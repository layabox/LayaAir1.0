!function(e,t,n){n.un,n.uns;var i=n.static,r=n.class,a=n.getset,s=n.__newvec,o=(laya.ani.AnimationContent,laya.ani.AnimationPlayer),l=(laya.ani.AnimationState,laya.ani.AnimationTemplet),h=laya.maths.Arith,_=laya.webgl.atlas.AtlasResourceManager,u=laya.webgl.shader.BaseShader,c=laya.utils.Browser,d=laya.webgl.utils.Buffer,f=laya.utils.Byte,m=laya.utils.ClassUtils,p=n.Config,v=(laya.events.Event,laya.events.EventDispatcher),g=laya.utils.Handler,x=laya.net.Loader,E=laya.net.LoaderManager,S=laya.maths.MathUtil,D=laya.display.Node,T=laya.renders.Render,M=(laya.renders.RenderContext,laya.renders.RenderSprite,laya.webgl.utils.RenderState2D),y=laya.resource.Resource,R=laya.utils.RunDriver,A=(laya.webgl.utils.ShaderCompile,laya.display.Sprite),C=laya.utils.Stat,I=laya.utils.StringKey,w=(laya.display.css.Style,laya.net.URL),V=laya.utils.Utils,N=laya.webgl.WebGL,O=laya.webgl.WebGLContext;laya.webgl.canvas.WebGLContext2D;n.interface("laya.d3.core.IClone"),n.interface("laya.d3.graphics.IVertex"),n.interface("laya.d3.core.render.IUpdate"),n.interface("laya.d3.core.scene.ITreeNode"),n.interface("laya.d3.core.render.IRenderable");var b=function(){function e(){}return r(e,"laya.d3.animation.AnimationClipParser01"),e.READ_DATA=function(){e._DATA.offset=e._reader.getUint32(),e._DATA.size=e._reader.getUint32()},e.READ_BLOCK=function(){for(var t=e._BLOCK.count=e._reader.getUint16(),n=e._BLOCK.blockStarts=[],i=e._BLOCK.blockLengths=[],r=0;r<t;r++)n.push(e._reader.getUint32()),i.push(e._reader.getUint32())},e.READ_STRINGS=function(){var t=e._reader.getUint32(),n=e._reader.getUint16(),i=e._reader.pos;e._reader.pos=t+e._DATA.offset;for(var r=0;r<n;r++)e._strings[r]=e._reader.readUTFString();e._reader.pos=i},e.parse=function(t,n){e._animationClip=t,e._reader=n;n.__getBuffer();e.READ_DATA(),e.READ_BLOCK(),e.READ_STRINGS();for(var i=0,r=e._BLOCK.count;i<r;i++){var a=n.getUint16(),s=e._strings[a],o=e["READ_"+s];if(null==o)throw new Error("model file err,no this function:"+a+" "+s);o.call()}},e.READ_ANIMATIONS=function(){var t,n=0,i=0,r=e._reader,a=r.__getBuffer(),s=[],o=r.getUint8();for(s.length=o,n=0;n<o;n++)s[n]=r.getUint16();var l=[],h=r.getUint16();for(l.length=h,n=0;n<h;n++)l[n]=r.getFloat32();var _=e._animationClip;_.name=e._strings[r.getUint16()];var u=_._duration=r.getFloat32();_.islooping=!!r.getByte(),_._frameRate=r.getInt16();var c=r.getInt16(),d=_._nodes=new Array;d.length=c;var f=_._nodesMap={},m=0,p=0;for(n=0;n<c;n++){t=d[n]=new F;var v=r.getUint16(),g=t.path=[];for(g.length=v,i=0;i<v;i++)g[i]=e._strings[r.getUint16()];var x=g.join("/"),E=f[x];E||(f[x]=E=[]),E.push(t);var S=r.getInt16();-1!==S&&(t.componentType=e._strings[S]);var D=P._propertyIndexDic[e._strings[r.getUint16()]];if(null==D)throw new Error("AnimationClipParser01:unknown property name.");var T=D<4,M=!T||T&&""===g[0];t._cacheProperty=M,M?m++:p++,t.propertyNameID=D;var y=s[r.getUint8()];t.keyFrameWidth=y/4;var R=t.keyFrames=[],A=R.length=r.getUint16(),C=null,I=NaN;for(i=0;i<A;i++){var w=R[i]=new L;I=w.startTime=l[r.getUint16()];var V=r.pos;w.inTangent=new Float32Array(a.slice(V,V+y)),r.pos+=y,V=r.pos,w.outTangent=new Float32Array(a.slice(V,V+y)),r.pos+=y,V=r.pos,w.data=new Float32Array(a.slice(V,V+y)),r.pos+=y,C&&(C.next=w,C.duration=I-C.startTime),C=w}w.next=null,w.duration=u-I}var N=_._nodeToCachePropertyMap=new Int32Array(c),O=_._cachePropertyToNodeMap=new Int32Array(m),b=_._unCachePropertyToNodeMap=new Int32Array(p);for(m=p=0,n=0;n<c;n++)(t=d[n])._cacheProperty?(N[n]=m,O[m++]=n):b[p++]=n},e._animationClip=null,e._reader=null,e._strings=[],i(e,["_BLOCK",function(){return this._BLOCK={count:0}},"_DATA",function(){return this._DATA={offset:0,size:0}}]),e}(),P=function(){function e(){this._childs=[],this._transform=new wt(this)}r(e,"laya.d3.animation.AnimationNode");var t=e.prototype;return n.imps(t,{"laya.d3.core.IClone":!0}),t.transform=function(){return this._transform},t.addChild=function(e){e._parent=this,e._transform.parent=this._transform,this._childs.push(e)},t.removeChild=function(e){var t=this._childs.indexOf(e);-1!==t&&this._childs.splice(t,1)},t.getChildByName=function(e){for(var t=0,n=this._childs.length;t<n;t++){var i=this._childs[t];if(i.name===e)return i}return null},t.getChildByIndex=function(e){return this._childs[e]},t.getChildCount=function(){return this._childs.length},t.cloneTo=function(e){var t=e;t.name=this.name;var n=t._transform,i=n.localPosition;this._transform.localPosition.cloneTo(i),n.localPosition=i;var r=n.localRotation;this._transform.localRotation.cloneTo(r),n.localRotation=r;var a=n.localScale;this._transform.localScale.cloneTo(a),n.localScale=a;for(var s=0,o=this._childs.length;s<o;s++){var l=this._childs[s].clone();t.addChild(l)}},t.clone=function(){var e=new this.constructor;return this.cloneTo(e),e},e.__init__=function(){e.registerAnimationNodeProperty("localPosition",e._getLocalPosition,e._setLocalPosition),e.registerAnimationNodeProperty("localRotation",e._getLocalRotation,e._setLocalRotation),e.registerAnimationNodeProperty("localScale",e._getLocalScale,e._setLocalScale),e.registerAnimationNodeProperty("localRotationEuler",e._getLocalRotationEuler,e._setLocalRotationEuler),e.registerAnimationNodeProperty("particleRender.sharedMaterial.tintColor",e._getParticleRenderSharedMaterialTintColor,e._setParticleRenderSharedMaterialTintColor),e.registerAnimationNodeProperty("meshRender.sharedMaterial.tilingOffset",e._getMeshRenderSharedMaterialTilingOffset,e._setMeshRenderSharedMaterialTilingOffset),e.registerAnimationNodeProperty("meshRender.sharedMaterial.albedo",e._getMeshRenderSharedMaterialAlbedo,e._setMeshRenderSharedMaterialAlbedo),e.registerAnimationNodeProperty("skinnedMeshRender.sharedMaterial.tilingOffset",e._getSkinnedMeshRenderSharedMaterialTilingOffset,e._setSkinnedMeshRenderSharedMaterialTilingOffset),e.registerAnimationNodeProperty("skinnedMeshRender.sharedMaterial.albedo",e._getSkinnedMeshRenderSharedMaterialAlbedo,e._setSkinnedMeshRenderSharedMaterialAlbedo)},e.registerAnimationNodeProperty=function(t,n,i){if(e._propertyIndexDic[t])throw new Error("AnimationNode: this propertyName has registered.");e._propertyIndexDic[t]=e._propertyIDCounter,e._propertyGetFuncs[e._propertyIDCounter]=n,e._propertySetFuncs[e._propertyIDCounter]=i,e._propertyIDCounter++},e._getLocalPosition=function(e,t){return e?e._transform.localPosition.elements:t._transform.localPosition.elements},e._setLocalPosition=function(e,t,n){var i;if(e){var r=e._transform;(i=r._localPosition).elements=n,r._setLocalPosition(i)}else{var a=t._transform;(i=a.localPosition).elements=n,a.localPosition=i}},e._getLocalRotation=function(e,t){return e?e._transform.localRotation.elements:t._transform.localRotation.elements},e._setLocalRotation=function(e,t,n){var i;if(e){var r=e._transform;(i=r._localRotation).elements=n,r._setLocalRotation(i)}else{var a=t._transform;(i=a.localRotation).elements=n,a.localRotation=i}},e._getLocalScale=function(e,t){return e?e._transform.localScale.elements:t._transform.localScale.elements},e._setLocalScale=function(e,t,n){var i;if(e){var r=e._transform;(i=r._localScale).elements=n,r._setLocalScale(i)}else{var a=t._transform;(i=a.localScale).elements=n,a.localScale=i}},e._getLocalRotationEuler=function(e,t){return e?e._transform.localRotationEuler.elements:t._transform.localRotationEuler.elements},e._setLocalRotationEuler=function(e,t,n){var i;if(e){var r=e._transform;(i=r._localRotationEuler).elements=n,r._setLocalRotationEuler(i)}else{var a=t._transform;(i=a.localRotationEuler).elements=n,a.localRotationEuler=i}},e._getMeshRenderSharedMaterialTilingOffset=function(e,t){if(e){var n=e._transform._entity;return n?n.owner.meshRender.sharedMaterial.tilingOffset.elements:null}return t.meshRender.sharedMaterial.tilingOffset.elements},e._setMeshRenderSharedMaterialTilingOffset=function(e,t,n){var i,r;if(e){var a=e._transform._entity;a&&((r=(i=a.owner.meshRender.material).tilingOffset).elements=n,i.tilingOffset=r)}else(r=(i=t.meshRender.material).tilingOffset).elements=n,i.tilingOffset=r},e._getMeshRenderSharedMaterialAlbedo=function(e,t){if(e){var n=e._transform._entity;return n?n.owner.meshRender.sharedMaterial.albedo.elements:null}return t.meshRender.sharedMaterial.albedo.elements},e._setMeshRenderSharedMaterialAlbedo=function(e,t,n){var i,r;if(e){var a=e._transform._entity;a&&((r=(i=a.owner.meshRender.material).albedo).elements=n,i.albedo=r)}else(r=(i=t.meshRender.material).albedo).elements=n,i.albedo=r},e._getSkinnedMeshRenderSharedMaterialTilingOffset=function(e,t){if(e){var n=e._transform._entity;return n?n.owner.skinnedMeshRender.sharedMaterial.tilingOffset.elements:null}return t.skinnedMeshRender.sharedMaterial.tilingOffset.elements},e._setSkinnedMeshRenderSharedMaterialTilingOffset=function(e,t,n){var i,r;if(e){var a=e._transform._entity;a&&((r=(i=a.owner.skinnedMeshRender.material).tilingOffset).elements=n,i.tilingOffset=r)}else(r=(i=t.skinnedMeshRender.material).tilingOffset).elements=n,i.tilingOffset=r},e._getSkinnedMeshRenderSharedMaterialAlbedo=function(e,t){if(e){var n=e._transform._entity;return n?n.owner.skinnedMeshRender.sharedMaterial.albedo.elements:null}return t.skinnedMeshRender.sharedMaterial.albedo.elements},e._setSkinnedMeshRenderSharedMaterialAlbedo=function(e,t,n){var i,r;if(e){var a=e._transform._entity;a&&((r=(i=a.owner.skinnedMeshRender.material).albedo).elements=n,i.albedo=r)}else(r=(i=t.skinnedMeshRender.material).albedo).elements=n,i.albedo=r},e._getParticleRenderSharedMaterialTintColor=function(e,t){if(e){var n=e._transform._entity;return n?n.owner.particleRender.sharedMaterial.tintColor.elements:null}return t.particleRender.sharedMaterial.tintColor.elements},e._setParticleRenderSharedMaterialTintColor=function(e,t,n){var i,r;if(e){var a=e._transform._entity;a&&((r=(i=a.owner.particleRender.material).tintColor).elements=n,i.tintColor=r)}else(r=(i=t.particleRender.material).tintColor).elements=n,i.tintColor=r},e._propertyIDCounter=0,e._propertyIndexDic={},e._propertySetFuncs=[],e._propertyGetFuncs=[],e}(),L=function(){function e(){this.startTime=NaN,this.inTangent=null,this.outTangent=null,this.data=null,this.duration=NaN,this.next=null}return r(e,"laya.d3.animation.Keyframe"),e}(),F=function(){function e(){this._cacheProperty=!1,this.path=null,this.componentType=null,this.propertyNameID=0,this.keyFrameWidth=0,this.defaultData=null,this.keyFrames=null}return r(e,"laya.d3.animation.KeyframeNode"),e}(),B=function(){function e(){this._tempVector30=new ct,this._tempVector31=new ct,this._tempVector32=new ct,this._a=new ct,this._b=new ct,this._c=new ct,this._d=new ct}r(e,"laya.d3.core.glitter.SplineCurvePositionVelocity");var t=e.prototype;return t.Init=function(e,t,n,i){e.cloneTo(this._d),t.cloneTo(this._c),ct.scale(e,2,this._a),ct.scale(n,2,this._tempVector30),ct.subtract(this._a,this._tempVector30,this._a),ct.add(this._a,t,this._a),ct.add(this._a,i,this._a),ct.scale(n,3,this._b),ct.scale(e,3,this._tempVector30),ct.subtract(this._b,this._tempVector30,this._b),ct.subtract(this._b,i,this._b),ct.scale(t,2,this._tempVector30),ct.subtract(this._b,this._tempVector30,this._b)},t.Slerp=function(e,t){ct.scale(this._a,e*e*e,this._tempVector30),ct.scale(this._b,e*e,this._tempVector31),ct.scale(this._c,e,this._tempVector32),ct.add(this._tempVector30,this._tempVector31,t),ct.add(t,this._tempVector32,t),ct.add(t,this._d,t)},e}(),U=function(){function e(e,t,n,i){this._datas=null,this._w=0,this._h=0,this._minHeight=NaN,this._maxHeight=NaN,this._datas=[],this._w=e,this._h=t,this._minHeight=n,this._maxHeight=i}r(e,"laya.d3.core.HeightMap");var t=e.prototype;return t._inBounds=function(e,t){return e>=0&&e<this._h&&t>=0&&t<this._w},t.getHeight=function(e,t){return this._inBounds(e,t)?this._datas[e][t]:NaN},a(0,t,"width",function(){return this._w}),a(0,t,"height",function(){return this._h}),a(0,t,"maxHeight",function(){return this._maxHeight}),a(0,t,"minHeight",function(){return this._minHeight}),e.creatFromMesh=function(t,n,i,r){for(var a=[],s=[],o=t.getSubMeshCount(),l=0;l<o;l++){for(var h=t.getSubMesh(l),_=h._getVertexBuffer(),u=_.getData(),c=[],d=0;d<u.length;d+=_.vertexDeclaration.vertexStride/4){var f=new ct(u[d+0],u[d+1],u[d+2]);c.push(f)}a.push(c);var m=h._getIndexBuffer();s.push(m.getData())}var p=t.boundingBox,v=p.min.x,g=p.min.z,x=p.max.x,E=p.max.z,S=p.min.y,D=p.max.y,T=x-v,M=E-g,y=r.elements[0]=T/(n-1),R=r.elements[1]=M/(i-1),A=new e(n,i,S,D),C=e._tempRay,I=C.direction.elements;I[0]=0,I[1]=-1,I[2]=0;var w=D+.1;C.origin.elements[1]=w;for(var V=0;V<i;V++){var N=g+V*R;A._datas[V]=[];for(var O=0;O<n;O++){var b=v+O*y,P=C.origin.elements;P[0]=b,P[2]=N;var L=e._getPosition(C,a,s);A._datas[V][O]=L===Number.MAX_VALUE?NaN:w-L}}return A},e.createFromImage=function(t,n,i){for(var r=t.width,a=t.height,s=new e(r,a,n,i),o=(i-n)/254,l=t.getPixels(),h=0,_=0;_<a;_++)for(var u=s._datas[_]=[],c=0;c<r;c++){var d=l[h++],f=l[h++],m=l[h++],p=l[h++];u[c]=255==d&&255==f&&255==m&&255==p?NaN:(d+f+m)/3*o+n}return s},e._getPosition=function(e,t,n){for(var i=Number.MAX_VALUE,r=0;r<t.length;r++)for(var a=t[r],s=n[r],o=0;o<s.length;o+=3){var l=a[s[o+0]],h=a[s[o+1]],_=a[s[o+2]],u=yt.rayIntersectsTriangle(e,l,h,_);!isNaN(u)&&u<i&&(i=u)}return i},i(e,["_tempRay",function(){return this._tempRay=new _t(new ct,new ct)}]),e}(),H=function(){function e(){if(this._id=0,this._number=0,this._mask=0,this._active=!0,this._visible=!0,this._colliders=null,this.name=null,e._uniqueIDCounter>31)throw new Error("不允许创建Layer，请参考函数getLayerByNumber、getLayerByMask、getLayerByName！");this._id=e._uniqueIDCounter,e._uniqueIDCounter++,this._colliders=[]}r(e,"laya.d3.core.Layer");var t=e.prototype;return a(0,t,"number",function(){return this._number}),a(0,t,"visible",function(){return this._visible},function(t){29!==this._number&&30!=this._number&&(this._visible=t,e._visibleLayers=t?e._visibleLayers|this.mask:e._visibleLayers&~this.mask)}),a(0,t,"mask",function(){return this._mask}),a(0,t,"active",function(){return this._active},function(t){29!==this._number&&30!=this._number&&(this._active=t,e._activeLayers=t?e._activeLayers|this.mask:e._activeLayers&~this.mask)}),a(1,e,"activeLayers",function(){return e._activeLayers},function(t){e._activeLayers=t|e.getLayerByNumber(29).mask|e.getLayerByNumber(30).mask;for(var n=0,i=e._layerList.length;n<i;n++){var r=e._layerList[n];r._active=0!=(r._mask&e._activeLayers)}}),a(1,e,"visibleLayers",function(){return e._visibleLayers},function(t){e._visibleLayers=t|e.getLayerByNumber(29).mask|e.getLayerByNumber(30).mask;for(var n=0,i=e._layerList.length;n<i;n++){var r=e._layerList[n];r._visible=0!=(r._mask&e._visibleLayers)}}),e.__init__=function(){e._layerList.length=31;for(var t=0;t<31;t++){var n=new e;e._layerList[t]=n,n.name=0===t?"Default Layer":29===t?"Reserved Layer0":30===t?"Reserved Layer1":"Layer-"+t,n._number=t,n._mask=Math.pow(2,t)}e._activeLayers=2147483647,e._visibleLayers=2147483647,e._currentCameraCullingMask=2147483647,e.currentCreationLayer=e._layerList[0]},e.getLayerByNumber=function(t){if(t<0||t>30)throw new Error("无法返回指定Layer，该number超出范围！");return e._layerList[t]},e.getLayerByMask=function(t){for(var n=0;n<31;n++)if(e._layerList[n].mask===t)return e._layerList[n];throw new Error("无法返回指定Layer,该mask不存在")},e.getLayerByName=function(t){for(var n=0;n<31;n++)if(e._layerList[n].name===t)return e._layerList[n];throw new Error("无法返回指定Layer,该name不存在")},e.isActive=function(t){return 0!=(t&e._activeLayers)},e.isVisible=function(t){return 0!=(t&e._currentCameraCullingMask&e._visibleLayers)},e._uniqueIDCounter=1,e._layerCount=31,e._layerList=[],e._activeLayers=0,e._visibleLayers=0,e._currentCameraCullingMask=0,e.currentCreationLayer=null,e}(),z=function(){function e(e,t,n){this._time=NaN,this._minCount=0,this._maxCount=0,this._time=e,this._minCount=t,this._maxCount=n}r(e,"laya.d3.core.particleShuriKen.module.Burst");var t=e.prototype;return n.imps(t,{"laya.d3.core.IClone":!0}),t.cloneTo=function(e){var t=e;t._time=this._time,t._minCount=this._minCount,t._maxCount=this._maxCount},t.clone=function(){var e=new this.constructor;return this.cloneTo(e),e},a(0,t,"time",function(){return this._time}),a(0,t,"minCount",function(){return this._minCount}),a(0,t,"maxCount",function(){return this._maxCount}),e}(),G=function(){function e(e){this._color=null,this.enbale=!1,this._color=e}r(e,"laya.d3.core.particleShuriKen.module.ColorOverLifetime");var t=e.prototype;return t.cloneTo=function(e){var t=e;this._color.cloneTo(t._color),t.enbale=this.enbale},t.clone=function(){var e;switch(this._color.type){case 0:e=j.createByConstant(this._color.constant.clone());break;case 1:e=j.createByGradient(this._color.gradient.clone());break;case 2:e=j.createByRandomTwoConstant(this._color.constantMin.clone(),this._color.constantMax.clone());break;case 3:e=j.createByRandomTwoGradient(this._color.gradientMin.clone(),this._color.gradientMax.clone())}var t=new this.constructor(e);return t.enbale=this.enbale,t},a(0,t,"color",function(){return this._color}),e}(),k=function(){function e(){this._destroyed=!1,this._emissionRate=0,this._particleSystem=null,this._shape=null,this._bursts=null,this.enbale=!1,this._destroyed=!1,this.emissionRate=10,this._bursts=[]}r(e,"laya.d3.core.particleShuriKen.module.Emission");var t=e.prototype;return n.imps(t,{"laya.d3.core.IClone":!0,"laya.resource.IDestroy":!0}),t._destroy=function(){this._bursts=null,this._particleSystem=null,this._destroyed=!0},t.getBurstsCount=function(){return this._bursts.length},t.getBurstByIndex=function(e){return this._bursts[e]},t.addBurst=function(e){var t=this._bursts.length;if(t>0)for(var n=0;n<t;n++)this._bursts[n].time>e.time&&this._bursts.splice(n,0,e);this._bursts.push(e)},t.removeBurst=function(e){var t=this._bursts.indexOf(e);-1!==t&&this._bursts.splice(t,1)},t.removeBurstByIndex=function(e){this._bursts.splice(e,1)},t.clearBurst=function(){this._bursts.length=0},t.cloneTo=function(e){var t=e,n=t._bursts;n.length=this._bursts.length;for(var i=0,r=this._bursts.length;i<r;i++){var a=n[i];a?this._bursts[i].cloneTo(a):n[i]=this._bursts[i].clone()}t._emissionRate=this._emissionRate,t.enbale=this.enbale},t.clone=function(){var e=new this.constructor;return this.cloneTo(e),e},a(0,t,"destroyed",function(){return this._destroyed}),a(0,t,"emissionRate",function(){return this._emissionRate},function(e){if(e<0)throw new Error("ParticleBaseShape:emissionRate value must large or equal than 0.");this._emissionRate=e}),e}(),W=function(){function e(){this._type=0,this._constant=0,this._overTime=null,this._constantMin=0,this._constantMax=0,this._overTimeMin=null,this._overTimeMax=null}r(e,"laya.d3.core.particleShuriKen.module.FrameOverTime");var t=e.prototype;return n.imps(t,{"laya.d3.core.IClone":!0}),t.cloneTo=function(e){var t=e;t._type=this._type,t._constant=this._constant,this._overTime.cloneTo(t._overTime),t._constantMin=this._constantMin,t._constantMax=this._constantMax,this._overTimeMin.cloneTo(t._overTimeMin),this._overTimeMax.cloneTo(t._overTimeMax)},t.clone=function(){var e=new this.constructor;return this.cloneTo(e),e},a(0,t,"frameOverTimeData",function(){return this._overTime}),a(0,t,"constant",function(){return this._constant}),a(0,t,"type",function(){return this._type}),a(0,t,"frameOverTimeDataMin",function(){return this._overTimeMin}),a(0,t,"constantMin",function(){return this._constantMin}),a(0,t,"frameOverTimeDataMax",function(){return this._overTimeMax}),a(0,t,"constantMax",function(){return this._constantMax}),e.createByConstant=function(t){var n=new e;return n._type=0,n._constant=t,n},e.createByOverTime=function(t){var n=new e;return n._type=1,n._overTime=t,n},e.createByRandomTwoConstant=function(t,n){var i=new e;return i._type=2,i._constantMin=t,i._constantMax=n,i},e.createByRandomTwoOverTime=function(t,n){var i=new e;return i._type=3,i._overTimeMin=t,i._overTimeMax=n,i},e}(),X=function(){function e(){this._type=0,this._separateAxes=!1,this._constant=NaN,this._constantSeparate=null,this._gradient=null,this._gradientX=null,this._gradientY=null,this._gradientZ=null,this._gradientW=null,this._constantMin=NaN,this._constantMax=NaN,this._constantMinSeparate=null,this._constantMaxSeparate=null,this._gradientMin=null,this._gradientMax=null,this._gradientXMin=null,this._gradientXMax=null,this._gradientYMin=null,this._gradientYMax=null,this._gradientZMin=null,this._gradientZMax=null,this._gradientWMin=null,this._gradientWMax=null}r(e,"laya.d3.core.particleShuriKen.module.GradientAngularVelocity");var t=e.prototype;return n.imps(t,{"laya.d3.core.IClone":!0}),t.cloneTo=function(e){var t=e;t._type=this._type,t._separateAxes=this._separateAxes,t._constant=this._constant,this._constantSeparate.cloneTo(t._constantSeparate),this._gradient.cloneTo(t._gradient),this._gradientX.cloneTo(t._gradientX),this._gradientY.cloneTo(t._gradientY),this._gradientZ.cloneTo(t._gradientZ),t._constantMin=this._constantMin,t._constantMax=this._constantMax,this._constantMinSeparate.cloneTo(t._constantMinSeparate),this._constantMaxSeparate.cloneTo(t._constantMaxSeparate),this._gradientMin.cloneTo(t._gradientMin),this._gradientMax.cloneTo(t._gradientMax),this._gradientXMin.cloneTo(t._gradientXMin),this._gradientXMax.cloneTo(t._gradientXMax),this._gradientYMin.cloneTo(t._gradientYMin),this._gradientYMax.cloneTo(t._gradientYMax),this._gradientZMin.cloneTo(t._gradientZMin),this._gradientZMax.cloneTo(t._gradientZMax)},t.clone=function(){var e=new this.constructor;return this.cloneTo(e),e},a(0,t,"gradientZ",function(){return this._gradientZ}),a(0,t,"constant",function(){return this._constant}),a(0,t,"gradient",function(){return this._gradient}),a(0,t,"separateAxes",function(){return this._separateAxes}),a(0,t,"type",function(){return this._type}),a(0,t,"constantSeparate",function(){return this._constantSeparate}),a(0,t,"gradientX",function(){return this._gradientX}),a(0,t,"gradientY",function(){return this._gradientY}),a(0,t,"gradientW",function(){return this._gradientW}),a(0,t,"gradientMin",function(){return this._gradientMin}),a(0,t,"constantMin",function(){return this._constantMin}),a(0,t,"gradientMax",function(){return this._gradientMax}),a(0,t,"constantMax",function(){return this._constantMax}),a(0,t,"gradientWMin",function(){return this._gradientWMin}),a(0,t,"constantMinSeparate",function(){return this._constantMinSeparate}),a(0,t,"constantMaxSeparate",function(){return this._constantMaxSeparate}),a(0,t,"gradientXMin",function(){return this._gradientXMin}),a(0,t,"gradientXMax",function(){return this._gradientXMax}),a(0,t,"gradientWMax",function(){return this._gradientWMax}),a(0,t,"gradientYMin",function(){return this._gradientYMin}),a(0,t,"gradientYMax",function(){return this._gradientYMax}),a(0,t,"gradientZMin",function(){return this._gradientZMin}),a(0,t,"gradientZMax",function(){return this._gradientZMax}),e.createByConstant=function(t){var n=new e;return n._type=0,n._separateAxes=!1,n._constant=t,n},e.createByConstantSeparate=function(t){var n=new e;return n._type=0,n._separateAxes=!0,n._constantSeparate=t,n},e.createByGradient=function(t){var n=new e;return n._type=1,n._separateAxes=!1,n._gradient=t,n},e.createByGradientSeparate=function(t,n,i,r){var a=new e;return a._type=1,a._separateAxes=!0,a._gradientX=t,a._gradientY=n,a._gradientZ=i,a._gradientW=r,a},e.createByRandomTwoConstant=function(t,n){var i=new e;return i._type=2,i._separateAxes=!1,i._constantMin=t,i._constantMax=n,i},e.createByRandomTwoConstantSeparate=function(t,n){var i=new e;return i._type=2,i._separateAxes=!0,i._constantMinSeparate=t,i._constantMaxSeparate=n,i},e.createByRandomTwoGradient=function(t,n){var i=new e;return i._type=3,i._separateAxes=!1,i._gradientMin=t,i._gradientMax=n,i},e.createByRandomTwoGradientSeparate=function(t,n,i,r,a,s,o,l){var h=new e;return h._type=3,h._separateAxes=!0,h._gradientXMin=t,h._gradientXMax=n,h._gradientYMin=i,h._gradientYMax=r,h._gradientZMin=a,h._gradientZMax=s,h._gradientWMin=o,h._gradientWMax=l,h},e}(),j=function(){function e(){this._type=0,this._constant=null,this._constantMin=null,this._constantMax=null,this._gradient=null,this._gradientMin=null,this._gradientMax=null}r(e,"laya.d3.core.particleShuriKen.module.GradientColor");var t=e.prototype;return n.imps(t,{"laya.d3.core.IClone":!0}),t.cloneTo=function(e){var t=e;t._type=this._type,this._constant.cloneTo(t._constant),this._constantMin.cloneTo(t._constantMin),this._constantMax.cloneTo(t._constantMax),this._gradient.cloneTo(t._gradient),this._gradientMin.cloneTo(t._gradientMin),this._gradientMax.cloneTo(t._gradientMax)},t.clone=function(){var e=new this.constructor;return this.cloneTo(e),e},a(0,t,"gradient",function(){return this._gradient}),a(0,t,"constant",function(){return this._constant}),a(0,t,"type",function(){return this._type}),a(0,t,"gradientMin",function(){return this._gradientMin}),a(0,t,"constantMin",function(){return this._constantMin}),a(0,t,"gradientMax",function(){return this._gradientMax}),a(0,t,"constantMax",function(){return this._constantMax}),e.createByConstant=function(t){var n=new e;return n._type=0,n._constant=t,n},e.createByGradient=function(t){var n=new e;return n._type=1,n._gradient=t,n},e.createByRandomTwoConstant=function(t,n){var i=new e;return i._type=2,i._constantMin=t,i._constantMax=n,i},e.createByRandomTwoGradient=function(t,n){var i=new e;return i._type=3,i._gradientMin=t,i._gradientMax=n,i},e}(),Z=function(){function e(){this._alphaCurrentLength=0,this._rgbCurrentLength=0,this._alphaElements=null,this._rgbElements=null,this._alphaElements=new Float32Array(8),this._rgbElements=new Float32Array(16)}r(e,"laya.d3.core.particleShuriKen.module.GradientDataColor");var t=e.prototype;return n.imps(t,{"laya.d3.core.IClone":!0}),t.addAlpha=function(e,t){this._alphaCurrentLength<8?(6===this._alphaCurrentLength&&1!==e&&(e=1,console.log("GradientDataColor warning:the forth key is  be force set to 1.")),this._alphaElements[this._alphaCurrentLength++]=e,this._alphaElements[this._alphaCurrentLength++]=t):console.log("GradientDataColor warning:data count must lessEqual than 4")},t.addRGB=function(e,t){this._rgbCurrentLength<16?(12===this._rgbCurrentLength&&1!==e&&(e=1,console.log("GradientDataColor warning:the forth key is  be force set to 1.")),this._rgbElements[this._rgbCurrentLength++]=e,this._rgbElements[this._rgbCurrentLength++]=t.x,this._rgbElements[this._rgbCurrentLength++]=t.y,this._rgbElements[this._rgbCurrentLength++]=t.z):console.log("GradientDataColor warning:data count must lessEqual than 4")},t.cloneTo=function(e){var t=e,n=0,i=0;t._alphaCurrentLength=this._alphaCurrentLength;var r=t._alphaElements;for(r.length=this._alphaElements.length,n=0,i=this._alphaElements.length;n<i;n++)r[n]=this._alphaElements[n];t._rgbCurrentLength=this._rgbCurrentLength;var a=t._rgbElements;for(a.length=this._rgbElements.length,n=0,i=this._rgbElements.length;n<i;n++)a[n]=this._rgbElements[n]},t.clone=function(){var e=new this.constructor;return this.cloneTo(e),e},a(0,t,"alphaGradientCount",function(){return this._alphaCurrentLength/2}),a(0,t,"rgbGradientCount",function(){return this._rgbCurrentLength/4}),e}(),Y=function(){function e(){this._currentLength=0,this._elements=null,this._elements=new Float32Array(8)}r(e,"laya.d3.core.particleShuriKen.module.GradientDataInt");var t=e.prototype;return n.imps(t,{"laya.d3.core.IClone":!0}),t.add=function(e,t){this._currentLength<8?(6===this._currentLength&&1!==e&&(e=1,console.log("Warning:the forth key is  be force set to 1.")),this._elements[this._currentLength++]=e,this._elements[this._currentLength++]=t):console.log("Warning:data count must lessEqual than 4")},t.cloneTo=function(e){var t=e;t._currentLength=this._currentLength;var n=t._elements;n.length=this._elements.length;for(var i=0,r=this._elements.length;i<r;i++)n[i]=this._elements[i]},t.clone=function(){var e=new this.constructor;return this.cloneTo(e),e},a(0,t,"gradientCount",function(){return this._currentLength/2}),e}(),q=function(){function e(){this._currentLength=0,this._elements=null,this._elements=new Float32Array(8)}r(e,"laya.d3.core.particleShuriKen.module.GradientDataNumber");var t=e.prototype;return n.imps(t,{"laya.d3.core.IClone":!0}),t.add=function(e,t){this._currentLength<8?(6===this._currentLength&&1!==e&&(e=1,console.log("GradientDataNumber warning:the forth key is  be force set to 1.")),this._elements[this._currentLength++]=e,this._elements[this._currentLength++]=t):console.log("GradientDataNumber warning:data count must lessEqual than 4")},t.getKeyByIndex=function(e){return this._elements[2*e]},t.getValueByIndex=function(e){return this._elements[2*e+1]},t.getAverageValue=function(){for(var e=0,t=this._currentLength-2;e<t;e+=2){this._elements[e+1];this._elements[e+3],this._elements[e+2]-this._elements[e]}return 0},t.cloneTo=function(e){var t=e;t._currentLength=this._currentLength;var n=t._elements;n.length=this._elements.length;for(var i=0,r=this._elements.length;i<r;i++)n[i]=this._elements[i]},t.clone=function(){var e=new this.constructor;return this.cloneTo(e),e},a(0,t,"gradientCount",function(){return this._currentLength/2}),e}(),Q=(function(){function e(){this._currentLength=0,this._elements=null,this._elements=new Float32Array(12)}r(e,"laya.d3.core.particleShuriKen.module.GradientDataVector2");var t=e.prototype;n.imps(t,{"laya.d3.core.IClone":!0}),t.add=function(e,t){this._currentLength<8?(6===this._currentLength&&1!==e&&(e=1,console.log("GradientDataVector2 warning:the forth key is  be force set to 1.")),this._elements[this._currentLength++]=e,this._elements[this._currentLength++]=t.x,this._elements[this._currentLength++]=t.y):console.log("GradientDataVector2 warning:data count must lessEqual than 4")},t.cloneTo=function(e){var t=e;t._currentLength=this._currentLength;var n=t._elements;n.length=this._elements.length;for(var i=0,r=this._elements.length;i<r;i++)n[i]=this._elements[i]},t.clone=function(){var e=new this.constructor;return this.cloneTo(e),e},a(0,t,"gradientCount",function(){return this._currentLength/3})}(),function(){function e(){this._type=0,this._separateAxes=!1,this._gradient=null,this._gradientX=null,this._gradientY=null,this._gradientZ=null,this._constantMin=NaN,this._constantMax=NaN,this._constantMinSeparate=null,this._constantMaxSeparate=null,this._gradientMin=null,this._gradientMax=null,this._gradientXMin=null,this._gradientXMax=null,this._gradientYMin=null,this._gradientYMax=null,this._gradientZMin=null,this._gradientZMax=null}r(e,"laya.d3.core.particleShuriKen.module.GradientSize");var t=e.prototype;return n.imps(t,{"laya.d3.core.IClone":!0}),t.getMaxSizeInGradient=function(){var e=0,t=0,n=-Number.MAX_VALUE;switch(this._type){case 0:if(this._separateAxes){for(e=0,t=this._gradientX.gradientCount;e<t;e++)n=Math.max(n,this._gradientX.getValueByIndex(e));for(e=0,t=this._gradientY.gradientCount;e<t;e++)n=Math.max(n,this._gradientY.getValueByIndex(e))}else for(e=0,t=this._gradient.gradientCount;e<t;e++)n=Math.max(n,this._gradient.getValueByIndex(e));break;case 1:this._separateAxes?(n=Math.max(this._constantMinSeparate.x,this._constantMaxSeparate.x),n=Math.max(n,this._constantMinSeparate.y),n=Math.max(n,this._constantMaxSeparate.y)):n=Math.max(this._constantMin,this._constantMax);break;case 2:if(this._separateAxes){for(e=0,t=this._gradientXMin.gradientCount;e<t;e++)n=Math.max(n,this._gradientXMin.getValueByIndex(e));for(e=0,t=this._gradientXMax.gradientCount;e<t;e++)n=Math.max(n,this._gradientXMax.getValueByIndex(e));for(e=0,t=this._gradientYMin.gradientCount;e<t;e++)n=Math.max(n,this._gradientYMin.getValueByIndex(e));for(e=0,t=this._gradientZMax.gradientCount;e<t;e++)n=Math.max(n,this._gradientZMax.getValueByIndex(e))}else{for(e=0,t=this._gradientMin.gradientCount;e<t;e++)n=Math.max(n,this._gradientMin.getValueByIndex(e));for(e=0,t=this._gradientMax.gradientCount;e<t;e++)n=Math.max(n,this._gradientMax.getValueByIndex(e))}}return n},t.cloneTo=function(e){var t=e;t._type=this._type,t._separateAxes=this._separateAxes,this._gradient.cloneTo(t._gradient),this._gradientX.cloneTo(t._gradientX),this._gradientY.cloneTo(t._gradientY),this._gradientZ.cloneTo(t._gradientZ),t._constantMin=this._constantMin,t._constantMax=this._constantMax,this._constantMinSeparate.cloneTo(t._constantMinSeparate),this._constantMaxSeparate.cloneTo(t._constantMaxSeparate),this._gradientMin.cloneTo(t._gradientMin),this._gradientMax.cloneTo(t._gradientMax),this._gradientXMin.cloneTo(t._gradientXMin),this._gradientXMax.cloneTo(t._gradientXMax),this._gradientYMin.cloneTo(t._gradientYMin),this._gradientYMax.cloneTo(t._gradientYMax),this._gradientZMin.cloneTo(t._gradientZMin),this._gradientZMax.cloneTo(t._gradientZMax)},t.clone=function(){var e=new this.constructor;return this.cloneTo(e),e},a(0,t,"gradientZ",function(){return this._gradientZ}),a(0,t,"gradient",function(){return this._gradient}),a(0,t,"separateAxes",function(){return this._separateAxes}),a(0,t,"type",function(){return this._type}),a(0,t,"gradientMin",function(){return this._gradientMin}),a(0,t,"constantMin",function(){return this._constantMin}),a(0,t,"gradientX",function(){return this._gradientX}),a(0,t,"gradientY",function(){return this._gradientY}),a(0,t,"gradientMax",function(){return this._gradientMax}),a(0,t,"constantMax",function(){return this._constantMax}),a(0,t,"constantMinSeparate",function(){return this._constantMinSeparate}),a(0,t,"constantMaxSeparate",function(){return this._constantMaxSeparate}),a(0,t,"gradientXMin",function(){return this._gradientXMin}),a(0,t,"gradientXMax",function(){return this._gradientXMax}),a(0,t,"gradientYMin",function(){return this._gradientYMin}),a(0,t,"gradientYMax",function(){return this._gradientYMax}),a(0,t,"gradientZMin",function(){return this._gradientZMin}),a(0,t,"gradientZMax",function(){return this._gradientZMax}),e.createByGradient=function(t){var n=new e;return n._type=0,n._separateAxes=!1,n._gradient=t,n},e.createByGradientSeparate=function(t,n,i){var r=new e;return r._type=0,r._separateAxes=!0,r._gradientX=t,r._gradientY=n,r._gradientZ=i,r},e.createByRandomTwoConstant=function(t,n){var i=new e;return i._type=1,i._separateAxes=!1,i._constantMin=t,i._constantMax=n,i},e.createByRandomTwoConstantSeparate=function(t,n){var i=new e;return i._type=1,i._separateAxes=!0,i._constantMinSeparate=t,i._constantMaxSeparate=n,i},e.createByRandomTwoGradient=function(t,n){var i=new e;return i._type=2,i._separateAxes=!1,i._gradientMin=t,i._gradientMax=n,i},e.createByRandomTwoGradientSeparate=function(t,n,i,r,a,s){var o=new e;return o._type=2,o._separateAxes=!0,o._gradientXMin=t,o._gradientXMax=n,o._gradientYMin=i,o._gradientYMax=r,o._gradientZMin=a,o._gradientZMax=s,o},e}()),K=function(){function e(){this._type=0,this._constant=null,this._gradientX=null,this._gradientY=null,this._gradientZ=null,this._constantMin=null,this._constantMax=null,this._gradientXMin=null,this._gradientXMax=null,this._gradientYMin=null,this._gradientYMax=null,this._gradientZMin=null,this._gradientZMax=null}r(e,"laya.d3.core.particleShuriKen.module.GradientVelocity");var t=e.prototype;return n.imps(t,{"laya.d3.core.IClone":!0}),t.cloneTo=function(e){var t=e;t._type=this._type,this._constant.cloneTo(t._constant),this._gradientX.cloneTo(t._gradientX),this._gradientY.cloneTo(t._gradientY),this._gradientZ.cloneTo(t._gradientZ),this._constantMin.cloneTo(t._constantMin),this._constantMax.cloneTo(t._constantMax),this._gradientXMin.cloneTo(t._gradientXMin),this._gradientXMax.cloneTo(t._gradientXMax),this._gradientYMin.cloneTo(t._gradientYMin),this._gradientYMax.cloneTo(t._gradientYMax),this._gradientZMin.cloneTo(t._gradientZMin),this._gradientZMax.cloneTo(t._gradientZMax)},t.clone=function(){var e=new this.constructor;return this.cloneTo(e),e},a(0,t,"gradientZ",function(){return this._gradientZ}),a(0,t,"constant",function(){return this._constant}),a(0,t,"type",function(){return this._type}),a(0,t,"gradientXMax",function(){return this._gradientXMax}),a(0,t,"constantMin",function(){return this._constantMin}),a(0,t,"gradientX",function(){return this._gradientX}),a(0,t,"gradientY",function(){return this._gradientY}),a(0,t,"gradientXMin",function(){return this._gradientXMin}),a(0,t,"constantMax",function(){return this._constantMax}),a(0,t,"gradientYMin",function(){return this._gradientYMin}),a(0,t,"gradientYMax",function(){return this._gradientYMax}),a(0,t,"gradientZMin",function(){return this._gradientZMin}),a(0,t,"gradientZMax",function(){return this._gradientZMax}),e.createByConstant=function(t){var n=new e;return n._type=0,n._constant=t,n},e.createByGradient=function(t,n,i){var r=new e;return r._type=1,r._gradientX=t,r._gradientY=n,r._gradientZ=i,r},e.createByRandomTwoConstant=function(t,n){var i=new e;return i._type=2,i._constantMin=t,i._constantMax=n,i},e.createByRandomTwoGradient=function(t,n,i,r,a,s){var o=new e;return o._type=3,o._gradientXMin=t,o._gradientXMax=n,o._gradientYMin=i,o._gradientYMax=r,o._gradientZMin=a,o._gradientZMax=s,o},e}(),$=function(){function e(e){this._angularVelocity=null,this.enbale=!1,this._angularVelocity=e}r(e,"laya.d3.core.particleShuriKen.module.RotationOverLifetime");var t=e.prototype;return n.imps(t,{"laya.d3.core.IClone":!0}),t.cloneTo=function(e){var t=e;this._angularVelocity.cloneTo(t._angularVelocity),t.enbale=this.enbale},t.clone=function(){var e;switch(this._angularVelocity.type){case 0:e=this._angularVelocity.separateAxes?X.createByConstantSeparate(this._angularVelocity.constantSeparate.clone()):X.createByConstant(this._angularVelocity.constant);break;case 1:e=this._angularVelocity.separateAxes?X.createByGradientSeparate(this._angularVelocity.gradientX.clone(),this._angularVelocity.gradientY.clone(),this._angularVelocity.gradientZ.clone(),this._angularVelocity.gradientW.clone()):X.createByGradient(this._angularVelocity.gradient.clone());break;case 2:e=this._angularVelocity.separateAxes?X.createByRandomTwoConstantSeparate(this._angularVelocity.constantMinSeparate.clone(),this._angularVelocity.constantMaxSeparate.clone()):X.createByRandomTwoConstant(this._angularVelocity.constantMin,this._angularVelocity.constantMax);break;case 3:e=this._angularVelocity.separateAxes?X.createByRandomTwoGradientSeparate(this._angularVelocity.gradientXMin.clone(),this._angularVelocity.gradientYMin.clone(),this._angularVelocity.gradientZMin.clone(),this._angularVelocity.gradientWMin.clone(),this._angularVelocity.gradientXMax.clone(),this._angularVelocity.gradientYMax.clone(),this._angularVelocity.gradientZMax.clone(),this._angularVelocity.gradientWMax.clone()):X.createByRandomTwoGradient(this._angularVelocity.gradientMin.clone(),this._angularVelocity.gradientMax.clone())}var t=new this.constructor(e);return t.enbale=this.enbale,t},a(0,t,"angularVelocity",function(){return this._angularVelocity}),e}(),J=function(){function e(){this.enable=!1,this.randomDirection=!1}r(e,"laya.d3.core.particleShuriKen.module.shape.BaseShape");var t=e.prototype;return n.imps(t,{"laya.d3.core.IClone":!0}),t._getShapeBoundBox=function(e){throw new Error("BaseShape: must override it.")},t._getSpeedBoundBox=function(e){throw new Error("BaseShape: must override it.")},t.generatePositionAndDirection=function(e,t,n,i){throw new Error("BaseShape: must override it.")},t._calculateProceduralBounds=function(e,t,n){this._getShapeBoundBox(e);var i=e.min,r=e.max;ct.multiply(i,t,i),ct.multiply(r,t,r);var a=new Je(new ct,new ct);this.randomDirection?(a.min=new ct(-1,-1,-1),a.max=new ct(1,1,1)):this._getSpeedBoundBox(a);var s=new Je(new ct,new ct),o=s.min,l=s.max;ct.scale(a.min,n.y,o),ct.scale(a.max,n.y,l),ct.add(e.min,o,o),ct.add(e.max,l,l),ct.min(e.min,o,e.min),ct.max(e.max,o,e.max);var h=new Je(new ct,new ct),_=h.min,u=h.max;ct.scale(a.min,n.x,_),ct.scale(a.max,n.x,u),ct.min(h.min,u,o),ct.max(h.min,u,l),ct.min(e.min,o,e.min),ct.max(e.max,o,e.max)},t.cloneTo=function(e){e.enable=this.enable},t.clone=function(){var e=new this.constructor;return this.cloneTo(e),e},e}(),ee=function(){function e(){}return r(e,"laya.d3.core.particleShuriKen.module.shape.ShapeUtils"),e._randomPointUnitArcCircle=function(e,t,n){var i=t.elements,r=NaN;r=n?n.getFloat()*e:Math.random()*e,i[0]=Math.cos(r),i[1]=Math.sin(r)},e._randomPointInsideUnitArcCircle=function(t,n,i){var r=n.elements;e._randomPointUnitArcCircle(t,n,i);var a=NaN;a=i?Math.pow(i.getFloat(),.5):Math.pow(Math.random(),.5),r[0]=r[0]*a,r[1]=r[1]*a},e._randomPointUnitCircle=function(e,t){var n=e.elements,i=NaN;i=t?t.getFloat()*Math.PI*2:Math.random()*Math.PI*2,n[0]=Math.cos(i),n[1]=Math.sin(i)},e._randomPointInsideUnitCircle=function(t,n){var i=t.elements;e._randomPointUnitCircle(t);var r=NaN;r=n?Math.pow(n.getFloat(),.5):Math.pow(Math.random(),.5),i[0]=i[0]*r,i[1]=i[1]*r},e._randomPointUnitSphere=function(e,t){var n=e.elements,i=NaN,r=NaN;t?(i=n[2]=2*t.getFloat()-1,r=t.getFloat()*Math.PI*2):(i=n[2]=2*Math.random()-1,r=Math.random()*Math.PI*2);var a=Math.sqrt(1-i*i);n[0]=a*Math.cos(r),n[1]=a*Math.sin(r)},e._randomPointInsideUnitSphere=function(t,n){var i=t.elements;e._randomPointUnitSphere(t);var r=NaN;r=n?Math.pow(n.getFloat(),1/3):Math.pow(Math.random(),1/3),i[0]=i[0]*r,i[1]=i[1]*r,i[2]=i[2]*r},e._randomPointInsideHalfUnitBox=function(e,t){var n=e.elements;t?(n[0]=t.getFloat()-.5,n[1]=t.getFloat()-.5,n[2]=t.getFloat()-.5):(n[0]=Math.random()-.5,n[1]=Math.random()-.5,n[2]=Math.random()-.5)},e}(),te=function(){function e(e){this._size=null,this.enbale=!1,this._size=e}r(e,"laya.d3.core.particleShuriKen.module.SizeOverLifetime");var t=e.prototype;return n.imps(t,{"laya.d3.core.IClone":!0}),t.cloneTo=function(e){var t=e;this._size.cloneTo(t._size),t.enbale=this.enbale},t.clone=function(){var e;switch(this._size.type){case 0:e=this._size.separateAxes?Q.createByGradientSeparate(this._size.gradientX.clone(),this._size.gradientY.clone(),this._size.gradientZ.clone()):Q.createByGradient(this._size.gradient.clone());break;case 1:e=this._size.separateAxes?Q.createByRandomTwoConstantSeparate(this._size.constantMinSeparate.clone(),this._size.constantMaxSeparate.clone()):Q.createByRandomTwoConstant(this._size.constantMin,this._size.constantMax);break;case 2:e=this._size.separateAxes?Q.createByRandomTwoGradientSeparate(this._size.gradientXMin.clone(),this._size.gradientYMin.clone(),this._size.gradientZMin.clone(),this._size.gradientXMax.clone(),this._size.gradientYMax.clone(),this._size.gradientZMax.clone()):Q.createByRandomTwoGradient(this._size.gradientMin.clone(),this._size.gradientMax.clone())}var t=new this.constructor(e);return t.enbale=this.enbale,t},a(0,t,"size",function(){return this._size}),e}(),ne=function(){function e(){this._type=0,this._constant=NaN,this._constantMin=NaN,this._constantMax=NaN}r(e,"laya.d3.core.particleShuriKen.module.StartFrame");var t=e.prototype;return n.imps(t,{"laya.d3.core.IClone":!0}),t.cloneTo=function(e){var t=e;t._type=this._type,t._constant=this._constant,t._constantMin=this._constantMin,t._constantMax=this._constantMax},t.clone=function(){var e=new this.constructor;return this.cloneTo(e),e},a(0,t,"constant",function(){return this._constant}),a(0,t,"type",function(){return this._type}),a(0,t,"constantMin",function(){return this._constantMin}),a(0,t,"constantMax",function(){return this._constantMax}),e.createByConstant=function(t){var n=new e;return n._type=0,n._constant=t,n},e.createByRandomTwoConstant=function(t,n){var i=new e;return i._type=1,i._constantMin=t,i._constantMax=n,i},e}(),ie=function(){function e(e,t){this._frame=null,this._startFrame=null,this.tiles=null,this.type=0,this.randomRow=!1,this.cycles=0,this.enableUVChannels=0,this.enable=!1,this.tiles=new ut(1,1),this.type=0,this.randomRow=!0,this.cycles=1,this.enableUVChannels=1,this._frame=e,this._startFrame=t}r(e,"laya.d3.core.particleShuriKen.module.TextureSheetAnimation");var t=e.prototype;return n.imps(t,{"laya.d3.core.IClone":!0}),t.cloneTo=function(e){var t=e;this.tiles.cloneTo(t.tiles),t.type=this.type,t.randomRow=this.randomRow,this._frame.cloneTo(t._frame),this._startFrame.cloneTo(t._startFrame),t.cycles=this.cycles,t.enableUVChannels=this.enableUVChannels,t.enable=this.enable},t.clone=function(){var e;switch(this._frame.type){case 0:e=W.createByConstant(this._frame.constant);break;case 1:e=W.createByOverTime(this._frame.frameOverTimeData.clone());break;case 2:e=W.createByRandomTwoConstant(this._frame.constantMin,this._frame.constantMax);break;case 3:e=W.createByRandomTwoOverTime(this._frame.frameOverTimeDataMin.clone(),this._frame.frameOverTimeDataMax.clone())}var t;switch(this._startFrame.type){case 0:t=ne.createByConstant(this._startFrame.constant);break;case 1:t=ne.createByRandomTwoConstant(this._startFrame.constantMin,this._startFrame.constantMax)}var n=new this.constructor(e,t);return this.tiles.cloneTo(n.tiles),n.type=this.type,n.randomRow=this.randomRow,n.cycles=this.cycles,n.enableUVChannels=this.enableUVChannels,n.enable=this.enable,n},a(0,t,"frame",function(){return this._frame}),a(0,t,"startFrame",function(){return this._startFrame}),e}(),re=function(){function e(e){this._velocity=null,this.enbale=!1,this.space=0,this._velocity=e}r(e,"laya.d3.core.particleShuriKen.module.VelocityOverLifetime");var t=e.prototype;return n.imps(t,{"laya.d3.core.IClone":!0}),t.cloneTo=function(e){var t=e;this._velocity.cloneTo(t._velocity),t.enbale=this.enbale,t.space=this.space},t.clone=function(){var e;switch(this._velocity.type){case 0:e=K.createByConstant(this._velocity.constant.clone());break;case 1:e=K.createByGradient(this._velocity.gradientX.clone(),this._velocity.gradientY.clone(),this._velocity.gradientZ.clone());break;case 2:e=K.createByRandomTwoConstant(this._velocity.constantMin.clone(),this._velocity.constantMax.clone());break;case 3:e=K.createByRandomTwoGradient(this._velocity.gradientXMin.clone(),this._velocity.gradientYMin.clone(),this._velocity.gradientZMin.clone(),this._velocity.gradientXMax.clone(),this._velocity.gradientYMax.clone(),this._velocity.gradientZMax.clone())}var t=new this.constructor(e);return t.enbale=this.enbale,t.space=this.space,t},a(0,t,"velocity",function(){return this._velocity}),e}(),ae=function(){function e(){}return r(e,"laya.d3.core.particleShuriKen.ShurikenParticleData"),e._getStartLifetimeFromGradient=function(e,t){for(var n=1,i=e.gradientCount;n<i;n++){var r=e.getKeyByIndex(n);if(r>=t){var a=e.getKeyByIndex(n-1),s=(t-a)/(r-a);return S.lerp(e.getValueByIndex(n-1),e.getValueByIndex(n),s)}}throw new Error("ShurikenParticleData: can't get value foam startLifeTimeGradient.")},e._randomInvertRoationArray=function(e,t,n,i,r){var a=NaN;i?(i.seed=r[6],a=i.getFloat(),r[6]=i.seed):a=Math.random(),a<n?(t[0]=-e[0],t[1]=-e[1],t[2]=-e[2]):(t[0]=e[0],t[1]=e[1],t[2]=e[2])},e._randomInvertRoation=function(e,t,n,i){var r=NaN;return n?(n.seed=i[6],r=n.getFloat(),i[6]=n.seed):r=Math.random(),r<t&&(e=-e),e},e.create=function(t,n,i){var r=t.autoRandomSeed,a=t._rand,s=t._randomSeeds;switch(t.startColorType){case 0:var o=t.startColorConstant.elements;e.startColor[0]=o[0],e.startColor[1]=o[1],e.startColor[2]=o[2],e.startColor[3]=o[3];break;case 2:r?S.lerpVector4(t.startColorConstantMin.elements,t.startColorConstantMax.elements,Math.random(),e.startColor):(a.seed=s[3],S.lerpVector4(t.startColorConstantMin.elements,t.startColorConstantMax.elements,a.getFloat(),e.startColor),s[3]=a.seed)}var l=t.colorOverLifetime;if(l&&l.enbale){var h=l.color;switch(h.type){case 0:e.startColor[0]=e.startColor[0]*h.constant.x,e.startColor[1]=e.startColor[1]*h.constant.y,e.startColor[2]=e.startColor[2]*h.constant.z,e.startColor[3]=e.startColor[3]*h.constant.w;break;case 2:var _=NaN;r?_=Math.random():(a.seed=s[10],_=a.getFloat(),s[10]=a.seed);var u=h.constantMin,c=h.constantMax;e.startColor[0]=e.startColor[0]*S.lerp(u.x,c.x,_),e.startColor[1]=e.startColor[1]*S.lerp(u.y,c.y,_),e.startColor[2]=e.startColor[2]*S.lerp(u.z,c.z,_),e.startColor[3]=e.startColor[3]*S.lerp(u.w,c.w,_)}}var d=e.startSize;switch(t.startSizeType){case 0:if(t.threeDStartSize){var f=t.startSizeConstantSeparate;d[0]=f.x,d[1]=f.y,d[2]=f.z}else d[0]=d[1]=d[2]=t.startSizeConstant;break;case 2:if(t.threeDStartSize){var m=t.startSizeConstantMinSeparate,p=t.startSizeConstantMaxSeparate;r?(d[0]=S.lerp(m.x,p.x,Math.random()),d[1]=S.lerp(m.y,p.y,Math.random()),d[2]=S.lerp(m.z,p.z,Math.random())):(a.seed=s[4],d[0]=S.lerp(m.x,p.x,a.getFloat()),d[1]=S.lerp(m.y,p.y,a.getFloat()),d[2]=S.lerp(m.z,p.z,a.getFloat()),s[4]=a.seed)}else r?d[0]=d[1]=d[2]=S.lerp(t.startSizeConstantMin,t.startSizeConstantMax,Math.random()):(a.seed=s[4],d[0]=d[1]=d[2]=S.lerp(t.startSizeConstantMin,t.startSizeConstantMax,a.getFloat()),s[4]=a.seed)}var v=t.sizeOverLifetime;if(v&&v.enbale&&1===v.size.type){var g=v.size;if(g.separateAxes)r?(d[0]=d[0]*S.lerp(g.constantMinSeparate.x,g.constantMaxSeparate.x,Math.random()),d[1]=d[1]*S.lerp(g.constantMinSeparate.y,g.constantMaxSeparate.y,Math.random()),d[2]=d[2]*S.lerp(g.constantMinSeparate.z,g.constantMaxSeparate.z,Math.random())):(a.seed=s[11],d[0]=d[0]*S.lerp(g.constantMinSeparate.x,g.constantMaxSeparate.x,a.getFloat()),d[1]=d[1]*S.lerp(g.constantMinSeparate.y,g.constantMaxSeparate.y,a.getFloat()),d[2]=d[2]*S.lerp(g.constantMinSeparate.z,g.constantMaxSeparate.z,a.getFloat()),s[11]=a.seed);else{var x=NaN;r?x=S.lerp(g.constantMin,g.constantMax,Math.random()):(a.seed=s[11],x=S.lerp(g.constantMin,g.constantMax,a.getFloat()),s[11]=a.seed),d[0]=d[0]*x,d[1]=d[1]*x,d[2]=d[2]*x}}var E=n.renderMode;if(1!==E)switch(t.startRotationType){case 0:if(t.threeDStartRotation){var D=t.startRotationConstantSeparate,T=e._tempVector30.elements;e._randomInvertRoationArray(D.elements,T,t.randomizeRotationDirection,r?null:a,s),e.startRotation[0]=T[0],e.startRotation[1]=T[1],e.startRotation[2]=4!==E?-T[2]:T[2]}else e.startRotation[0]=e._randomInvertRoation(t.startRotationConstant,t.randomizeRotationDirection,r?null:a,s);break;case 2:if(t.threeDStartRotation){var M=t.startRotationConstantMinSeparate,y=t.startRotationConstantMaxSeparate,R=e._tempVector30.elements;r?(R[0]=S.lerp(M.x,y.x,Math.random()),R[1]=S.lerp(M.y,y.y,Math.random()),R[2]=S.lerp(M.z,y.z,Math.random())):(a.seed=s[5],R[0]=S.lerp(M.x,y.x,a.getFloat()),R[1]=S.lerp(M.y,y.y,a.getFloat()),R[2]=S.lerp(M.z,y.z,a.getFloat()),s[5]=a.seed),e._randomInvertRoationArray(R,R,t.randomizeRotationDirection,r?null:a,s),e.startRotation[0]=R[0],e.startRotation[1]=R[1],e.startRotation[2]=4!==E?-R[2]:R[2]}else r?e.startRotation[0]=e._randomInvertRoation(S.lerp(t.startRotationConstantMin,t.startRotationConstantMax,Math.random()),t.randomizeRotationDirection,r?null:a,s):(a.seed=s[5],e.startRotation[0]=e._randomInvertRoation(S.lerp(t.startRotationConstantMin,t.startRotationConstantMax,a.getFloat()),t.randomizeRotationDirection,r?null:a,s),s[5]=a.seed)}switch(t.startLifetimeType){case 0:e.startLifeTime=t.startLifetimeConstant;break;case 1:e.startLifeTime=e._getStartLifetimeFromGradient(t.startLifeTimeGradient,t.emissionTime);break;case 2:r?e.startLifeTime=S.lerp(t.startLifetimeConstantMin,t.startLifetimeConstantMax,Math.random()):(a.seed=s[7],e.startLifeTime=S.lerp(t.startLifetimeConstantMin,t.startLifetimeConstantMax,a.getFloat()),s[7]=a.seed);break;case 3:var A=t.emissionTime;r?e.startLifeTime=S.lerp(e._getStartLifetimeFromGradient(t.startLifeTimeGradientMin,A),e._getStartLifetimeFromGradient(t.startLifeTimeGradientMax,A),Math.random()):(a.seed=s[7],e.startLifeTime=S.lerp(e._getStartLifetimeFromGradient(t.startLifeTimeGradientMin,A),e._getStartLifetimeFromGradient(t.startLifeTimeGradientMax,A),a.getFloat()),s[7]=a.seed)}switch(t.startSpeedType){case 0:e.startSpeed=t.startSpeedConstant;break;case 2:r?e.startSpeed=S.lerp(t.startSpeedConstantMin,t.startSpeedConstantMax,Math.random()):(a.seed=s[8],e.startSpeed=S.lerp(t.startSpeedConstantMin,t.startSpeedConstantMax,a.getFloat()),s[8]=a.seed)}var C=t.textureSheetAnimation;if(C&&C.enable){var I=C.tiles,w=I.x,V=I.y,N=1/w,O=1/V,b=0,P=C.randomRow;switch(C.type){case 0:w*V;break;case 1:w,P?r?b=Math.round(Math.random()*V):(a.seed=s[13],b=Math.round(a.getFloat()*V),s[13]=a.seed):b=0}var L=0,F=C.startFrame;switch(F.type){case 0:L=F.constant;break;case 1:r?L=Math.round(S.lerp(F.constantMin,F.constantMax,Math.random())):(a.seed=s[14],L=Math.round(S.lerp(F.constantMin,F.constantMax,a.getFloat())),s[14]=a.seed)}var B=C.frame;switch(B.type){case 0:L+=B.constant;break;case 2:r?L+=Math.round(S.lerp(B.constantMin,B.constantMax,Math.random())):(a.seed=s[15],L+=Math.round(S.lerp(B.constantMin,B.constantMax,a.getFloat())),s[15]=a.seed)}P||(b=Math.floor(L/w));var U=L%w;(e.startUVInfo=e.startUVInfo)[0]=N,e.startUVInfo[1]=O,e.startUVInfo[2]=U*N,e.startUVInfo[3]=b*O}else(e.startUVInfo=e.startUVInfo)[0]=1,e.startUVInfo[1]=1,e.startUVInfo[2]=0,e.startUVInfo[3]=0;switch(t.simulationSpace){case 0:var H=i.position.elements;e.simulationWorldPostion[0]=H[0],e.simulationWorldPostion[1]=H[1],e.simulationWorldPostion[2]=H[2];var z=i.rotation.elements;e.simulationWorldRotation[0]=z[0],e.simulationWorldRotation[1]=z[1],e.simulationWorldRotation[2]=z[2],e.simulationWorldRotation[3]=z[3];break;case 1:break;default:throw new Error("ShurikenParticleMaterial: SimulationSpace value is invalid.")}},e.startLifeTime=NaN,e.startSpeed=NaN,i(e,["_tempVector30",function(){return this._tempVector30=new ct},"_tempQuaternion",function(){return this._tempQuaternion=new lt},"startColor",function(){return this.startColor=new Float32Array(4)},"startSize",function(){return this.startSize=new Float32Array(3)},"startRotation",function(){return this.startRotation=new Float32Array(3)},"startUVInfo",function(){return this.startUVInfo=new Float32Array(4)},"simulationWorldPostion",function(){return this.simulationWorldPostion=new Float32Array(3)},"simulationWorldRotation",function(){return this.simulationWorldRotation=new Float32Array(4)}]),e}(),se=function(){function e(){this._tempInt0=0,this._tempInt1=0,this._tempUint0=0,this._tempUint1=0,this._tempUint2=0,this._tempUint3=0,this._tempUint4=0,this._tempUint5=0,this._tempUint6=0,this._tempUint7=0,this._tempNumver0=NaN,this._tempNumver1=NaN,this._tempNumver2=NaN,this._tempNumver3=NaN,this._floatSizePerVer=7,this._defaultBufferSize=600*this._floatSizePerVer,this._vb=null,this._posInVBData=0,this._ib=null,this._posInIBData=0,this._primitiveType=NaN,this._hasBegun=!1,this._numVertsPerPrimitive=0,this._camera=null,this._sharderNameID=0,this._shader=null,this._shaderCompile=null,this._vbData=new Float32Array(this._defaultBufferSize),this._ibData=new Uint16Array(this._defaultBufferSize),this._spriteShaderValue=new gt,this._vb=En.create(e._vertexDeclaration,this._defaultBufferSize/this._floatSizePerVer,35048),this._ib=xn.create("ushort",this._defaultBufferSize,35048),this._sharderNameID=cn.nameKey.getID("LINE"),this._shaderCompile=pt._preCompileShader[this._sharderNameID]}r(e,"laya.d3.core.PhasorSpriter3D");var t=e.prototype;return t.line=function(e,t,n,i){return this._hasBegun&&1===this._primitiveType||this.drawLinesException(),(this._posInVBData+2*this._floatSizePerVer>this._vbData.length||this._posInIBData+2>this._ibData.length)&&this.flush(),this._tempUint0=this._posInVBData/this._floatSizePerVer,this.addVertex(e.x,e.y,e.z,t.x,t.y,t.z,t.w),this.addVertex(n.x,n.y,n.z,i.x,i.y,i.z,i.w),this.addIndexes(this._tempUint0,this._tempUint0+1),this},t.circle=function(e,t,n,i,r,a){for(this._hasBegun&&1===this._primitiveType||this.drawLinesException(),this._tempUint0=2*t,(this._posInVBData+this._tempUint0*this._floatSizePerVer>this._vbData.length||this._posInIBData+2*this._tempUint0>this._ibData.length)&&this.flush(),this._tempUint1=this._posInVBData/this._floatSizePerVer,this._tempNumver0=0,this._tempInt0=0;this._tempNumver0<6.2832;this._tempNumver0=this._tempNumver0+3.1416/t,this._tempInt0++)this.addVertex(Math.sin(this._tempNumver0)*e,Math.cos(this._tempNumver0)*e,0,n,i,r,a),0===this._tempInt0?this.addIndexes(this._tempUint1):this._tempInt0===this._tempUint0-1?(this._tempUint2=this._tempUint1+this._tempInt0,this.addIndexes(this._tempUint2,this._tempUint2,this._tempUint1)):(this._tempUint2=this._tempUint1+this._tempInt0,this.addIndexes(this._tempUint2,this._tempUint2));return this},t.plane=function(e,t,n,i,r,a,s,o,l){return this._hasBegun&&4===this._primitiveType||this.drawTrianglesException(),(this._posInVBData+4*this._floatSizePerVer>this._vbData.length||this._posInIBData+6>this._ibData.length)&&this.flush(),this._tempNumver0=i/2,this._tempNumver1=r/2,this._tempUint0=this._posInVBData/this._floatSizePerVer,this.addVertex(e-this._tempNumver0,t+this._tempNumver1,n,a,s,o,l),this.addVertex(e+this._tempNumver0,t+this._tempNumver1,n,a,s,o,l),this.addVertex(e-this._tempNumver0,t-this._tempNumver1,n,a,s,o,l),this.addVertex(e+this._tempNumver0,t-this._tempNumver1,n,a,s,o,l),this._tempUint1=this._tempUint0+1,this._tempUint2=this._tempUint0+2,this.addIndexes(this._tempUint0,this._tempUint1,this._tempUint2,this._tempUint2,this._tempUint1,this._tempUint0+3),this},t.box=function(e,t,n,i,r,a,s,o,l,h){return this._hasBegun&&4===this._primitiveType||this.drawTrianglesException(),(this._posInVBData+8*this._floatSizePerVer>this._vbData.length||this._posInIBData+36>this._ibData.length)&&this.flush(),this._tempNumver0=i/2,this._tempNumver1=r/2,this._tempNumver2=a/2,this._tempUint0=this._posInVBData/this._floatSizePerVer,this.addVertex(e-this._tempNumver0,t+this._tempNumver1,n+this._tempNumver2,s,o,l,h),this.addVertex(e+this._tempNumver0,t+this._tempNumver1,n+this._tempNumver2,s,o,l,h),this.addVertex(e-this._tempNumver0,t-this._tempNumver1,n+this._tempNumver2,s,o,l,h),this.addVertex(e+this._tempNumver0,t-this._tempNumver1,n+this._tempNumver2,s,o,l,h),this.addVertex(e+this._tempNumver0,t+this._tempNumver1,n-this._tempNumver2,s,o,l,h),this.addVertex(e-this._tempNumver0,t+this._tempNumver1,n-this._tempNumver2,s,o,l,h),this.addVertex(e+this._tempNumver0,t-this._tempNumver1,n-this._tempNumver2,s,o,l,h),this.addVertex(e-this._tempNumver0,t-this._tempNumver1,n-this._tempNumver2,s,o,l,h),this._tempUint1=this._tempUint0+1,this._tempUint2=this._tempUint0+2,this._tempUint3=this._tempUint0+3,this._tempUint4=this._tempUint0+4,this._tempUint5=this._tempUint0+5,this._tempUint6=this._tempUint0+6,this._tempUint7=this._tempUint0+7,this.addIndexes(this._tempUint0,this._tempUint1,this._tempUint2,this._tempUint2,this._tempUint1,this._tempUint3,this._tempUint4,this._tempUint5,this._tempUint6,this._tempUint6,this._tempUint5,this._tempUint7,this._tempUint5,this._tempUint0,this._tempUint7,this._tempUint7,this._tempUint0,this._tempUint2,this._tempUint1,this._tempUint4,this._tempUint3,this._tempUint3,this._tempUint4,this._tempUint6,this._tempUint5,this._tempUint4,this._tempUint0,this._tempUint0,this._tempUint4,this._tempUint1,this._tempUint2,this._tempUint3,this._tempUint7,this._tempUint7,this._tempUint3,this._tempUint6),this},t.cone=function(e,t,n,i,r,a,s){for(this._hasBegun&&4===this._primitiveType||this.drawTrianglesException(),(this._posInVBData+(2*n+2)*this._floatSizePerVer>this._vbData.length||this._posInIBData+6*n>this._ibData.length)&&this.flush(),this._tempUint0=this._posInVBData,this._tempUint1=this._posInVBData/this._floatSizePerVer,this._tempNumver0=2*Math.PI/n,this.addVertexIndex(0,t,0,i,r,a,s,this._tempUint0),this.addVertexIndex(0,0,0,i,r,a,s,this._tempUint0+this._floatSizePerVer),this._tempInt0=2,this._tempNumver1=0,this._tempInt1=0;this._tempInt1<n;this._tempInt1++)this._tempNumver2=Math.cos(this._tempNumver1),this._tempNumver3=Math.sin(this._tempNumver1),this.addVertexIndex(e*this._tempNumver2,0,e*this._tempNumver3,i,r,a,s,this._tempUint0+this._tempInt0*this._floatSizePerVer),this.addIndexes(this._tempUint1,this._tempUint1+this._tempInt0),this._tempInt1==n-1?this.addIndexes(this._tempUint1+2):this.addIndexes(this._tempUint1+this._tempInt0+1),this.addVertexIndex(e*this._tempNumver2,0,e*this._tempNumver3,i,r,a,s,this._tempUint0+(this._tempInt0+n)*this._floatSizePerVer),this.addIndexes(this._tempUint1+1),this._tempInt1==n-1?this.addIndexes(this._tempUint1+n+2):this.addIndexes(this._tempUint1+this._tempInt0+n+1),this.addIndexes(this._tempUint1+this._tempInt0+n),this._tempInt0++,this._tempNumver1+=this._tempNumver0;return this},t.boundingBoxLine=function(e,t,n,i,r,a,s,o,l,h){return this._hasBegun&&1===this._primitiveType||this.drawLinesException(),(this._posInVBData+8*this._floatSizePerVer>this._vbData.length||this._posInIBData+48>this._ibData.length)&&this.flush(),this._tempUint0=this._posInVBData/this._floatSizePerVer,this.addVertex(e,r,a,s,o,l,h),this.addVertex(i,r,a,s,o,l,h),this.addVertex(e,t,a,s,o,l,h),this.addVertex(i,t,a,s,o,l,h),this.addVertex(i,r,n,s,o,l,h),this.addVertex(e,r,n,s,o,l,h),this.addVertex(i,t,n,s,o,l,h),this.addVertex(e,t,n,s,o,l,h),this._tempUint1=this._tempUint0+1,this._tempUint2=this._tempUint0+2,this._tempUint3=this._tempUint0+3,this._tempUint4=this._tempUint0+4,this._tempUint5=this._tempUint0+5,this._tempUint6=this._tempUint0+6,this._tempUint7=this._tempUint0+7,this.addIndexes(this._tempUint0,this._tempUint1,this._tempUint1,this._tempUint3,this._tempUint3,this._tempUint2,this._tempUint2,this._tempUint0,this._tempUint4,this._tempUint5,this._tempUint5,this._tempUint7,this._tempUint7,this._tempUint6,this._tempUint6,this._tempUint4,this._tempUint5,this._tempUint0,this._tempUint0,this._tempUint2,this._tempUint2,this._tempUint7,this._tempUint7,this._tempUint5,this._tempUint1,this._tempUint4,this._tempUint4,this._tempUint6,this._tempUint6,this._tempUint3,this._tempUint3,this._tempUint1,this._tempUint5,this._tempUint4,this._tempUint4,this._tempUint1,this._tempUint1,this._tempUint0,this._tempUint0,this._tempUint5,this._tempUint2,this._tempUint3,this._tempUint3,this._tempUint6,this._tempUint6,this._tempUint7,this._tempUint7,this._tempUint2),this},t.addVertex=function(e,t,n,i,r,a,s){return this._hasBegun||this.addVertexIndexException(),this._vbData[this._posInVBData]=e,this._vbData[this._posInVBData+1]=t,this._vbData[this._posInVBData+2]=n,this._vbData[this._posInVBData+3]=i,this._vbData[this._posInVBData+4]=r,this._vbData[this._posInVBData+5]=a,this._vbData[this._posInVBData+6]=s,this._posInVBData+=this._floatSizePerVer,this},t.addVertexIndex=function(e,t,n,i,r,a,s,o){return this._hasBegun||this.addVertexIndexException(),this._vbData[o]=e,this._vbData[o+1]=t,this._vbData[o+2]=n,this._vbData[o+3]=i,this._vbData[o+4]=r,this._vbData[o+5]=a,this._vbData[o+6]=s,(o+=this._floatSizePerVer)>this._posInVBData&&(this._posInVBData=o),this},t.addIndexes=function(e){var t=arguments;this._hasBegun||this.addVertexIndexException();for(var n=0;n<t.length;n++)this._ibData[this._posInIBData]=t[n],this._posInIBData++;return this},t.begin=function(e,t){return this._hasBegun&&this.beginException0(),1!==e&&4!==e&&this.beginException1(),this._primitiveType=e,this._camera=t,this._hasBegun=!0,this},t.end=function(){return this._hasBegun||this.endException(),this.flush(),this._hasBegun=!1,this},t.flush=function(){0!==this._posInVBData&&(this._ib.setData(this._ibData),this._vb.setData(this._vbData),this._vb._bind(),this._ib._bind(),this._shader=this._shaderCompile.withCompile(0,0,0),this._shader.bind(),this._shader.uploadAttributes(e._vertexDeclaration.shaderValues.data,null),this._spriteShaderValue.setValue(1,this._camera.projectionViewMatrix.elements),this._shader.uploadSpriteUniforms(this._spriteShaderValue.data),C.drawCall++,N.mainContext.drawElements(this._primitiveType,this._posInIBData,5123,0),this._posInIBData=0,this._posInVBData=0)},t.addVertexIndexException=function(){throw new Error("请先调用begin()函数")},t.beginException0=function(){throw new Error("调用begin()前请确保已成功调用end()！")},t.beginException1=function(){throw new Error("只支持“LINES”和“TRIANGLES”两种基元！")},t.endException=function(){throw new Error("调用end()前请确保已成功调用begin()！")},t.drawLinesException=function(){throw new Error("您必须确保在此之前已调用begin()且使用“LINES”基元！")},t.drawTrianglesException=function(){throw new Error("您必须确保在此之前已调用begin()且使用“TRIANGLES”基元！")},i(e,["_vertexDeclaration",function(){return this._vertexDeclaration=new pe(28,[new ve(0,"vector3",0),new ve(12,"vector4",1)])}]),e}(),oe=function(){function e(){this._id=0,this._type=0,this._mainSortID=0,this._render=null,this._sprite3D=null,this._material=null,this._renderObj=null,this._staticBatch=null,this._tempBatchIndexStart=0,this._tempBatchIndexEnd=0,this._canDynamicBatch=!1,this._shaderValue=null,this._onPreRenderFunction=null,this._conchSubmesh=null,this._id=++e._uniqueIDCounter,this._canDynamicBatch=!0,this._shaderValue=new gt,T.isConchNode&&(this._conchSubmesh=new ConchSubmesh)}r(e,"laya.d3.core.render.RenderElement");var t=e.prototype;return t.getDynamicBatchBakedVertexs=function(e){for(var t=this._renderObj._getVertexBuffer(e),n=t.getData().slice(),i=t.vertexDeclaration,r=i.getVertexElementByUsage(0).offset/4,a=i.getVertexElementByUsage(3).offset/4,s=this._sprite3D.transform,o=s.worldMatrix,l=s.rotation,h=i.vertexStride/4,_=0,u=n.length;_<u;_+=h){var c=_+r,d=_+a;Ct.transformVector3ArrayToVector3ArrayCoordinate(n,c,o,n,c),Ct.transformVector3ArrayByQuat(n,d,l,n,d)}return n},t.getBakedIndices=function(){return this._renderObj._getIndexBuffer().getData()},t._destroy=function(){this._staticBatch&&this._staticBatch._manager._garbageCollection(this)},a(0,t,"id",function(){return this._id}),a(0,t,"renderObj",function(){return this._renderObj},function(e){this._renderObj!==e&&(this._renderObj=e)}),e._uniqueIDCounter=0,e}(),le=function(){function e(t){this._id=0,this._needSort=!1,this._renderElements=null,this._renderableRenderObjects=null,this._dynamicBatchCombineRenderElements=null,this._finalElements=null,this._scene=null,this._id=++e._uniqueIDCounter,this._needSort=!1,this._scene=t,this._renderElements=[],this._renderableRenderObjects=[],this._dynamicBatchCombineRenderElements=[]}r(e,"laya.d3.core.render.RenderQueue");var t=e.prototype;return t._sortOpaqueFunc=function(e,t){return e._render&&t._render?e._render._distanceForSort-t._render._distanceForSort:0},t._sortAlphaFunc=function(e,t){return e._render&&t._render?t._render._distanceForSort-e._render._distanceForSort:0},t._begainRenderElement=function(e,t,n){return!!t._beforeRender(e)},t._sortAlpha=function(t){e._cameraPosition=t,this._finalElements.sort(this._sortAlphaFunc)},t._sortOpaque=function(t){e._cameraPosition=t,this._finalElements.sort(this._sortOpaqueFunc)},t._preRender=function(e){this._finalElements=this._renderElements.concat(this._dynamicBatchCombineRenderElements)},t._render=function(e,t){for(var n,i,r,a,s,o=C.loopCount,l=this._scene,h=e.camera,_=(h.id,!1),u=0,c=this._finalElements.length;u<c;u++){var d,f,m,p=this._finalElements[u];if(null!=p._onPreRenderFunction&&p._onPreRenderFunction.call(p._sprite3D,e),0===p._type)e.owner=m=p._sprite3D,e.renderElement=p,m._preRenderUpdateComponents(e),d=p.renderObj,f=p._material,this._begainRenderElement(e,d,f)&&(i=(n=d._getVertexBuffer(0)).vertexDeclaration,_=(r=e._shader=f._getShader(l._shaderDefineValue,i.shaderDefineValue,m._shaderDefineValue)).bind()||o!==r._uploadLoopCount,(r._uploadVertexBuffer!==n||_)&&(r.uploadAttributes(i.shaderValues.data,null),r._uploadVertexBuffer=n),(r._uploadScene!==l||_)&&(r.uploadSceneUniforms(l._shaderValues.data),r._uploadScene=l),(h!==r._uploadCamera||r._uploadSprite3D!==m||_)&&(r.uploadSpriteUniforms(m._shaderValues.data),r._uploadSprite3D=m),(h!==r._uploadCamera||_)&&(r.uploadCameraUniforms(h._shaderValues.data),r._uploadCamera=h),(r._uploadMaterial!==f||_)&&(f._upload(),r._uploadMaterial=f),a!==f?(f._setRenderStateBlendDepth(),f._setRenderStateFrontFace(t,m.transform),a=f,s=m):s!==m&&(f._setRenderStateFrontFace(t,m.transform),s=m),d._render(e),r._uploadLoopCount=o),m._postRenderUpdateComponents(e);else if(2===p._type){p.renderObj;e.owner=m=p._sprite3D,e.renderElement=p,e._batchIndexStart=p._tempBatchIndexStart,e._batchIndexEnd=p._tempBatchIndexEnd,d=p.renderObj,f=p._material,this._begainRenderElement(e,d,f)&&(i=(n=d._getVertexBuffer(0)).vertexDeclaration,_=(r=e._shader=f._getShader(l._shaderDefineValue,i.shaderDefineValue,m._shaderDefineValue)).bind()||o!==r._uploadLoopCount,(r._uploadVertexBuffer!==n||_)&&(r.uploadAttributes(i.shaderValues.data,null),r._uploadVertexBuffer=n),(r._uploadScene!==l||_)&&(r.uploadSceneUniforms(l._shaderValues.data),r._uploadScene=l),(h!==r._uploadCamera||r._uploadSprite3D!==m||_)&&(r.uploadSpriteUniforms(m._shaderValues.data),r._uploadSprite3D=m),(h!==r._uploadCamera||_)&&(r.uploadCameraUniforms(h._shaderValues.data),r._uploadCamera=h),(r._uploadMaterial!==f||_)&&(f._upload(),r._uploadMaterial=f),a!==f?(f._setRenderStateBlendDepth(),f._setRenderStateFrontFace(t,m.transform),a=f,s=m):s!==m&&(f._setRenderStateFrontFace(t,m.transform),s=m),d._render(e),r._uploadLoopCount=o)}}},t._renderShadow=function(e,t){for(var n,i,r,a,s,o=C.loopCount,l=this._scene,h=e.camera,_=!1,u=0,c=this._finalElements.length;u<c;u++){var d,f,m,p=this._finalElements[u];0===p._type&&(e.owner=m=p._sprite3D,t||m._projectionViewWorldUpdateCamera===h&&m._projectionViewWorldUpdateLoopCount===C.loopCount||(m._render._renderUpdate(e._projectionViewMatrix),m._projectionViewWorldUpdateLoopCount=C.loopCount,m._projectionViewWorldUpdateCamera=h),e.renderElement=p,m._preRenderUpdateComponents(e),d=p.renderObj,f=p._material,this._begainRenderElement(e,d,null)&&(i=(n=d._getVertexBuffer(0)).vertexDeclaration,_=(r=e._shader=f._getShader(l._shaderDefineValue,i.shaderDefineValue,m._shaderDefineValue)).bind()||o!==r._uploadLoopCount,(r._uploadVertexBuffer!==n||_)&&(r.uploadAttributes(i.shaderValues.data,null),r._uploadVertexBuffer=n),(h!==r._uploadCamera||r._uploadSprite3D!==m||_)&&(r.uploadSpriteUniforms(m._shaderValues.data),r._uploadSprite3D=m),(h!==r._uploadCamera||_)&&(r.uploadCameraUniforms(h._shaderValues.data),r._uploadCamera=h),(r._uploadMaterial!==f||_)&&(f._upload(),r._uploadMaterial=f),r._uploadRenderElement,a!==f?(f._setRenderStateFrontFace(!1,m.transform),a=f,s=m):s!==m&&(f._setRenderStateFrontFace(!1,m.transform),s=m),d._render(e),r._uploadLoopCount=o),m._postRenderUpdateComponents(e))}},t._clearRenderElements=function(){this._dynamicBatchCombineRenderElements.length=0,this._renderElements.length=0,this._needSort=!0},t._addRenderElement=function(e){this._renderElements.push(e),this._needSort=!0},t._addDynamicBatchElement=function(e){this._dynamicBatchCombineRenderElements.push(e)},a(0,t,"id",function(){return this._id}),e._uniqueIDCounter=0,e.OPAQUE=1,e.TRANSPARENT=2,e._cameraPosition=null,e}(),he=function(){function e(){this._staticBatch=null,this._batchIndexStart=0,this._batchIndexEnd=0,this._viewMatrix=null,this._projectionMatrix=null,this._projectionViewMatrix=null,this._viewport=null,this._shader=null,this.elapsedTime=NaN,this.scene=null,this.owner=null,this.renderElement=null,this.camera=null}return r(e,"laya.d3.core.render.RenderState"),e.clientWidth=0,e.clientHeight=0,e}(),_e=function(){function e(e,t){this._exactBox=null,this._relaxBox=null,this._corners=[new ct,new ct,new ct,new ct,new ct,new ct,new ct,new ct],this._scene=null,this._parent=null,this._currentDepth=0,this._boundingSphere=new tt(new ct,0),this._boundingBoxCenter=new ct,this._children=s(8),this._objects=[],this._tempBoundBoxCorners=[],this._scene=e,this._currentDepth=t}r(e,"laya.d3.core.scene.OctreeNode");var t=e.prototype;return n.imps(t,{"laya.d3.core.scene.ITreeNode":!0}),t.init=function(e,t){var n=new ct,i=new ct;ct.scale(t,-.5,n),ct.scale(t,.5,i),ct.add(n,e,n),ct.add(i,e,i),this.exactBox=new Je(n,i),this.relaxBox=new Je(n,i)},t.addTreeNode=function(e){1===nt.boxContainsBox(this._relaxBox,e.boundingBox)?this.addNodeDown(e,0):this.addObject(e)},t.addChild=function(t){var n=this._children[t];if(null==n){n=new e(this._scene,this._currentDepth+1),this._children[t]=n,n._parent=this,ct.subtract(this._exactBox.max,this._exactBox.min,e.tempSize),ct.multiply(e.tempSize,e._octreeSplit[t],e.tempCenter),ct.add(this._exactBox.min,e.tempCenter,e.tempCenter),ct.scale(e.tempSize,.25,e.tempSize);var i=new ct,r=new ct;ct.subtract(e.tempCenter,e.tempSize,i),ct.add(e.tempCenter,e.tempSize,r),n.exactBox=new Je(i,r),ct.scale(e.tempSize,e.relax,e.tempSize);var a=new ct,s=new ct;ct.subtract(e.tempCenter,e.tempSize,a),ct.add(e.tempCenter,e.tempSize,s),n.relaxBox=new Je(a,s)}return n},t.addObject=function(e){e._treeNode=this,this._objects.push(e)},t.removeObject=function(e){if(e._treeNode!=this)return console.log("OctreeNode::removeObject error"),!1;var t=this._objects.indexOf(e);return-1!==t&&(this._objects.splice(t,1),!0)},t.clearObject=function(){this._objects.length=0},t.addNodeUp=function(e,t){this._parent&&1!==nt.boxContainsBox(this._exactBox,e.boundingBox)?this._parent.addNodeUp(e,t-1):this.addNodeDown(e,t)},t.addNodeDown=function(e,t){if(t<this._scene.treeLevel){var n=this.inChildIndex(e.boundingBoxCenter),i=this.addChild(n);1===nt.boxContainsBox(i._relaxBox,e.boundingBox)?i.addNodeDown(e,++t):this.addObject(e)}else this.addObject(e)},t.inChildIndex=function(e){return 4*(e.z<this._boundingBoxCenter.z?0:1)+2*(e.y<this._boundingBoxCenter.y?0:1)+(e.x<this._boundingBoxCenter.x?0:1)},t.updateObject=function(e){1===nt.boxContainsBox(this._relaxBox,e.boundingBox)?(this.removeObject(e),e._treeNode=null,this.addNodeDown(e,this._currentDepth)):this._parent&&(this.removeObject(e),e._treeNode=null,this._parent.addNodeUp(e,this._currentDepth-1))},t.cullingObjects=function(e,t,n,i,r){var a=0,s=0,o=0,l=0,h=this._scene._dynamicBatchManager;for(a=0,o=this._objects.length;a<o;a++){var _=this._objects[a];if(H.isVisible(_._owner.layer.mask)&&_.enable){if(t&&(C.treeSpriteCollision+=1,0===e.containsBoundSphere(_.boundingSphere)))continue;_._renderUpdate(r),_._distanceForSort=ct.distance(_.boundingSphere.center,i)+_.sortingFudge;var u=_._renderElements;for(s=0,l=u.length;s<l;s++){var c=u[s],d=c._staticBatch;if(d&&d._material===c._material)d._addBatchRenderElement(c);else{var f=c.renderObj;f.triangleCount<10&&1===f._vertexBufferCount&&f._getIndexBuffer()&&c._material.renderQueue<2&&c._canDynamicBatch&&!_._owner.isStatic?h._addPrepareRenderElement(c):this._scene.getRenderQueue(c._material.renderQueue)._addRenderElement(c)}}}}for(a=0;a<8;a++){var m=this._children[a];if(null!=m){var p=t;if(t){var v=e.containsBoundBox(m._relaxBox);if(C.treeNodeCollision+=1,0===v)continue;p=2===v}m.cullingObjects(e,p,n,i,r)}}},t.cullingShadowObjects=function(e,t,n,i,r){var a=0,s=0,o=0,l=0;this._scene._dynamicBatchManager;for(a=0,o=this._objects.length;a<o;a++){var h=this._objects[a];if(h.castShadow&&H.isVisible(h._owner.layer.mask)&&h.enable){if(n&&0===e[0].containsBoundSphere(h.boundingSphere))continue;for(var _=1,u=e.length;_<u;_++){var c=t[_-1];if(0!==e[_].containsBoundSphere(h.boundingSphere)){var d=h._renderElements;for(s=0,l=d.length;s<l;s++)c._addRenderElement(d[s])}}}}for(a=0;a<8;a++){var f=this._children[a];if(null!=f){var m=n;if(n){var p=e[0].containsBoundBox(f._relaxBox);if(0===p)continue;m=2===p}f.cullingShadowObjects(e,t,m,i,r)}}},t.cullingShadowObjectsOnePSSM=function(e,t,n,i,r,a){var s=t[0],o=0,l=0,h=0,_=0;for(o=0,h=this._objects.length;o<h;o++){var u=this._objects[o];if(u.castShadow&&H.isVisible(u._owner.layer.mask)&&u.enable){if(i&&0===e.containsBoundSphere(u.boundingSphere))continue;u._renderUpdate(n);var c=u._renderElements;for(l=0,_=c.length;l<_;l++)s._addRenderElement(c[l])}}for(o=0;o<8;o++){var d=this._children[o];if(null!=d){var f=i;if(i){var m=e.containsBoundBox(d._relaxBox);if(0===m)continue;f=2===m}d.cullingShadowObjectsOnePSSM(e,t,n,f,r,a)}}},t.renderBoudingBox=function(e){this._renderBoudingBox(e);for(var t=0;t<8;++t){var n=this._children[t];n&&n.renderBoudingBox(e)}},t.buildAllChild=function(e){if(e<this._scene.treeLevel)for(var t=0;t<8;t++)this.addChild(t).buildAllChild(e+1)},t._renderBoudingBox=function(e){},a(0,t,"exactBox",function(){return this._exactBox},function(e){this._exactBox=e,ct.add(e.min,e.max,this._boundingBoxCenter),ct.scale(this._boundingBoxCenter,.5,this._boundingBoxCenter)}),a(0,t,"relaxBox",function(){return this._relaxBox},function(e){this._relaxBox=e,e.getCorners(this._corners),tt.createfromPoints(this._corners,this._boundingSphere)}),e.debugMode=!1,e.relax=1.15,e.CHILDNUM=8,i(e,["tempVector0",function(){return this.tempVector0=new ct},"tempSize",function(){return this.tempSize=new ct},"tempCenter",function(){return this.tempCenter=new ct},"_octreeSplit",function(){return this._octreeSplit=[new ct(.25,.25,.25),new ct(.75,.25,.25),new ct(.25,.75,.25),new ct(.75,.75,.25),new ct(.25,.25,.75),new ct(.75,.25,.75),new ct(.25,.75,.75),new ct(.75,.75,.75)]}]),e}(),ue=(function(){function e(){}r(e,"laya.d3.core.scene.SceneManager")}(),function(){function e(e){this._vertexDeclaration=null,this._vertexDatas=null,this._indexDatas=null,this._vertexBuffer=null,this._indexBuffer=null,this._currentCombineVertexCount=0,this._currentCombineIndexCount=0,this._combineRenderElements=null,this._materials=null,this._materialToRenderElementsOffsets=null,this._merageElements=null,this._combineRenderElementPool=null,this._combineRenderElementPoolIndex=0,this._currentCombineVertexCount=0,this._currentCombineIndexCount=0,this._combineRenderElements=[],this._materialToRenderElementsOffsets=[],this._materials=[],this._merageElements=[],this._combineRenderElementPool=[],this._combineRenderElementPoolIndex=0,this._vertexDeclaration=e}r(e,"laya.d3.graphics.DynamicBatch");var t=e.prototype;return n.imps(t,{"laya.d3.core.render.IRenderable":!0}),t._getVertexBuffer=function(e){return void 0===e&&(e=0),0===e?this._vertexBuffer:null},t._getIndexBuffer=function(){return this._indexBuffer},t._getCombineRenderElementFromPool=function(e,t,n){var i=this._combineRenderElementPool[this._combineRenderElementPoolIndex++];return i||(this._combineRenderElementPool[this._combineRenderElementPoolIndex-1]=i=new oe,i._sprite3D=new Un),i._sprite3D._render._renderUpdate(n),i},t._getRenderElement=function(t,n,i){this._vertexDatas||(this._vertexDatas=new Float32Array(this._vertexDeclaration.vertexStride/4*e.maxVertexCount),this._indexDatas=new Uint16Array(e.maxIndexCount),this._vertexBuffer=En.create(this._vertexDeclaration,e.maxVertexCount,35048),this._indexBuffer=xn.create("ushort",e.maxIndexCount,35048)),this._merageElements.length=0;for(var r=0,a=0,s=0,o=this._combineRenderElements.length;s<o;s++){var l=this._combineRenderElements[s],h=l.getDynamicBatchBakedVertexs(0),_=l.getBakedIndices(),u=l._sprite3D.transform._isFrontFaceInvert,c=r/(this._vertexDeclaration.vertexStride/4),d=a,f=d+_.length;l._tempBatchIndexStart=d,l._tempBatchIndexEnd=f,this._indexDatas.set(_,a);var m=0;if(u)for(m=d;m<f;m+=3){this._indexDatas[m]=c+this._indexDatas[m];var p=this._indexDatas[m+1],v=this._indexDatas[m+2];this._indexDatas[m+1]=c+v,this._indexDatas[m+2]=c+p}else for(m=d;m<f;m+=3)this._indexDatas[m]=c+this._indexDatas[m],this._indexDatas[m+1]=c+this._indexDatas[m+1],this._indexDatas[m+2]=c+this._indexDatas[m+2];a+=_.length,this._vertexDatas.set(h,r),r+=h.length}for(this._vertexBuffer.setData(this._vertexDatas),this._indexBuffer.setData(this._indexDatas),this._combineRenderElementPoolIndex=0,s=0,o=this._materials.length;s<o;s++){var g=this._getCombineRenderElementFromPool(t,n,i);g._type=2,g._staticBatch=null,g.renderObj=this;var x=this._combineRenderElements[this._materialToRenderElementsOffsets[s]]._tempBatchIndexStart,E=s+1===this._materialToRenderElementsOffsets.length?a:this._combineRenderElements[this._materialToRenderElementsOffsets[s+1]]._tempBatchIndexStart;g._tempBatchIndexStart=x,g._tempBatchIndexEnd=E,g._material=this._materials[s],this._merageElements.push(g)}},t._addCombineRenderObjTest=function(t){var n=t.renderObj,i=this._currentCombineIndexCount+n._getIndexBuffer().indexCount;return!(this._currentCombineVertexCount+n._getVertexBuffer().vertexCount>e.maxVertexCount||i>e.maxIndexCount)},t._addCombineRenderObj=function(e){var t=e.renderObj;this._combineRenderElements.push(e),this._currentCombineIndexCount=this._currentCombineIndexCount+t._getIndexBuffer().indexCount,this._currentCombineVertexCount=this._currentCombineVertexCount+t._getVertexBuffer().vertexCount},t._addCombineMaterial=function(e){this._materials.push(e)},t._addMaterialToRenderElementOffset=function(e){this._materialToRenderElementsOffsets.push(e)},t._clearRenderElements=function(){this._combineRenderElements.length=0,this._materials.length=0,this._materialToRenderElementsOffsets.length=0,this._currentCombineVertexCount=0,this._currentCombineIndexCount=0},t._addToRenderQueue=function(e,t,n,i){this._getRenderElement(t,n,i);for(var r=0,a=this._materials.length;r<a;r++)e.getRenderQueue(this._materials[r].renderQueue)._addDynamicBatchElement(this._merageElements[r])},t._beforeRender=function(e){return this._vertexBuffer._bind(),this._indexBuffer._bind(),!0},t._render=function(e){var t=e._batchIndexEnd-e._batchIndexStart;N.mainContext.drawElements(4,t,5123,2*e._batchIndexStart),C.drawCall++,C.trianglesFaces+=t/3},t._renderRuntime=function(e,t,n){},a(0,t,"_vertexBufferCount",function(){return 1}),a(0,t,"triangleCount",function(){return this._indexBuffer.indexCount/3}),a(0,t,"combineRenderElementsCount",function(){return this._combineRenderElements.length}),e.maxVertexCount=2e4,e.maxIndexCount=4e4,e.maxCombineTriangleCount=10,e}()),ce=function(){function e(){this._dynamicBatches=null,this._prepareDynamicBatchCombineElements=null,this._dynamicBatches={},this._prepareDynamicBatchCombineElements=[]}r(e,"laya.d3.graphics.DynamicBatchManager");var t=e.prototype;return t.getDynamicBatch=function(e,t){var n,i=e.id.toString()+t;return this._dynamicBatches[i]?n=this._dynamicBatches[i]:this._dynamicBatches[i]=n=new ue(e),n},t._garbageCollection=function(){for(var e in this._dynamicBatches)0===this._dynamicBatches[e].combineRenderElementsCount&&delete this._dynamicBatches[e]},t._addPrepareRenderElement=function(e){this._prepareDynamicBatchCombineElements.push(e)},t._finishCombineDynamicBatch=function(t){this._prepareDynamicBatchCombineElements.sort(e._sortPrepareDynamicBatch);for(var n,i,r,a,s,o,l,h,_=-1,u=!0,c=0,d=-1,f=0,m=this._prepareDynamicBatchCombineElements.length;f<m;f++){var p=(s=this._prepareDynamicBatchCombineElements[f]).renderObj._getVertexBuffer(0).vertexDeclaration,v=i!==p;v&&(c=0,i=p);var g=c!==_;if(g&&(_=c),(v||g)&&(o=this.getDynamicBatch(p,c),n=null),u)if(o._addCombineRenderObjTest(s)){if(a=s._material,n!==a)l&&(t.getRenderQueue(h._material.renderQueue)._addRenderElement(h),l=null,h=null,d=-1),l=a,d=o.combineRenderElementsCount,h=s,n=a;else if(l){var x=h.renderObj,E=s.renderObj;x._getVertexBuffer().vertexCount+E._getVertexBuffer().vertexCount>ue.maxVertexCount||x._getIndexBuffer().indexCount+E._getIndexBuffer().indexCount>ue.maxIndexCount?(t.getRenderQueue(h._material.renderQueue)._addRenderElement(h),l=a,d=o.combineRenderElementsCount,h=s):(o._addCombineMaterial(l),o._addMaterialToRenderElementOffset(d),o._addCombineRenderObj(h),l=null,h=null,d=-1,o._addCombineRenderObj(s))}else o._addCombineRenderObj(s);u=!0}else l&&(t.getRenderQueue(h._material.renderQueue)._addRenderElement(h),l=null,h=null,d=-1),c++,u=!1;else r=this._prepareDynamicBatchCombineElements[f-1],o._addMaterialToRenderElementOffset(o.combineRenderElementsCount),n=r._material,o._addCombineMaterial(n),o._addCombineRenderObj(r),u=!0,n!==(a=s._material)?(l=a,d=o.combineRenderElementsCount,h=s):o._addCombineRenderObj(s),n=a}l&&(t.getRenderQueue(h._material.renderQueue)._addRenderElement(h),l=null,h=null,d=-1),this._prepareDynamicBatchCombineElements.length=0},t._clearRenderElements=function(){for(var e in this._dynamicBatches)this._dynamicBatches[e]._clearRenderElements()},t._addToRenderQueue=function(e,t,n,i){for(var r in this._dynamicBatches){var a=this._dynamicBatches[r];a.combineRenderElementsCount>0&&a._addToRenderQueue(e,t,n,i)}},t.dispose=function(){this._dynamicBatches=null},e._sortPrepareDynamicBatch=function(e,t){return e._mainSortID-t._mainSortID},e}(),de=function(){function e(){}return r(e,"laya.d3.graphics.FrustumCulling"),e.renderShadowObjectCulling=function(e,t,n,i,r){var a=0,s=0,o=0,l=0;for(a=0,o=n.length;a<o;a++){var h=n[a];h&&h._clearRenderElements()}var _,u,c,d=e._cullingRenders;if(r>1){for(a=0,o=e._cullingRendersLength;a<o;a++)if((_=d[a]).castShadow&&H.isVisible(_._owner.layer.mask)&&_.enable)for(var f=1,m=t.length;f<m;f++)if(u=n[f-1],0!==t[f].containsBoundSphere(_.boundingSphere))for(s=0,l=(c=_._renderElements).length;s<l;s++)u._addRenderElement(c[s])}else for(a=0,o=e._cullingRendersLength;a<o;a++)if((_=d[a]).castShadow&&H.isVisible(_._owner.layer.mask)&&_.enable&&0!==t[0].containsBoundSphere(_.boundingSphere))for(_._renderUpdate(i),u=n[0],s=0,l=(c=_._renderElements).length;s<l;s++)u._addRenderElement(c[s])},e.renderShadowObjectCullingOctree=function(e,t,n,i,r){for(var a=0,s=n.length;a<s;a++){var o=n[a];o&&o._clearRenderElements()}r>1?e.treeRoot.cullingShadowObjects(t,n,!0,0,e):e.treeRoot.cullingShadowObjectsOnePSSM(t[0],n,i,!0,0,e)},e.renderObjectCulling=function(e,t,n,i,r,a){var s=0,o=0,l=0,h=0,_=t._quenes,u=t._dynamicBatchManager,c=t._cullingRenders;for(s=0,o=_.length;s<o;s++){var d=_[s];d&&d._clearRenderElements()}var f=fe._staticBatchManagers;for(s=0,o=f.length;s<o;s++)f[s]._clearRenderElements();u._clearRenderElements();var m=n.transform.position;for(s=0,o=t._cullingRendersLength;s<o;s++){var p=c[s];if(H.isVisible(p._owner.layer.mask)&&p.enable&&0!==e.containsBoundSphere(p.boundingSphere)){p._renderUpdate(a),p._distanceForSort=ct.distance(p.boundingSphere.center,m)+p.sortingFudge;var v=p._renderElements;for(l=0,h=v.length;l<h;l++){var g=v[l],x=g._staticBatch;if(x&&x._material===g._material)x._addBatchRenderElement(g);else{var E=g.renderObj;E.triangleCount<10&&1===E._vertexBufferCount&&E._getIndexBuffer()&&g._material.renderQueue<2&&g._canDynamicBatch&&!p._owner.isStatic?u._addPrepareRenderElement(g):t.getRenderQueue(g._material.renderQueue)._addRenderElement(g)}}}}for(s=0,o=f.length;s<o;s++)f[s]._addToRenderQueue(t,i,r,a);u._finishCombineDynamicBatch(t),u._addToRenderQueue(t,i,r,a)},e.renderObjectCullingOctree=function(e,t,n,i,r,a){var s=0,o=0,l=t._quenes,h=t._dynamicBatchManager;for(s=0,o=l.length;s<o;s++){var _=l[s];_&&_._clearRenderElements()}var u=fe._staticBatchManagers;for(s=0,o=u.length;s<o;s++)u[s]._clearRenderElements();for(h._clearRenderElements(),t._cullingRenders.length=0,t.treeRoot.cullingObjects(e,!0,0,n.transform.position,a),s=0,o=u.length;s<o;s++)u[s]._addToRenderQueue(t,i,r,a);h._finishCombineDynamicBatch(t),h._addToRenderQueue(t,i,r,a)},e.renderObjectCullingNoBoundFrustum=function(e,t,n,i,r){var a=0,s=0,o=0,l=0,h=e._quenes,_=e._dynamicBatchManager,u=e._cullingRenders;for(a=0,s=h.length;a<s;a++){var c=h[a];c&&c._clearRenderElements()}var d=fe._staticBatchManagers;for(a=0,s=d.length;a<s;a++)d[a]._clearRenderElements();_._clearRenderElements();var f=t.transform.position;for(a=0,s=e._cullingRendersLength;a<s;a++){var m=u[a];if(H.isVisible(m._owner.layer.mask)&&m.enable){m._renderUpdate(r),m._distanceForSort=ct.distance(m.boundingSphere.center,f)+m.sortingFudge;var p=m._renderElements;for(o=0,l=p.length;o<l;o++){var v=p[o],g=v._staticBatch;if(g&&g._material===v._material)g._addBatchRenderElement(v);else{var x=v.renderObj;x.triangleCount<10&&1===x._vertexBufferCount&&x._getIndexBuffer()&&v._material.renderQueue<2&&v._canDynamicBatch&&!m._owner.isStatic?_._addPrepareRenderElement(v):e.getRenderQueue(v._material.renderQueue)._addRenderElement(v)}}}}for(a=0,s=d.length;a<s;a++)d[a]._addToRenderQueue(e,n,i,r);_._finishCombineDynamicBatch(e),_._addToRenderQueue(e,n,i,r)},e}(),fe=function(){function e(){this._initBatchRenderElements=null,this._staticBatches=null,this._initBatchRenderElements=[],this._staticBatches={}}r(e,"laya.d3.graphics.StaticBatchManager");var t=e.prototype;return t._finshInit=function(){for(var e in this._staticBatches)this._staticBatches[e]._finshInit();this._initBatchRenderElements.length=0},t._initStaticBatchs=function(e){throw new Error("StaticBatchManager:must override this function.")},t._addInitBatchSprite=function(e){for(var t=e._render._renderElements,n=0,i=t.length;n<i;n++)this._initBatchRenderElements.push(t[n])},t._clearRenderElements=function(){for(var e in this._staticBatches)this._staticBatches[e]._clearRenderElements()},t._garbageCollection=function(e){var t=e._staticBatch,n=t._initBatchRenderElements,i=n.indexOf(e);n.splice(i,1),0===n.length&&(t.dispose(),delete this._staticBatches[t._key])},t._addToRenderQueue=function(e,t,n,i){for(var r in this._staticBatches){var a=this._staticBatches[r];a._batchRenderElements.length>0&&a._updateToRenderQueue(e,i)}},t.dispose=function(){this._staticBatches=null},e._addToRenderQueueStaticBatch=function(t){t instanceof laya.d3.core.RenderableSprite3D&&t._addToInitStaticBatchManager();for(var n=0,i=t.numChildren;n<i;n++)e._addToRenderQueueStaticBatch(t._childs[n])},e.combine=function(t,n){var i,r=0,a=0;if(n)for(r=0,a=n.length;r<a;r++)n[r]._addToInitStaticBatchManager();else t&&e._addToRenderQueueStaticBatch(t);for(r=0,a=e._staticBatchManagers.length;r<a;r++)(i=e._staticBatchManagers[r])._initStaticBatchs(t),i._finshInit()},e._staticBatchManagers=[],e}(),me=function(){function e(e,t,n){this._combineRenderElementPoolIndex=0,this._combineRenderElementPool=null,this._initBatchRenderElements=null,this._batchRenderElements=null,this._material=null,this._rootOwner=null,this._key=null,this._manager=null,this._key=e,this._manager=t,this._combineRenderElementPoolIndex=0,this._combineRenderElementPool=[],this._initBatchRenderElements=[],this._batchRenderElements=[],this._rootOwner=n}r(e,"laya.d3.graphics.StaticBatch");var t=e.prototype;return n.imps(t,{"laya.d3.core.render.IRenderable":!0,"laya.resource.IDispose":!0}),t._binarySearch=function(e){for(var t=0,n=this._batchRenderElements.length-1,i=0;t<=n;)i=parseInt((t+n)/2),this._compareBatchRenderElement(this._batchRenderElements[i],e)?n=i-1:t=i+1;return t},t._compareBatchRenderElement=function(e,t){throw new Error("StaticBatch:must override this function.")},t._getVertexDecLightMap=function(e){return e===He.vertexDeclaration?Fe.vertexDeclaration:e===Ue.vertexDeclaration?Le.vertexDeclaration:e===Ne.vertexDeclaration?Ie.vertexDeclaration:e===Ge.vertexDeclaration?null:e===ye.vertexDeclaration?Re.vertexDeclaration:e===ze.vertexDeclaration?Be.vertexDeclaration:e===be.vertexDeclaration?Pe.vertexDeclaration:e},t._getCombineRenderElementFromPool=function(){throw new Error("StaticBatch:must override this function.")},t._addBatchRenderElement=function(e){this._batchRenderElements.splice(this._binarySearch(e),0,e)},t._updateToRenderQueue=function(e,t){this._combineRenderElementPoolIndex=0,this._getRenderElement(e.getRenderQueue(this._material.renderQueue)._renderElements,e,t)},t._getRenderElement=function(e,t,n){throw new Error("StaticBatch:must override this function.")},t._finshInit=function(){throw new Error("StaticBatch:must override this function.")},t._clearRenderElements=function(){this._batchRenderElements.length=0},t.dispose=function(){},t._getVertexBuffer=function(e){return void 0===e&&(e=0),null},t._getIndexBuffer=function(){return null},t._beforeRender=function(e){return!0},t._render=function(e){},t._renderRuntime=function(e,t,n){},a(0,t,"_vertexBufferCount",function(){return 1}),a(0,t,"triangleCount",function(){return 0}),e.combine=function(e){console.log("StaticBatch: discard property,please use StaticBatchManager.combine() function instead."),fe.combine(e)},e.maxBatchVertexCount=65535,e}(),pe=function(){function e(t,n){if(this._id=0,this._shaderValues=null,this._shaderDefineValue=0,this._vertexStride=0,this._vertexElements=null,this._vertexElementsDic=null,this._conchVertexDeclaration=null,this._id=++e._uniqueIDCounter,this._id>e.maxVertexDeclaration)throw new Error("VertexDeclaration: VertexDeclaration count should not large than ",e.maxVertexDeclaration);this._shaderValues=new gt,this._vertexElementsDic={},this._vertexStride=t,this._vertexElements=n,T.isConchNode&&(this._conchVertexDeclaration=new ConchVertexDeclare);for(var i=0;i<n.length;i++){var r=n[i],a=r.elementUsage;this._vertexElementsDic[a]=r;var s=[e._getTypeSize(r.elementFormat)/4,5126,!1,this._vertexStride,r.offset];switch(this._shaderValues.setValue(a,s),a){case 1:this._addShaderDefine(pt.SHADERDEFINE_COLOR);break;case 2:this._addShaderDefine(pt.SHADERDEFINE_UV0);break;case 15:this._addShaderDefine(pt.SHADERDEFINE_UV1)}}if(T.isConchNode){for(var o=[],l=0,h=n.length;l<h;l++){var _=n[l];switch(_.elementFormat){case"vector2":o.push({offset:_.offset,elementFormat:35664,elementUsage:_.elementUsage});break;case"vector3":o.push({offset:_.offset,elementFormat:35665,elementUsage:_.elementUsage});break;case"vector4":o.push({offset:_.offset,elementFormat:35666,elementUsage:_.elementUsage})}}this._conchVertexDeclaration.setDelcare(o)}}r(e,"laya.d3.graphics.VertexDeclaration");var t=e.prototype;return t._addShaderDefine=function(e){this._shaderDefineValue|=e,this._conchVertexDeclaration&&this._conchVertexDeclaration.addShaderDefine(e)},t._removeShaderDefine=function(e){this._shaderDefineValue&=~e,this._conchVertexDeclaration&&this._conchVertexDeclaration.removeShaderDefine(e)},t.getVertexElements=function(){return this._vertexElements.slice()},t.getVertexElementByUsage=function(e){return this._vertexElementsDic[e]},t.unBinding=function(){},a(0,t,"shaderDefineValue",function(){return this._shaderDefineValue}),a(0,t,"id",function(){return this._id}),a(0,t,"vertexStride",function(){return this._vertexStride}),a(0,t,"shaderValues",function(){return this._shaderValues}),e._getTypeSize=function(e){switch(e){case"single":return 4;case"vector2":return 8;case"vector3":return 12;case"vector4":return 16;case"color":case"byte4":case"short2":return 4;case"short4":return 8;case"normalizedshort2":return 4;case"normalizedshort4":return 8;case"halfvector2":return 4;case"halfvector4":return 8}return 0},e.getVertexStride=function(t){for(var n=0,i=0;i<t.Length;i++){var r=t[i],a=r.offset+e._getTypeSize(r.elementFormat);n<a&&(n=a)}return n},e._maxVertexDeclarationBit=1e3,e._uniqueIDCounter=1,i(e,["maxVertexDeclaration",function(){return this.maxVertexDeclaration=2147483647-1e3*Math.floor(2147483.647)}]),e}(),ve=function(){function e(e,t,n){this.offset=0,this.elementFormat=null,this.elementUsage=0,this.offset=e,this.elementFormat=t,this.elementUsage=n}return r(e,"laya.d3.graphics.VertexElement"),e}(),ge=(function(){function e(){}r(e,"laya.d3.graphics.VertexElementFormat"),e.Single="single",e.Vector2="vector2",e.Vector3="vector3",e.Vector4="vector4",e.Color="color",e.Byte4="byte4",e.Short2="short2",e.Short4="short4",e.NormalizedShort2="normalizedshort2",e.NormalizedShort4="normalizedshort4",e.HalfVector2="halfvector2",e.HalfVector4="halfvector4"}(),function(){function e(){}r(e,"laya.d3.graphics.VertexElementUsage"),e.POSITION0=0,e.COLOR0=1,e.TEXTURECOORDINATE0=2,e.NORMAL0=3,e.BINORMAL0=4,e.TANGENT0=5,e.BLENDINDICES0=6,e.BLENDWEIGHT0=7,e.DEPTH0=8,e.FOG0=9,e.POINTSIZE0=10,e.SAMPLE0=11,e.TESSELLATEFACTOR0=12,e.COLOR1=13,e.NEXTTEXTURECOORDINATE0=14,e.TEXTURECOORDINATE1=15,e.NEXTTEXTURECOORDINATE1=16,e.CORNERTEXTURECOORDINATE0=17,e.VELOCITY0=18,e.STARTCOLOR0=19,e.STARTSIZE=20,e.AGEADDSCALE0=21,e.STARTROTATION=22,e.ENDCOLOR0=23,e.STARTLIFETIME=24,e.TIME0=33,e.SHAPEPOSITIONSTARTLIFETIME=30,e.DIRECTIONTIME=32,e.SIZEROTATION0=27,e.RADIUS0=28,e.RADIAN0=29,e.STARTSPEED=31,e.RANDOM0=34,e.RANDOM1=35,e.SIMULATIONWORLDPOSTION=36,e.SIMULATIONWORLDROTATION=37}(),function(){function e(e,t,n){this._position=null,this._textureCoordinate0=null,this._time=NaN,this._position=e,this._textureCoordinate0=t,this._time=n}r(e,"laya.d3.graphics.VertexGlitter");var t=e.prototype;return n.imps(t,{"laya.d3.graphics.IVertex":!0}),a(0,t,"textureCoordinate",function(){return this._textureCoordinate0}),a(0,t,"position",function(){return this._position}),a(0,t,"time",function(){return this._time}),a(0,t,"vertexDeclaration",function(){return e._vertexDeclaration}),a(1,e,"vertexDeclaration",function(){return e._vertexDeclaration}),i(e,["_vertexDeclaration",function(){return this._vertexDeclaration=new pe(24,[new ve(0,"vector3",0),new ve(12,"vector2",2),new ve(20,"single",33)])}]),e}()),xe=(function(){function e(e,t,n,i,r,a,s,o,l,h){this._cornerTextureCoordinate=null,this._position=null,this._velocity=null,this._startColor=null,this._endColor=null,this._sizeRotation=null,this._radius=null,this._radian=null,this._ageAddScale=NaN,this._time=NaN,this._cornerTextureCoordinate=e,this._position=t,this._velocity=n,this._startColor=i,this._endColor=r,this._sizeRotation=a,this._radius=s,this._radian=o,this._ageAddScale=l,this._time=h}r(e,"laya.d3.graphics.VertexParticle");var t=e.prototype;n.imps(t,{"laya.d3.graphics.IVertex":!0}),a(0,t,"endColor",function(){return this._endColor}),a(0,t,"cornerTextureCoordinate",function(){return this._cornerTextureCoordinate}),a(0,t,"sizeRotation",function(){return this._sizeRotation}),a(0,t,"velocity",function(){return this._velocity}),a(0,t,"position",function(){return this._position}),a(0,t,"startColor",function(){return this._startColor}),a(0,t,"radius",function(){return this._radius}),a(0,t,"radian",function(){return this._radian}),a(0,t,"ageAddScale",function(){return this._ageAddScale}),a(0,t,"time",function(){return this._time}),a(0,t,"vertexDeclaration",function(){return e._vertexDeclaration}),a(1,e,"vertexDeclaration",function(){return e._vertexDeclaration}),i(e,["_vertexDeclaration",function(){return this._vertexDeclaration=new pe(116,[new ve(0,"vector4",17),new ve(16,"vector3",0),new ve(28,"vector3",18),new ve(40,"vector4",19),new ve(56,"vector4",23),new ve(72,"vector3",27),new ve(84,"vector2",28),new ve(92,"vector4",29),new ve(108,"single",24),new ve(112,"single",33)])}])}(),function(){function e(e){this._position=null,this._position=e}r(e,"laya.d3.graphics.VertexPosition");var t=e.prototype;return n.imps(t,{"laya.d3.graphics.IVertex":!0}),a(0,t,"position",function(){return this._position}),a(0,t,"vertexDeclaration",function(){return e._vertexDeclaration}),a(1,e,"vertexDeclaration",function(){return e._vertexDeclaration}),i(e,["_vertexDeclaration",function(){return this._vertexDeclaration=new pe(12,[new ve(0,"vector3",0)])}]),e}()),Ee=function(){function e(e,t){this._position=null,this._normal=null,this._position=e,this._normal=t}r(e,"laya.d3.graphics.VertexPositionNormal");var t=e.prototype;return n.imps(t,{"laya.d3.graphics.IVertex":!0}),a(0,t,"normal",function(){return this._normal}),a(0,t,"position",function(){return this._position}),a(0,t,"vertexDeclaration",function(){return e._vertexDeclaration}),a(1,e,"vertexDeclaration",function(){return e._vertexDeclaration}),i(e,["_vertexDeclaration",function(){return this._vertexDeclaration=new pe(24,[new ve(0,"vector3",0),new ve(12,"vector3",3)])}]),e}(),Se=function(){function e(e,t,n){this._position=null,this._normal=null,this._color=null,this._position=e,this._normal=t,this._color=n}r(e,"laya.d3.graphics.VertexPositionNormalColor");var t=e.prototype;return n.imps(t,{"laya.d3.graphics.IVertex":!0}),a(0,t,"normal",function(){return this._normal}),a(0,t,"position",function(){return this._position}),a(0,t,"color",function(){return this._color}),a(0,t,"vertexDeclaration",function(){return e._vertexDeclaration}),a(1,e,"vertexDeclaration",function(){return e._vertexDeclaration}),i(e,["_vertexDeclaration",function(){return this._vertexDeclaration=new pe(40,[new ve(0,"vector3",0),new ve(12,"vector3",3),new ve(24,"vector4",1)])}]),e}(),De=function(){function e(e,t,n,i,r){this._position=null,this._normal=null,this._color=null,this._blendIndex=null,this._blendWeight=null,this._position=e,this._normal=t,this._color=n,this._blendIndex=i,this._blendWeight=r}r(e,"laya.d3.graphics.VertexPositionNormalColorSkin");var t=e.prototype;return n.imps(t,{"laya.d3.graphics.IVertex":!0}),a(0,t,"normal",function(){return this._normal}),a(0,t,"position",function(){return this._position}),a(0,t,"blendWeight",function(){return this._blendWeight}),a(0,t,"color",function(){return this._color}),a(0,t,"blendIndex",function(){return this._blendIndex}),a(0,t,"vertexDeclaration",function(){return e._vertexDeclaration}),a(1,e,"vertexDeclaration",function(){return e._vertexDeclaration}),i(e,["_vertexDeclaration",function(){return this._vertexDeclaration=new pe(72,[new ve(0,"vector3",0),new ve(12,"vector3",3),new ve(24,"vector4",1),new ve(40,"vector4",7),new ve(56,"vector4",6)])}]),e}(),Te=function(){function e(e,t,n,i,r,a){this._position=null,this._normal=null,this._color=null,this._blendIndex=null,this._blendWeight=null,this._tangent=null,this._position=e,this._normal=t,this._color=n,this._tangent=i,this._blendIndex=r,this._blendWeight=a}r(e,"laya.d3.graphics.VertexPositionNormalColorSkinTangent");var t=e.prototype;return n.imps(t,{"laya.d3.graphics.IVertex":!0}),a(0,t,"tangent",function(){return this._tangent}),a(0,t,"normal",function(){return this._normal}),a(0,t,"position",function(){return this._position}),a(0,t,"blendWeight",function(){return this._blendWeight}),a(0,t,"color",function(){return this._color}),a(0,t,"blendIndex",function(){return this._blendIndex}),a(0,t,"vertexDeclaration",function(){return e._vertexDeclaration}),a(1,e,"vertexDeclaration",function(){return e._vertexDeclaration}),i(e,["_vertexDeclaration",function(){return this._vertexDeclaration=new pe(84,[new ve(0,"vector3",0),new ve(12,"vector3",3),new ve(24,"vector4",1),new ve(40,"vector4",7),new ve(56,"vector4",6),new ve(72,"vector3",5)])}]),e}(),Me=function(){function e(e,t,n,i){this._position=null,this._normal=null,this._color=null,this._tangent=null,this._position=e,this._normal=t,this._color=n,this._tangent=i}r(e,"laya.d3.graphics.VertexPositionNormalColorTangent");var t=e.prototype;return n.imps(t,{"laya.d3.graphics.IVertex":!0}),a(0,t,"tangent",function(){return this._tangent}),a(0,t,"normal",function(){return this._normal}),a(0,t,"position",function(){return this._position}),a(0,t,"color",function(){return this._color}),a(0,t,"vertexDeclaration",function(){return e._vertexDeclaration}),a(1,e,"vertexDeclaration",function(){return e._vertexDeclaration}),i(e,["_vertexDeclaration",function(){return this._vertexDeclaration=new pe(52,[new ve(0,"vector3",0),new ve(12,"vector3",3),new ve(24,"vector4",1),new ve(40,"vector3",5)])}]),e}(),ye=function(){function e(e,t,n,i){this._position=null,this._normal=null,this._color=null,this._textureCoordinate=null,this._position=e,this._normal=t,this._color=n,this._textureCoordinate=i}r(e,"laya.d3.graphics.VertexPositionNormalColorTexture");var t=e.prototype;return n.imps(t,{"laya.d3.graphics.IVertex":!0}),a(0,t,"textureCoordinate",function(){return this._textureCoordinate}),a(0,t,"normal",function(){return this._normal}),a(0,t,"position",function(){return this._position}),a(0,t,"color",function(){return this._color}),a(0,t,"vertexDeclaration",function(){return e._vertexDeclaration}),a(1,e,"vertexDeclaration",function(){return e._vertexDeclaration}),i(e,["_vertexDeclaration",function(){return this._vertexDeclaration=new pe(48,[new ve(0,"vector3",0),new ve(12,"vector3",3),new ve(24,"vector4",1),new ve(40,"vector2",2)])}]),e}(),Re=function(){function e(e,t,n,i,r){this._position=null,this._normal=null,this._color=null,this._textureCoordinate0=null,this._textureCoordinate1=null,this._position=e,this._normal=t,this._color=n,this._textureCoordinate0=i,this._textureCoordinate1=r}r(e,"laya.d3.graphics.VertexPositionNormalColorTexture0Texture1");var t=e.prototype;return n.imps(t,{"laya.d3.graphics.IVertex":!0}),a(0,t,"normal",function(){return this._normal}),a(0,t,"position",function(){return this._position}),a(0,t,"color",function(){return this._color}),a(0,t,"textureCoordinate0",function(){return this._textureCoordinate0}),a(0,t,"vertexDeclaration",function(){return e._vertexDeclaration}),a(0,t,"textureCoordinate1",function(){return this._textureCoordinate1}),a(1,e,"vertexDeclaration",function(){return e._vertexDeclaration}),i(e,["_vertexDeclaration",function(){return this._vertexDeclaration=new pe(56,[new ve(0,"vector3",0),new ve(12,"vector3",3),new ve(24,"vector4",1),new ve(40,"vector2",2),new ve(48,"vector2",15)])}]),e}(),Ae=function(){function e(e,t,n,i,r,a,s){this._position=null,this._normal=null,this._color=null,this._textureCoordinate0=null,this._textureCoordinate1=null,this._blendIndex=null,this._blendWeight=null,this._position=e,this._normal=t,this._color=n,this._textureCoordinate0=i,this._textureCoordinate1=r,this._blendIndex=a,this._blendWeight=s}r(e,"laya.d3.graphics.VertexPositionNormalColorTexture0Texture1Skin");var t=e.prototype;return n.imps(t,{"laya.d3.graphics.IVertex":!0}),a(0,t,"normal",function(){return this._normal}),a(0,t,"position",function(){return this._position}),a(0,t,"blendWeight",function(){return this._blendWeight}),a(0,t,"color",function(){return this._color}),a(0,t,"textureCoordinate0",function(){return this._textureCoordinate0}),a(0,t,"vertexDeclaration",function(){return e._vertexDeclaration}),a(0,t,"textureCoordinate1",function(){return this._textureCoordinate1}),a(0,t,"blendIndex",function(){return this._blendIndex}),a(1,e,"vertexDeclaration",function(){return e._vertexDeclaration}),i(e,["_vertexDeclaration",function(){return this._vertexDeclaration=new pe(88,[new ve(0,"vector3",0),new ve(12,"vector3",3),new ve(24,"vector4",1),new ve(40,"vector2",2),new ve(48,"vector2",15),new ve(56,"vector4",7),new ve(72,"vector4",6)])}]),e}(),Ce=function(){function e(){this._position=null,this._normal=null,this._color=null,this._textureCoordinate0=null,this._textureCoordinate1=null,this._blendIndex=null,this._blendWeight=null,this._tangent=null}r(e,"laya.d3.graphics.VertexPositionNormalColorTexture0Texture1SkinTangent");var t=e.prototype;return n.imps(t,{"laya.d3.graphics.IVertex":!0}),t.VertexPositionNormalColorTexture0SkinTangent=function(e,t,n,i,r,a,s,o){this._position=e,this._normal=t,this._color=n,this._textureCoordinate0=i,this._textureCoordinate1=r,this._tangent=a,this._blendIndex=s,this._blendWeight=o},a(0,t,"tangent",function(){return this._tangent}),a(0,t,"normal",function(){return this._normal}),a(0,t,"position",function(){return this._position}),a(0,t,"blendWeight",function(){return this._blendWeight}),a(0,t,"color",function(){return this._color}),a(0,t,"textureCoordinate0",function(){return this._textureCoordinate0}),a(0,t,"vertexDeclaration",function(){return e._vertexDeclaration}),a(0,t,"textureCoordinate1",function(){return this._textureCoordinate1}),a(0,t,"blendIndex",function(){return this._blendIndex}),a(1,e,"vertexDeclaration",function(){return e._vertexDeclaration}),i(e,["_vertexDeclaration",function(){return this._vertexDeclaration=new pe(100,[new ve(0,"vector3",0),new ve(12,"vector3",3),new ve(24,"vector4",1),new ve(40,"vector2",2),new ve(48,"vector2",15),new ve(56,"vector4",7),new ve(72,"vector4",6),new ve(88,"vector3",5)])}]),e}(),Ie=function(){function e(){this._position=null,this._normal=null,this._color=null,this._textureCoordinate0=null,this._textureCoordinate1=null,this._tangent=null}r(e,"laya.d3.graphics.VertexPositionNormalColorTexture0Texture1Tangent");var t=e.prototype;return n.imps(t,{"laya.d3.graphics.IVertex":!0}),t.VertexPositionNormalColorTexture0Tangent=function(e,t,n,i,r,a){this._position=e,this._normal=t,this._color=n,this._textureCoordinate0=i,this._textureCoordinate1=r,this._tangent=a},a(0,t,"tangent",function(){return this._tangent}),a(0,t,"normal",function(){return this._normal}),a(0,t,"position",function(){return this._position}),a(0,t,"color",function(){return this._color}),a(0,t,"textureCoordinate0",function(){return this._textureCoordinate0}),a(0,t,"vertexDeclaration",function(){return e._vertexDeclaration}),a(0,t,"textureCoordinate1",function(){return this._textureCoordinate1}),a(1,e,"vertexDeclaration",function(){return e._vertexDeclaration}),i(e,["_vertexDeclaration",function(){return this._vertexDeclaration=new pe(68,[new ve(0,"vector3",0),new ve(12,"vector3",3),new ve(24,"vector4",1),new ve(40,"vector2",2),new ve(48,"vector2",15),new ve(56,"vector3",5)])}]),e}(),we=function(){function e(e,t,n,i,r,a){this._position=null,this._normal=null,this._color=null,this._textureCoordinate=null,this._blendIndex=null,this._blendWeight=null,this._position=e,this._normal=t,this._color=n,this._textureCoordinate=i,this._blendIndex=r,this._blendWeight=a}r(e,"laya.d3.graphics.VertexPositionNormalColorTextureSkin");var t=e.prototype;return n.imps(t,{"laya.d3.graphics.IVertex":!0}),a(0,t,"textureCoordinate",function(){return this._textureCoordinate}),a(0,t,"normal",function(){return this._normal}),a(0,t,"position",function(){return this._position}),a(0,t,"blendWeight",function(){return this._blendWeight}),a(0,t,"color",function(){return this._color}),a(0,t,"blendIndex",function(){return this._blendIndex}),a(0,t,"vertexDeclaration",function(){return e._vertexDeclaration}),a(1,e,"vertexDeclaration",function(){return e._vertexDeclaration}),i(e,["_vertexDeclaration",function(){return this._vertexDeclaration=new pe(80,[new ve(0,"vector3",0),new ve(12,"vector3",3),new ve(24,"vector4",1),new ve(40,"vector2",2),new ve(48,"vector4",7),new ve(64,"vector4",6)])}]),e}(),Ve=function(){function e(e,t,n,i,r,a,s){this._position=null,this._normal=null,this._color=null,this._textureCoordinate=null,this._blendIndex=null,this._blendWeight=null,this._tangent=null,this._position=e,this._normal=t,this._color=n,this._textureCoordinate=i,this._tangent=r,this._blendIndex=a,this._blendWeight=s}r(e,"laya.d3.graphics.VertexPositionNormalColorTextureSkinTangent");var t=e.prototype;return n.imps(t,{"laya.d3.graphics.IVertex":!0}),a(0,t,"tangent",function(){return this._tangent}),a(0,t,"textureCoordinate",function(){return this._textureCoordinate}),a(0,t,"normal",function(){return this._normal}),a(0,t,"position",function(){return this._position}),a(0,t,"blendWeight",function(){return this._blendWeight}),a(0,t,"color",function(){return this._color}),a(0,t,"blendIndex",function(){return this._blendIndex}),a(0,t,"vertexDeclaration",function(){return e._vertexDeclaration}),a(1,e,"vertexDeclaration",function(){return e._vertexDeclaration}),i(e,["_vertexDeclaration",function(){return this._vertexDeclaration=new pe(92,[new ve(0,"vector3",0),new ve(12,"vector3",3),new ve(24,"vector4",1),new ve(40,"vector2",2),new ve(48,"vector4",7),new ve(64,"vector4",6),new ve(80,"vector3",5)])}]),e}(),Ne=function(){function e(e,t,n,i,r){this._position=null,this._normal=null,this._color=null,this._textureCoordinate=null,this._tangent=null,this._position=e,this._normal=t,this._color=n,this._textureCoordinate=i,this._tangent=r}r(e,"laya.d3.graphics.VertexPositionNormalColorTextureTangent");var t=e.prototype;return n.imps(t,{"laya.d3.graphics.IVertex":!0}),a(0,t,"tangent",function(){return this._tangent}),a(0,t,"textureCoordinate",function(){return this._textureCoordinate}),a(0,t,"normal",function(){return this._normal}),a(0,t,"position",function(){return this._position}),a(0,t,"color",function(){return this._color}),a(0,t,"vertexDeclaration",function(){return e._vertexDeclaration}),a(1,e,"vertexDeclaration",function(){return e._vertexDeclaration}),i(e,["_vertexDeclaration",function(){return this._vertexDeclaration=new pe(60,[new ve(0,"vector3",0),new ve(12,"vector3",3),new ve(24,"vector4",1),new ve(40,"vector2",2),new ve(48,"vector3",5)])}]),e}(),Oe=function(){function e(e,t,n){this._position=null,this._normal=null,this._tangent=null,this._position=e,this._normal=t,this._tangent=n}r(e,"laya.d3.graphics.VertexPositionNormalTangent");var t=e.prototype;return n.imps(t,{"laya.d3.graphics.IVertex":!0}),a(0,t,"tangent",function(){return this._tangent}),a(0,t,"normal",function(){return this._normal}),a(0,t,"position",function(){return this._position}),a(0,t,"vertexDeclaration",function(){return e._vertexDeclaration}),a(1,e,"vertexDeclaration",function(){return e._vertexDeclaration}),i(e,["_vertexDeclaration",function(){return this._vertexDeclaration=new pe(36,[new ve(0,"vector3",0),new ve(12,"vector3",3),new ve(24,"vector3",5)])}]),e}(),be=function(){function e(e,t,n){this._position=null,this._normal=null,this._textureCoordinate=null,this._position=e,this._normal=t,this._textureCoordinate=n}r(e,"laya.d3.graphics.VertexPositionNormalTexture");var t=e.prototype;return n.imps(t,{"laya.d3.graphics.IVertex":!0}),a(0,t,"textureCoordinate",function(){return this._textureCoordinate}),a(0,t,"normal",function(){return this._normal}),a(0,t,"position",function(){return this._position}),a(0,t,"vertexDeclaration",function(){return e._vertexDeclaration}),a(1,e,"vertexDeclaration",function(){return e._vertexDeclaration}),i(e,["_vertexDeclaration",function(){return this._vertexDeclaration=new pe(32,[new ve(0,"vector3",0),new ve(12,"vector3",3),new ve(24,"vector2",2)])}]),e}(),Pe=function(){function e(e,t,n,i){this._position=null,this._normal=null,this._textureCoordinate0=null,this._textureCoordinate1=null,this._position=e,this._normal=t,this._textureCoordinate0=n,this._textureCoordinate1=i}r(e,"laya.d3.graphics.VertexPositionNormalTexture0Texture1");var t=e.prototype;return n.imps(t,{"laya.d3.graphics.IVertex":!0}),a(0,t,"normal",function(){return this._normal}),a(0,t,"position",function(){return this._position}),a(0,t,"textureCoordinate0",function(){return this._textureCoordinate0}),a(0,t,"vertexDeclaration",function(){return e._vertexDeclaration}),a(0,t,"textureCoordinate1",function(){return this._textureCoordinate1}),a(1,e,"vertexDeclaration",function(){return e._vertexDeclaration}),i(e,["_vertexDeclaration",function(){return this._vertexDeclaration=new pe(40,[new ve(0,"vector3",0),new ve(12,"vector3",3),new ve(24,"vector2",2),new ve(32,"vector2",15)])}]),e}(),Le=function(){function e(e,t,n,i,r,a){this._position=null,this._normal=null,this._textureCoordinate0=null,this._textureCoordinate1=null,this._blendIndex=null,this._blendWeight=null,this._position=e,this._normal=t,this._textureCoordinate0=n,this._textureCoordinate1=i,this._blendIndex=r,this._blendWeight=a}r(e,"laya.d3.graphics.VertexPositionNormalTexture0Texture1Skin");var t=e.prototype;return n.imps(t,{"laya.d3.graphics.IVertex":!0}),a(0,t,"normal",function(){return this._normal}),a(0,t,"position",function(){return this._position}),a(0,t,"textureCoordinate0",function(){return this._textureCoordinate0}),a(0,t,"vertexDeclaration",function(){return e._vertexDeclaration}),a(0,t,"textureCoordinate1",function(){return this._textureCoordinate1}),a(0,t,"blendIndex",function(){return this._blendIndex}),a(0,t,"blendWeight",function(){return this._blendWeight}),a(1,e,"vertexDeclaration",function(){return e._vertexDeclaration}),i(e,["_vertexDeclaration",function(){return this._vertexDeclaration=new pe(72,[new ve(0,"vector3",0),new ve(12,"vector3",3),new ve(24,"vector2",2),new ve(32,"vector2",15),new ve(40,"vector4",7),new ve(56,"vector4",6)])}]),e}(),Fe=function(){function e(){this._position=null,this._normal=null,this._textureCoordinate0=null,this._textureCoordinate1=null,this._blendIndex=null,this._blendWeight=null,this._tangent=null}r(e,"laya.d3.graphics.VertexPositionNormalTexture0Texture1SkinTangent");var t=e.prototype;return n.imps(t,{"laya.d3.graphics.IVertex":!0}),t.VertexPositionNormalTexture0SkinTangent=function(e,t,n,i,r,a,s){this._position=e,this._normal=t,this._textureCoordinate0=n,this._textureCoordinate1=i,this._tangent=r,this._blendIndex=a,this._blendWeight=s},a(0,t,"tangent",function(){return this._tangent}),a(0,t,"normal",function(){return this._normal}),a(0,t,"position",function(){return this._position}),a(0,t,"textureCoordinate0",function(){return this._textureCoordinate0}),a(0,t,"vertexDeclaration",function(){return e._vertexDeclaration}),a(0,t,"textureCoordinate1",function(){return this._textureCoordinate1}),a(0,t,"blendIndex",function(){return this._blendIndex}),a(0,t,"blendWeight",function(){return this._blendWeight}),a(1,e,"vertexDeclaration",function(){return e._vertexDeclaration}),i(e,["_vertexDeclaration",function(){return this._vertexDeclaration=new pe(84,[new ve(0,"vector3",0),new ve(12,"vector3",3),new ve(24,"vector2",2),new ve(32,"vector2",15),new ve(40,"vector4",7),new ve(56,"vector4",6),new ve(72,"vector3",5)])}]),e}(),Be=function(){function e(){this._position=null,this._normal=null,this._textureCoordinate0=null,this._textureCoordinate1=null,this._tangent=null}r(e,"laya.d3.graphics.VertexPositionNormalTexture0Texture1Tangent");var t=e.prototype;return n.imps(t,{"laya.d3.graphics.IVertex":!0}),t.VertexPositionNormalTexture0Tangent=function(e,t,n,i,r){this._position=e,this._normal=t,this._textureCoordinate0=n,this._textureCoordinate1=i,this._tangent=r},a(0,t,"tangent",function(){return this._tangent}),a(0,t,"normal",function(){return this._normal}),a(0,t,"position",function(){return this._position}),a(0,t,"textureCoordinate0",function(){return this._textureCoordinate0}),a(0,t,"vertexDeclaration",function(){return e._vertexDeclaration}),a(0,t,"textureCoordinate1",function(){return this._textureCoordinate1}),a(1,e,"vertexDeclaration",function(){return e._vertexDeclaration}),i(e,["_vertexDeclaration",function(){return this._vertexDeclaration=new pe(52,[new ve(0,"vector3",0),new ve(12,"vector3",3),new ve(24,"vector2",2),new ve(32,"vector2",15),new ve(40,"vector3",5)])}]),e}(),Ue=function(){function e(e,t,n,i,r){this._position=null,this._normal=null,this._textureCoordinate=null,this._blendIndex=null,this._blendWeight=null,this._position=e,this._normal=t,this._textureCoordinate=n,this._blendIndex=i,this._blendWeight=r}r(e,"laya.d3.graphics.VertexPositionNormalTextureSkin");var t=e.prototype;return n.imps(t,{"laya.d3.graphics.IVertex":!0}),a(0,t,"textureCoordinate",function(){return this._textureCoordinate}),a(0,t,"normal",function(){return this._normal}),a(0,t,"position",function(){return this._position}),a(0,t,"blendIndex",function(){return this._blendIndex}),a(0,t,"blendWeight",function(){return this._blendWeight}),a(0,t,"vertexDeclaration",function(){return e._vertexDeclaration}),a(1,e,"vertexDeclaration",function(){return e._vertexDeclaration}),i(e,["_vertexDeclaration",function(){return this._vertexDeclaration=new pe(64,[new ve(0,"vector3",0),new ve(12,"vector3",3),new ve(24,"vector2",2),new ve(32,"vector4",7),new ve(48,"vector4",6)])}]),e}(),He=function(){function e(e,t,n,i,r,a){this._position=null,this._normal=null,this._textureCoordinate=null,this._blendIndex=null,this._blendWeight=null,this._tangent=null,this._position=e,this._normal=t,this._textureCoordinate=n,this._tangent=i,this._blendIndex=r,this._blendWeight=a}r(e,"laya.d3.graphics.VertexPositionNormalTextureSkinTangent");var t=e.prototype;return n.imps(t,{"laya.d3.graphics.IVertex":!0}),a(0,t,"tangent",function(){return this._tangent}),a(0,t,"textureCoordinate",function(){return this._textureCoordinate}),a(0,t,"normal",function(){return this._normal}),a(0,t,"position",function(){return this._position}),a(0,t,"blendIndex",function(){return this._blendIndex}),a(0,t,"blendWeight",function(){return this._blendWeight}),a(0,t,"vertexDeclaration",function(){return e._vertexDeclaration}),a(1,e,"vertexDeclaration",function(){return e._vertexDeclaration}),i(e,["_vertexDeclaration",function(){return this._vertexDeclaration=new pe(76,[new ve(0,"vector3",0),new ve(12,"vector3",3),new ve(24,"vector2",2),new ve(32,"vector4",7),new ve(48,"vector4",6),new ve(64,"vector3",5)])}]),e}(),ze=function(){function e(e,t,n,i){this._position=null,this._normal=null,this._textureCoordinate=null,this._tangent=null,this._position=e,this._normal=t,this._textureCoordinate=n,this._tangent=i}r(e,"laya.d3.graphics.VertexPositionNormalTextureTangent");var t=e.prototype;return n.imps(t,{"laya.d3.graphics.IVertex":!0}),a(0,t,"tangent",function(){return this._tangent}),a(0,t,"textureCoordinate",function(){return this._textureCoordinate}),a(0,t,"normal",function(){return this._normal}),a(0,t,"position",function(){return this._position}),a(0,t,"vertexDeclaration",function(){return e._vertexDeclaration}),a(1,e,"vertexDeclaration",function(){return e._vertexDeclaration}),i(e,["_vertexDeclaration",function(){return this._vertexDeclaration=new pe(44,[new ve(0,"vector3",0),new ve(12,"vector3",3),new ve(24,"vector2",2),new ve(32,"vector3",5)])}]),e}(),Ge=function(){function e(e,t,n){this._position=null,this._normal=null,this._textureCoordinate=null,this._position=e,this._normal=t,this._textureCoordinate=n}r(e,"laya.d3.graphics.VertexPositionNTBTexture");var t=e.prototype;return n.imps(t,{"laya.d3.graphics.IVertex":!0}),a(0,t,"textureCoordinate",function(){return this._textureCoordinate}),a(0,t,"normal",function(){return this._normal}),a(0,t,"position",function(){return this._position}),a(0,t,"vertexDeclaration",function(){return e._vertexDeclaration}),a(1,e,"vertexDeclaration",function(){return e._vertexDeclaration}),i(e,["_vertexDeclaration",function(){return this._vertexDeclaration=new pe(56,[new ve(0,"vector3",0),new ve(12,"vector3",3),new ve(24,"vector3",5),new ve(36,"vector3",4),new ve(48,"vector2",2)])}]),e}(),ke=function(){function e(e,t,n,i,r,a,s,o){this._position=null,this._normal=null,this._textureCoordinate0=null,this._textureCoordinate1=null,this._blendIndex=null,this._blendWeight=null,this._tangent=null,this.binormal=null,this._position=e,this._normal=t,this._textureCoordinate0=i,this._textureCoordinate1=r,this._tangent=a,n=n,this._blendIndex=s,this._blendWeight=o}r(e,"laya.d3.graphics.VertexPositionNTBTexture0Texture1Skin");var t=e.prototype;return n.imps(t,{"laya.d3.graphics.IVertex":!0}),a(0,t,"tangent",function(){return this._tangent}),a(0,t,"normal",function(){return this._normal}),a(0,t,"position",function(){return this._position}),a(0,t,"textureCoordinate0",function(){return this._textureCoordinate0}),a(0,t,"vertexDeclaration",function(){return e._vertexDeclaration}),a(0,t,"textureCoordinate1",function(){return this._textureCoordinate1}),a(0,t,"blendIndex",function(){return this._blendIndex}),a(0,t,"blendWeight",function(){return this._blendWeight}),a(1,e,"vertexDeclaration",function(){return e._vertexDeclaration}),i(e,["_vertexDeclaration",function(){return this._vertexDeclaration=new pe(96,[new ve(0,"vector3",0),new ve(12,"vector3",3),new ve(24,"vector3",5),new ve(36,"vector3",4),new ve(48,"vector2",2),new ve(56,"vector2",15),new ve(64,"vector4",7),new ve(80,"vector4",6)])}]),e}(),We=function(){function e(e,t,n){this._position=null,this._normal=null,this._textureCoordinate=null,this._position=e,this._normal=t,this._textureCoordinate=n}r(e,"laya.d3.graphics.VertexPositionNTBTextureSkin");var t=e.prototype;return n.imps(t,{"laya.d3.graphics.IVertex":!0}),a(0,t,"textureCoordinate",function(){return this._textureCoordinate}),a(0,t,"normal",function(){return this._normal}),a(0,t,"position",function(){return this._position}),a(0,t,"vertexDeclaration",function(){return e._vertexDeclaration}),a(1,e,"vertexDeclaration",function(){return e._vertexDeclaration}),i(e,["_vertexDeclaration",function(){return this._vertexDeclaration=new pe(88,[new ve(0,"vector3",0),new ve(12,"vector3",3),new ve(24,"vector3",5),new ve(36,"vector3",4),new ve(48,"vector2",2),new ve(56,"vector4",7),new ve(72,"vector4",6)])}]),e}(),Xe=function(){function e(e,t,n,i){this._position=null,this._normal=null,this._textureCoord0=null,this._textureCoord1=null,this._position=e,this._normal=t,this._textureCoord0=n,this._textureCoord1=i}r(e,"laya.d3.graphics.VertexPositionTerrain");var t=e.prototype;return n.imps(t,{"laya.d3.graphics.IVertex":!0}),a(0,t,"normal",function(){return this._normal}),a(0,t,"position",function(){return this._position}),a(0,t,"textureCoord0",function(){return this._textureCoord0}),a(0,t,"textureCoord1",function(){return this._textureCoord1}),a(0,t,"vertexDeclaration",function(){return e._vertexDeclaration}),a(1,e,"vertexDeclaration",function(){return e._vertexDeclaration}),i(e,["_vertexDeclaration",function(){return this._vertexDeclaration=new pe(40,[new ve(0,"vector3",0),new ve(12,"vector3",3),new ve(24,"vector2",2),new ve(32,"vector2",15)])}]),e}(),je=function(){function e(e,t){this._position=null,this._textureCoordinate0=null,this._position=e,this._textureCoordinate0=t}r(e,"laya.d3.graphics.VertexPositionTexture0");var t=e.prototype;return n.imps(t,{"laya.d3.graphics.IVertex":!0}),a(0,t,"position",function(){return this._position}),a(0,t,"textureCoordinate0",function(){return this._textureCoordinate0}),a(0,t,"vertexDeclaration",function(){return e._vertexDeclaration}),a(1,e,"vertexDeclaration",function(){return e._vertexDeclaration}),i(e,["_vertexDeclaration",function(){return this._vertexDeclaration=new pe(20,[new ve(0,"vector3",0),new ve(12,"vector2",2)])}]),e}(),Ze=function(){function e(e,t,n,i,r,a,s,o,l,h,_,u,c,d){this._cornerTextureCoordinate=null,this._positionStartLifeTime=null,this._velocity=null,this._startColor=null,this._startSize=null,this._startRotation0=null,this._startRotation1=null,this._startRotation2=null,this._startLifeTime=NaN,this._time=NaN,this._startSpeed=NaN,this._randoms0=null,this._randoms1=null,this._simulationWorldPostion=null,this._cornerTextureCoordinate=e,this._positionStartLifeTime=t,this._velocity=n,this._startColor=i,this._startSize=r,this._startRotation0=a,this._startRotation1=s,this._startRotation2=o,this._startLifeTime=l,this._time=h,this._startSpeed=_,this._randoms0=this.random0,this._randoms1=this.random1,this._simulationWorldPostion=d}r(e,"laya.d3.graphics.VertexShurikenParticleBillboard");var t=e.prototype;return n.imps(t,{"laya.d3.graphics.IVertex":!0}),a(0,t,"cornerTextureCoordinate",function(){return this._cornerTextureCoordinate}),a(0,t,"random1",function(){return this._randoms1}),a(0,t,"startRotation2",function(){return this._startRotation2}),a(0,t,"positionStartLifeTime",function(){return this._positionStartLifeTime}),a(0,t,"velocity",function(){return this._velocity}),a(0,t,"random0",function(){return this._randoms0}),a(0,t,"startSize",function(){return this._startSize}),a(0,t,"startColor",function(){return this._startColor}),a(0,t,"startRotation0",function(){return this._startRotation0}),a(0,t,"startRotation1",function(){return this._startRotation1}),a(0,t,"startLifeTime",function(){return this._startLifeTime}),a(0,t,"time",function(){return this._time}),a(0,t,"startSpeed",function(){return this._startSpeed}),a(0,t,"simulationWorldPostion",function(){return this._simulationWorldPostion}),a(0,t,"vertexDeclaration",function(){return e._vertexDeclaration}),a(1,e,"vertexDeclaration",function(){return e._vertexDeclaration}),i(e,["_vertexDeclaration",function(){return this._vertexDeclaration=new pe(152,[new ve(0,"vector4",17),new ve(16,"vector4",30),new ve(32,"vector4",32),new ve(48,"vector4",19),new ve(64,"vector3",20),new ve(76,"vector3",22),new ve(88,"single",31),new ve(92,"vector4",34),new ve(108,"vector4",35),new ve(124,"vector3",36),new ve(136,"vector4",37)])}]),e}(),Ye=function(){function e(e,t,n,i,r,a,s,o,l,h,_,u,c,d){this._cornerTextureCoordinate=null,this._positionStartLifeTime=null,this._velocity=null,this._startColor=null,this._startSize=null,this._startRotation0=null,this._startRotation1=null,this._startRotation2=null,this._startLifeTime=NaN,this._time=NaN,this._startSpeed=NaN,this._randoms0=null,this._randoms1=null,this._simulationWorldPostion=null,this._cornerTextureCoordinate=e,this._positionStartLifeTime=t,this._velocity=n,this._startColor=i,this._startSize=r,this._startRotation0=a,this._startRotation1=s,this._startRotation2=o,this._startLifeTime=l,this._time=h,this._startSpeed=_,this._randoms0=this.random0,this._randoms1=this.random1,this._simulationWorldPostion=d}r(e,"laya.d3.graphics.VertexShurikenParticleMesh");var t=e.prototype;return n.imps(t,{"laya.d3.graphics.IVertex":!0}),a(0,t,"cornerTextureCoordinate",function(){return this._cornerTextureCoordinate}),a(0,t,"velocity",function(){return this._velocity}),a(0,t,"position",function(){return this._positionStartLifeTime}),a(0,t,"random0",function(){return this._randoms0}),a(0,t,"startSize",function(){return this._startSize}),a(0,t,"startColor",function(){return this._startColor}),a(0,t,"startRotation0",function(){return this._startRotation0}),a(0,t,"startRotation1",function(){return this._startRotation1}),a(0,t,"random1",function(){return this._randoms1}),a(0,t,"startRotation2",function(){return this._startRotation2}),a(0,t,"startLifeTime",function(){return this._startLifeTime}),a(0,t,"time",function(){return this._time}),a(0,t,"startSpeed",function(){return this._startSpeed}),a(0,t,"simulationWorldPostion",function(){return this._simulationWorldPostion}),a(0,t,"vertexDeclaration",function(){return e._vertexDeclaration}),a(1,e,"vertexDeclaration",function(){return e._vertexDeclaration}),i(e,["_vertexDeclaration",function(){return this._vertexDeclaration=new pe(156,[new ve(0,"vector3",0),new ve(12,"vector2",2),new ve(20,"vector4",30),new ve(36,"vector4",32),new ve(52,"vector4",19),new ve(68,"vector3",20),new ve(80,"vector3",22),new ve(92,"single",31),new ve(96,"vector4",34),new ve(112,"vector4",35),new ve(128,"vector3",36),new ve(140,"vector4",37)])}]),e}(),qe=function(){function e(e,t,n,i,r,a){this._version=null,this._strings=["BLOCK","DATA","STRINGS"],this._materials=null,this._subMeshes=null,this._materialMap=null,this._readData=null,this._mesh=null,this._BLOCK={count:0},this._DATA={offset:0,size:0},this._STRINGS={offset:0,size:0},this._shaderAttributes=null,this._mesh=n,this._materials=i,this._subMeshes=r,this._materialMap=a,this._version=t,this._onLoaded(e)}r(e,"laya.d3.loaders.LoadModelV01");var t=e.prototype;return t._onLoaded=function(e){this._readData=e,this.READ_BLOCK();for(var t=0;t<this._BLOCK.count;t++){var n=this._readData.getUint16(),i=this._strings[n],r=this["READ_"+i];if(null==r)throw new Error("model file err,no this function:"+n+" "+i);if(!r.call(this))break}return this._mesh},t.onError=function(){},t._readString=function(){return this._strings[this._readData.getUint16()]},t.READ_BLOCK=function(){this._readData.getUint16();return this._BLOCK.count=this._readData.getUint16(),!0},t.READ_DATA=function(){return this._DATA.offset=this._readData.getUint32(),this._DATA.size=this._readData.getUint32(),!0},t.READ_STRINGS=function(){this._STRINGS.offset=this._readData.getUint16(),this._STRINGS.size=this._readData.getUint16();var e=this._readData.pos;this._readData.pos=this._STRINGS.offset+this._DATA.offset;for(var t=0;t<this._STRINGS.size;t++)this._strings[t]=this._readData.readUTFString();return this._readData.pos=e,!0},t.READ_MATERIAL=function(){var e=this._readData.getUint16(),t=(this._readString(),this._readString());return this._materials[e]="null"!==t?x.getRes(this._materialMap[t]):new jt,!0},t.READ_MESH=function(){this._readString();switch(this._version){case"LAYAMODEL:01":console.log("Warning: The (.lm) file is converted by old fbxTools,please reConverted it use  lastest fbxTools version,later we will remove the  support of old version (.lm) support.");break;case"LAYASKINANI:01":case"LAYAMODEL:02":var e=this._readData.__getBuffer(),t=0,n=0,i=this._readData.getUint32(),r=this._readData.getUint32(),a=(new Float32Array(e.slice(i+this._DATA.offset,i+this._DATA.offset+r)),this._readData.getUint32()),s=this._readData.getUint32(),o=new Float32Array(e.slice(a+this._DATA.offset,a+this._DATA.offset+s));for(this.mesh._inverseBindPoses=[],t=0,n=o.length;t<n;t+=16){var l=new at(o[t+0],o[t+1],o[t+2],o[t+3],o[t+4],o[t+5],o[t+6],o[t+7],o[t+8],o[t+9],o[t+10],o[t+11],o[t+12],o[t+13],o[t+14],o[t+15]);this.mesh._inverseBindPoses.push(l)}break;default:throw new Error("LoadModel:unknown version.")}return!0},t.READ_SUBMESH=function(){this._readString(),this._readData.getUint8();var t=this._readString();this._shaderAttributes=t.match(e._attrReg);var n=this._readData.getUint32(),i=this._readData.getUint32(),r=(this._readData.getUint32(),this._readData.getUint32(),this._readData.getUint32()),a=this._readData.getUint32(),s=this._readData.getUint32(),o=this._readData.getUint32(),l=this._readData.__getBuffer(),h=new mt(this._mesh),_=this._getVertexDeclaration(),u=En.create(_,a/_.vertexStride,35044,!0),c=r+this._DATA.offset,d=l.slice(c,c+a);u.setData(new Float32Array(d)),h._vertexBuffer=u;for(var f=u.vertexDeclaration.getVertexElements(),m=0;m<f.length;m++)h._bufferUsage[f[m].elementUsage]=u;var p=xn.create("ushort",i/2,35044,!0),v=n+this._DATA.offset,g=l.slice(v,v+i);p.setData(new Uint16Array(g)),h._indexBuffer=p;var x=l.slice(s+this._DATA.offset,s+this._DATA.offset+o);return h._boneIndicesList[0]=new Uint8Array(x),this._subMeshes.push(h),!0},t.READ_DATAAREA=function(){return!1},t._getVertexDeclaration=function(){for(var e=!1,t=!1,n=!1,i=!1,r=!1,a=!1,s=!1,o=!1,l=!1,h=0;h<this._shaderAttributes.length;h+=8)switch(this._shaderAttributes[h]){case"POSITION":e=!0;break;case"NORMAL":t=!0;break;case"COLOR":n=!0;break;case"UV":i=!0;break;case"UV1":r=!0;break;case"BLENDWEIGHT":s=!0;break;case"BLENDINDICES":o=!0;break;case"TANGENT":a=!0;break;case"BINORMAL":l=!0}var _;return e&&t&&n&&i&&r&&s&&o&&a?_=Ce.vertexDeclaration:e&&t&&n&&i&&r&&s&&o?_=Ae.vertexDeclaration:e&&t&&i&&r&&s&&o&&a?_=Fe.vertexDeclaration:e&&t&&i&&r&&s&&o?_=Le.vertexDeclaration:e&&t&&n&&i&&s&&o&&a?_=Ve.vertexDeclaration:e&&t&&n&&i&&s&&o?_=we.vertexDeclaration:e&&t&&a&&l&&i&&s&&o?_=We.vertexDeclaration:e&&t&&i&&s&&o&&a?_=He.vertexDeclaration:e&&t&&i&&s&&o?_=Ue.vertexDeclaration:e&&t&&n&&s&&o&&a?_=Te.vertexDeclaration:e&&t&&n&&s&&o?_=De.vertexDeclaration:e&&t&&n&&i&&r&&a?_=Ie.vertexDeclaration:e&&t&&n&&i&&r?_=Re.vertexDeclaration:e&&t&&i&&r&&a?_=Be.vertexDeclaration:e&&t&&i&&r?_=Pe.vertexDeclaration:e&&t&&n&&i&&a?_=Ne.vertexDeclaration:e&&t&&i&&a&&l?_=Ge.vertexDeclaration:e&&t&&n&&i?_=ye.vertexDeclaration:e&&t&&i&&a?_=ze.vertexDeclaration:e&&t&&i?_=be.vertexDeclaration:e&&t&&n&&a?_=Me.vertexDeclaration:e&&t&&n&&(_=Se.vertexDeclaration),_},a(0,t,"mesh",function(){return this._mesh}),e._attrReg=new RegExp("(\\w+)|([:,;])","g"),e}(),Qe=function(){function e(){}return r(e,"laya.d3.loaders.LoadModelV02"),e.parse=function(t,n,i,r,a,s){e._mesh=i,e._materials=r,e._subMeshes=a,e._materialMap=s,e._version=n,e._readData=t,e.READ_DATA(),e.READ_BLOCK(),e.READ_STRINGS();for(var o=0,l=e._BLOCK.count;o<l;o++){e._readData.pos=e._BLOCK.blockStarts[o];var h=e._readData.getUint16(),_=e._strings[h],u=e["READ_"+_];if(null==u)throw new Error("model file err,no this function:"+h+" "+_);u.call()}e._strings.length=0,e._readData=null,e._version=null,e._mesh=null,e._materials=null,e._subMeshes=null,e._materialMap=null},e._readString=function(){return e._strings[e._readData.getUint16()]},e.READ_DATA=function(){e._DATA.offset=e._readData.getUint32(),e._DATA.size=e._readData.getUint32()},e.READ_BLOCK=function(){for(var t=e._BLOCK.count=e._readData.getUint16(),n=e._BLOCK.blockStarts=[],i=e._BLOCK.blockLengths=[],r=0;r<t;r++)n.push(e._readData.getUint32()),i.push(e._readData.getUint32())},e.READ_STRINGS=function(){var t=e._readData.getUint32(),n=e._readData.getUint16(),i=e._readData.pos;e._readData.pos=t+e._DATA.offset;for(var r=0;r<n;r++)e._strings[r]=e._readData.readUTFString();e._readData.pos=i},e.READ_MATERIAL=function(){e._readString(),e._readString();var t=e._readString();return""!==t&&e._materials.push(x.getRes(e._materialMap[t])),!0},e.READ_MESH=function(){e._readString();var t=e._readData.__getBuffer(),n=0,i=0,r=e._readData.getInt16(),a=e._DATA.offset;for(n=0;n<r;n++){var s=a+e._readData.getUint32(),o=e._readData.getUint32(),l=new Float32Array(t.slice(s,s+o)),h=e._readString().match(e._attrReg),_=e._getVertexDeclaration(h),u=En.create(_,4*l.length/_.vertexStride,35044,!0);u.setData(l),e._mesh._vertexBuffers.push(u)}var c=a+e._readData.getUint32(),d=e._readData.getUint32(),f=new Uint16Array(t.slice(c,c+d)),m=xn.create("ushort",d/2,35044,!0);m.setData(f),e._mesh._indexBuffer=m;var p=e._mesh._boneNames=[],v=e._readData.getUint16();for(p.length=v,n=0;n<v;n++)p[n]=e._strings[e._readData.getUint16()];var g=e._readData.getUint32(),x=e._readData.getUint32(),E=(new Float32Array(t.slice(a+g,a+g+x)),e._readData.getUint32()),S=e._readData.getUint32(),D=new Float32Array(t.slice(a+E,a+E+S));for(e._mesh._inverseBindPoses=[],n=0,i=D.length;n<i;n+=16){var T=new at(D[n+0],D[n+1],D[n+2],D[n+3],D[n+4],D[n+5],D[n+6],D[n+7],D[n+8],D[n+9],D[n+10],D[n+11],D[n+12],D[n+13],D[n+14],D[n+15]);e._mesh._inverseBindPoses.push(T)}return!0},e.READ_SUBMESH=function(){var t=e._readData.__getBuffer(),n=new mt(e._mesh),i=e._readData.getInt16(),r=e._readData.getUint32(),a=e._readData.getUint32();n._vertexBuffer=e._mesh._vertexBuffers[i],n._vertexStart=r,n._vertexCount=a;var s=e._readData.getUint32(),o=e._readData.getUint32(),l=e._mesh._indexBuffer;n._indexBuffer=l,n._indexStart=s,n._indexCount=o,n._indices=new Uint16Array(l.getData().buffer,2*s,o);var h=e._DATA.offset,_=n._subIndexBufferStart,u=n._subIndexBufferCount,c=n._boneIndicesList,d=e._readData.getUint16();_.length=d,u.length=d,c.length=d;for(var f=0;f<d;f++){_[f]=e._readData.getUint32(),u[f]=e._readData.getUint32();var m=e._readData.getUint32(),p=e._readData.getUint32();n._boneIndicesList[f]=new Uint8Array(t.slice(h+m,h+m+p))}return e._subMeshes.push(n),!0},e._getVertexDeclaration=function(e){for(var t=!1,n=!1,i=!1,r=!1,a=!1,s=!1,o=!1,l=!1,h=!1,_=0;_<e.length;_++)switch(e[_]){case"POSITION":t=!0;break;case"NORMAL":n=!0;break;case"COLOR":i=!0;break;case"UV":r=!0;break;case"UV1":a=!0;break;case"BLENDWEIGHT":o=!0;break;case"BLENDINDICES":l=!0;break;case"TANGENT":s=!0;break;case"BINORMAL":h=!0}var u;return t&&n&&i&&r&&a&&o&&l&&s?u=Ce.vertexDeclaration:t&&n&&i&&r&&a&&o&&l?u=Ae.vertexDeclaration:t&&n&&r&&a&&o&&l&&s?u=Fe.vertexDeclaration:t&&n&&r&&a&&o&&l?u=Le.vertexDeclaration:t&&n&&i&&r&&o&&l&&s?u=Ve.vertexDeclaration:t&&n&&i&&r&&o&&l?u=we.vertexDeclaration:t&&n&&r&&o&&l&&s?u=He.vertexDeclaration:t&&n&&r&&o&&l?u=Ue.vertexDeclaration:t&&n&&i&&o&&l&&s?u=Te.vertexDeclaration:t&&n&&i&&o&&l?u=De.vertexDeclaration:t&&n&&i&&r&&a&&s?u=Ie.vertexDeclaration:t&&n&&i&&r&&a?u=Re.vertexDeclaration:t&&n&&r&&a&&s?u=Be.vertexDeclaration:t&&n&&r&&a?u=Pe.vertexDeclaration:t&&n&&i&&r&&s?u=Ne.vertexDeclaration:t&&n&&r&&s&&h?u=Ge.vertexDeclaration:t&&n&&i&&r?u=ye.vertexDeclaration:t&&n&&r&&s?u=ze.vertexDeclaration:t&&n&&r?u=be.vertexDeclaration:t&&n&&i&&s?u=Me.vertexDeclaration:t&&n&&i&&(u=Se.vertexDeclaration),u},e._attrReg=new RegExp("(\\w+)|([:,;])","g"),e._strings=[],e._readData=null,e._version=null,e._mesh=null,e._materials=null,e._subMeshes=null,e._materialMap=null,i(e,["_BLOCK",function(){return this._BLOCK={count:0}},"_DATA",function(){return this._DATA={offset:0,size:0}}]),e}(),Ke=function(){function e(){}return r(e,"laya.d3.loaders.LoadModelV03"),e.parse=function(t,n,i,r,a){e._mesh=i,e._subMeshes=r,e._materialMap=a,e._version=n,e._readData=t,e.READ_DATA(),e.READ_BLOCK(),e.READ_STRINGS();for(var s=0,o=e._BLOCK.count;s<o;s++){e._readData.pos=e._BLOCK.blockStarts[s];var l=e._readData.getUint16(),h=e._strings[l],_=e["READ_"+h];if(null==_)throw new Error("model file err,no this function:"+l+" "+h);_.call()}e._strings.length=0,e._readData=null,e._version=null,e._mesh=null,e._subMeshes=null,e._materialMap=null},e._readString=function(){return e._strings[e._readData.getUint16()]},e.READ_DATA=function(){e._DATA.offset=e._readData.getUint32(),e._DATA.size=e._readData.getUint32()},e.READ_BLOCK=function(){for(var t=e._BLOCK.count=e._readData.getUint16(),n=e._BLOCK.blockStarts=[],i=e._BLOCK.blockLengths=[],r=0;r<t;r++)n.push(e._readData.getUint32()),i.push(e._readData.getUint32())},e.READ_STRINGS=function(){var t=e._readData.getUint32(),n=e._readData.getUint16(),i=e._readData.pos;e._readData.pos=t+e._DATA.offset;for(var r=0;r<n;r++)e._strings[r]=e._readData.readUTFString();e._readData.pos=i},e.READ_MESH=function(){e._readString();var t=e._readData.__getBuffer(),n=0,i=0,r=e._readData.getInt16(),a=e._DATA.offset;for(n=0;n<r;n++){var s=a+e._readData.getUint32(),o=e._readData.getUint32(),l=new Float32Array(t.slice(s,s+o)),h=e._readString(),_=e._vertexDeclarationMap[h];if(!_)throw new Error("LoadModelV03: unknown vertexDeclaration.");var u=En.create(_,4*l.length/_.vertexStride,35044,!0);u.setData(l),e._mesh._vertexBuffers.push(u)}var c=a+e._readData.getUint32(),d=e._readData.getUint32(),f=new Uint16Array(t.slice(c,c+d)),m=xn.create("ushort",d/2,35044,!0);m.setData(f),e._mesh._indexBuffer=m;var p=e._mesh._boneNames=[],v=e._readData.getUint16();for(p.length=v,n=0;n<v;n++)p[n]=e._strings[e._readData.getUint16()];e._readData.pos+=8;var g=e._readData.getUint32(),x=e._readData.getUint32(),E=new Float32Array(t.slice(a+g,a+g+x));for(e._mesh._inverseBindPoses=[],n=0,i=E.length;n<i;n+=16){var S=new at(E[n+0],E[n+1],E[n+2],E[n+3],E[n+4],E[n+5],E[n+6],E[n+7],E[n+8],E[n+9],E[n+10],E[n+11],E[n+12],E[n+13],E[n+14],E[n+15]);e._mesh._inverseBindPoses.push(S)}return!0},e.READ_SUBMESH=function(){var t=e._readData.__getBuffer(),n=new mt(e._mesh),i=e._readData.getInt16(),r=e._readData.getUint32(),a=e._readData.getUint32();n._vertexBuffer=e._mesh._vertexBuffers[i],n._vertexStart=r,n._vertexCount=a;var s=e._readData.getUint32(),o=e._readData.getUint32(),l=e._mesh._indexBuffer;n._indexBuffer=l,n._indexStart=s,n._indexCount=o,n._indices=new Uint16Array(l.getData().buffer,2*s,o);var h=e._DATA.offset,_=n._subIndexBufferStart,u=n._subIndexBufferCount,c=n._boneIndicesList,d=e._readData.getUint16();_.length=d,u.length=d,c.length=d;for(var f=0;f<d;f++){_[f]=e._readData.getUint32(),u[f]=e._readData.getUint32();var m=e._readData.getUint32(),p=e._readData.getUint32();n._boneIndicesList[f]=new Uint8Array(t.slice(h+m,h+m+p))}return e._subMeshes.push(n),!0},e._strings=[],e._readData=null,e._version=null,e._mesh=null,e._subMeshes=null,e._materialMap=null,i(e,["_vertexDeclarationMap",function(){return this._vertexDeclarationMap={"POSITION,NORMAL,COLOR,UV,UV1,BLENDWEIGHT,BLENDINDICES,TANGENT":Ce.vertexDeclaration,"POSITION,NORMAL,COLOR,UV,UV1,BLENDWEIGHT,BLENDINDICES":Ae.vertexDeclaration,"POSITION,NORMAL,TANGENT,BINORMAL,UV,UV1,BLENDWEIGHT,BLENDINDICES,":ke.vertexDeclaration,"POSITION,NORMAL,UV,UV1,BLENDWEIGHT,BLENDINDICES,TANGENT":Fe.vertexDeclaration,"POSITION,NORMAL,UV,UV1,BLENDWEIGHT,BLENDINDICES":Le.vertexDeclaration,"POSITION,NORMAL,COLOR,UV,BLENDWEIGHT,BLENDINDICES,TANGENT":Ve.vertexDeclaration,"POSITION,NORMAL,COLOR,UV,BLENDWEIGHT,BLENDINDICES":we.vertexDeclaration,"POSITION,NORMAL,UV,BLENDWEIGHT,BLENDINDICES,TANGENT":He.vertexDeclaration,"POSITION,NORMAL,UV,BLENDWEIGHT,BLENDINDICES":Ue.vertexDeclaration,"POSITION,NORMAL,COLOR,BLENDWEIGHT,BLENDINDICES,TANGENT":Te.vertexDeclaration,"POSITION,NORMAL,COLOR,BLENDWEIGHT,BLENDINDICES":De.vertexDeclaration,"POSITION,NORMAL,COLOR,UV,UV1,TANGENT":Ie.vertexDeclaration,"POSITION,NORMAL,COLOR,UV,UV1":Re.vertexDeclaration,"POSITION,NORMAL,UV,UV1,TANGENT":Be.vertexDeclaration,"POSITION,NORMAL,UV,UV1":Pe.vertexDeclaration,"POSITION,NORMAL,COLOR,UV,TANGENT":Ne.vertexDeclaration,"POSITION,NORMAL,UV,TANGENT,BINORMAL":Ge.vertexDeclaration,"POSITION,NORMAL,COLOR,UV":ye.vertexDeclaration,"POSITION,NORMAL,UV,TANGENT":ze.vertexDeclaration,"POSITION,NORMAL,UV":be.vertexDeclaration,"POSITION,NORMAL,COLOR,TANGENT":Me.vertexDeclaration,"POSITION,NORMAL,COLOR":Se.vertexDeclaration,"POSITION,NORMAL,TANGENT":Oe.vertexDeclaration,"POSITION,NORMAL":Ee.vertexDeclaration,"POSITION,UV":je.vertexDeclaration,POSITION:xe.vertexDeclaration}},"_BLOCK",function(){return this._BLOCK={count:0}},"_DATA",function(){return this._DATA={offset:0,size:0}}]),e}(),$e=function(){function e(){}return r(e,"laya.d3.loaders.MeshReader"),e.read=function(t,n,i,r,a){var s=new f(t);s.pos=0;var o=s.readUTFString();switch(o){case"LAYAMODEL:01":case"LAYASKINANI:01":e._readVersion01(s,o,n,i,r,a);break;case"LAYAMODEL:02":Qe.parse(s,o,n,i,r,a);break;case"LAYAMODEL:03":Ke.parse(s,o,n,r,a);break;default:throw new Error("MeshReader: unknown mesh version.")}n._setSubMeshes(r)},e._readVersion01=function(e,t,n,i,r,a){new qe(e,t,n,i,r,a)},e}(),Je=function(){function e(e,t){this.min=null,this.max=null,this.min=e,this.max=t}r(e,"laya.d3.math.BoundBox");var t=e.prototype;return n.imps(t,{"laya.d3.core.IClone":!0}),t.getCorners=function(e){e.length=8;var t=this.min.elements,n=this.max.elements,i=t[0],r=t[1],a=t[2],s=n[0],o=n[1],l=n[2];e[0]=new ct(i,o,l),e[1]=new ct(s,o,l),e[2]=new ct(s,r,l),e[3]=new ct(i,r,l),e[4]=new ct(i,o,a),e[5]=new ct(s,o,a),e[6]=new ct(s,r,a),e[7]=new ct(i,r,a)},t.toDefault=function(){this.min.toDefault(),this.max.toDefault()},t.cloneTo=function(e){var t=e;this.min.cloneTo(t.min),this.max.cloneTo(t.max)},t.clone=function(){var e=new this.constructor(new ct,new ct);return this.cloneTo(e),e},e.createfromPoints=function(e,t){if(null==e)throw new Error("points");var n=t.min,i=t.max,r=n.elements;r[0]=Number.MAX_VALUE,r[1]=Number.MAX_VALUE,r[2]=Number.MAX_VALUE;var a=i.elements;a[0]=-Number.MAX_VALUE,a[1]=-Number.MAX_VALUE,a[2]=-Number.MAX_VALUE;for(var s=0,o=e.length;s<o;++s)ct.min(n,e[s],n),ct.max(i,e[s],i)},e.merge=function(e,t,n){ct.min(e.min,t.min,n.min),ct.max(e.max,t.max,n.max)},e}(),et=function(){function e(t){this._matrix=null,this._near=null,this._far=null,this._left=null,this._right=null,this._top=null,this._bottom=null,this._matrix=t,this._near=new ot(new ct),this._far=new ot(new ct),this._left=new ot(new ct),this._right=new ot(new ct),this._top=new ot(new ct),this._bottom=new ot(new ct),e._getPlanesFromMatrix(this._matrix,this._near,this._far,this._left,this._right,this._top,this._bottom)}r(e,"laya.d3.math.BoundFrustum");var t=e.prototype;return t.equalsBoundFrustum=function(e){return this._matrix.equalsOtherMatrix(e.matrix)},t.equalsObj=function(e){if(e instanceof laya.d3.math.BoundFrustum){var t=e;return this.equalsBoundFrustum(t)}return!1},t.getPlane=function(e){switch(e){case 0:return this._near;case 1:return this._far;case 2:return this._left;case 3:return this._right;case 4:return this._top;case 5:return this._bottom;default:return null}},t.getCorners=function(t){e._get3PlaneInterPoint(this._near,this._bottom,this._right).cloneTo(t[0]),e._get3PlaneInterPoint(this._near,this._top,this._right).cloneTo(t[1]),e._get3PlaneInterPoint(this._near,this._top,this._left).cloneTo(t[2]),e._get3PlaneInterPoint(this._near,this._bottom,this._left).cloneTo(t[3]),e._get3PlaneInterPoint(this._far,this._bottom,this._right).cloneTo(t[4]),e._get3PlaneInterPoint(this._far,this._top,this._right).cloneTo(t[5]),e._get3PlaneInterPoint(this._far,this._top,this._left).cloneTo(t[6]),e._get3PlaneInterPoint(this._far,this._bottom,this._left).cloneTo(t[7])},t.containsPoint=function(e){for(var t=ot.PlaneIntersectionType_Front,n=ot.PlaneIntersectionType_Front,i=0;i<6;i++){switch(i){case 0:n=nt.intersectsPlaneAndPoint(this._near,e);break;case 1:n=nt.intersectsPlaneAndPoint(this._far,e);break;case 2:n=nt.intersectsPlaneAndPoint(this._left,e);break;case 3:n=nt.intersectsPlaneAndPoint(this._right,e);break;case 4:n=nt.intersectsPlaneAndPoint(this._top,e);break;case 5:n=nt.intersectsPlaneAndPoint(this._bottom,e)}switch(n){case ot.PlaneIntersectionType_Back:return 0;case ot.PlaneIntersectionType_Intersecting:t=ot.PlaneIntersectionType_Intersecting}}switch(t){case ot.PlaneIntersectionType_Intersecting:return 2;default:return 1}},t.containsBoundBox=function(t){for(var n,i=e._tempV30,r=e._tempV31,a=1,s=0;s<6;s++){if(n=this.getPlane(s),this._getBoxToPlanePVertexNVertex(t,n.normal,i,r),nt.intersectsPlaneAndPoint(n,i)===ot.PlaneIntersectionType_Back)return 0;nt.intersectsPlaneAndPoint(n,r)===ot.PlaneIntersectionType_Back&&(a=2)}return a},t.containsBoundSphere=function(e){for(var t=ot.PlaneIntersectionType_Front,n=ot.PlaneIntersectionType_Front,i=0;i<6;i++){switch(i){case 0:n=nt.intersectsPlaneAndSphere(this._near,e);break;case 1:n=nt.intersectsPlaneAndSphere(this._far,e);break;case 2:n=nt.intersectsPlaneAndSphere(this._left,e);break;case 3:n=nt.intersectsPlaneAndSphere(this._right,e);break;case 4:n=nt.intersectsPlaneAndSphere(this._top,e);break;case 5:n=nt.intersectsPlaneAndSphere(this._bottom,e)}switch(n){case ot.PlaneIntersectionType_Back:return 0;case ot.PlaneIntersectionType_Intersecting:t=ot.PlaneIntersectionType_Intersecting}}switch(t){case ot.PlaneIntersectionType_Intersecting:return 2;default:return 1}},t._getBoxToPlanePVertexNVertex=function(e,t,n,i){var r=e.min,a=r.elements,s=e.max,o=s.elements,l=t.elements,h=l[0],_=l[1],u=l[2];r.cloneTo(n);var c=n.elements;h>=0&&(c[0]=o[0]),_>=0&&(c[1]=o[1]),u>=0&&(c[2]=o[2]),s.cloneTo(i);var d=i.elements;h>=0&&(d[0]=a[0]),_>=0&&(d[1]=a[1]),u>=0&&(d[2]=a[2])},a(0,t,"top",function(){return this._top}),a(0,t,"matrix",function(){return this._matrix},function(t){this._matrix=t,e._getPlanesFromMatrix(this._matrix,this._near,this._far,this._left,this._right,this._top,this._bottom)}),a(0,t,"near",function(){return this._near}),a(0,t,"far",function(){return this._far}),a(0,t,"left",function(){return this._left}),a(0,t,"right",function(){return this._right}),a(0,t,"bottom",function(){return this._bottom}),e._getPlanesFromMatrix=function(e,t,n,i,r,a,s){var o=e.elements,l=o[0],h=o[1],_=o[2],u=o[3],c=o[4],d=o[5],f=o[6],m=o[7],p=o[8],v=o[9],g=o[10],x=o[11],E=o[12],S=o[13],D=o[14],T=o[15],M=t.normal.elements;M[0]=u+_,M[1]=m+f,M[2]=x+g,t.distance=T+D,t.normalize();var y=n.normal.elements;y[0]=u-_,y[1]=m-f,y[2]=x-g,n.distance=T-D,n.normalize();var R=i.normal.elements;R[0]=u+l,R[1]=m+c,R[2]=x+p,i.distance=T+E,i.normalize();var A=r.normal.elements;A[0]=u-l,A[1]=m-c,A[2]=x-p,r.distance=T-E,r.normalize();var C=a.normal.elements;C[0]=u-h,C[1]=m-d,C[2]=x-v,a.distance=T-S,a.normalize();var I=s.normal.elements;I[0]=u+h,I[1]=m+d,I[2]=x+v,s.distance=T+S,s.normalize()},e._get3PlaneInterPoint=function(t,n,i){var r=t.normal,a=n.normal,s=i.normal;ct.cross(a,s,e._tempV30),ct.cross(s,r,e._tempV31),ct.cross(r,a,e._tempV32);var o=ct.dot(r,e._tempV30),l=ct.dot(a,e._tempV31),h=ct.dot(s,e._tempV32);return ct.scale(e._tempV30,-t.distance/o,e._tempV33),ct.scale(e._tempV31,-n.distance/l,e._tempV34),ct.scale(e._tempV32,-i.distance/h,e._tempV35),ct.add(e._tempV33,e._tempV34,e._tempV36),ct.add(e._tempV35,e._tempV36,e._tempV37),e._tempV37},i(e,["_tempV30",function(){return this._tempV30=new ct},"_tempV31",function(){return this._tempV31=new ct},"_tempV32",function(){return this._tempV32=new ct},"_tempV33",function(){return this._tempV33=new ct},"_tempV34",function(){return this._tempV34=new ct},"_tempV35",function(){return this._tempV35=new ct},"_tempV36",function(){return this._tempV36=new ct},"_tempV37",function(){return this._tempV37=new ct}]),e}(),tt=function(){function e(e,t){this.center=null,this.radius=NaN,this.center=e,this.radius=t}r(e,"laya.d3.math.BoundSphere");var t=e.prototype;return n.imps(t,{"laya.d3.core.IClone":!0}),t.toDefault=function(){this.center.toDefault(),this.radius=0},t.intersectsRayDistance=function(e){return nt.intersectsRayAndSphereRD(e,this)},t.intersectsRayPoint=function(e,t){return nt.intersectsRayAndSphereRP(e,this,t)},t.cloneTo=function(e){var t=e;this.center.cloneTo(t.center),t.radius=this.radius},t.clone=function(){var e=new this.constructor(new ct,new ct);return this.cloneTo(e),e},e.createFromSubPoints=function(t,n,i,r){if(null==t)throw new Error("points");if(n<0||n>=t.length)throw new Error("start"+n+"Must be in the range [0, "+(t.length-1)+"]");if(i<0||n+i>t.length)throw new Error("count"+i+"Must be in the range <= "+t.length+"}");var a=n+i,s=e._tempVector3;s.elements[0]=0,s.elements[1]=0,s.elements[2]=0;for(var o=n;o<a;++o)ct.add(t[o],s,s);var l=r.center;ct.scale(s,1/i,l);var h=0;for(o=n;o<a;++o){var _=ct.distanceSquared(l,t[o]);_>h&&(h=_)}r.radius=Math.sqrt(h)},e.createfromPoints=function(t,n){if(null==t)throw new Error("points");e.createFromSubPoints(t,0,t.length,n)},i(e,["_tempVector3",function(){return this._tempVector3=new ct}]),e}(),nt=function(){function e(){}return r(e,"laya.d3.math.Collision"),e.distancePlaneToPoint=function(e,t){return ct.dot(e.normal,t)-e.distance},e.distanceBoxToPoint=function(e,t){var n=e.min.elements,i=n[0],r=n[1],a=n[2],s=e.max.elements,o=s[0],l=s[1],h=s[2],_=t.elements,u=_[0],c=_[1],d=_[2],f=0;return u<i&&(f+=(i-u)*(i-u)),u>o&&(f+=(o-u)*(o-u)),c<r&&(f+=(r-c)*(r-c)),c>l&&(f+=(l-c)*(l-c)),d<a&&(f+=(a-d)*(a-d)),d>h&&(f+=(h-d)*(h-d)),Math.sqrt(f)},e.distanceBoxToBox=function(e,t){var n=e.min.elements,i=n[0],r=n[1],a=n[2],s=e.max.elements,o=s[0],l=s[1],h=s[2],_=t.min.elements,u=_[0],c=_[1],d=_[2],f=t.max.elements,m=f[0],p=f[1],v=f[2],g=0,x=NaN;return i>m?g+=(x=i-m)*x:u>o&&(g+=(x=u-o)*x),r>p?g+=(x=r-p)*x:c>l&&(g+=(x=c-l)*x),a>v?g+=(x=a-v)*x:d>h&&(g+=(x=d-h)*x),Math.sqrt(g)},e.distanceSphereToPoint=function(e,t){var n=Math.sqrt(ct.distanceSquared(e.center,t));return n-=e.radius,Math.max(n,0)},e.distanceSphereToSphere=function(e,t){var n=Math.sqrt(ct.distanceSquared(e.center,t.center));return n-=e.radius+t.radius,Math.max(n,0)},e.intersectsRayAndTriangleRD=function(t,n,i,r,a){var s=t.origin.elements,o=s[0],l=s[1],h=s[2],_=t.direction.elements,u=_[0],c=_[1],d=_[2],f=n.elements,m=f[0],p=f[1],v=f[2],g=i.elements,x=g[0],E=g[1],S=g[2],D=r.elements,T=D[0],M=D[1],y=D[2],R=e._tempV30.elements,A=R[0],C=R[1],I=R[2];A=x-m,C=E-p,I=S-v;var w=e._tempV31.elements,V=w[0],N=w[1],O=w[2];V=T-m,N=M-p,O=y-v;var b=e._tempV32.elements,P=b[0],L=b[1],F=b[2],B=A*(P=c*O-d*N)+C*(L=d*V-u*O)+I*(F=u*N-c*V);if(it.isZero(B))return 0,!1;var U=1/B,H=e._tempV33.elements,z=H[0],G=H[1],k=H[2],W=(z=o-m)*P+(G=l-p)*L+(k=h-v)*F;if((W*=U)<0||W>1)return 0,!1;var X=e._tempV34.elements,j=X[0],Z=X[1],Y=X[2],q=u*(j=G*I-k*C)+c*(Z=k*A-z*I)+d*(Y=z*C-G*A);if((q*=U)<0||W+q>1)return 0,!1;var Q=V*j+N*Z+O*Y;return(Q*=U)<0?(0,!1):(Q,!0)},e.intersectsRayAndTriangleRP=function(t,n,i,r,a){return e.intersectsRayAndTriangleRD(t,n,i,r,NaN)?(ct.scale(t.direction,NaN,e._tempV30),ct.add(t.origin,e._tempV30,a),!0):(a=ct.ZERO,!1)},e.intersectsRayAndPoint=function(t,n){ct.subtract(t.origin,n,e._tempV30);var i=ct.dot(e._tempV30,t.direction),r=ct.dot(e._tempV30,e._tempV30)-it.zeroTolerance;return!(r>0&&i>0)&&!(i*i-r<0)},e.intersectsRayAndRay=function(t,n,i){var r=t.origin,a=r.elements,s=a[0],o=a[1],l=a[2],h=t.direction,_=h.elements,u=_[0],c=_[1],d=_[2],f=n.origin,m=f.elements,p=m[0],v=m[1],g=m[2],x=n.direction,E=x.elements,S=E[0],D=E[1],T=E[2];ct.cross(h,x,e._tempV30);var M=e._tempV30.elements,y=ct.scalarLength(e._tempV30);if(it.isZero(y)&&it.nearEqual(p,s)&&it.nearEqual(v,o)&&it.nearEqual(g,l))return ct.ZERO,!0;y*=y;var R=p-s,A=v-o,C=g-l,I=S,w=D,V=T,N=M[0],O=M[1],b=M[2],P=(R*w*b+A*V*N+C*I*O-R*V*O-A*I*b-C*w*N)/y;w=c,V=d,I=u;ct.scale(h,P,e._tempV30),ct.scale(x,P,e._tempV31),ct.add(r,e._tempV30,e._tempV32),ct.add(f,e._tempV31,e._tempV33);var L=e._tempV32.elements,F=e._tempV33.elements;return it.nearEqual(F[0],L[0])&&it.nearEqual(F[1],L[1])&&it.nearEqual(F[2],L[2])?(e._tempV32,!0):(ct.ZERO,!1)},e.intersectsPlaneAndTriangle=function(t,n,i,r){var a=e.intersectsPlaneAndPoint(t,n),s=e.intersectsPlaneAndPoint(t,i),o=e.intersectsPlaneAndPoint(t,r);return a==ot.PlaneIntersectionType_Front&&s==ot.PlaneIntersectionType_Front&&o==ot.PlaneIntersectionType_Front?ot.PlaneIntersectionType_Front:a==ot.PlaneIntersectionType_Back&&s==ot.PlaneIntersectionType_Back&&o==ot.PlaneIntersectionType_Back?ot.PlaneIntersectionType_Back:ot.PlaneIntersectionType_Intersecting},e.intersectsRayAndPlaneRD=function(e,t,n){var i=t.normal,r=ct.dot(i,e.direction);if(it.isZero(r))return 0,!1;var a=ct.dot(i,e.origin);return!((-t.distance-a)/r<0)},e.intersectsRayAndPlaneRP=function(t,n,i){return e.intersectsRayAndPlaneRD(t,n,NaN)?(ct.scale(t.direction,NaN,e._tempV30),ct.add(t.origin,e._tempV30,e._tempV31),e._tempV31,!0):(ct.ZERO,!1)},e.intersectsRayAndBoxRD=function(e,t){var n=e.origin.elements,i=n[0],r=n[1],a=n[2],s=e.direction.elements,o=s[0],l=s[1],h=s[2],_=t.min.elements,u=_[0],c=_[1],d=_[2],f=t.max.elements,m=f[0],p=f[1],v=f[2],g=0,x=it.MaxValue;if(it.isZero(o)){if(i<u||i>m)return-1}else{var E=1/o,S=(u-i)*E,D=(m-i)*E;if(S>D){var T=S;S=D,D=T}if(g=Math.max(S,g),x=Math.min(D,x),g>x)return-1}if(it.isZero(l)){if(r<c||r>p)return-1}else{var M=1/l,y=(c-r)*M,R=(p-r)*M;if(y>R){var A=y;y=R,R=A}if(g=Math.max(y,g),x=Math.min(R,x),g>x)return-1}if(it.isZero(h)){if(a<d||a>v)return-1}else{var C=1/h,I=(d-a)*C,w=(v-a)*C;if(I>w){var V=I;I=w,w=V}if(g=Math.max(I,g),x=Math.min(w,x),g>x)return-1}return g},e.intersectsRayAndBoxRP=function(t,n,i){var r=e.intersectsRayAndBoxRD(t,n);return-1===r?(ct.ZERO.cloneTo(i),r):(ct.scale(t.direction,r,e._tempV30),ct.add(t.origin,e._tempV30,e._tempV31),e._tempV31.cloneTo(i),r)},e.intersectsRayAndSphereRD=function(t,n){var i=n.radius;ct.subtract(t.origin,n.center,e._tempV30);var r=ct.dot(e._tempV30,t.direction),a=ct.dot(e._tempV30,e._tempV30)-i*i;if(a>0&&r>0)return-1;var s=r*r-a;if(s<0)return-1;var o=-r-Math.sqrt(s);return o<0&&(o=0),o},e.intersectsRayAndSphereRP=function(t,n,i){var r=e.intersectsRayAndSphereRD(t,n);return-1===r?(ct.ZERO.cloneTo(i),r):(ct.scale(t.direction,r,e._tempV30),ct.add(t.origin,e._tempV30,e._tempV31),e._tempV31.cloneTo(i),r)},e.intersectsSphereAndTriangle=function(t,n,i,r){var a=t.center,s=t.radius;return e.closestPointPointTriangle(a,n,i,r,e._tempV30),ct.subtract(e._tempV30,a,e._tempV31),ct.dot(e._tempV31,e._tempV31)<=s*s},e.intersectsPlaneAndPoint=function(e,t){var n=ct.dot(e.normal,t)+e.distance;return n>0?ot.PlaneIntersectionType_Front:n<0?ot.PlaneIntersectionType_Back:ot.PlaneIntersectionType_Intersecting},e.intersectsPlaneAndPlane=function(t,n){ct.cross(t.normal,n.normal,e._tempV30);var i=ct.dot(e._tempV30,e._tempV30);return!it.isZero(i)},e.intersectsPlaneAndPlaneRL=function(t,n,i){var r=t.normal,a=n.normal;ct.cross(r,a,e._tempV34);var s=ct.dot(e._tempV34,e._tempV34);return!it.isZero(s)&&(ct.scale(a,t.distance,e._tempV30),ct.scale(r,n.distance,e._tempV31),ct.subtract(e._tempV30,e._tempV31,e._tempV32),ct.cross(e._tempV32,e._tempV34,e._tempV33),ct.normalize(e._tempV34,e._tempV34),new _t(e._tempV33,e._tempV34),!0)},e.intersectsPlaneAndBox=function(t,n){var i=t.distance,r=t.normal,a=r.elements,s=a[0],o=a[1],l=a[2],h=n.min.elements,_=h[0],u=h[1],c=h[2],d=n.max.elements,f=d[0],m=d[1],p=d[2];e._tempV30.elements[0]=s>0?_:f,e._tempV30.elements[1]=o>0?u:m,e._tempV30.elements[2]=l>0?c:p,e._tempV31.elements[0]=s>0?f:_,e._tempV31.elements[1]=o>0?m:u,e._tempV31.elements[2]=l>0?p:c;var v=ct.dot(r,e._tempV30);return v+i>0?ot.PlaneIntersectionType_Front:(v=ct.dot(r,e._tempV31))+i<0?ot.PlaneIntersectionType_Back:ot.PlaneIntersectionType_Intersecting},e.intersectsPlaneAndSphere=function(e,t){var n=t.radius,i=ct.dot(e.normal,t.center)+e.distance;return i>n?ot.PlaneIntersectionType_Front:i<-n?ot.PlaneIntersectionType_Back:ot.PlaneIntersectionType_Intersecting},e.intersectsBoxAndBox=function(e,t){var n=e.min.elements,i=e.max.elements,r=t.min.elements,a=t.max.elements;return!(n[0]>a[0]||r[0]>i[0])&&(!(n[1]>a[1]||r[1]>i[1])&&!(n[2]>a[2]||r[2]>i[2]))},e.intersectsBoxAndSphere=function(t,n){var i=n.center,r=n.radius;return ct.Clamp(i,t.min,t.max,e._tempV30),ct.distanceSquared(i,e._tempV30)<=r*r},e.intersectsSphereAndSphere=function(e,t){var n=e.radius+t.radius;return ct.distanceSquared(e.center,t.center)<=n*n},e.boxContainsPoint=function(e,t){var n=e.min.elements,i=e.max.elements,r=t.elements;return n[0]<=r[0]&&i[0]>=r[0]&&n[1]<=r[1]&&i[1]>=r[1]&&n[2]<=r[2]&&i[2]>=r[2]?1:0},e.boxContainsBox=function(e,t){var n=e.min.elements,i=n[0],r=n[1],a=n[2],s=e.max.elements,o=s[0],l=s[1],h=s[2],_=t.min.elements,u=_[0],c=_[1],d=_[2],f=t.max.elements,m=f[0],p=f[1],v=f[2];return o<u||i>m?0:l<c||r>p?0:h<d||a>v?0:i<=u&&m<=m&&r<=c&&p<=l&&a<=d&&v<=h?1:2},e.boxContainsSphere=function(t,n){var i=t.min,r=i.elements,a=r[0],s=r[1],o=r[2],l=t.max,h=l.elements,_=h[0],u=h[1],c=h[2],d=n.center,f=d.elements,m=f[0],p=f[1],v=f[2],g=n.radius;return ct.Clamp(d,i,l,e._tempV30),ct.distanceSquared(d,e._tempV30)>g*g?0:a+g<=m&&m<=_-g&&_-a>g&&s+g<=p&&p<=u-g&&u-s>g&&o+g<=v&&v<=c-g&&c-o>g?1:2},e.sphereContainsPoint=function(e,t){return ct.distanceSquared(t,e.center)<=e.radius*e.radius?1:0},e.sphereContainsTriangle=function(t,n,i,r){var a=e.sphereContainsPoint(t,n),s=e.sphereContainsPoint(t,i),o=e.sphereContainsPoint(t,r);return 1==a&&1==s&&1==o?1:e.intersectsSphereAndTriangle(t,n,i,r)?2:0},e.sphereContainsBox=function(t,n){var i=t.center.elements,r=i[0],a=i[1],s=i[2],o=t.radius,l=n.min.elements,h=l[0],_=l[1],u=l[2],c=n.max.elements,d=c[0],f=c[1],m=c[2],p=e._tempV30.elements;p[0],p[1],p[2];if(!e.intersectsBoxAndSphere(n,t))return 0;var v=o*o;return r-h,a-f,s-m,ct.scalarLengthSquared(e._tempV30)>v?2:(r-d,a-f,s-m,ct.scalarLengthSquared(e._tempV30)>v?2:(r-d,a-_,s-m,ct.scalarLengthSquared(e._tempV30)>v?2:(r-h,a-_,s-m,ct.scalarLengthSquared(e._tempV30)>v?2:(r-h,a-f,s-u,ct.scalarLengthSquared(e._tempV30)>v?2:(r-d,a-f,s-u,ct.scalarLengthSquared(e._tempV30)>v?2:(r-d,a-_,s-u,ct.scalarLengthSquared(e._tempV30)>v?2:(r-h,a-_,s-u,ct.scalarLengthSquared(e._tempV30)>v?2:1)))))))},e.sphereContainsSphere=function(e,t){var n=e.radius,i=t.radius,r=ct.distance(e.center,t.center);return n+i<r?0:n-i<r?2:1},e.closestPointPointTriangle=function(t,n,i,r,a){ct.subtract(i,n,e._tempV30),ct.subtract(r,n,e._tempV31),ct.subtract(t,n,e._tempV32),ct.subtract(t,i,e._tempV33),ct.subtract(t,r,e._tempV34);var s=ct.dot(e._tempV30,e._tempV32),o=ct.dot(e._tempV31,e._tempV32),l=ct.dot(e._tempV30,e._tempV33),h=ct.dot(e._tempV31,e._tempV33),_=ct.dot(e._tempV30,e._tempV34),u=ct.dot(e._tempV31,e._tempV34);if(s<=0&&o<=0)n.cloneTo(a);else if(l>=0&&h<=l)i.cloneTo(a);else{var c=s*h-l*o;if(c<=0&&s>=0&&l<=0){var d=s/(s-l);return ct.scale(e._tempV30,d,a),void ct.add(n,a,a)}if(u>=0&&_<=u)r.cloneTo(a);else{var f=_*o-s*u;if(f<=0&&o>=0&&u<=0){var m=o/(o-u);return ct.scale(e._tempV31,m,a),void ct.add(n,a,a)}var p=l*u-_*h;if(p<=0&&h-l>=0&&_-u>=0){var v=(h-l)/(h-l+(_-u));return ct.subtract(r,i,a),ct.scale(a,v,a),void ct.add(i,a,a)}var g=1/(p+f+c),x=f*g,E=c*g;ct.scale(e._tempV30,x,e._tempV35),ct.scale(e._tempV31,E,e._tempV36),ct.add(e._tempV35,e._tempV36,a),ct.add(n,a,a)}}},e.closestPointPlanePoint=function(t,n,i){var r=t.normal,a=ct.dot(r,n)-t.distance;ct.scale(r,a,e._tempV30),ct.subtract(n,e._tempV30,i)},e.closestPointBoxPoint=function(t,n,i){ct.max(n,t.min,e._tempV30),ct.min(e._tempV30,t.max,i)},e.closestPointSpherePoint=function(e,t,n){var i=e.center;ct.subtract(t,i,n),ct.normalize(n,n),ct.scale(n,e.radius,n),ct.add(n,i,n)},e.closestPointSphereSphere=function(e,t,n){var i=e.center;ct.subtract(t.center,i,n),ct.normalize(n,n),ct.scale(n,e.radius,n),ct.add(n,i,n)},i(e,["_tempV30",function(){return this._tempV30=new ct},"_tempV31",function(){return this._tempV31=new ct},"_tempV32",function(){return this._tempV32=new ct},"_tempV33",function(){return this._tempV33=new ct},"_tempV34",function(){return this._tempV34=new ct},"_tempV35",function(){return this._tempV35=new ct},"_tempV36",function(){return this._tempV36=new ct}]),e}(),it=(function(){function e(){}r(e,"laya.d3.math.ContainmentType"),e.Disjoint=0,e.Contains=1,e.Intersects=2}(),function(){function e(){}return r(e,"laya.d3.math.MathUtils3D"),e.isZero=function(t){return Math.abs(t)<e.zeroTolerance},e.nearEqual=function(t,n){return!!e.isZero(t-n)},e.fastInvSqrt=function(t){return e.isZero(t)?t:1/Math.sqrt(t)},i(e,["zeroTolerance",function(){return this.zeroTolerance=1e-6},"MaxValue",function(){return this.MaxValue=3.40282347e38},"MinValue",function(){return this.MinValue=-3.40282347e38}]),e}()),rt=function(){function e(){var e=this.elements=new Float32Array(9);e[0]=1,e[1]=0,e[2]=0,e[3]=0,e[4]=1,e[5]=0,e[6]=0,e[7]=0,e[8]=1}r(e,"laya.d3.math.Matrix3x3");var t=e.prototype;return n.imps(t,{"laya.d3.core.IClone":!0}),t.determinant=function(){var e=this.elements,t=e[0],n=e[1],i=e[2],r=e[3],a=e[4],s=e[5],o=e[6],l=e[7],h=e[8];return t*(h*a-s*l)+n*(-h*r+s*o)+i*(l*r-a*o)},t.translate=function(e,t){var n=t.elements,i=this.elements,r=e.elements,a=i[0],s=i[1],o=i[2],l=i[3],h=i[4],_=i[5],u=i[6],c=i[7],d=i[8],f=r[0],m=r[1];n[0]=a,n[1]=s,n[2]=o,n[3]=l,n[4]=h,n[5]=_,n[6]=f*a+m*l+u,n[7]=f*s+m*h+c,n[8]=f*o+m*_+d},t.rotate=function(e,t){var n=t.elements,i=this.elements,r=i[0],a=i[1],s=i[2],o=i[3],l=i[4],h=i[5],_=i[6],u=i[7],c=i[8],d=Math.sin(e),f=Math.cos(e);n[0]=f*r+d*o,n[1]=f*a+d*l,n[2]=f*s+d*h,n[3]=f*o-d*r,n[4]=f*l-d*a,n[5]=f*h-d*s,n[6]=_,n[7]=u,n[8]=c},t.scale=function(e,t){var n=t.elements,i=this.elements,r=e.elements,a=r[0],s=r[1];n[0]=a*i[0],n[1]=a*i[1],n[2]=a*i[2],n[3]=s*i[3],n[4]=s*i[4],n[5]=s*i[5],n[6]=i[6],n[7]=i[7],n[8]=i[8]},t.invert=function(e){var t=e.elements,n=this.elements,i=n[0],r=n[1],a=n[2],s=n[3],o=n[4],l=n[5],h=n[6],_=n[7],u=n[8],c=u*o-l*_,d=-u*s+l*h,f=_*s-o*h,m=i*c+r*d+a*f;m||(e=null),m=1/m,t[0]=c*m,t[1]=(-u*r+a*_)*m,t[2]=(l*r-a*o)*m,t[3]=d*m,t[4]=(u*i-a*h)*m,t[5]=(-l*i+a*s)*m,t[6]=f*m,t[7]=(-_*i+r*h)*m,t[8]=(o*i-r*s)*m},t.transpose=function(e){var t=e.elements,n=this.elements;if(e===this){var i=n[1],r=n[2],a=n[5];t[1]=n[3],t[2]=n[6],t[3]=i,t[5]=n[7],t[6]=r,t[7]=a}else t[0]=n[0],t[1]=n[3],t[2]=n[6],t[3]=n[1],t[4]=n[4],t[5]=n[7],t[6]=n[2],t[7]=n[5],t[8]=n[8]},t.identity=function(){var e=this.elements;e[0]=1,e[1]=0,e[2]=0,e[3]=0,e[4]=1,e[5]=0,e[6]=0,e[7]=0,e[8]=1},t.cloneTo=function(e){var t,n,i;if(n=this.elements,i=e.elements,n!==i)for(t=0;t<9;++t)i[t]=n[t]},t.clone=function(){var e=new this.constructor;return this.cloneTo(e),e},e.createFromTranslation=function(e,t){t.elements;var n=e.elements;t[0]=1,t[1]=0,t[2]=0,t[3]=0,t[4]=1,t[5]=0,t[6]=n[0],t[7]=n[1],t[8]=1},e.createFromRotation=function(e,t){var n=t.elements,i=Math.sin(e),r=Math.cos(e);n[0]=r,n[1]=i,n[2]=0,n[3]=-i,n[4]=r,n[5]=0,n[6]=0,n[7]=0,n[8]=1},e.createFromScaling=function(e,t){var n=t.elements,i=e.elements;n[0]=i[0],n[1]=0,n[2]=0,n[3]=0,n[4]=i[1],n[5]=0,n[6]=0,n[7]=0,n[8]=1},e.createFromMatrix4x4=function(e,t){t[0]=e[0],t[1]=e[1],t[2]=e[2],t[3]=e[4],t[4]=e[5],t[5]=e[6],t[6]=e[8],t[7]=e[9],t[8]=e[10]},e.multiply=function(e,t,n){var i=n.elements,r=e.elements,a=t.elements,s=r[0],o=r[1],l=r[2],h=r[3],_=r[4],u=r[5],c=r[6],d=r[7],f=r[8],m=a[0],p=a[1],v=a[2],g=a[3],x=a[4],E=a[5],S=a[6],D=a[7],T=a[8];i[0]=m*s+p*h+v*c,i[1]=m*o+p*_+v*d,i[2]=m*l+p*u+v*f,i[3]=g*s+x*h+E*c,i[4]=g*o+x*_+E*d,i[5]=g*l+x*u+E*f,i[6]=S*s+D*h+T*c,i[7]=S*o+D*_+T*d,i[8]=S*l+D*u+T*f},e.lookAt=function(t,n,i,r){ct.subtract(t,n,e._tempV30),ct.normalize(e._tempV30,e._tempV30),ct.cross(i,e._tempV30,e._tempV31),ct.normalize(e._tempV31,e._tempV31),ct.cross(e._tempV30,e._tempV31,e._tempV32);var a=e._tempV30.elements,s=e._tempV31.elements,o=e._tempV32.elements,l=r.elements;l[0]=s[0],l[3]=s[1],l[6]=s[2],l[1]=o[0],l[4]=o[1],l[7]=o[2],l[2]=a[0],l[5]=a[1],l[8]=a[2]},e.DEFAULT=new e,i(e,["_tempV30",function(){return this._tempV30=new ct},"_tempV31",function(){return this._tempV31=new ct},"_tempV32",function(){return this._tempV32=new ct}]),e}(),at=function(){function e(e,t,n,i,r,a,s,o,l,h,_,u,c,d,f,m){void 0===e&&(e=1),void 0===t&&(t=0),void 0===n&&(n=0),void 0===i&&(i=0),void 0===r&&(r=0),void 0===a&&(a=1),void 0===s&&(s=0),void 0===o&&(o=0),void 0===l&&(l=0),void 0===h&&(h=0),void 0===_&&(_=1),void 0===u&&(u=0),void 0===c&&(c=0),void 0===d&&(d=0),void 0===f&&(f=0),void 0===m&&(m=1);var p=this.elements=new Float32Array(16);p[0]=e,p[1]=t,p[2]=n,p[3]=i,p[4]=r,p[5]=a,p[6]=s,p[7]=o,p[8]=l,p[9]=h,p[10]=_,p[11]=u,p[12]=c,p[13]=d,p[14]=f,p[15]=m}r(e,"laya.d3.math.Matrix4x4");var t=e.prototype;return n.imps(t,{"laya.d3.core.IClone":!0}),t.getElementByRowColumn=function(e,t){if(e<0||e>3)throw new Error("row","Rows and columns for matrices run from 0 to 3, inclusive.");if(t<0||t>3)throw new Error("column","Rows and columns for matrices run from 0 to 3, inclusive.");return this.elements[4*e+t]},t.setElementByRowColumn=function(e,t,n){if(e<0||e>3)throw new Error("row","Rows and columns for matrices run from 0 to 3, inclusive.");if(t<0||t>3)throw new Error("column","Rows and columns for matrices run from 0 to 3, inclusive.");this.elements[4*e+t]=n},t.equalsOtherMatrix=function(e){var t=this.elements,n=e.elements;return it.nearEqual(t[0],n[0])&&it.nearEqual(t[1],n[1])&&it.nearEqual(t[2],n[2])&&it.nearEqual(t[3],n[3])&&it.nearEqual(t[4],n[4])&&it.nearEqual(t[5],n[5])&&it.nearEqual(t[6],n[6])&&it.nearEqual(t[7],n[7])&&it.nearEqual(t[8],n[8])&&it.nearEqual(t[9],n[9])&&it.nearEqual(t[10],n[10])&&it.nearEqual(t[11],n[11])&&it.nearEqual(t[12],n[12])&&it.nearEqual(t[13],n[13])&&it.nearEqual(t[14],n[14])&&it.nearEqual(t[15],n[15])},t.decomposeTransRotScale=function(t,n,i){var r=e._tempMatrix4x4;return this.decomposeTransRotMatScale(t,r,i)?(lt.createFromMatrix4x4(r,n),!0):(n.identity(),!1)},t.decomposeTransRotMatScale=function(t,n,i){var r=this.elements,a=t.elements,s=n.elements,o=i.elements;a[0]=r[12],a[1]=r[13],a[2]=r[14];var l=r[0],h=r[1],_=r[2],u=r[4],c=r[5],d=r[6],f=r[8],m=r[9],p=r[10],v=o[0]=Math.sqrt(l*l+h*h+_*_),g=o[1]=Math.sqrt(u*u+c*c+d*d),x=o[2]=Math.sqrt(f*f+m*m+p*p);if(it.isZero(v)||it.isZero(g)||it.isZero(x))return s[1]=s[2]=s[3]=s[4]=s[6]=s[7]=s[8]=s[9]=s[11]=s[12]=s[13]=s[14]=0,s[0]=s[5]=s[10]=s[15]=1,!1;var E=e._tempVector0,S=E.elements;S[0]=f/x,S[1]=m/x,S[2]=p/x;var D=e._tempVector1,T=D.elements;T[0]=l/v,T[1]=h/v,T[2]=_/v;var M=e._tempVector2;ct.cross(E,D,M);var y=e._tempVector1;return ct.cross(M,E,y),s[3]=s[7]=s[11]=s[12]=s[13]=s[14]=0,s[15]=1,s[0]=y.x,s[1]=y.y,s[2]=y.z,s[4]=M.x,s[5]=M.y,s[6]=M.z,s[8]=E.x,s[9]=E.y,s[10]=E.z,s[0]*l+s[1]*h+s[2]*_<0&&(o[0]=-v),s[4]*u+s[5]*c+s[6]*d<0&&(o[1]=-g),s[8]*f+s[9]*m+s[10]*p<0&&(o[2]=-x),!0},t.decomposeYawPitchRoll=function(e){var t=e.elements,n=Math.asin(-this.elements[9]);t[1]=n,Math.cos(n)>it.zeroTolerance?(t[2]=Math.atan2(this.elements[1],this.elements[5]),t[0]=Math.atan2(this.elements[8],this.elements[10])):(t[2]=Math.atan2(-this.elements[4],this.elements[0]),t[0]=0)},t.normalize=function(){var e=this.elements,t=e[0],n=e[1],i=e[2],r=Math.sqrt(t*t+n*n+i*i);if(!r)return e[0]=0,e[1]=0,void(e[2]=0);1!=r&&(r=1/r,e[0]=t*r,e[1]=n*r,e[2]=i*r)},t.transpose=function(){var e,t;return e=this.elements,t=e[1],e[1]=e[4],e[4]=t,t=e[2],e[2]=e[8],e[8]=t,t=e[3],e[3]=e[12],e[12]=t,t=e[6],e[6]=e[9],e[9]=t,t=e[7],e[7]=e[13],e[13]=t,t=e[11],e[11]=e[14],e[14]=t,this},t.invert=function(e){var t=this.elements,n=e.elements,i=t[0],r=t[1],a=t[2],s=t[3],o=t[4],l=t[5],h=t[6],_=t[7],u=t[8],c=t[9],d=t[10],f=t[11],m=t[12],p=t[13],v=t[14],g=t[15],x=i*l-r*o,E=i*h-a*o,S=i*_-s*o,D=r*h-a*l,T=r*_-s*l,M=a*_-s*h,y=u*p-c*m,R=u*v-d*m,A=u*g-f*m,C=c*v-d*p,I=c*g-f*p,w=d*g-f*v,V=x*w-E*I+S*C+D*A-T*R+M*y;0!==Math.abs(V)&&(V=1/V,n[0]=(l*w-h*I+_*C)*V,n[1]=(a*I-r*w-s*C)*V,n[2]=(p*M-v*T+g*D)*V,n[3]=(d*T-c*M-f*D)*V,n[4]=(h*A-o*w-_*R)*V,n[5]=(i*w-a*A+s*R)*V,n[6]=(v*S-m*M-g*E)*V,n[7]=(u*M-d*S+f*E)*V,n[8]=(o*I-l*A+_*y)*V,n[9]=(r*A-i*I-s*y)*V,n[10]=(m*T-p*S+g*x)*V,n[11]=(c*S-u*T-f*x)*V,n[12]=(l*R-o*C-h*y)*V,n[13]=(i*C-r*R+a*y)*V,n[14]=(p*E-m*D-v*x)*V,n[15]=(u*D-c*E+d*x)*V)},t.identity=function(){var e=this.elements;e[1]=e[2]=e[3]=e[4]=e[6]=e[7]=e[8]=e[9]=e[11]=e[12]=e[13]=e[14]=0,e[0]=e[5]=e[10]=e[15]=1},t.cloneTo=function(e){var t,n,i;if(n=this.elements,i=e.elements,n!==i)for(t=0;t<16;++t)i[t]=n[t]},t.clone=function(){var e=new this.constructor;return this.cloneTo(e),e},t.getTranslationVector=function(e){var t=this.elements,n=e.elements;n[0]=t[12],n[1]=t[13],n[2]=t[14]},t.setTranslationVector=function(e){var t=this.elements,n=e.elements;t[12]=n[0],t[13]=n[1],t[14]=n[2]},t.getForward=function(e){var t=this.elements,n=e.elements;n[0]=-t[8],n[1]=-t[9],n[2]=-t[10]},t.setForward=function(e){var t=this.elements,n=e.elements;t[8]=-n[0],t[9]=-n[1],t[10]=-n[2]},e.createRotationX=function(e,t){var n=t.elements,i=Math.sin(e),r=Math.cos(e);n[1]=n[2]=n[3]=n[4]=n[7]=n[8]=n[11]=n[12]=n[13]=n[14]=0,n[0]=n[15]=1,n[5]=n[10]=r,n[6]=i,n[9]=-i},e.createRotationY=function(e,t){var n=t.elements,i=Math.sin(e),r=Math.cos(e);n[1]=n[3]=n[4]=n[6]=n[7]=n[9]=n[11]=n[12]=n[13]=n[14]=0,n[5]=n[15]=1,n[0]=n[10]=r,n[2]=-i,n[8]=i},e.createRotationZ=function(e,t){var n=t.elements,i=Math.sin(e),r=Math.cos(e);n[2]=n[3]=n[6]=n[7]=n[8]=n[9]=n[11]=n[12]=n[13]=n[14]=0,n[10]=n[15]=1,n[0]=n[5]=r,n[1]=i,n[4]=-i},e.createRotationYawPitchRoll=function(t,n,i,r){lt.createFromYawPitchRoll(t,n,i,e._tempQuaternion),e.createRotationQuaternion(e._tempQuaternion,r)},e.createRotationAxis=function(e,t,n){var i=e.elements,r=i[0],a=i[1],s=i[2],o=Math.cos(t),l=Math.sin(t),h=r*r,_=a*a,u=s*s,c=r*a,d=r*s,f=a*s,m=n.elements;m[3]=m[7]=m[11]=m[12]=m[13]=m[14]=0,m[15]=1,m[0]=h+o*(1-h),m[1]=c-o*c+l*s,m[2]=d-o*d-l*a,m[4]=c-o*c-l*s,m[5]=_+o*(1-_),m[6]=f-o*f+l*r,m[8]=d-o*d+l*a,m[9]=f-o*f-l*r,m[10]=u+o*(1-u)},e.createRotationQuaternion=function(e,t){var n=e.elements,i=t.elements,r=n[0],a=n[1],s=n[2],o=n[3],l=r*r,h=a*a,_=s*s,u=r*a,c=s*o,d=s*r,f=a*o,m=a*s,p=r*o;i[3]=i[7]=i[11]=i[12]=i[13]=i[14]=0,i[15]=1,i[0]=1-2*(h+_),i[1]=2*(u+c),i[2]=2*(d-f),i[4]=2*(u-c),i[5]=1-2*(_+l),i[6]=2*(m+p),i[8]=2*(d+f),i[9]=2*(m-p),i[10]=1-2*(h+l)},e.createTranslate=function(e,t){var n=e.elements,i=t.elements;i[4]=i[8]=i[1]=i[9]=i[2]=i[6]=i[3]=i[7]=i[11]=0,i[0]=i[5]=i[10]=i[15]=1,i[12]=n[0],i[13]=n[1],i[14]=n[2]},e.createScaling=function(e,t){var n=e.elements,i=t.elements;i[0]=n[0],i[5]=n[1],i[10]=n[2],i[1]=i[4]=i[8]=i[12]=i[9]=i[13]=i[2]=i[6]=i[14]=i[3]=i[7]=i[11]=0,i[15]=1},e.multiply=function(e,t,n){var i,r,a,s,o,l,h,_;if(r=n.elements,a=e.elements,s=t.elements,r===s)for(s=new Float32Array(16),i=0;i<16;++i)s[i]=r[i];for(i=0;i<4;i++)o=a[i],l=a[i+4],h=a[i+8],_=a[i+12],r[i]=o*s[0]+l*s[1]+h*s[2]+_*s[3],r[i+4]=o*s[4]+l*s[5]+h*s[6]+_*s[7],r[i+8]=o*s[8]+l*s[9]+h*s[10]+_*s[11],r[i+12]=o*s[12]+l*s[13]+h*s[14]+_*s[15]},e.createFromQuaternion=function(e,t){var n=t.elements,i=e.elements,r=i[0],a=i[1],s=i[2],o=i[3],l=r+r,h=a+a,_=s+s,u=r*l,c=a*l,d=a*h,f=s*l,m=s*h,p=s*_,v=o*l,g=o*h,x=o*_;n[0]=1-d-p,n[1]=c+x,n[2]=f-g,n[3]=0,n[4]=c-x,n[5]=1-u-p,n[6]=m+v,n[7]=0,n[8]=f+g,n[9]=m-v,n[10]=1-u-d,n[11]=0,n[12]=0,n[13]=0,n[14]=0,n[15]=1},e.createAffineTransformation=function(e,t,n,i){var r=e.elements,a=t.elements,s=n.elements,o=i.elements,l=a[0],h=a[1],_=a[2],u=a[3],c=l+l,d=h+h,f=_+_,m=l*c,p=l*d,v=l*f,g=h*d,x=h*f,E=_*f,S=u*c,D=u*d,T=u*f,M=s[0],y=s[1],R=s[2];o[0]=(1-(g+E))*M,o[1]=(p+T)*M,o[2]=(v-D)*M,o[3]=0,o[4]=(p-T)*y,o[5]=(1-(m+E))*y,o[6]=(x+S)*y,o[7]=0,o[8]=(v+D)*R,o[9]=(x-S)*R,o[10]=(1-(m+g))*R,o[11]=0,o[12]=r[0],o[13]=r[1],o[14]=r[2],o[15]=1},e.createLookAt=function(t,n,i,r){var a=r.elements,s=e._tempVector0,o=e._tempVector1,l=e._tempVector2;ct.subtract(t,n,l),ct.normalize(l,l),ct.cross(i,l,s),ct.normalize(s,s),ct.cross(l,s,o),r.identity(),a[0]=s.x,a[4]=s.y,a[8]=s.z,a[1]=o.x,a[5]=o.y,a[9]=o.z,a[2]=l.x,a[6]=l.y,a[10]=l.z,a[12]=-ct.dot(s,t),a[13]=-ct.dot(o,t),a[14]=-ct.dot(l,t)},e.createPerspective=function(e,t,n,i,r){var a=r.elements,s=1/Math.tan(e/2),o=1/(n-i);a[0]=s/t,a[5]=s,a[10]=(i+n)*o,a[11]=-1,a[14]=2*i*n*o,a[1]=a[2]=a[3]=a[4]=a[6]=a[7]=a[8]=a[9]=a[12]=a[13]=a[15]=0},e.createOrthoOffCenterRH=function(e,t,n,i,r,a,s){var o=s.elements,l=1/(e-t),h=1/(n-i),_=1/(r-a);o[1]=o[2]=o[3]=o[4]=o[6]=o[7]=o[8]=o[9]=o[11]=0,o[15]=1,o[0]=-2*l,o[5]=-2*h,o[10]=2*_,o[12]=(e+t)*l,o[13]=(i+n)*h,o[14]=(a+r)*_},e.translation=function(e,t){var n=e.elements,i=t.elements;i[0]=i[5]=i[10]=i[15]=1,i[12]=n[0],i[13]=n[1],i[14]=n[2]},i(e,["_tempMatrix4x4",function(){return this._tempMatrix4x4=new e},"_tempVector0",function(){return this._tempVector0=new ct},"_tempVector1",function(){return this._tempVector1=new ct},"_tempVector2",function(){return this._tempVector2=new ct},"_tempQuaternion",function(){return this._tempQuaternion=new lt},"DEFAULT",function(){return this.DEFAULT=new e}]),e}(),st=function(){function e(e,t){this.extents=null,this.transformation=null,this.extents=e,this.transformation=t}r(e,"laya.d3.math.OrientedBoundBox");var t=e.prototype;return t.getCorners=function(t){var n=this.extents.elements;t.length=8;var i=e._tempV30.elements,r=e._tempV31.elements,a=e._tempV32.elements;i[0]=n[0],i[1]=i[2]=0,r[1]=n[1],r[0]=r[2]=0,a[2]=n[2],a[0]=a[1]=0,ct.TransformNormal(e._tempV30,this.transformation,e._tempV30),ct.TransformNormal(e._tempV31,this.transformation,e._tempV31),ct.TransformNormal(e._tempV32,this.transformation,e._tempV32);var s=e._tempV33;this.transformation.getTranslationVector(s),ct.add(s,e._tempV30,e._tempV34),ct.add(e._tempV34,e._tempV31,e._tempV34),ct.add(e._tempV34,e._tempV32,t[0]),ct.add(s,e._tempV30,e._tempV34),ct.add(e._tempV34,e._tempV31,e._tempV34),ct.subtract(e._tempV34,e._tempV32,t[1]),ct.subtract(s,e._tempV30,e._tempV34),ct.add(e._tempV34,e._tempV31,e._tempV34),ct.subtract(e._tempV34,e._tempV32,t[2]),ct.subtract(s,e._tempV30,e._tempV34),ct.add(e._tempV34,e._tempV31,e._tempV34),ct.add(e._tempV34,e._tempV32,t[3]),ct.add(s,e._tempV30,e._tempV34),ct.subtract(e._tempV34,e._tempV31,e._tempV34),ct.add(e._tempV34,e._tempV32,t[4]),ct.add(s,e._tempV30,e._tempV34),ct.subtract(e._tempV34,e._tempV31,e._tempV34),ct.subtract(e._tempV34,e._tempV32,t[5]),ct.subtract(s,e._tempV30,e._tempV34),ct.subtract(e._tempV34,e._tempV31,e._tempV34),ct.subtract(e._tempV34,e._tempV32,t[6]),ct.subtract(s,e._tempV30,e._tempV34),ct.subtract(e._tempV34,e._tempV31,e._tempV34),ct.add(e._tempV34,e._tempV32,t[7])},t.transform=function(e){at.multiply(this.transformation,e,this.transformation)},t.scale=function(e){ct.multiply(this.extents,e,this.extents)},t.translate=function(t){this.transformation.getTranslationVector(e._tempV30),ct.add(e._tempV30,t,e._tempV31),this.transformation.setTranslationVector(e._tempV31)},t.Size=function(e){ct.scale(this.extents,2,e)},t.getSize=function(t){var n=this.extents.elements;e._tempV30.x=n[0],e._tempV31.y=n[1],e._tempV32.z=n[2],ct.TransformNormal(e._tempV30,this.transformation,e._tempV30),ct.TransformNormal(e._tempV31,this.transformation,e._tempV31),ct.TransformNormal(e._tempV31,this.transformation,e._tempV32);var i=t.elements;i[0]=ct.scalarLength(e._tempV30),i[1]=ct.scalarLength(e._tempV31),i[2]=ct.scalarLength(e._tempV32)},t.getSizeSquared=function(t){var n=this.extents.elements;e._tempV30.x=n[0],e._tempV31.y=n[1],e._tempV32.z=n[2],ct.TransformNormal(e._tempV30,this.transformation,e._tempV30),ct.TransformNormal(e._tempV31,this.transformation,e._tempV31),ct.TransformNormal(e._tempV31,this.transformation,e._tempV32);var i=t.elements;i[0]=ct.scalarLengthSquared(e._tempV30),i[1]=ct.scalarLengthSquared(e._tempV31),i[2]=ct.scalarLengthSquared(e._tempV32)},t.getCenter=function(e){this.transformation.getTranslationVector(e)},t.containsPoint=function(t){var n=this.extents.elements,i=n[0],r=n[1],a=n[2];this.transformation.invert(e._tempM0),ct.transformCoordinate(t,e._tempM0,e._tempV30);var s=e._tempV30.elements,o=Math.abs(s[0]),l=Math.abs(s[1]),h=Math.abs(s[2]);return it.nearEqual(o,i)&&it.nearEqual(l,r)&&it.nearEqual(h,a)?2:o<i&&l<r&&h<a?1:0},t.containsPoints=function(t){var n=this.extents.elements,i=n[0],r=n[1],a=n[2];this.transformation.invert(e._tempM0);for(var s=!0,o=!1,l=0;l<t.length;l++){ct.transformCoordinate(t[l],e._tempM0,e._tempV30);var h=e._tempV30.elements,_=Math.abs(h[0]),u=Math.abs(h[1]),c=Math.abs(h[2]);it.nearEqual(_,i)&&it.nearEqual(u,r)&&it.nearEqual(c,a)&&(o=!0),_<i&&u<r&&a<c?o=!0:s=!1}return s?1:o?2:0},t.containsSphere=function(t,n){void 0===n&&(n=!1);var i=this.extents.elements,r=i[0],a=i[1],s=i[2],o=t.radius;this.transformation.invert(e._tempM0),ct.transformCoordinate(t.center,e._tempM0,e._tempV30);var l=NaN;if(n?l=o:(ct.scale(ct.UnitX,o,e._tempV31),ct.TransformNormal(e._tempV31,e._tempM0,e._tempV31),l=ct.scalarLength(e._tempV31)),ct.scale(this.extents,-1,e._tempV32),ct.Clamp(e._tempV30,e._tempV32,this.extents,e._tempV33),ct.distanceSquared(e._tempV30,e._tempV33)>l*l)return 0;var h=e._tempV30.elements,_=h[0],u=h[1],c=h[2],d=e._tempV32.elements,f=d[0],m=d[1],p=d[2];return f+l<=_&&_<=r-l&&r-f>l&&m+l<=u&&u<=a-l&&a-m>l&&p+l<=c&&c<=s-l&&s-p>l?1:2},t.containsOrientedBoundBox=function(t){var n=0,i=0;t.getCorners(e._corners);var r=this.containsPoints(e._corners);if(0!=r)return r;var a=this.extents.elements;t.extents.cloneTo(e._tempV35);var s=e._tempV35.elements;e._getRows(this.transformation,e._rows1),e._getRows(t.transformation,e._rows2);var o=NaN,l=NaN,h=NaN;for(n=0;n<3;n++)for(i=0;i<3;i++)h=ct.dot(e._rows1[n],e._rows2[i]),e._tempM0.setElementByRowColumn(n,i,h),e._tempM1.setElementByRowColumn(n,i,Math.abs(h));t.getCenter(e._tempV34),this.getCenter(e._tempV36),ct.subtract(e._tempV34,e._tempV36,e._tempV30);var _=e._tempV31.elements;_[0]=ct.dot(e._tempV30,e._rows1[0]),_[1]=ct.dot(e._tempV30,e._rows1[1]),_[2]=ct.dot(e._tempV30,e._rows1[2]);var u=e._tempV32.elements,c=e._tempV33.elements;for(n=0;n<3;n++)if(u[0]=e._tempM1.getElementByRowColumn(n,0),u[1]=e._tempM1.getElementByRowColumn(n,1),u[2]=e._tempM1.getElementByRowColumn(n,2),o=a[n],l=ct.dot(e._tempV35,e._tempV32),Math.abs(_[n])>o+l)return 0;for(i=0;i<3;i++)if(u[0]=e._tempM1.getElementByRowColumn(0,i),u[1]=e._tempM1.getElementByRowColumn(1,i),u[2]=e._tempM1.getElementByRowColumn(2,i),c[0]=e._tempM0.getElementByRowColumn(0,i),c[1]=e._tempM0.getElementByRowColumn(1,i),c[2]=e._tempM0.getElementByRowColumn(2,i),o=ct.dot(this.extents,e._tempV32),l=s[i],Math.abs(ct.dot(e._tempV31,e._tempV33))>o+l)return 0;for(n=0;n<3;n++)for(i=0;i<3;i++){var d=(n+1)%3,f=(n+2)%3,m=(i+1)%3,p=(i+2)%3;if(o=a[d]*e._tempM1.getElementByRowColumn(f,i)+s[f]*e._tempM1.getElementByRowColumn(f,i),l=a[m]*e._tempM1.getElementByRowColumn(n,p)+s[p]*e._tempM1.getElementByRowColumn(n,m),Math.abs(_[f]*e._tempM0.getElementByRowColumn(d,i)-_[d]*e._tempM0.getElementByRowColumn(f,i))>o+l)return 0}return 2},t.containsLine=function(t,n){e._corners[0]=t,e._corners[1]=n;var i=this.containsPoints(e._corners);if(0!=i)return i;var r=this.extents.elements,a=r[0],s=r[1],o=r[2];this.transformation.invert(e._tempM0),ct.transformCoordinate(t,e._tempM0,e._tempV30),ct.transformCoordinate(n,e._tempM0,e._tempV31),ct.add(e._tempV30,e._tempV31,e._tempV32),ct.scale(e._tempV32,.5,e._tempV32),ct.subtract(e._tempV30,e._tempV32,e._tempV33);var l=e._tempV33.elements,h=l[0],_=l[1],u=l[2],c=e._tempV34.elements,d=c[0]=Math.abs(l[0]),f=c[1]=Math.abs(l[1]),m=c[2]=Math.abs(l[2]),p=e._tempV32.elements,v=p[0],g=p[1],x=p[2];return Math.abs(v)>a+d?0:Math.abs(g)>s+f?0:Math.abs(x)>o+m?0:Math.abs(g*u-x*_)>s*m+o*f?0:Math.abs(v*u-x*h)>a*m+o*d?0:Math.abs(v*_-g*h)>a*f+s*d?0:2},t.containsBoundBox=function(t){var n=0,i=0,r=t.min,a=t.max;t.getCorners(e._corners);var s=this.containsPoints(e._corners);if(0!=s)return s;ct.subtract(a,r,e._tempV30),ct.scale(e._tempV30,.5,e._tempV30),ct.add(r,e._tempV30,e._tempV30),ct.subtract(a,e._tempV30,e._tempV31);var o=this.extents.elements,l=e._tempV31.elements;e._getRows(this.transformation,e._rows1),this.transformation.invert(e._tempM0);var h=NaN,_=NaN;for(n=0;n<3;n++)for(i=0;i<3;i++)e._tempM1.setElementByRowColumn(n,i,Math.abs(e._tempM0.getElementByRowColumn(n,i)));this.getCenter(e._tempV35),ct.subtract(e._tempV30,e._tempV35,e._tempV32);var u=e._tempV31.elements;u[0]=ct.dot(e._tempV32,e._rows1[0]),u[1]=ct.dot(e._tempV32,e._rows1[1]),u[2]=ct.dot(e._tempV32,e._rows1[2]);var c=e._tempV33.elements,d=e._tempV34.elements;for(n=0;n<3;n++)if(c[0]=e._tempM1.getElementByRowColumn(n,0),c[1]=e._tempM1.getElementByRowColumn(n,1),c[2]=e._tempM1.getElementByRowColumn(n,2),h=o[n],_=ct.dot(e._tempV31,e._tempV33),Math.abs(u[n])>h+_)return 0;for(i=0;i<3;i++)if(c[0]=e._tempM1.getElementByRowColumn(0,i),c[1]=e._tempM1.getElementByRowColumn(1,i),c[2]=e._tempM1.getElementByRowColumn(2,i),d[0]=e._tempM0.getElementByRowColumn(0,i),d[1]=e._tempM0.getElementByRowColumn(1,i),d[2]=e._tempM0.getElementByRowColumn(2,i),h=ct.dot(this.extents,e._tempV33),_=l[i],Math.abs(ct.dot(e._tempV31,e._tempV34))>h+_)return 0;for(n=0;n<3;n++)for(i=0;i<3;i++){var f=(n+1)%3,m=(n+2)%3,p=(i+1)%3,v=(i+2)%3;if(h=o[f]*e._tempM1.getElementByRowColumn(m,i)+o[m]*e._tempM1.getElementByRowColumn(f,i),_=l[p]*e._tempM1.getElementByRowColumn(n,v)+l[v]*e._tempM1.getElementByRowColumn(n,p),Math.abs(u[m]*e._tempM0.getElementByRowColumn(f,i)-u[f]*e._tempM0.getElementByRowColumn(m,i))>h+_)return 0}return 2},t.intersectsRay=function(t,n){ct.scale(this.extents,-1,e._tempV30),this.transformation.invert(e._tempM0),ct.TransformNormal(t.direction,e._tempM0,e._ray.direction),ct.transformCoordinate(t.origin,e._tempM0,e._ray.origin),e._boxBound1.min=e._tempV30,e._boxBound1.max=this.extents;var i=nt.intersectsRayAndBoxRP(e._ray,e._boxBound1,n);return-1!==i&&ct.transformCoordinate(n,this.transformation,n),i},t._getLocalCorners=function(t){t.length=8;var n=this.extents.elements;e._tempV30.x=n[0],e._tempV31.y=n[1],e._tempV32.z=n[2],ct.add(e._tempV30,e._tempV31,e._tempV33),ct.add(e._tempV33,e._tempV32,t[0]),ct.add(e._tempV30,e._tempV31,e._tempV33),ct.subtract(e._tempV33,e._tempV32,t[1]),ct.subtract(e._tempV31,e._tempV30,e._tempV33),ct.subtract(e._tempV33,e._tempV30,t[2]),ct.subtract(e._tempV31,e._tempV30,e._tempV33),ct.add(e._tempV33,e._tempV32,t[3]),ct.subtract(e._tempV30,e._tempV31,e._tempV33),ct.add(e._tempV33,e._tempV32,t[4]),ct.subtract(e._tempV30,e._tempV31,e._tempV33),ct.subtract(e._tempV33,e._tempV32,t[5]),ct.scale(t[0],-1,t[6]),ct.subtract(e._tempV32,e._tempV30,e._tempV33),ct.subtract(e._tempV33,e._tempV31,t[7])},t.equals=function(e){return this.extents==e.extents&&this.transformation==e.transformation},t.cloneTo=function(e){var t=e;this.extents.cloneTo(t.extents),this.transformation.cloneTo(t.transformation)},e.createByBoundBox=function(t,n){var i=t.min,r=t.max;ct.subtract(r,i,e._tempV30),ct.scale(e._tempV30,.5,e._tempV30),ct.add(i,e._tempV30,e._tempV31),ct.subtract(r,e._tempV31,e._tempV32),at.translation(e._tempV31,e._tempM0);var a=e._tempV32.clone(),s=e._tempM0.clone();n.extents=a,n.transformation=s},e.createByMinAndMaxVertex=function(t,n){return ct.subtract(n,t,e._tempV30),ct.scale(e._tempV30,.5,e._tempV30),ct.add(t,e._tempV30,e._tempV31),ct.subtract(n,e._tempV31,e._tempV32),at.translation(e._tempV31,e._tempM0),new e(e._tempV32,e._tempM0)},e._getRows=function(e,t){t.length=3;var n=e.elements,i=t[0].elements;i[0]=n[0],i[1]=n[1],i[2]=n[2];var r=t[1].elements;r[0]=n[4],r[1]=n[5],r[2]=n[6];var a=t[2].elements;a[0]=n[8],a[1]=n[9],a[2]=n[10]},e.getObbtoObbMatrix4x4=function(t,n,i,r){var a=t.transformation,s=n.transformation;if(i){e._getRows(a,e._rows1),e._getRows(s,e._rows2);for(var o=0;o<3;o++)for(var l=0;l<3;l++)r.setElementByRowColumn(o,l,ct.dot(e._rows2[o],e._rows1[l]));n.getCenter(e._tempV30),t.getCenter(e._tempV31),ct.subtract(e._tempV30,e._tempV31,e._tempV32);var h=r.elements;h[12]=ct.dot(e._tempV32,e._rows1[0]),h[13]=ct.dot(e._tempV32,e._rows1[1]),h[14]=ct.dot(e._tempV32,e._rows1[2]),h[15]=1}else a.invert(e._tempM0),at.multiply(s,e._tempM0,r)},e.merge=function(t,n,i){var r=t.extents,a=t.transformation;e.getObbtoObbMatrix4x4(t,n,i,e._tempM0),n._getLocalCorners(e._corners),ct.transformCoordinate(e._corners[0],e._tempM0,e._corners[0]),ct.transformCoordinate(e._corners[1],e._tempM0,e._corners[1]),ct.transformCoordinate(e._corners[2],e._tempM0,e._corners[2]),ct.transformCoordinate(e._corners[3],e._tempM0,e._corners[3]),ct.transformCoordinate(e._corners[4],e._tempM0,e._corners[4]),ct.transformCoordinate(e._corners[5],e._tempM0,e._corners[5]),ct.transformCoordinate(e._corners[6],e._tempM0,e._corners[6]),ct.transformCoordinate(e._corners[7],e._tempM0,e._corners[7]),ct.scale(r,-1,e._boxBound1.min),r.cloneTo(e._boxBound1.max),Je.createfromPoints(e._corners,e._boxBound2),Je.merge(e._boxBound2,e._boxBound1,e._boxBound3);var s=e._boxBound3.min,o=e._boxBound3.max;ct.subtract(o,s,e._tempV30),ct.scale(e._tempV30,.5,e._tempV30),ct.add(s,e._tempV30,e._tempV32),ct.subtract(o,e._tempV32,r),ct.transformCoordinate(e._tempV32,a,e._tempV33)},e._corners=[],e._rows1=[],e._rows2=[],i(e,["_tempV30",function(){return this._tempV30=new ct},"_tempV31",function(){return this._tempV31=new ct},"_tempV32",function(){return this._tempV32=new ct},"_tempV33",function(){return this._tempV33=new ct},"_tempV34",function(){return this._tempV34=new ct},"_tempV35",function(){return this._tempV35=new ct},"_tempV36",function(){return this._tempV36=new ct},"_tempM0",function(){return this._tempM0=new at},"_tempM1",function(){return this._tempM1=new at},"_ray",function(){return this._ray=new _t(new ct,new ct)},"_boxBound1",function(){return this._boxBound1=new Je(new ct,new ct)},"_boxBound2",function(){return this._boxBound2=new Je(new ct,new ct)},"_boxBound3",function(){return this._boxBound3=new Je(new ct,new ct)}]),e}(),ot=function(){function e(e,t){this.normal=null,this.distance=NaN,void 0===t&&(t=0),this.normal=e,this.distance=t}return r(e,"laya.d3.math.Plane"),e.prototype.normalize=function(){var e=this.normal.elements,t=e[0],n=e[1],i=e[2],r=1/Math.sqrt(t*t+n*n+i*i);e[0]=t*r,e[1]=n*r,e[2]=i*r,this.distance*=r},e.createPlaneBy3P=function(t,n,i){var r=t.elements,a=n.elements,s=i.elements,o=a[0]-r[0],l=a[1]-r[1],h=a[2]-r[2],_=s[0]-r[0],u=s[1]-r[1],c=s[2]-r[2],d=l*c-h*u,f=h*_-o*c,m=o*u-l*_,p=1/Math.sqrt(d*d+f*f+m*m),v=d*p,g=f*p,x=m*p,E=e._TEMPVec3.elements;E[0]=v,E[1]=g,E[2]=x;var S=-(v*r[0]+g*r[1]+x*r[2]);return new e(e._TEMPVec3,S)},e.PlaneIntersectionType_Back=0,e.PlaneIntersectionType_Front=1,e.PlaneIntersectionType_Intersecting=2,i(e,["_TEMPVec3",function(){return this._TEMPVec3=new ct}]),e}(),lt=function(){function e(e,t,n,i){this.elements=new Float32Array(4),void 0===e&&(e=0),void 0===t&&(t=0),void 0===n&&(n=0),void 0===i&&(i=1),this.elements[0]=e,this.elements[1]=t,this.elements[2]=n,this.elements[3]=i}r(e,"laya.d3.math.Quaternion");var t=e.prototype;return n.imps(t,{"laya.d3.core.IClone":!0}),t.scaling=function(e,t){var n=t.elements,i=this.elements;n[0]=i[0]*e,n[1]=i[1]*e,n[2]=i[2]*e,n[3]=i[3]*e},t.normalize=function(e){var t=e.elements,n=this.elements,i=n[0],r=n[1],a=n[2],s=n[3],o=i*i+r*r+a*a+s*s;o>0&&(o=1/Math.sqrt(o),t[0]=i*o,t[1]=r*o,t[2]=a*o,t[3]=s*o)},t.length=function(){var e=this.elements,t=e[0],n=e[1],i=e[2],r=e[3];return Math.sqrt(t*t+n*n+i*i+r*r)},t.rotateX=function(e,t){var n=t.elements,i=this.elements;e*=.5;var r=i[0],a=i[1],s=i[2],o=i[3],l=Math.sin(e),h=Math.cos(e);n[0]=r*h+o*l,n[1]=a*h+s*l,n[2]=s*h-a*l,n[3]=o*h-r*l},t.rotateY=function(e,t){var n=t.elements,i=this.elements;e*=.5;var r=i[0],a=i[1],s=i[2],o=i[3],l=Math.sin(e),h=Math.cos(e);n[0]=r*h-s*l,n[1]=a*h+o*l,n[2]=s*h+r*l,n[3]=o*h-a*l},t.rotateZ=function(e,t){var n=t.elements,i=this.elements;e*=.5;var r=i[0],a=i[1],s=i[2],o=i[3],l=Math.sin(e),h=Math.cos(e);n[0]=r*h+a*l,n[1]=a*h-r*l,n[2]=s*h+o*l,n[3]=o*h-s*l},t.getYawPitchRoll=function(t){ct.transformQuat(ct.ForwardRH,this,e.TEMPVector31),ct.transformQuat(ct.Up,this,e.TEMPVector32);var n=e.TEMPVector32.elements;e.angleTo(ct.ZERO,e.TEMPVector31,e.TEMPVector33);var i=e.TEMPVector33.elements;i[0]==Math.PI/2?(i[1]=e.arcTanAngle(n[2],n[0]),i[2]=0):i[0]==-Math.PI/2?(i[1]=e.arcTanAngle(-n[2],-n[0]),i[2]=0):(at.createRotationY(-i[1],e.TEMPMatrix0),at.createRotationX(-i[0],e.TEMPMatrix1),ct.transformCoordinate(e.TEMPVector32,e.TEMPMatrix0,e.TEMPVector32),ct.transformCoordinate(e.TEMPVector32,e.TEMPMatrix1,e.TEMPVector32),i[2]=e.arcTanAngle(n[1],-n[0])),i[1]<=-Math.PI&&(i[1]=Math.PI),i[2]<=-Math.PI&&(i[2]=Math.PI),i[1]>=Math.PI&&i[2]>=Math.PI&&(i[1]=0,i[2]=0,i[0]=Math.PI-i[0]);var r=t.elements;r[0]=i[1],r[1]=i[0],r[2]=i[2]},t.invert=function(e){var t=e.elements,n=this.elements,i=n[0],r=n[1],a=n[2],s=n[3],o=i*i+r*r+a*a+s*s,l=o?1/o:0;t[0]=-i*l,t[1]=-r*l,t[2]=-a*l,t[3]=s*l},t.identity=function(){var e=this.elements;e[0]=0,e[1]=0,e[2]=0,e[3]=1},t.cloneTo=function(e){var t,n,i;if(n=this.elements,i=e.elements,n!==i)for(t=0;t<4;++t)i[t]=n[t]},t.clone=function(){var e=new this.constructor;return this.cloneTo(e),e},t.equals=function(e){var t=this.elements,n=e.elements;return it.nearEqual(t[0],n[0])&&it.nearEqual(t[1],n[1])&&it.nearEqual(t[2],n[2])&&it.nearEqual(t[3],n[3])},t.lengthSquared=function(){var e=this.elements[0],t=this.elements[1],n=this.elements[2],i=this.elements[3];return e*e+t*t+n*n+i*i},a(0,t,"x",function(){return this.elements[0]}),a(0,t,"y",function(){return this.elements[1]}),a(0,t,"z",function(){return this.elements[2]}),a(0,t,"w",function(){return this.elements[3]}),e.createFromYawPitchRoll=function(e,t,n,i){var r=.5*n,a=.5*t,s=.5*e,o=Math.sin(r),l=Math.cos(r),h=Math.sin(a),_=Math.cos(a),u=Math.sin(s),c=Math.cos(s),d=i.elements;d[0]=c*h*l+u*_*o,d[1]=u*_*l-c*h*o,d[2]=c*_*o-u*h*l,d[3]=c*_*l+u*h*o},e.multiply=function(e,t,n){var i=e.elements,r=t.elements,a=n.elements,s=i[0],o=i[1],l=i[2],h=i[3],_=r[0],u=r[1],c=r[2],d=r[3],f=o*c-l*u,m=l*_-s*c,p=s*u-o*_,v=s*_+o*u+l*c;a[0]=s*d+_*h+f,a[1]=o*d+u*h+m,a[2]=l*d+c*h+p,a[3]=h*d-v},e.arcTanAngle=function(e,t){return 0==e?1==t?Math.PI/2:-Math.PI/2:e>0?Math.atan(t/e):e<0?t>0?Math.atan(t/e)+Math.PI:Math.atan(t/e)-Math.PI:0},e.angleTo=function(t,n,i){ct.subtract(n,t,e.TEMPVector30),ct.normalize(e.TEMPVector30,e.TEMPVector30),i.elements[0]=Math.asin(e.TEMPVector30.y),i.elements[1]=e.arcTanAngle(-e.TEMPVector30.z,-e.TEMPVector30.x)},e.createFromAxisAngle=function(e,t,n){var i=n.elements,r=e.elements;t*=.5;var a=Math.sin(t);i[0]=a*r[0],i[1]=a*r[1],i[2]=a*r[2],i[3]=Math.cos(t)},e.createFromMatrix3x3=function(e,t){var n,i=t.elements,r=e.elements,a=r[0]+r[4]+r[8];if(a>0)n=Math.sqrt(a+1),i[3]=.5*n,n=.5/n,i[0]=(r[5]-r[7])*n,i[1]=(r[6]-r[2])*n,i[2]=(r[1]-r[3])*n;else{var s=0;r[4]>r[0]&&(s=1),r[8]>r[3*s+s]&&(s=2);var o=(s+1)%3,l=(s+2)%3;n=Math.sqrt(r[3*s+s]-r[3*o+o]-r[3*l+l]+1),i[s]=.5*n,n=.5/n,i[3]=(r[3*o+l]-r[3*l+o])*n,i[o]=(r[3*o+s]+r[3*s+o])*n,i[l]=(r[3*l+s]+r[3*s+l])*n}},e.createFromMatrix4x4=function(e,t){var n,i,r=e.elements,a=t.elements,s=r[0]+r[5]+r[10];s>0?(n=Math.sqrt(s+1),a[3]=.5*n,n=.5/n,a[0]=(r[6]-r[9])*n,a[1]=(r[8]-r[2])*n,a[2]=(r[1]-r[4])*n):r[0]>=r[5]&&r[0]>=r[10]?(i=.5/(n=Math.sqrt(1+r[0]-r[5]-r[10])),a[0]=.5*n,a[1]=(r[1]+r[4])*i,a[2]=(r[2]+r[8])*i,a[3]=(r[6]-r[9])*i):r[5]>r[10]?(i=.5/(n=Math.sqrt(1+r[5]-r[0]-r[10])),a[0]=(r[4]+r[1])*i,a[1]=.5*n,a[2]=(r[9]+r[6])*i,a[3]=(r[8]-r[2])*i):(i=.5/(n=Math.sqrt(1+r[10]-r[0]-r[5])),a[0]=(r[8]+r[2])*i,a[1]=(r[9]+r[6])*i,a[2]=.5*n,a[3]=(r[1]-r[4])*i)},e.slerp=function(e,t,n,i){var r,a,s,o,l,h=e.elements,_=t.elements,u=i.elements,c=h[0],d=h[1],f=h[2],m=h[3],p=_[0],v=_[1],g=_[2],x=_[3];return(a=c*p+d*v+f*g+m*x)<0&&(a=-a,p=-p,v=-v,g=-g,x=-x),1-a>1e-6?(r=Math.acos(a),s=Math.sin(r),o=Math.sin((1-n)*r)/s,l=Math.sin(n*r)/s):(o=1-n,l=n),u[0]=o*c+l*p,u[1]=o*d+l*v,u[2]=o*f+l*g,u[3]=o*m+l*x,u},e.lerp=function(e,t,n,i){var r=i.elements,a=e.elements,s=t.elements,o=a[0],l=a[1],h=a[2],_=a[3];r[0]=o+n*(s[0]-o),r[1]=l+n*(s[1]-l),r[2]=h+n*(s[2]-h),r[3]=_+n*(s[3]-_)},e.add=function(e,t,n){var i=n.elements,r=e.elements,a=t.elements;i[0]=r[0]+a[0],i[1]=r[1]+a[1],i[2]=r[2]+a[2],i[3]=r[3]+a[3]},e.dot=function(e,t){var n=e.elements,i=t.elements;return n[0]*i[0]+n[1]*i[1]+n[2]*i[2]+n[3]*i[3]},e.rotationLookAt=function(t,n,i){e.lookAt(ct.ZERO,t,n,i)},e.lookAt=function(t,n,i,r){rt.lookAt(t,n,i,e._tempMatrix3x3),e.rotationMatrix(e._tempMatrix3x3,r)},e.invert=function(e,t){var n=e.elements,i=t.elements,r=e.lengthSquared();it.isZero(r)||(r=1/r,i[0]=-n[0]*r,i[1]=-n[1]*r,i[2]=-n[2]*r,i[3]=n[3]*r)},e.rotationMatrix=function(e,t){var n=e.elements,i=n[0],r=n[1],a=n[2],s=n[3],o=n[4],l=n[5],h=n[6],_=n[7],u=n[8],c=t.elements,d=NaN,f=NaN,m=i+o+u;m>0?(d=Math.sqrt(m+1),c[3]=.5*d,d=.5/d,c[0]=(l-_)*d,c[1]=(h-a)*d,c[2]=(r-s)*d):i>=o&&i>=u?(f=.5/(d=Math.sqrt(1+i-o-u)),c[0]=.5*d,c[1]=(r+s)*f,c[2]=(a+h)*f,c[3]=(l-_)*f):o>u?(f=.5/(d=Math.sqrt(1+o-i-u)),c[0]=(s+r)*f,c[1]=.5*d,c[2]=(_+l)*f,c[3]=(h-a)*f):(f=.5/(d=Math.sqrt(1+u-i-o)),c[0]=(h+a)*f,c[1]=(_+l)*f,c[2]=.5*d,c[3]=(r-s)*f)},e.DEFAULT=new e,i(e,["TEMPVector30",function(){return this.TEMPVector30=new ct},"TEMPVector31",function(){return this.TEMPVector31=new ct},"TEMPVector32",function(){return this.TEMPVector32=new ct},"TEMPVector33",function(){return this.TEMPVector33=new ct},"TEMPMatrix0",function(){return this.TEMPMatrix0=new at},"TEMPMatrix1",function(){return this.TEMPMatrix1=new at},"_tempMatrix3x3",function(){return this._tempMatrix3x3=new rt}]),e}(),ht=function(){function e(e){this._temp=new Uint32Array(1),this.seeds=new Uint32Array(4),this.seeds[0]=e,this.seeds[1]=1812433253*this.seeds[0]+1,this.seeds[2]=1812433253*this.seeds[1]+1,this.seeds[3]=1812433253*this.seeds[2]+1}r(e,"laya.d3.math.Rand");var t=e.prototype;return t.getUint=function(){return this._temp[0]=this.seeds[0]^this.seeds[0]<<11,this.seeds[0]=this.seeds[1],this.seeds[1]=this.seeds[2],this.seeds[2]=this.seeds[3],this.seeds[3]=this.seeds[3]^this.seeds[3]>>>19^this._temp[0]^this._temp[0]>>>8,this.seeds[3]},t.getFloat=function(){return this.getUint(),(8388607&this.seeds[3])*(1/8388607)},t.getSignedFloat=function(){return 2*this.getFloat()-1},a(0,t,"seed",function(){return this.seeds[0]},function(e){this.seeds[0]=e,this.seeds[1]=1812433253*this.seeds[0]+1,this.seeds[2]=1812433253*this.seeds[1]+1,this.seeds[3]=1812433253*this.seeds[2]+1}),e.getFloatFromInt=function(e){return 1/8388607*(8388607&e)},e.getByteFromInt=function(e){return(8388607&e)>>>15},e}(),_t=(function(){function e(e){if(this._state0U=NaN,this._state0L=NaN,this._state1U=NaN,this._state1L=NaN,!(e instanceof Array)||4!==e.length)throw new Error("Rand:Seed must be an array with 4 numbers");this._state0U=0|e[0],this._state0L=0|e[1],this._state1U=0|e[2],this._state1L=0|e[3]}r(e,"laya.d3.math.RandX");var t=e.prototype;t.randomint=function(){var e=this._state0U,t=this._state0L,n=this._state1U,i=this._state1L,r=(i>>>0)+(t>>>0),a=n+e+(r/2>>>31)>>>0,s=r>>>0;this._state0U=n,this._state0L=i;var o=0,l=0,h=0,_=0;o=(e^=o=e<<23|(-512&t)>>>9)^n,l=(t^=l=t<<23)^i;o^=h=e>>>18,l^=_=t>>>18|(262143&e)<<14;return h=n>>>5,_=i>>>5|(31&n)<<27,o^=h,l^=_,this._state1U=o,this._state1L=l,[a,s]},t.random=function(){var t=this.randomint(),n=t[0],i=1023<<20|n>>>12,r=0|(t[1]>>>12|(4095&n)<<20);return e._CONVERTION_BUFFER.setUint32(0,i,!1),e._CONVERTION_BUFFER.setUint32(4,r,!1),ht._CONVERTION_BUFFER.getFloat64(0,!1)-1},i(e,["_CONVERTION_BUFFER",function(){return this._CONVERTION_BUFFER=new DataView(new ArrayBuffer(8))},"defaultRand",function(){return this.defaultRand=new ht([0,Date.now()/65536,0,Date.now()%65536])}])}(),function(){function e(e,t){this.origin=null,this.direction=null,this.origin=e,this.direction=t}return r(e,"laya.d3.math.Ray"),e}()),ut=function(){function e(e,t){this.elements=new Float32Array(2),void 0===e&&(e=0),void 0===t&&(t=0);var n=this.elements;n[0]=e,n[1]=t}r(e,"laya.d3.math.Vector2");var t=e.prototype;return n.imps(t,{"laya.d3.core.IClone":!0}),t.cloneTo=function(e){var t=e.elements,n=this.elements;t[0]=n[0],t[1]=n[1]},t.clone=function(){var e=new this.constructor;return this.cloneTo(e),e},a(0,t,"x",function(){return this.elements[0]},function(e){this.elements[0]=e}),a(0,t,"y",function(){return this.elements[1]},function(e){this.elements[1]=e}),e.scale=function(e,t,n){var i=n.elements,r=e.elements;i[0]=r[0]*t,i[1]=r[1]*t},i(e,["ZERO",function(){return this.ZERO=new e(0,0)},"ONE",function(){return this.ONE=new e(1,1)}]),e}(),ct=function(){function e(e,t,n){this.elements=new Float32Array(3),void 0===e&&(e=0),void 0===t&&(t=0),void 0===n&&(n=0);var i=this.elements;i[0]=e,i[1]=t,i[2]=n}r(e,"laya.d3.math.Vector3");var t=e.prototype;return n.imps(t,{"laya.d3.core.IClone":!0}),t.cloneTo=function(e){var t=e.elements,n=this.elements;t[0]=n[0],t[1]=n[1],t[2]=n[2]},t.clone=function(){var e=new this.constructor;return this.cloneTo(e),e},t.toDefault=function(){this.elements[0]=0,this.elements[1]=0,this.elements[2]=0},a(0,t,"x",function(){return this.elements[0]},function(e){this.elements[0]=e}),a(0,t,"y",function(){return this.elements[1]},function(e){this.elements[1]=e}),a(0,t,"z",function(){return this.elements[2]},function(e){this.elements[2]=e}),e.distanceSquared=function(e,t){var n=e.elements,i=t.elements,r=n[0]-i[0],a=n[1]-i[1],s=n[2]-i[2];return r*r+a*a+s*s},e.distance=function(e,t){var n=e.elements,i=t.elements,r=n[0]-i[0],a=n[1]-i[1],s=n[2]-i[2];return Math.sqrt(r*r+a*a+s*s)},e.min=function(e,t,n){var i=n.elements,r=e.elements,a=t.elements;i[0]=Math.min(r[0],a[0]),i[1]=Math.min(r[1],a[1]),i[2]=Math.min(r[2],a[2])},e.max=function(e,t,n){var i=n.elements,r=e.elements,a=t.elements;i[0]=Math.max(r[0],a[0]),i[1]=Math.max(r[1],a[1]),i[2]=Math.max(r[2],a[2])},e.transformQuat=function(e,t,n){var i=n.elements,r=e.elements,a=t.elements,s=r[0],o=r[1],l=r[2],h=a[0],_=a[1],u=a[2],c=a[3],d=c*s+_*l-u*o,f=c*o+u*s-h*l,m=c*l+h*o-_*s,p=-h*s-_*o-u*l;i[0]=d*c+p*-h+f*-u-m*-_,i[1]=f*c+p*-_+m*-h-d*-u,i[2]=m*c+p*-u+d*-_-f*-h},e.scalarLength=function(e){var t=e.elements,n=t[0],i=t[1],r=t[2];return Math.sqrt(n*n+i*i+r*r)},e.scalarLengthSquared=function(e){var t=e.elements,n=t[0],i=t[1],r=t[2];return n*n+i*i+r*r},e.normalize=function(e,t){var n=e.elements,i=t.elements,r=n[0],a=n[1],s=n[2],o=r*r+a*a+s*s;o>0&&(o=1/Math.sqrt(o),i[0]=n[0]*o,i[1]=n[1]*o,i[2]=n[2]*o)},e.multiply=function(e,t,n){var i=n.elements,r=e.elements,a=t.elements;i[0]=r[0]*a[0],i[1]=r[1]*a[1],i[2]=r[2]*a[2]},e.scale=function(e,t,n){var i=n.elements,r=e.elements;i[0]=r[0]*t,i[1]=r[1]*t,i[2]=r[2]*t},e.lerp=function(e,t,n,i){var r=i.elements,a=e.elements,s=t.elements,o=a[0],l=a[1],h=a[2];r[0]=o+n*(s[0]-o),r[1]=l+n*(s[1]-l),r[2]=h+n*(s[2]-h)},e.transformV3ToV3=function(t,n,i){var r=e._tempVector4;e.transformV3ToV4(t,n,r);var a=r.elements,s=i.elements;s[0]=a[0],s[1]=a[1],s[2]=a[2]},e.transformV3ToV4=function(e,t,n){var i=e.elements,r=i[0],a=i[1],s=i[2],o=t.elements,l=n.elements;l[0]=r*o[0]+a*o[4]+s*o[8]+o[12],l[1]=r*o[1]+a*o[5]+s*o[9]+o[13],l[2]=r*o[2]+a*o[6]+s*o[10]+o[14],l[3]=r*o[3]+a*o[7]+s*o[11]+o[15]},e.TransformNormal=function(e,t,n){var i=e.elements,r=i[0],a=i[1],s=i[2],o=t.elements,l=n.elements;l[0]=r*o[0]+a*o[4]+s*o[8],l[1]=r*o[1]+a*o[5]+s*o[9],l[2]=r*o[2]+a*o[6]+s*o[10]},e.transformCoordinate=function(t,n,i){var r=e.TEMPVec4.elements,a=t.elements,s=a[0],o=a[1],l=a[2],h=n.elements;r[0]=s*h[0]+o*h[4]+l*h[8]+h[12],r[1]=s*h[1]+o*h[5]+l*h[9]+h[13],r[2]=s*h[2]+o*h[6]+l*h[10]+h[14],r[3]=1/(s*h[3]+o*h[7]+l*h[11]+h[15]);var _=i.elements;_[0]=r[0]*r[3],_[1]=r[1]*r[3],_[2]=r[2]*r[3]},e.Clamp=function(e,t,n,i){var r=e.elements,a=r[0],s=r[1],o=r[2],l=t.elements,h=l[0],_=l[1],u=l[2],c=n.elements,d=c[0],f=c[1],m=c[2],p=i.elements;a=(a=a>d?d:a)<h?h:a,s=(s=s>f?f:s)<_?_:s,o=(o=o>m?m:o)<u?u:o,p[0]=a,p[1]=s,p[2]=o},e.add=function(e,t,n){var i=n.elements,r=e.elements,a=t.elements;i[0]=r[0]+a[0],i[1]=r[1]+a[1],i[2]=r[2]+a[2]},e.subtract=function(e,t,n){var i=n.elements,r=e.elements,a=t.elements;i[0]=r[0]-a[0],i[1]=r[1]-a[1],i[2]=r[2]-a[2]},e.cross=function(e,t,n){var i=e.elements,r=t.elements,a=n.elements,s=i[0],o=i[1],l=i[2],h=r[0],_=r[1],u=r[2];a[0]=o*u-l*_,a[1]=l*h-s*u,a[2]=s*_-o*h},e.dot=function(e,t){var n=e.elements,i=t.elements;return n[0]*i[0]+n[1]*i[1]+n[2]*i[2]},e.equals=function(e,t){var n=e.elements,i=t.elements;return it.nearEqual(Math.abs(n[0]),Math.abs(i[0]))&&it.nearEqual(Math.abs(n[1]),Math.abs(i[1]))&&it.nearEqual(Math.abs(n[2]),Math.abs(i[2]))},i(e,["_tempVector4",function(){return this._tempVector4=new dt},"ZERO",function(){return this.ZERO=new e(0,0,0)},"ONE",function(){return this.ONE=new e(1,1,1)},"NegativeUnitX",function(){return this.NegativeUnitX=new e(-1,0,0)},"UnitX",function(){return this.UnitX=new e(1,0,0)},"UnitY",function(){return this.UnitY=new e(0,1,0)},"UnitZ",function(){return this.UnitZ=new e(0,0,1)},"ForwardRH",function(){return this.ForwardRH=new e(0,0,-1)},"ForwardLH",function(){return this.ForwardLH=new e(0,0,1)},"Up",function(){return this.Up=new e(0,1,0)},"TEMPVec4",function(){return this.TEMPVec4=new dt}]),e}(),dt=function(){function e(e,t,n,i){this.elements=new Float32Array(4),void 0===e&&(e=0),void 0===t&&(t=0),void 0===n&&(n=0),void 0===i&&(i=0);var r=this.elements;r[0]=e,r[1]=t,r[2]=n,r[3]=i}r(e,"laya.d3.math.Vector4");var t=e.prototype;return n.imps(t,{"laya.d3.core.IClone":!0}),t.cloneTo=function(e){var t=e.elements,n=this.elements;t[0]=n[0],t[1]=n[1],t[2]=n[2],t[3]=n[3]},t.clone=function(){var e=new this.constructor;return this.cloneTo(e),e},t.length=function(){return Math.sqrt(this.x*this.x+this.y*this.y+this.z*this.z+this.w*this.w)},t.lengthSquared=function(){return this.x*this.x+this.y*this.y+this.z*this.z+this.w*this.w},a(0,t,"x",function(){return this.elements[0]},function(e){this.elements[0]=e}),a(0,t,"y",function(){return this.elements[1]},function(e){this.elements[1]=e}),a(0,t,"z",function(){return this.elements[2]},function(e){this.elements[2]=e}),a(0,t,"w",function(){return this.elements[3]},function(e){this.elements[3]=e}),e.lerp=function(e,t,n,i){var r=i.elements,a=e.elements,s=t.elements,o=a[0],l=a[1],h=a[2],_=a[3];r[0]=o+n*(s[0]-o),r[1]=l+n*(s[1]-l),r[2]=h+n*(s[2]-h),r[3]=_+n*(s[3]-_)},e.transformByM4x4=function(e,t,n){var i=e.elements,r=i[0],a=i[1],s=i[2],o=i[3],l=t.elements,h=n.elements;h[0]=r*l[0]+a*l[4]+s*l[8]+o*l[12],h[1]=r*l[1]+a*l[5]+s*l[9]+o*l[13],h[2]=r*l[2]+a*l[6]+s*l[10]+o*l[14],h[3]=r*l[3]+a*l[7]+s*l[11]+o*l[15]},e.equals=function(e,t){var n=e.elements,i=t.elements;return it.nearEqual(Math.abs(n[0]),Math.abs(i[0]))&&it.nearEqual(Math.abs(n[1]),Math.abs(i[1]))&&it.nearEqual(Math.abs(n[2]),Math.abs(i[2]))&&it.nearEqual(Math.abs(n[3]),Math.abs(i[3]))},e.normalize=function(e,t){var n=e.elements,i=t.elements,r=e.length();r>0&&(i[0]=n[0]*r,i[1]=n[1]*r,i[2]=n[2]*r,i[3]=n[3]*r)},e.add=function(e,t,n){var i=n.elements,r=e.elements,a=t.elements;i[0]=r[0]+a[0],i[1]=r[1]+a[1],i[2]=r[2]+a[2],i[3]=r[3]+a[3]},e.subtract=function(e,t,n){var i=n.elements,r=e.elements,a=t.elements;i[0]=r[0]-a[0],i[1]=r[1]-a[1],i[2]=r[2]-a[2],i[3]=r[3]-a[3]},e.multiply=function(e,t,n){var i=n.elements,r=e.elements,a=t.elements;i[0]=r[0]*a[0],i[1]=r[1]*a[1],i[2]=r[2]*a[2],i[3]=r[3]*a[3]},e.scale=function(e,t,n){var i=n.elements,r=e.elements;i[0]=r[0]*t,i[1]=r[1]*t,i[2]=r[2]*t,i[3]=r[3]*t},e.Clamp=function(e,t,n,i){var r=e.elements,a=r[0],s=r[1],o=r[2],l=r[3],h=t.elements,_=h[0],u=h[1],c=h[2],d=h[3],f=n.elements,m=f[0],p=f[1],v=f[2],g=f[3],x=i.elements;a=(a=a>m?m:a)<_?_:a,s=(s=s>p?p:s)<u?u:s,o=(o=o>v?v:o)<c?c:o,l=(l=l>g?g:l)<d?d:l,x[0]=a,x[1]=s,x[2]=o,x[3]=l},e.distanceSquared=function(e,t){var n=e.elements,i=t.elements,r=n[0]-i[0],a=n[1]-i[1],s=n[2]-i[2],o=n[3]-i[3];return r*r+a*a+s*s+o*o},e.distance=function(e,t){var n=e.elements,i=t.elements,r=n[0]-i[0],a=n[1]-i[1],s=n[2]-i[2],o=n[3]-i[3];return Math.sqrt(r*r+a*a+s*s+o*o)},e.dot=function(e,t){var n=e.elements,i=t.elements;return n[0]*i[0]+n[1]*i[1]+n[2]*i[2]+n[3]*i[3]},e.min=function(e,t,n){var i=n.elements,r=e.elements,a=t.elements;i[0]=Math.min(r[0],a[0]),i[1]=Math.min(r[1],a[1]),i[2]=Math.min(r[2],a[2]),i[3]=Math.min(r[3],a[3])},e.max=function(e,t,n){var i=n.elements,r=e.elements,a=t.elements;i[0]=Math.max(r[0],a[0]),i[1]=Math.max(r[1],a[1]),i[2]=Math.max(r[2],a[2]),i[3]=Math.max(r[3],a[3])},i(e,["ZERO",function(){return this.ZERO=new e},"ONE",function(){return this.ONE=new e(1,1,1,1)},"UnitX",function(){return this.UnitX=new e(1,0,0,0)},"UnitY",function(){return this.UnitY=new e(0,1,0,0)},"UnitZ",function(){return this.UnitZ=new e(0,0,1,0)},"UnitW",function(){return this.UnitW=new e(0,0,0,1)}]),e}(),ft=function(){function e(e,t,n,i){this.minDepth=0,this.maxDepth=1,this.x=e,this.y=t,this.width=n,this.height=i}r(e,"laya.d3.math.Viewport");var t=e.prototype;return t.project=function(e,t,n){ct.transformV3ToV3(e,t,n);var i=e.elements,r=t.elements,a=n.elements,s=i[0]*r[3]+i[1]*r[7]+i[2]*r[11]+r[15];1!==s&&(a[0]=a[0]/s,a[1]=a[1]/s,a[2]=a[2]/s),a[0]=.5*(a[0]+1)*this.width+this.x,a[1]=.5*(1-a[1])*this.height+this.y,a[2]=a[2]*(this.maxDepth-this.minDepth)+this.minDepth},t.unprojectFromMat=function(e,t,n){var i=e.elements,r=t.elements,a=n.elements;a[0]=(i[0]-this.x)/this.width*2-1,a[1]=-((i[1]-this.y)/this.height*2-1);var s=(this.maxDepth-this.minDepth)/2;a[2]=(i[2]-this.minDepth-s)/s;var o=a[0]*r[3]+a[1]*r[7]+a[2]*r[11]+r[15];ct.transformV3ToV3(n,t,n),1!==o&&(a[0]=a[0]/o,a[1]=a[1]/o,a[2]=a[2]/o)},t.unprojectFromWVP=function(t,n,i,r,a){at.multiply(n,i,e._tempMatrix4x4),r&&at.multiply(e._tempMatrix4x4,r,e._tempMatrix4x4),e._tempMatrix4x4.invert(e._tempMatrix4x4),this.unprojectFromMat(t,e._tempMatrix4x4,a)},i(e,["_tempMatrix4x4",function(){return this._tempMatrix4x4=new at}]),e}(),mt=function(){function e(e){this._mesh=null,this._boneIndicesList=null,this._subIndexBufferStart=null,this._subIndexBufferCount=null,this._skinAnimationDatas=null,this._bufferUsage=null,this._indexInMesh=0,this._vertexBuffer=null,this._vertexStart=0,this._vertexCount=0,this._indexBuffer=null,this._indexStart=0,this._indexCount=0,this._indices=null,this._bufferUsage={},this._mesh=e,this._boneIndicesList=[],this._subIndexBufferStart=[],this._subIndexBufferCount=[]}r(e,"laya.d3.resource.models.SubMesh");var t=e.prototype;return n.imps(t,{"laya.d3.core.render.IRenderable":!0,"laya.resource.IDispose":!0}),t._getVertexBuffer=function(e){return void 0===e&&(e=0),0===e?this._vertexBuffer:null},t._getIndexBuffer=function(){return this._indexBuffer},t._getStaticBatchBakedVertexs=function(t,n){var i,r,a=this._vertexBuffer,s=a.vertexDeclaration,o=s.getVertexElementByUsage(0).offset/4,l=s.getVertexElementByUsage(3).offset/4,h=n.meshRender.lightmapScaleOffset,_=0,u=0,c=0,d=0,f=0,m=0;if(h)if(r=s.getVertexElementByUsage(15))c=s.vertexStride/4,i=this._vertexCount>0?a.getData().slice(this._vertexStart*c,(this._vertexStart+this._vertexCount)*c):a.getData().slice(),d=r.offset/4;else{c=(m=s.vertexStride/4)+2,i=this._vertexCount?new Float32Array(this._vertexCount*(a.vertexDeclaration.vertexStride/4+2)):new Float32Array(a.vertexCount*(a.vertexDeclaration.vertexStride/4+2)),d=(f=s.getVertexElementByUsage(2).offset/4)+2;var p=a.getData();for(_=0,u=p.length/m;_<u;_++){var v=0;v=this._vertexCount>0?(this._vertexStart+_)*m:_*m;var g=_*c,x=0;for(x=0;x<d;x++)i[g+x]=p[v+x];for(x=d;x<m;x++)i[g+x+2]=p[v+x]}}else c=s.vertexStride/4,i=this._vertexCount?a.getData().slice(this._vertexStart*c,(this._vertexStart+this._vertexCount)*c):a.getData().slice();if(t){var E=t.worldMatrix,S=e._tempMatrix4x40;E.invert(S);var D=e._tempMatrix4x41,T=n.transform.worldMatrix;at.multiply(S,T,D)}else D=n.transform.worldMatrix;var M=e._tempQuaternion0;for(D.decomposeTransRotScale(e._tempVector30,M,e._tempVector31),_=0,u=i.length/c;_<u;_++){var y=_*c+o,R=_*c+l;if(Ct.transformVector3ArrayToVector3ArrayCoordinate(i,y,D,i,y),Ct.transformVector3ArrayByQuat(i,R,M,i,R),h){var A=_*c+d;if(r)Ct.transformLightingMapTexcoordByUV1Array(i,A,h,i,A);else{var C=_*m+f;Ct.transformLightingMapTexcoordByUV0Array(p,C,h,i,A)}}}return i},t._beforeRender=function(e){return this._vertexBuffer._bind(),this._indexBuffer._bind(),!0},t._render=function(e){var t,n=0,i=e.renderElement;if(this._indexCount>1){var r=this._boneIndicesList.length;if(r>1){for(var a=0;a<r;a++)(t=i._skinAnimationDatas||this._skinAnimationDatas)&&(i._shaderValue.setValue(0,t[a]),e._shader.uploadRenderElementUniforms(i._shaderValue.data)),N.mainContext.drawElements(4,this._subIndexBufferCount[a],5123,2*this._subIndexBufferStart[a]);C.drawCall+=r}else(t=i._skinAnimationDatas||this._skinAnimationDatas)&&(i._shaderValue.setValue(0,t[0]),e._shader.uploadRenderElementUniforms(i._shaderValue.data)),N.mainContext.drawElements(4,this._indexCount,5123,2*this._indexStart),C.drawCall++;n=this._indexCount}else n=this._indexBuffer.indexCount,(t=i._skinAnimationDatas||this._skinAnimationDatas)&&(i._shaderValue.setValue(0,t[0]),e._shader.uploadRenderElementUniforms(i._shaderValue.data)),N.mainContext.drawElements(4,n,5123,0),C.drawCall++;C.trianglesFaces+=n/3},t.getIndices=function(){return this._indexCount>0?this._indices:this._indexBuffer.getData()},t.dispose=function(){this._indexBuffer.dispose(),this._vertexBuffer.dispose(),this._mesh=null,this._boneIndicesList=null,this._subIndexBufferStart=null,this._subIndexBufferCount=null,this._skinAnimationDatas=null,this._bufferUsage=null,this._vertexBuffer=null,this._indexBuffer=null},t._renderRuntime=function(e,t,n){t._material,t._sprite3D;e.drawSubmesh(t._conchSubmesh,0,4,0,this._indexBuffer.indexCount)},a(0,t,"_vertexBufferCount",function(){return 1}),a(0,t,"triangleCount",function(){return this._indexBuffer.indexCount/3}),i(e,["_tempVector30",function(){return this._tempVector30=new ct},"_tempVector31",function(){return this._tempVector31=new ct},"_tempQuaternion0",function(){return this._tempQuaternion0=new lt},"_tempMatrix4x40",function(){return this._tempMatrix4x40=new at},"_tempMatrix4x41",function(){return this._tempMatrix4x41=new at}]),e}(),pt=function(){function e(n,i,r,a,s,o){function l(e){for(var t=e.split(" "),n=[],i=0;i<t.length;i++)t[i].length>0&&n.push(t[i]);return n}function h(n){var i=n;n=n.replace(e.DEFINEREG,"");var r,a,s=0,h=0,_=0,u=new t(0,null,null,null),c=u,d=n.split("\n");for(s=0,h=d.length;s<h;s++){var f=d[s];if(f.indexOf("#ifdef")>=0)r=l(f),c=new t(1,r[1],"",c);else if(f.indexOf("#if")>=0)r=l(f),c=new t(1,r[1],"",c);else if(f.indexOf("#else")>=0)a=c.condition,(c=new t(2,null,"",c.parent)).condition=a;else if(f.indexOf("#endif")>=0)c=c.parent;else if(f.indexOf("#include")>=0){var m=(r=l(f))[1],p=m.charAt(0);'"'!==p&&"'"!==p||(_=(m=m.substr(1,m.length-2)).lastIndexOf(p))>0&&(m=m.substr(0,_));var v=(_=r[0].indexOf("?"))>0?r[0].substr(_+1):null;if(new t(1,v,o[m],c),T.isConchNode){var g=v.match(e.INCLUDE),x=g.length;if(1==x)v=v.replace(g[0],"defined("+g[0]+")");else if(x>1)for(var E={},S=0;S<x;S++){var D=g[S];E[D]||(v=v.replace(D,"defined("+D+")"),E[D]=!0)}var M="#if "+v;M+="\n"+o[m]+"\n",M+="#endif",i=i.replace(f,M)}}else c.childs.length>0&&0===c.childs[c.childs.length-1].type?c.childs[c.childs.length-1].text+="\n"+f:new t(0,null,f,c)}return T.isConchNode&&(u.sd=i),u}this._curMaterialDefinePower=1,this._curSpriteDefinePower=3,this._materialInt2name=[],this._materialName2Int={},this._spriteInt2name=[],this._name=n,this._renderElementUniformMap={},this._materialUniformMap={},this._spriteUniformMap={},this._cameraUniformMap={},this._sceneUniformMap={},this.sharders=[],this._VSTXT=i,this._PSTXT=r,this._spriteInt2name[1]="RECEIVESHADOW",this._spriteInt2name[2]="SCALEOFFSETLIGHTINGMAPUV",this._spriteInt2name[4]="LIGHTMAP",this._spriteInt2name[zn.SHADERDEFINE_BONE]="BONE",this._materialInt2name[1]="ALPHATEST",this._VS=h(i),this._PS=h(r),this._attributeMap=a;var _;for(_ in s){var u=s[_];switch(u[1]){case 0:this._renderElementUniformMap[_]=u[0];break;case 1:this._materialUniformMap[_]=u[0];break;case 2:this._spriteUniformMap[_]=u[0];break;case 3:this._cameraUniformMap[_]=u[0];break;case 4:this._sceneUniformMap[_]=u[0];break;default:throw new Error("ShaderCompile3D: period is unkonw.")}}if(T.isConchNode){this._conchShader=new ConchShader,this._conchShader.setSrc(this._VS.sd,this._PS.sd),delete this._VS.sd,delete this._PS.sd;var c=[];for(_ in this._attributeMap)c.push({name:_,elementUsage:this._attributeMap[_]});this._conchShader.setAttrDeclare(c);var d=[];for(_ in s){var f=s[_];d.push({name:_,elementUsage:f[0],periodType:f[1]})}this._conchShader.setUniformDeclare(d)}}var t;r(e,"laya.d3.shader.ShaderCompile3D");var n=e.prototype;return n._definesToNameDic=function(e,t){for(var n={},i=1,r=0;r<32&&!((i=1<<r)>e);r++)if(e&i){var a=t[i];a&&(n[a]="")}return n},n.withCompile=function(t,n,i){var r,a,s;if(a=this.sharders[t])if(s=a[n]){if(r=s[i])return r}else s=a[n]=[];else s=(a=this.sharders[t]=[])[n]=[];var o=this._definesToNameDic(t,e._globalInt2name),l=this._definesToNameDic(n,this._spriteInt2name),h=this._definesToNameDic(i,this._materialInt2name);if(laya.d3.shader.ShaderCompile3D.debugMode){var _,u="";for(_ in o)u+=_+" ";var c="";for(_ in l)c+=_+" ";var d="";for(_ in h)d+=_+" ";console.log("ShaderCompile3DDebugMode---(Name:"+cn.nameKey.getName(this._name)+" PublicDefine:"+t+" SpriteDefine:"+n+" MaterialDefine:"+i+" PublicDefineGroup:"+u+" SpriteDefineGroup:"+c+"MaterialDefineGroup: "+d+")---ShaderCompile3DDebugMode")}return r=this.createShader(o,l,h),s[i]=r,r},n.createShader=function(e,t,n){var i,r={},a="";if(e)for(i in e)a+="#define "+i+"\n",r[i]=!0;if(t)for(i in t)a+="#define "+i+"\n",r[i]=!0;if(n)for(i in n)a+="#define "+i+"\n",r[i]=!0;var s=this._VS.toscript(r,[]),o=this._PS.toscript(r,[]);return cn.create(a+s.join("\n"),a+o.join("\n"),this._attributeMap,this._sceneUniformMap,this._cameraUniformMap,this._spriteUniformMap,this._materialUniformMap,this._renderElementUniformMap)},n.precompileShaderWithShaderDefine=function(e,t,n){this.withCompile(e,t,n)},n.registerMaterialDefine=function(e){var t=Math.pow(2,this._curMaterialDefinePower++);return this._materialInt2name[t]=e,this._materialName2Int[e]=t,T.isConchNode&&conch.regShaderDefine&&conch.regShaderDefine(e,t),t},n.registerSpriteDefine=function(e){var t=Math.pow(2,this._curSpriteDefinePower++);return this._spriteInt2name[t]=e,T.isConchNode&&conch.regShaderDefine&&conch.regShaderDefine(e,t),t},n.getMaterialDefineByName=function(e){return this._materialName2Int[e]},e.__init__=function(){e._globalRegDefine("HIGHPRECISION",e.SHADERDEFINE_HIGHPRECISION),e._globalRegDefine("FOG",e.SHADERDEFINE_FOG),e._globalRegDefine("DIRECTIONLIGHT",e.SHADERDEFINE_DIRECTIONLIGHT),e._globalRegDefine("POINTLIGHT",e.SHADERDEFINE_POINTLIGHT),e._globalRegDefine("SPOTLIGHT",e.SHADERDEFINE_SPOTLIGHT),e._globalRegDefine("UV",e.SHADERDEFINE_UV0),e._globalRegDefine("COLOR",e.SHADERDEFINE_COLOR),e._globalRegDefine("UV1",e.SHADERDEFINE_UV1),e._globalRegDefine("CASTSHADOW",xt.SHADERDEFINE_CAST_SHADOW),e._globalRegDefine("SHADOWMAP_PSSM1",xt.SHADERDEFINE_SHADOW_PSSM1),e._globalRegDefine("SHADOWMAP_PSSM2",xt.SHADERDEFINE_SHADOW_PSSM2),e._globalRegDefine("SHADOWMAP_PSSM3",xt.SHADERDEFINE_SHADOW_PSSM3),e._globalRegDefine("SHADOWMAP_PCF_NO",xt.SHADERDEFINE_SHADOW_PCF_NO),e._globalRegDefine("SHADOWMAP_PCF1",xt.SHADERDEFINE_SHADOW_PCF1),e._globalRegDefine("SHADOWMAP_PCF2",xt.SHADERDEFINE_SHADOW_PCF2),e._globalRegDefine("SHADOWMAP_PCF3",xt.SHADERDEFINE_SHADOW_PCF3),e._globalRegDefine("DEPTHFOG",e.SAHDERDEFINE_DEPTHFOG)},e._globalRegDefine=function(t,n){e._globalInt2name[n]=t},e.add=function(t,n,i,r,a){return laya.d3.shader.ShaderCompile3D._preCompileShader[t]=new e(t,n,i,r,a,cn._includeFiles)},e.get=function(e){return laya.d3.shader.ShaderCompile3D._preCompileShader[cn.nameKey.getID(e)]},e.debugMode=!1,e.SHADERDEFINE_HIGHPRECISION=1,e.SHADERDEFINE_FOG=4,e.SHADERDEFINE_DIRECTIONLIGHT=8,e.SHADERDEFINE_POINTLIGHT=16,e.SHADERDEFINE_SPOTLIGHT=32,e.SHADERDEFINE_UV0=64,e.SHADERDEFINE_COLOR=128,e.SHADERDEFINE_UV1=256,e.SAHDERDEFINE_DEPTHFOG=131072,e._globalInt2name=[],e._preCompileShader={},e.IFDEF_NO=0,e.IFDEF_YES=1,e.IFDEF_ELSE=2,i(e,["DEFINEREG",function(){return this.DEFINEREG=new RegExp("defined(?=\\((.*?)\\))","g")},"INCLUDE",function(){return this.INCLUDE=new RegExp("\\w+","g")}]),e.__init$=function(){t=function(){function e(e,t,n,i){if(this.childs=new Array,this.type=e,this.text=n,this.parent=i,i&&i.childs.push(this),t){for(var r="",a=!1,s=!1,o=0,l=t.length;o<l;o++){var h=t.charAt(o);a!=(s="!&|() \t".indexOf(h)<0)&&(s&&(r+="this."),a=s),r+=h}this.condition=R.createShaderCondition(r)}else 1==this.type&&(this.type=0)}return r(e,""),e.prototype.toscript=function(e,t){if(0===this.type&&this.text&&t.push(this.text),this.childs.length<1&&!this.text)return t;if(0!==this.type){var n=!!this.condition.call(e);if(2===this.type&&(n=!n),!n)return t;this.text&&t.push(this.text)}return this.childs.length>0&&this.childs.forEach(function(n,i,r){n.toscript(e,t)}),t},e}()},e}(),vt=function(){function e(){}return r(e,"laya.d3.shader.ShaderInit3D"),e.__init__=function(){cn.addInclude("LightHelper.glsl","\nstruct DirectionLight\n{\n vec3 Direction;\n vec3 Diffuse;\n};\n\nstruct PointLight\n{\n vec3 Diffuse;\n vec3 Attenuation;\n vec3 Position;\n float Range;\n};\n\nstruct SpotLight\n{\n vec3 Diffuse;\n vec3 Attenuation;\n vec3 Position;\n vec3 Direction;\n float Spot;\n float Range;\n};\n\n\nvoid  computeDirectionLight(in vec3 matDif,in vec3 matAmb,in vec4 matSpe,in DirectionLight dirLight,in vec3 ambinentColor,in vec3 normal,in vec3 toEye,out vec3 dif,out vec3 amb,out vec3 spec)\n{\n\tdif=vec3(0.0);//不初始化在IOS中闪烁，PC中不会闪烁\n\tamb=vec3(0.0);\n\tspec=vec3(0.0);\n\tvec3 lightVec=-normalize(dirLight.Direction);\n\t\n\tamb=matAmb*ambinentColor;\n\t\n\tfloat  diffuseFactor=dot(lightVec, normal);\n\t\n\tif(diffuseFactor>0.0)\n\t{\n\t   vec3 v = reflect(-lightVec, normal);\n\t   float specFactor = pow(max(dot(v, toEye), 0.0), matSpe.w);\n\t   \n\t   dif = diffuseFactor * matDif * dirLight.Diffuse;\n\t   spec = specFactor * matSpe.rgb;\n\t}\n\t\n}\n\nvoid computePointLight(in vec3 matDif,in vec3 matAmb,in vec4 matSpe,in PointLight poiLight,in vec3 ambinentColor, in vec3 pos,in vec3 normal,in vec3 toEye,out vec3 dif,out vec3 amb,out vec3 spec)\n{\n\tdif=vec3(0.0);\n\tamb=vec3(0.0);\n\tspec=vec3(0.0);\n\tvec3 lightVec = poiLight.Position - pos;\n\t\t\n\tfloat d = length(lightVec);\n\t\n\tif( d > poiLight.Range )\n\t\treturn;\n\t\t\n\tlightVec /= d; \n\t\n\tamb = matAmb*ambinentColor;\t\n\n\tfloat diffuseFactor = dot(lightVec, normal);\n\n\tif( diffuseFactor > 0.0 )\n\t{\n\t\tvec3 v= reflect(-lightVec, normal);\n\t\tfloat specFactor = pow(max(dot(v, toEye), 0.0), matSpe.w);\n\t\t\t\t\t\n\t\tdif = diffuseFactor * matDif * poiLight.Diffuse;\n\t\tspec = specFactor * matSpe.rgb;\n\t}\n\n\tfloat attenuate = 1.0 / dot(poiLight.Attenuation, vec3(1.0, d, d*d));\n\n\tdif *= attenuate;\n\tspec*= attenuate;\n}\n\nvoid ComputeSpotLight(in vec3 matDif,in vec3 matAmb,in vec4 matSpe,in SpotLight spoLight,in vec3 ambinentColor,in vec3 pos, in vec3 normal,in vec3 toEye,out vec3 dif,out vec3 amb,out vec3 spec)\n{\n\tamb = vec3(0.0);\n\tdif =vec3(0.0);\n\tspec= vec3(0.0);\n\tvec3 lightVec = spoLight.Position - pos;\n\t\t\n\tfloat d = length(lightVec);\n\t\n\tif( d > spoLight.Range)\n\t\treturn;\n\t\t\n\tlightVec /= d; \n\t\n\tamb = matAmb*ambinentColor;\t\n\n\tfloat diffuseFactor = dot(lightVec, normal);\n\n\tif(diffuseFactor > 0.0)\n\t{\n\t\tvec3 v= reflect(-lightVec, normal);\n\t\tfloat specFactor = pow(max(dot(v, toEye), 0.0), matSpe.w);\n\t\t\t\t\t\n\t\tdif = diffuseFactor * matDif * spoLight.Diffuse;\n\t\tspec = specFactor * matSpe.rgb;\n\t}\n\t\n\tfloat spot = pow(max(dot(-lightVec, normalize(spoLight.Direction)), 0.0), spoLight.Spot);\n\n\tfloat attenuate = spot/dot(spoLight.Attenuation, vec3(1.0, d, d*d));\n\n\tamb *= spot;\n\tdif *= attenuate;\n\tspec*= attenuate;\n}\n\nvec3 NormalSampleToWorldSpace(vec3 normalMapSample, vec3 unitNormal, vec3 tangent)\n{\n\tvec3 normalT = 2.0*normalMapSample - 1.0;\n\n\t// Build orthonormal basis.\n\tvec3 N = normalize(unitNormal);\n\tvec3 T = normalize(tangent- dot(tangent, N)*N);\n\tvec3 B = cross(T, N);\n\n\tmat3 TBN = mat3(T, B, N);\n\n\t// Transform from tangent space to world space.\n\tvec3 bumpedNormal = TBN*normalT;\n\n\treturn bumpedNormal;\n}\n"),cn.addInclude("ShadowHelper.glsl","uniform sampler2D u_shadowMap1;\nuniform sampler2D u_shadowMap2;\nuniform sampler2D u_shadowMap3;\nuniform vec2\t  u_shadowPCFoffset;\nuniform vec4     u_shadowPSSMDistance;\nvec4 packDepth(const in float depth)\n{\n\tconst vec4 bitShift = vec4(256.0*256.0*256.0, 256.0*256.0, 256.0, 1.0);\n\tconst vec4 bitMask\t= vec4(0.0, 1.0/256.0, 1.0/256.0, 1.0/256.0);\n\tvec4 res = mod(depth*bitShift*vec4(255), vec4(256))/vec4(255);\n\tres -= res.xxyz * bitMask;\n\treturn res;\n}\nfloat unpackDepth(const in vec4 rgbaDepth)\n{\n\tconst vec4 bitShift = vec4(1.0/(256.0*256.0*256.0), 1.0/(256.0*256.0), 1.0/256.0, 1.0);\n\tfloat depth = dot(rgbaDepth, bitShift);\n\treturn depth;\n}\nfloat tex2DPCF( sampler2D shadowMap,vec2 texcoord,vec2 invsize,float zRef )\n{\n\tvec2 texelpos =texcoord / invsize;\n\tvec2 lerps = fract( texelpos );\n\tfloat sourcevals[4];\n\tsourcevals[0] = float( unpackDepth(texture2D(shadowMap,texcoord)) > zRef );\n\tsourcevals[1] = float( unpackDepth(texture2D(shadowMap,texcoord + vec2(invsize.x,0))) > zRef );\n\tsourcevals[2] = float( unpackDepth(texture2D(shadowMap,texcoord + vec2(0,invsize.y))) > zRef );\n\tsourcevals[3] = float( unpackDepth(texture2D(shadowMap,texcoord + vec2(invsize.x, invsize.y) )) > zRef );\n\treturn mix( mix(sourcevals[0],sourcevals[2],lerps.y),mix(sourcevals[1],sourcevals[3],lerps.y),lerps.x );\n}\nfloat getShadowPSSM3( sampler2D shadowMap1,sampler2D shadowMap2,sampler2D shadowMap3,mat4 lightShadowVP[4],vec4 pssmDistance,vec2 shadowPCFOffset,vec3 worldPos,float posViewZ,float zBias )\n{\n\tfloat value = 1.0;\n\tint nPSNum = int(posViewZ>pssmDistance.x);\n\tnPSNum += int(posViewZ>pssmDistance.y);\n\tnPSNum += int(posViewZ>pssmDistance.z);\n\t//真SB,webgl不支持在PS中直接访问数组\n\tmat4 lightVP;\n\tif( nPSNum == 0 )\n\t{\n\t\tlightVP = lightShadowVP[1];\n\t}\n\telse if( nPSNum == 1 )\n\t{\n\t\tlightVP = lightShadowVP[2];\n\t}\n\telse if( nPSNum == 2 )\n\t{\n\t\tlightVP = lightShadowVP[3];\n\t}\n\tvec4 vLightMVPPos = lightVP * vec4(worldPos,1.0);\n\t//为了效率，在CPU计算/2.0 + 0.5\n\t//vec3 vText = (vLightMVPPos.xyz / vLightMVPPos.w)/2.0 + 0.5;\n\tvec3 vText = vLightMVPPos.xyz / vLightMVPPos.w;\n\tfloat fMyZ = vText.z - zBias;\n\t/*\n\tbvec4 bInFrustumVec = bvec4 ( vText.x >= 0.0, vText.x <= 1.0, vText.y >= 0.0, vText.y <= 1.0 );\n\tbool bInFrustum = all( bInFrustumVec );\n\tbvec2 bFrustumTestVec = bvec2( bInFrustum, fMyZ <= 1.0 );\n\tbool bFrustumTest = all( bFrustumTestVec );\n\tif ( bFrustumTest ) \n\t*/\n\tif( fMyZ <= 1.0 )\n\t{\n\t\tfloat zdepth=0.0;\n#ifdef SHADOWMAP_PCF3\n\t\tif ( nPSNum == 0 )\n\t\t{\n\t\t\tvalue =  tex2DPCF( shadowMap1, vText.xy,shadowPCFOffset,fMyZ );\n\t\t\tvalue += tex2DPCF( shadowMap1, vText.xy+vec2(shadowPCFOffset.xy),shadowPCFOffset,\tfMyZ );\n\t\t\tvalue += tex2DPCF( shadowMap1, vText.xy+vec2(shadowPCFOffset.x,0),shadowPCFOffset,\tfMyZ );\n\t\t\tvalue += tex2DPCF( shadowMap1, vText.xy+vec2(0,shadowPCFOffset.y),shadowPCFOffset,\tfMyZ );\n\t\t\tvalue = value/4.0;\n\t\t} \n\t\telse if( nPSNum == 1 )\n\t\t{\n\t\t\tvalue = tex2DPCF( shadowMap2,vText.xy,shadowPCFOffset,fMyZ);\n\t\t}\n\t\telse if( nPSNum == 2 )\n\t\t{\n\t\t\tvec4 color = texture2D( shadowMap3,vText.xy );\n\t\t\tzdepth = unpackDepth(color);\n\t\t\tvalue = float(fMyZ < zdepth);\n\t\t}\n#endif\n#ifdef SHADOWMAP_PCF2\n\t\tif ( nPSNum == 0 )\n\t\t{\n\t\t\tvalue = tex2DPCF( shadowMap1,vText.xy,shadowPCFOffset,fMyZ);\n\t\t}\n\t\telse if( nPSNum == 1 )\n\t\t{\n\t\t\tvalue = tex2DPCF( shadowMap2,vText.xy,shadowPCFOffset,fMyZ);\n\t\t}\n\t\telse if( nPSNum == 2 )\n\t\t{\n\t\t\tvec4 color = texture2D( shadowMap3,vText.xy );\n\t\t\tzdepth = unpackDepth(color);\n\t\t\tvalue = float(fMyZ < zdepth);\n\t\t}\n\n#endif\n#ifdef SHADOWMAP_PCF1\n\t\tif ( nPSNum == 0 )\n\t\t{\n\t\t\tvalue = tex2DPCF( shadowMap1,vText.xy,shadowPCFOffset,fMyZ);\n\t\t}\n\t\telse if( nPSNum == 1 )\n\t\t{\n\t\t\tvec4 color = texture2D( shadowMap2,vText.xy );\n\t\t\tzdepth = unpackDepth(color);\n\t\t\tvalue = float(fMyZ < zdepth);\n\t\t}\n\t\telse if( nPSNum == 2 )\n\t\t{\n\t\t\tvec4 color = texture2D( shadowMap3,vText.xy );\n\t\t\tzdepth = unpackDepth(color);\n\t\t\tvalue = float(fMyZ < zdepth);\n\t\t}\n#endif\n#ifdef SHADOWMAP_PCF_NO\n\t\tvec4 color;\n\t\tif ( nPSNum == 0 )\n\t\t{\n\t\t\tcolor = texture2D( shadowMap1,vText.xy );\n\t\t}\n\t\telse if( nPSNum == 1 )\n\t\t{\n\t\t\tcolor = texture2D( shadowMap2,vText.xy );\n\t\t}\n\t\telse if( nPSNum == 2 )\n\t\t{\n\t\t\tcolor = texture2D( shadowMap3,vText.xy );\n\t\t}\n\t\tzdepth = unpackDepth(color);\n\t\tvalue = float(fMyZ < zdepth);\n#endif\n\t}\n\treturn value;\n}\nfloat getShadowPSSM2( sampler2D shadowMap1,sampler2D shadowMap2,mat4 lightShadowVP[4],vec4 pssmDistance,vec2 shadowPCFOffset,vec3 worldPos,float posViewZ,float zBias )\n{\n\tfloat value = 1.0;\n\tint nPSNum = int(posViewZ>pssmDistance.x);\n\tnPSNum += int(posViewZ>pssmDistance.y);\n\t//真SB,webgl不支持在PS中直接访问数组\n\tmat4 lightVP;\n\tif( nPSNum == 0 )\n\t{\n\t\tlightVP = lightShadowVP[1];\n\t}\n\telse if( nPSNum == 1 )\n\t{\n\t\tlightVP = lightShadowVP[2];\n\t}\n\tvec4 vLightMVPPos = lightVP * vec4(worldPos,1.0);\n\t//为了效率，在CPU计算/2.0 + 0.5\n\t//vec3 vText = (vLightMVPPos.xyz / vLightMVPPos.w)/2.0 + 0.5;\n\tvec3 vText = vLightMVPPos.xyz / vLightMVPPos.w;\n\tfloat fMyZ = vText.z - zBias;\n\t/*\n\tbvec4 bInFrustumVec = bvec4 ( vText.x >= 0.0, vText.x <= 1.0, vText.y >= 0.0, vText.y <= 1.0 );\n\tbool bInFrustum = all( bInFrustumVec );\n\tbvec2 bFrustumTestVec = bvec2( bInFrustum, fMyZ <= 1.0 );\n\tbool bFrustumTest = all( bFrustumTestVec );\n\tif ( bFrustumTest ) \n\t*/\n\tif( fMyZ <= 1.0 )\n\t{\n\t\tfloat zdepth=0.0;\n#ifdef SHADOWMAP_PCF3\n\t\tif ( nPSNum == 0 )\n\t\t{\n\t\t\tvalue =  tex2DPCF( shadowMap1, vText.xy,shadowPCFOffset,fMyZ );\n\t\t\tvalue += tex2DPCF( shadowMap1, vText.xy+vec2(shadowPCFOffset.xy),shadowPCFOffset,\tfMyZ );\n\t\t\tvalue += tex2DPCF( shadowMap1, vText.xy+vec2(shadowPCFOffset.x,0),shadowPCFOffset,\tfMyZ );\n\t\t\tvalue += tex2DPCF( shadowMap1, vText.xy+vec2(0,shadowPCFOffset.y),shadowPCFOffset,\tfMyZ );\n\t\t\tvalue = value/4.0;\n\t\t}\n\t\telse if( nPSNum == 1 )\n\t\t{\n\t\t\tvalue = tex2DPCF( shadowMap2,vText.xy,shadowPCFOffset,fMyZ);\n\t\t}\n#endif\n#ifdef SHADOWMAP_PCF2\n\t\tif ( nPSNum == 0 )\n\t\t{\n\t\t\tvalue = tex2DPCF( shadowMap1,vText.xy,shadowPCFOffset,fMyZ);\n\t\t}\n\t\telse if( nPSNum == 1 )\n\t\t{\n\t\t\tvalue = tex2DPCF( shadowMap2,vText.xy,shadowPCFOffset,fMyZ);\n\t\t}\n#endif\n#ifdef SHADOWMAP_PCF1\n\t\tif ( nPSNum == 0 )\n\t\t{\n\t\t\tvalue = tex2DPCF( shadowMap1,vText.xy,shadowPCFOffset,fMyZ);\n\t\t}\n\t\telse if( nPSNum == 1 )\n\t\t{\n\t\t\tvec4 color = texture2D( shadowMap2,vText.xy );\n\t\t\tzdepth = unpackDepth(color);\n\t\t\tvalue = float(fMyZ < zdepth);\n\t\t}\n#endif\n#ifdef SHADOWMAP_PCF_NO\n\t\tvec4 color;\n\t\tif ( nPSNum == 0 )\n\t\t{\n\t\t\tcolor = texture2D( shadowMap1,vText.xy );\n\t\t}\n\t\telse if( nPSNum == 1 )\n\t\t{\n\t\t\tcolor = texture2D( shadowMap2,vText.xy );\n\t\t}\n\t\tzdepth = unpackDepth(color);\n\t\tvalue = float(fMyZ < zdepth);\n#endif\n\t}\n\treturn value;\n}\nfloat getShadowPSSM1( sampler2D shadowMap1,vec4 lightMVPPos,vec4 pssmDistance,vec2 shadowPCFOffset,float posViewZ,float zBias )\n{\n\tfloat value = 1.0;\n\tif( posViewZ < pssmDistance.x )\n\t{\n\t\tvec3 vText = lightMVPPos.xyz / lightMVPPos.w;\n\t\tfloat fMyZ = vText.z - zBias;\n\t\t/*\n\t\tbvec4 bInFrustumVec = bvec4 ( vText.x >= 0.0, vText.x <= 1.0, vText.y >= 0.0, vText.y <= 1.0 );\n\t\tbool bInFrustum = all( bInFrustumVec );\n\t\tbvec2 bFrustumTestVec = bvec2( bInFrustum, fMyZ <= 1.0 );\n\t\tbool bFrustumTest = all( bFrustumTestVec );\n\t\t*/\n\t\tif ( fMyZ <= 1.0 ) \n\t\t{\n\t\t\tfloat zdepth=0.0;\n#ifdef SHADOWMAP_PCF3\n\t\t\tvalue =  tex2DPCF( shadowMap1, vText.xy,shadowPCFOffset,fMyZ );\n\t\t\tvalue += tex2DPCF( shadowMap1, vText.xy+vec2(shadowPCFOffset.xy),shadowPCFOffset,fMyZ );\n\t\t\tvalue += tex2DPCF( shadowMap1, vText.xy+vec2(shadowPCFOffset.x,0),shadowPCFOffset,fMyZ );\n\t\t\tvalue += tex2DPCF( shadowMap1, vText.xy+vec2(0,shadowPCFOffset.y),shadowPCFOffset,fMyZ );\n\t\t\tvalue = value/4.0;\n#endif\n#ifdef SHADOWMAP_PCF2\t\t\n\t\t\tvalue = tex2DPCF( shadowMap1,vText.xy,shadowPCFOffset,fMyZ);\n#endif\n#ifdef SHADOWMAP_PCF1\n\t\t\tvalue = tex2DPCF( shadowMap1,vText.xy,shadowPCFOffset,fMyZ);\n#endif\n#ifdef SHADOWMAP_PCF_NO\t\t\n\t\t\tvec4 color = texture2D( shadowMap1,vText.xy );\n\t\t\tzdepth = unpackDepth(color);\n\t\t\tvalue = float(fMyZ < zdepth);\n#endif\n\t\t}\n\t}\n\treturn value;\n}"),cn.addInclude("WaveFunction.glsl","\nuniform vec2 u_WaveInfoD[20];\nuniform vec4 u_WaveInfo[20];\n\nuniform float TEXWAVE_UV_SCALE ;//= 20.0; //每texwidth像素代表的实际距离\n/**\n\t这里的计算都是\n*/\n\n/**\n* 计算一个波形\n*  开始计算的时候都按照z向上，最后输出的时候，颠倒一下。\n* @param tm {float} 毫秒\n*/\nvoid calcGerstnerWave(float curtm, vec3 pos, float deep, vec2 uvpos, out vec3 opos, out vec3 B, out vec3 T, out vec3 N, out float foamS){\n\tfloat tm = curtm/1000.;\n\topos = pos;\n\tvec3 wpos=vec3(0.);\t\t//累加的位置\n\tN=vec3(0.,0.,0.);\t//输出的法线初始化一下\n\tT=vec3(0.,0.,0.);\n\tB=vec3(0.,0.,0.);\n\tvec2 cD ;//= D;\n\t//float deepAtt = max(0.,min(deep,1.0));\n\t//A*=deepAtt; //TODO\n\t\n\tfor( int i=0; i<4; i++){\n\t\tcD = u_WaveInfoD[i];//vec2(wi.winfo[0],wi.winfo[1]);// wi.vDir;\n\t\tfloat Q = u_WaveInfo[i].x;//wi.QorK;\n\t\tfloat A = u_WaveInfo[i].y;//wi.A;\n\t\tfloat W = u_WaveInfo[i].z;//wi.omega;\n\t\tfloat P = u_WaveInfo[i].w;//wi.phi;\n\t\tfloat dop = dot(cD,uvpos);\n\t\tfloat c = cos(dop*W - tm*P);//TODO 优化\n\t\tfloat s = sin(dop*W - tm*P);\n\t\tfloat AWs = A*W*s;\n\t\tfloat AWc = A*W*c;\n\t\tfloat _QxyAWs = -Q*cD.x*cD.y*AWs;\n\t\t\n\t\twpos += vec3(Q*A*cD.x*c,\n\t\t\t\t\tQ*A*cD.y*c,\n\t\t\t\t\tA*s);\n\t\tN += vec3(-cD.x*AWc,\n\t\t\t\t-cD.y*AWc,\n\t\t\t\tQ*AWs);//记得最后1-\n\t\tT += vec3(_QxyAWs,\n\t\t\t\tQ*cD.y*cD.y*AWs,//记得1-\n\t\t\t\tcD.y*AWc\n\t\t\t);\n\t\tB += vec3(Q*cD.x*cD.x*AWs,//记得1-\n\t\t\t\t_QxyAWs,\n\t\t\t\tcD.x*AWc\n\t\t\t);\n\t\t//float v1 = exp(-tan((dop*W - tm*P)/2.+1.07));//除2，+pi/2 这样正好能对齐\n#ifdef USE_FOAM\t\t\n\t\tfloat v1 = 0.5-sin((dop*W - tm*P)/1.+2.0)/2.;\n\t\tfoamS += pow(v1,9.)/4.;\n#endif\n\t}\n\tT.y=1.-T.y; B.x=1.-B.x;N.z=1.-N.z;\n\topos += vec3(wpos.x,wpos.z*min(deep/10.,1.),wpos.y);\n\t//y和z交换一下。现在根据uv计算的位置，所以直接交换yz就行。其他情况下有问题么\n\tT.xyz=T.xzy;\n\tB.xyz=B.xzy;\n\tN.xyz=N.xzy;\n}\n\n\nvoid calcWave(float curtm, vec2 uv, out vec3 B, out vec3 T, out vec3 N){\n\tfloat tm = curtm/1000.;\n\tN=vec3(0.,0.,0.);\t//输出的法线初始化一下\n\tvec2 uvpos = uv*TEXWAVE_UV_SCALE; //TODO 这个范围是什么 就是1？\n\tuvpos.y*=-1.;\n\tvec2 cD;// = D;\n\tconst int NumWaves = 4;\n\tfloat scale = 1./float(NumWaves);\n\tfor( int i=0; i<NumWaves; i++){\n\t\tcD = u_WaveInfoD[i];//vec2(wi.winfo[0],wi.winfo[1]);// wi.vDir;\n\t\tfloat k = 1.5;//u_WaveInfo[i].x;//wi.QorK; TODO  不知道为什么，这个取u_WaveInfo[i].x，在mi3w上就会闪。测试发现实际值也传过来了，就是1.5\n\t\tfloat A = u_WaveInfo[i].y;//wi.A;\n\t\tfloat W = u_WaveInfo[i].z;//wi.omega;\n\t\tfloat P = u_WaveInfo[i].w;//wi.phi;\n\t\t\n\t\tfloat dop = dot(cD,uvpos);\n\t\tfloat c = cos(dop*W - tm*P);//TODO 优化\n\t\tfloat s = sin(dop*W - tm*P);\n\t\t/*\n\t\tfloat AWs = A*W*s;\n\t\tfloat AWc = A*W*c;\n\t\tfloat _QxyAWs = -Q*cD.x*cD.y*AWs;\n\t\t\n\t\tN += vec3(-cD.x*AWc,\n\t\t\t\t-cD.y*AWc,\n\t\t\t\tQ*AWs);//记得最后1-\n\t\t*/\n\t\tfloat kWAc = scale*c;//k*W*A*c;  为了提高精度，这里只保留sin，cos部分，实际使用的时候再乘回来。\n\t\t//float kWAc = k*W*A*c;  \n\t\tN += vec3(\n\t\t\t-kWAc*cD.x*pow((s+1.)/2.,k-1.),\n\t\t\t-kWAc*cD.y*pow((s+1.)/2.,k-1.),\n\t\t\t1.\n\t\t);\n\t}\n\t//N.z=1.-N.z;\n\t//y和z交换一下。现在根据uv计算的位置，所以直接交换yz就行。其他情况下有问题么\n\tN.xyz=N.xzy;\n}\n");var e,t,n={a_Position:0,a_Color:1,a_Normal:3,a_Texcoord0:2,a_Texcoord1:15,a_TexcoordNext0:14,a_BoneWeights:7,a_BoneIndices:6,a_Tangent0:5},i={u_Bones:[0,0],u_DiffuseTexture:[1,1],u_SpecularTexture:[3,1],u_NormalTexture:[2,1],u_AmbientTexture:[5,1],u_ReflectTexture:[6,1],u_AlphaTestValue:[0,1],u_Albedo:[7,1],u_UVMatrix:[13,1],u_UVAge:[14,1],u_UVAniAge:[8,1],u_MaterialDiffuse:[10,1],u_MaterialAmbient:[9,1],u_MaterialSpecular:[11,1],u_MaterialReflect:[12,1],u_TilingOffset:[15,1],u_WorldMat:[0,2],u_MvpMatrix:[1,2],u_LightmapScaleOffset:[2,2],u_LightMap:[3,2],u_CameraPos:[0,3],u_FogStart:[1,4],u_FogRange:[2,4],u_FogColor:[0,4],"u_DirectionLight.Direction":[3,4],"u_DirectionLight.Diffuse":[4,4],"u_PointLight.Position":[5,4],"u_PointLight.Range":[6,4],"u_PointLight.Attenuation":[7,4],"u_PointLight.Diffuse":[8,4],"u_SpotLight.Position":[9,4],"u_SpotLight.Direction":[10,4],"u_SpotLight.Range":[12,4],"u_SpotLight.Spot":[11,4],"u_SpotLight.Attenuation":[13,4],"u_SpotLight.Diffuse":[14,4],u_AmbientColor:[21,4],u_shadowMap1:[18,4],u_shadowMap2:[19,4],u_shadowMap3:[20,4],u_shadowPSSMDistance:[15,4],u_lightShadowVP:[16,4],u_shadowPCFoffset:[17,4]},r=cn.nameKey.add("SIMPLE");e="attribute vec4 a_Position;\nuniform mat4 u_MvpMatrix;\n\n\n\n#if defined(DIFFUSEMAP)||((defined(DIRECTIONLIGHT)||defined(POINTLIGHT)||defined(SPOTLIGHT))&&(defined(COLOR)&&defined(SPECULARMAP)||defined(NORMALMAP)))||(defined(LIGHTMAP)&&defined(UV))\nattribute vec2 a_Texcoord0;\nvarying vec2 v_Texcoord0;\n  #ifdef UVTRANSFORM \n  uniform mat4 u_UVMatrix;\n  #endif\n#endif\n\n#ifdef defined(AMBIENTMAP)||(defined(LIGHTMAP)&&defined(UV1))\nattribute vec2 a_Texcoord1;\n#endif\n\n#ifdef defined(AMBIENTMAP)||defined(LIGHTMAP)\nuniform vec4 u_LightmapScaleOffset;\nvarying vec2 v_LightMapUV;\n#endif\n\n\n#ifdef COLOR\nattribute vec4 a_Color;\nvarying vec4 v_Color;\n#endif\n\n#ifdef BONE\nattribute vec4 a_BoneIndices;\nattribute vec4 a_BoneWeights;\nconst int c_MaxBoneCount = 24;\nuniform mat4 u_Bones[c_MaxBoneCount];\n#endif\n\n#if defined(DIRECTIONLIGHT)||defined(POINTLIGHT)||defined(SPOTLIGHT)||defined(REFLECTMAP)\nattribute vec3 a_Normal;\nvarying vec3 v_Normal;\n#endif\n\n#if (defined(DIRECTIONLIGHT)||defined(POINTLIGHT)||defined(SPOTLIGHT)||defined(REFLECTMAP))&&defined(NORMALMAP)\nattribute vec3 a_Tangent0;\nvarying vec3 v_Tangent0;\n#endif\n\n#if defined(DIRECTIONLIGHT)||defined(POINTLIGHT)||defined(SPOTLIGHT)||defined(FOG)||defined(DEPTHFOG)||defined(REFLECTMAP)||defined(RECEIVESHADOW)\nuniform mat4 u_WorldMat;\nvarying vec3 v_PositionWorld;\n#endif\n\nvarying float v_posViewZ;\n#ifdef RECEIVESHADOW\n  #ifdef SHADOWMAP_PSSM1 \n  varying vec4 v_lightMVPPos;\n  uniform mat4 u_lightShadowVP[4];\n  #endif\n#endif\n\n#ifdef TILINGOFFSET\n\tuniform vec4 u_TilingOffset;\n#endif\n\nvoid main_castShadow()\n{\n#ifdef BONE\n\tmat4 skinTransform=mat4(0.0);\n\tskinTransform += u_Bones[int(a_BoneIndices.x)] * a_BoneWeights.x;\n\tskinTransform += u_Bones[int(a_BoneIndices.y)] * a_BoneWeights.y;\n\tskinTransform += u_Bones[int(a_BoneIndices.z)] * a_BoneWeights.z;\n\tskinTransform += u_Bones[int(a_BoneIndices.w)] * a_BoneWeights.w;\n\tvec4 position=skinTransform*a_Position;\n\tgl_Position = u_MvpMatrix * position;\n#else\n\tgl_Position = u_MvpMatrix * a_Position;\n#endif\n \n//TODO没考虑UV动画呢\n#if defined(DIFFUSEMAP)&&defined(ALPHATEST)\n\tv_Texcoord0=a_Texcoord0;\n#endif\n\tv_posViewZ = gl_Position.z;\n}\n\nvoid main_normal()\n{\n#ifdef BONE\n\tmat4 skinTransform=mat4(0.0);\n\tskinTransform += u_Bones[int(a_BoneIndices.x)] * a_BoneWeights.x;\n\tskinTransform += u_Bones[int(a_BoneIndices.y)] * a_BoneWeights.y;\n\tskinTransform += u_Bones[int(a_BoneIndices.z)] * a_BoneWeights.z;\n\tskinTransform += u_Bones[int(a_BoneIndices.w)] * a_BoneWeights.w;\n\tvec4 position=skinTransform*a_Position;\n\tgl_Position = u_MvpMatrix * position;\n#else\n\tgl_Position = u_MvpMatrix * a_Position;\n#endif\n\n#if defined(DIRECTIONLIGHT)||defined(POINTLIGHT)||defined(SPOTLIGHT)||defined(REFLECTMAP)\n\tmat3 worldMat;\n\t#ifdef BONE\n\t\tworldMat=mat3(u_WorldMat*skinTransform);\n\t#else\n\t\tworldMat=mat3(u_WorldMat);\n\t#endif  \n\tv_Normal=worldMat*a_Normal;\n\t#if (defined(DIRECTIONLIGHT)||defined(POINTLIGHT)||defined(SPOTLIGHT))&&defined(NORMALMAP)\n\t\tv_Tangent0=worldMat*a_Tangent0;\n\t#endif\n#endif\n\n#if defined(DIRECTIONLIGHT)||defined(POINTLIGHT)||defined(SPOTLIGHT)||defined(FOG)||defined(DEPTHFOG)||defined(REFLECTMAP)||defined(RECEIVESHADOW)\n\t#ifdef BONE\n\t\tv_PositionWorld=(u_WorldMat*position).xyz;\n\t#else\n\t\tv_PositionWorld=(u_WorldMat*a_Position).xyz;\n\t#endif\n#endif\n\n#if defined(DIFFUSEMAP)||((defined(DIRECTIONLIGHT)||defined(POINTLIGHT)||defined(SPOTLIGHT))&&(defined(COLOR)&&defined(SPECULARMAP)||defined(NORMALMAP)))\n\tv_Texcoord0=a_Texcoord0;\n\t#ifdef TILINGOFFSET\n\t\tv_Texcoord0=(v_Texcoord0*u_TilingOffset.xy)+u_TilingOffset.zw;\n\t#endif\n\t#ifdef UVTRANSFORM\n\t\tv_Texcoord0=(u_UVMatrix*vec4(v_Texcoord0,0.0,1.0)).xy;\n\t#endif\n#endif\n\n#ifdef defined(AMBIENTMAP)||defined(LIGHTMAP)\n\t#ifdef SCALEOFFSETLIGHTINGMAPUV\n\t\t#ifdef UV1\n\t\t\tv_LightMapUV=vec2(a_Texcoord1.x*u_LightmapScaleOffset.x+u_LightmapScaleOffset.z,1.0+a_Texcoord1.y*u_LightmapScaleOffset.y+u_LightmapScaleOffset.w);\n\t\t#else\n\t\t\tv_LightMapUV=vec2(a_Texcoord0.x*u_LightmapScaleOffset.x+u_LightmapScaleOffset.z,(a_Texcoord0.y-1.0)*u_LightmapScaleOffset.y+u_LightmapScaleOffset.w);\n\t\t#endif \n\t#else\n\t\t#ifdef UV1\n\t\t\tv_LightMapUV=a_Texcoord1;\n\t\t#else\n\t\t\tv_LightMapUV=a_Texcoord0;\n\t\t#endif \n\t#endif \n#endif\n\n#ifdef COLOR\n\tv_Color=a_Color;\n#endif\n\n#ifdef RECEIVESHADOW\n\tv_posViewZ = gl_Position.w;\n\t#ifdef SHADOWMAP_PSSM1 \n\t\tv_lightMVPPos = u_lightShadowVP[0] * vec4(v_PositionWorld,1.0);\n\t#endif\n#endif\n}\n\nvoid main()\n{\n#ifdef CASTSHADOW\n\tmain_castShadow();\n#else\n\tmain_normal();\n#endif\n}",t='#ifdef HIGHPRECISION\nprecision highp float;\n#else\nprecision mediump float;\n#endif\n\n#include?DIRECTIONLIGHT||POINTLIGHT||SPOTLIGHT "LightHelper.glsl";\n\nuniform vec4 u_Albedo;\n\n#ifdef ALPHATEST\nuniform float u_AlphaTestValue;\n#endif\n\n#ifdef DIFFUSEMAP\nuniform sampler2D u_DiffuseTexture;\n#endif\n\n#ifdef REFLECTMAP\nuniform samplerCube u_ReflectTexture;\nuniform vec3 u_MaterialReflect;\n#endif\n\n#if   defined(DIFFUSEMAP)||((defined(DIRECTIONLIGHT)||defined(POINTLIGHT)||defined(SPOTLIGHT))&&(defined(COLOR)&&defined(SPECULARMAP)||defined(NORMALMAP)))\nvarying vec2 v_Texcoord0;\n#endif\n\n#ifdef defined(AMBIENTMAP)||defined(LIGHTMAP)\nvarying vec2 v_LightMapUV;\n#endif\n#ifdef AMBIENTMAP\nuniform sampler2D u_AmbientTexture;\n#endif\n#ifdef LIGHTMAP\nuniform sampler2D u_LightMap;\n#endif\n\n#ifdef COLOR\nvarying vec4 v_Color;\n#endif\n\n#if defined(DIRECTIONLIGHT)||defined(POINTLIGHT)||defined(SPOTLIGHT)\nuniform vec3 u_MaterialDiffuse;\nuniform vec4 u_MaterialSpecular;\n  #if (defined(DIFFUSEMAP)||defined(COLOR))&&defined(SPECULARMAP) \n  uniform sampler2D u_SpecularTexture;\n  #endif\n#endif\n\n#if defined(DIRECTIONLIGHT)||defined(POINTLIGHT)||defined(SPOTLIGHT)||defined(AMBIENTMAP)||defined(LIGHTMAP)\nuniform vec3 u_MaterialAmbient;\n#endif\n\n#if defined(FOG)||defined(DEPTHFOG)\nuniform float u_FogStart;\nuniform float u_FogRange;\nuniform vec3 u_FogColor;\n#endif\n\n\n#if defined(DIRECTIONLIGHT)||defined(POINTLIGHT)||defined(SPOTLIGHT)||defined(REFLECTMAP)\nvarying vec3 v_Normal;\n#endif\n\n#if (defined(DIRECTIONLIGHT)||defined(POINTLIGHT)||defined(SPOTLIGHT))&&defined(NORMALMAP)\nuniform sampler2D u_NormalTexture;\nvarying vec3 v_Tangent0;\n#endif\n\n#ifdef DIRECTIONLIGHT\nuniform DirectionLight u_DirectionLight;\n#endif\n\n#ifdef POINTLIGHT\nuniform PointLight u_PointLight;\n#endif\n\n#ifdef SPOTLIGHT\nuniform SpotLight u_SpotLight;\n#endif\n\nuniform vec3 u_AmbientColor;\n\n\n#if defined(DIRECTIONLIGHT)||defined(POINTLIGHT)||defined(SPOTLIGHT)||defined(FOG)||defined(DEPTHFOG)||defined(REFLECTMAP)||(defined(RECEIVESHADOW)&&(defined(SHADOWMAP_PSM2)||defined(SHADOWMAP_PSM3)))\nuniform vec3 u_CameraPos;\n#endif\n#if defined(DIRECTIONLIGHT)||defined(POINTLIGHT)||defined(SPOTLIGHT)||defined(FOG)||defined(DEPTHFOG)||defined(REFLECTMAP)\nvarying vec3 v_PositionWorld;\n#endif\n\n#include "ShadowHelper.glsl"\n#ifdef RECEIVESHADOW\n\t#if defined(SHADOWMAP_PSSM2)||defined(SHADOWMAP_PSSM3)\n\tuniform mat4 u_lightShadowVP[4];\n\t#endif\n\t#ifdef SHADOWMAP_PSSM1 \n\tvarying vec4 v_lightMVPPos;\n\t#endif\n#endif\nvarying float v_posViewZ;\n\n\n\nvoid main_castShadow()\n{\n\t//gl_FragColor=vec4(v_posViewZ,0.0,0.0,1.0);\n\tgl_FragColor=packDepth(v_posViewZ);\n\t#if defined(DIFFUSEMAP)&&defined(ALPHATEST)\n\t\tfloat alpha = texture2D(u_DiffuseTexture,v_Texcoord0).w;\n\t\tif( alpha < u_AlphaTestValue )\n\t\t{\n\t\t\tdiscard;\n\t\t}\n\t#endif\n}\nvoid main_normal()\n{\n#if defined(DIFFUSEMAP)&&!defined(COLOR)\n\tgl_FragColor=texture2D(u_DiffuseTexture, v_Texcoord0);\n#endif \n  \n#if defined(COLOR)&&!defined(DIFFUSEMAP)\n\tgl_FragColor=v_Color;\n#endif \n  \n#if defined(DIFFUSEMAP)&&defined(COLOR)\n\tvec4 texColor=texture2D(u_DiffuseTexture, v_Texcoord0);\n\tgl_FragColor=texColor*v_Color;\n#endif\n  \n#if !defined(DIFFUSEMAP)&&!defined(COLOR)\n\tgl_FragColor=vec4(1.0,1.0,1.0,1.0);\n#endif \n    \n#ifdef ALPHATEST\n\tif(gl_FragColor.a-u_AlphaTestValue<0.0)\n\t\tdiscard;\n#endif\n  \n  \n#if defined(DIRECTIONLIGHT)||defined(POINTLIGHT)||defined(SPOTLIGHT)||defined(REFLECTMAP)\n\tvec3 normal;\n    #if (defined(DIRECTIONLIGHT)||defined(POINTLIGHT)||defined(SPOTLIGHT))&&defined(NORMALMAP)\n\t\tvec3 normalMapSample = texture2D(u_NormalTexture, v_Texcoord0).rgb;\n\t\tnormal = normalize(NormalSampleToWorldSpace(normalMapSample, v_Normal, v_Tangent0));\n\t#else\n\t\tnormal = normalize(v_Normal);\n    #endif\n#endif\n\t\n#if defined(DIRECTIONLIGHT)||defined(POINTLIGHT)||defined(SPOTLIGHT)\n\tvec3 diffuse = vec3(0.0);\n\tvec3 ambient = vec3(0.0);\n\tvec3 specular= vec3(0.0);\n\tvec3 dif, amb, spe;\n#endif\n  \n#if defined(DIRECTIONLIGHT)||defined(POINTLIGHT)||defined(SPOTLIGHT)||defined(FOG)||defined(REFLECTMAP)\n\tvec3 toEye;\n\t#ifdef FOG\n\t\ttoEye=u_CameraPos-v_PositionWorld;\n\t\tfloat toEyeLength=length(toEye);\n\t\ttoEye/=toEyeLength;\n\t#else\n\t\ttoEye=normalize(u_CameraPos-v_PositionWorld);\n\t#endif\n#endif\n\t\n#ifdef DIRECTIONLIGHT\n\tcomputeDirectionLight(u_MaterialDiffuse,u_MaterialAmbient,u_MaterialSpecular,u_DirectionLight,u_AmbientColor,normal,toEye, dif, amb, spe);\n\tdiffuse+=dif;\n\tambient+=amb;\n\tspecular+=spe;\n#endif\n \n#ifdef POINTLIGHT\n\tcomputePointLight(u_MaterialDiffuse,u_MaterialAmbient,u_MaterialSpecular,u_PointLight,u_AmbientColor,v_PositionWorld,normal,toEye, dif, amb, spe);\n\tdiffuse+=dif;\n\tambient+=amb;\n\tspecular+=spe;\n#endif\n\n#ifdef SPOTLIGHT\n\tComputeSpotLight(u_MaterialDiffuse,u_MaterialAmbient,u_MaterialSpecular,u_SpotLight,u_AmbientColor,v_PositionWorld,normal,toEye, dif, amb, spe);\n\tdiffuse+=dif;\n\tambient+=amb;\n\tspecular+=spe;\n#endif\n\n#ifdef RECEIVESHADOW\n\tfloat shadowValue = 1.0;\n\t#ifdef SHADOWMAP_PSSM3\n\t\tshadowValue = getShadowPSSM3( u_shadowMap1,u_shadowMap2,u_shadowMap3,u_lightShadowVP,u_shadowPSSMDistance,u_shadowPCFoffset,v_PositionWorld,v_posViewZ,0.001);\n\t#endif\n\t#ifdef SHADOWMAP_PSSM2\n\t\tshadowValue = getShadowPSSM2( u_shadowMap1,u_shadowMap2,u_lightShadowVP,u_shadowPSSMDistance,u_shadowPCFoffset,v_PositionWorld,v_posViewZ,0.001);\n\t#endif \n\t#ifdef SHADOWMAP_PSSM1\n\t\tshadowValue = getShadowPSSM1( u_shadowMap1,v_lightMVPPos,u_shadowPSSMDistance,u_shadowPCFoffset,v_posViewZ,0.001);\n\t#endif\n#endif\n\n#ifdef AMBIENTMAP\n\t#if defined(DIRECTIONLIGHT)||defined(POINTLIGHT)||defined(SPOTLIGHT)\n\t\tgl_FragColor.rgb=gl_FragColor.rgb*(u_MaterialAmbient+texture2D(u_AmbientTexture, v_LightMapUV).rgb); \n\t#else\n\t\t#if defined(RECEIVESHADOW)\n\t\t\tgl_FragColor.rgb=gl_FragColor.rgb*(u_MaterialAmbient+texture2D(u_AmbientTexture, v_LightMapUV).rgb * shadowValue);\n\t\t#else\n\t\t\tgl_FragColor.rgb=gl_FragColor.rgb*(u_MaterialAmbient+texture2D(u_AmbientTexture, v_LightMapUV).rgb); \n\t\t#endif\n\t#endif\n#endif\n\n#ifdef LIGHTMAP\n\t#if defined(DIRECTIONLIGHT)||defined(POINTLIGHT)||defined(SPOTLIGHT)\n\t\tgl_FragColor.rgb=gl_FragColor.rgb*(u_MaterialAmbient+texture2D(u_LightMap, v_LightMapUV).rgb); \n\t#else\n\t\t#if defined(RECEIVESHADOW)\n\t\t\tgl_FragColor.rgb=gl_FragColor.rgb*(u_MaterialAmbient+texture2D(u_LightMap, v_LightMapUV).rgb * shadowValue);\n\t\t#else\n\t\t\tgl_FragColor.rgb=gl_FragColor.rgb*(u_MaterialAmbient+texture2D(u_LightMap, v_LightMapUV).rgb); \n\t\t#endif\n\t#endif\n#endif\n\ngl_FragColor=gl_FragColor*u_Albedo;\n\n#if defined(DIRECTIONLIGHT)||defined(POINTLIGHT)||defined(SPOTLIGHT)\n\t#if (defined(DIFFUSEMAP)||defined(COLOR))&&defined(SPECULARMAP)\n\t\tspecular =specular*texture2D(u_SpecularTexture, v_Texcoord0).rgb;\n    #endif\n\t#ifdef RECEIVESHADOW\n\t\tgl_FragColor =vec4( gl_FragColor.rgb*(ambient + diffuse*shadowValue) + specular*shadowValue,gl_FragColor.a);\n\t#else\n\t\tgl_FragColor =vec4( gl_FragColor.rgb*(ambient + diffuse) + specular,gl_FragColor.a);\n\t#endif\n#endif\n  \n#ifdef REFLECTMAP\n\tvec3 incident = -toEye;\n\tvec3 reflectionVector = reflect(incident,normal);\n\tvec3 reflectionColor  = textureCube(u_ReflectTexture,reflectionVector).rgb;\n\tgl_FragColor.rgb += u_MaterialReflect*reflectionColor;\n#endif\n  \n#ifdef FOG\n\tfloat lerpFact=clamp((toEyeLength-u_FogStart)/u_FogRange,0.0,1.0);\n\tgl_FragColor.rgb=mix(gl_FragColor.rgb,u_FogColor,lerpFact);\n#endif\n#ifdef DEPTHFOG\n\tfloat lerpFact = (-v_PositionWorld.y-u_FogStart)/u_FogRange;\n\tgl_FragColor.rgb=mix(gl_FragColor.rgb,u_FogColor,lerpFact);\n#endif\n}\n\nvoid main()\n{\n#ifdef CASTSHADOW\t\t\n\tmain_castShadow();\n#else\n  main_normal();\n#endif  \n}\n\n';var a=pt.add(r,e,t,n,i);pn.SHADERDEFINE_DIFFUSEMAP=a.registerMaterialDefine("DIFFUSEMAP"),pn.SHADERDEFINE_NORMALMAP=a.registerMaterialDefine("NORMALMAP"),pn.SHADERDEFINE_SPECULARMAP=a.registerMaterialDefine("SPECULARMAP"),pn.SHADERDEFINE_EMISSIVEMAP=a.registerMaterialDefine("EMISSIVEMAP"),pn.SHADERDEFINE_AMBIENTMAP=a.registerMaterialDefine("AMBIENTMAP"),pn.SHADERDEFINE_REFLECTMAP=a.registerMaterialDefine("REFLECTMAP"),pn.SHADERDEFINE_UVTRANSFORM=a.registerMaterialDefine("UVTRANSFORM"),pn.SHADERDEFINE_TILINGOFFSET=a.registerMaterialDefine("TILINGOFFSET"),n={a_Position:0,a_Color:1},i={u_MvpMatrix:[1,2]};var s=cn.nameKey.add("LINE");e='#include?VR "VRHelper.glsl";\nattribute vec4 a_Position;\nuniform mat4 u_MvpMatrix;\nattribute vec4 a_Color;\nvarying vec4 v_Color;\n\n\nvoid main()\n{\n  gl_Position = u_MvpMatrix * a_Position;\n  v_Color=a_Color;\n}',t="#ifdef HIGHPRECISION\nprecision highp float;\n#else\nprecision mediump float;\n#endif\n\nvarying vec4 v_Color;\n\nvoid main()\n{\n  gl_FragColor=v_Color; \n}\n\n",pt.add(s,e,t,n,i),n={a_position:0,a_normal:3,tangent:5,binormal:4,uv:2,a_BoneWeights:7,a_BoneIndices:6,a_Tangent0:5},i={u_Bones:[0,0],u_lodRect:[9,3],irrad_mat_red:[10,3],irrad_mat_green:[11,3],irrad_mat_blue:[12,3],u_hdrexposure:[13,3],u_aoObjPos:[14,1],texBaseColor:[1,1],texNormal:[2,1],texPbrInfo:[3,1],texPrefilterdEnv:[8,3],texHSNoise:[15,1],texPrefilterDiff:[7,3],u_AlphaTestValue:[0,1],texBRDFLUT:[4,1],u_UVAniAge:[5,1],u_roughness:[6,1],u_metaless:[7,1],u_UVMatrix:[8,1],u_UVAge:[9,1],modelMatrix:[0,2],mvp:[1,2],cameraPosition:[0,3],u_View:[1,3],u_Project:[2,3],u_FogStart:[1,4],u_FogRange:[2,4],u_FogColor:[0,4],"u_DirectionLight.Direction":[3,4],"u_DirectionLight.Diffuse":[4,4],"u_PointLight.Position":[5,4],"u_PointLight.Range":[6,4],"u_PointLight.Attenuation":[7,4],"u_PointLight.Diffuse":[8,4],"u_SpotLight.Position":[9,4],"u_SpotLight.Direction":[10,4],"u_SpotLight.Range":[12,4],"u_SpotLight.Spot":[11,4],"u_SpotLight.Attenuation":[13,4],"u_SpotLight.Diffuse":[14,4],u_shadowMap1:[18,4],u_shadowMap2:[19,4],u_shadowMap3:[20,4],u_shadowPSSMDistance:[15,4],u_lightShadowVP:[16,4],u_shadowPCFoffset:[17,4]};var o=cn.nameKey.add("PBR");e="\nuniform mat4 modelMatrix;\n//uniform mat4 modelViewMatrix;\n//uniform mat4 projectionMatrix;\nuniform mat4 u_View;\nuniform mat4 u_Project;\nuniform mat4 mvp;\n//uniform mat4 viewMatrix;\nuniform vec3 cameraPosition;\n\nattribute vec3 a_position;\nattribute vec3 a_normal;\n#ifdef HAS_TANGENT\nattribute vec3 tangent;\nattribute vec3 binormal;\n#endif\nattribute vec2 uv;\n#ifdef BONE\nattribute vec4 a_BoneIndices;\nattribute vec4 a_BoneWeights;\nconst int c_MaxBoneCount = 24;\nuniform mat4 u_Bones[c_MaxBoneCount];\n#endif\n\nvarying vec2 vUv;\nvarying vec3 vWorldNorm;\nvarying vec4 vViewPos;\nvarying vec4 vWorldPos;\nvarying vec3 vLightDir;\nvarying vec3 vViewDir;\n#ifdef HAS_TANGENT\nvarying vec3 vWorldTangent;\nvarying vec3 vWorldBinormal;\n#endif\n\n#ifdef RECEIVESHADOW\nvarying float v_posViewZ;\n  #ifdef SHADOWMAP_PSSM1 \n  varying vec4 v_lightMVPPos;\n  uniform mat4 u_lightShadowVP[4];\n  #endif\n#endif\n\nvoid main() {\n#ifdef BONE\n\tmat4 skinTransform=mat4(0.0);\n\tskinTransform += u_Bones[int(a_BoneIndices.x)] * a_BoneWeights.x;\n\tskinTransform += u_Bones[int(a_BoneIndices.y)] * a_BoneWeights.y;\n\tskinTransform += u_Bones[int(a_BoneIndices.z)] * a_BoneWeights.z;\n\tskinTransform += u_Bones[int(a_BoneIndices.w)] * a_BoneWeights.w;\n\tgl_Position = mvp*skinTransform*vec4(a_position,1.);\n\tmat4 modelMat = modelMatrix*skinTransform;\n#else\n\tgl_Position = mvp*vec4(a_position,1.);\n\tmat4 modelMat = modelMatrix;\n#endif\t\n\tvWorldPos = modelMat*vec4(a_position,1.);\n\n#ifdef CASTSHADOW \n\t#if defined(DIFFUSEMAP)&&defined(ALPHATEST)\n\t\tvUv = uv;\n\t#endif\t\n#else\n    vUv = uv;\n\tvWorldNorm = normalize((modelMat*vec4(a_normal,0.0)).xyz);\n\t#ifdef HAS_TANGENT\n\tvWorldTangent = normalize((modelMat*vec4(tangent,0.0)).xyz);\n\tvWorldBinormal = normalize((modelMat*vec4(binormal,0.0)).xyz);\n\t#endif\n    \n    vViewDir = (vWorldPos.xyz-cameraPosition);//这个不能normalize。否则无法线性差值了\n#ifdef RECEIVESHADOW\n\tv_posViewZ = gl_Position.z;\n\t#ifdef SHADOWMAP_PSSM1 \n\t\tv_lightMVPPos = u_lightShadowVP[0] * vWorldPos;\n\t#endif\n#endif\t\n#endif\n}\n",t='//#version 300 es\n\nprecision highp float;\nprecision lowp int;\n\nconst float PI = 3.14159265358979323846264;\nconst float _2PI = 6.2831853071796;\nvarying vec2 vUv;\nvarying vec3 vWorldNorm;\n#ifdef HAS_TANGENT\nvarying vec3 vWorldTangent;\nvarying vec3 vWorldBinormal;\n#endif\nvarying vec3 vViewDir;\nvarying vec4 vViewPos;\nvarying vec4 vWorldPos;\n//\nuniform sampler2D texBaseColor;\nuniform sampler2D texNormal;\n//预计算的贴图\nuniform sampler2D texPrefilterdEnv;\nuniform sampler2D texBRDFLUT;\nuniform sampler2D texPrefilterDiff;\n#ifdef HAS_PBRINFO\nuniform sampler2D texPbrInfo;   //Ao, Roughness, Metallic\n#endif\nuniform float u_hdrexposure;\nuniform float u_AlphaTestValue;\n\nuniform float u_roughness;\nuniform float u_metaless;\nconst float maxlv = 7.;\t//现在只支持512分辨率的环境贴图\nconst int nmaxlv = 9;//\n\t\t\t\t\t\t\t\nuniform mat4 irrad_mat_red;\nuniform mat4 irrad_mat_green;\nuniform mat4 irrad_mat_blue;\t\t\t\t\t\t\t\n\nvec3 speccontrib = vec3(0.);\n\nconst float _maxu8 = 255.0;\nconst float _maxu16 = 65535.0;\nconst float _shift8 = 256.0;    //平移的话是*256而不是255\nvec2 _RGBAToU16(const in vec4 rgba){\n    return vec2((rgba.r*_maxu8+rgba.g*_maxu8*_shift8)/_maxu16, (rgba.b*_maxu8+rgba.a*_maxu8*_shift8)/_maxu16);\n}\nvec3 _RGBEToRGB( const in vec4 rgba ){\n    float f = pow(2.0, rgba.w * 255.0 - (128.0 + 8.0));\n    return rgba.rgb * (255.0 * f);\n}\n\nfloat saturate(float v){\n    return min(max(v,0.),1.);\n}\n\nvec4 tex2dLod(sampler2D tex, float u, float v, float lod){\n\tvec2 uv = vec2(u,v);\n\tuv+=mod(gl_FragCoord.xy-vec2(0.5),2.0)*vec2(128.,0.);\n\treturn texture2D(tex,uv,lod-16.);\n}\n\n/*\n* 对一个全景图进行采样。假设x轴指向中心。\n*/\nvec4 texPanorama(sampler2D tex, const in vec3 dir){\n\tfloat envu = atan(dir.z,dir.x)/_2PI+0.5; \t\n\tfloat envv = acos(dir.y)/PI;//(1.0-dir.y)/2.0;\n\treturn texture2D(tex,vec2(envu,envv));\n}\n\nvec4 texPanoramaLod(sampler2D tex, const in vec3 dir, float lod){\n\tfloat envu = atan(dir.z,dir.x)/_2PI+0.5; \t\n\tfloat envv = acos(dir.y)/PI;//(1.0-dir.y)/2.0;\n\treturn tex2dLod(tex,envu,envv,lod);\n}\n\n/*\n    计算sh光照。\n    使用level=2，所以需要9个系数。\n    https://cseweb.ucsd.edu/~ravir/papers/envmap/envmap.pdf\n*/\nfloat environment_exposure = 1.0;\nvec3 diff_sh9(vec3 dir){\n\tvec4 shDir = vec4(dir.x,-dir.z,dir.y,1.0);\n  return max(vec3(0.0), vec3(\n\tdot(shDir, irrad_mat_red * shDir),\n\tdot(shDir, irrad_mat_green * shDir),\n\tdot(shDir, irrad_mat_blue * shDir)\n\t)) * environment_exposure;\t\n}\n\n#ifdef HAS_TANGENT\nvec3 applyNormalTex( vec3 norm, vec3 surf_norm ) {\n    vec3 mapN = norm * 2.0 - 1.0;\n    //mapN.xy = normalScale * mapN.xy;\n    mat3 tsn = mat3( vWorldTangent, vWorldBinormal, surf_norm );\n    return normalize( tsn * mapN );\n}\n#endif\n\nvec4 pbrlight(vec3 normal, float rough, float NoV, vec3 R){\n    vec4 basecolor = texture2D(texBaseColor,vUv);\n\tbasecolor.rgb = pow(basecolor.rgb,vec3(2.2));\n\tfloat metaless = 1.0; \t\n\tconst float ismetalinfov = (128./255.);\n\tif(basecolor.a>=ismetalinfov){//这时候表示金属度\n\t\tmetaless = (basecolor.a-ismetalinfov)*2.;\n\t\tbasecolor.a = 1.0;\n\t}else{\n\t\tmetaless = 0.;\n\t\tbasecolor.a = basecolor.a*2.0;\n\t}\n\t#ifdef FIX_METALESS\n\tmetaless = u_metaless;\n\t#endif\n\t#ifdef HAS_PBRINFO\t\n\tvec4 pbrinfo = texture2D(texPbrInfo, vUv);\n\tmetaless = pbrinfo.b;\n\trough = pbrinfo.g;\n\t#endif\n    const vec3 nonmetalF0 =vec3(0.02);\n    vec3 F0 =  mix(nonmetalF0, basecolor.rgb, metaless);\n\t\n    vec4 PrefilteredColor = texPanoramaLod(texPrefilterdEnv, R, rough*maxlv);\n    PrefilteredColor.rgb = _RGBEToRGB(PrefilteredColor);\n    vec4 EnvBRDF = texture2D(texBRDFLUT,vec2(rough , NoV));//TODO lod\n    vec2 rg = _RGBAToU16(EnvBRDF);    \n    speccontrib = (F0* rg.x + saturate( 50.0 * PrefilteredColor.g ) * rg.y);\n\tvec3 color_spec = PrefilteredColor.rgb*speccontrib;\n\t\n\tvec3 color_diff=diff_sh9(normal);\n\tvec3 outc =  color_diff*mix(basecolor.rgb,vec3(0.),metaless)*(vec3(1.0)-speccontrib)+color_spec;\n\t#ifdef HAS_PBRINFO\n\toutc*=pbrinfo.r;\n\t#endif\n\treturn vec4(outc, basecolor.a);\n}\n\nvec3 oldlight(vec4 normal, float NoV, vec3 R){\n    vec4 basecolor = texture2D(texBaseColor,vUv);\n\tconst vec3 lightdir=normalize(vec3(1.,1.,0.));\n\tconst vec3 spcecol = vec3(1.,0.8,0.8);\n\tconst vec3 amb = vec3(0.5);\n\tvec3 diffv =  (vec3(saturate(dot(lightdir,normal.xyz)))+amb);\n\t//vec3 spec = spcecol* pow(saturate(dot(R,lightdir)),(1.-pbrinfo.g)*5.);\n\treturn diffv*basecolor.rgb;//+spec;\n}\n\n#include "ShadowHelper.glsl"\n#ifdef RECEIVESHADOW\nvarying float v_posViewZ;\n\t#if defined(SHADOWMAP_PSSM2)||defined(SHADOWMAP_PSSM3)\n\tuniform mat4 u_lightShadowVP[4];\n\t#endif\n\t#ifdef SHADOWMAP_PSSM1 \n\tvarying vec4 v_lightMVPPos;\n\t#endif\n#endif\n\nvoid main() {\n#ifdef CASTSHADOW\n\tgl_FragColor=packDepth(gl_FragCoord.w);\n\t#if defined(DIFFUSEMAP)&&defined(ALPHATEST)\n\t\tfloat alpha = texture2D(texBaseColor,vUv).w;\n\t\tif( alpha < u_AlphaTestValue ){\n\t\t\tdiscard;\n\t\t}\n\t#endif\n#else\n\n\t#ifdef RECEIVESHADOW\n\t\tfloat shadowValue = 1.0;\n\t\t#ifdef SHADOWMAP_PSSM3\n\t\t\tshadowValue = getShadowPSSM3( u_shadowMap1,u_shadowMap2,u_shadowMap3,u_lightShadowVP,u_shadowPSSMDistance,u_shadowPCFoffset,vWorldPos.xyz,v_posViewZ,0.0001);\n\t\t#endif\n\t\t#ifdef SHADOWMAP_PSSM2\n\t\t\tshadowValue = getShadowPSSM2( u_shadowMap1,u_shadowMap2,u_lightShadowVP,u_shadowPSSMDistance,u_shadowPCFoffset,vWorldPos.xyz,v_posViewZ,0.0001);\n\t\t#endif \n\t\t#ifdef SHADOWMAP_PSSM1\n\t\t\tshadowValue = getShadowPSSM1( u_shadowMap1,v_lightMVPPos,u_shadowPSSMDistance,u_shadowPCFoffset,v_posViewZ,0.0001);\n\t\t#endif\n\t#endif\t\n\t\n    vec3 normal =  normalize(vWorldNorm);\n\tvec4 normtex = texture2D( texNormal, vUv );\n\t#ifdef HAS_TANGENT\t\n\tnormal = applyNormalTex(normtex.xyz, normal);\n\t#endif\n    vec3 view   = -normalize(vViewDir);\n    float NoV = saturate(dot( view, normal ));\n    vec3 R = 2. * NoV * normal - view;\n\tfloat roughness = normtex.a;\n\t#ifdef FIX_ROUGHNESS\n\troughness = u_roughness;\n\t#endif\n\t\n\tvec4 pbrl = pbrlight(normal,roughness,NoV,R)*u_hdrexposure;\n    gl_FragColor.rgb =  pow(pbrl.rgb,vec3(0.45455));\n\t//gl_FragColor.rgb = oldlight(normtex,NoV,R);\n\t#ifdef RECEIVESHADOW\n\tgl_FragColor.rgb *= max(shadowValue,0.7);\n\t#endif\n\t\n    gl_FragColor.a = pbrl.a;\n\n#endif\n}\n',a=pt.add(o,e,t,n,i),mn.SHADERDEFINE_FIX_METALESS=a.registerMaterialDefine("FIX_METALESS"),mn.SHADERDEFINE_FIX_ROUGHNESS=a.registerMaterialDefine("FIX_ROUGHNESS"),mn.SHADERDEFINE_HAS_TANGENT=a.registerMaterialDefine("HAS_TANGENT"),mn.SHADERDEFINE_HAS_PBRINFO=a.registerMaterialDefine("HAS_PBRINFO"),mn.SHADERDEFINE_USE_GROUNDTRUTH=a.registerMaterialDefine("USE_GROUNDTRUTH"),mn.SHADERDEFINE_TEST_CLIPZ=a.registerMaterialDefine("CLIPZ"),n={a_position:0,a_normal:3,uv:2},i={irrad_mat_red:[10,3],irrad_mat_green:[11,3],irrad_mat_blue:[12,3],u_hdrexposure:[13,3],texBaseColor:[1,1],texNormal:[2,1],texSky:[11,1],texUnderWater:[3,1],texPrefilterdEnv:[8,3],texPrefilterDiff:[7,3],texWaterDisp:[4,1],texWaveDetail:[9,1],texDeepColor:[10,1],texWaterInfo:[16,1],texFoam:[17,1],GEOWAVE_UV_SCALE:[18,1],modelMatrix:[0,2],mvp:[1,2],cameraPosition:[0,3],u_curTm:[8,1],u_scrsize:[15,1],u_WaveInfoD:[13,1],u_WaveInfo:[12,1],u_WaveMainDir:[14,1],u_DeepScale:[20,1],u_SeaColor:[19,1],u_View:[1,3],u_Project:[2,3],u_FogStart:[1,4],u_FogRange:[2,4],u_FogColor:[0,4],"u_DirectionLight.Direction":[3,4],"u_DirectionLight.Diffuse":[4,4],"u_PointLight.Position":[5,4],"u_PointLight.Range":[6,4],"u_PointLight.Attenuation":[7,4],"u_PointLight.Diffuse":[8,4],"u_SpotLight.Position":[9,4],"u_SpotLight.Direction":[10,4],"u_SpotLight.Range":[12,4],"u_SpotLight.Spot":[11,4],"u_SpotLight.Attenuation":[13,4],"u_SpotLight.Diffuse":[14,4]};var l=cn.nameKey.add("Water");e='\nuniform mat4 modelMatrix;\n//uniform mat4 modelViewMatrix;\n//uniform mat4 projectionMatrix;\nuniform mat4 u_View;\nuniform mat4 u_Project;\nuniform mat4 mvp;\n//uniform mat4 viewMatrix;\nuniform vec3 cameraPosition;\nuniform float u_curTm;\n\nattribute vec3 a_position;\nattribute vec3 a_normal;\nattribute vec2 uv;\n//uniform sampler2D texWaterDisp;\n#ifdef USE_VERTEX_DEEPINFO\n#else\nuniform sampler2D texWaterInfo;\nvarying vec4 vWaterInfo;\nuniform float u_DeepScale;//texWaterInfo.r*vDeepScale\n#endif\nuniform float u_WaveMainDir;\t//主波方向\nuniform float GEOWAVE_UV_SCALE ;//= 100.0;\n\n\nvarying vec2 vUv;\nvarying vec3 vWorldNorm;\nvarying vec3 vWorldTan;\nvarying vec3 vWorldBin;\nvarying vec4 vViewPos;\nvarying vec4 vWorldPos;\nvarying vec3 vLightDir;\nvarying vec3 vViewDir;\nvarying vec3 vDisp;\nvarying float fDeep;\nvarying mat2 matUVTrans;\nvarying float fFoam;\n\nconst float PI = 3.14159265358979323846264;\n\n#include "WaveFunction.glsl"\n\nvec2 getPosFromUV(vec2 uv){\n\treturn uv*50.;\n}\n\nvoid main() {\n\tvec3 pos = a_position;\n    vUv = uv;\n\t\n\t//vDisp = texture2D(texWaterDisp,uv).rgb;\n\t//vec3 disp = vDisp;\n\t\n\t//TODO 这里有个潜规则。\n\tfloat tt = pos.y; pos.y=pos.z; pos.z=-tt;\n\t\n\t#ifdef USE_VERTEX_DEEPINFO\n\tfDeep = -pos.y;\n\tpos.y=0.0;\n\t#else\n\tvWaterInfo = texture2D(texWaterInfo,uv);\n\tfDeep = vWaterInfo.r*u_DeepScale;\n\t#endif\n\t\n\t\n\t//计算波形\n\tmat4 modelMat = modelMatrix;\n\tvec3 opos, T,B,N;\n\tfloat foams=0.;\n\tvec2 uvpos = uv*GEOWAVE_UV_SCALE+vec2(modelMat[3][0],0.);//TODO 如果有旋转缩放怎么办\n\tcalcGerstnerWave(u_curTm, pos,fDeep, uvpos,opos,B,T,N,foams);\n\tfFoam = foams;\n\tgl_Position = mvp*vec4(opos,1.);\n\tvWorldPos = modelMat*vec4(opos,1.);\n\n\tvWorldNorm = normalize((modelMatrix*vec4(N,0.0)).xyz);\n\tvWorldTan = normalize((modelMatrix*vec4(T,0.0)).xyz);\n\tvWorldBin = normalize((modelMatrix*vec4(B,0.0)).xyz);\n    vViewDir = vWorldPos.xyz-cameraPosition; //这个不能取normalize，否则会引入非线性\n\t\n\tfloat s = sin(u_WaveMainDir);\n\tfloat c = cos(u_WaveMainDir);\n\tmatUVTrans = mat2(c,-s,s,c);\n}\n',t="//#version 300 es\n\nprecision highp float;\nprecision lowp int;\n\nconst float PI = 3.14159265358979323846264;\nconst float _2PI = 6.2831853071796;\nvarying vec2 vUv;\nvarying vec3 vWorldNorm;\nvarying vec3 vWorldTan;\nvarying vec3 vWorldBin;\nvarying vec3 vViewDir;//入射。pos-cam\nvarying vec4 vViewPos;\nvarying vec4 vWorldPos;\nvarying float fDeep;\nvarying mat2 matUVTrans;\n#ifdef USE_VERTEX_DEEPINFO\n#else\nvarying vec4 vWaterInfo;\n#endif\nmat3 matTBNOff;//\n\n//\nuniform sampler2D texBaseColor;\nuniform sampler2D texNormal;\n#ifdef CUBE_ENV\nuniform samplerCube texSky;\n#else\nuniform sampler2D texSky;\n#endif\nuniform sampler2D texUnderWater;\nuniform sampler2D texWaveDetail;\n//uniform sampler2D texDeepColor;\nuniform sampler2D texFoam;\nvarying float fFoam;\nuniform float u_curTm;\nuniform vec2 u_scrsize;\nuniform vec3 u_SeaColor;//\n\nconst int NumTexWaves=4;\nconst float Amp_over_L = 0.01;\n//const vec3 SEA_COLOR1 = vec3(0.0292,0.672,0.7467);//大洋\n//const vec3 SEA_COLOR2 = vec3(0,0.927,0.43);//近海\n\nconst float _maxu8 = 255.0;\nconst float _maxu16 = 65535.0;\nconst float _shift8 = 256.0;    //平移的话是*256而不是255\nvec2 _RGBAToU16(const in vec4 rgba){\n    return vec2((rgba.r*_maxu8+rgba.g*_maxu8*_shift8)/_maxu16, (rgba.b*_maxu8+rgba.a*_maxu8*_shift8)/_maxu16);\n}\nvec3 _RGBEToRGB( const in vec4 rgba ){\n    float f = pow(2.0, rgba.w * 255.0 - (128.0 + 8.0));\n    return rgba.rgb * (255.0 * f);\n}\n\nfloat saturate(float v){\n    return min(max(v,0.),1.);\n}\n\n/*\n\t各种 ToneMap\n*/\n//Reinhard\nvec3 ReinhardToneMapping(vec3 color, float adapted_lum) {\n    const float MIDDLE_GREY = 1.;\n    color *= MIDDLE_GREY / adapted_lum;\n    return color / (1.0 + color);\n}\n\n//CE2\nvec3 CEToneMapping(vec3 color, float adapted_lum){\n    return 1. - exp(-adapted_lum * color);\n}\n\n//UC2\nvec3 F1(vec3 x){\n\tconst float A = 0.22;\n\tconst float B = 0.30;\n\tconst float C = 0.10;\n\tconst float D = 0.20;\n\tconst float E = 0.01;\n\tconst float F = 0.30;\n \n\treturn ((x * (A * x + C * B) + D * E) / (x * (A * x + B) + D * F)) - E / F;\n}\n\nvec3 Uncharted2ToneMapping(vec3 color, float adapted_lum){\n\tconst vec3 WHITE = vec3(11.2);\n\treturn F1(1.6 * adapted_lum * color) / F1(WHITE);\n}\n\n//ACES\nvec3 ACESToneMapping(vec3 color, float adapted_lum){\n\tconst float A = 2.51;\n\tconst float B = 0.03;\n\tconst float C = 2.43;\n\tconst float D = 0.59;\n\tconst float E = 0.14;\n\n\tcolor *= adapted_lum;\n\treturn (color * (A * color + B)) / (color * (C * color + D) + E);\n}\n\n/*\n* 对一个全景图进行采样。假设x轴指向中心。\n*/\nvec4 texPanorama(sampler2D tex, const in vec3 dir){\n\tfloat envu = atan(dir.z,dir.x)/_2PI+0.5; \t\n\tfloat envv = acos(dir.y)/PI;//(1.0-dir.y)/2.0;\n\treturn texture2D(tex,vec2(envu,envv));\n}\n\n/*\n\t与位于0点的测试棒的相交测试交点\n\t这个是瞎写的，只是为了测试\n*/\nbool hitClydiner(vec3 pos, vec3 dir, out vec3 hitpos, out vec3 hitnormal){\n\tconst float r = 0.5;\n\tfloat a = dir.x*dir.x+dir.z*dir.z;\n\tfloat b = 2.*dir.x*pos.x+2.*dir.z*pos.z;\n\tfloat c = pos.x*pos.x+pos.z*pos.z-r*r;\n\tfloat d = b*b-4.*a*c;\n\tif(d>=0.0){\n\t\tfloat t = (-b+sqrt(d))/2./a;\n\t\tt =min(t, (-b-sqrt(d))/2./a);\n\t\thitpos = pos+dir*t;\n\t\treturn true;\n\t}\n\t/*\n\tvec3 v1 = normalize(cross(dir,vec3(0.,1.,0.)));//公垂线\n\tfloat dist = dot(pos,v1);//最短距离\n\tif(abs(dist)<r){\n\t\treturn true;\n\t}\n\t*/\n\treturn false;\n}\n\n///* 根据散射公式来计算某个方向的颜色 *///\n//\nfloat phase_function(float costheta, float g, float g2){\n\treturn 1.5*( (1.0-g2) / (2.0+g2) ) * (1.0+costheta*costheta) / pow(1.0+g2-2.0*g*costheta, 1.5);\t\n}\n\nconst float _density = .2;\nconst vec3 _vLightDir=vec3(0.,-1.,0.);//必须是规格化的\nconst int _SAMPLENUM = 20;\nconst float _K1 = 1.0;\nconst float _g = -0.93;\n//\nvec3 calcScatter(vec3 start, vec3 dir, vec3 end){\n\tfloat len = length(end-start);\n\tfloat costheta = dot(dir,_vLightDir);\n\tfloat g2 = _g*_g;\n\tfloat K = _K1*len*_density*phase_function(costheta,_g,g2);\n\t//用分段的方式来积分\n\tfloat dlen = len/float(_SAMPLENUM);//距离平分\n\tfloat ddeep = (start.y-end.y)/float(_SAMPLENUM);//深度平分\n\tfloat sum=0.;\n\tfor( int i=0; i<_SAMPLENUM; i++){\n\t\tfloat fi = float(i);\n\t\tfloat v1 = exp(-_density*(dlen+ddeep)*fi);//TODO 应该可以用分析法计算出来\n\t\tsum += v1;\n\t}\n\treturn vec3(K*sum);\n}\n///* 根据散射公式来计算某个方向的亮度  END *///\n\nconst float cDeep = -2.;\t//假设水的深度\nvec3 getShuiDiColor(vec3 pos, vec3 dir, vec3 normal){\n\t//一个无限大的水底，黑白格纹理。纹理长度为1米\n\tfloat t = ( cDeep-pos.y )/dir.y;\n\tif(t<0.) return vec3(1.,0.,0.);//TEST\n\tbool bhit = false;\n\tvec3 hitpos;\n\tvec3 hitcolor;\n\tvec3 hn;\n\tif(hitClydiner(pos,dir,hitpos,hn) && hitpos.y>cDeep && hitpos.y<pos.y){\n\t\tbhit=true;\n\t\thitcolor = vec3(.8,.8,.8);\n\n\t}else\n\t{\n\t\thitpos = pos+dir*t;\n\t\tvec3 hp = floor(hitpos);\n\t\tfloat a = mod((hp.x+hp.z),2.);\n\t\thitcolor = (a<.9)?vec3(0.,0.,0.):vec3(1.,1.,1.);\n\t\t//hitcolor = texture2D(texUnderWater,hitpos.xz/10.).rgb;\n\t}\n\t\n\tfloat l = length(hitpos-pos);\n\t//return texture2D(texDeepColor,vec2(min(max(l/400.,0.),1.),0.5)).rgb;\n\t//return SEA_COLOR1*calcScatter(pos,dir,hitpos);\n\tfloat left = pow(0.8,l);//假设透过率为80%，则到达水底的时候的光强。\n\treturn mix(hitcolor,u_SeaColor,1.-left);\n}\n\n/*\n\tview已经normalize了\n*/\nvec3 getRefractColor(vec3 view,vec3 normal){\n\tvec3 T = refract(-view, normal, 0.7);\n\treturn getShuiDiColor(vWorldPos.xyz,T,normal); \n}\n\nvec4 calcWaterC(vec3 view, vec3 normal, float von, vec3 R, float rough){\n\t/*\n\t只有浪顶的法线向下，也就是波形形成了交叠的时候，才会这样，所以要通过参数控制避免出现这种情况，而不是在这里保护。\n\tif(dot(R,vec3(0.,1.,0.))<0.){\n\t\tR = -R;\n\t}\n\t*/\n\t//vec3 refr = getRefractColor(-view,normal);\n#ifdef USE_REFR_TEX\t\n\tvec3 refr = texture2D(texUnderWater, gl_FragCoord.xy/u_scrsize+normal.xz/8.).rgb;\n#else\n\tvec3 refr = u_SeaColor;\n#endif\n\tfloat F0=0.02;\n\t//菲涅尔，越大反射越强\n\tfloat f =  F0+(1.0-F0)*exp2((-5.55473*von-6.98316)*von);\n\t//float f = F0+(1.0-F0)*pow(1.-von,5.);\n\t//能看到水底的程度。反射剩余的*水中的衰减\n\t//float a = (1.-f)*(1.-deepk);\n#ifdef CUBE_ENV\n\tvec4 reflc = textureCube(texSky,R);\n#else\n\tvec4 reflc = texPanorama(texSky, R);\n#endif\n#ifdef HDR_ENV\n\tvec3 refl = _RGBEToRGB(reflc)*f;\n#else\n\tvec3 refl = reflc.rgb*f;\n#endif\n\t//return vec4(refl*(1.-rough),1.);\n\t\n\t//vec3 refl = reflc.rgb*f;\n\tvec3 final = mix(refr, u_SeaColor, min(fDeep/10.,1.))+refl*(max(0.,1.-rough));\n#ifdef HDR_ENV\n\tfinal = ACESToneMapping(final,1.);//TODO 这个要uniform传入\n#endif\n\treturn vec4(final,f);\n}\n\nvoid main() {\n    vec3 normal =  normalize(vWorldNorm);\n\t//如果uv=1为100米，希望每个细节纹理表示20米的小波形，则uv缩放是 100/20。细节纹理内部也要用这个值，即pos=uv*20\n\tvec2 ruv = matUVTrans*vUv;\n\tvec3 detailNorm = texture2D(texWaveDetail,fract(ruv*5.)).rgb*2.-vec3(1.);//TODO uv怎么算\n\tfloat texNormScale = 2.*PI*float(NumTexWaves)*Amp_over_L*2.5;\n\tdetailNorm *= vec3(texNormScale,1.,texNormScale);\n\t//旋转\n\t//细节纹理来自rendertarget，因此需要颠倒z\n\t\n\tmatTBNOff = mat3(matUVTrans[0][0],0.,matUVTrans[1][0],\n\t0.,1.,0.,\n\tmatUVTrans[0][1],0.,matUVTrans[1][1]\n\t);\n\t\n\t/*\n\tmatTBNOff = mat3(0.,0.,1.,\n\t0.,1.,0.,\n\t-1.,0.,0.\n\t);\n\t*/\n\n    mat3 tsn = mat3( vWorldBin, normal, vWorldTan);\t\n    //normal = normalize(tsn * matTBNOff * detailNorm);\n\tnormal = normalize(tsn * detailNorm); //这个应该更正确。因为本身方向就是根据uv算的，如果是静态图片才需要转换。\n\t//vec4 normtex = texture2D( texNormal, vUv );\n    vec3 view   = -normalize(vViewDir);//view 是指向camera的\n    float NoV = saturate(dot( view, normal ));\n    //vec3 R = 2. * NoV * normal - view;\n\t\n#ifdef USE_FOAM\t\n\tvec4 foamc = (texture2D(texFoam,vUv*50.)+texture2D(texFoam,vUv*20.))/2.;\n\tfloat nearcoast = 1.-min(fDeep/10.,1.);// 1.-vWaterInfo.r;\n\tfloat foams = (nearcoast/4.+fFoam)*2.*nearcoast;\n#else\n\tfloat foams =0.;\n#endif\n\t\n\tvec3 R = reflect(-view,normal);\n\tvec4 wc = calcWaterC(view, normal,NoV,R, foams);\n\n\tgl_FragColor.rgb = wc.rgb;//normalize(detailNorm).rrr;//((normal)+vec3(0.0))/1.;//normalize(normal).rgb;//texture2D(texWaveDetail,vUv).rgb;// fracColor * texture2D(texUnderWater, vUv*20.0).rgb;// vec3(1.0);//pbrl.rgb;\n    gl_FragColor.a = 1.0;//wc.a;\n#ifdef USE_FOAM\n\tgl_FragColor.rgb = mix(gl_FragColor.rgb,vec3(1.),foamc.a*foams);\n\tgl_FragColor.a = foamc.r;\n#endif\n\t//if(mod(vUv.x*100.,1.0)<0.02 || mod(vUv.y*100.,1.0)<0.02) gl_FragColor.rgb=vec3(0.5,.5,.5);\n\t//gl_FragColor.rgb = detailNorm;\n}\n",a=pt.add(l,e,t,n,i),gn.SHADERDEFINE_CUBE_ENV=a.registerMaterialDefine("CUBE_ENV"),gn.SHADERDEFINE_HDR_ENV=a.registerMaterialDefine("HDR_ENV"),gn.SHADERDEFINE_SHOW_NORMAL=a.registerMaterialDefine("SHOW_NORMAL"),gn.SHADERDEFINE_USEVERTEXHEIGHT=a.registerMaterialDefine("USE_VERTEX_DEEPINFO"),gn.SHADERDEFINE_USE_FOAM=a.registerMaterialDefine("USE_FOAM"),gn.SHADERDEFINE_USE_REFRACT_TEX=a.registerMaterialDefine("USE_REFR_TEX"),n={a_CornerTextureCoordinate:17,a_MeshPosition:0,a_MeshTextureCoordinate:2,a_ShapePositionStartLifeTime:30,a_DirectionTime:32,a_StartColor:19,a_EndColor:23,a_StartSize:20,a_StartRotation0:22,a_StartSpeed:31,a_Random0:34,a_Random1:35,a_SimulationWorldPostion:36,a_SimulationWorldRotation:37},i={u_Tintcolor:[2,1],u_texture:[1,1],u_WorldPosition:[0,2],u_WorldRotation:[1,2],u_PositionScale:[4,2],u_SizeScale:[5,2],u_ScalingMode:[6,2],u_Gravity:[7,2],u_ThreeDStartRotation:[8,2],u_StretchedBillboardLengthScale:[9,2],u_StretchedBillboardSpeedScale:[10,2],u_SimulationSpace:[11,2],u_CurrentTime:[12,2],u_ColorOverLifeGradientAlphas:[22,2],u_ColorOverLifeGradientColors:[23,2],u_MaxColorOverLifeGradientAlphas:[24,2],u_MaxColorOverLifeGradientColors:[25,2],u_VOLVelocityConst:[13,2],u_VOLVelocityGradientX:[14,2],u_VOLVelocityGradientY:[15,2],u_VOLVelocityGradientZ:[16,2],u_VOLVelocityConstMax:[17,2],u_VOLVelocityGradientMaxX:[18,2],u_VOLVelocityGradientMaxY:[19,2],u_VOLVelocityGradientMaxZ:[20,2],u_VOLSpaceType:[21,2],u_SOLSizeGradient:[26,2],u_SOLSizeGradientX:[27,2],u_SOLSizeGradientY:[28,2],u_SOLSizeGradientZ:[29,2],u_SOLSizeGradientMax:[30,2],u_SOLSizeGradientMaxX:[31,2],u_SOLSizeGradientMaxY:[32,2],u_SOLSizeGradientMaxZ:[33,2],u_ROLAngularVelocityConst:[34,2],u_ROLAngularVelocityConstSeprarate:[35,2],u_ROLAngularVelocityGradient:[36,2],u_ROLAngularVelocityGradientX:[37,2],u_ROLAngularVelocityGradientY:[38,2],u_ROLAngularVelocityGradientZ:[39,2],u_ROLAngularVelocityGradientW:[40,2],u_ROLAngularVelocityConstMax:[41,2],u_ROLAngularVelocityConstMaxSeprarate:[42,2],u_ROLAngularVelocityGradientMax:[43,2],u_ROLAngularVelocityGradientMaxX:[44,2],u_ROLAngularVelocityGradientMaxY:[45,2],u_ROLAngularVelocityGradientMaxZ:[46,2],u_ROLAngularVelocityGradientMaxW:[47,2],u_TSACycles:[48,2],u_TSASubUVLength:[49,2],u_TSAGradientUVs:[50,2],u_TSAMaxGradientUVs:[51,2],u_CameraPosition:[0,3],u_CameraDirection:[5,3],u_CameraUp:[6,3],u_View:[1,3],u_Projection:[2,3],u_FogStart:[1,4],u_FogRange:[2,4],u_FogColor:[0,4]};var h=cn.nameKey.add("PARTICLESHURIKEN");e="#ifdef HIGHPRECISION\n  precision highp float;\n#else\n  precision mediump float;\n#endif\n\n#ifdef defined(SPHERHBILLBOARD)||defined(STRETCHEDBILLBOARD)||defined(HORIZONTALBILLBOARD)||defined(VERTICALBILLBOARD)\n\tattribute vec4 a_CornerTextureCoordinate;\n#endif\n#ifdef RENDERMODE_MESH\n\tattribute vec3 a_MeshPosition;\n\tattribute vec2 a_MeshTextureCoordinate;\n#endif\n\nattribute vec4 a_ShapePositionStartLifeTime;\nattribute vec4 a_DirectionTime;\nattribute vec4 a_StartColor;\nattribute vec3 a_StartSize;\nattribute vec3 a_StartRotation0;\nattribute float a_StartSpeed;\n#ifdef defined(COLOROVERLIFETIME)||defined(RANDOMCOLOROVERLIFETIME)||defined(SIZEOVERLIFETIMERANDOMCURVES)||definedSIZEOVERLIFETIMERANDOMCURVESSEPERATE||defined(ROTATIONOVERLIFETIMERANDOMCONSTANTS)||defined(ROTATIONOVERLIFETIMERANDOMCURVES)\n  attribute vec4 a_Random0;\n#endif\n#ifdef TEXTURESHEETANIMATIONRANDOMCURVE||defined(VELOCITYOVERLIFETIMERANDOMCONSTANT)||defined(VELOCITYOVERLIFETIMERANDOMCURVE)\n  attribute vec4 a_Random1;\n#endif\nattribute vec3 a_SimulationWorldPostion;\nattribute vec4 a_SimulationWorldRotation;\n\nvarying float v_Discard;\nvarying vec4 v_Color;\n#ifdef DIFFUSEMAP\n\tvarying vec2 v_TextureCoordinate;\n#endif\n\nuniform float u_CurrentTime;\nuniform vec3 u_Gravity;\n\nuniform vec3 u_WorldPosition;\nuniform vec4 u_WorldRotation;\nuniform bool u_ThreeDStartRotation;\nuniform int u_ScalingMode;\nuniform vec3 u_PositionScale;\nuniform vec3 u_SizeScale;\nuniform mat4 u_View;\nuniform mat4 u_Projection;\n\n#ifdef STRETCHEDBILLBOARD\n\tuniform vec3 u_CameraPosition;\n#endif\nuniform vec3 u_CameraDirection;//TODO:只有几种广告牌模式需要用\nuniform vec3 u_CameraUp;\n\nuniform  float u_StretchedBillboardLengthScale;\nuniform  float u_StretchedBillboardSpeedScale;\nuniform int u_SimulationSpace;\n\n#ifdef defined(VELOCITYOVERLIFETIMECONSTANT)||defined(VELOCITYOVERLIFETIMECURVE)||defined(VELOCITYOVERLIFETIMERANDOMCONSTANT)||defined(VELOCITYOVERLIFETIMERANDOMCURVE)\n  uniform  int  u_VOLSpaceType;\n#endif\n#ifdef defined(VELOCITYOVERLIFETIMECONSTANT)||defined(VELOCITYOVERLIFETIMERANDOMCONSTANT)\n  uniform  vec3 u_VOLVelocityConst;\n#endif\n#ifdef defined(VELOCITYOVERLIFETIMECURVE)||defined(VELOCITYOVERLIFETIMERANDOMCURVE)\n  uniform  vec2 u_VOLVelocityGradientX[4];//x为key,y为速度\n  uniform  vec2 u_VOLVelocityGradientY[4];//x为key,y为速度\n  uniform  vec2 u_VOLVelocityGradientZ[4];//x为key,y为速度\n#endif\n#ifdef VELOCITYOVERLIFETIMERANDOMCONSTANT\n  uniform  vec3 u_VOLVelocityConstMax;\n#endif\n#ifdef VELOCITYOVERLIFETIMERANDOMCURVE\n  uniform  vec2 u_VOLVelocityGradientMaxX[4];//x为key,y为速度\n  uniform  vec2 u_VOLVelocityGradientMaxY[4];//x为key,y为速度\n  uniform  vec2 u_VOLVelocityGradientMaxZ[4];//x为key,y为速度\n#endif\n\n#ifdef COLOROVERLIFETIME\n  uniform  vec4 u_ColorOverLifeGradientColors[4];//x为key,yzw为Color\n  uniform  vec2 u_ColorOverLifeGradientAlphas[4];//x为key,y为Alpha\n#endif\n#ifdef RANDOMCOLOROVERLIFETIME\n  uniform  vec4 u_ColorOverLifeGradientColors[4];//x为key,yzw为Color\n  uniform  vec2 u_ColorOverLifeGradientAlphas[4];//x为key,y为Alpha\n  uniform  vec4 u_MaxColorOverLifeGradientColors[4];//x为key,yzw为Color\n  uniform  vec2 u_MaxColorOverLifeGradientAlphas[4];//x为key,y为Alpha\n#endif\n\n\n#ifdef defined(SIZEOVERLIFETIMECURVE)||defined(SIZEOVERLIFETIMERANDOMCURVES)\n  uniform  vec2 u_SOLSizeGradient[4];//x为key,y为尺寸\n#endif\n#ifdef SIZEOVERLIFETIMERANDOMCURVES\n  uniform  vec2 u_SOLSizeGradientMax[4];//x为key,y为尺寸\n#endif\n#ifdef defined(SIZEOVERLIFETIMECURVESEPERATE)||defined(SIZEOVERLIFETIMERANDOMCURVESSEPERATE)\n  uniform  vec2 u_SOLSizeGradientX[4];//x为key,y为尺寸\n  uniform  vec2 u_SOLSizeGradientY[4];//x为key,y为尺寸\n  uniform  vec2 u_SOLSizeGradientZ[4];//x为key,y为尺寸\n#endif\n#ifdef SIZEOVERLIFETIMERANDOMCURVESSEPERATE\n  uniform  vec2 u_SOLSizeGradientMaxX[4];//x为key,y为尺寸\n  uniform  vec2 u_SOLSizeGradientMaxY[4];//x为key,y为尺寸\n  uniform  vec2 u_SOLSizeGradientMaxZ[4];//x为key,y为尺寸\n#endif\n\n\n#ifdef ROTATIONOVERLIFETIME\n  #ifdef defined(ROTATIONOVERLIFETIMECONSTANT)||defined(ROTATIONOVERLIFETIMERANDOMCONSTANTS)\n    uniform  float u_ROLAngularVelocityConst;\n  #endif\n  #ifdef ROTATIONOVERLIFETIMERANDOMCONSTANTS\n    uniform  float u_ROLAngularVelocityConstMax;\n  #endif\n  #ifdef defined(ROTATIONOVERLIFETIMECURVE)||defined(ROTATIONOVERLIFETIMERANDOMCURVES)\n    uniform  vec2 u_ROLAngularVelocityGradient[4];//x为key,y为旋转\n  #endif\n  #ifdef ROTATIONOVERLIFETIMERANDOMCURVES\n    uniform  vec2 u_ROLAngularVelocityGradientMax[4];//x为key,y为旋转\n  #endif\n#endif\n#ifdef ROTATIONOVERLIFETIMESEPERATE\n  #ifdef defined(ROTATIONOVERLIFETIMECONSTANT)||defined(ROTATIONOVERLIFETIMERANDOMCONSTANTS)\n    uniform  vec4 u_ROLAngularVelocityConstSeprarate;\n  #endif\n  #ifdef ROTATIONOVERLIFETIMERANDOMCONSTANTS\n    uniform  vec4 u_ROLAngularVelocityConstMaxSeprarate;\n  #endif\n  #ifdef defined(ROTATIONOVERLIFETIMECURVE)||defined(ROTATIONOVERLIFETIMERANDOMCURVES)\n    uniform  vec2 u_ROLAngularVelocityGradientX[4];\n    uniform  vec2 u_ROLAngularVelocityGradientY[4];\n    uniform  vec2 u_ROLAngularVelocityGradientZ[4];\n\tuniform  vec2 u_ROLAngularVelocityGradientW[4];\n  #endif\n  #ifdef ROTATIONOVERLIFETIMERANDOMCURVES\n    uniform  vec2 u_ROLAngularVelocityGradientMaxX[4];\n    uniform  vec2 u_ROLAngularVelocityGradientMaxY[4];\n    uniform  vec2 u_ROLAngularVelocityGradientMaxZ[4];\n\tuniform  vec2 u_ROLAngularVelocityGradientMaxW[4];\n  #endif\n#endif\n\n#ifdef defined(TEXTURESHEETANIMATIONCURVE)||defined(TEXTURESHEETANIMATIONRANDOMCURVE)\n  uniform  float u_TSACycles;\n  uniform  vec2 u_TSASubUVLength;\n  uniform  vec2 u_TSAGradientUVs[4];//x为key,y为frame\n#endif\n#ifdef TEXTURESHEETANIMATIONRANDOMCURVE\n  uniform  vec2 u_TSAMaxGradientUVs[4];//x为key,y为frame\n#endif\n\n#if FOG\n\tvarying vec3 v_PositionWorld;\n#endif\n\nvec3 rotationByEuler(in vec3 vector,in vec3 rot)\n{\n\tfloat halfRoll = rot.z * 0.5;\n    float halfPitch = rot.x * 0.5;\n\tfloat halfYaw = rot.y * 0.5;\n\n\tfloat sinRoll = sin(halfRoll);\n\tfloat cosRoll = cos(halfRoll);\n\tfloat sinPitch = sin(halfPitch);\n\tfloat cosPitch = cos(halfPitch);\n\tfloat sinYaw = sin(halfYaw);\n\tfloat cosYaw = cos(halfYaw);\n\n\tfloat quaX = (cosYaw * sinPitch * cosRoll) + (sinYaw * cosPitch * sinRoll);\n\tfloat quaY = (sinYaw * cosPitch * cosRoll) - (cosYaw * sinPitch * sinRoll);\n\tfloat quaZ = (cosYaw * cosPitch * sinRoll) - (sinYaw * sinPitch * cosRoll);\n\tfloat quaW = (cosYaw * cosPitch * cosRoll) + (sinYaw * sinPitch * sinRoll);\n\t\n\t//vec4 q=vec4(quaX,quaY,quaZ,quaW);\n\t//vec3 temp = cross(q.xyz, vector) + q.w * vector;\n\t//return (cross(temp, -q.xyz) + dot(q.xyz,vector) * q.xyz + q.w * temp);\n\t\n\tfloat x = quaX + quaX;\n    float y = quaY + quaY;\n    float z = quaZ + quaZ;\n    float wx = quaW * x;\n    float wy = quaW * y;\n    float wz = quaW * z;\n\tfloat xx = quaX * x;\n    float xy = quaX * y;\n\tfloat xz = quaX * z;\n    float yy = quaY * y;\n    float yz = quaY * z;\n    float zz = quaZ * z;\n\n    return vec3(((vector.x * ((1.0 - yy) - zz)) + (vector.y * (xy - wz))) + (vector.z * (xz + wy)),\n                ((vector.x * (xy + wz)) + (vector.y * ((1.0 - xx) - zz))) + (vector.z * (yz - wx)),\n                ((vector.x * (xz - wy)) + (vector.y * (yz + wx))) + (vector.z * ((1.0 - xx) - yy)));\n\t\n}\n\n//假定axis已经归一化\nvec3 rotationByAxis(in vec3 vector,in vec3 axis, in float angle)\n{\n\tfloat halfAngle = angle * 0.5;\n\tfloat sin = sin(halfAngle);\n\t\n\tfloat quaX = axis.x * sin;\n\tfloat quaY = axis.y * sin;\n\tfloat quaZ = axis.z * sin;\n\tfloat quaW = cos(halfAngle);\n\t\n\t//vec4 q=vec4(quaX,quaY,quaZ,quaW);\n\t//vec3 temp = cross(q.xyz, vector) + q.w * vector;\n\t//return (cross(temp, -q.xyz) + dot(q.xyz,vector) * q.xyz + q.w * temp);\n\t\n\tfloat x = quaX + quaX;\n    float y = quaY + quaY;\n    float z = quaZ + quaZ;\n    float wx = quaW * x;\n    float wy = quaW * y;\n    float wz = quaW * z;\n\tfloat xx = quaX * x;\n    float xy = quaX * y;\n\tfloat xz = quaX * z;\n    float yy = quaY * y;\n    float yz = quaY * z;\n    float zz = quaZ * z;\n\n    return vec3(((vector.x * ((1.0 - yy) - zz)) + (vector.y * (xy - wz))) + (vector.z * (xz + wy)),\n                ((vector.x * (xy + wz)) + (vector.y * ((1.0 - xx) - zz))) + (vector.z * (yz - wx)),\n                ((vector.x * (xz - wy)) + (vector.y * (yz + wx))) + (vector.z * ((1.0 - xx) - yy)));\n\t\n}\n\nvec3 rotationByQuaternions(in vec3 v,in vec4 q) \n{\n\treturn v + 2.0 * cross(q.xyz, cross(q.xyz, v) + q.w * v);\n}\n\n \n#ifdef defined(VELOCITYOVERLIFETIMECURVE)||defined(VELOCITYOVERLIFETIMERANDOMCURVE)||defined(SIZEOVERLIFETIMECURVE)||defined(SIZEOVERLIFETIMECURVESEPERATE)||defined(SIZEOVERLIFETIMERANDOMCURVES)||defined(SIZEOVERLIFETIMERANDOMCURVESSEPERATE)\nfloat getCurValueFromGradientFloat(in vec2 gradientNumbers[4],in float normalizedAge)\n{\n\tfloat curValue;\n\tfor(int i=1;i<4;i++)\n\t{\n\t\tvec2 gradientNumber=gradientNumbers[i];\n\t\tfloat key=gradientNumber.x;\n\t\tif(key>=normalizedAge)\n\t\t{\n\t\t\tvec2 lastGradientNumber=gradientNumbers[i-1];\n\t\t\tfloat lastKey=lastGradientNumber.x;\n\t\t\tfloat age=(normalizedAge-lastKey)/(key-lastKey);\n\t\t\tcurValue=mix(lastGradientNumber.y,gradientNumber.y,age);\n\t\t\tbreak;\n\t\t}\n\t}\n\treturn curValue;\n}\n#endif\n\n#ifdef defined(VELOCITYOVERLIFETIMECURVE)||defined(VELOCITYOVERLIFETIMERANDOMCURVE)||defined(ROTATIONOVERLIFETIMECURVE)||defined(ROTATIONOVERLIFETIMERANDOMCURVES)\nfloat getTotalValueFromGradientFloat(in vec2 gradientNumbers[4],in float normalizedAge)\n{\n\tfloat totalValue=0.0;\n\tfor(int i=1;i<4;i++)\n\t{\n\t\tvec2 gradientNumber=gradientNumbers[i];\n\t\tfloat key=gradientNumber.x;\n\t\tvec2 lastGradientNumber=gradientNumbers[i-1];\n\t\tfloat lastValue=lastGradientNumber.y;\n\t\t\n\t\tif(key>=normalizedAge){\n\t\t\tfloat lastKey=lastGradientNumber.x;\n\t\t\tfloat age=(normalizedAge-lastKey)/(key-lastKey);\n\t\t\ttotalValue+=(lastValue+mix(lastValue,gradientNumber.y,age))/2.0*a_ShapePositionStartLifeTime.w*(normalizedAge-lastKey);\n\t\t\tbreak;\n\t\t}\n\t\telse{\n\t\t\ttotalValue+=(lastValue+gradientNumber.y)/2.0*a_ShapePositionStartLifeTime.w*(key-lastGradientNumber.x);\n\t\t}\n\t}\n\treturn totalValue;\n}\n#endif\n\n#ifdef defined(COLOROVERLIFETIME)||defined(RANDOMCOLOROVERLIFETIME)\nvec4 getColorFromGradient(in vec2 gradientAlphas[4],in vec4 gradientColors[4],in float normalizedAge)\n{\n\tvec4 overTimeColor;\n\tfor(int i=1;i<4;i++)\n\t{\n\t\tvec2 gradientAlpha=gradientAlphas[i];\n\t\tfloat alphaKey=gradientAlpha.x;\n\t\tif(alphaKey>=normalizedAge)\n\t\t{\n\t\t\tvec2 lastGradientAlpha=gradientAlphas[i-1];\n\t\t\tfloat lastAlphaKey=lastGradientAlpha.x;\n\t\t\tfloat age=(normalizedAge-lastAlphaKey)/(alphaKey-lastAlphaKey);\n\t\t\toverTimeColor.a=mix(lastGradientAlpha.y,gradientAlpha.y,age);\n\t\t\tbreak;\n\t\t}\n\t}\n\t\n\tfor(int i=1;i<4;i++)\n\t{\n\t\tvec4 gradientColor=gradientColors[i];\n\t\tfloat colorKey=gradientColor.x;\n\t\tif(colorKey>=normalizedAge)\n\t\t{\n\t\t\tvec4 lastGradientColor=gradientColors[i-1];\n\t\t\tfloat lastColorKey=lastGradientColor.x;\n\t\t\tfloat age=(normalizedAge-lastColorKey)/(colorKey-lastColorKey);\n\t\t\toverTimeColor.rgb=mix(gradientColors[i-1].yzw,gradientColor.yzw,age);\n\t\t\tbreak;\n\t\t}\n\t}\n\treturn overTimeColor;\n}\n#endif\n\n\n#ifdef defined(TEXTURESHEETANIMATIONCURVE)||defined(TEXTURESHEETANIMATIONRANDOMCURVE)\nfloat getFrameFromGradient(in vec2 gradientFrames[4],in float normalizedAge)\n{\n\tfloat overTimeFrame;\n\tfor(int i=1;i<4;i++)\n\t{\n\t\tvec2 gradientFrame=gradientFrames[i];\n\t\tfloat key=gradientFrame.x;\n\t\tif(key>=normalizedAge)\n\t\t{\n\t\t\tvec2 lastGradientFrame=gradientFrames[i-1];\n\t\t\tfloat lastKey=lastGradientFrame.x;\n\t\t\tfloat age=(normalizedAge-lastKey)/(key-lastKey);\n\t\t\toverTimeFrame=mix(lastGradientFrame.y,gradientFrame.y,age);\n\t\t\tbreak;\n\t\t}\n\t}\n\treturn floor(overTimeFrame);\n}\n#endif\n\n#ifdef defined(VELOCITYOVERLIFETIMECONSTANT)||defined(VELOCITYOVERLIFETIMECURVE)||defined(VELOCITYOVERLIFETIMERANDOMCONSTANT)||defined(VELOCITYOVERLIFETIMERANDOMCURVE)\nvec3 computeParticleLifeVelocity(in float normalizedAge)\n{\n  vec3 outLifeVelocity;\n  #ifdef VELOCITYOVERLIFETIMECONSTANT\n\t outLifeVelocity=u_VOLVelocityConst; \n  #endif\n  #ifdef VELOCITYOVERLIFETIMECURVE\n     outLifeVelocity= vec3(getCurValueFromGradientFloat(u_VOLVelocityGradientX,normalizedAge),getCurValueFromGradientFloat(u_VOLVelocityGradientY,normalizedAge),getCurValueFromGradientFloat(u_VOLVelocityGradientZ,normalizedAge));\n  #endif\n  #ifdef VELOCITYOVERLIFETIMERANDOMCONSTANT\n\t outLifeVelocity=mix(u_VOLVelocityConst,u_VOLVelocityConstMax,vec3(a_Random1.y,a_Random1.z,a_Random1.w)); \n  #endif\n  #ifdef VELOCITYOVERLIFETIMERANDOMCURVE\n     outLifeVelocity=vec3(mix(getCurValueFromGradientFloat(u_VOLVelocityGradientX,normalizedAge),getCurValueFromGradientFloat(u_VOLVelocityGradientMaxX,normalizedAge),a_Random1.y),\n\t                 mix(getCurValueFromGradientFloat(u_VOLVelocityGradientY,normalizedAge),getCurValueFromGradientFloat(u_VOLVelocityGradientMaxY,normalizedAge),a_Random1.z),\n\t\t\t\t\t mix(getCurValueFromGradientFloat(u_VOLVelocityGradientZ,normalizedAge),getCurValueFromGradientFloat(u_VOLVelocityGradientMaxZ,normalizedAge),a_Random1.w));\n  #endif\n\t\t\t\t\t\n  return outLifeVelocity;\n} \n#endif\n\nvec3 computeParticlePosition(in vec3 startVelocity, in vec3 lifeVelocity,in float age,in float normalizedAge,vec3 gravityVelocity,vec4 worldRotation)\n{\n   vec3 startPosition;\n   vec3 lifePosition;\n   #ifdef defined(VELOCITYOVERLIFETIMECONSTANT)||defined(VELOCITYOVERLIFETIMECURVE)||defined(VELOCITYOVERLIFETIMERANDOMCONSTANT)||defined(VELOCITYOVERLIFETIMERANDOMCURVE)\n\t#ifdef VELOCITYOVERLIFETIMECONSTANT\n\t\t  startPosition=startVelocity*age;\n\t\t  lifePosition=lifeVelocity*age;\n\t#endif\n\t#ifdef VELOCITYOVERLIFETIMECURVE\n\t\t  startPosition=startVelocity*age;\n\t\t  lifePosition=vec3(getTotalValueFromGradientFloat(u_VOLVelocityGradientX,normalizedAge),getTotalValueFromGradientFloat(u_VOLVelocityGradientY,normalizedAge),getTotalValueFromGradientFloat(u_VOLVelocityGradientZ,normalizedAge));\n\t#endif\n\t#ifdef VELOCITYOVERLIFETIMERANDOMCONSTANT\n\t\t  startPosition=startVelocity*age;\n\t\t  lifePosition=lifeVelocity*age;\n\t#endif\n\t#ifdef VELOCITYOVERLIFETIMERANDOMCURVE\n\t\t  startPosition=startVelocity*age;\n\t\t  lifePosition=vec3(mix(getTotalValueFromGradientFloat(u_VOLVelocityGradientX,normalizedAge),getTotalValueFromGradientFloat(u_VOLVelocityGradientMaxX,normalizedAge),a_Random1.y)\n\t      ,mix(getTotalValueFromGradientFloat(u_VOLVelocityGradientY,normalizedAge),getTotalValueFromGradientFloat(u_VOLVelocityGradientMaxY,normalizedAge),a_Random1.z)\n\t      ,mix(getTotalValueFromGradientFloat(u_VOLVelocityGradientZ,normalizedAge),getTotalValueFromGradientFloat(u_VOLVelocityGradientMaxZ,normalizedAge),a_Random1.w));\n\t#endif\n\t\n\tvec3 finalPosition;\n\tif(u_VOLSpaceType==0){\n\t  if(u_ScalingMode!=2)\n\t   finalPosition =rotationByQuaternions(u_PositionScale*(a_ShapePositionStartLifeTime.xyz+startPosition+lifePosition),worldRotation);\n\t  else\n\t   finalPosition =rotationByQuaternions(u_PositionScale*a_ShapePositionStartLifeTime.xyz+startPosition+lifePosition,worldRotation);\n\t}\n\telse{\n\t  if(u_ScalingMode!=2)\n\t    finalPosition = rotationByQuaternions(u_PositionScale*(a_ShapePositionStartLifeTime.xyz+startPosition),worldRotation)+lifePosition;\n\t  else\n\t    finalPosition = rotationByQuaternions(u_PositionScale*a_ShapePositionStartLifeTime.xyz+startPosition,worldRotation)+lifePosition;\n\t}\n  #else\n\t startPosition=startVelocity*age;\n\t vec3 finalPosition;\n\t if(u_ScalingMode!=2)\n\t   finalPosition = rotationByQuaternions(u_PositionScale*(a_ShapePositionStartLifeTime.xyz+startPosition),worldRotation);\n\t else\n\t   finalPosition = rotationByQuaternions(u_PositionScale*a_ShapePositionStartLifeTime.xyz+startPosition,worldRotation);\n  #endif\n  \n  if(u_SimulationSpace==0)\n    finalPosition=finalPosition+a_SimulationWorldPostion;\n  else if(u_SimulationSpace==1) \n    finalPosition=finalPosition+u_WorldPosition;\n  \n  finalPosition+=0.5*gravityVelocity*age;\n \n  return  finalPosition;\n}\n\n\nvec4 computeParticleColor(in vec4 color,in float normalizedAge)\n{\n\t#ifdef COLOROVERLIFETIME\n\t  color*=getColorFromGradient(u_ColorOverLifeGradientAlphas,u_ColorOverLifeGradientColors,normalizedAge);\n\t#endif\n\t\n\t#ifdef RANDOMCOLOROVERLIFETIME\n\t  color*=mix(getColorFromGradient(u_ColorOverLifeGradientAlphas,u_ColorOverLifeGradientColors,normalizedAge),getColorFromGradient(u_MaxColorOverLifeGradientAlphas,u_MaxColorOverLifeGradientColors,normalizedAge),a_Random0.y);\n\t#endif\n\n    return color;\n}\n\nvec2 computeParticleSizeBillbard(in vec2 size,in float normalizedAge)\n{\n\t#ifdef SIZEOVERLIFETIMECURVE\n\t\tsize*=getCurValueFromGradientFloat(u_SOLSizeGradient,normalizedAge);\n\t#endif\n\t#ifdef SIZEOVERLIFETIMERANDOMCURVES\n\t    size*=mix(getCurValueFromGradientFloat(u_SOLSizeGradient,normalizedAge),getCurValueFromGradientFloat(u_SOLSizeGradientMax,normalizedAge),a_Random0.z); \n\t#endif\n\t#ifdef SIZEOVERLIFETIMECURVESEPERATE\n\t\tsize*=vec2(getCurValueFromGradientFloat(u_SOLSizeGradientX,normalizedAge),getCurValueFromGradientFloat(u_SOLSizeGradientY,normalizedAge));\n\t#endif\n\t#ifdef SIZEOVERLIFETIMERANDOMCURVESSEPERATE\n\t    size*=vec2(mix(getCurValueFromGradientFloat(u_SOLSizeGradientX,normalizedAge),getCurValueFromGradientFloat(u_SOLSizeGradientMaxX,normalizedAge),a_Random0.z)\n\t    ,mix(getCurValueFromGradientFloat(u_SOLSizeGradientY,normalizedAge),getCurValueFromGradientFloat(u_SOLSizeGradientMaxY,normalizedAge),a_Random0.z));\n\t#endif\n\treturn size;\n}\n\n#ifdef RENDERMODE_MESH\nvec3 computeParticleSizeMesh(in vec3 size,in float normalizedAge)\n{\n\t#ifdef SIZEOVERLIFETIMECURVE\n\t\tsize*=getCurValueFromGradientFloat(u_SOLSizeGradient,normalizedAge);\n\t#endif\n\t#ifdef SIZEOVERLIFETIMERANDOMCURVES\n\t    size*=mix(getCurValueFromGradientFloat(u_SOLSizeGradient,normalizedAge),getCurValueFromGradientFloat(u_SOLSizeGradientMax,normalizedAge),a_Random0.z); \n\t#endif\n\t#ifdef SIZEOVERLIFETIMECURVESEPERATE\n\t\tsize*=vec3(getCurValueFromGradientFloat(u_SOLSizeGradientX,normalizedAge),getCurValueFromGradientFloat(u_SOLSizeGradientY,normalizedAge),getCurValueFromGradientFloat(u_SOLSizeGradientZ,normalizedAge));\n\t#endif\n\t#ifdef SIZEOVERLIFETIMERANDOMCURVESSEPERATE\n\t    size*=vec3(mix(getCurValueFromGradientFloat(u_SOLSizeGradientX,normalizedAge),getCurValueFromGradientFloat(u_SOLSizeGradientMaxX,normalizedAge),a_Random0.z)\n\t    ,mix(getCurValueFromGradientFloat(u_SOLSizeGradientY,normalizedAge),getCurValueFromGradientFloat(u_SOLSizeGradientMaxY,normalizedAge),a_Random0.z)\n\t\t,mix(getCurValueFromGradientFloat(u_SOLSizeGradientZ,normalizedAge),getCurValueFromGradientFloat(u_SOLSizeGradientMaxZ,normalizedAge),a_Random0.z));\n\t#endif\n\treturn size;\n}\n#endif\n\nfloat computeParticleRotationFloat(in float rotation,in float age,in float normalizedAge)\n{ \n\t#ifdef ROTATIONOVERLIFETIME\n\t#ifdef ROTATIONOVERLIFETIMECONSTANT\n\t\t\tfloat ageRot=u_ROLAngularVelocityConst*age;\n\t        rotation+=ageRot;\n\t\t#endif\n\t\t#ifdef ROTATIONOVERLIFETIMECURVE\n\t\t\trotation+=getTotalValueFromGradientFloat(u_ROLAngularVelocityGradient,normalizedAge);\n\t\t#endif\n\t\t#ifdef ROTATIONOVERLIFETIMERANDOMCONSTANTS\n\t\t\tfloat ageRot=mix(u_ROLAngularVelocityConst,u_ROLAngularVelocityConstMax,a_Random0.w)*age;\n\t        rotation+=ageRot;\n\t    #endif\n\t\t#ifdef ROTATIONOVERLIFETIMERANDOMCURVES\n\t\t\trotation+=mix(getTotalValueFromGradientFloat(u_ROLAngularVelocityGradient,normalizedAge),getTotalValueFromGradientFloat(u_ROLAngularVelocityGradientMax,normalizedAge),a_Random0.w);\n\t\t#endif\n\t#endif\n\t#ifdef ROTATIONOVERLIFETIMESEPERATE\n\t#ifdef ROTATIONOVERLIFETIMECONSTANT\n\t\t\tfloat ageRot=u_ROLAngularVelocityConstSeprarate.z*age;\n\t        rotation+=ageRot;\n\t\t#endif\n\t\t#ifdef ROTATIONOVERLIFETIMECURVE\n\t\t\trotation+=getTotalValueFromGradientFloat(u_ROLAngularVelocityGradientZ,normalizedAge);\n\t\t#endif\n\t\t#ifdef ROTATIONOVERLIFETIMERANDOMCONSTANTS\n\t\t\tfloat ageRot=mix(u_ROLAngularVelocityConstSeprarate.z,u_ROLAngularVelocityConstMaxSeprarate.z,a_Random0.w)*age;\n\t        rotation+=ageRot;\n\t    #endif\n\t\t#ifdef ROTATIONOVERLIFETIMERANDOMCURVES\n\t\t\trotation+=mix(getTotalValueFromGradientFloat(u_ROLAngularVelocityGradientZ,normalizedAge),getTotalValueFromGradientFloat(u_ROLAngularVelocityGradientMaxZ,normalizedAge),a_Random0.w));\n\t\t#endif\n\t#endif\n\treturn rotation;\n}\n\n#ifdef defined(RENDERMODE_MESH)&&(defined(ROTATIONOVERLIFETIME)||defined(ROTATIONOVERLIFETIMESEPERATE))\nvec3 computeParticleRotationMesh(in vec3 rotation,in float age,in float normalizedAge)\n{ \n\t#ifdef ROTATIONOVERLIFETIME\n\t#ifdef ROTATIONOVERLIFETIMECONSTANT\n\t\t\tfloat ageRot=u_ROLAngularVelocityConst*age;\n\t        rotation+=ageRot;\n\t\t#endif\n\t\t#ifdef ROTATIONOVERLIFETIMECURVE\n\t\t\trotation+=getTotalValueFromGradientFloat(u_ROLAngularVelocityGradient,normalizedAge);\n\t\t#endif\n\t\t#ifdef ROTATIONOVERLIFETIMERANDOMCONSTANTS\n\t\t\tfloat ageRot=mix(u_ROLAngularVelocityConst,u_ROLAngularVelocityConstMax,a_Random0.w)*age;\n\t        rotation+=ageRot;\n\t    #endif\n\t\t#ifdef ROTATIONOVERLIFETIMERANDOMCURVES\n\t\t\trotation+=mix(getTotalValueFromGradientFloat(u_ROLAngularVelocityGradient,normalizedAge),getTotalValueFromGradientFloat(u_ROLAngularVelocityGradientMax,normalizedAge),a_Random0.w);\n\t\t#endif\n\t#endif\n\t#ifdef ROTATIONOVERLIFETIMESEPERATE\n\t#ifdef ROTATIONOVERLIFETIMECONSTANT\n\t\t\tvec3 ageRot=u_ROLAngularVelocityConstSeprarate*age;\n\t        rotation+=ageRot;\n\t\t#endif\n\t\t#ifdef ROTATIONOVERLIFETIMECURVE\n\t\t\trotation+=vec3(getTotalValueFromGradientFloat(u_ROLAngularVelocityGradientX,normalizedAge),getTotalValueFromGradientFloat(u_ROLAngularVelocityGradientY,normalizedAge),getTotalValueFromGradientFloat(u_ROLAngularVelocityGradientZ,normalizedAge));\n\t\t#endif\n\t\t#ifdef ROTATIONOVERLIFETIMERANDOMCONSTANTS\n\t\t\tvec3 ageRot=mix(u_ROLAngularVelocityConstSeprarate,u_ROLAngularVelocityConstMaxSeprarate,a_Random0.w)*age;\n\t        rotation+=ageRot;\n\t    #endif\n\t\t#ifdef ROTATIONOVERLIFETIMERANDOMCURVES\n\t\t\trotation+=vec3(mix(getTotalValueFromGradientFloat(u_ROLAngularVelocityGradientX,normalizedAge),getTotalValueFromGradientFloat(u_ROLAngularVelocityGradientMaxX,normalizedAge),a_Random0.w)\n\t        ,mix(getTotalValueFromGradientFloat(u_ROLAngularVelocityGradientY,normalizedAge),getTotalValueFromGradientFloat(u_ROLAngularVelocityGradientMaxY,normalizedAge),a_Random0.w)\n\t        ,mix(getTotalValueFromGradientFloat(u_ROLAngularVelocityGradientZ,normalizedAge),getTotalValueFromGradientFloat(u_ROLAngularVelocityGradientMaxZ,normalizedAge),a_Random0.w));\n\t\t#endif\n\t#endif\n\treturn rotation;\n}\n#endif\n\nvec2 computeParticleUV(in vec2 uv,in float normalizedAge)\n{ \n\t#ifdef TEXTURESHEETANIMATIONCURVE\n\t\tfloat cycleNormalizedAge=normalizedAge*u_TSACycles;\n\t\tfloat frame=getFrameFromGradient(u_TSAGradientUVs,cycleNormalizedAge-floor(cycleNormalizedAge));\n\t\tfloat totalULength=frame*u_TSASubUVLength.x;\n\t\tfloat floorTotalULength=floor(totalULength);\n\t    uv.x=uv.x+totalULength-floorTotalULength;\n\t\tuv.y=uv.y+floorTotalULength*u_TSASubUVLength.y;\n    #endif\n\t#ifdef TEXTURESHEETANIMATIONRANDOMCURVE\n\t\tfloat cycleNormalizedAge=normalizedAge*u_TSACycles;\n\t\tfloat uvNormalizedAge=cycleNormalizedAge-floor(cycleNormalizedAge);\n\t    float frame=floor(mix(getFrameFromGradient(u_TSAGradientUVs,uvNormalizedAge),getFrameFromGradient(u_TSAMaxGradientUVs,uvNormalizedAge),a_Random1.x));\n\t\tfloat totalULength=frame*u_TSASubUVLength.x;\n\t\tfloat floorTotalULength=floor(totalULength);\n\t    uv.x=uv.x+totalULength-floorTotalULength;\n\t\tuv.y=uv.y+floorTotalULength*u_TSASubUVLength.y;\n    #endif\n\treturn uv;\n}\n\nvoid main()\n{\n   float age = u_CurrentTime - a_DirectionTime.w;\n   float normalizedAge = age/a_ShapePositionStartLifeTime.w;\n   vec3 lifeVelocity;\n   if(normalizedAge<1.0){ \n\t  vec3 startVelocity=a_DirectionTime.xyz*a_StartSpeed;\n   #ifdef defined(VELOCITYOVERLIFETIMECONSTANT)||defined(VELOCITYOVERLIFETIMECURVE)||defined(VELOCITYOVERLIFETIMERANDOMCONSTANT)||defined(VELOCITYOVERLIFETIMERANDOMCURVE)\n\t  lifeVelocity= computeParticleLifeVelocity(normalizedAge);//计算粒子生命周期速度\n   #endif \n\tvec3 gravityVelocity=u_Gravity*age;\n\t\n\tvec4 worldRotation;\n\tif(u_SimulationSpace==0)\n\t\tworldRotation=a_SimulationWorldRotation;\n\telse\n\t\tworldRotation=u_WorldRotation;\n\t\n   vec3 center=computeParticlePosition(startVelocity, lifeVelocity, age, normalizedAge,gravityVelocity,worldRotation);//计算粒子位置\n   \n   \n   #ifdef SPHERHBILLBOARD\n\t\tvec2 corner=a_CornerTextureCoordinate.xy;//Billboard模式z轴无效\n        vec3 cameraUpVector =normalize(u_CameraUp);//TODO:是否外面归一化\n        vec3 sideVector = normalize(cross(u_CameraDirection,cameraUpVector));\n        vec3 upVector = normalize(cross(sideVector,u_CameraDirection));\n\t    corner*=computeParticleSizeBillbard(a_StartSize.xy,normalizedAge);\n\t\t#ifdef defined(ROTATIONOVERLIFETIME)||defined(ROTATIONOVERLIFETIMESEPERATE)\n\t\t\tif(u_ThreeDStartRotation){\n\t\t\t\tvec3 rotation=vec3(a_StartRotation0.xy,computeParticleRotationFloat(a_StartRotation0.z,age,normalizedAge));\n\t\t\t\tcenter += u_SizeScale.xzy*rotationByEuler(corner.x*sideVector+corner.y*upVector,rotation);\n\t\t\t}\n\t\t\telse{\n\t\t\t\tfloat rot = computeParticleRotationFloat(a_StartRotation0.x, age,normalizedAge);\n\t\t\t\tfloat c = cos(rot);\n\t\t\t\tfloat s = sin(rot);\n\t\t\t\tmat2 rotation= mat2(c, -s, s, c);\n\t\t\t\tcorner=rotation*corner;\n\t\t\t\tcenter += u_SizeScale.xzy*(corner.x*sideVector+corner.y*upVector);\n\t\t\t}\n\t\t#else\n\t\t\tif(u_ThreeDStartRotation){\n\t\t\t\tcenter += u_SizeScale.xzy*rotationByEuler(corner.x*sideVector+corner.y*upVector,a_StartRotation0);\n\t\t\t}\n\t\t\telse{\n\t\t\t\tfloat c = cos(a_StartRotation0.x);\n\t\t\t\tfloat s = sin(a_StartRotation0.x);\n\t\t\t\tmat2 rotation= mat2(c, -s, s, c);\n\t\t\t\tcorner=rotation*corner;\n\t\t\t\tcenter += u_SizeScale.xzy*(corner.x*sideVector+corner.y*upVector);\n\t\t\t}\n\t\t#endif\n   #endif\n   \n   #ifdef STRETCHEDBILLBOARD\n\tvec2 corner=a_CornerTextureCoordinate.xy;//Billboard模式z轴无效\n\tvec3 velocity;\n\t#ifdef defined(VELOCITYOVERLIFETIMECONSTANT)||defined(VELOCITYOVERLIFETIMECURVE)||defined(VELOCITYOVERLIFETIMERANDOMCONSTANT)||defined(VELOCITYOVERLIFETIMERANDOMCURVE)\n\t    if(u_VOLSpaceType==0)\n\t\t  velocity=rotationByQuaternions(u_SizeScale*(startVelocity+lifeVelocity),worldRotation)+gravityVelocity;\n\t    else\n\t\t  velocity=rotationByQuaternions(u_SizeScale*startVelocity,worldRotation)+lifeVelocity+gravityVelocity;\n    #else\n\t    velocity= rotationByQuaternions(u_SizeScale*startVelocity,worldRotation)+gravityVelocity;\n    #endif\t\n\t\tvec3 cameraUpVector = normalize(velocity);\n\t\tvec3 direction = normalize(center-u_CameraPosition);\n        vec3 sideVector = normalize(cross(direction,normalize(velocity)));\n\t\t\n\t\tsideVector=u_SizeScale.xzy*sideVector;\n\t\tcameraUpVector=length(vec3(u_SizeScale.x,0.0,0.0))*cameraUpVector;\n\t\t\n\t    vec2 size=computeParticleSizeBillbard(a_StartSize.xy,normalizedAge);\n\t\t\n\t    const mat2 rotaionZHalfPI=mat2(0.0, -1.0, 1.0, 0.0);\n\t    corner=rotaionZHalfPI*corner;\n\t    corner.y=corner.y-abs(corner.y);\n\t\t\n\t    float speed=length(velocity);//TODO:\n\t    center +=sign(u_SizeScale.x)*(sign(u_StretchedBillboardLengthScale)*size.x*corner.x*sideVector+(speed*u_StretchedBillboardSpeedScale+size.y*u_StretchedBillboardLengthScale)*corner.y*cameraUpVector);\n   #endif\n   \n   #ifdef HORIZONTALBILLBOARD\n\t\tvec2 corner=a_CornerTextureCoordinate.xy;//Billboard模式z轴无效\n        const vec3 cameraUpVector=vec3(0.0,0.0,-1.0);\n\t    const vec3 sideVector = vec3(1.0,0.0,0.0);\n\t\tcorner*=computeParticleSizeBillbard(a_StartSize.xy,normalizedAge);\n\t\tfloat rot = computeParticleRotationFloat(a_StartRotation0.x, age,normalizedAge);\n        float c = cos(rot);\n        float s = sin(rot);\n        mat2 rotation= mat2(c, -s, s, c);\n\t    corner=rotation*corner*cos(0.78539816339744830961566084581988);//TODO:临时缩小cos45,不确定U3D原因\n        center +=u_SizeScale.xzy*(corner.x*sideVector+ corner.y*cameraUpVector);\n   #endif\n   \n   #ifdef VERTICALBILLBOARD\n\t\tvec2 corner=a_CornerTextureCoordinate.xy;//Billboard模式z轴无效\n        const vec3 cameraUpVector =vec3(0.0,1.0,0.0);\n        vec3 sideVector = normalize(cross(u_CameraDirection,cameraUpVector));\n\t\tcorner*=computeParticleSizeBillbard(a_StartSize.xy,normalizedAge);\n\t\tfloat rot = computeParticleRotationFloat(a_StartRotation0.x, age,normalizedAge);\n        float c = cos(rot);\n        float s = sin(rot);\n        mat2 rotation= mat2(c, -s, s, c);\n\t    corner=rotation*corner*cos(0.78539816339744830961566084581988);//TODO:临时缩小cos45,不确定U3D原因\n        center +=u_SizeScale.xzy*(corner.x*sideVector+ corner.y*cameraUpVector);\n   #endif\n   \n   #ifdef RENDERMODE_MESH\n\t    vec3 size=computeParticleSizeMesh(a_StartSize,normalizedAge);\n\t\t#ifdef defined(ROTATIONOVERLIFETIME)||defined(ROTATIONOVERLIFETIMESEPERATE)\n\t\t\tif(u_ThreeDStartRotation){\n\t\t\t\tvec3 rotation=vec3(a_StartRotation0.xy,-computeParticleRotationFloat(a_StartRotation0.z, age,normalizedAge));\n\t\t\t\tcenter+= rotationByQuaternions(u_SizeScale*rotationByEuler(a_MeshPosition*size,rotation),worldRotation);\n\t\t\t}\n\t\t\telse{\n\t\t\t\tfloat angle=computeParticleRotationFloat(a_StartRotation0.x, age,normalizedAge);\n\t\t\t\tif(a_ShapePositionStartLifeTime.x!=0.0||a_ShapePositionStartLifeTime.y!=0.0)\n\t\t\t\t{\n\t\t\t\t\tcenter+= (rotationByQuaternions(rotationByAxis(u_SizeScale*a_MeshPosition*size,normalize(cross(vec3(0.0,0.0,1.0),vec3(a_ShapePositionStartLifeTime.xy,0.0))),angle),worldRotation));//已验证\n\t\t\t\t}\n\t\t\t\telse\n\t\t\t\t{\n\t\t\t\t\t#ifdef SHAPE\n\t\t\t\t\t\tcenter+= u_SizeScale.xzy*(rotationByQuaternions(rotationByAxis(a_MeshPosition*size,vec3(0.0,-1.0,0.0),angle),worldRotation));\n\t\t\t\t\t#else\n\t\t\t\t\t\tcenter+=rotationByQuaternions(rotationByAxis(a_MeshPosition*size,vec3(0.0,0.0,-1.0),angle)*u_SizeScale,worldRotation);//已验证\n\t\t\t\t\t#endif\n\t\t\t\t}\n\t\t\t\t\t\n\t\t\t}\n\t\t#else\n\t\t\tif(u_ThreeDStartRotation){\n\t\t\t\tcenter+= rotationByQuaternions(u_SizeScale*rotationByEuler(a_MeshPosition*size,a_StartRotation0),worldRotation);//已验证\n\t\t\t}\n\t\t\telse{\n\t\t\t\tif(a_ShapePositionStartLifeTime.x!=0.0||a_ShapePositionStartLifeTime.y!=0.0){\n\t\t\t\t\tif(u_SimulationSpace==0)\n\t\t\t\t\t\tcenter+= rotationByAxis(u_SizeScale*a_MeshPosition*size,normalize(cross(vec3(0.0,0.0,1.0),vec3(a_ShapePositionStartLifeTime.xy,0.0))),a_StartRotation0.x);\n\t\t\t\t\telse if(u_SimulationSpace==1)\n\t\t\t\t\t\tcenter+= (rotationByQuaternions(u_SizeScale*rotationByAxis(a_MeshPosition*size,normalize(cross(vec3(0.0,0.0,1.0),vec3(a_ShapePositionStartLifeTime.xy,0.0))),a_StartRotation0.x),worldRotation));//已验证\n\t\t\t\t}\n\t\t\t\telse{\n\t\t\t\t\t#ifdef SHAPE\n\t\t\t\t\t\tif(u_SimulationSpace==0)\n\t\t\t\t\t\t\tcenter+= u_SizeScale*rotationByAxis(a_MeshPosition*size,vec3(0.0,-1.0,0.0),a_StartRotation0.x);\n\t\t\t\t\t\telse if(u_SimulationSpace==1)\n\t\t\t\t\t\t\tcenter+= rotationByQuaternions(u_SizeScale*rotationByAxis(a_MeshPosition*size,vec3(0.0,-1.0,0.0),a_StartRotation0.x),worldRotation);\t\n\t\t\t\t\t#else\n\t\t\t\t\t\tif(u_SimulationSpace==0)\n\t\t\t\t\t\t\tcenter+= rotationByAxis(u_SizeScale*a_MeshPosition*size,vec3(0.0,0.0,-1.0),a_StartRotation0.x);\n\t\t\t\t\t\telse if(u_SimulationSpace==1)\n\t\t\t\t\t\t\tcenter+= rotationByQuaternions(u_SizeScale*rotationByAxis(a_MeshPosition*size,vec3(0.0,0.0,-1.0),a_StartRotation0.x),worldRotation);//已验证\n\t\t\t\t\t#endif\n\t\t\t\t}\n\t\t\t}\n\t\t#endif\n   #endif\n   \n    gl_Position=u_Projection*u_View*vec4(center,1.0);\n    v_Color = computeParticleColor(a_StartColor, normalizedAge);\n\t#ifdef DIFFUSEMAP\n\t\t#ifdef defined(SPHERHBILLBOARD)||defined(STRETCHEDBILLBOARD)||defined(HORIZONTALBILLBOARD)||defined(VERTICALBILLBOARD)\n\t\t\tv_TextureCoordinate =computeParticleUV(a_CornerTextureCoordinate.zw, normalizedAge);\n\t\t#endif\n\t\t#ifdef RENDERMODE_MESH\n\t\t\tv_TextureCoordinate =computeParticleUV(a_MeshTextureCoordinate, normalizedAge);\n\t\t#endif\n\t#endif\n      v_Discard=0.0;\n\t  \n\t#if FOG\n\t\tv_PositionWorld=center;\n\t#endif\n   }\n   else\n\t{\n\t\tv_Discard=1.0;\n\t}\n}\n\n",t="#ifdef HIGHPRECISION\n  precision highp float;\n#else\n  precision mediump float;\n#endif\n\nvarying float v_Discard;\nvarying vec4 v_Color;\nvarying vec2 v_TextureCoordinate;\nuniform sampler2D u_texture;\nuniform vec4 u_Tintcolor;\n\n#if FOG\n\tvarying vec3 v_PositionWorld;\n\tuniform vec3 u_CameraPosition;\n\tuniform float u_FogStart;\n\tuniform float u_FogRange;\n\t#if ADDTIVEFOG\n\t#else\n\t\tuniform vec3 u_FogColor;\n\t#endif\n#endif\n\n\nvoid main()\n{\t\n\t#ifdef DIFFUSEMAP\n\t\tif(v_Discard!=0.0)\n\t\t\tdiscard;\n\t\t#ifdef TINTCOLOR\n\t\t\tgl_FragColor=texture2D(u_texture,v_TextureCoordinate)*u_Tintcolor*2.0*v_Color;\n\t\t#else\n\t\t\tgl_FragColor=texture2D(u_texture,v_TextureCoordinate)*v_Color;\n\t\t#endif\n\t#else\n\t\t#ifdef TINTCOLOR\n\t\t\tgl_FragColor=u_Tintcolor*2.0*v_Color;\n\t\t#else\n\t\t\tgl_FragColor=v_Color;\n\t\t#endif\n\t#endif\n\t\n\t#ifdef FOG\n\t\tvec3 toEye=u_CameraPosition-v_PositionWorld;\n\t\tfloat toEyeLength=length(toEye);\n\t\ttoEye/=toEyeLength;\n\t\t\n\t\tfloat lerpFact=clamp((toEyeLength-u_FogStart)/u_FogRange,0.0,1.0);\n\t\t#if ADDTIVEFOG\n\t\t\tgl_FragColor.rgb=mix(gl_FragColor.rgb,vec3(0.0,0.0,0.0),lerpFact);\n\t\t#else\n\t\t\tgl_FragColor.rgb=mix(gl_FragColor.rgb,u_FogColor,lerpFact);\n\t\t#endif\n\t#endif\n}",a=pt.add(h,e,t,n,i),Sn.SHADERDEFINE_DIFFUSEMAP=a.registerMaterialDefine("DIFFUSEMAP"),Sn.SHADERDEFINE_TINTCOLOR=a.registerMaterialDefine("TINTCOLOR"),Sn.SHADERDEFINE_ADDTIVEFOG=a.registerMaterialDefine("ADDTIVEFOG"),Hn.SHADERDEFINE_RENDERMODE_BILLBOARD=a.registerSpriteDefine("SPHERHBILLBOARD"),Hn.SHADERDEFINE_RENDERMODE_STRETCHEDBILLBOARD=a.registerSpriteDefine("STRETCHEDBILLBOARD"),Hn.SHADERDEFINE_RENDERMODE_HORIZONTALBILLBOARD=a.registerSpriteDefine("HORIZONTALBILLBOARD"),Hn.SHADERDEFINE_RENDERMODE_VERTICALBILLBOARD=a.registerSpriteDefine("VERTICALBILLBOARD"),Hn.SHADERDEFINE_COLOROVERLIFETIME=a.registerSpriteDefine("COLOROVERLIFETIME"),Hn.SHADERDEFINE_RANDOMCOLOROVERLIFETIME=a.registerSpriteDefine("RANDOMCOLOROVERLIFETIME"),Hn.SHADERDEFINE_VELOCITYOVERLIFETIMECONSTANT=a.registerSpriteDefine("VELOCITYOVERLIFETIMECONSTANT"),Hn.SHADERDEFINE_VELOCITYOVERLIFETIMECURVE=a.registerSpriteDefine("VELOCITYOVERLIFETIMECURVE"),Hn.SHADERDEFINE_VELOCITYOVERLIFETIMERANDOMCONSTANT=a.registerSpriteDefine("VELOCITYOVERLIFETIMERANDOMCONSTANT"),Hn.SHADERDEFINE_VELOCITYOVERLIFETIMERANDOMCURVE=a.registerSpriteDefine("VELOCITYOVERLIFETIMERANDOMCURVE"),Hn.SHADERDEFINE_TEXTURESHEETANIMATIONCURVE=a.registerSpriteDefine("TEXTURESHEETANIMATIONCURVE"),Hn.SHADERDEFINE_TEXTURESHEETANIMATIONRANDOMCURVE=a.registerSpriteDefine("TEXTURESHEETANIMATIONRANDOMCURVE"),Hn.SHADERDEFINE_ROTATIONOVERLIFETIME=a.registerSpriteDefine("ROTATIONOVERLIFETIME"),Hn.SHADERDEFINE_ROTATIONOVERLIFETIMESEPERATE=a.registerSpriteDefine("ROTATIONOVERLIFETIMESEPERATE"),Hn.SHADERDEFINE_ROTATIONOVERLIFETIMECONSTANT=a.registerSpriteDefine("ROTATIONOVERLIFETIMECONSTANT"),Hn.SHADERDEFINE_ROTATIONOVERLIFETIMECURVE=a.registerSpriteDefine("ROTATIONOVERLIFETIMECURVE"),Hn.SHADERDEFINE_ROTATIONOVERLIFETIMERANDOMCONSTANTS=a.registerSpriteDefine("ROTATIONOVERLIFETIMERANDOMCONSTANTS"),Hn.SHADERDEFINE_ROTATIONOVERLIFETIMERANDOMCURVES=a.registerSpriteDefine("ROTATIONOVERLIFETIMERANDOMCURVES"),Hn.SHADERDEFINE_SIZEOVERLIFETIMECURVE=a.registerSpriteDefine("SIZEOVERLIFETIMECURVE"),Hn.SHADERDEFINE_SIZEOVERLIFETIMECURVESEPERATE=a.registerSpriteDefine("SIZEOVERLIFETIMECURVESEPERATE"),Hn.SHADERDEFINE_SIZEOVERLIFETIMERANDOMCURVES=a.registerSpriteDefine("SIZEOVERLIFETIMERANDOMCURVES"),Hn.SHADERDEFINE_SIZEOVERLIFETIMERANDOMCURVESSEPERATE=a.registerSpriteDefine("SIZEOVERLIFETIMERANDOMCURVESSEPERATE"),Hn.SHADERDEFINE_RENDERMODE_MESH=a.registerSpriteDefine("RENDERMODE_MESH"),Hn.SHADERDEFINE_SHAPE=a.registerSpriteDefine("SHAPE"),n={a_Position:0,a_Texcoord0:2,a_Time:33},i={u_Texture:[1,1],u_Albedo:[2,1],u_Color:[3,1],u_CurrentTime:[2,2],u_Duration:[3,2],u_MvpMatrix:[1,2]};var _=cn.nameKey.add("GLITTER");e="attribute vec4 a_Position;\nattribute vec2 a_Texcoord0;\nattribute float a_Time;\n\nuniform mat4 u_MvpMatrix;\nuniform  float u_CurrentTime;\nuniform  vec4 u_Color;\nuniform float u_Duration;\n\nvarying vec2 v_Texcoord;\nvarying vec4 v_Color;\n\n\nvoid main()\n{\n  gl_Position = u_MvpMatrix * a_Position;\n  \n  float age = u_CurrentTime-a_Time;\n  float normalizedAge = clamp(age / u_Duration,0.0,1.0);\n   \n  v_Texcoord=a_Texcoord0;\n  \n  v_Color=u_Color;\n  v_Color.a*=1.0-normalizedAge;\n}\n",t="#ifdef HIGHPRECISION\n\tprecision highp float;\n#else\n\tprecision mediump float;\n#endif\n\nuniform vec4 u_Albedo;\nuniform sampler2D u_Texture;\n\nvarying vec2 v_Texcoord;\nvarying vec4 v_Color;\n\n\nvoid main()\n{\t\n  gl_FragColor=texture2D(u_Texture, v_Texcoord)*v_Color;\n  gl_FragColor=gl_FragColor*u_Albedo;\n}\n\n",a=pt.add(_,e,t,n,i),n={a_Position:0},i={u_Intensity:[1,1],u_AlphaBlending:[2,1],u_CubeTexture:[3,1],u_MvpMatrix:[4,3]};var u=cn.nameKey.add("SkyBox");e="attribute vec4 a_Position;\nuniform mat4 u_MvpMatrix;\nvarying vec3 v_Texcoord;\n\n\nvoid main()\n{\n  gl_Position = (u_MvpMatrix*a_Position).xyww;\n  v_Texcoord=a_Position.xyz;\n}\n",t="#ifdef HIGHPRECISION\nprecision highp float;\n#else\nprecision mediump float;\n#endif\n\nuniform float u_Intensity;\nuniform float u_AlphaBlending;\nuniform samplerCube u_CubeTexture;\n\nvarying vec3 v_Texcoord;\n\n\nvoid main()\n{\t\n  gl_FragColor=vec4(textureCube(u_CubeTexture, v_Texcoord).rgb*u_Intensity,u_AlphaBlending);\n}\n\n",pt.add(u,e,t,n,i),n={a_Position:0,a_Texcoord0:2},i={u_Intensity:[1,1],u_AlphaBlending:[2,1],u_texture:[3,1],u_MvpMatrix:[4,3]};var c=cn.nameKey.add("SkyDome");e="attribute vec4 a_Position;\nattribute vec2 a_Texcoord0;\nuniform mat4 u_MvpMatrix;\nvarying vec2 v_Texcoord;\n\n\nvoid main()\n{\n  gl_Position = (u_MvpMatrix*a_Position).xyww;\n  v_Texcoord = a_Texcoord0;\n}\n",t="#ifdef HIGHPRECISION\nprecision highp float;\n#else\nprecision mediump float;\n#endif\n\nuniform float u_Intensity;\nuniform float u_AlphaBlending;\nuniform sampler2D u_texture;\n\nvarying vec2 v_Texcoord;\n\n\nvoid main()\n{\t\n  gl_FragColor=vec4(texture2D(u_texture, v_Texcoord).rgb*u_Intensity,u_AlphaBlending);\n}\n\n",pt.add(c,e,t,n,i),n={a_Position:0,a_Normal:3,a_Texcoord0:2,a_Texcoord1:15},i={u_MvpMatrix:[1,2],u_WorldMat:[0,2],u_LightmapScaleOffset:[2,2],u_LightMap:[3,2],u_SplatAlphaTexture:[0,1],u_NormalTexture:[1,1],u_DiffuseTexture1:[2,1],u_DiffuseTexture2:[3,1],u_DiffuseTexture3:[4,1],u_DiffuseTexture4:[5,1],u_DiffuseScale1:[6,1],u_DiffuseScale2:[7,1],u_DiffuseScale3:[8,1],u_DiffuseScale4:[9,1],u_MaterialDiffuse:[11,1],u_MaterialAmbient:[10,1],u_MaterialSpecular:[12,1],u_CameraPos:[0,3],u_FogStart:[1,4],u_FogRange:[2,4],u_FogColor:[0,4],"u_DirectionLight.Direction":[3,4],"u_DirectionLight.Diffuse":[4,4],"u_PointLight.Position":[5,4],"u_PointLight.Range":[6,4],"u_PointLight.Attenuation":[7,4],"u_PointLight.Diffuse":[8,4],"u_SpotLight.Position":[9,4],"u_SpotLight.Direction":[10,4],"u_SpotLight.Range":[12,4],"u_SpotLight.Spot":[11,4],"u_SpotLight.Attenuation":[13,4],"u_SpotLight.Diffuse":[14,4],u_AmbientColor:[21,4],u_shadowMap1:[18,4],u_shadowMap2:[19,4],u_shadowMap3:[20,4],u_shadowPSSMDistance:[15,4],u_lightShadowVP:[16,4],u_shadowPCFoffset:[17,4]};var d=cn.nameKey.add("Terrain");e="attribute vec4 a_Position;\n\n#if defined(DIRECTIONLIGHT)||defined(POINTLIGHT)||defined(SPOTLIGHT)||defined(LIGHTMAP)\n\tattribute vec3 a_Normal;\n\tvarying vec3 v_Normal;\n#endif\n\n#if defined(DIRECTIONLIGHT)||defined(POINTLIGHT)||defined(SPOTLIGHT)||(defined(RECEIVESHADOW)&&defined(SHADOWMAP_PSSM1))\n\tuniform mat4 u_WorldMat;\n\tvarying vec3 v_PositionWorld;\n#endif\n\nvarying float v_posViewZ;\n#ifdef RECEIVESHADOW\n  #ifdef SHADOWMAP_PSSM1 \n  varying vec4 v_lightMVPPos;\n  uniform mat4 u_lightShadowVP[4];\n  #endif\n#endif\n\n#ifdef LIGHTMAP\n\tuniform vec4 u_LightmapScaleOffset;\n\tvarying vec2 v_LightMapUV;\n#endif\n\nattribute vec2 a_Texcoord0;\nattribute vec2 a_Texcoord1;\nvarying vec2 v_Texcoord0;\nvarying vec2 v_Texcoord1;\nuniform mat4 u_MvpMatrix;\n\nvoid main()\n{\n\tgl_Position = u_MvpMatrix * a_Position;\n\tv_Texcoord0=a_Texcoord0;\n\tv_Texcoord1=a_Texcoord1;\n\t\n#if defined(DIRECTIONLIGHT)||defined(POINTLIGHT)||defined(SPOTLIGHT)\n\tv_Normal=a_Normal;\n#endif\n\n#if defined(DIRECTIONLIGHT)||defined(POINTLIGHT)||defined(SPOTLIGHT)||(defined(RECEIVESHADOW)&&defined(SHADOWMAP_PSSM1))\n\tv_PositionWorld=(u_WorldMat*a_Position).xyz;\n#endif\n\n#ifdef LIGHTMAP\n\t//这个地方使用a_Normal 并不是真的代表normal，其实凑巧法线图的uv正好是符合 light_Map的UV\n\tv_LightMapUV=vec2(a_Normal.x*u_LightmapScaleOffset.x+u_LightmapScaleOffset.z,(a_Normal.y-1.0)*u_LightmapScaleOffset.y+u_LightmapScaleOffset.w);\n#endif\n\n#ifdef RECEIVESHADOW\n\tv_posViewZ = gl_Position.w;\n\t#ifdef SHADOWMAP_PSSM1\n\t\tv_lightMVPPos = u_lightShadowVP[0] * vec4(v_PositionWorld,1.0);\n\t#endif\n#endif\n\n}",t='#ifdef HIGHPRECISION\n\tprecision highp float;\n#else\n\tprecision mediump float;\n#endif\n\n#include?DIRECTIONLIGHT||POINTLIGHT||SPOTLIGHT "LightHelper.glsl";\n\n#if defined(DIRECTIONLIGHT)||defined(POINTLIGHT)||defined(SPOTLIGHT)\n\tuniform vec3 u_MaterialDiffuse;\n\tuniform vec4 u_MaterialSpecular;\n\tuniform vec3 u_CameraPos;\n\tvarying vec3 v_Normal;\n\tvarying vec3 v_PositionWorld;\n#endif\n\n#if defined(DIRECTIONLIGHT)||defined(POINTLIGHT)||defined(SPOTLIGHT)||defined(LIGHTMAP)\n\tuniform vec3 u_MaterialAmbient;\n#endif\n\n#ifdef FOG\n\tuniform float u_FogStart;\n\tuniform float u_FogRange;\n\tuniform vec3 u_FogColor;\n#endif\n\n\n#ifdef DIRECTIONLIGHT\n\tuniform DirectionLight u_DirectionLight;\n#endif\n\n#ifdef POINTLIGHT\n\tuniform PointLight u_PointLight;\n#endif\n\n#ifdef SPOTLIGHT\n\tuniform SpotLight u_SpotLight;\n#endif\n\nuniform vec3 u_AmbientColor;\n\n#include "ShadowHelper.glsl"\n#ifdef RECEIVESHADOW\n\t#if defined(SHADOWMAP_PSSM2)||defined(SHADOWMAP_PSSM3)\n\tuniform mat4 u_lightShadowVP[4];\n\t#endif\n\t#ifdef SHADOWMAP_PSSM1 \n\tvarying vec4 v_lightMVPPos;\n\t#endif\n#endif\nvarying float v_posViewZ;\n\n\nuniform sampler2D u_SplatAlphaTexture;\nuniform sampler2D u_NormalTexture;\nuniform sampler2D u_DiffuseTexture1;\nuniform sampler2D u_DiffuseTexture2;\nuniform sampler2D u_DiffuseTexture3;\nuniform sampler2D u_DiffuseTexture4;\nuniform vec2 u_DiffuseScale1;\nuniform vec2 u_DiffuseScale2;\nuniform vec2 u_DiffuseScale3;\nuniform vec2 u_DiffuseScale4;\nvarying vec2 v_Texcoord0;\nvarying vec2 v_Texcoord1;\n\n#ifdef LIGHTMAP\n\tuniform sampler2D u_LightMap;\n\tvarying vec2 v_LightMapUV;\n#endif\n\nvoid main()\n{\n#ifdef DETAIL_NUM1\n\tvec4 color1 = texture2D(u_DiffuseTexture1, v_Texcoord1/u_DiffuseScale1);\n\tvec4 splatAlpha = texture2D(u_SplatAlphaTexture, v_Texcoord0);\n\tgl_FragColor.xyz = color1.xyz;\n#endif\n#ifdef DETAIL_NUM2\n\tvec4 color1 = texture2D(u_DiffuseTexture1, v_Texcoord1/u_DiffuseScale1);\n\tvec4 color2 = texture2D(u_DiffuseTexture2, v_Texcoord1/u_DiffuseScale2);\n\tvec4 splatAlpha = texture2D(u_SplatAlphaTexture, v_Texcoord0);\n\tgl_FragColor.xyz = color1.xyz * (1.0-splatAlpha.r) + color2.xyz * splatAlpha.r;\n#endif\n#ifdef DETAIL_NUM3\n\tvec4 color1 = texture2D(u_DiffuseTexture1, v_Texcoord1/u_DiffuseScale1);\n\tvec4 color2 = texture2D(u_DiffuseTexture2, v_Texcoord1/u_DiffuseScale2);\n\tvec4 color3 = texture2D(u_DiffuseTexture3, v_Texcoord1/u_DiffuseScale3);\n\tvec4 splatAlpha = texture2D(u_SplatAlphaTexture, v_Texcoord0);\n\tgl_FragColor.xyz = color1.xyz * (1.0-(splatAlpha.r+splatAlpha.g)) + color2.xyz * splatAlpha.r + color3.xyz * splatAlpha.g;\n#endif\n#ifdef DETAIL_NUM4\n\tvec4 color1 = texture2D(u_DiffuseTexture1, v_Texcoord1/u_DiffuseScale1);\n\tvec4 color2 = texture2D(u_DiffuseTexture2, v_Texcoord1/u_DiffuseScale2);\n\tvec4 color3 = texture2D(u_DiffuseTexture3, v_Texcoord1/u_DiffuseScale3);\n\tvec4 color4 = texture2D(u_DiffuseTexture4, v_Texcoord1/u_DiffuseScale4);\n\tvec4 splatAlpha = texture2D(u_SplatAlphaTexture, v_Texcoord0);\n\tgl_FragColor.xyz = color1.xyz * (1.0-(splatAlpha.r+splatAlpha.g+splatAlpha.b))+ color2.xyz * splatAlpha.r + color3.xyz * splatAlpha.g + color4.xyz * splatAlpha.b;\n#endif\n\tgl_FragColor.w = splatAlpha.a;\n\t\t\n#if defined(DIRECTIONLIGHT)||defined(POINTLIGHT)||defined(SPOTLIGHT)\n    vec3 normal = texture2D(u_NormalTexture,v_Normal.xy).xyz;\n\tnormal = normal*2.0 - vec3(1.0);\n\tvec3 diffuse = vec3(0.0);\n\tvec3 ambient = vec3(0.0);\n\tvec3 specular= vec3(0.0);\n\tvec3 dif, amb, spe;\n#endif\n\n#if defined(DIRECTIONLIGHT)||defined(POINTLIGHT)||defined(SPOTLIGHT)||defined(FOG)\n\tvec3 toEye;\n\t#ifdef FOG\n\t\ttoEye=u_CameraPos-v_PositionWorld;\n\t\tfloat toEyeLength=length(toEye);\n\t\ttoEye/=toEyeLength;\n\t#else\n\t\ttoEye=normalize(u_CameraPos-v_PositionWorld);\n\t#endif\n#endif\n\n#ifdef DIRECTIONLIGHT\n\tcomputeDirectionLight(u_MaterialDiffuse,u_MaterialAmbient,u_MaterialSpecular,u_DirectionLight,u_AmbientColor,normal,toEye, dif, amb, spe);\n\tdiffuse+=dif;\n\tambient+=amb;\n\tspecular+=spe;\n#endif\n \n#ifdef POINTLIGHT\n\tcomputePointLight(u_MaterialDiffuse,u_MaterialAmbient,u_MaterialSpecular,u_PointLight,u_AmbientColor,v_PositionWorld,normal,toEye, dif, amb, spe);\n\tdiffuse+=dif;\n\tambient+=amb;\n\tspecular+=spe;\n#endif\n\n#ifdef SPOTLIGHT\n\tComputeSpotLight(u_MaterialDiffuse,u_MaterialAmbient,u_MaterialSpecular,u_SpotLight,u_AmbientColor,v_PositionWorld,normal,toEye, dif, amb, spe);\n\tdiffuse+=dif;\n\tambient+=amb;\n\tspecular+=spe;\n#endif\n\n#ifdef RECEIVESHADOW\n\tfloat shadowValue = 1.0;\n\t#ifdef SHADOWMAP_PSSM3\n\t\tshadowValue = getShadowPSSM3( u_shadowMap1,u_shadowMap2,u_shadowMap3,u_lightShadowVP,u_shadowPSSMDistance,u_shadowPCFoffset,v_PositionWorld,v_posViewZ,0.001);\n\t#endif\n\t#ifdef SHADOWMAP_PSSM2\n\t\tshadowValue = getShadowPSSM2( u_shadowMap1,u_shadowMap2,u_lightShadowVP,u_shadowPSSMDistance,u_shadowPCFoffset,v_PositionWorld,v_posViewZ,0.001);\n\t#endif \n\t#ifdef SHADOWMAP_PSSM1\n\t\tshadowValue = getShadowPSSM1( u_shadowMap1,v_lightMVPPos,u_shadowPSSMDistance,u_shadowPCFoffset,v_posViewZ,0.001);\n\t#endif\n#endif\n\n#ifdef LIGHTMAP\n\t#if defined(DIRECTIONLIGHT)||defined(POINTLIGHT)||defined(SPOTLIGHT)\n\t\tgl_FragColor.rgb=gl_FragColor.rgb*(u_MaterialAmbient + texture2D(u_LightMap, v_LightMapUV).rgb);\n\t#else\n\t\t#if defined(RECEIVESHADOW)\n\t\t\tgl_FragColor.rgb=gl_FragColor.rgb*(u_MaterialAmbient + texture2D(u_LightMap, v_LightMapUV).rgb * shadowValue);\n\t\t#else\n\t\t\tgl_FragColor.rgb=gl_FragColor.rgb*(u_MaterialAmbient + texture2D(u_LightMap, v_LightMapUV).rgb);\n\t\t#endif\n\t#endif\n#endif\n\n#if defined(DIRECTIONLIGHT)||defined(POINTLIGHT)||defined(SPOTLIGHT)\n\t#ifdef RECEIVESHADOW\n\t\tgl_FragColor =vec4( gl_FragColor.rgb*(ambient + diffuse*shadowValue) + specular * shadowValue,gl_FragColor.a);\n\t#else\n\t\tgl_FragColor =vec4( gl_FragColor.rgb*(ambient + diffuse) + specular, gl_FragColor.a);\n\t#endif\n#endif\n\n#ifdef FOG\n\tfloat lerpFact=clamp((toEyeLength-u_FogStart)/u_FogRange,0.0,1.0);\n\tgl_FragColor.rgb=mix(gl_FragColor.rgb,u_FogColor,lerpFact);\n#endif\n}\n\n';var f=pt.add(d,e,t,n,i);vn.SHADERDEFINE_DETAIL_NUM1=f.registerMaterialDefine("DETAIL_NUM1"),vn.SHADERDEFINE_DETAIL_NUM2=f.registerMaterialDefine("DETAIL_NUM2"),vn.SHADERDEFINE_DETAIL_NUM4=f.registerMaterialDefine("DETAIL_NUM4"),vn.SHADERDEFINE_DETAIL_NUM3=f.registerMaterialDefine("DETAIL_NUM3"),n={a_Position:0,a_Normal:3,a_Texcoord0:2},i={u_MvpMatrix:[1,2],u_WorldMat:[0,2],u_CameraPos:[0,3],u_LightmapScaleOffset:[2,2],u_LightMap:[3,2],u_SplatAlphaTexture:[0,1],u_DiffuseTexture1:[1,1],u_DiffuseTexture2:[2,1],u_DiffuseTexture3:[3,1],u_DiffuseTexture4:[4,1],u_DiffuseTexture5:[5,1],u_DiffuseScaleOffset1:[6,1],u_DiffuseScaleOffset2:[7,1],u_DiffuseScaleOffset3:[8,1],u_DiffuseScaleOffset4:[9,1],u_DiffuseScaleOffset5:[10,1],u_MaterialAlbedo:[14,1],u_MaterialDiffuse:[12,1],u_MaterialAmbient:[11,1],u_MaterialSpecular:[13,1],u_FogStart:[1,4],u_FogRange:[2,4],u_FogColor:[0,4],"u_DirectionLight.Direction":[3,4],"u_DirectionLight.Diffuse":[4,4],"u_PointLight.Position":[5,4],"u_PointLight.Range":[6,4],"u_PointLight.Attenuation":[7,4],"u_PointLight.Diffuse":[8,4],"u_SpotLight.Position":[9,4],"u_SpotLight.Direction":[10,4],"u_SpotLight.Range":[12,4],"u_SpotLight.Spot":[11,4],"u_SpotLight.Attenuation":[13,4],"u_SpotLight.Diffuse":[14,4],u_AmbientColor:[21,4],u_shadowMap1:[18,4],u_shadowMap2:[19,4],u_shadowMap3:[20,4],u_shadowPSSMDistance:[15,4],u_lightShadowVP:[16,4],u_shadowPCFoffset:[17,4]};var m=cn.nameKey.add("ExtendTerrain");e="attribute vec4 a_Position;\nattribute vec2 a_Texcoord0;\n\nuniform mat4 u_MvpMatrix;\n\nvarying vec2 v_Texcoord0;\n\n#if defined(DIRECTIONLIGHT)||defined(POINTLIGHT)||defined(SPOTLIGHT)||defined(LIGHTMAP)\n\tattribute vec3 a_Normal;\n\tvarying vec3 v_Normal;\n#endif\n\n#if defined(DIRECTIONLIGHT)||defined(POINTLIGHT)||defined(SPOTLIGHT)||defined(FOG)||(defined(RECEIVESHADOW)&&defined(SHADOWMAP_PSSM1))\n\tuniform mat4 u_WorldMat;\n\tvarying vec3 v_PositionWorld;\n#endif\n\n#ifdef LIGHTMAP\n\tvarying vec2 v_LightMapUV;\n\tuniform vec4 u_LightmapScaleOffset;\n#endif\n\n#ifdef RECEIVESHADOW\n\tvarying float v_posViewZ;\n\t#ifdef SHADOWMAP_PSSM1 \n\t\tvarying vec4 v_lightMVPPos;\n\t\tuniform mat4 u_lightShadowVP[4];\n\t#endif\n#endif\n\nvoid main()\n{\n\tgl_Position = u_MvpMatrix * a_Position;\n  \n\tv_Texcoord0 = a_Texcoord0;\n  \n\t#ifdef LIGHTMAP\n\t\tv_LightMapUV = vec2(a_Texcoord0.x*u_LightmapScaleOffset.x+u_LightmapScaleOffset.z,(a_Texcoord0.y-1.0)*u_LightmapScaleOffset.y+u_LightmapScaleOffset.w);\n\t#endif\n  \n\t#if defined(DIRECTIONLIGHT)||defined(POINTLIGHT)||defined(SPOTLIGHT)\n\t\tv_Normal = a_Normal;\n\t#endif\n\n\t#if defined(DIRECTIONLIGHT)||defined(POINTLIGHT)||defined(SPOTLIGHT)||defined(FOG)||(defined(RECEIVESHADOW)&&defined(SHADOWMAP_PSSM1))\n\t\tv_PositionWorld=(u_WorldMat*a_Position).xyz;\n\t#endif\n\n\t#ifdef RECEIVESHADOW\n\t\tv_posViewZ = gl_Position.w;\n\t\t#ifdef SHADOWMAP_PSSM1\n\t\t\tv_lightMVPPos = u_lightShadowVP[0] * vec4(v_PositionWorld,1.0);\n\t\t#endif\n\t#endif\n}",t='#ifdef HIGHPRECISION\n\tprecision highp float;\n#else\n\tprecision mediump float;\n#endif\n\n#include?DIRECTIONLIGHT||POINTLIGHT||SPOTLIGHT "LightHelper.glsl";\n\n#if defined(DIRECTIONLIGHT)||defined(POINTLIGHT)||defined(SPOTLIGHT)||defined(FOG)\n\tuniform vec3 u_MaterialDiffuse;\n\tuniform vec4 u_MaterialSpecular;\n\tuniform vec3 u_CameraPos;\n\tvarying vec3 v_Normal;\n\tvarying vec3 v_PositionWorld;\n#endif\n\n#ifdef FOG\n\tuniform float u_FogStart;\n\tuniform float u_FogRange;\n\tuniform vec3 u_FogColor;\n#endif\n\n\n#ifdef DIRECTIONLIGHT\n\tuniform DirectionLight u_DirectionLight;\n#endif\n\n#ifdef POINTLIGHT\n\tuniform PointLight u_PointLight;\n#endif\n\n#ifdef SPOTLIGHT\n\tuniform SpotLight u_SpotLight;\n#endif\n\nuniform vec3 u_AmbientColor;\n\n#include "ShadowHelper.glsl"\n#ifdef RECEIVESHADOW\n\t#if defined(SHADOWMAP_PSSM2)||defined(SHADOWMAP_PSSM3)\n\tuniform mat4 u_lightShadowVP[4];\n\t#endif\n\t#ifdef SHADOWMAP_PSSM1 \n\tvarying vec4 v_lightMVPPos;\n\t#endif\n#endif\nvarying float v_posViewZ;\n\n\nuniform sampler2D u_SplatAlphaTexture;\n\nuniform sampler2D u_DiffuseTexture1;\nuniform sampler2D u_DiffuseTexture2;\nuniform sampler2D u_DiffuseTexture3;\nuniform sampler2D u_DiffuseTexture4;\nuniform sampler2D u_DiffuseTexture5;\n\nuniform vec4 u_DiffuseScaleOffset1;\nuniform vec4 u_DiffuseScaleOffset2;\nuniform vec4 u_DiffuseScaleOffset3;\nuniform vec4 u_DiffuseScaleOffset4;\nuniform vec4 u_DiffuseScaleOffset5;\n\nvarying vec2 v_Texcoord0;\n\nuniform vec3 u_MaterialAmbient;\nuniform vec4 u_MaterialAlbedo;\n\n#ifdef LIGHTMAP\n\tuniform sampler2D u_LightMap;\n\tvarying vec2 v_LightMapUV;\n#endif\n\nvoid main()\n{\n\t#ifdef ExtendTerrain_DETAIL_NUM1\n\t\tvec4 splatAlpha = texture2D(u_SplatAlphaTexture, v_Texcoord0);\n\t\tvec4 color1 = texture2D(u_DiffuseTexture1, v_Texcoord0 * u_DiffuseScaleOffset1.xy);\n\t\tgl_FragColor.xyz = color1.xyz * splatAlpha.r;\n\t#endif\n\t#ifdef ExtendTerrain_DETAIL_NUM2\n\t\tvec4 splatAlpha = texture2D(u_SplatAlphaTexture, v_Texcoord0);\n\t\tvec4 color1 = texture2D(u_DiffuseTexture1, v_Texcoord0 * u_DiffuseScaleOffset1.xy);\n\t\tvec4 color2 = texture2D(u_DiffuseTexture2, v_Texcoord0 * u_DiffuseScaleOffset2.xy);\n\t\tgl_FragColor.xyz = color1.xyz * splatAlpha.r + color2.xyz * (1.0 - splatAlpha.r);\n\t#endif\n\t#ifdef ExtendTerrain_DETAIL_NUM3\n\t\tvec4 splatAlpha = texture2D(u_SplatAlphaTexture, v_Texcoord0);\n\t\tvec4 color1 = texture2D(u_DiffuseTexture1, v_Texcoord0 * u_DiffuseScaleOffset1.xy);\n\t\tvec4 color2 = texture2D(u_DiffuseTexture2, v_Texcoord0 * u_DiffuseScaleOffset2.xy);\n\t\tvec4 color3 = texture2D(u_DiffuseTexture3, v_Texcoord0 * u_DiffuseScaleOffset3.xy);\n\t\tgl_FragColor.xyz = color1.xyz * splatAlpha.r  + color2.xyz * splatAlpha.g + color3.xyz * (1.0 - splatAlpha.r - splatAlpha.g);\n\t#endif\n\t#ifdef ExtendTerrain_DETAIL_NUM4\n\t\tvec4 splatAlpha = texture2D(u_SplatAlphaTexture, v_Texcoord0);\n\t\tvec4 color1 = texture2D(u_DiffuseTexture1, v_Texcoord0 * u_DiffuseScaleOffset1.xy);\n\t\tvec4 color2 = texture2D(u_DiffuseTexture2, v_Texcoord0 * u_DiffuseScaleOffset2.xy);\n\t\tvec4 color3 = texture2D(u_DiffuseTexture3, v_Texcoord0 * u_DiffuseScaleOffset3.xy);\n\t\tvec4 color4 = texture2D(u_DiffuseTexture4, v_Texcoord0 * u_DiffuseScaleOffset4.xy);\n\t\tgl_FragColor.xyz = color1.xyz * splatAlpha.r  + color2.xyz * splatAlpha.g + color3.xyz * splatAlpha.b + color4.xyz * (1.0 - splatAlpha.r - splatAlpha.g - splatAlpha.b);\n\t#endif\n\t#ifdef ExtendTerrain_DETAIL_NUM5\n\t\tvec4 splatAlpha = texture2D(u_SplatAlphaTexture, v_Texcoord0);\n\t\tvec4 color1 = texture2D(u_DiffuseTexture1, v_Texcoord0 * u_DiffuseScaleOffset1.xy);\n\t\tvec4 color2 = texture2D(u_DiffuseTexture2, v_Texcoord0 * u_DiffuseScaleOffset2.xy);\n\t\tvec4 color3 = texture2D(u_DiffuseTexture3, v_Texcoord0 * u_DiffuseScaleOffset3.xy);\n\t\tvec4 color4 = texture2D(u_DiffuseTexture4, v_Texcoord0 * u_DiffuseScaleOffset4.xy);\n\t\tvec4 color5 = texture2D(u_DiffuseTexture5, v_Texcoord0 * u_DiffuseScaleOffset5.xy);\n\t\tgl_FragColor.xyz = color1.xyz * splatAlpha.r  + color2.xyz * splatAlpha.g + color3.xyz * splatAlpha.b + color4.xyz * splatAlpha.a + color5.xyz * (1.0 - splatAlpha.r - splatAlpha.g - splatAlpha.b - splatAlpha.a);\n\t#endif\n\t\tgl_FragColor.w = splatAlpha.a;\n\t\t\n#if defined(DIRECTIONLIGHT)||defined(POINTLIGHT)||defined(SPOTLIGHT)\n    vec3 normal = v_Normal;\n\tvec3 diffuse = vec3(0.0);\n\tvec3 ambient = vec3(0.0);\n\tvec3 specular= vec3(0.0);\n\tvec3 dif, amb, spe;\n#endif\n\n#if defined(DIRECTIONLIGHT)||defined(POINTLIGHT)||defined(SPOTLIGHT)||defined(FOG)\n\tvec3 toEye;\n\t#ifdef FOG\n\t\ttoEye=u_CameraPos-v_PositionWorld;\n\t\tfloat toEyeLength=length(toEye);\n\t\ttoEye/=toEyeLength;\n\t#else\n\t\ttoEye=normalize(u_CameraPos-v_PositionWorld);\n\t#endif\n#endif\n\n#ifdef DIRECTIONLIGHT\n\tcomputeDirectionLight(u_MaterialDiffuse,u_MaterialAmbient,u_MaterialSpecular,u_DirectionLight,u_AmbientColor,normal,toEye, dif, amb, spe);\n\tdiffuse+=dif;\n\tambient+=amb;\n\tspecular+=spe;\n#endif\n \n#ifdef POINTLIGHT\n\tcomputePointLight(u_MaterialDiffuse,u_MaterialAmbient,u_MaterialSpecular,u_PointLight,u_AmbientColor,v_PositionWorld,normal,toEye, dif, amb, spe);\n\tdiffuse+=dif;\n\tambient+=amb;\n\tspecular+=spe;\n#endif\n\n#ifdef SPOTLIGHT\n\tComputeSpotLight(u_MaterialDiffuse,u_MaterialAmbient,u_MaterialSpecular,u_SpotLight,u_AmbientColor,v_PositionWorld,normal,toEye, dif, amb, spe);\n\tdiffuse+=dif;\n\tambient+=amb;\n\tspecular+=spe;\n#endif\n\n#ifdef RECEIVESHADOW\n\tfloat shadowValue = 1.0;\n\t#ifdef SHADOWMAP_PSSM3\n\t\tshadowValue = getShadowPSSM3( u_shadowMap1,u_shadowMap2,u_shadowMap3,u_lightShadowVP,u_shadowPSSMDistance,u_shadowPCFoffset,v_PositionWorld,v_posViewZ,0.001);\n\t#endif\n\t#ifdef SHADOWMAP_PSSM2\n\t\tshadowValue = getShadowPSSM2( u_shadowMap1,u_shadowMap2,u_lightShadowVP,u_shadowPSSMDistance,u_shadowPCFoffset,v_PositionWorld,v_posViewZ,0.001);\n\t#endif \n\t#ifdef SHADOWMAP_PSSM1\n\t\tshadowValue = getShadowPSSM1( u_shadowMap1,v_lightMVPPos,u_shadowPSSMDistance,u_shadowPCFoffset,v_posViewZ,0.001);\n\t#endif\n#endif\n\n#ifdef LIGHTMAP\n\t#if defined(DIRECTIONLIGHT)||defined(POINTLIGHT)||defined(SPOTLIGHT)\n\t\tgl_FragColor.rgb=gl_FragColor.rgb*(u_MaterialAmbient + texture2D(u_LightMap, v_LightMapUV).rgb);\n\t#else\n\t\t#if defined(RECEIVESHADOW)\t\t\n\t\t\tgl_FragColor.rgb=gl_FragColor.rgb*(u_MaterialAmbient+texture2D(u_LightMap, v_LightMapUV).rgb * shadowValue);\n\t\t\t//vec3 tColor= u_MaterialAmbient + texture2D(u_LightMap, v_LightMapUV).rgb * shadowValue + mix(vec3(0.15,0.15,0.15),vec3(0.0),shadowValue);\n\t\t\t//gl_FragColor.rgb*=tColor;\n\t\t#else\n\t\t\tgl_FragColor.rgb=gl_FragColor.rgb*(u_MaterialAmbient + texture2D(u_LightMap, v_LightMapUV).rgb);\n\t\t#endif\n\t#endif\n#endif\n\ngl_FragColor=gl_FragColor*u_MaterialAlbedo;\n\n#if defined(DIRECTIONLIGHT)||defined(POINTLIGHT)||defined(SPOTLIGHT)\n\t#ifdef RECEIVESHADOW\n\t\tgl_FragColor = vec4( gl_FragColor.rgb*(ambient + diffuse*shadowValue) + specular * shadowValue,gl_FragColor.a);\n\t#else\n\t\tgl_FragColor =vec4( gl_FragColor.rgb*(ambient + diffuse) + specular, gl_FragColor.a);\n\t#endif\n#endif\n\n#ifdef FOG\n\tfloat lerpFact=clamp((toEyeLength-u_FogStart)/u_FogRange,0.0,1.0);\n\tgl_FragColor.rgb=mix(gl_FragColor.rgb,u_FogColor,lerpFact);\n#endif\n}\n\n\n\n\n\n';var p=pt.add(m,e,t,n,i);dn.SHADERDEFINE_DETAIL_NUM1=p.registerMaterialDefine("ExtendTerrain_DETAIL_NUM1"),dn.SHADERDEFINE_DETAIL_NUM2=p.registerMaterialDefine("ExtendTerrain_DETAIL_NUM2"),dn.SHADERDEFINE_DETAIL_NUM3=p.registerMaterialDefine("ExtendTerrain_DETAIL_NUM3"),dn.SHADERDEFINE_DETAIL_NUM4=p.registerMaterialDefine("ExtendTerrain_DETAIL_NUM4"),dn.SHADERDEFINE_DETAIL_NUM5=p.registerMaterialDefine("ExtendTerrain_DETAIL_NUM5")},e}(),gt=function(){function e(){this._data=null,this._data=[]}r(e,"laya.d3.shader.ValusArray");var t=e.prototype;return t.setValue=function(e,t){this._data[e]=t},a(0,t,"data",function(){return this._data}),e}(),xt=function(){function e(){this._currentPSSM=-1,this._numberOfPSSM=3,this._maxDistance=200,this._ratioOfDistance=1/this._numberOfPSSM,this._statesDirty=!0,this._lightCulling=null,this._renderTarget=null,this._lightVPMatrix=null,this._lightCameras=null,this._shadowQuenes=null,this._shadowMapTextureSize=1024,this._scene=null,this._PCFType=0,this._shaderValueLightVP=null,this._shaderValueVPs=null,this._spiltDistance=new Array(4),this._globalParallelLightDir=new ct(0,-1,0),this._boundingSphere=new Array(4),this._boundingBox=new Array(4),this._frustumPos=new Array(16),this._uniformDistance=new Array(4),this._logDistance=new Array(4),this._dimension=new Array(4),this._tempLookAt3=new ct,this._tempLookAt4=new dt,this._tempValue=new dt,this._tempPos=new ct,this._tempLightUp=new ct,this._tempMin=new dt,this._tempMax=new dt,this._tempMatrix44=new at,this._splitFrustumCulling=new et(at.DEFAULT),this._tempScaleMatrix44=new at,this._shadowPCFOffset=new ut(1/1024,1/1024),this._shaderValueDistance=new dt;var e=0;for(e=0;e<this._spiltDistance.length;e++)this._spiltDistance[e]=0;for(e=0;e<this._dimension.length;e++)this._dimension[e]=new ut;for(e=0;e<this._frustumPos.length;e++)this._frustumPos[e]=new ct;for(e=0;e<this._boundingBox.length;e++)this._boundingBox[e]=new Je(new ct,new ct);for(e=0;e<this._boundingSphere.length;e++)this._boundingSphere[e]=new tt(new ct,0);at.createScaling(new ct(.5,.5,1),this._tempScaleMatrix44),this._tempScaleMatrix44.elements[12]=.5,this._tempScaleMatrix44.elements[13]=.5}r(e,"laya.d3.shadowMap.ParallelSplitShadowMap");var t=e.prototype;return t.setInfo=function(e,t,n,i,r,a){r>3&&(this._numberOfPSSM=3),this._scene=e,this._maxDistance=t,this.PSSMNum=r,this._globalParallelLightDir=n,this._ratioOfDistance=1/this._numberOfPSSM;for(var s=0;s<this._spiltDistance.length;s++)this._spiltDistance[s]=0;this._shadowMapTextureSize=i,this._shadowPCFOffset.x=1/this._shadowMapTextureSize,this._shadowPCFOffset.y=1/this._shadowMapTextureSize,this.setPCFType(a),this._statesDirty=!0},t.setPCFType=function(e){switch(this._PCFType=e,this._PCFType){case 0:this._scene.addShaderDefine(laya.d3.shadowMap.ParallelSplitShadowMap.SHADERDEFINE_SHADOW_PCF_NO),this._scene.removeShaderDefine(laya.d3.shadowMap.ParallelSplitShadowMap.SHADERDEFINE_SHADOW_PCF1),this._scene.removeShaderDefine(laya.d3.shadowMap.ParallelSplitShadowMap.SHADERDEFINE_SHADOW_PCF2),this._scene.removeShaderDefine(laya.d3.shadowMap.ParallelSplitShadowMap.SHADERDEFINE_SHADOW_PCF3);break;case 1:this._scene.addShaderDefine(laya.d3.shadowMap.ParallelSplitShadowMap.SHADERDEFINE_SHADOW_PCF1),this._scene.removeShaderDefine(laya.d3.shadowMap.ParallelSplitShadowMap.SHADERDEFINE_SHADOW_PCF_NO),this._scene.removeShaderDefine(laya.d3.shadowMap.ParallelSplitShadowMap.SHADERDEFINE_SHADOW_PCF2),this._scene.removeShaderDefine(laya.d3.shadowMap.ParallelSplitShadowMap.SHADERDEFINE_SHADOW_PCF3);break;case 2:this._scene.addShaderDefine(laya.d3.shadowMap.ParallelSplitShadowMap.SHADERDEFINE_SHADOW_PCF2),this._scene.removeShaderDefine(laya.d3.shadowMap.ParallelSplitShadowMap.SHADERDEFINE_SHADOW_PCF_NO),this._scene.removeShaderDefine(laya.d3.shadowMap.ParallelSplitShadowMap.SHADERDEFINE_SHADOW_PCF1),this._scene.removeShaderDefine(laya.d3.shadowMap.ParallelSplitShadowMap.SHADERDEFINE_SHADOW_PCF3);break;case 3:this._scene.addShaderDefine(laya.d3.shadowMap.ParallelSplitShadowMap.SHADERDEFINE_SHADOW_PCF3),this._scene.removeShaderDefine(laya.d3.shadowMap.ParallelSplitShadowMap.SHADERDEFINE_SHADOW_PCF_NO),this._scene.removeShaderDefine(laya.d3.shadowMap.ParallelSplitShadowMap.SHADERDEFINE_SHADOW_PCF1),this._scene.removeShaderDefine(laya.d3.shadowMap.ParallelSplitShadowMap.SHADERDEFINE_SHADOW_PCF2)}},t.getPCFType=function(){return this._PCFType},t.setFarDistance=function(e){this._maxDistance!=e&&(this._maxDistance=e,this._statesDirty=!0)},t.getFarDistance=function(){return this._maxDistance},t._setGlobalParallelLightDir=function(e){this._globalParallelLightDir=e},t.getGlobalParallelLightDir=function(){return this._globalParallelLightDir},t.getCurrentPSSM=function(){return this._currentPSSM},t.getLightCamera=function(e){return this._lightCameras[e]},t._beginSampler=function(e,t){if(e<0||e>this._numberOfPSSM)throw new Error("ParallelSplitShadowMap: beginSample invalid index");this._currentPSSM=e,this._update(t)},t.endSampler=function(e){this._currentPSSM=-1},t._calcAllLightCameraInfo=function(e){if(1===this._numberOfPSSM)this._beginSampler(0,e),this.endSampler(e);else for(var t=0,n=this._numberOfPSSM+1;t<n;t++)this._beginSampler(t,e),this.endSampler(e)},t._recalculate=function(e,t,n){this._calcSplitDistance(e),this._calcBoundingBox(t,n),this._rebuildRenderInfo()},t._update=function(e){var t=e.nearPlane,n=e.fieldOfView,i=e.aspectRatio;(this._statesDirty||this.lastNearPlane!==t||this.lastFieldOfView!==n||this.lastAspectRatio!==i)&&(this._recalculate(t,n,i),this._uploadShaderValue(),this._statesDirty=!1,this.lastNearPlane=t,this.lastFieldOfView=n,this.lastAspectRatio=i),this._calcLightViewProject(e)},t._uploadShaderValue=function(){var e=this._scene;switch(this._numberOfPSSM){case 1:e.addShaderDefine(laya.d3.shadowMap.ParallelSplitShadowMap.SHADERDEFINE_SHADOW_PSSM1),e.removeShaderDefine(laya.d3.shadowMap.ParallelSplitShadowMap.SHADERDEFINE_SHADOW_PSSM2),e.removeShaderDefine(laya.d3.shadowMap.ParallelSplitShadowMap.SHADERDEFINE_SHADOW_PSSM3);break;case 2:e.addShaderDefine(laya.d3.shadowMap.ParallelSplitShadowMap.SHADERDEFINE_SHADOW_PSSM2),e.removeShaderDefine(laya.d3.shadowMap.ParallelSplitShadowMap.SHADERDEFINE_SHADOW_PSSM1),e.removeShaderDefine(laya.d3.shadowMap.ParallelSplitShadowMap.SHADERDEFINE_SHADOW_PSSM3);break;case 3:e.addShaderDefine(laya.d3.shadowMap.ParallelSplitShadowMap.SHADERDEFINE_SHADOW_PSSM3),e.removeShaderDefine(laya.d3.shadowMap.ParallelSplitShadowMap.SHADERDEFINE_SHADOW_PSSM1),e.removeShaderDefine(laya.d3.shadowMap.ParallelSplitShadowMap.SHADERDEFINE_SHADOW_PSSM2)}var t=e._shaderValues;switch(t.setValue(15,this._shaderValueDistance.elements),t.setValue(16,this._shaderValueLightVP),t.setValue(17,this._shadowPCFOffset.elements),this._numberOfPSSM){case 3:t.setValue(18,this.getRenderTarget(1).source),t.setValue(19,this.getRenderTarget(2).source),t.setValue(20,this.getRenderTarget(3).source);break;case 2:t.setValue(18,this.getRenderTarget(1).source),t.setValue(19,this.getRenderTarget(2).source);break;case 1:t.setValue(18,this.getRenderTarget(1).source)}},t._calcSplitDistance=function(e){var t=this._maxDistance,n=1/this._numberOfPSSM,i=0;for(i=0;i<=this._numberOfPSSM;i++)this._uniformDistance[i]=e+(t-e)*i*n;var r=t/e;for(i=0;i<=this._numberOfPSSM;i++){var a=Math.pow(r,i*n);this._logDistance[i]=e*a}for(i=0;i<=this._numberOfPSSM;i++)this._spiltDistance[i]=this._uniformDistance[i]*this._ratioOfDistance+this._logDistance[i]*(1-this._ratioOfDistance);this._shaderValueDistance.x=this._spiltDistance[1],this._shaderValueDistance.y=this._spiltDistance[2],this._shaderValueDistance.z=this._spiltDistance[3],this._shaderValueDistance.w=this._spiltDistance[4]},t._calcBoundingBox=function(e,t){var n=3.1415926*e/180,i=Math.tan(n/2),r=NaN,a=NaN,s=NaN,o=0;for(o=0;o<=this._numberOfPSSM;o++){a=(r=(s=this._spiltDistance[o])*i)*t;var l=this._frustumPos[4*o+0].elements;l[0]=-a,l[1]=-r,l[2]=-s,(l=this._frustumPos[4*o+1].elements)[0]=a,l[1]=-r,l[2]=-s,(l=this._frustumPos[4*o+2].elements)[0]=-a,l[1]=r,l[2]=-s,(l=this._frustumPos[4*o+3].elements)[0]=a,l[1]=r,l[2]=-s,(l=this._dimension[o].elements)[0]=a,l[1]=r}var h,_,u,c;for(o=1;o<=this._numberOfPSSM;o++)h=this._dimension[o].elements,(_=this._boundingBox[o].min.elements)[0]=-h[0],_[1]=-h[1],_[2]=-this._spiltDistance[o],(u=this._boundingBox[o].max.elements)[0]=h[0],u[1]=h[1],u[2]=-this._spiltDistance[o-1],(c=this._boundingSphere[o].center.elements)[0]=.5*(_[0]+u[0]),c[1]=.5*(_[1]+u[1]),c[2]=.5*(_[2]+u[2]),this._boundingSphere[o].radius=.5*Math.sqrt(Math.pow(u[0]-_[0],2)+Math.pow(u[1]-_[1],2)+Math.pow(u[2]-_[2],2));_=this._boundingBox[0].min.elements,h=this._dimension[this._numberOfPSSM].elements,_[0]=-h[0],_[1]=-h[1],_[2]=-this._spiltDistance[this._numberOfPSSM],(u=this._boundingBox[0].max.elements)[0]=h[0],u[1]=h[1],u[2]=-this._spiltDistance[0],(c=this._boundingSphere[0].center.elements)[0]=.5*(_[0]+u[0]),c[1]=.5*(_[1]+u[1]),c[2]=.5*(_[2]+u[2]),this._boundingSphere[0].radius=.5*Math.sqrt(Math.pow(u[0]-_[0],2)+Math.pow(u[1]-_[1],2)+Math.pow(u[2]-_[2],2))},t.calcSplitFrustum=function(e){this._currentPSSM>0?at.createPerspective(3.1416*e.fieldOfView/180,e.aspectRatio,this._spiltDistance[this._currentPSSM-1],this._spiltDistance[this._currentPSSM],this._tempMatrix44):at.createPerspective(3.1416*e.fieldOfView/180,e.aspectRatio,this._spiltDistance[0],this._spiltDistance[this._numberOfPSSM],this._tempMatrix44),at.multiply(this._tempMatrix44,e.viewMatrix,this._tempMatrix44),this._splitFrustumCulling.matrix=this._tempMatrix44},t._rebuildRenderInfo=function(){var e=this._numberOfPSSM+1,t=0;if(null==this._renderTarget)for(this._renderTarget=s(e),this._renderTarget[0]=null,t=1;t<e;t++)this._renderTarget[t]=new An(this._shadowMapTextureSize,this._shadowMapTextureSize,6408,5121,33189,!1,!1,9728,9728);else if(this._renderTarget.length!=e)for(this.disposeAllRenderTarget(),this._renderTarget.length=e,this._renderTarget[0]=null,t=1;t<e;t++)this._renderTarget[t]=new An(this._shadowMapTextureSize,this._shadowMapTextureSize,6408,5121,33189,!1,!1,9728,9728);else for(t=1;t<e;t++)null!=this._renderTarget[t]&&this._renderTarget[t].width==this._shadowMapTextureSize&&this._renderTarget[t].height==this._shadowMapTextureSize||(null!=this._renderTarget[t]&&this._renderTarget[t].dispose(),this._renderTarget[t]=new An(this._shadowMapTextureSize,this._shadowMapTextureSize,6408,5121,33189,!1,!1,9728,9728));if(null==this._lightCulling||this._lightCulling.length!=e)for(this._lightCulling?this._lightCulling.length=e:this._lightCulling=s(e),t=0;t<this._lightCulling.length;t++)this._lightCulling[t]=new et(at.DEFAULT);if(null==this._lightVPMatrix||this._lightVPMatrix.length!=e)for(this._lightVPMatrix?this._lightVPMatrix.length=e:this._lightVPMatrix=s(e),t=0;t<this._lightVPMatrix.length;t++)this._lightVPMatrix[t]=new at;if(null==this._lightCameras||this._lightCameras.length!=e)for(this._lightCameras?this._lightCameras.length=e:this._lightCameras=s(e),t=0;t<this._lightCameras.length;t++)this._lightCameras[t]=new Bn,this._lightCameras[t].name="lightCamera"+t;if(null==this._shadowQuenes||this._shadowQuenes.length!=this._numberOfPSSM)for(this._shadowQuenes?this._shadowQuenes.length=this._numberOfPSSM:this._shadowQuenes=s(this._numberOfPSSM),t=0;t<this._shadowQuenes.length;t++)this._shadowQuenes[t]=new le(this._scene);if(null==this._shaderValueVPs||this._shaderValueVPs.length!=e)for(this._shaderValueVPs?this._shaderValueVPs.length=e:this._shaderValueVPs=s(e),this._shaderValueLightVP=new Float32Array(16*e),t=0;t<e;t++)this._shaderValueVPs[t]=new Float32Array(this._shaderValueLightVP.buffer,64*t)},t._calcLightViewProject=function(t){var n=this._boundingSphere[this._currentPSSM],i=t.transform.worldMatrix;n.radius;n.center.cloneTo(this._tempLookAt3),ct.transformV3ToV4(this._tempLookAt3,i,this._tempLookAt4);var r=this._tempLookAt3.elements,a=this._tempLookAt4.elements;r[0]=a[0],r[1]=a[1],r[2]=a[2];var s=this._tempLightUp.elements,o=t.forward.elements;s[0]=o[0],s[1]=1,s[2]=o[2],ct.normalize(this._tempLightUp,this._tempLightUp),ct.scale(this._globalParallelLightDir,4*n.radius,this._tempPos),ct.subtract(this._tempLookAt3,this._tempPos,this._tempPos);var l=this._lightCameras[this._currentPSSM];l.transform.position=this._tempPos,l.transform.lookAt(this._tempLookAt3,this._tempLightUp,!1);var h=this._tempMax.elements,_=this._tempMin.elements;h[0]=h[1]=h[2]=-1e5,h[3]=1,_[0]=_[1]=_[2]=1e5,_[3]=1,at.multiply(l.viewMatrix,i,this._tempMatrix44);var u=this._tempValue.elements,c=[];c.length=8,this._boundingBox[this._currentPSSM].getCorners(c);for(var d=0;d<8;d++){var f=c[d].elements;u[0]=f[0],u[1]=f[1],u[2]=f[2],u[3]=1,dt.transformByM4x4(this._tempValue,this._tempMatrix44,this._tempValue),_[0]=u[0]<_[0]?u[0]:_[0],_[1]=u[1]<_[1]?u[1]:_[1],_[2]=u[2]<_[2]?u[2]:_[2],h[0]=u[0]>h[0]?u[0]:h[0],h[1]=u[1]>h[1]?u[1]:h[1],h[2]=u[2]>h[2]?u[2]:h[2]}dt.add(this._tempMax,this._tempMin,this._tempValue),u[0]*=.5,u[1]*=.5,u[2]*=.5,u[3]=1,dt.transformByM4x4(this._tempValue,l.transform.worldMatrix,this._tempValue);var m=Math.abs(-this._tempMax.z),p=m>this._maxDistance?m:this._maxDistance;ct.scale(this._globalParallelLightDir,p,this._tempPos);var v=this._tempPos.elements;v[0]=u[0]-v[0],v[1]=u[1]-v[1],v[2]=u[2]-v[2],l.transform.position=this._tempPos,l.transform.lookAt(this._tempLookAt3,this._tempLightUp,!1),at.createOrthoOffCenterRH(_[0],h[0],_[1],h[1],1,p+.5*(h[2]-_[2]),l.projectionMatrix),l.projectionViewMatrix.cloneTo(this._lightVPMatrix[this._currentPSSM]),this._lightCulling[this._currentPSSM].matrix=this._lightVPMatrix[this._currentPSSM],e.multiplyMatrixOutFloat32Array(this._tempScaleMatrix44,this._lightVPMatrix[this._currentPSSM],this._shaderValueVPs[this._currentPSSM])},t.getLightFrustumCulling=function(e){return this._lightCulling[e]},t.getSplitFrustumCulling=function(){return this._splitFrustumCulling},t.getSplitDistance=function(e){return this._spiltDistance[e]},t.setShadowMapTextureSize=function(e){e!==this._shadowMapTextureSize&&(this._shadowMapTextureSize=e,this._shadowPCFOffset.x=1/this._shadowMapTextureSize,this._shadowPCFOffset.y=1/this._shadowMapTextureSize,this._statesDirty=!0)},t.getShadowMapTextureSize=function(){return this._shadowMapTextureSize},t.beginRenderTarget=function(e){this._renderTarget[e].start()},t.endRenderTarget=function(e){this._renderTarget[e].end()},t.getRenderTarget=function(e){return this._renderTarget[e]},t.disposeAllRenderTarget=function(){for(var e=0,t=this._numberOfPSSM+1;e<t;e++)this._renderTarget[e]&&(this._renderTarget[e].dispose(),this._renderTarget[e]=null)},a(0,t,"PSSMNum",function(){return this._numberOfPSSM},function(e){e=(e=e>0?e:1)<=3?e:3,this._numberOfPSSM!=e&&(this._numberOfPSSM=e,this._ratioOfDistance=1/this._numberOfPSSM,this._statesDirty=!0)}),e.multiplyMatrixOutFloat32Array=function(e,t,n){var i,r,a,s,o,l,h;for(r=e.elements,a=t.elements,i=0;i<4;i++)s=r[i],o=r[i+4],l=r[i+8],h=r[i+12],n[i]=s*a[0]+o*a[1]+l*a[2]+h*a[3],n[i+4]=s*a[4]+o*a[5]+l*a[6]+h*a[7],n[i+8]=s*a[8]+o*a[9]+l*a[10]+h*a[11],n[i+12]=s*a[12]+o*a[13]+l*a[14]+h*a[15]},e.SHADERDEFINE_RECEIVE_SHADOW=1,e.SHADERDEFINE_CAST_SHADOW=512,e.SHADERDEFINE_SHADOW_PSSM1=1024,e.SHADERDEFINE_SHADOW_PSSM2=2048,e.SHADERDEFINE_SHADOW_PSSM3=4096,e.SHADERDEFINE_SHADOW_PCF_NO=8192,e.SHADERDEFINE_SHADOW_PCF1=16384,e.SHADERDEFINE_SHADOW_PCF2=32768,e.SHADERDEFINE_SHADOW_PCF3=65536,e.MAX_PSSM_COUNT=3,e}(),Et=function(){function e(){this._boundingSphere=null,this._boundingBox=null,this._sizeOfY=null,this._currentLODLevel=0,this._lastDistanceToEye=NaN,this._originalBoundingSphere=null,this._originalBoundingBox=null,this._originalBoundingBoxCorners=null,this._bUseStrip=!1,this._gridSize=NaN,this._beginGridX=0,this._beginGridZ=0,this._LODError=null,e.__init__(),this._currentLODLevel=0}r(e,"laya.d3.terrain.TerrainLeaf");var t=e.prototype;return t.calcVertextNorml=function(t,n,i,r,a,s){var o=0,l=0;l=-1*e.getHeightFromTerrainHeightData(t-1,n-1,i,r,a),l+=-1*e.getHeightFromTerrainHeightData(t-1,n,i,r,a),l+=-1*e.getHeightFromTerrainHeightData(t-1,n+1,i,r,a),l+=1*e.getHeightFromTerrainHeightData(t+1,n-1,i,r,a),l+=1*e.getHeightFromTerrainHeightData(t+1,n,i,r,a),l+=1*e.getHeightFromTerrainHeightData(t+1,n+1,i,r,a),o=-1*e.getHeightFromTerrainHeightData(t-1,n-1,i,r,a),o+=-1*e.getHeightFromTerrainHeightData(t,n-1,i,r,a),o+=-1*e.getHeightFromTerrainHeightData(t+1,n-1,i,r,a),o+=1*e.getHeightFromTerrainHeightData(t-1,n+1,i,r,a),o+=1*e.getHeightFromTerrainHeightData(t,n+1,i,r,a),o+=1*e.getHeightFromTerrainHeightData(t+1,n+1,i,r,a),s.x=-l,s.y=6,s.z=-o,ct.normalize(s,s)},t.calcVertextNormlUV=function(e,t,n,i,r){r.x=e/n,r.y=t/i,r.z=t/i},t.calcVertextBuffer=function(t,n,i,r,a,s,o,l,h,_,u,c){if(1==c&&!e.__ADAPT_MATRIX__){e.__ADAPT_MATRIX__=new at;var d=new at;at.createRotationY(Math.PI,e.__ADAPT_MATRIX__),at.createTranslate(new ct(0,0,(u-1)*a),d),at.multiply(d,e.__ADAPT_MATRIX__,e.__ADAPT_MATRIX__),e.__ADAPT_MATRIX_INV__=new at,e.__ADAPT_MATRIX__.invert(e.__ADAPT_MATRIX_INV__)}this._gridSize=a,this._beginGridX=t*e.CHUNK_GRID_NUM+i,this._beginGridZ=n*e.CHUNK_GRID_NUM+r;for(var f=o*l,m=2147483647,p=-2147483648,v=new ct,g=0,x=e.LEAF_GRID_NUM+1;g<x;g++)for(var E=0,S=e.LEAF_GRID_NUM+1;E<S;E++)e.__VECTOR3__.x=(this._beginGridX+E)*this._gridSize,e.__VECTOR3__.z=(this._beginGridZ+g)*this._gridSize,e.__VECTOR3__.y=h[(this._beginGridZ+g)*_+(this._beginGridX+E)],m=e.__VECTOR3__.y<m?e.__VECTOR3__.y:m,p=e.__VECTOR3__.y>p?e.__VECTOR3__.y:p,e.__ADAPT_MATRIX__&&ct.transformV3ToV3(e.__VECTOR3__,e.__ADAPT_MATRIX__,e.__VECTOR3__),s[f]=e.__VECTOR3__.x,s[++f]=e.__VECTOR3__.y,s[++f]=e.__VECTOR3__.z,f++,this.calcVertextNormlUV(this._beginGridX+E,this._beginGridZ+g,_,u,v),s[f]=v.x,s[++f]=v.y,s[++f]=v.z,s[++f]=(i+E)/e.CHUNK_GRID_NUM,s[++f]=(r+g)/e.CHUNK_GRID_NUM,s[++f]=this._beginGridX+E,s[++f]=this._beginGridZ+g,f++;this._sizeOfY=new ut(m-1,p+1),this.calcLODErrors(h,_,u),this.calcOriginalBoudingBoxAndSphere()},t.calcSkirtVertextBuffer=function(t,n,i,r,a,s,o,l,h,_,u){this._gridSize=a,this._beginGridX=t*e.CHUNK_GRID_NUM+i,this._beginGridZ=n*e.CHUNK_GRID_NUM+r;var c=o*l,d=0,f=0,m=e.LEAF_GRID_NUM+1,p=new ct,v=0,g=0;for(d=0;d<2;d++)for(f=0;f<m;f++)e.__VECTOR3__.x=(this._beginGridX+f)*this._gridSize,e.__VECTOR3__.y=1==d?h[this._beginGridZ*_+(this._beginGridX+f)]:-this._gridSize,e.__VECTOR3__.z=(this._beginGridZ+0)*this._gridSize,e.__ADAPT_MATRIX__&&ct.transformV3ToV3(e.__VECTOR3__,e.__ADAPT_MATRIX__,e.__VECTOR3__),s[c]=e.__VECTOR3__.x,s[++c]=e.__VECTOR3__.y,s[++c]=e.__VECTOR3__.z,c++,v=0==d?this._beginGridZ-1:this._beginGridZ,this.calcVertextNormlUV(this._beginGridX+f,v,_,u,p),s[c]=p.x,s[++c]=p.y,s[++c]=p.z,s[++c]=(i+f)/e.CHUNK_GRID_NUM,s[++c]=(r+0)/e.CHUNK_GRID_NUM,s[++c]=this._beginGridX+f,s[++c]=v,c++;for(d=0;d<2;d++)for(f=0;f<m;f++)e.__VECTOR3__.x=(this._beginGridX+f)*this._gridSize,e.__VECTOR3__.y=0==d?h[(this._beginGridZ+e.LEAF_GRID_NUM)*_+(this._beginGridX+f)]:-this._gridSize,e.__VECTOR3__.z=(this._beginGridZ+e.LEAF_GRID_NUM)*this._gridSize,e.__ADAPT_MATRIX__&&ct.transformV3ToV3(e.__VECTOR3__,e.__ADAPT_MATRIX__,e.__VECTOR3__),s[c]=e.__VECTOR3__.x,s[++c]=e.__VECTOR3__.y,s[++c]=e.__VECTOR3__.z,c++,v=0==d?this._beginGridZ+e.LEAF_GRID_NUM:this._beginGridZ+e.LEAF_GRID_NUM+1,this.calcVertextNormlUV(this._beginGridX+f,v,_,u,p),s[c]=p.x,s[++c]=p.y,s[++c]=p.z,s[++c]=(i+f)/e.CHUNK_GRID_NUM,s[++c]=(r+e.LEAF_GRID_NUM)/e.CHUNK_GRID_NUM,s[++c]=this._beginGridX+f,s[++c]=v,c++;for(d=0;d<2;d++)for(f=0;f<m;f++)e.__VECTOR3__.x=(this._beginGridX+0)*this._gridSize,e.__VECTOR3__.y=0==d?h[(this._beginGridZ+f)*_+(this._beginGridX+0)]:-this._gridSize,e.__VECTOR3__.z=(this._beginGridZ+f)*this._gridSize,e.__ADAPT_MATRIX__&&ct.transformV3ToV3(e.__VECTOR3__,e.__ADAPT_MATRIX__,e.__VECTOR3__),s[c]=e.__VECTOR3__.x,s[++c]=e.__VECTOR3__.y,s[++c]=e.__VECTOR3__.z,c++,g=0==d?this._beginGridX:this._beginGridX-1,this.calcVertextNormlUV(g,this._beginGridZ+f,_,u,p),s[c]=p.x,s[++c]=p.y,s[++c]=p.z,s[++c]=(i+0)/e.CHUNK_GRID_NUM,s[++c]=(r+f)/e.CHUNK_GRID_NUM,s[++c]=g,s[++c]=this._beginGridZ+f,c++;for(d=0;d<2;d++)for(f=0;f<m;f++)e.__VECTOR3__.x=(this._beginGridX+e.LEAF_GRID_NUM)*this._gridSize,e.__VECTOR3__.y=1==d?h[(this._beginGridZ+f)*_+(this._beginGridX+e.LEAF_GRID_NUM)]:-this._gridSize,e.__VECTOR3__.z=(this._beginGridZ+f)*this._gridSize,e.__ADAPT_MATRIX__&&ct.transformV3ToV3(e.__VECTOR3__,e.__ADAPT_MATRIX__,e.__VECTOR3__),s[c]=e.__VECTOR3__.x,s[++c]=e.__VECTOR3__.y,s[++c]=e.__VECTOR3__.z,c++,g=0==d?this._beginGridX+e.LEAF_GRID_NUM+1:this._beginGridX+e.LEAF_GRID_NUM,this.calcVertextNormlUV(g,this._beginGridZ+f,_,u,p),s[c]=p.x,s[++c]=p.y,s[++c]=p.z,s[++c]=(i+e.LEAF_GRID_NUM)/e.CHUNK_GRID_NUM,s[++c]=(r+f)/e.CHUNK_GRID_NUM,s[++c]=g,s[++c]=this._beginGridZ+f,c++},t.calcOriginalBoudingBoxAndSphere=function(){var t=new ct(this._beginGridX*this._gridSize,this._sizeOfY.x,this._beginGridZ*this._gridSize),n=new ct((this._beginGridX+e.LEAF_GRID_NUM)*this._gridSize,this._sizeOfY.y,(this._beginGridZ+e.LEAF_GRID_NUM)*this._gridSize);e.__ADAPT_MATRIX__&&(ct.transformV3ToV3(t,e.__ADAPT_MATRIX__,t),ct.transformV3ToV3(n,e.__ADAPT_MATRIX__,n)),this._originalBoundingBox=new Je(t,n);var i=new ct;ct.subtract(n,t,i),ct.scale(i,.5,i);var r=new ct;ct.add(t,i,r),this._originalBoundingSphere=new tt(r,ct.scalarLength(i)),this._originalBoundingBoxCorners=[],this._originalBoundingBoxCorners.length=8,this._originalBoundingBox.getCorners(this._originalBoundingBoxCorners),this._boundingBox=new Je(new ct(-.5,-.5,-.5),new ct(.5,.5,.5)),this._boundingSphere=new tt(new ct(0,0,0),1)},t.calcLeafBoudingBox=function(e){for(var t=0;t<8;t++)ct.transformCoordinate(this._originalBoundingBoxCorners[t],e,Ot._tempBoundBoxCorners[t]);Je.createfromPoints(Ot._tempBoundBoxCorners,this._boundingBox)},t.calcLeafBoudingSphere=function(e,t){ct.transformCoordinate(this._originalBoundingSphere.center,e,this._boundingSphere.center),this._boundingSphere.radius=this._originalBoundingSphere.radius*t},t.calcLODErrors=function(t,n,i){this._LODError=new Float32Array(e._maxLODLevel+1);for(var r=1,a=0,s=e._maxLODLevel+1;a<s;a++){for(var o=0,l=0,h=e.LEAF_GRID_NUM;l<h;l+=r)for(var _=0,u=e.LEAF_GRID_NUM;_<u;_+=r)for(var c=t[(this._beginGridZ+l)*n+(this._beginGridX+_)],d=t[(this._beginGridZ+l)*n+(this._beginGridX+_)+r],f=t[(this._beginGridZ+l+r)*n+(this._beginGridX+_)],m=t[(this._beginGridZ+l+r)*n+(this._beginGridX+_)+r],p=0;p<r;p++)for(var v=p/r,g=0;g<r;g++){var x=g/r,E=t[(this._beginGridZ+l+p)*n+(this._beginGridX+_)+g],S=x+v<=1?c+(d-c)*x+(f-c)*v:m+(f-m)*(1-x)+(d-m)*(1-v),D=Math.abs(S-E);o=Math.max(o,D)}r*=2,this._LODError[a]=o}},t.determineLod=function(t,n,i,r){var a=ct.distance(t,this._boundingSphere.center),s=e._maxLODLevel;if(!r){if(this._lastDistanceToEye==a)return this._currentLODLevel;this._lastDistanceToEye>a&&(s=this._currentLODLevel)}for(var o=s;o>=1;o--)if(Ln.LOD_DISTANCE_FACTOR*this._LODError[o]/a*n<i){this._currentLODLevel=o;break}return this._lastDistanceToEye=a,this._currentLODLevel},e.__init__=function(){if(!e._bInit){var t=e.CHUNK_GRID_NUM/e.LEAF_GRID_NUM*(e.CHUNK_GRID_NUM/e.LEAF_GRID_NUM);e._planeLODIndex=s(t);var n=0,i=0,r=0,a=0,o=0,l=0,h=null,_=null;for(n=0;n<t;n++)e._planeLODIndex[n]=new Array(e._maxLODLevel+1);for(n=0,a=e._maxLODLevel+1;n<a;n++)e._planeLODIndex[0][n]=e.calcPlaneLODIndex(n);for(n=1;n<t;n++)for(l=n*e.LEAF_PLANE_VERTEXT_COUNT,i=0,o=e._maxLODLevel+1;i<o;i++){for(h=e._planeLODIndex[0][i],_=new Uint16Array(h.length),r=0;r<h.length;r++)_[r]=h[r]+l;e._planeLODIndex[n][i]=_}for(e._skirtLODIndex=s(t),n=0;n<t;n++)e._skirtLODIndex[n]=new Array(e._maxLODLevel+1);for(n=0,a=e._maxLODLevel+1;n<a;n++)e._skirtLODIndex[0][n]=e.calcSkirtLODIndex(n);for(n=1;n<t;n++)for(l=n*e.LEAF_SKIRT_VERTEXT_COUNT,i=0,o=e._maxLODLevel+1;i<o;i++){for(h=e._skirtLODIndex[0][i],_=new Uint16Array(h.length),r=0;r<h.length;r++)_[r]=h[r]+l;e._skirtLODIndex[n][i]=_}e._bInit=!0}},e.getPlaneLODIndex=function(t,n){return e._planeLODIndex[t][n]},e.getSkirtLODIndex=function(t,n){return e._skirtLODIndex[t][n]},e.calcPlaneLODIndex=function(t){t>e._maxLODLevel&&(t=e._maxLODLevel);var n=e.LEAF_GRID_NUM+1,i=0,r=null,a=laya.d3.terrain.TerrainLeaf.LEAF_GRID_NUM/Math.pow(2,t);r=new Uint16Array(a*a*6);for(var s=laya.d3.terrain.TerrainLeaf.LEAF_GRID_NUM/a,o=0;o<e.LEAF_GRID_NUM;o+=s)for(var l=0;l<e.LEAF_GRID_NUM;l+=s)r[i]=(o+s)*n+l,r[++i]=o*n+l,r[++i]=o*n+l+s,r[++i]=o*n+l+s,r[++i]=(o+s)*n+l+s,r[++i]=(o+s)*n+l,i++;return r},e.calcSkirtLODIndex=function(t){t>e._maxLODLevel&&(t=e._maxLODLevel);var n=e.CHUNK_GRID_NUM/e.LEAF_GRID_NUM*(e.CHUNK_GRID_NUM/e.LEAF_GRID_NUM)*e.LEAF_PLANE_VERTEXT_COUNT,i=e.LEAF_GRID_NUM+1,r=0,a=null,s=laya.d3.terrain.TerrainLeaf.LEAF_GRID_NUM/Math.pow(2,t);a=new Uint16Array(4*s*6);for(var o=laya.d3.terrain.TerrainLeaf.LEAF_GRID_NUM/s,l=0;l<4;l++){for(var h=0;h<e.LEAF_GRID_NUM;h+=o)a[r]=n+i+h,a[++r]=n+h,a[++r]=n+h+o,a[++r]=n+h+o,a[++r]=n+i+h+o,a[++r]=n+i+h,r++;n+=2*i}return a},e.getHeightFromTerrainHeightData=function(e,t,n,i,r){return e=e<0?0:e,e=e>=i?i-1:e,t=t<0?0:t,t=t>=r?r-1:t,n[t*i+e]},e.CHUNK_GRID_NUM=64,e.LEAF_GRID_NUM=32,e.__ADAPT_MATRIX__=null,e.__ADAPT_MATRIX_INV__=null,e._planeLODIndex=null,e._skirtLODIndex=null,e._bInit=!1,i(e,["LEAF_PLANE_VERTEXT_COUNT",function(){return this.LEAF_PLANE_VERTEXT_COUNT=(e.LEAF_GRID_NUM+1)*(e.LEAF_GRID_NUM+1)},"LEAF_SKIRT_VERTEXT_COUNT",function(){return this.LEAF_SKIRT_VERTEXT_COUNT=2*(e.LEAF_GRID_NUM+1)*4},"LEAF_VERTEXT_COUNT",function(){return this.LEAF_VERTEXT_COUNT=e.LEAF_PLANE_VERTEXT_COUNT+e.LEAF_SKIRT_VERTEXT_COUNT},"LEAF_PLANE_MAX_INDEX_COUNT",function(){return this.LEAF_PLANE_MAX_INDEX_COUNT=e.LEAF_GRID_NUM*e.LEAF_GRID_NUM*6},"LEAF_SKIRT_MAX_INDEX_COUNT",function(){return this.LEAF_SKIRT_MAX_INDEX_COUNT=4*e.LEAF_GRID_NUM*6},"LEAF_MAX_INDEX_COUNT",function(){return this.LEAF_MAX_INDEX_COUNT=e.LEAF_PLANE_MAX_INDEX_COUNT+e.LEAF_SKIRT_MAX_INDEX_COUNT},"__VECTOR3__",function(){return this.__VECTOR3__=new ct},"_maxLODLevel",function(){return this._maxLODLevel=Math.log2(e.LEAF_GRID_NUM)}]),e}(),St=function(){function e(){this.alphaMap=null,this.detailID=null,this.normalMap=null}return r(e,"laya.d3.terrain.unit.ChunkInfo"),e}(),Dt=function(){function e(){this.diffuseTexture=null,this.normalTexture=null,this.scale=null,this.offset=null}return r(e,"laya.d3.terrain.unit.DetailTextureInfo"),e}(),Tt=function(){function e(){this.ambientColor=null,this.diffuseColor=null,this.specularColor=null}return r(e,"laya.d3.terrain.unit.MaterialInfo"),e}(),Mt=function(){function e(){}return r(e,"laya.d3.utils.Physics"),e.rayCast=function(t,n,i,r){void 0===i&&(i=Number.MAX_VALUE),void 0===r&&(r=0),e._outHitAllInfo.length=0;for(var a=H.getLayerByNumber(r)._colliders,s=0,o=a.length;s<o;s++)if(a[s].raycast(t,e._outHitInfo,i),-1!==e._outHitInfo.distance&&e._outHitInfo.distance<=i){var l=new Rt;e._outHitInfo.cloneTo(l),e._outHitAllInfo.push(l)}if(0==e._outHitAllInfo.length)return n.sprite3D=null,void(n.distance=-1);for(var h=Number.MAX_VALUE,_=0,u=0;u<e._outHitAllInfo.length;u++)e._outHitAllInfo[u].distance<h&&(h=e._outHitAllInfo[u].distance,_=u);e._outHitAllInfo[_].cloneTo(n)},e.rayCastAll=function(t,n,i,r){void 0===i&&(i=Number.MAX_VALUE),void 0===r&&(r=0),n.length=0;for(var a=H.getLayerByNumber(r)._colliders,s=0,o=a.length;s<o;s++)if(e._outHitInfo.distance=-1,e._outHitInfo.sprite3D=null,a[s].raycast(t,e._outHitInfo,i),-1!==e._outHitInfo.distance&&e._outHitInfo.distance<=i){var l=new Rt;e._outHitInfo.cloneTo(l),n.push(l)}},e._outHitAllInfo=[],i(e,["_outHitInfo",function(){return this._outHitInfo=new Rt},"gravity",function(){return this.gravity=new ct(0,-9.81,0)}]),e}(),yt=function(){function e(){}return r(e,"laya.d3.utils.Picker"),e.calculateCursorRay=function(t,n,i,r,a,s){var o=t.elements[0],l=t.elements[1],h=e._tempVector30,_=h.elements;_[0]=o,_[1]=l,_[2]=n.minDepth;var u=e._tempVector31,c=u.elements;c[0]=o,c[1]=l,c[2]=n.maxDepth;var d=s.origin,f=e._tempVector32;n.unprojectFromWVP(h,i,r,a,d),n.unprojectFromWVP(u,i,r,a,f);var m=s.direction.elements;m[0]=f.x-d.x,m[1]=f.y-d.y,m[2]=f.z-d.z,ct.normalize(s.direction,s.direction)},e.rayIntersectsPositionsAndIndices=function(t,n,i,r,a){for(var s=i.vertexStride/4,o=i.getVertexElementByUsage(0).offset/4,l=Number.MAX_VALUE,h=-1,_=-1,u=-1,c=0;c<r.length;c+=3){var d=e._tempVector35,f=d.elements,m=r[c]*s,p=m+o;f[0]=n[p],f[1]=n[p+1],f[2]=n[p+2];var v=e._tempVector36,g=v.elements,x=r[c+1]*s,E=x+o;g[0]=n[E],g[1]=n[E+1],g[2]=n[E+2];var S=e._tempVector37,D=S.elements,T=r[c+2]*s,M=T+o;D[0]=n[M],D[1]=n[M+1],D[2]=n[M+2];var y=laya.d3.utils.Picker.rayIntersectsTriangle(t,d,v,S);!isNaN(y)&&y<l&&(l=y,h=m,_=x,u=T)}if(l!==Number.MAX_VALUE){a.distance=l,ct.scale(t.direction,l,a.position),ct.add(t.origin,a.position,a.position);var R=a.trianglePositions,A=R[0],C=R[1],I=R[2],w=A.elements,V=C.elements,N=I.elements,O=h+o;w[0]=n[O],w[1]=n[O+1],w[2]=n[O+2];var b=_+o;V[0]=n[b],V[1]=n[b+1],V[2]=n[b+2];var P=u+o;N[0]=n[P],N[1]=n[P+1],N[2]=n[P+2];var L=i.getVertexElementByUsage(3);if(L){var F=L.offset/4,B=a.triangleNormals,U=B[0],H=B[1],z=B[2],G=U.elements,k=H.elements,W=z.elements,X=h+F;G[0]=n[X],G[1]=n[X+1],G[2]=n[X+2];var j=_+F;k[0]=n[j],k[1]=n[j+1],k[2]=n[j+2];var Z=u+F;W[0]=n[Z],W[1]=n[Z+1],W[2]=n[Z+2]}return!0}return a.position.toDefault(),a.distance=Number.MAX_VALUE,a.trianglePositions[0].toDefault(),a.trianglePositions[1].toDefault(),a.trianglePositions[2].toDefault(),a.triangleNormals[0].toDefault(),a.triangleNormals[1].toDefault(),a.triangleNormals[2].toDefault(),!1},e.rayIntersectsTriangle=function(t,n,i,r){var a=e._tempVector30,s=e._tempVector31;ct.subtract(i,n,a),ct.subtract(r,n,s);var o=e._tempVector32;ct.cross(t.direction,s,o);var l;if((l=ct.dot(a,o))>-Number.MIN_VALUE&&l<Number.MIN_VALUE)return Number.NaN;var h=1/l,_=e._tempVector33;ct.subtract(t.origin,n,_);var u;if(u=ct.dot(_,o),(u*=h)<0||u>1)return Number.NaN;var c=e._tempVector34;ct.cross(_,a,c);var d;if(d=ct.dot(t.direction,c),(d*=h)<0||u+d>1)return Number.NaN;var f;return f=ct.dot(s,c),(f*=h)<0?Number.NaN:f},i(e,["_tempVector30",function(){return this._tempVector30=new ct},"_tempVector31",function(){return this._tempVector31=new ct},"_tempVector32",function(){return this._tempVector32=new ct},"_tempVector33",function(){return this._tempVector33=new ct},"_tempVector34",function(){return this._tempVector34=new ct},"_tempVector35",function(){return this._tempVector35=new ct},"_tempVector36",function(){return this._tempVector36=new ct},"_tempVector37",function(){return this._tempVector37=new ct}]),e}(),Rt=function(){function e(){this.distance=NaN,this.trianglePositions=null,this.triangleNormals=null,this.position=null,this.sprite3D=null,this.distance=-1,this.trianglePositions=[new ct,new ct,new ct],this.trianglePositions.length=3,this.triangleNormals=[new ct,new ct,new ct],this.triangleNormals.length=3,this.position=new ct}return r(e,"laya.d3.utils.RaycastHit"),e.prototype.cloneTo=function(e){e.distance=this.distance,this.trianglePositions[0].cloneTo(e.trianglePositions[0]),this.trianglePositions[1].cloneTo(e.trianglePositions[1]),this.trianglePositions[2].cloneTo(e.trianglePositions[2]),this.triangleNormals[0].cloneTo(e.triangleNormals[0]),this.triangleNormals[1].cloneTo(e.triangleNormals[1]),this.triangleNormals[2].cloneTo(e.triangleNormals[2]),this.position.cloneTo(e.position),e.sprite3D=this.sprite3D},e}(),At=function(){function e(e,t){this._width=0,this._height=0,this._width=e,this._height=t}r(e,"laya.d3.utils.Size");var t=e.prototype;return a(0,t,"width",function(){return-1===this._width?he.clientWidth:this._width}),a(0,t,"height",function(){return-1===this._height?he.clientHeight:this._height}),a(1,e,"fullScreen",function(){return new e(-1,-1)}),e}(),Ct=function(){function e(){}return r(e,"laya.d3.utils.Utils3D"),e.prototype.testTangent=function(e,t,n,i){var r=t.vertexDeclaration;if(e._material.normalTexture&&!r.getVertexElementByUsage(5)){var a=t.getData(),s=laya.d3.utils.Utils3D.generateTangent(a,r.vertexStride/4,r.getVertexElementByUsage(0).offset/4,r.getVertexElementByUsage(2).offset/4,n.getData());r=laya.d3.utils.Utils3D.getVertexTangentDeclaration(r.getVertexElements());var o=En.create(r,35044);return o.setData(s),t.dispose(),i[5]=o,o}return t},e._rotationTransformScaleSkinAnimation=function(t,n,i,r,a,s,o,l,h,_,u,c){var d=e._tempArray16_0,f=e._tempArray16_1,m=e._tempArray16_2,p=r+r,v=a+a,g=s+s,x=r*p,E=a*p,S=a*v,D=s*p,T=s*v,M=s*g,y=o*p,R=o*v,A=o*g;d[15]=1,d[0]=1-S-M,d[1]=E+A,d[2]=D-R,d[4]=E-A,d[5]=1-x-M,d[6]=T+y,d[8]=D+R,d[9]=T-y,d[10]=1-x-S,f[15]=1,f[0]=l,f[5]=h,f[10]=_;var C,I,w,V,N;for(C=0;C<4;C++)I=d[C],w=d[C+4],V=d[C+8],N=d[C+12],m[C]=I,m[C+4]=w,m[C+8]=V,m[C+12]=I*t+w*n+V*i+N;for(C=0;C<4;C++)I=m[C],w=m[C+4],V=m[C+8],N=m[C+12],u[C+c]=I*f[0]+w*f[1]+V*f[2]+N*f[3],u[C+c+4]=I*f[4]+w*f[5]+V*f[6]+N*f[7],u[C+c+8]=I*f[8]+w*f[9]+V*f[10]+N*f[11],u[C+c+12]=I*f[12]+w*f[13]+V*f[14]+N*f[15]},e._createNodeByJson=function(t,n,i,r){if(!i)switch(n.type){case"Sprite3D":i=new un;break;case"MeshSprite3D":i=new Un;break;case"SkinnedMeshSprite3D":i=new zn;break;case"ShuriKenParticle3D":i=new Hn;break;case"Terrain":i=new Ln;break;case"Camera":i=new Bn;break;default:throw new Error("Utils3D:unidentified class type in (.lh) file.")}var a=n.props;if(a)for(var s in a)i[s]=a[s];var o=n.customProps;o&&(i instanceof laya.d3.core.Sprite3D?(i._parseCustomRTS(o),i._parseCustomProps(t,r,o,n),i._parseCustomComponent(t,r,n.components)):i._parseCustomProps(t,r,o,n));var l=n.child;if(l)for(var h=0,_=l.length;h<_;h++){var u=e._createNodeByJson(t,l[h],null,r);i.addChild(u)}return i},e._computeBoneAndAnimationDatasByBindPoseMatrxix=function(e,t,n,i,r,a){var s,o,l=0,h=0,_=e.length;for(s=0;s<_;l+=e[s].keyframeWidth,h+=16,s++)laya.d3.utils.Utils3D._rotationTransformScaleSkinAnimation(t[l+0],t[l+1],t[l+2],t[l+3],t[l+4],t[l+5],t[l+6],t[l+7],t[l+8],t[l+9],i,h),0!=s&&(o=16*e[s].parentIndex,laya.d3.utils.Utils3D.mulMatrixByArray(i,o,i,h,i,h));var u=n.length;for(s=0;s<u;s++)laya.d3.utils.Utils3D.mulMatrixByArrayAndMatrixFast(i,16*a[s],n[s],r,16*s)},e._computeAnimationDatasByArrayAndMatrixFast=function(e,t,n,i){for(var r=0,a=e.length;r<a;r++)laya.d3.utils.Utils3D.mulMatrixByArrayAndMatrixFast(t,16*i[r],e[r],n,16*r)},e._computeBoneAndAnimationDatasByBindPoseMatrxixOld=function(e,t,n,i,r){var a,s,o=0,l=0,h=e.length;for(a=0;a<h;o+=e[a].keyframeWidth,l+=16,a++)laya.d3.utils.Utils3D._rotationTransformScaleSkinAnimation(t[o+7],t[o+8],t[o+9],t[o+3],t[o+4],t[o+5],t[o+6],t[o+0],t[o+1],t[o+2],i,l),0!=a&&(s=16*e[a].parentIndex,laya.d3.utils.Utils3D.mulMatrixByArray(i,s,i,l,i,l));var _=n.length;for(a=0;a<_;a++){var u=16*a;laya.d3.utils.Utils3D.mulMatrixByArrayAndMatrixFast(i,u,n[a],r,u)}},e._computeAnimationDatasByArrayAndMatrixFastOld=function(e,t,n){for(var i=e.length,r=0;r<i;r++){var a=16*r;laya.d3.utils.Utils3D.mulMatrixByArrayAndMatrixFast(t,a,e[r],n,a)}},e._computeRootAnimationData=function(e,t,n){for(var i=0,r=0,a=0,s=e.length;i<s;r+=e[i].keyframeWidth,a+=16,i++)laya.d3.utils.Utils3D.createAffineTransformationArray(t[r+0],t[r+1],t[r+2],t[r+3],t[r+4],t[r+5],t[r+6],t[r+7],t[r+8],t[r+9],n,a)},e.generateTangent=function(t,n,i,r,a){for(var s=n+3,o=new Float32Array(s*(t.length/n)),l=0;l<a.length;l+=3){var h=a[l+0],_=a[l+1],u=a[l+2],c=n*h+i,d=e._tempVector3_0;d.x=t[c+0],d.y=t[c+1],d.z=t[c+2];var f=n*_+i,m=e._tempVector3_1;m.x=t[f+0],m.y=t[f+1],m.z=t[f+2];var p=n*u+i,v=e._tempVector3_2;v.x=t[p+0],v.y=t[p+1],v.z=t[p+2];var g=n*h+r,x=t[g+0],E=t[g+1],S=n*_+r,D=t[S+0],T=t[S+1],M=n*u+r,y=t[M+0],R=t[M+1],A=e._tempVector3_3;ct.subtract(m,d,A);var C=e._tempVector3_4;ct.subtract(v,d,C),ct.scale(A,R-E,A),ct.scale(C,T-E,C);var I=e._tempVector3_5;ct.subtract(A,C,I),ct.scale(I,1/((D-x)*(R-E)-(T-E)*(y-x)),I);var w=0;for(w=0;w<n;w++)o[s*h+w]=t[n*h+w];for(w=0;w<3;w++)o[s*h+n+w]=+I.elements[w];for(w=0;w<n;w++)o[s*_+w]=t[n*_+w];for(w=0;w<3;w++)o[s*_+n+w]=+I.elements[w];for(w=0;w<n;w++)o[s*u+w]=t[n*u+w];for(w=0;w<3;w++)o[s*u+n+w]=+I.elements[w]}for(l=0;l<o.length;l+=s){var V=s*l+n,N=e._tempVector3_6;N.x=o[V+0],N.y=o[V+1],N.z=o[V+2],ct.normalize(N,N),o[V+0]=N.x,o[V+1]=N.y,o[V+2]=N.z}return o},e.getVertexTangentDeclaration=function(e){for(var t=!1,n=!1,i=!1,r=!1,a=!1,s=!1,o=!1,l=0;l<e.length;l++)switch(e[l].elementUsage){case"POSITION":t=!0;break;case"NORMAL":n=!0;break;case"COLOR":i=!0;break;case"UV":r=!0;break;case"UV1":a=!0;break;case"BLENDWEIGHT":s=!0;break;case"BLENDINDICES":o=!0}var h;return t&&n&&i&&r&&a&&s&&o&&(h=Ce.vertexDeclaration),t&&n&&i&&r&&s&&o?h=Ve.vertexDeclaration:t&&n&&r&&a&&s&&o?h=Fe.vertexDeclaration:t&&n&&r&&s&&o?h=He.vertexDeclaration:t&&n&&i&&s&&o?h=Te.vertexDeclaration:t&&n&&i&&r&&a?h=Ie.vertexDeclaration:t&&n&&i&&r?h=Ne.vertexDeclaration:t&&n&&r&&a?h=Be.vertexDeclaration:t&&n&&r?h=ze.vertexDeclaration:t&&n&&i?h=Me.vertexDeclaration:t&&r&&(h=je.vertexDeclaration),h},e.transformVector3ArrayByQuat=function(e,t,n,i,r){var a=n.elements,s=e[t],o=e[t+1],l=e[t+2],h=a[0],_=a[1],u=a[2],c=a[3],d=c*s+_*l-u*o,f=c*o+u*s-h*l,m=c*l+h*o-_*s,p=-h*s-_*o-u*l;i[r]=d*c+p*-h+f*-u-m*-_,i[r+1]=f*c+p*-_+m*-h-d*-u,i[r+2]=m*c+p*-u+d*-_-f*-h},e.mulMatrixByArray=function(t,n,i,r,a,s){var o,l,h,_,u;if(a===i){for(i=e._tempArray16_3,o=0;o<16;++o)i[o]=a[s+o];r=0}for(o=0;o<4;o++)l=t[n+o],h=t[n+o+4],_=t[n+o+8],u=t[n+o+12],a[s+o]=l*i[r+0]+h*i[r+1]+_*i[r+2]+u*i[r+3],a[s+o+4]=l*i[r+4]+h*i[r+5]+_*i[r+6]+u*i[r+7],a[s+o+8]=l*i[r+8]+h*i[r+9]+_*i[r+10]+u*i[r+11],a[s+o+12]=l*i[r+12]+h*i[r+13]+_*i[r+14]+u*i[r+15]},e.mulMatrixByArrayFast=function(e,t,n,i,r,a){var s,o,l,h,_;for(s=0;s<4;s++)o=e[t+s],l=e[t+s+4],h=e[t+s+8],_=e[t+s+12],r[a+s]=o*n[i+0]+l*n[i+1]+h*n[i+2]+_*n[i+3],r[a+s+4]=o*n[i+4]+l*n[i+5]+h*n[i+6]+_*n[i+7],r[a+s+8]=o*n[i+8]+l*n[i+9]+h*n[i+10]+_*n[i+11],r[a+s+12]=o*n[i+12]+l*n[i+13]+h*n[i+14]+_*n[i+15]},e.mulMatrixByArrayAndMatrixFast=function(e,t,n,i,r){var a,s,o,l,h,_=n.elements,u=_[0],c=_[1],d=_[2],f=_[3],m=_[4],p=_[5],v=_[6],g=_[7],x=_[8],E=_[9],S=_[10],D=_[11],T=_[12],M=_[13],y=_[14],R=_[15],A=t,C=t+4,I=t+8,w=t+12,V=r,N=r+4,O=r+8,b=r+12;for(a=0;a<4;a++)s=e[A+a],o=e[C+a],l=e[I+a],h=e[w+a],i[V+a]=s*u+o*c+l*d+h*f,i[N+a]=s*m+o*p+l*v+h*g,i[O+a]=s*x+o*E+l*S+h*D,i[b+a]=s*T+o*M+l*y+h*R},e.createAffineTransformationArray=function(e,t,n,i,r,a,s,o,l,h,_,u){var c=i+i,d=r+r,f=a+a,m=i*c,p=i*d,v=i*f,g=r*d,x=r*f,E=a*f,S=s*c,D=s*d,T=s*f;_[u+0]=(1-(g+E))*o,_[u+1]=(p+T)*o,_[u+2]=(v-D)*o,_[u+3]=0,_[u+4]=(p-T)*l,_[u+5]=(1-(m+E))*l,_[u+6]=(x+S)*l,_[u+7]=0,_[u+8]=(v+D)*h,_[u+9]=(x-S)*h,_[u+10]=(1-(m+g))*h,_[u+11]=0,_[u+12]=e,_[u+13]=t,_[u+14]=n,_[u+15]=1},e.transformVector3ArrayToVector3ArrayCoordinate=function(t,n,i,r,a){var s=e._tempArray4_0,o=t[n+0],l=t[n+1],h=t[n+2],_=i.elements;s[0]=o*_[0]+l*_[4]+h*_[8]+_[12],s[1]=o*_[1]+l*_[5]+h*_[9]+_[13],s[2]=o*_[2]+l*_[6]+h*_[10]+_[14],s[3]=1/(o*_[3]+l*_[7]+h*_[11]+_[15]),r[a+0]=s[0]*s[3],r[a+1]=s[1]*s[3],r[a+2]=s[2]*s[3]},e.transformLightingMapTexcoordByUV0Array=function(e,t,n,i,r){var a=n.elements;i[r+0]=e[t+0]*a[0]+a[2],i[r+1]=(e[t+1]-1)*a[1]+a[3]},e.transformLightingMapTexcoordByUV1Array=function(e,t,n,i,r){var a=n.elements;i[r+0]=e[t+0]*a[0]+a[2],i[r+1]=1+e[t+1]*a[1]+a[3]},e.convert3DCoordTo2DScreenCoord=function(e,t){var n=e.elements,i=t.elements;i[0]=-he.clientWidth/2+n[0],i[1]=he.clientHeight/2-n[1],i[2]=n[2]},e.getURLVerion=function(e){var t=e.indexOf("?");return t>=0?e.substr(t):null},e._quaternionCreateFromYawPitchRollArray=function(e,t,n,i){var r=.5*n,a=.5*t,s=.5*e,o=Math.sin(r),l=Math.cos(r),h=Math.sin(a),_=Math.cos(a),u=Math.sin(s),c=Math.cos(s);i[0]=c*h*l+u*_*o,i[1]=u*_*l-c*h*o,i[2]=c*_*o-u*h*l,i[3]=c*_*l+u*h*o},e._createAffineTransformationArray=function(e,t,n,i){var r=i.elements,a=t[0],s=t[1],o=t[2],l=t[3],h=a+a,_=s+s,u=o+o,c=a*h,d=a*_,f=a*u,m=s*_,p=s*u,v=o*u,g=l*h,x=l*_,E=l*u,S=n[0],D=n[1],T=n[2];r[0]=(1-(m+v))*S,r[1]=(d+E)*S,r[2]=(f-x)*S,r[3]=0,r[4]=(d-E)*D,r[5]=(1-(c+v))*D,r[6]=(p+g)*D,r[7]=0,r[8]=(f+x)*T,r[9]=(p-g)*T,r[10]=(1-(c+m))*T,r[11]=0,r[12]=e[0],r[13]=e[1],r[14]=e[2],r[15]=1},e._mulMatrixArray=function(e,t,n,i){var r,a,s,o,l,h=t.elements,_=e.elements,u=h[0],c=h[1],d=h[2],f=h[3],m=h[4],p=h[5],v=h[6],g=h[7],x=h[8],E=h[9],S=h[10],D=h[11],T=h[12],M=h[13],y=h[14],R=h[15],A=i,C=i+4,I=i+8,w=i+12;for(r=0;r<4;r++)a=_[r],s=_[r+4],o=_[r+8],l=_[r+12],n[A+r]=a*u+s*c+o*d+l*f,n[C+r]=a*m+s*p+o*v+l*g,n[I+r]=a*x+s*E+o*S+l*D,n[w+r]=a*T+s*M+o*y+l*R},e._tempVector3_0=new ct,e._tempVector3_1=new ct,e._tempVector3_2=new ct,e._tempVector3_3=new ct,e._tempVector3_4=new ct,e._tempVector3_5=new ct,e._tempVector3_6=new ct,e._tempArray4_0=new Float32Array(4),e._tempArray16_0=new Float32Array(16),e._tempArray16_1=new Float32Array(16),e._tempArray16_2=new Float32Array(16),e._tempArray16_3=new Float32Array(16),i(e,["_typeToFunO",function(){return this._typeToFunO={INT16:"writeInt16",SHORT:"writeInt16",UINT16:"writeUint16",UINT32:"writeUint32",FLOAT32:"writeFloat32",INT:"writeInt32",UINT:"writeUint32",BYTE:"writeByte",STRING:"writeUTFString"}}]),e}(),It=function(){function e(){}return r(e,"Laya3D"),e._changeWebGLSize=function(e,t){N.onStageResize(e,t),he.clientWidth=e,he.clientHeight=t},e.__init__=function(){var t=E.createMap;t.lh=[un,"SPRITE3DHIERARCHY"],t.ls=[_n,"SPRITE3DHIERARCHY"],t.lm=[Rn,"MESH"],t.lmat=[pn,"MATERIAL"],t.lpbr=[mn,"MATERIAL"],t.ltc=[Vn,"TEXTURECUBE"],t.jpg=[wn,"nativeimage"],t.jpeg=[wn,"nativeimage"],t.png=[wn,"nativeimage"],t.pkm=[wn,"arraybuffer"],t.lsani=[l,"arraybuffer"],t.lrani=[l,"arraybuffer"],t.raw=[Mn,"arraybuffer"],t.mipmaps=[Mn,"arraybuffer"],t.thdata=[Qt,"arraybuffer"],t.lt=[Kt,"TERRAIN"],t.lani=[Wt,"arraybuffer"],t.lav=[Xt,"json"],t.ani=[l,"arraybuffer"],x.parserMap.SPRITE3DHIERARCHY=e._loadHierarchy,x.parserMap.MESH=e._loadMesh,x.parserMap.MATERIAL=e._loadMaterial,x.parserMap.TEXTURECUBE=e._loadTextureCube,x.parserMap.TERRAIN=e._loadTerrain,e._innerFirstLevelLoaderManager.on("error",null,e._eventLoadManagerError),e._innerSecondLevelLoaderManager.on("error",null,e._eventLoadManagerError),e._innerThirdLevelLoaderManager.on("error",null,e._eventLoadManagerError),e._innerFourthLevelLoaderManager.on("error",null,e._eventLoadManagerError)},e.READ_BLOCK=function(){return e._readData.pos+=4,!0},e.READ_DATA=function(){return e._DATA.offset=e._readData.getUint32(),e._DATA.size=e._readData.getUint32(),!0},e.READ_STRINGS=function(){var t=[],n={offset:0,size:0};n.offset=e._readData.getUint16(),n.size=e._readData.getUint16();e._readData.pos;e._readData.pos=n.offset+e._DATA.offset;for(var i=0;i<n.size;i++){var r=e._readData.readUTFString();-1===r.lastIndexOf(".lmat")&&-1===r.lastIndexOf(".lpbr")||t.push(r)}return t},e._eventLoadManagerError=function(e){n.loader.event("error",e)},e._addHierarchyInnerUrls=function(e,t,n,i,r,a){var s=w.formatURL(r,i);n&&(s+=n),e.push({url:s,clas:a}),t[r]=s},e._getSprite3DHierarchyInnerUrls=function(t,n,i,r,a,s,o){var l,h=0,_=0;switch(t.type){case"Scene":var u=t.customProps.lightmaps;for(h=0,_=u.length;h<_;h++){var d=u[h].replace("exr","png");e._addHierarchyInnerUrls(r,a,s,o,d,wn)}break;case"MeshSprite3D":case"SkinnedMeshSprite3D":var f;if(t.instanceParams)(f=t.instanceParams.loadPath)&&e._addHierarchyInnerUrls(n,a,s,o,f,Rn);else{(f=(l=t.customProps).meshPath)&&e._addHierarchyInnerUrls(n,a,s,o,f,Rn);var m=l.materials;if(m)for(h=0,_=m.length;h<_;h++){var p=m[h],v=p.type.split("."),g=c.window;if(v.forEach(function(e){g=g[e]}),"function"!=typeof g)throw"_getSprite3DHierarchyInnerUrls 错误: "+p.type+" 不是类";e._addHierarchyInnerUrls(i,a,s,o,p.path,g)}}break;case"ShuriKenParticle3D":var x=(l=t.customProps).meshPath;x&&e._addHierarchyInnerUrls(n,a,s,o,x,Rn);var E=l.material;if(E)e._addHierarchyInnerUrls(i,a,s,o,E.path,Sn);else{var S=l.materialPath;S?e._addHierarchyInnerUrls(i,a,s,o,S,Sn):e._addHierarchyInnerUrls(r,a,s,o,l.texturePath,wn)}break;case"Terrain":e._addHierarchyInnerUrls(r,a,s,o,t.customProps.dataPath,Kt)}var D=t.components;for(var T in D){var M=D[T];switch(T){case"Animator":var y=M.avatarPath;if(y)e._addHierarchyInnerUrls(r,a,s,o,y,Xt);else{var R=M.avatar;R&&e._addHierarchyInnerUrls(r,a,s,o,R.path,Xt)}var A=M.clipPaths;for(h=0,_=A.length;h<_;h++)e._addHierarchyInnerUrls(r,a,s,o,A[h],Wt)}}var C=t.child;for(h=0,_=C.length;h<_;h++)e._getSprite3DHierarchyInnerUrls(C[h],n,i,r,a,s,o)},e._loadHierarchy=function(t){t.on("loaded",null,e._onHierarchylhLoaded,[t]),t.load(t.url,"text",!1,null,!0)},e._onHierarchylhLoaded=function(t,n){var i=t.url,r=Ct.getURLVerion(i),a=w.getPath(w.formatURL(i)),s=[],o=[],l=[],h={},_=JSON.parse(n);e._getSprite3DHierarchyInnerUrls(_,s,o,l,h,r,a);var u=s.length+o.length+l.length,c=u+1,d=1/c;if(e._onProcessChange(t,0,d,1),l.length>0){var f=u/c,m=g.create(null,e._onProcessChange,[t,d,f],!1);e._innerFourthLevelLoaderManager.create(l,g.create(null,e._onHierarchyInnerForthLevResouLoaded,[t,m,n,h,s,o,d+f*l.length,f]),m)}else e._onHierarchyInnerForthLevResouLoaded(t,null,n,h,s,o,d,f)},e._onHierarchyInnerForthLevResouLoaded=function(t,n,i,r,a,s,o,l){if(n&&n.recover(),s.length>0){var h=g.create(null,e._onProcessChange,[t,o,l],!1);e._innerSecondLevelLoaderManager.create(s,g.create(null,e._onHierarchyInnerSecondLevResouLoaded,[t,h,i,r,a,o+l*s.length,l]),n)}else e._onHierarchyInnerSecondLevResouLoaded(t,null,i,r,a,o,l)},e._onHierarchyInnerSecondLevResouLoaded=function(t,n,i,r,a,s,o){if(n&&n.recover(),a.length>0){var l=g.create(null,e._onProcessChange,[t,s,o],!1);e._innerFirstLevelLoaderManager.create(a,g.create(null,e._onHierarchyInnerFirstLevResouLoaded,[t,l,i,r]),n)}else e._onHierarchyInnerFirstLevResouLoaded(t,null,i,r)},e._onHierarchyInnerFirstLevResouLoaded=function(e,t,n,i){t&&t.recover(),e.endLoad([n,i])},e._loadTerrain=function(t){t.on("loaded",null,e._onTerrainLtLoaded,[t]),t.load(t.url,"json",!1,null,!0)},e._onTerrainLtLoaded=function(t,n){var i,r,a=t.url,s=Ct.getURLVerion(a),o=w.getPath(w.formatURL(a)),l=[],h={},_=0,u=0,c=n.heightData;i=c.url,r=w.formatURL(i,o),s&&(r+=s),h[i]=r,i=r;var d=n.detailTexture;for(_=0,u=d.length;_<u;_++)l.push({url:d[_].diffuse});var f=n.normalMap;for(_=0,u=f.length;_<u;_++)l.push({url:f[_]});var m=n.alphaMap;for(_=0,u=m.length;_<u;_++)l.push({url:m[_],params:[!1,!1,6408,!0]});for(_=0,u=l.length;_<u;_++){var p=l[_].url;r=w.formatURL(p,o),s&&(r+=s),l[_].url=r,h[p]=r}var v=l.length,x=v+2,E=1/x;e._onProcessChange(t,0,E,1);var S={heightMapLoaded:!1,texturesLoaded:!1},D=g.create(null,e._onProcessChange,[t,E,E],!1);e._innerFourthLevelLoaderManager.create(i,g.create(null,e._onTerrainHeightMapLoaded,[t,D,n,h,S]),D,null,[c.numX,c.numZ,c.bitType,c.value]);var T=g.create(null,e._onProcessChange,[t,2*E,v/x],!1);e._innerFourthLevelLoaderManager.create(l,g.create(null,e._onTerrainTexturesLoaded,[t,T,n,h,S]),T)},e._onTerrainHeightMapLoaded=function(e,t,n,i,r){r.heightMapLoaded=!0,r.texturesLoaded&&(e.endLoad([n,i]),t.recover())},e._onTerrainTexturesLoaded=function(e,t,n,i,r){r.texturesLoaded=!0,r.heightMapLoaded&&(e.endLoad([n,i]),t.recover())},e._loadMesh=function(t){t.on("loaded",null,e._onMeshLmLoaded,[t]),t.load(t.url,"arraybuffer",!1,null,!0)},e._onMeshLmLoaded=function(t,n){var i,r,a=t.url,s=Ct.getURLVerion(a),o=w.getPath(w.formatURL(a)),l={},h=0,_=0,u=0;switch((e._readData=new f(n)).pos=0,e._readData.readUTFString()){case"LAYAMODEL:02":case"LAYAMODEL:03":var c=e._readData.getUint32();e._readData.pos=e._readData.pos+4,u=e._readData.getUint16(),e._readData.pos=e._readData.pos+8*u;var d=e._readData.getUint32();for(u=e._readData.getUint16(),e._readData.pos=c+d,i=[],h=0;h<u;h++){var m=e._readData.readUTFString();-1!==m.lastIndexOf(".lmat")&&i.push(m)}break;default:for(e.READ_BLOCK(),h=0;h<2;h++){var p=e._readData.getUint16(),v=e._strings[p],x=e["READ_"+v];if(null==x)throw new Error("model file err,no this function:"+p+" "+v);1===h?i=x.call():x.call()}}for(h=0,_=i.length;h<_;h++){var E=i[h];r=w.formatURL(E,o),s&&(r+=s),i[h]=r,l[E]=r}if(i.length>0){e._onProcessChange(t,0,.5,1);var S=g.create(null,e._onProcessChange,[t,.5,.5],!1);e._innerSecondLevelLoaderManager.create(i,g.create(null,e._onMeshMateialLoaded,[t,S,n,l]),S)}else t.endLoad([n,l])},e._onMeshMateialLoaded=function(e,t,n,i){e.endLoad([n,i]),t.recover()},e._getMaterialTexturePath=function(e,t,n){var i=e.length-4;return e.indexOf(".dds")!=i&&e.indexOf(".tga")!=i&&e.indexOf(".exr")!=i&&e.indexOf(".DDS")!=i&&e.indexOf(".TGA")!=i&&e.indexOf(".EXR")!=i||(e=e.substr(0,i)+".png"),e=w.formatURL(e,n),t&&(e+=t),e},e._loadMaterial=function(t){t.on("loaded",null,e._onMaterilLmatLoaded,[t]),t.load(t.url,"json",!1,null,!0)},e._onMaterilLmatLoaded=function(t,n){var i,r=t.url,a=Ct.getURLVerion(r),s=w.getPath(w.formatURL(r)),o=[],l={},h=n.customProps,_=n.version;if(_)switch(_){case"LAYAMATERIAL:01":for(var u=n.props.textures,c=0,d=u.length;c<d;c++){var f=u[c],m=f.path;if(m){var p=m.length-4;m.indexOf(".exr")!=p&&m.indexOf(".EXR")!=p||(m=m.substr(0,p)+".png"),i=w.formatURL(m,s),a&&(i+=a),o.push({url:i,params:f.params}),l[m]=i}}break;default:throw new Error("Laya3D:unkonwn version.")}else{var v=h.diffuseTexture.texture2D;if(v&&(i=e._getMaterialTexturePath(v,a,s),o.push(i),l[v]=i),h.normalTexture){var x=h.normalTexture.texture2D;x&&(i=e._getMaterialTexturePath(x,a,s),o.push(i),l[x]=i)}if(h.specularTexture){var E=h.specularTexture.texture2D;E&&(i=e._getMaterialTexturePath(E,a,s),o.push(i),l[E]=i)}if(h.emissiveTexture){var S=h.emissiveTexture.texture2D;S&&(i=e._getMaterialTexturePath(S,a,s),o.push(i),l[S]=i)}if(h.ambientTexture){var D=h.ambientTexture.texture2D;D&&(i=e._getMaterialTexturePath(D,a,s),o.push(i),l[D]=i)}if(h.reflectTexture){var T=h.reflectTexture.texture2D;T&&(i=e._getMaterialTexturePath(T,a,s),o.push(i),l[T]=i)}}var M=o.length,y=M+1,R=1/y;if(e._onProcessChange(t,0,R,1),M>0){var A=g.create(null,e._onProcessChange,[t,R,M/y],!1);e._innerFourthLevelLoaderManager.create(o,g.create(null,e._onMateialTexturesLoaded,[t,A,n,l]),A,wn)}else e._onMateialTexturesLoaded(t,null,n,null)},e._onMateialTexturesLoaded=function(e,t,n,i){e.endLoad([n,i]),t&&t.recover()},e._loadTextureCube=function(t){t.on("loaded",null,e._onTextureCubeLtcLoaded,[t]),t.load(t.url,"json",!1,null,!0)},e._onTextureCubeLtcLoaded=function(t,n){var i=w.getPath(w.formatURL(t.url)),r=[w.formatURL(n.px,i),w.formatURL(n.nx,i),w.formatURL(n.py,i),w.formatURL(n.ny,i),w.formatURL(n.pz,i),w.formatURL(n.nz,i)];e._onProcessChange(t,0,1/7,1);var a=g.create(null,e._onProcessChange,[t,1/7,6/7],!1);e._innerFourthLevelLoaderManager.load(r,g.create(null,e._onTextureCubeImagesLoaded,[t,r,a]),a,"nativeimage")},e._onTextureCubeImagesLoaded=function(e,t,n){var i=[];i.length=6;for(var r=0;r<6;r++){var a=t[r];i[r]=x.getRes(a),x.clearRes(a)}e.endLoad(i),n.recover()},e._onProcessChange=function(e,t,n,i){(i=t+i*n)<1&&e.event("progress",i)},e.init=function(t,i,r,a,s,o){void 0===r&&(r=!1),void 0===a&&(a=!1),void 0===s&&(s=!0),void 0===o&&(o=!0),p.isAntialias=r,p.isAlpha=a,p.premultipliedAlpha=s,p.isStencil=o,T.isConchNode||N.enable()?(R.changeWebGLSize=e._changeWebGLSize,T.is3DMode=!0,n.init(t,i),H.__init__(),pt.__init__(),vt.__init__(),Un.__init__(),P.__init__(),e.__init__(),_.maxTextureCount=2,(e.debugMode||_e.debugMode)&&(e._debugPhasorSprite=new se)):alert("Laya3D init error,must support webGL!")},e.HIERARCHY="SPRITE3DHIERARCHY",e.MESH="MESH",e.MATERIAL="MATERIAL",e.PBRMATERIAL="PBRMTL",e.TEXTURECUBE="TEXTURECUBE",e.TERRAIN="TERRAIN",e._readData=null,e._debugPhasorSprite=null,e.debugMode=!1,i(e,["_DATA",function(){return this._DATA={offset:0,size:0}},"_strings",function(){return this._strings=["BLOCK","DATA","STRINGS"]},"_innerFirstLevelLoaderManager",function(){return this._innerFirstLevelLoaderManager=new E},"_innerSecondLevelLoaderManager",function(){return this._innerSecondLevelLoaderManager=new E},"_innerThirdLevelLoaderManager",function(){return this._innerThirdLevelLoaderManager=new E},"_innerFourthLevelLoaderManager",function(){return this._innerFourthLevelLoaderManager=new E}]),e}(),wt=function(e){function t(e){this._worldMatrix=null,this._localQuaternionUpdate=!1,this._locaEulerlUpdate=!1,this._localUpdate=!1,this._positionUpdate=!0,this._rotationUpdate=!0,this._scaleUpdate=!0,this._parent=null,this._childs=null,this._owner=null,this._worldUpdate=!0,this._entity=null,t.__super.call(this),this._localMatrix=new at,this._localPosition=new ct,this._localRotation=new lt(0,0,0,1),this._localScale=new ct(1,1,1),this._localRotationEuler=new ct,this._owner=e,this._childs=[]}r(t,"laya.d3.animation.AnimationTransform3D",v);var n=t.prototype;return n._updateLocalMatrix=function(){at.createAffineTransformation(this._localPosition,this._localRotation,this._localScale,this._localMatrix)},n._onLocalTransform=function(){this._localUpdate=!0},n._onWorldPositionTransform=function(){if(!this._worldUpdate||!this._positionUpdate){this._worldUpdate=this._positionUpdate=!0,this.event("worldmatrixneedchanged");for(var e=0,t=this._childs.length;e<t;e++)this._childs[e]._onWorldPositionTransform()}},n._onWorldRotationTransform=function(){if(!this._worldUpdate||!this._rotationUpdate){this._worldUpdate=this._rotationUpdate=!0,this.event("worldmatrixneedchanged");for(var e=0,t=this._childs.length;e<t;e++)this._childs[e]._onWorldRotationTransform()}},n._onWorldScaleTransform=function(){if(!this._worldUpdate||!this._scaleUpdate){this._worldUpdate=this._scaleUpdate=!0,this.event("worldmatrixneedchanged");for(var e=0,t=this._childs.length;e<t;e++)this._childs[e]._onWorldScaleTransform()}},n._onWorldTransform=function(){if(!(this._worldUpdate&&this._positionUpdate&&this._rotationUpdate&&this._scaleUpdate)){this._worldUpdate=this._positionUpdate=this._rotationUpdate=this._scaleUpdate=!0,this._worldUpdate=this._positionUpdate=this._rotationUpdate=this._scaleUpdate=!0,this.event("worldmatrixneedchanged");for(var e=0,t=this._childs.length;e<t;e++)this._childs[e]._onWorldTransform()}},n._setWorldMatrixAndUpdate=function(e){if(this._worldMatrix=e,null==this._parent)throw new Error("don't need to set worldMatrix to root Node.");null==this._parent._parent?this.localMatrix.cloneTo(this._worldMatrix):at.multiply(this._parent._getWorldMatrix(),this.localMatrix,this._worldMatrix),this._worldUpdate=!1},n._setWorldMatrixNoUpdate=function(e){this._worldMatrix=e,this._worldUpdate=!1},n._setLocalPosition=function(e){if(this._parent)this._localPosition=e,this._onLocalTransform(),this._onWorldPositionTransform();else{var t=this._entity.owner._transform,n=this._entity.localPosition;e.cloneTo(n),t.localPosition=n}},n._setLocalRotation=function(e){if(this._parent)this._localRotation=e,this._localRotation.normalize(this._localRotation),this._locaEulerlUpdate=!0,this._localQuaternionUpdate=!1,this._onLocalTransform(),this._onWorldRotationTransform();else{var t=this._entity.owner._transform,n=this._entity.localRotation;e.cloneTo(n),t.localRotation=n}},n._setLocalScale=function(e){if(this._parent)this._localScale=e,this._onLocalTransform(),this._onWorldScaleTransform();else{var t=this._entity.owner._transform,n=this._entity.localScale;e.cloneTo(n),t.localScale=n}},n._setLocalRotationEuler=function(e){if(this._parent){var n=e.elements;lt.createFromYawPitchRoll(n[1]/t._angleToRandin,n[0]/t._angleToRandin,n[2]/t._angleToRandin,this._localRotation),this._localRotationEuler=e,this._locaEulerlUpdate=!1,this._localQuaternionUpdate=!1,this._onLocalTransform(),this._onWorldRotationTransform()}else{var i=this._entity.owner._transform,r=this._entity.localRotationEuler;e.cloneTo(r),i.localRotationEuler=r}},n._getWorldMatrix=function(){return this._worldUpdate?(null!=this._parent._parent?(at.multiply(this._parent._getWorldMatrix(),this.localMatrix,this._worldMatrix),this._worldUpdate=!1):(this.localMatrix.cloneTo(this._worldMatrix),this._worldUpdate=!1),this._worldMatrix):this._worldMatrix},a(0,n,"localMatrix",function(){return this._localUpdate&&(this._updateLocalMatrix(),this._localUpdate=!1),this._localMatrix}),a(0,n,"localPosition",function(){return this._localPosition},function(e){this._localPosition=e,this._onLocalTransform(),this._onWorldPositionTransform()}),a(0,n,"localRotation",function(){if(this._localQuaternionUpdate){var e=this._localRotationEuler.elements;lt.createFromYawPitchRoll(e[1]/t._angleToRandin,e[0]/t._angleToRandin,e[2]/t._angleToRandin,this._localRotation),this._localQuaternionUpdate=!1}return this._localRotation},function(e){this._localRotation=e,this._localRotation.normalize(this._localRotation),this._locaEulerlUpdate=!0,this._localQuaternionUpdate=!1,this._onLocalTransform(),this._onWorldRotationTransform()}),a(0,n,"localScale",function(){return this._localScale},function(e){this._localScale=e,this._onLocalTransform(),this._onWorldScaleTransform()}),a(0,n,"localRotationEuler",function(){if(this._locaEulerlUpdate){this._localRotation.getYawPitchRoll(t._tempVector3);var e=t._tempVector3.elements,n=this._localRotationEuler.elements;n[0]=e[1]/t._randinToAngle,n[1]=e[0]/t._randinToAngle,n[2]=e[2]/t._randinToAngle,this._locaEulerlUpdate=!1}return this._localRotationEuler},function(e){e.elements;this._localRotationEuler=e,this._locaEulerlUpdate=!1,this._localQuaternionUpdate=!0,this._onLocalTransform(),this._onWorldRotationTransform()}),a(0,n,"parent",function(){return this._parent},function(e){if(this._parent!==e){if(this._parent){var t=this._parent._childs,n=t.indexOf(this);t.splice(n,1)}e&&(e._childs.push(this),e&&this._onWorldTransform()),this._parent=e}}),i(t,["_tempVector3",function(){return this._tempVector3=new ct},"_angleToRandin",function(){return this._angleToRandin=180/Math.PI},"_randinToAngle",function(){return this._randinToAngle=180*Math.PI}]),t}(),Vt=function(e){function t(){this._destroyed=!1,this._id=0,this._enable=!1,this._owner=null,this.started=!1,t.__super.call(this),this._destroyed=!1,this._id=t._uniqueIDCounter,t._uniqueIDCounter++}r(t,"laya.d3.component.Component3D",v);var i=t.prototype;return n.imps(i,{"laya.d3.core.render.IUpdate":!0,"laya.resource.IDestroy":!0}),i._initialize=function(e){this._owner=e,this.enable=!0,this.started=!1,this._load(e)},i._destroy=function(){this._unload(this._owner),this._owner=null,this._destroyed=!0},i._load=function(e){},i._start=function(e){},i._update=function(e){},i._lateUpdate=function(e){},i._preRenderUpdate=function(e){},i._postRenderUpdate=function(e){},i._unload=function(e){this.offAll()},i._cloneTo=function(e){},a(0,i,"id",function(){return this._id}),a(0,i,"destroyed",function(){return this._destroyed}),a(0,i,"owner",function(){return this._owner}),a(0,i,"enable",function(){return this._enable},function(e){this._enable!==e&&(this._enable=e,this.event("enablechanged",this._enable))}),a(0,i,"isSingleton",function(){return t._isSingleton}),t._isSingleton=!0,t._uniqueIDCounter=1,t}(),Nt=function(e){function t(){this._destroyed=!1,t.__super.call(this),this._destroyed=!1}r(t,"laya.d3.core.GeometryFilter",v);var i=t.prototype;return n.imps(i,{"laya.resource.IDestroy":!0}),i._destroy=function(){this.offAll(),this._destroyed=!0},a(0,i,"_isAsyncLoaded",function(){return!0}),a(0,i,"_originalBoundingBoxCorners",function(){throw new Error("BaseRender: must override it.")}),a(0,i,"_originalBoundingSphere",function(){throw new Error("BaseRender: must override it.")}),a(0,i,"_originalBoundingBox",function(){throw new Error("BaseRender: must override it.")}),a(0,i,"destroyed",function(){return this._destroyed}),t}(),Ot=function(e){function t(e){this._id=0,this._destroyed=!1,this._lightmapScaleOffset=null,this._lightmapIndex=0,this._enable=!1,this._receiveShadow=!1,this._boundingSphere=null,this._boundingBox=null,this._boundingBoxCenter=null,this._boundingSphereNeedChange=!1,this._boundingBoxNeedChange=!1,this._boundingBoxCenterNeedChange=!1,this._octreeNodeNeedChange=!1,this._indexInSceneFrustumCullingObjects=0,this._materials=null,this._owner=null,this._renderElements=null,this._distanceForSort=NaN,this._treeNode=null,this._isPartOfStaticBatch=!1,this._staticBatchRootSprite3D=null,this._staticBatchRenderElements=null,this.sortingFudge=NaN,this.castShadow=!1,t.__super.call(this),this._id=++t._uniqueIDCounter,this._indexInSceneFrustumCullingObjects=-1,this._boundingBox=new Je(new ct,new ct),this._boundingBoxCenter=new ct,this._boundingSphere=new tt(new ct,0),this._boundingSphereNeedChange=!0,this._boundingBoxNeedChange=!0,this._boundingBoxCenterNeedChange=!0,this._octreeNodeNeedChange=!0,this._materials=[],this._renderElements=[],this._isPartOfStaticBatch=!1,this._destroyed=!1,this._owner=e,this._enable=!0,this.lightmapIndex=-1,this.castShadow=!1,this.receiveShadow=!1,this.sortingFudge=0,this._owner.transform.on("worldmatrixneedchanged",this,this._onWorldMatNeedChange)}r(t,"laya.d3.core.render.BaseRender",v);var s=t.prototype;return n.imps(s,{"laya.resource.IDestroy":!0}),s._setShaderValuelightMap=function(e){this._setShaderValueTexture(3,e)},s._onWorldMatNeedChange=function(){this._boundingSphereNeedChange=!0,this._boundingBoxNeedChange=!0,this._boundingBoxCenterNeedChange=!0,this._octreeNodeNeedChange=!0},s._renderRenderableBoundBox=function(){var e=It._debugPhasorSprite,n=this.boundingBox,i=t._tempBoundBoxCorners;n.getCorners(i),e.line(i[0],t._greenColor,i[1],t._greenColor),e.line(i[2],t._greenColor,i[3],t._greenColor),e.line(i[4],t._greenColor,i[5],t._greenColor),e.line(i[6],t._greenColor,i[7],t._greenColor),e.line(i[0],t._greenColor,i[3],t._greenColor),e.line(i[1],t._greenColor,i[2],t._greenColor),e.line(i[2],t._greenColor,i[6],t._greenColor),e.line(i[3],t._greenColor,i[7],t._greenColor),e.line(i[0],t._greenColor,i[4],t._greenColor),e.line(i[1],t._greenColor,i[5],t._greenColor),e.line(i[4],t._greenColor,i[7],t._greenColor),e.line(i[5],t._greenColor,i[6],t._greenColor)},s._calculateBoundingSphere=function(){throw"BaseRender: must override it."},s._calculateBoundingBox=function(){throw"BaseRender: must override it."},s._setShaderValueTexture=function(e,t){this._owner._shaderValues.setValue(e,t?t.source:null)},s._setShaderValueMatrix4x4=function(e,t){this._owner._shaderValues.setValue(e,t?t.elements:null)},s._setShaderValueColor=function(e,t){this._owner._shaderValues.setValue(e,t?t.elements:null)},s._setShaderValueBuffer=function(e,t){this._owner._shaderValues.setValue(e,t)},s._setShaderValueInt=function(e,t){this._owner._shaderValues.setValue(e,t)},s._setShaderValueBool=function(e,t){this._owner._shaderValues.setValue(e,t)},s._setShaderValueNumber=function(e,t){this._owner._shaderValues.setValue(e,t)},s._setShaderValueVector2=function(e,t){this._owner._shaderValues.setValue(e,t?t.elements:null)},s._addShaderDefine=function(e){this._owner._shaderDefineValue|=e},s._removeShaderDefine=function(e){this._owner._shaderDefineValue&=~e},s._renderUpdate=function(e){},s._applyLightMapParams=function(){if(this._lightmapIndex>=0){var e=this._owner.scene;if(e){var t=e.getlightmaps()[this._lightmapIndex];t?(this._addShaderDefine(4),t.loaded?this._setShaderValuelightMap(t):t.once("loaded",this,this._setShaderValuelightMap)):this._removeShaderDefine(4)}else this._removeShaderDefine(4)}else this._removeShaderDefine(4)},s._updateOctreeNode=function(){var e=this._treeNode;e&&this._octreeNodeNeedChange&&(e.updateObject(this),this._octreeNodeNeedChange=!1)},s._destroy=function(){this.offAll();for(var e=0,t=this._renderElements.length;e<t;e++)this._renderElements[e]._destroy();this._renderElements=null,this._owner=null,this._materials=null,this._boundingBox=null,this._boundingBoxCenter=null,this._boundingSphere=null,this._lightmapScaleOffset=null,this._destroyed=!0},a(0,s,"boundingSphere",function(){return this._boundingSphereNeedChange&&(this._calculateBoundingSphere(),this._boundingSphereNeedChange=!1),this._boundingSphere}),a(0,s,"id",function(){return this._id}),a(0,s,"material",function(){var e=this._materials[0];if(e&&!e._isInstance){var t=new e.constructor;e.cloneTo(t),t.name=t.name+"(Instance)",t._isInstance=!0,this._materials[0]=t,this.event("materialchanged",[this,0,t])}return this._materials[0]},function(e){this._materials[0]=e,this.event("materialchanged",[this,0,e])}),a(0,s,"sharedMaterial",function(){return this._materials[0]},function(e){this._materials[0]=e,this.event("materialchanged",[this,0,e])}),a(0,s,"lightmapIndex",function(){return this._lightmapIndex},function(e){this._lightmapIndex=e,this._applyLightMapParams()}),a(0,s,"lightmapScaleOffset",function(){return this._lightmapScaleOffset},function(e){this._lightmapScaleOffset=e,this._setShaderValueColor(2,e),this._addShaderDefine(2)}),a(0,s,"enable",function(){return this._enable},function(e){this._enable=e,this.event("enablechanged",[this,e])}),a(0,s,"materials",function(){for(var e=0,t=this._materials.length;e<t;e++){var n=this._materials[e];if(!n._isInstance){var i=new n.constructor;n.cloneTo(i),i.name=i.name+"(Instance)",i._isInstance=!0,this._materials[e]=i,this.event("materialchanged",[this,e,i])}}return this._materials.slice()},function(e){if(!e)throw new Error("MeshRender: materials value can't be null.");this._materials=e;for(var t=0,n=e.length;t<n;t++)this.event("materialchanged",[this,t,e[t]])}),a(0,s,"sharedMaterials",function(){return this._materials.slice()},function(e){if(!e)throw new Error("MeshRender: shadredMaterials value can't be null.");this._materials=e;for(var t=0,n=e.length;t<n;t++)this.event("materialchanged",[this,t,e[t]])}),a(0,s,"boundingBox",function(){return this._boundingBoxNeedChange&&(this._calculateBoundingBox(),this._boundingBoxNeedChange=!1),this._boundingBox}),a(0,s,"boundingBoxCenter",function(){if(this._boundingBoxCenterNeedChange){var e=this.boundingBox;ct.add(e.min,e.max,this._boundingBoxCenter),ct.scale(this._boundingBoxCenter,.5,this._boundingBoxCenter),this._boundingBoxCenterNeedChange=!1}return this._boundingBoxCenter}),a(0,s,"receiveShadow",function(){return this._receiveShadow},function(e){this._receiveShadow!==e&&(this._receiveShadow=e,e?this._addShaderDefine(1):this._removeShaderDefine(1))}),a(0,s,"destroyed",function(){return this._destroyed}),t._uniqueIDCounter=0,i(t,["_tempBoundBoxCorners",function(){return this._tempBoundBoxCorners=[new ct,new ct,new ct,new ct,new ct,new ct,new ct,new ct]},"_greenColor",function(){return this._greenColor=new dt(0,1,0,1)}]),t}(),bt=function(e){function t(e){this._owner=null,this._localQuaternionUpdate=!1,this._locaEulerlUpdate=!1,this._localUpdate=!1,this._worldUpdate=!0,this._positionUpdate=!0,this._rotationUpdate=!0,this._scaleUpdate=!0,this._parent=null,this._childs=null,this._dummy=null,this.pivot=null,t.__super.call(this),this._localPosition=new ct,this._localRotation=new lt(0,0,0,1),this._localScale=new ct(1,1,1),this._localRotationEuler=new ct,this._localMatrix=new at,this._position=new ct,this._rotation=new lt(0,0,0,1),this._scale=new ct(1,1,1),this._worldMatrix=new at,this._forward=new ct,this._up=new ct,this._right=new ct,this._owner=e,this._childs=[]}r(t,"laya.d3.core.Transform3D",v);var n=t.prototype;return n._updateLocalMatrix=function(){if(!this.pivot||0===this.pivot.x&&0===this.pivot.y&&0===this.pivot.z)at.createAffineTransformation(this._localPosition,this.localRotation,this._localScale,this._localMatrix);else{var e=t._tempVector30;ct.multiply(this.pivot,this._localScale,e);var n=t._tempVector31;ct.subtract(e,this.pivot,n);var i=t._tempVector32,r=this.localRotation;ct.transformQuat(e,r,i),ct.subtract(i,e,i);var a=t._tempVector33;ct.subtract(this._localPosition,n,a),ct.subtract(a,i,a),at.createAffineTransformation(a,r,this._localScale,this._localMatrix)}},n._onWorldPositionRotationTransform=function(){if(!this._worldUpdate||!this._positionUpdate||!this._rotationUpdate){this._worldUpdate=this._positionUpdate=this._rotationUpdate=!0,this.event("worldmatrixneedchanged");for(var e=0,t=this._childs.length;e<t;e++)this._childs[e]._onWorldPositionRotationTransform()}},n._onWorldPositionScaleTransform=function(){if(!this._worldUpdate||!this._positionUpdate||!this._scaleUpdate){this._worldUpdate=this._positionUpdate=this._scaleUpdate=!0,this.event("worldmatrixneedchanged");for(var e=0,t=this._childs.length;e<t;e++)this._childs[e]._onWorldPositionScaleTransform()}},n._onWorldPositionTransform=function(){if(!this._worldUpdate||!this._positionUpdate){this._worldUpdate=this._positionUpdate=!0,this.event("worldmatrixneedchanged");for(var e=0,t=this._childs.length;e<t;e++)this._childs[e]._onWorldPositionTransform()}},n._onWorldRotationTransform=function(){if(!this._worldUpdate||!this._rotationUpdate){this._worldUpdate=this._rotationUpdate=!0,this.event("worldmatrixneedchanged");for(var e=0,t=this._childs.length;e<t;e++)this._childs[e]._onWorldPositionRotationTransform()}},n._onWorldScaleTransform=function(){if(!this._worldUpdate||!this._scaleUpdate){this._worldUpdate=this._scaleUpdate=!0,this.event("worldmatrixneedchanged");for(var e=0,t=this._childs.length;e<t;e++)this._childs[e]._onWorldPositionScaleTransform()}},n._onWorldTransform=function(){if(!(this._worldUpdate&&this._positionUpdate&&this._rotationUpdate&&this._scaleUpdate)){this._worldUpdate=this._positionUpdate=this._rotationUpdate=this._scaleUpdate=!0,this.event("worldmatrixneedchanged");for(var e=0,t=this._childs.length;e<t;e++)this._childs[e]._onWorldTransform()}},n.translate=function(e,n){void 0===n&&(n=!0),n?(at.createFromQuaternion(this.localRotation,t._tempMatrix0),ct.transformCoordinate(e,t._tempMatrix0,t._tempVector30),ct.add(this.localPosition,t._tempVector30,this._localPosition),this.localPosition=this._localPosition):(ct.add(this.position,e,this._position),this.position=this._position)},n.rotate=function(e,n,i){void 0===n&&(n=!0),void 0===i&&(i=!0);var r;i?r=e:(ct.scale(e,Math.PI/180,t._tempVector30),r=t._tempVector30),lt.createFromYawPitchRoll(r.y,r.x,r.z,t._tempQuaternion0),n?(lt.multiply(this._localRotation,t._tempQuaternion0,this._localRotation),this.localRotation=this._localRotation):(lt.multiply(t._tempQuaternion0,this.rotation,this._rotation),this.rotation=this._rotation)},n.lookAt=function(e,t,n){void 0===n&&(n=!1);var i,r=e.elements;if(n){if(i=this._localPosition.elements,Math.abs(i[0]-r[0])<it.zeroTolerance&&Math.abs(i[1]-r[1])<it.zeroTolerance&&Math.abs(i[2]-r[2])<it.zeroTolerance)return;lt.lookAt(this._localPosition,e,t,this._localRotation),this._localRotation.invert(this._localRotation),this.localRotation=this._localRotation}else{var a=this.position;if(i=a.elements,Math.abs(i[0]-r[0])<it.zeroTolerance&&Math.abs(i[1]-r[1])<it.zeroTolerance&&Math.abs(i[2]-r[2])<it.zeroTolerance)return;lt.lookAt(a,e,t,this._rotation),this._rotation.invert(this._rotation),this.rotation=this._rotation}},a(0,n,"_isFrontFaceInvert",function(){var e=this.scale,t=e.x<0;return e.y<0&&(t=!t),e.z<0&&(t=!t),t}),a(0,n,"owner",function(){return this._owner}),a(0,n,"localRotation",function(){if(this._localQuaternionUpdate){var e=this._localRotationEuler.elements;lt.createFromYawPitchRoll(e[1]/t._angleToRandin,e[0]/t._angleToRandin,e[2]/t._angleToRandin,this._localRotation)}return this._localRotation},function(e){this._localRotation=e,this._localRotation.normalize(this._localRotation),this._locaEulerlUpdate=!0,this._localQuaternionUpdate=!1,this._localUpdate=!0,!this.pivot||0===this.pivot.x&&0===this.pivot.y&&0===this.pivot.z?this._onWorldRotationTransform():this._onWorldPositionRotationTransform()}),a(0,n,"worldMatrix",function(){return this._worldUpdate&&(null!=this._parent?at.multiply(this._parent.worldMatrix,this.localMatrix,this._worldMatrix):this.localMatrix.cloneTo(this._worldMatrix),this._worldUpdate=!1),this._worldMatrix},function(e){null===this._parent?e.cloneTo(this._localMatrix):(this._parent.worldMatrix.invert(this._localMatrix),at.multiply(this._localMatrix,e,this._localMatrix)),this.localMatrix=this._localMatrix,this._worldMatrix=e,this._worldUpdate=!1}),a(0,n,"worldNeedUpdate",function(){return this._worldUpdate}),a(0,n,"localMatrix",function(){return this._localUpdate&&(this._updateLocalMatrix(),this._localUpdate=!1),this._localMatrix},function(e){this._localMatrix=e,this._localMatrix.decomposeTransRotScale(this._localPosition,this._localRotation,this._localScale),this._localUpdate=!1,this._onWorldTransform()}),a(0,n,"dummy",function(){return this._dummy},function(e){this._dummy!==e&&(this._dummy&&(this._dummy._entity=null),e&&(e._entity=this),this._dummy=e)}),a(0,n,"localPosition",function(){return this._localPosition},function(e){this._localPosition=e,this._localUpdate=!0,this._onWorldPositionTransform()}),a(0,n,"position",function(){if(this._positionUpdate){if(null!=this._parent){var e=this._parent.position;ct.transformQuat(this._localPosition,this._parent.rotation,t._tempVector30),ct.multiply(t._tempVector30,this._parent.scale,t._tempVector30),ct.add(e,t._tempVector30,this._position)}else this._localPosition.cloneTo(this._position);this._positionUpdate=!1}return this._position},function(e){if(null!=this._parent){ct.subtract(e,this._parent.position,this._localPosition);var n=this._parent.scale.elements,i=n[0],r=n[1],a=n[2];if(1!==i||1!==r||1!==a){var s=t._tempVector30,o=s.elements;o[0]=1/i,o[1]=1/r,o[2]=1/a,ct.multiply(this._localPosition,s,this._localPosition)}this._parent.rotation.invert(t._tempQuaternion0),ct.transformQuat(this._localPosition,t._tempQuaternion0,this._localPosition),this.localPosition=this._localPosition}else e.cloneTo(this._localPosition),this.localPosition=this._localPosition;this._position=e,this._positionUpdate=!1}),a(0,n,"localScale",function(){return this._localScale},function(e){this._localScale=e,this._localUpdate=!0,!this.pivot||0===this.pivot.x&&0===this.pivot.y&&0===this.pivot.z?this._onWorldScaleTransform():this._onWorldPositionScaleTransform()}),a(0,n,"localRotationEuler",function(){if(this._locaEulerlUpdate){this._localRotation.getYawPitchRoll(t._tempVector30);var e=t._tempVector30.elements,n=this._localRotationEuler.elements;n[0]=e[1]/t._randinToAngle,n[1]=e[0]/t._randinToAngle,n[2]=e[2]/t._randinToAngle}return this._localRotationEuler},function(e){this._localRotationEuler=e,this._locaEulerlUpdate=!1,this._localQuaternionUpdate=!0,this._localUpdate=!0,!this.pivot||0===this.pivot.x&&0===this.pivot.y&&0===this.pivot.z?this._onWorldRotationTransform():this._onWorldPositionRotationTransform()}),a(0,n,"rotation",function(){return this._rotationUpdate&&(null!=this._parent?lt.multiply(this._parent.rotation,this._localRotation,this._rotation):this._localRotation.cloneTo(this._rotation),this._rotationUpdate=!1),this._rotation},function(e){null!=this._parent?(this._parent.rotation.invert(t._tempQuaternion0),lt.multiply(e,t._tempQuaternion0,this._localRotation),this.localRotation=this._localRotation):(e.cloneTo(this._localRotation),this.localRotation=this._localRotation),this._rotation=e,this._rotationUpdate=!1}),a(0,n,"scale",function(){return this._scaleUpdate?(null!==this._parent?ct.multiply(this._parent.scale,this._localScale,this._scale):this._localScale.cloneTo(this._scale),this._scaleUpdate=!1,this._scale):this._scale}),a(0,n,"rotationEuler",null,function(e){lt.createFromYawPitchRoll(e.y,e.x,e.z,this._rotation),this.rotation=this._rotation}),a(0,n,"forward",function(){var e=this.worldMatrix.elements;return this._forward.elements[0]=-e[8],this._forward.elements[1]=-e[9],this._forward.elements[2]=-e[10],this._forward}),a(0,n,"up",function(){var e=this.worldMatrix.elements;return this._up.elements[0]=e[4],this._up.elements[1]=e[5],this._up.elements[2]=e[6],this._up}),a(0,n,"right",function(){var e=this.worldMatrix.elements;return this._right.elements[0]=e[0],this._right.elements[1]=e[1],this._right.elements[2]=e[2],this._right}),a(0,n,"parent",function(){return this._parent},function(e){if(this._parent!==e){if(this._parent){var t=this._parent._childs,n=t.indexOf(this);t.splice(n,1)}e&&(e._childs.push(this),e&&this._onWorldTransform()),this._parent=e}}),i(t,["_tempVector30",function(){return this._tempVector30=new ct},"_tempVector31",function(){return this._tempVector31=new ct},"_tempVector32",function(){return this._tempVector32=new ct},"_tempVector33",function(){return this._tempVector33=new ct},"_tempQuaternion0",function(){return this._tempQuaternion0=new lt},"_tempMatrix0",function(){return this._tempMatrix0=new at},"_angleToRandin",function(){return this._angleToRandin=180/Math.PI},"_randinToAngle",function(){return this._randinToAngle=180*Math.PI}]),t}(),Pt=(function(e){function t(){this._rotation=0,this._matNeedUpdte=!1,t.__super.call(this),this._matrix=new at,this._offset=new ut,this._tiling=new ut(1,1)}r(t,"laya.d3.core.TransformUV",v);var s=t.prototype;n.imps(s,{"laya.d3.core.IClone":!0}),s._updateMatrix=function(){t._tempOffsetV3.elements[0]=this._offset.x,t._tempOffsetV3.elements[1]=this._offset.y,lt.createFromYawPitchRoll(0,0,this._rotation,t._tempRotationQua),t._tempTitlingV3.elements[0]=this._tiling.x,t._tempTitlingV3.elements[1]=this._tiling.y,at.createAffineTransformation(t._tempOffsetV3,t._tempRotationQua,t._tempTitlingV3,this._matrix)},s.cloneTo=function(e){e._matrix=this._matrix.clone(),e._offset=this._offset.clone(),e._rotation=this._rotation,e._tiling=this._tiling.clone()},s.clone=function(){var e=new this.constructor;return this.cloneTo(e),e},a(0,s,"matrix",function(){return this._matNeedUpdte&&(this._updateMatrix(),this._matNeedUpdte=!1),this._matrix}),a(0,s,"tiling",function(){return this._tiling},function(e){this._tiling=e,this._matNeedUpdte=!0}),a(0,s,"offset",function(){return this._offset},function(e){this._offset=e,this._matNeedUpdte=!0}),a(0,s,"rotation",function(){return this._rotation},function(e){this._rotation=e,this._matNeedUpdte=!0}),i(t,["_tempOffsetV3",function(){return this._tempOffsetV3=new ct(0,0,0)},"_tempRotationQua",function(){return this._tempRotationQua=new lt},"_tempTitlingV3",function(){return this._tempTitlingV3=new ct(1,1,1)}])}(),function(e){function t(){t.__super.call(this)}r(t,"laya.d3.core.glitter.SplineCurvePosition",e);var n=t.prototype;n._CalcVelocity=function(e,t,n){ct.subtract(e,t,n),ct.scale(n,.5,n)},n.Init=function(t,n,i,r){this._CalcVelocity(n,t,this._tempVector30),this._CalcVelocity(r,i,this._tempVector31),e.prototype.Init.call(this,n,this._tempVector30,r,this._tempVector31)}}(B),function(e){function t(){this.x=NaN,this.y=NaN,this.z=NaN,t.__super.call(this),this.x=1,this.y=1,this.z=1,this.randomDirection=!1}r(t,"laya.d3.core.particleShuriKen.module.shape.BoxShape",e);var n=t.prototype;return n._getShapeBoundBox=function(e){var t=e.min.elements;t[0]=.5*-this.x,t[1]=.5*-this.y,t[2]=.5*-this.z;var n=e.max.elements;n[0]=.5*this.x,n[1]=.5*this.y,n[2]=.5*this.z},n._getSpeedBoundBox=function(e){var t=e.min.elements;t[0]=0,t[1]=0,t[2]=0;var n=e.max.elements;n[0]=0,n[1]=1,n[2]=0},n.generatePositionAndDirection=function(e,t,n,i){var r=e.elements,a=t.elements;n?(n.seed=i[16],ee._randomPointInsideHalfUnitBox(e,n),i[16]=n.seed):ee._randomPointInsideHalfUnitBox(e),r[0]=this.x*r[0],r[1]=this.y*r[1],r[2]=this.z*r[2],this.randomDirection?n?(n.seed=i[17],ee._randomPointUnitSphere(t,n),i[17]=n.seed):ee._randomPointUnitSphere(t):(a[0]=0,a[1]=0,a[2]=1)},n.cloneTo=function(t){e.prototype.cloneTo.call(this,t);var n=t;n.x=this.x,n.y=this.y,n.z=this.z,n.randomDirection=this.randomDirection},t}(J)),Lt=function(e){function t(){this.radius=NaN,this.arc=NaN,this.emitFromEdge=!1,t.__super.call(this),this.radius=1,this.arc=2*Math.PI,this.emitFromEdge=!1,this.randomDirection=!1}r(t,"laya.d3.core.particleShuriKen.module.shape.CircleShape",e);var n=t.prototype;return n._getShapeBoundBox=function(e){var t=e.min.elements;t[0]=t[2]=-this.radius,t[1]=0;var n=e.max.elements;n[0]=n[2]=this.radius,n[1]=0},n._getSpeedBoundBox=function(e){var t=e.min.elements;t[0]=t[1]=-1,t[2]=0;var n=e.max.elements;n[0]=n[1]=1,n[2]=0},n.generatePositionAndDirection=function(e,n,i,r){var a=e.elements,s=t._tempPositionPoint.elements;i?(i.seed=r[16],this.emitFromEdge?ee._randomPointUnitArcCircle(this.arc,t._tempPositionPoint,i):ee._randomPointInsideUnitArcCircle(this.arc,t._tempPositionPoint,i),r[16]=i.seed):this.emitFromEdge?ee._randomPointUnitArcCircle(this.arc,t._tempPositionPoint):ee._randomPointInsideUnitArcCircle(this.arc,t._tempPositionPoint),a[0]=-s[0],a[1]=s[1],a[2]=0,ct.scale(e,this.radius,e),this.randomDirection?i?(i.seed=r[17],ee._randomPointUnitSphere(n,i),r[17]=i.seed):ee._randomPointUnitSphere(n):e.cloneTo(n)},n.cloneTo=function(t){e.prototype.cloneTo.call(this,t);var n=t;n.radius=this.radius,n.arc=this.arc,n.emitFromEdge=this.emitFromEdge,n.randomDirection=this.randomDirection},i(t,["_tempPositionPoint",function(){return this._tempPositionPoint=new ut}]),t}(J),Ft=function(e){function t(){this.angle=NaN,this.radius=NaN,this.length=NaN,this.emitType=0,t.__super.call(this),this.angle=25/180*Math.PI,this.radius=1,this.length=5,this.emitType=0,this.randomDirection=!1}r(t,"laya.d3.core.particleShuriKen.module.shape.ConeShape",e);var n=t.prototype;return n._getShapeBoundBox=function(e){var t=this.radius+this.length*Math.sin(this.angle),n=this.length*Math.cos(this.angle),i=e.min.elements;i[0]=i[1]=-t,i[2]=0;var r=e.max.elements;r[0]=r[1]=t,r[2]=n},n._getSpeedBoundBox=function(e){var t=Math.sin(this.angle),n=e.min.elements;n[0]=n[1]=-t,n[2]=0;var i=e.max.elements;i[0]=n[1]=t,i[2]=1},n.generatePositionAndDirection=function(e,n,i,r){var a,s=e.elements,o=n.elements,l=t._tempPositionPoint.elements,h=NaN,_=NaN,u=Math.cos(this.angle),c=Math.sin(this.angle);switch(this.emitType){case 0:i?(i.seed=r[16],ee._randomPointInsideUnitCircle(t._tempPositionPoint,i),r[16]=i.seed):ee._randomPointInsideUnitCircle(t._tempPositionPoint),h=l[0],_=l[1],s[0]=h*this.radius,s[1]=_*this.radius,s[2]=0,this.randomDirection?(i?(i.seed=r[17],ee._randomPointInsideUnitCircle(t._tempDirectionPoint,i),r[17]=i.seed):ee._randomPointInsideUnitCircle(t._tempDirectionPoint),a=t._tempDirectionPoint.elements,o[0]=a[0]*c,o[1]=a[1]*c):(o[0]=h*c,o[1]=_*c),o[2]=u;break;case 1:i?(i.seed=r[16],ee._randomPointUnitCircle(t._tempPositionPoint,i),r[16]=i.seed):ee._randomPointUnitCircle(t._tempPositionPoint),h=l[0],_=l[1],s[0]=h*this.radius,s[1]=_*this.radius,s[2]=0,this.randomDirection?(i?(i.seed=r[17],ee._randomPointInsideUnitCircle(t._tempDirectionPoint,i),r[17]=i.seed):ee._randomPointInsideUnitCircle(t._tempDirectionPoint),a=t._tempDirectionPoint.elements,o[0]=a[0]*c,o[1]=a[1]*c):(o[0]=h*c,o[1]=_*c),o[2]=u;break;case 2:i?(i.seed=r[16],ee._randomPointInsideUnitCircle(t._tempPositionPoint,i)):ee._randomPointInsideUnitCircle(t._tempPositionPoint),h=l[0],_=l[1],s[0]=h*this.radius,s[1]=_*this.radius,s[2]=0,o[0]=h*c,o[1]=_*c,o[2]=u,ct.normalize(n,n),i?(ct.scale(n,this.length*i.getFloat(),n),r[16]=i.seed):ct.scale(n,this.length*Math.random(),n),ct.add(e,n,e),this.randomDirection&&(i?(i.seed=r[17],ee._randomPointUnitSphere(n,i),r[17]=i.seed):ee._randomPointUnitSphere(n));break;case 3:i?(i.seed=r[16],ee._randomPointUnitCircle(t._tempPositionPoint,i)):ee._randomPointUnitCircle(t._tempPositionPoint),h=l[0],_=l[1],s[0]=h*this.radius,s[1]=_*this.radius,s[2]=0,o[0]=h*c,o[1]=_*c,o[2]=u,ct.normalize(n,n),i?(ct.scale(n,this.length*i.getFloat(),n),r[16]=i.seed):ct.scale(n,this.length*Math.random(),n),ct.add(e,n,e),this.randomDirection&&(i?(i.seed=r[17],ee._randomPointUnitSphere(n,i),r[17]=i.seed):ee._randomPointUnitSphere(n));break;default:throw new Error("ConeShape:emitType is invalid.")}},n.cloneTo=function(t){e.prototype.cloneTo.call(this,t);var n=t;n.angle=this.angle,n.radius=this.radius,n.length=this.length,n.emitType=this.emitType,n.randomDirection=this.randomDirection},i(t,["_tempPositionPoint",function(){return this._tempPositionPoint=new ut},"_tempDirectionPoint",function(){return this._tempDirectionPoint=new ut}]),t}(J),Bt=function(e){function t(){this.radius=NaN,this.emitFromShell=!1,t.__super.call(this),this.radius=1,this.emitFromShell=!1,this.randomDirection=!1}r(t,"laya.d3.core.particleShuriKen.module.shape.HemisphereShape",e);var n=t.prototype;return n._getShapeBoundBox=function(e){var t=e.min.elements;t[0]=t[1]=t[2]=-this.radius;var n=e.max.elements;n[0]=n[1]=this.radius,n[2]=0},n._getSpeedBoundBox=function(e){var t=e.min.elements;t[0]=t[1]=-1,t[2]=0;var n=e.max.elements;n[0]=n[1]=n[2]=1},n.generatePositionAndDirection=function(e,t,n,i){var r=e.elements;n?(n.seed=i[16],this.emitFromShell?ee._randomPointUnitSphere(e,n):ee._randomPointInsideUnitSphere(e,n),i[16]=n.seed):this.emitFromShell?ee._randomPointUnitSphere(e):ee._randomPointInsideUnitSphere(e),ct.scale(e,this.radius,e);var a=r[2];a<0&&(r[2]=-1*a),this.randomDirection?n?(n.seed=i[17],ee._randomPointUnitSphere(t,n),i[17]=n.seed):ee._randomPointUnitSphere(t):e.cloneTo(t)},n.cloneTo=function(t){e.prototype.cloneTo.call(this,t);var n=t;n.radius=this.radius,n.emitFromShell=this.emitFromShell,n.randomDirection=this.randomDirection},t}(J),Ut=function(e){function t(){this.radius=NaN,this.emitFromShell=!1,t.__super.call(this),this.radius=1,this.emitFromShell=!1,this.randomDirection=!1}r(t,"laya.d3.core.particleShuriKen.module.shape.SphereShape",e);var n=t.prototype;return n._getShapeBoundBox=function(e){var t=e.min.elements;t[0]=t[1]=t[2]=-this.radius;var n=e.max.elements;n[0]=n[1]=n[2]=this.radius},n._getSpeedBoundBox=function(e){var t=e.min.elements;t[0]=t[1]=t[2]=-1;var n=e.max.elements;n[0]=n[1]=n[2]=1},n.generatePositionAndDirection=function(e,t,n,i){n?(n.seed=i[16],this.emitFromShell?ee._randomPointUnitSphere(e,n):ee._randomPointInsideUnitSphere(e,n),i[16]=n.seed):this.emitFromShell?ee._randomPointUnitSphere(e):ee._randomPointInsideUnitSphere(e),ct.scale(e,this.radius,e),this.randomDirection?n?(n.seed=i[17],ee._randomPointUnitSphere(t,n),i[17]=n.seed):ee._randomPointUnitSphere(t):e.cloneTo(t)},n.cloneTo=function(t){e.prototype.cloneTo.call(this,t);var n=t;n.radius=this.radius,n.emitFromShell=this.emitFromShell,n.randomDirection=this.randomDirection},t}(J),Ht=function(e){function t(){this._batchIndexStart=0,this._batchIndexEnd=0,this._skinAnimationDatas=null,t.__super.call(this)}return r(t,"laya.d3.core.render.SubMeshRenderElement",oe),t}(),zt=function(e){function t(){t.__super.call(this)}r(t,"laya.d3.graphics.MeshSprite3DStaticBatchManager",fe);var n=t.prototype;return n._getStaticBatch=function(e,t,n,i){var r,a;return a=e?e.id.toString()+n.id.toString()+t.id.toString()+i.toString():n.id.toString()+t.id.toString()+i.toString(),this._staticBatches[a]?r=this._staticBatches[a]:this._staticBatches[a]=r=new Gt(a,this,e,t,n),r},n._initStaticBatchs=function(e){this._initBatchRenderElements.sort(t._sortPrepareStaticBatch);for(var n,i,r,a=!1,s=0,o=0,l=this._initBatchRenderElements.length;o<l;o++){var h=this._initBatchRenderElements[o],_=h.renderObj._getVertexBuffer(0);h._sprite3D;if(i===_.vertexDeclaration&&n===h._material){var u;if(a)r._addCombineBatchRenderObjTest(h)?((u=h._staticBatch)&&u!==r&&u._deleteCombineBatchRenderObj(h),r._addCombineBatchRenderObj(h)):(a=!1,s++);else{var c=this._initBatchRenderElements[o-1],d=c.renderObj,f=h.renderObj;d._getVertexBuffer().vertexCount+f._getVertexBuffer().vertexCount>65535?a=!1:(r=this._getStaticBatch(e,i,n,s),(u=c._staticBatch)&&u!==r&&u._deleteCombineBatchRenderObj(c),r._addCombineBatchRenderObj(c),(u=h._staticBatch)&&u!==r&&u._deleteCombineBatchRenderObj(h),r._addCombineBatchRenderObj(h),a=!0)}}else a=!1,s=0;n=h._material,i=_.vertexDeclaration}},t._sortPrepareStaticBatch=function(e,t){var n=e._render,i=t._render,r=n.lightmapIndex-i.lightmapIndex;if(0===r){var a=n.receiveShadow-i.receiveShadow;if(0===a){var s=e._mainSortID-t._mainSortID;return 0===s?e.renderObj.triangleCount-t.renderObj.triangleCount:s}return a}return r},t}(),Gt=function(e){function t(e,n,i,r,a){this._batchOwnerIndices=null,this._batchOwners=null,this._needFinishCombine=!1,this._currentCombineVertexCount=0,this._currentCombineIndexCount=0,this._vertexDeclaration=null,this._vertexBuffer=null,this._indexBuffer=null,t.__super.call(this,e,n,i),this._batchOwnerIndices=[],this._batchOwners=[],this._needFinishCombine=!1,this._currentCombineVertexCount=0,this._currentCombineIndexCount=0,this._vertexDeclaration=r,this._material=a}r(t,"laya.d3.graphics.SubMeshStaticBatch",me);var n=t.prototype;return n._compareBatchRenderElement=function(e,t){return e._batchIndexStart>t._batchIndexStart},n._addCombineBatchRenderObjTest=function(e){var t=e.renderObj._vertexCount;return!((t>0?this._currentCombineVertexCount+t:this._currentCombineVertexCount+e.renderObj._getVertexBuffer().vertexCount)>65535)},n._addCombineBatchRenderObj=function(e){var t=e.renderObj,n=t._vertexCount;this._initBatchRenderElements.push(e),e._staticBatch=this,n>0?(this._currentCombineIndexCount+=t._indexCount,this._currentCombineVertexCount+=n):(this._currentCombineIndexCount=this._currentCombineIndexCount+t._getIndexBuffer().indexCount,this._currentCombineVertexCount=this._currentCombineVertexCount+t._getVertexBuffer().vertexCount),this._needFinishCombine=!0},n._deleteCombineBatchRenderObj=function(e){var t=e.renderObj,n=this._initBatchRenderElements.indexOf(e);if(-1!==n){this._initBatchRenderElements.splice(n,1),e._staticBatch=null;var i=t._vertexCount;i>0?(this._currentCombineIndexCount=this._currentCombineIndexCount-t._indexCount,this._currentCombineVertexCount=this._currentCombineVertexCount-i):(this._currentCombineIndexCount=this._currentCombineIndexCount-t._getIndexBuffer().indexCount,this._currentCombineVertexCount=this._currentCombineVertexCount-t._getVertexBuffer().vertexCount),this._needFinishCombine=!0}},n._finshInit=function(){if(this._needFinishCombine){var e=0,t=0;this._initBatchRenderElements[0]._sprite3D._render.lightmapIndex>=0?this._vertexDeclaration=this._getVertexDecLightMap(this._vertexDeclaration):this._material instanceof laya.d3.core.material.StandardMaterial&&this._material.ambientTexture&&(this._vertexDeclaration=this._getVertexDecLightMap(this._vertexDeclaration));var n=new Float32Array(this._vertexDeclaration.vertexStride/4*this._currentCombineVertexCount),i=new Uint16Array(this._currentCombineIndexCount);this._vertexBuffer&&(this._vertexBuffer.dispose(),this._indexBuffer.dispose()),this._vertexBuffer=En.create(this._vertexDeclaration,this._currentCombineVertexCount,35044),this._indexBuffer=xn.create("ushort",this._currentCombineIndexCount,35044);for(var r=0,a=this._initBatchRenderElements.length;r<a;r++){var s=this._initBatchRenderElements[r],o=s.renderObj,l=o._getStaticBatchBakedVertexs(this._rootOwner?this._rootOwner._transform:null,s._sprite3D),h=o.getIndices(),_=s._sprite3D.transform._isFrontFaceInvert,u=e/(this._vertexDeclaration.vertexStride/4)-o._vertexStart,c=t,d=c+h.length;s._batchIndexStart=c,s._batchIndexEnd=d,i.set(h,t);var f=0;if(_)for(f=c;f<d;f+=3){i[f]=u+i[f];var m=i[f+1],p=i[f+2];i[f+1]=u+p,i[f+2]=u+m}else for(f=c;f<d;f+=3)i[f]=u+i[f],i[f+1]=u+i[f+1],i[f+2]=u+i[f+2];t+=h.length,n.set(l,e),e+=l.length}this._vertexBuffer.setData(n),this._indexBuffer.setData(i),this._needFinishCombine=!1}},n._getCombineRenderElementFromPool=function(){return this._combineRenderElementPool[this._combineRenderElementPoolIndex++]||(this._combineRenderElementPool[this._combineRenderElementPoolIndex-1]=new Ht)},n._getRenderElement=function(e,t,n){for(var i,r,a=this._batchRenderElements.length,s=!0,o=0;o<a;o++){var l,h=(r=this._batchRenderElements[o])._sprite3D._render;0!==o&&(s=(l=(i=this._batchRenderElements[o-1])._sprite3D._render).lightmapIndex!==h.lightmapIndex||l.receiveShadow!==h.receiveShadow||i._batchIndexEnd!==r._batchIndexStart);var _;if(s){(_=this._getCombineRenderElementFromPool()).renderObj=this,_._material=this._material,_._batchIndexStart=r._batchIndexStart,_._batchIndexEnd=r._batchIndexEnd;var u=h.lightmapIndex,c=u+1,d=this._batchOwnerIndices[c];d||(d=this._batchOwnerIndices[c]=[]);var f,m=d[r._render.receiveShadow?1:0];void 0===m?(d[h.receiveShadow?1:0]=this._batchOwners.length,(f=new Un(null,"StaticBatchMeshSprite3D"))._scene=t,f._transform=this._rootOwner?this._rootOwner._transform:null,f._render.lightmapIndex=u,f._render.receiveShadow=r._render.receiveShadow,this._batchOwners.push(f)):f=this._batchOwners[m],f._render._renderUpdate(n),_._sprite3D=f,e.push(_)}else _._batchIndexEnd=r._batchIndexEnd}},n._beforeRender=function(e){return this._vertexBuffer._bind(),this._indexBuffer._bind(),!0},n._render=function(e){var t=e.renderElement,n=t._batchIndexStart,i=t._batchIndexEnd-n;N.mainContext.drawElements(4,i,5123,2*n),C.drawCall++,C.trianglesFaces+=i/3},n.dispose=function(){this._batchOwnerIndices=null,this._batchOwners=null,this._vertexDeclaration=null,this._vertexBuffer.dispose(),this._indexBuffer.dispose()},n._getVertexBuffer=function(e){return void 0===e&&(e=0),this._vertexBuffer},t}(),kt=function(e){function t(){this._componentsMap=null,this._typeComponentsIndices=null,this._components=null,t.__super.call(this),this._componentsMap=[],this._typeComponentsIndices=[],this._components=[]}r(t,"laya.d3.core.ComponentNode",D);var n=t.prototype;return n._addComponent=function(e){var t,n=this._componentsMap.indexOf(e);if(-1===n)t=[],this._componentsMap.push(e),this._typeComponentsIndices.push(t);else if(t=this._typeComponentsIndices[n],this._components[t[0]].isSingleton)throw new Error("无法单实例创建"+e+"组件，"+e+"组件已存在！");var i=m.getInstance(e);return t.push(this._components.length),this._components.push(i),i._initialize(this),i},n._removeComponent=function(e,t){var n=this._typeComponentsIndices[e],i=n[t],r=this._components[i];this._components.splice(i,1),n.splice(t,1),0===n.length&&(this._typeComponentsIndices.splice(e,1),this._componentsMap.splice(e,1));for(var a=0,s=this._componentsMap.length;a<s;a++)for(var o=(n=this._typeComponentsIndices[a]).length-1;o>=0;o--){var l=n[o];if(!(l>i))break;n[o]=--l}r._destroy()},n._getComponentByType=function(e,t){void 0===t&&(t=0);var n=this._componentsMap.indexOf(e);return-1===n?null:this._components[this._typeComponentsIndices[n][t]]},n._getComponentsByType=function(e,t){var n=this._componentsMap.indexOf(e);if(-1!==n){var i=this._typeComponentsIndices[n],r=i.length;t.length=r;for(var a=0;a<r;a++)t[a]=this._components[i[a]]}else t.length=0},n._getComponentByIndex=function(e){return this._components[e]},n._removeComponentByType=function(e,t){void 0===t&&(t=0);var n=this._componentsMap.indexOf(e);-1!==n&&this._removeComponent(n,t)},n._removeComponentsByType=function(e){var t=this._componentsMap.indexOf(e);if(-1!==t)for(var n=this._typeComponentsIndices[t],i=0,r=n.length;i<r;n.length<r?r--:i++)this._removeComponent(t,i)},n._removeAllComponent=function(){for(var e=0,t=this._componentsMap.length;e<t;this._componentsMap.length<t?t--:e++)this._removeComponentsByType(this._componentsMap[e])},n._updateComponents=function(e){for(var t=0,n=this._components.length;t<n;t++){var i=this._components[t];!i.started&&(i._start(e),i.started=!0),i.enable&&i._update(e)}},n._lateUpdateComponents=function(e){for(var t=0;t<this._components.length;t++){var n=this._components[t];!n.started&&(n._start(e),n.started=!0),n.enable&&n._lateUpdate(e)}},n._preRenderUpdateComponents=function(e){for(var t=0;t<this._components.length;t++){var n=this._components[t];!n.started&&(n._start(e),n.started=!0),n.enable&&n._preRenderUpdate(e)}},n._postRenderUpdateComponents=function(e){for(var t=0;t<this._components.length;t++){var n=this._components[t];!n.started&&(n._start(e),n.started=!0),n.enable&&n._postRenderUpdate(e)}},t}(),Wt=function(e){function t(){this._realTimeCurrentFrameIndexes=null,this._realTimeCurrentTimes=null,this._fullKeyframeIndicesCache=null,this._animationDatasCache=null,this._avatarDatasCache=null,this._skinnedDatasCache=null,this._version=null,this._nodes=null,this._nodesMap=null,this._cachePropertyToNodeMap=null,this._nodeToCachePropertyMap=null,this._unCachePropertyToNodeMap=null,this._duration=NaN,this._frameRate=0,this.islooping=!1,t.__super.call(this),this._fullKeyframeIndicesCache={},this._animationDatasCache=[],this._avatarDatasCache=[],this._skinnedDatasCache=[]}r(t,"laya.d3.animation.AnimationClip",y);var i=t.prototype;return i._hermiteInterpolate=function(e,t,n,i){for(var r=e.data,a=e.outTangent,s=e.next,o=s.data,l=s.inTangent,h=!1,_=NaN,u=NaN,c=NaN,d=NaN,f=0,m=i.length;f<m;f++){var p=a[f],v=l[f];if(Number.isFinite(p)&&Number.isFinite(v)){if(!h){var g=t*t,x=g*t;_=2*x-3*g+1,u=x-2*g+t,c=x-g,d=-2*x+3*g,h=!0}i[f]=_*r[f]+u*p*n+c*v*n+d*o[f]}else i[f]=r[f]}},i._getFullKeyframeIndicesWithCache=function(e){return this._fullKeyframeIndicesCache[e]},i._cacheFullKeyframeIndices=function(e,t){this._fullKeyframeIndicesCache[e]=t},i._getAnimationDataWithCache=function(e,t){var n=this._animationDatasCache[e];return n?n[t]:null},i._cacheAnimationData=function(e,t,n){(this._animationDatasCache[e]||(this._animationDatasCache[e]=[]))[t]=n},i._getAvatarDataWithCache=function(e,t,n){var i=this._avatarDatasCache[e.id];if(i){var r=i[t];return r?r[n]:null}return null},i._cacheAvatarData=function(e,t,n,i){var r=this._avatarDatasCache[e.id]||(this._avatarDatasCache[e.id]=[]);(r[t]||(r[t]=[]))[n]=i},i._getSkinnedDatasWithCache=function(e,t,n,i){var r=this._skinnedDatasCache[e.id];if(r){var a=r[t.id];if(a){var s=a[n];return s?s[i]:null}return null}return null},i._cacheSkinnedDatasWithCache=function(e,t,n,i,r){var a=this._skinnedDatasCache[e.id]||(this._skinnedDatasCache[e.id]=[]),s=a[t.id]||(a[t.id]=[]);(s[n]||(s[n]=[]))[i]=r},i._evaluateAnimationlDatasCacheFrame=function(e,t,n,i,r){for(var a=0,s=0,o=0,l=this._nodes.length;o<l;o++){var h=this._nodes[o],_=h._cacheProperty;if(!r||r[o]&&(!_||i)){var u,c=e[o],d=c[t.currentFrameIndex],f=0;if(-1!==d){var m=h.keyFrames[d];if(m.next){n?_?(u=new Float32Array(h.keyFrameWidth),i[this._nodeToCachePropertyMap[o]]=u):(u=n[o])||(u=n[o]=new Float32Array(h.keyFrameWidth)):(u=new Float32Array(h.keyFrameWidth),i[o]=u);var p=NaN,v=m.duration;p=0!==v?(t.currentFrameTime-m.startTime)/v:0,this._hermiteInterpolate(m,p,v,u)}else{if(n)if(_){if(-1!==(f=t._lastFrameIndex)&&c[f]===d)continue;u=new Float32Array(h.keyFrameWidth),i[this._nodeToCachePropertyMap[o]]=u}else(u=n[o])||(u=n[o]=new Float32Array(h.keyFrameWidth));else{if(-1!==(f=t._lastFrameIndex)&&c[f]===d)continue;u=new Float32Array(h.keyFrameWidth),i[o]=u}var g=m.data;for(a=0,s=u.length;a<s;a++)u[a]=g[a]}}else{if(n)if(_){if(-1!==(f=t._lastFrameIndex)&&c[f]===d)continue;u=new Float32Array(h.keyFrameWidth),i[this._nodeToCachePropertyMap[o]]=u}else(u=n[o])||(u=n[o]=new Float32Array(h.keyFrameWidth));else{if(-1!==(f=t._lastFrameIndex)&&c[f]===d)continue;u=new Float32Array(h.keyFrameWidth),i[o]=u}var x=h.keyFrames[0].data;for(a=0,s=u.length;a<s;a++)u[a]=x[a]}}}},i._evaluateAnimationlDatasRealTime=function(e,t){var n=0,i=0,r=this._nodes;if(!this._realTimeCurrentFrameIndexes){for(this._realTimeCurrentFrameIndexes=new Int32Array(r.length),n=0,i=r.length;n<i;n++)this._realTimeCurrentFrameIndexes[n]=-1;this._realTimeCurrentTimes=new Float32Array(r.length)}for(n=0,i=r.length;n<i;n++){var a=r[n];e<this._realTimeCurrentTimes[n]&&(this._realTimeCurrentFrameIndexes[n]=-1),this._realTimeCurrentTimes[n]=e;for(var s=this._realTimeCurrentFrameIndexes[n]+1,o=a.keyFrames,l=o.length;s<l;){if(o[s].startTime>e){this._realTimeCurrentFrameIndexes[n]=s-1;break}s++}s===l&&(this._realTimeCurrentFrameIndexes[n]=l-1);var h=0,_=0,u=t[n];u||(u=t[n]=new Float32Array(a.keyFrameWidth));var c=o[this._realTimeCurrentFrameIndexes[n]];if(c)if(c.next){var d=c.duration,f=NaN;f=0!==d?(e-c.startTime)/d:0,this._hermiteInterpolate(c,f,d,u)}else{var m=c.data;for(h=0,_=u.length;h<_;h++)u[h]=m[h]}else{var p=a.keyFrames[0].data;for(h=0,_=u.length;h<_;h++)u[h]=p[h]}}},i.onAsynLoaded=function(e,t,n){var i=new f(t);switch(this._version=i.readUTFString(),this._version){case"LAYAANIMATION:01":b.parse(this,i)}this._endLoaded()},i.detoryResource=function(){this._realTimeCurrentFrameIndexes=null,this._realTimeCurrentTimes=null,this._fullKeyframeIndicesCache=null,this._animationDatasCache=null,this._avatarDatasCache=null,this._skinnedDatasCache=null,this._version=null,this._nodes=null,this._nodesMap=null,this._cachePropertyToNodeMap=null,this._nodeToCachePropertyMap=null,this._unCachePropertyToNodeMap=null},t.load=function(e){return n.loader.create(e,null,null,t)},t}(),Xt=function(e){function t(){t.__super.call(this)}r(t,"laya.d3.core.Avatar",y);var i=t.prototype;return n.imps(i,{"laya.d3.core.IClone":!0}),i._initCloneToAnimator=function(e,t){t._avatarNodeMap[e.name]=e,t._avatarNodes.push(e);for(var n=0,i=e.getChildCount();n<i;n++)this._initCloneToAnimator(e.getChildByIndex(n),t)},i._parseNode=function(e,t){var n=e.props.name;t.name=n;var i=e.customProps,r=t._transform,a=r.localPosition,s=a.elements,o=i.translate;s[0]=o[0],s[1]=o[1],s[2]=o[2],r.localPosition=a;var l=r.localRotation,h=l.elements,_=i.rotation;h[0]=_[0],h[1]=_[1],h[2]=_[2],h[3]=_[3],r.localRotation=l;var u=r.localScale,c=u.elements,d=i.scale;c[0]=d[0],c[1]=d[1],c[2]=d[2],r.localScale=u;for(var f=e.child,m=0,p=f.length;m<p;m++){var v=f[m],g=new P;t.addChild(g),this._parseNode(v,g)}},i.onAsynLoaded=function(e,t,n){this._rootNode=new P,t.version?(this._version=t.version,this._parseNode(t.rootNode,this._rootNode)):this._parseNode(t,this._rootNode),this._endLoaded()},i._cloneDatasToAnimator=function(e){var t=this._rootNode.clone(),n=[];e._avatarRootNode=t,e._avatarNodeMap={},e._avatarNodes=n,this._initCloneToAnimator(t,e);for(var i=0,r=n.length;i<r;i++){var a=n[i];a._parent?a._transform._setWorldMatrixAndUpdate(new at):a._transform._setWorldMatrixNoUpdate(null)}},i.cloneTo=function(e){var t=e,n=this._rootNode.clone();t._rootNode=n},i.clone=function(){var e=new this.constructor;return this.cloneTo(e),e},t.load=function(e){return n.loader.create(e,null,null,t)},t}(),jt=function(e){function t(){t.__super.call(this),this._isInstance=!1,this._shaderDefineValue=0,this._disablePublicShaderDefine=0,this._shaderValues=new gt,this._values=[],this._textureSharderIndices=[],this.renderQueue=1,this._alphaTest=!1,this.cull=2,this.blend=0,this.srcBlend=1,this.dstBlend=0,this.srcBlendRGB=1,this.dstBlendRGB=0,this.srcBlendAlpha=1,this.dstBlendAlpha=0,this.blendConstColor=new dt(1,1,1,1),this.blendEquation=0,this.blendEquationRGB=0,this.blendEquationAlpha=0,this.depthTest=!0,this.depthFunc=513,this.depthWrite=!0,T.isConchNode&&(this._conchMaterial=new ConchMaterial)}r(t,"laya.d3.core.material.BaseMaterial",y);var i=t.prototype;return n.imps(i,{"laya.d3.core.IClone":!0}),i._uploadTextures=function(){for(var e=0,t=this._textureSharderIndices.length;e<t;e++){var n=this._textureSharderIndices[e],i=this._values[n];i&&this._uploadTexture(n,i.source||i.defaulteTexture.source)}},i._uploadTexture=function(e,t){this._shaderValues.data[e]=t},i._addShaderDefine=function(e){this._shaderDefineValue|=e,this._conchMaterial&&this._conchMaterial.addShaderDefine(e)},i._removeShaderDefine=function(e){this._shaderDefineValue&=~e,this._conchMaterial&&this._conchMaterial.removeShaderDefine(e)},i._addDisablePublicShaderDefine=function(e){this._disablePublicShaderDefine|=e},i._removeDisablePublicShaderDefine=function(e){this._disablePublicShaderDefine&=~e},i._setBuffer=function(e,t){this._shaderValues.setValue(e,t),this._values[e]=t,this._conchMaterial&&this._conchMaterial.setShaderValue(e,t,0)},i._getBuffer=function(e){return this._values[e]},i._setMatrix4x4=function(e,t){this._shaderValues.setValue(e,t?t.elements:null),this._values[e]=t,this._conchMaterial&&this._conchMaterial.setShaderValue(e,t.elements,0)},i._getMatrix4x4=function(e){return this._values[e]},i._setInt=function(e,t){this._shaderValues.setValue(e,t),this._values[e]=t,this._conchMaterial&&this._conchMaterial.setShaderValue(e,t,1)},i._getInt=function(e){return this._values[e]},i._setNumber=function(e,t){this._shaderValues.setValue(e,t),this._values[e]=t,this._conchMaterial&&this._conchMaterial.setShaderValue(e,t,2)},i._getNumber=function(e){return this._values[e]},i._setBool=function(e,t){this._shaderValues.setValue(e,t),this._values[e]=t,this._conchMaterial&&this._conchMaterial.setShaderValue(e,t,1)},i._getBool=function(e){return this._values[e]},i._setVector2=function(e,t){this._shaderValues.setValue(e,t?t.elements:null),this._values[e]=t,this._conchMaterial&&this._conchMaterial.setShaderValue(e,t.elements,0)},i._getVector2=function(e){return this._values[e]},i._setColor=function(e,t){this._shaderValues.setValue(e,t?t.elements:null),this._values[e]=t,this._conchMaterial&&t&&this._conchMaterial.setShaderValue(e,t.elements,0)},i._getColor=function(e){return this._values[e]},i._setTexture=function(e,t){this._shaderValues;var n=this._values[e];!n&&t?this._textureSharderIndices.push(e):n&&!t&&this._textureSharderIndices.splice(this._textureSharderIndices.indexOf(e),1),this._values[e]=t,this._conchMaterial&&this._conchMaterial.setTexture(t._conchTexture,this._textureSharderIndices.indexOf(e),e)},i._getTexture=function(e){return this._values[e]},i._upload=function(){this._uploadTextures(),this._shader.uploadMaterialUniforms(this._shaderValues.data)},i._getShader=function(e,t,n){var i=(e|t)&~this._disablePublicShaderDefine;return this._shader=this._shaderCompile.withCompile(i,n,this._shaderDefineValue),this._shader},i._setRenderStateBlendDepth=function(){var e=N.mainContext;switch(O.setDepthTest(e,this.depthTest),O.setDepthMask(e,this.depthWrite),O.setDepthFunc(e,this.depthFunc),this.blend){case 0:O.setBlend(e,!1);break;case 1:O.setBlend(e,!0),O.setBlendFunc(e,this.srcBlend,this.dstBlend);break;case 2:O.setBlend(e,!0)}},i._setRenderStateFrontFace=function(e,t){var n=N.mainContext,i=0;switch(this.cull){case 0:O.setCullFace(n,!1);break;case 1:O.setCullFace(n,!0),i=e?t&&t._isFrontFaceInvert?2305:2304:t&&t._isFrontFaceInvert?2304:2305,O.setFrontFace(n,i);break;case 2:O.setCullFace(n,!0),i=e?t&&t._isFrontFaceInvert?2304:2305:t&&t._isFrontFaceInvert?2305:2304,O.setFrontFace(n,i)}},i.setShaderName=function(e){var t=cn.nameKey.getID(e);if(-1===t)throw new Error("BaseMaterial: unknown shader name.");this._shaderCompile=pt._preCompileShader[t],this._conchMaterial&&this._conchMaterial.setShader(this._shaderCompile._conchShader)},i.onAsynLoaded=function(e,t,n){var i=t[0],r=t[1];switch(i.version){case"LAYAMATERIAL:01":var a=0,s=0,o=i.props;for(var l in o)switch(l){case"vectors":var h=o[l];for(a=0,s=h.length;a<s;a++){var _=h[a],u=_.value;switch(u.length){case 2:this[_.name]=new ut(u[0],u[1]);break;case 3:this[_.name]=new ct(u[0],u[1],u[2]);break;case 4:this[_.name]=new dt(u[0],u[1],u[2],u[3]);break;default:throw new Error("BaseMaterial:unkonwn color length.")}}break;case"textures":var c=o[l];for(a=0,s=c.length;a<s;a++){var d=c[a],f=d.path;f&&(this[d.name]=x.getRes(r[f]))}break;case"defines":var m=o[l];for(a=0,s=m.length;a<s;a++){var p=this._shaderCompile.getMaterialDefineByName(m[a]);this._addShaderDefine(p)}break;default:this[l]=o[l]}break;default:throw new Error("BaseMaterial:unkonwn version.")}this._endLoaded()},i.cloneTo=function(e){var t=e;t.name=this.name,t.cull=this.cull,t.blend=this.blend,t.srcBlend=this.srcBlend,t.dstBlend=this.dstBlend,t.srcBlendRGB=this.srcBlendRGB,t.dstBlendRGB=this.dstBlendRGB,t.srcBlendAlpha=this.srcBlendAlpha,t.dstBlendAlpha=this.dstBlendAlpha,this.blendConstColor.cloneTo(t.blendConstColor),t.blendEquation=this.blendEquation,t.blendEquationRGB=this.blendEquationRGB,t.blendEquationAlpha=this.blendEquationAlpha,t.depthTest=this.depthTest,t.depthFunc=this.depthFunc,t.depthWrite=this.depthWrite,t.renderQueue=this.renderQueue,t._shader=this._shader,t._disablePublicShaderDefine=this._disablePublicShaderDefine,t._shaderDefineValue=this._shaderDefineValue;var n=0,i=0,r=t._shaderValues;t._shaderValues.data.length=this._shaderValues.data.length;var a=this._values.length,s=t._values;for(s.length=a,n=0,i=a;n<i;n++){var o=this._values[n];if(o)if("number"==typeof o)s[n]=o,r.data[n]=o;else if("number"==typeof o&&Math.floor(o)==o)s[n]=o,r.data[n]=o;else if("boolean"==typeof o)s[n]=o,r.data[n]=o;else if(o instanceof laya.d3.math.Vector2){var l=s[n]||(s[n]=new ut);o.cloneTo(l),r.data[n]=l.elements}else if(o instanceof laya.d3.math.Vector3){var h=s[n]||(s[n]=new ct);o.cloneTo(h),r.data[n]=h.elements}else if(o instanceof laya.d3.math.Vector4){var _=s[n]||(s[n]=new dt);o.cloneTo(_),r.data[n]=_.elements}else if(o instanceof laya.d3.math.Matrix4x4){var u=s[n]||(s[n]=new at);o.cloneTo(u),r.data[n]=u.elements}else o instanceof laya.d3.resource.BaseTexture&&(s[n]=o)}t._textureSharderIndices=this._textureSharderIndices.slice()},i.clone=function(){var e=new this.constructor;return this.cloneTo(e),e},a(0,i,"alphaTestValue",function(){return this._getNumber(0)},function(e){this._setNumber(0,e)}),a(0,i,"alphaTest",function(){return this._alphaTest},function(e){this._alphaTest=e,e?this._addShaderDefine(1):this._removeShaderDefine(1)}),t.CULL_NONE=0,t.CULL_FRONT=1,t.CULL_BACK=2,t.BLEND_DISABLE=0,t.BLEND_ENABLE_ALL=1,t.BLEND_ENABLE_SEPERATE=2,t.BLENDPARAM_ZERO=0,t.BLENDPARAM_ONE=1,t.BLENDPARAM_SRC_COLOR=768,t.BLENDPARAM_ONE_MINUS_SRC_COLOR=769,t.BLENDPARAM_DST_COLOR=774,t.BLENDPARAM_ONE_MINUS_DST_COLOR=775,t.BLENDPARAM_SRC_ALPHA=770,t.BLENDPARAM_ONE_MINUS_SRC_ALPHA=771,t.BLENDPARAM_DST_ALPHA=772,t.BLENDPARAM_ONE_MINUS_DST_ALPHA=773,t.BLENDPARAM_CONSTANT_COLOR=32769,t.BLENDPARAM_ONE_MINUS_CONSTANT_COLOR=32770,t.BLENDPARAM_CONSTANT_ALPHA=32771,t.BLENDPARAM_ONE_MINUS_CONSTANT_ALPHA=32772,t.BLENDPARAM_SRC_ALPHA_SATURATE=776,t.BLENDEQUATION_ADD=0,t.BLENDEQUATION_SUBTRACT=1,t.BLENDEQUATION_REVERSE_SUBTRACT=2,t.DEPTHFUNC_NEVER=512,t.DEPTHFUNC_LESS=513,t.DEPTHFUNC_EQUAL=514,t.DEPTHFUNC_LEQUAL=515,t.DEPTHFUNC_GREATER=516,t.DEPTHFUNC_NOTEQUAL=517,t.DEPTHFUNC_GEQUAL=518,t.DEPTHFUNC_ALWAYS=519,t.SHADERDEFINE_ALPHATEST=1,t.ALPHATESTVALUE=0,t}(),Zt=function(e){function t(){this._type=0,this._width=0,this._height=0,this._size=null,this._repeat=!1,this._mipmap=!1,this._minFifter=0,this._magFifter=0,this._format=0,this._source=null,t.__super.call(this),this._conchTexture,T.isConchNode&&(this._conchTexture=new ConchTexture),this._repeat=!0,this.mipmap=!0,this.minFifter=-1,this.magFifter=-1}r(t,"laya.d3.resource.BaseTexture",y);var n=t.prototype;return a(0,n,"width",function(){return this._width}),a(0,n,"format",function(){return this._format}),a(0,n,"repeat",function(){return this._repeat},function(e){if(this._repeat!==e&&(this._repeat=e,this._source)){var t=N.mainContext;O.bindTexture(t,this._type,this._source),h.isPOT(this._width,this._height)&&this._repeat?(t.texParameteri(this._type,10242,10497),t.texParameteri(this._type,10243,10497)):(t.texParameteri(this._type,10242,33071),t.texParameteri(this._type,10243,33071))}}),a(0,n,"height",function(){return this._height}),a(0,n,"magFifter",function(){return this._magFifter},function(e){this._magFifter=e,e!=this._magFifter&&this._conchTexture&&this._conchTexture.setMaxFifter(e)}),a(0,n,"size",function(){return this._size}),a(0,n,"mipmap",function(){return this._mipmap},function(e){this._mipmap=e,this._mipmap!=e&&this._conchTexture&&this._conchTexture.setMipMap(e)}),a(0,n,"minFifter",function(){return this._minFifter},function(e){this._minFifter=e,this._minFifter!=e&&this._conchTexture&&this._conchTexture.setMinFifter(e)}),a(0,n,"source",function(){return this.activeResource(),this._source}),a(0,n,"defaulteTexture",function(){return Cn.grayTexture}),t}(),Yt=function(e){function t(){this._subMeshCount=0,this._boundingBox=null,this._boundingSphere=null,this._boundingBoxCorners=null,t.__super.call(this),this._boundingBoxCorners=new Array(8)}r(t,"laya.d3.resource.models.BaseMesh",y);var n=t.prototype;return n._generateBoundingObject=function(){var e=this.positions;this._boundingSphere=new tt(new ct,0),tt.createfromPoints(e,this._boundingSphere),this._boundingBox=new Je(new ct,new ct),Je.createfromPoints(e,this._boundingBox),this._boundingBox.getCorners(this._boundingBoxCorners)},n.getRenderElementsCount=function(){throw new Error("未Override,请重载该属性！")},n.getRenderElement=function(e){throw new Error("未Override,请重载该属性！")},a(0,n,"positions",function(){throw new Error("未Override,请重载该属性！")}),a(0,n,"subMeshCount",function(){return this._subMeshCount}),a(0,n,"boundingBox",function(){return this._boundingBox}),a(0,n,"boundingBoxCorners",function(){return this._boundingBoxCorners}),a(0,n,"boundingSphere",function(){return this._boundingSphere}),t}(),qt=function(e){function t(){this.__ownerCamera=null,this._alphaBlending=1,this._colorIntensity=1,this._vertexBuffer=null,this._indexBuffer=null,this._sharderNameID=0,this._shader=null,this._shaderValue=null,this._shaderCompile=null,this._environmentDiffuse=null,this._environmentSpecular=null,this._conchSky=null,t.__super.call(this),this._shaderValue=new gt,T.isConchNode&&(this._conchSky=new ConchSkyMesh)}r(t,"laya.d3.resource.models.Sky",y);var n=t.prototype;return n._setEnvironmentDiffuse=function(){this._environmentDiffuse.loaded?this.__ownerCamera._shaderValues.setValue(7,this._environmentDiffuse.source):this._environmentDiffuse.on("loaded",this,this._environmentDiffuseLoaded)},n._setEnvironmentSpecular=function(){if(this._environmentSpecular.loaded){var e=this._environmentSpecular.simLodInfo;e&&e instanceof Float32Array&&this.__ownerCamera._shaderValues.setValue(9,e),this.__ownerCamera._shaderValues.setValue(8,this._environmentSpecular.source)}else this._environmentSpecular.on("loaded",this,this._environmentSpecularLoaded)},n._environmentDiffuseLoaded=function(){this.__ownerCamera._shaderValues.setValue(7,this._environmentDiffuse.source)},n._environmentSpecularLoaded=function(){var e=this._environmentSpecular.simLodInfo;e&&e instanceof Float32Array&&this.__ownerCamera._shaderValues.setValue(9,e),this.__ownerCamera._shaderValues.setValue(8,this._environmentSpecular.source)},n._render=function(e){},a(0,n,"_ownerCamera",null,function(e){this.__ownerCamera=e,this._environmentDiffuse&&this._setEnvironmentDiffuse(),this._environmentSpecular&&this._setEnvironmentSpecular()}),a(0,n,"alphaBlending",function(){return this._alphaBlending},function(e){this._alphaBlending=e,this._alphaBlending<0&&(this._alphaBlending=0),this._alphaBlending>1&&(this._alphaBlending=1),this._conchSky&&this._conchSky.setShaderValue(2,this._alphaBlending,2)}),a(0,n,"envDiffuseSHBlue",null,function(e){this.__ownerCamera._shaderValues.setValue(12,e)}),a(0,n,"colorIntensity",function(){return this._colorIntensity},function(e){this._colorIntensity=e,this._colorIntensity<0&&(this._colorIntensity=0),this._conchSky&&this._conchSky.setShaderValue(1,this._colorIntensity,2)}),a(0,n,"envDiffuseSHGreen",null,function(e){this.__ownerCamera._shaderValues.setValue(11,e)}),a(0,n,"envDiffuseSHRed",null,function(e){this.__ownerCamera._shaderValues.setValue(10,e)}),a(0,n,"environmentDiffuse",function(){return this._environmentDiffuse},function(e){e.minFifter=9728,this._environmentDiffuse=e,this.__ownerCamera&&this._setEnvironmentDiffuse()}),a(0,n,"environmentSpecular",function(){return this._environmentSpecular},function(e){this._environmentSpecular=e,this.__ownerCamera&&this._setEnvironmentSpecular()}),t.MVPMATRIX=0,t.INTENSITY=1,t.ALPHABLENDING=2,t.DIFFUSETEXTURE=3,t}(),Qt=function(e){function t(){this._terrainHeightData=null,this._width=0,this._height=0,this._bitType=0,this._value=NaN,t.__super.call(this)}return r(t,"laya.d3.terrain.TerrainHeightData",y),t.prototype.onAsynLoaded=function(e,t,n){this._width=n[0],this._height=n[1],this._bitType=n[2],this._value=n[3];var i,r=NaN;8==this._bitType?(i=new Uint8Array(t),r=1/255):16==this._bitType&&(i=new Int16Array(t),r=1/32766),this._terrainHeightData=new Float32Array(this._height*this._width);for(var a=0,s=this._height*this._width;a<s;a++)this._terrainHeightData[a]=i[a]*r*this._value/2;this._endLoaded()},t.load=function(e,i,r,a,s){return n.loader.create(e,null,null,t,[i,r,a,s],1,!1)},t}(),Kt=function(e){function t(){this._version=NaN,this._cameraCoordinateInverse=!1,this._gridSize=NaN,this._chunkNumX=0,this._chunkNumZ=0,this._heightDataX=0,this._heightDataZ=0,this._heightDataBitType=0,this._heightDataValue=NaN,this._heightDataUrl=null,this._detailTextureInfos=null,this._chunkInfos=null,this._heightData=null,this._materialInfo=null,this._alphaMaps=null,this._normalMaps=null,t.__super.call(this)}r(t,"laya.d3.terrain.TerrainRes",y);var i=t.prototype;return i.parseData=function(e){var t=e[0],n=e[1];if(this._version=t.version,1==this._version){this._cameraCoordinateInverse=t.cameraCoordinateInverse,this._gridSize=t.gridSize,this._chunkNumX=t.chunkNumX,this._chunkNumZ=t.chunkNumZ;var i=t.heightData;if(this._heightDataX=i.numX,this._heightDataZ=i.numZ,this._heightDataBitType=i.bitType,this._heightDataValue=i.value,this._heightDataUrl=n[i.url],this._materialInfo=new Tt,t.material){var r=t.material.ambient,a=t.material.diffuse,o=t.material.specular;this._materialInfo.ambientColor=new ct(r[0],r[1],r[2]),this._materialInfo.diffuseColor=new ct(a[0],a[1],a[2]),this._materialInfo.specularColor=new dt(o[0],o[1],o[2],o[3])}var l=t.detailTexture;this._detailTextureInfos=s(l.length);for(var h=0;h<l.length;h++){var _=l[h],u=new Dt;u.diffuseTexture=n[_.diffuse],u.normalTexture=_.normal?n[_.normal]:null,_.scale?u.scale=new ut(_.scale[0],_.scale[1]):u.scale=new ut(1,1),_.offset?u.offset=new ut(_.offset[0],_.offset[1]):u.offset=new ut(0,0),this._detailTextureInfos[h]=u}var c=t.alphaMap;for(this._alphaMaps=s(c.length),h=0;h<this._alphaMaps.length;h++)this._alphaMaps[h]=t.alphaMap[h];var d=t.normalMap;for(this._normalMaps=s(d.length),h=0;h<this._normalMaps.length;h++)this._normalMaps[h]=t.normalMap[h];var f=t.chunkInfo;if(this._chunkNumX*this._chunkNumZ!=f.length)return alert("terrain data error"),!1;for(this._chunkInfos=s(f.length),h=0;h<f.length;h++){var m=f[h],p=new St,v=m.alphaMap.length,g=m.detailID.length;if(v!=g)return alert("terrain chunk data error"),!1;p.alphaMap=s(v),p.detailID=s(g),p.normalMap=n[this._normalMaps[m.normalMap]];for(var E=0;E<v;E++){p.alphaMap[E]=n[this._alphaMaps[m.alphaMap[E]]];var S=m.detailID[E],D=S.length;p.detailID[E]=new Uint8Array(D);for(var T=0;T<D;T++)p.detailID[E][T]=S[T]}this._chunkInfos[h]=p}this._heightData=x.getRes(this._heightDataUrl),this.onLoadTerrainComplete(this._heightData)}return!0},i.onLoadTerrainComplete=function(e){this._endLoaded()},i.onAsynLoaded=function(e,t,n){this.parseData(t)},t.load=function(e){return n.loader.create(e,null,null,t,null,1,!1)},t}(),$t=function(e){function t(){this._player=null,this._templet=null,t.__super.call(this),this._player=new o}r(t,"laya.d3.component.animation.KeyframeAnimations",e);var i=t.prototype;return i._updateAnimtionPlayer=function(){this._player._update(n.timer.delta)},i._addUpdatePlayerToTimer=function(){n.timer.frameLoop(1,this,this._updateAnimtionPlayer)},i._removeUpdatePlayerToTimer=function(){n.timer.clear(this,this._updateAnimtionPlayer)},i._onOwnerActiveHierarchyChanged=function(e){this._owner.displayedInStage&&(e?this._addUpdatePlayerToTimer():this._removeUpdatePlayerToTimer())},i._onDisplayInStage=function(){this._owner.activeInHierarchy&&this._addUpdatePlayerToTimer()},i._onUnDisplayInStage=function(){this._owner.activeInHierarchy&&this._removeUpdatePlayerToTimer()},i._load=function(e){e.displayedInStage&&e.activeInHierarchy&&this._addUpdatePlayerToTimer(),e.on("activeinhierarchychanged",this,this._onOwnerActiveHierarchyChanged),e.on("display",this,this._onDisplayInStage),e.on("undisplay",this,this._onUnDisplayInStage)},i._unload=function(t){e.prototype._unload.call(this,t),t.displayedInStage&&t.activeInHierarchy&&this._removeUpdatePlayerToTimer(),t.off("activeinhierarchychanged",this,this._onOwnerActiveHierarchyChanged),t.off("display",this,this._onDisplayInStage),t.off("undisplay",this,this._onUnDisplayInStage),this._player._destroy(),this._player=null,this._templet=null},a(0,i,"url",null,function(e){console.log("Warning: discard property,please use templet property instead.");var t=n.loader.create(e,null,null,l);this._templet!==t&&(0!==this._player.state&&this._player.stop(!0),this._templet=t,this._player.templet=t,this.event("animationchanged",this))}),a(0,i,"player",function(){return this._player}),a(0,i,"templet",function(){return this._templet},function(e){this._templet!==e&&(0!==this._player.state&&this._player.stop(!0),this._templet=e,this._player.templet=e,this.event("animationchanged",this))}),a(0,i,"currentFrameIndex",function(){return this._player.currentKeyframeIndex}),a(0,i,"currentAnimationClipIndex",function(){return this._player.currentAnimationClipIndex}),a(0,i,"nodeCount",function(){return this._templet.getNodeCount(this._player.currentAnimationClipIndex)}),t}(Vt),Jt=function(e){function t(){t.__super.call(this),this._clipNames=[],this._clips=[],this._playStartFrames=[],this._playEndFrames=[],this._cacheNodesSpriteOwners=[],this._cacheNodesAvatarOwners=[],this._cacheNodesDefaultlValues=[],this._cacheNodesToSpriteMap=[],this._cacheSpriteToNodesMap=[],this._cacheFullFrames=[],this._publicClipAnimationDatas=[],this._updateTransformPropertyLoopCount=-1,this._lastFrameIndex=-1,this._defaultClipIndex=-1,this._cachePlayRate=1,this._currentPlayClip=null,this._currentFrameIndex=-1,this._currentTime=0,this._stopWhenCircleFinish=!1,this._elapsedPlaybackTime=0,this._startUpdateLoopCount=-1,this.isCache=!0,this.cacheFrameRate=60,this.playbackRate=1}r(t,"laya.d3.component.Animator",e);var i=t.prototype;return n.imps(i,{"laya.resource.IDestroy":!0}),i._getAvatarOwnersByClip=function(e){var t=this._clips[e]._nodes,n=t.length,i=this._cacheNodesAvatarOwners[e];i.length=n;var r=this._cacheNodesDefaultlValues[e];r.length=n;for(var a=0;a<n;a++){for(var s=this._avatarRootNode,o=t[a],l=o.path,h=0,_=l.length;h<_;h++){var u=l[h];if(""===u)break;if(!(s=s.getChildByName(u)))break}if(s){i[a]=s;var c=P._propertyGetFuncs[o.propertyNameID](s);if(c){var d=new Float32Array(o.keyFrameWidth);for(r[a]=d,h=0,_=c.length;h<_;h++)d[h]=c[h]}}}},i._handleSpriteOwnersByClip=function(e){var t=this._clips[e]._nodes,n=t.length,i=this._cacheNodesSpriteOwners[e];i.length=n;var r=this._cacheNodesDefaultlValues[e];r.length=n;for(var a=0;a<n;a++){var s=this._owner,o=t[a],l=o.path,h=0,_=0;for(h=0,_=l.length;h<_;h++){var u=l[h];if(""===u)break;if(!(s=s.getChildByName(u)))break}if(s){i[a]=s;var c=P._propertyGetFuncs[o.propertyNameID](s);if(c){var d=new Float32Array(o.keyFrameWidth);for(r[a]=d,h=0,_=c.length;h<_;h++)d[h]=c[h]}}}},i._offClipAndAvatarRelateEvent=function(e,t){e.loaded?t.loaded||t.off("loaded",this,this._getAvatarOwnersByClip):e.off("loaded",this,this._getAvatarOwnersAndInitDatasAsync)},i._getAvatarOwnersByClipAsync=function(e,t){t.loaded?this._getAvatarOwnersByClip(e):t.once("loaded",this,this._getAvatarOwnersByClip,[e])},i._offGetSpriteOwnersByClipAsyncEvent=function(e){e.loaded||e.off("loaded",this,this._getSpriteOwnersByClipAsync)},i._getSpriteOwnersByClipAsync=function(e,t){t.loaded?this._handleSpriteOwnersByClip(e):t.once("loaded",this,this._handleSpriteOwnersByClip,[e])},i._getAvatarOwnersAndInitDatasAsync=function(){for(var e=0,t=this._clips.length;e<t;e++)this._getAvatarOwnersByClipAsync(e,this._clips[e]);this._avatar._cloneDatasToAnimator(this);var n=this._avatarNodes.length;for(this._publicAvatarAnimationDatas=[],this._publicAvatarAnimationDatas.length=n,e=0;e<n;e++)this._publicAvatarAnimationDatas[e]=new at;for(e=0,t=this._avatarNodes.length;e<t;e++)this._checkAnimationNode(this._avatarNodes[e],this._owner)},i._offGetClipCacheFullKeyframeIndicesEvent=function(e){e.loaded||e.off("loaded",this,this._computeCacheFullKeyframeIndices)},i._computeCacheFullKeyframeIndices=function(e){var t=this._clips[e],n=this._cacheFrameRateInterval*this._cachePlayRate,i=t._getFullKeyframeIndicesWithCache(n);if(i)this._cacheFullFrames[e]=i;else{i=this._cacheFullFrames[e]=[];var r=t._nodes,a=r.length;i.length=a;for(var s=Math.ceil(t._duration/n+1e-5)+1,o=0;o<a;o++){for(var l=r[o],h=new Int32Array(s),_=-1,u=l.keyFrames,c=0,d=u.length;c<d;c++){var f=u[c],m=f.startTime,p=m+f.duration;do{for(var v=Math.ceil(m/n-1e-5),g=_+1;g<v;g++)h[g]=-1;h[v]=c,_=v,m+=n}while(m<p)}i[o]=h}t._cacheFullKeyframeIndices(n,i)}},i._updateAnimtionPlayer=function(){this._updatePlayer(n.timer.delta/1e3)},i._onOwnerActiveHierarchyChanged=function(){var e=this._owner;e.displayedInStage&&e.activeInHierarchy?n.timer.frameLoop(1,this,this._updateAnimtionPlayer):n.timer.clear(this,this._updateAnimtionPlayer)},i._setPlayParams=function(e,t){this._currentTime=e,this._currentFrameIndex=Math.floor(this.currentPlayTime/t+1e-5),this._currentFrameTime=this._currentFrameIndex*t},i._setPlayParamsWhenStop=function(e,t){this._currentTime=e,this._currentFrameIndex=Math.floor(e/t+1e-5),this._currentFrameTime=this._currentFrameIndex*t,this._currentPlayClip=null},i._revertKeyframeNodes=function(e,t){if(this._avatar)for(var n=this._cacheNodesDefaultlValues[t],i=e._nodes,r=this._cacheNodesAvatarOwners[t],a=0,s=r.length;a<s;a++){var o=r[a];o&&P._propertySetFuncs[i[a].propertyNameID](o,null,n[a])}},i._onAnimationStop=function(){var e,t,n,i=0,r=0;this._lastFrameIndex=-1;var a=this._currentPlayClip._nodes;if(this._avatar){var s=this._cacheNodesAvatarOwners[this._currentPlayClipIndex];for(i=0,r=s.length;i<r;i++){var o=s[i];n=(t=(e=a[i]).keyFrames)[t.length-1].data,o&&P._propertySetFuncs[e.propertyNameID](o,null,n)}}else{var l=this._cacheNodesSpriteOwners[this._currentPlayClipIndex];for(i=0,r=l.length;i<r;i++){var h=l[i];n=(t=(e=a[i]).keyFrames)[t.length-1].data,h&&P._propertySetFuncs[e.propertyNameID](null,h,n)}}},i._setAnimationClipPropertyToAnimationNode=function(e,t){for(var n=this._currentPlayClip._nodeToCachePropertyMap,i=0,r=e.length;i<r;i++){var a=e[i];if(a){var s=this._currentPlayClip._nodes[i],o=s._cacheProperty?this._curClipAnimationDatas[n[i]]:t[i];o&&P._propertySetFuncs[s.propertyNameID](a,null,o)}}},i._setAnimationClipPropertyToAnimationNodeRealTime=function(e){this._currentPlayClip._nodeToCachePropertyMap;for(var t=0,n=e.length;t<n;t++){var i=e[t];if(i){var r=this._currentPlayClip._nodes[t],a=this._curClipAnimationDatas[t];a&&P._propertySetFuncs[r.propertyNameID](i,null,a)}}},i._setAnimationClipPropertyToSprite3D=function(e){for(var t=0,n=e.length;t<n;t++){var i=e[t];if(i){var r=this._currentPlayClip._nodes[t],a=this._curClipAnimationDatas[t];a&&P._propertySetFuncs[r.propertyNameID](null,i,a)}}},i._setAnimationClipPropertyToAnimationNodeCache=function(e){for(var t=this._currentPlayClip._cachePropertyToNodeMap,n=0,i=t.length;n<i;n++){var r=t[n],a=e[r];if(a){var s=this._currentPlayClip._nodes[r],o=this._curClipAnimationDatas[n];o&&P._propertySetFuncs[s.propertyNameID](a,null,o)}}},i._setAnimationClipPropertyUnCache=function(e,t){for(var n=this._currentPlayClip._unCachePropertyToNodeMap,i=0,r=n.length;i<r;i++){var a=n[i],s=e[a];if(s){var o=this._currentPlayClip._nodes[a],l=t[i];l&&P._propertySetFuncs[o.propertyNameID](s,null,l)}}},i._handleSpriteOwnersBySprite=function(e,t,n,i){var r=this._clips[e],a=n.join("/"),s=r._nodesMap[a];if(s)for(var o=this._cacheNodesSpriteOwners[e],l=r._nodes,h=this._cacheNodesDefaultlValues[e],_=0,u=s.length;_<u;_++){var c=s[_],d=l.indexOf(c);if(t){o[d]=i;var f=P._propertyGetFuncs[c.propertyNameID](i);if(f){var m=h[d];m||(h[d]=m=new Float32Array(c.keyFrameWidth));for(var p=0,v=f.length;p<v;p++)m[p]=f[p]}}else o[d]=null}},i._updateAvatarNodes=function(e){for(var t=0,n=this._cacheSpriteToNodesMap.length;t<n;t++){var i=this._avatarNodes[this._cacheSpriteToNodesMap[t]],r=i._transform._entity,a=i._transform;if(a._worldUpdate){var s=new at;e[t]=s,a._setWorldMatrixAndUpdate(s);var o=r.worldMatrix;at.multiply(this._owner._transform.worldMatrix,s,o),r.worldMatrix=o}}},i._updateAvatarNodesCache=function(e){for(var t=0,n=this._cacheSpriteToNodesMap.length;t<n;t++){var i=this._avatarNodes[this._cacheSpriteToNodesMap[t]]._transform._entity,r=e[t];if(r){var a=i.worldMatrix;at.multiply(this._owner._transform.worldMatrix,r,a),i.worldMatrix=a}}},i._updatePlayer=function(e){if(null!=this._currentPlayClip&&!this._paused&&this._currentPlayClip.loaded){var t=this._cacheFrameRateInterval*this._cachePlayRate,n=0;this._startUpdateLoopCount!==C.loopCount&&(n=e*this.playbackRate,this._elapsedPlaybackTime+=n);var i=this._currentPlayClip._frameRate,r=this._playStartFrames[this._currentPlayClipIndex]/i,a=Math.min(this._playEndFrames[this._currentPlayClipIndex]/i,this._currentPlayClip._duration)-r;if(!this._currentPlayClip.islooping&&this._elapsedPlaybackTime>=a)return this._onAnimationStop(),this._setPlayParamsWhenStop(a,t),void this.event("stopped");if(n+=this._currentTime,a>0)if(n>=a)do{if(n-=a,this._stopWhenCircleFinish)return this._stopWhenCircleFinish=!1,this._onAnimationStop(),this._setPlayParamsWhenStop(a,t),void this.event("stopped");n<a&&(this._setPlayParams(n,t),this.event("complete"))}while(n>=a);else this._setPlayParams(n,t);else{if(this._stopWhenCircleFinish)return this._stopWhenCircleFinish=!1,this._onAnimationStop(),this._setPlayParamsWhenStop(a,t),void this.event("stopped");this._currentTime=this._currentFrameTime=this._currentFrameIndex=0,this.event("complete")}}},i._updateTansformProperty=function(){if(this._updateTransformPropertyLoopCount!==C.loopCount&&this._avatar){var e=this._publicClipAnimationDatas[this._currentPlayClipIndex];this.currentPlayClip._evaluateAnimationlDatasCacheFrame(this._cacheFullFrames[this._currentPlayClipIndex],this,e,null,this._cacheNodesAvatarOwners[this._currentPlayClipIndex]),this._setAnimationClipPropertyUnCache(this._cacheNodesAvatarOwners[this._currentPlayClipIndex],e)}},i._update=function(e){var t=this._currentPlayClip;if(2===this.playState&&t&&t.loaded){var i=this.playbackRate*n.timer.scale,r=this._cachePlayRate;this._canCache=this.isCache&&i>=r;var a=-1;if(this._canCache){if(a=this._currentFrameIndex,this._lastFrameIndex===a)return;var s,o,l;if(this._avatar){var h=t._getAvatarDataWithCache(this._avatar,this._cachePlayRate,a);if(h)return this._curClipAnimationDatas=t._getAnimationDataWithCache(r,a),this._setAnimationClipPropertyToAnimationNodeCache(this._cacheNodesAvatarOwners[this._currentPlayClipIndex]),this._updateAvatarNodesCache(h),void(this._lastFrameIndex=a);s=this._cacheNodesAvatarOwners[this._currentPlayClipIndex],o=this._publicClipAnimationDatas[this._currentPlayClipIndex]}else l=this._cacheNodesSpriteOwners[this._currentPlayClipIndex];this._curClipAnimationDatas=t._getAnimationDataWithCache(r,a),this._curClipAnimationDatas?this._avatar?(t._evaluateAnimationlDatasCacheFrame(this._cacheFullFrames[this._currentPlayClipIndex],this,o,null,s),this._setAnimationClipPropertyToAnimationNode(s,o)):this._setAnimationClipPropertyToSprite3D(l):(this._curClipAnimationDatas=[],this._curClipAnimationDatas.length=t._cachePropertyToNodeMap.length,this._avatar?(t._evaluateAnimationlDatasCacheFrame(this._cacheFullFrames[this._currentPlayClipIndex],this,o,this._curClipAnimationDatas,s),this._setAnimationClipPropertyToAnimationNode(s,o)):(t._evaluateAnimationlDatasCacheFrame(this._cacheFullFrames[this._currentPlayClipIndex],this,null,this._curClipAnimationDatas,null),this._setAnimationClipPropertyToSprite3D(l)),t._cacheAnimationData(r,a,this._curClipAnimationDatas)),this._avatar&&(this._curAvatarAnimationDatas=[],this._curAvatarAnimationDatas.length=this._cacheSpriteToNodesMap.length,this._updateAvatarNodes(this._curAvatarAnimationDatas),t._cacheAvatarData(this._avatar,r,a,this._curAvatarAnimationDatas)),this._updateTransformPropertyLoopCount=C.loopCount}else this._curClipAnimationDatas=this._publicClipAnimationDatas[this._currentPlayClipIndex],this._avatar?(t._evaluateAnimationlDatasRealTime(this.currentPlayTime,this._curClipAnimationDatas),this._setAnimationClipPropertyToAnimationNodeRealTime(this._cacheNodesAvatarOwners[this._currentPlayClipIndex]),this._curAvatarAnimationDatas=this._publicAvatarAnimationDatas,this._updateAvatarNodes(this._curAvatarAnimationDatas)):(t._evaluateAnimationlDatasRealTime(this.currentPlayTime,this._curClipAnimationDatas),this._setAnimationClipPropertyToSprite3D(this._cacheNodesSpriteOwners[this._currentPlayClipIndex]));this._lastFrameIndex=a}},i._checkAnimationNode=function(e,t){e.name!==t.name||t._transform.dummy||t._isLinkSpriteToAnimationNode(this,e,!0);for(var n=0,i=t._childs.length;n<i;n++)this._checkAnimationNode(e,t.getChildAt(n))},i._load=function(e){this._owner.on("display",this,this._onOwnerActiveHierarchyChanged),this._owner.on("undisplay",this,this._onOwnerActiveHierarchyChanged),this._owner.on("activeinhierarchychanged",this,this._onOwnerActiveHierarchyChanged)},i._unload=function(t){e.prototype._unload.call(this,t),this._curClipAnimationDatas=null,this._publicClipAnimationDatas=null,this._curAvatarAnimationDatas=null,this._publicAvatarAnimationDatas=null},i._destroy=function(){e.prototype._destroy.call(this),this._currentPlayClip=null,this._clipNames=null,this._cacheNodesSpriteOwners=null,this._cacheNodesAvatarOwners=null,this._cacheNodesDefaultlValues=null,this._publicClipAnimationDatas=null,this._clips=null,this._cacheFullFrames=null},i._cloneTo=function(e){var t=e;t.avatar=this.avatar;this._clips.length;for(var n=0,i=this._clips.length;n<i;n++)t.addClip(this._clips[n]);t.clip=this.clip,t.play()},i.addClip=function(e,t,n,i){void 0===n&&(n=0),void 0===i&&(i=4294967295),t=t||e.name;var r=this._clipNames.indexOf(t);if(-1!==r){if(this._clips[r]!==e)throw new Error("Animation:this playName has exist with another clip.")}else{var a=this._clips.indexOf(e);if(n<0||i<0)throw new Error("Animator:startFrame and endFrame must large than zero.");if(n>i)throw new Error("Animator:startFrame must less than endFrame.");this._clipNames.push(t),this._clips.push(e),this._playStartFrames.push(n),this._playEndFrames.push(i),this._cacheNodesSpriteOwners.push([]),this._cacheNodesAvatarOwners.push([]),this._cacheNodesDefaultlValues.push([]),this._publicClipAnimationDatas.push([]),a=this._clips.length-1,this._avatar?this._avatar.loaded?this._getAvatarOwnersByClipAsync(a,e):this._avatar.once("loaded",this,this._getAvatarOwnersByClipAsync,[a,e]):this._getSpriteOwnersByClipAsync(a,e),e.loaded?this._computeCacheFullKeyframeIndices(a):e.once("loaded",this,this._computeCacheFullKeyframeIndices,[a])}},i.removeClip=function(e){var t=this._clips.indexOf(e);-1!==t&&(this._avatar?this._offClipAndAvatarRelateEvent(this._avatar,e):this._offGetSpriteOwnersByClipAsyncEvent(e),this._offGetClipCacheFullKeyframeIndicesEvent(e),this._clipNames.splice(t,1),this._clips.splice(t,1),this._playStartFrames.splice(t,1),this._playEndFrames.splice(t,1),this._cacheNodesSpriteOwners.splice(t,1),this._cacheNodesAvatarOwners.splice(t,1),this._cacheNodesDefaultlValues.splice(t,1),this._publicClipAnimationDatas.splice(t,1))},i.removeClipByName=function(e){var t=this._clipNames.indexOf(e);if(-1!==t){var n=this._clips[t];this._avatar?this._offClipAndAvatarRelateEvent(this._avatar,n):this._offGetSpriteOwnersByClipAsyncEvent(n),this._offGetClipCacheFullKeyframeIndicesEvent(n),this._clipNames.splice(t,1),this._clips.splice(t,1),this._playStartFrames.splice(t,1),this._playEndFrames.splice(t,1),this._cacheNodesSpriteOwners.splice(t,1),this._cacheNodesAvatarOwners.splice(t,1),this._cacheNodesDefaultlValues.splice(t,1),this._publicClipAnimationDatas.splice(t,1)}},i.getClip=function(e){var t=this._clipNames.indexOf(e);return-1!==t?this._clips[t]:null},i.getClipCount=function(){return this._clips.length},i.play=function(e,t){if(void 0===t&&(t=1),!e&&-1==this._defaultClipIndex)throw new Error("Animator:must have  default clip value,please set clip property.");e?(this._currentPlayClipIndex=this._clipNames.indexOf(e),this._currentPlayClip=this._clips[this._currentPlayClipIndex]):(this._currentPlayClipIndex=this._defaultClipIndex,this._currentPlayClip=this._clips[this._defaultClipIndex]),this._currentTime=0,this._currentFrameTime=0,this._elapsedPlaybackTime=0,this.playbackRate=t,this._paused=!1,this._currentFrameIndex=0,this._startUpdateLoopCount=C.loopCount,this.event("played"),this._lastPlayAnimationClip&&this._lastPlayAnimationClip!==this._currentPlayClip&&this._revertKeyframeNodes(this._lastPlayAnimationClip,this._lastPlayAnimationClipIndex),this._updatePlayer(0),this._lastPlayAnimationClip=this._currentPlayClip,this._lastPlayAnimationClipIndex=this._currentPlayClipIndex},i.stop=function(e){void 0===e&&(e=!0),0!==this.playState&&(e?(this._onAnimationStop(),this._currentTime=this._currentFrameTime=this._currentFrameIndex=0,this._currentPlayClip=null,this.event("stopped")):this._stopWhenCircleFinish=!0)},i.linkSprite3DToAvatarNode=function(e,t){if(this._avatar){var n=this._avatarNodeMap[e];return!!n&&(t._isLinkSpriteToAnimationNode(this,n,!0),!0)}return!1},i.unLinkSprite3DToAvatarNode=function(e){if(this._avatar){var t=e.transform.dummy;if(t){var n=this._avatarNodeMap[t._owner.name];return e._isLinkSpriteToAnimationNode(this,n,!1),!0}return!1}return!1},a(0,i,"avatar",function(){return this._avatar},function(e){if(this._avatar!==e){var t=this._avatar;this._avatar=e;for(var n=this._clips.length,i=0;i<n;i++)this._offClipAndAvatarRelateEvent(t,this._clips[i]);e&&(e.loaded?this._getAvatarOwnersAndInitDatasAsync():e.once("loaded",this,this._getAvatarOwnersAndInitDatasAsync))}}),a(0,i,"cacheFrameRate",function(){return this._cacheFrameRate},function(e){if(this._cacheFrameRate!==e){this._cacheFrameRate=e,this._cacheFrameRateInterval=1/this._cacheFrameRate;for(var t=0,n=this._clips.length;t<n;t++)this._clips[t].loaded&&this._computeCacheFullKeyframeIndices(t)}}),a(0,i,"paused",function(){return this._paused},function(e){this._paused=e,e&&this.event("paused")}),a(0,i,"clip",function(){return this._clips[this._defaultClipIndex]},function(e){var t=e?this._clips.indexOf(e):-1;this._defaultClipIndex!==t&&(-1!==this._defaultClipIndex&&this.removeClip(this._clips[this._defaultClipIndex]),-1!==t&&this.addClip(e,e.name),this._defaultClipIndex=t)}),a(0,i,"currentFrameIndex",function(){return this._currentFrameIndex}),a(0,i,"cachePlayRate",function(){return this._cachePlayRate},function(e){if(this._cachePlayRate!==e){this._cachePlayRate=e;for(var t=0,n=this._clips.length;t<n;t++)this._clips[t].loaded&&this._computeCacheFullKeyframeIndices(t)}}),a(0,i,"currentFrameTime",function(){return this._currentFrameTime}),a(0,i,"currentPlayClip",function(){return this._currentPlayClip}),a(0,i,"currentPlayTime",function(){return this._currentTime+this._playStartFrames[this._currentPlayClipIndex]/this._currentPlayClip._frameRate}),a(0,i,"playState",function(){return null==this._currentPlayClip?0:this._paused?1:2}),a(0,i,"curAnimationDatas",function(){return this._curClipAnimationDatas}),a(0,i,"playbackTime",null,function(e){if(null!=this._currentPlayClip&&this._currentPlayClip&&this._currentPlayClip.loaded){this._startUpdateLoopCount=C.loopCount;var t=this._cacheFrameRateInterval*this._cachePlayRate;this._currentTime=e,this._currentFrameIndex=Math.floor(this.currentPlayTime/t),this._currentFrameTime=this._currentFrameIndex*t}}),t}(Vt),en=(function(e){function t(){this._attachSkeleton=null,this._extenData=null,this.attachBones=null,this.matrixs=null,t.__super.call(this),this.attachBones=[],this.matrixs=[]}r(t,"laya.d3.component.AttachPoint",e);var n=t.prototype;n._load=function(t){e.prototype._load.call(this,t),this._attachSkeleton=t.getComponentByType(Tn)},n._update=function(e){if(this._attachSkeleton&&!this._attachSkeleton.destroyed&&0!==this._attachSkeleton.player.state&&this._attachSkeleton.curBonesDatas){var t=this._attachSkeleton.player,n=this._attachSkeleton.templet;this.matrixs.length=this.attachBones.length;for(var i=this._attachSkeleton.curBonesDatas,r=this.owner.transform.worldMatrix,a=0,s=this.attachBones.length;a<s;a++){var o=16*n.getNodeIndexWithName(t.currentAnimationClipIndex,this.attachBones[a]),l=this.matrixs[a];l||(l=this.matrixs[a]=new at);for(var h=l.elements,_=0;_<16;_++)h[_]=i[o+_];at.multiply(r,l,l)}this.event("complete")}}}(Vt),function(e){function t(){this._needUpdate=!1,t.__super.call(this)}r(t,"laya.d3.component.physics.Collider",Vt);var n=t.prototype;return n.raycast=function(e,t,n){throw void 0===n&&(n=Number.MAX_VALUE),new Error("Must override it.")},a(0,n,"isSingleton",function(){return t._isSingleton}),t._isSingleton=!1,t}()),tn=(function(e){function t(){t.__super.call(this)}r(t,"laya.d3.component.Script",Vt);var n=t.prototype;a(0,n,"isSingleton",function(){return t._isSingleton}),t._isSingleton=!1}(),function(e){function t(e){t.__super.call(this,e)}r(t,"laya.d3.core.GlitterRender",Ot);var n=t.prototype;return n._calculateBoundingBox=function(){var e=this._boundingBox.min.elements;e[0]=-Number.MAX_VALUE,e[1]=-Number.MAX_VALUE,e[2]=-Number.MAX_VALUE;var t=this._boundingBox.min.elements;t[0]=Number.MAX_VALUE,t[1]=Number.MAX_VALUE,t[2]=Number.MAX_VALUE},n._calculateBoundingSphere=function(){var e=this._boundingSphere.center.elements;e[0]=0,e[1]=0,e[2]=0,this._boundingSphere.radius=Number.MAX_VALUE},n._renderUpdate=function(e){this._setShaderValueMatrix4x4(0,this._owner.transform.worldMatrix);var t=this._owner.getProjectionViewWorldMatrix(e);this._setShaderValueMatrix4x4(1,t);var n=this._owner.templet;this._setShaderValueNumber(3,n.lifeTime),this._setShaderValueNumber(2,n._currentTime)},t}()),nn=function(e){function t(e){this._owner=null,this._sharedMesh=null,t.__super.call(this),this._owner=e}r(t,"laya.d3.core.MeshFilter",e);var n=t.prototype;return n._sharedMeshLoaded=function(){this.event("loaded")},n._destroy=function(){e.prototype._destroy.call(this),this._owner=null,this._sharedMesh=null},a(0,n,"sharedMesh",function(){return this._sharedMesh},function(e){var t=this._sharedMesh;this._sharedMesh=e,this.event("meshchanged",[this,t,e]),e.loaded||this._sharedMesh.once("loaded",this,this._sharedMeshLoaded)}),a(0,n,"_isAsyncLoaded",function(){return this._sharedMesh.loaded}),a(0,n,"_originalBoundingBoxCorners",function(){return this._sharedMesh.boundingBoxCorners}),a(0,n,"_originalBoundingSphere",function(){return this._sharedMesh.boundingSphere}),a(0,n,"_originalBoundingBox",function(){return this._sharedMesh.boundingBox}),t}(Nt),rn=function(e){function t(e){t.__super.call(this,e),e.meshFilter.on("meshchanged",this,this._onMeshChanged)}r(t,"laya.d3.core.MeshRender",Ot);var n=t.prototype;return n._onMeshChanged=function(e,t,n){n.loaded?this._boundingSphereNeedChange=this._boundingBoxNeedChange=this._boundingBoxCenterNeedChange=this._octreeNodeNeedChange=!0:n.once("loaded",this,this._onMeshLoaed)},n._onMeshLoaed=function(e,t){this._boundingSphereNeedChange=this._boundingBoxNeedChange=this._boundingBoxCenterNeedChange=this._octreeNodeNeedChange=!0},n._calculateBoundingSphere=function(){var e=this._owner.meshFilter.sharedMesh;if(null==e||null==e.boundingSphere)this._boundingSphere.toDefault();else{var t=e.boundingSphere,n=NaN,i=this._owner.transform,r=i.scale.elements,a=Math.abs(r[0]),s=Math.abs(r[1]),o=Math.abs(r[2]);n=a>=s&&a>=o?a:s>=o?s:o,ct.transformCoordinate(t.center,i.worldMatrix,this._boundingSphere.center),this._boundingSphere.radius=t.radius*n}},n._calculateBoundingBox=function(){var e=this._owner.meshFilter.sharedMesh;if(null==e||null==e.boundingBox)this._boundingBox.toDefault();else{for(var t=this._owner.transform.worldMatrix,n=e.boundingBoxCorners,i=0;i<8;i++)ct.transformCoordinate(n[i],t,Ot._tempBoundBoxCorners[i]);Je.createfromPoints(Ot._tempBoundBoxCorners,this._boundingBox)}},n._renderUpdate=function(e){var t=this._owner.transform;if(t){this._setShaderValueMatrix4x4(0,t.worldMatrix);var n=this._owner.getProjectionViewWorldMatrix(e);this._setShaderValueMatrix4x4(1,n)}else this._setShaderValueMatrix4x4(0,at.DEFAULT),this._setShaderValueMatrix4x4(1,e)},t}(),an=function(e){function t(e){t.__super.call(this),this._tempRotationMatrix=new at,this._uvLength=new ut,this._firstActiveElement=0,this._firstNewElement=0,this._firstFreeElement=0,this._firstRetiredElement=0,this._owner=e,this._ownerRender=e.particleRender,this._boundingBoxCorners=new Array(8),this._boundingSphere=new tt(new ct,0),this._boundingBox=new Je(new ct,new ct),this._currentTime=0,this._isEmitting=!1,this._isPlaying=!1,this._isPaused=!1,this._burstsIndex=0,this._frameRateTime=0,this._emissionTime=0,this._totalDelayTime=0,this._simulateUpdate=!1,this._bufferMaxParticles=1,this.duration=5,this.looping=!0,this.prewarm=!1,this.startDelayType=0,this.startDelay=0,this.startDelayMin=0,this.startDelayMax=0,this._startLifetimeType=0,this._startLifetimeConstant=5,this._startLifeTimeGradient=new q,this._startLifetimeConstantMin=0,this._startLifetimeConstantMax=5,this._startLifeTimeGradientMin=new q,this._startLifeTimeGradientMax=new q,this._maxStartLifetime=5,this.startSpeedType=0,this.startSpeedConstant=5,this.startSpeedConstantMin=0,this.startSpeedConstantMax=5,this.threeDStartSize=!1,this.startSizeType=0,this.startSizeConstant=1,this.startSizeConstantSeparate=new ct(1,1,1),this.startSizeConstantMin=0,this.startSizeConstantMax=1,this.startSizeConstantMinSeparate=new ct(0,0,0),this.startSizeConstantMaxSeparate=new ct(1,1,1),this.threeDStartRotation=!1,this.startRotationType=0,this.startRotationConstant=0,this.startRotationConstantSeparate=new ct(0,0,0),this.startRotationConstantMin=0,this.startRotationConstantMax=0,this.startRotationConstantMinSeparate=new ct(0,0,0),this.startRotationConstantMaxSeparate=new ct(0,0,0),this.randomizeRotationDirection=0,this.startColorType=0,this.startColorConstant=new dt(1,1,1,1),this.startColorConstantMin=new dt(1,1,1,1),this.startColorConstantMax=new dt(1,1,1,1),this.gravityModifier=0,this.simulationSpace=1,this.scaleMode=0,this.playOnAwake=!0,this._rand=new ht(0),this.autoRandomSeed=!0,this.randomSeed=new Uint32Array(1),this._randomSeeds=new Uint32Array(t._RANDOMOFFSET.length),this.isPerformanceMode=!0,this._owner.on("activeinhierarchychanged",this,this._onOwnerActiveHierarchyChanged),this._owner.on("display",this,this._onDisplayInStage),this._owner.on("undisplay",this,this._onUnDisplayInStage)}r(t,"laya.d3.core.particleShuriKen.ShurikenParticleSystem",e);var s=t.prototype;return n.imps(s,{"laya.d3.core.render.IRenderable":!0,"laya.d3.core.IClone":!0}),s._getVertexBuffer=function(e){return void 0===e&&(e=0),0===e?this._vertexBuffer:null},s._getIndexBuffer=function(){return this._indexBuffer},s._generateBoundingSphere=function(){var e=this._boundingSphere.center.elements;e[0]=0,e[1]=0,e[2]=0,this._boundingSphere.radius=Number.MAX_VALUE},s._generateBoundingBox=function(){var e=this._owner.particleRender,n=this._boundingBox.min,i=this._boundingBox.max,r=0,a=0,s=NaN;switch(this.startLifetimeType){case 0:s=this.startLifetimeConstant;break;case 1:s=-Number.MAX_VALUE;var o=o;for(r=0,a=o.gradientCount;r<a;r++)s=Math.max(s,o.getValueByIndex(r));break;case 2:s=Math.max(this.startLifetimeConstantMin,this.startLifetimeConstantMax);break;case 3:s=-Number.MAX_VALUE;var l=l;for(r=0,a=l.gradientCount;r<a;r++)s=Math.max(s,l.getValueByIndex(r));var h=h;for(r=0,a=h.gradientCount;r<a;r++)s=Math.max(s,h.getValueByIndex(r))}var _=NaN,u=NaN;switch(this.startSpeedType){case 0:_=u=this.startSpeedConstant;break;case 1:break;case 2:_=this.startLifetimeConstantMin,u=this.startLifetimeConstantMax}var c,d,f,m;this._shape&&this._shape.enable||(c=d=ct.ZERO,f=ct.ZERO,m=ct.UnitZ);var p=new ct(f.x*_,f.y*_,f.z*_),v=new ct(m.x*u,m.y*u,m.z*u);if(this._velocityOverLifetime&&this._velocityOverLifetime.enbale){var g=this._velocityOverLifetime.velocity;switch(g.type){case 0:g.constant;break;case 1:new ct(g.gradientX.getAverageValue(),g.gradientY.getAverageValue(),g.gradientZ.getAverageValue());break;case 2:g.constantMin,g.constantMax;break;case 3:new ct(g.gradientXMin.getAverageValue(),g.gradientYMin.getAverageValue(),g.gradientZMin.getAverageValue()),new ct(g.gradientXMax.getAverageValue(),g.gradientYMax.getAverageValue(),g.gradientZMax.getAverageValue())}}var x,E,S=this._owner.transform,D=S.position,T=t._tempVector39,M=T.elements,y=e.renderMode;switch(this.scaleMode){case 0:var R=S.scale;x=R,M[0]=R.x,M[1]=R.z,M[2]=R.y,1===y&&(E=R);break;case 1:var A=S.localScale;x=A,M[0]=A.x,M[1]=A.z,M[2]=A.y,1===y&&(E=A);break;case 2:x=S.scale,M[0]=M[1]=M[2]=1,1===y&&(E=ct.ONE)}var C,I;switch(this._velocityOverLifetime&&this._velocityOverLifetime.enbale||(C=new ct(p.x*s,p.y*s,p.z*s),I=new ct(v.x*s,v.y*s,v.z*s),2!=this.scaleMode?(ct.add(c,C,n),ct.multiply(x,n,n),ct.add(d,I,i),ct.multiply(x,i,i)):(ct.multiply(x,c,n),ct.add(n,C,n),ct.multiply(x,d,i),ct.add(i,I,i))),this.simulationSpace){case 0:break;case 1:ct.add(n,D,n),ct.add(i,D,i)}var w=NaN,V=NaN;switch(this.startSizeType){case 0:if(this.threeDStartSize){var N=N;w=Math.max(N.x,N.y),1===y&&(V=N.y)}else w=this.startSizeConstant,1===y&&(V=this.startSizeConstant);break;case 1:break;case 2:if(this.threeDStartSize){var O=O;w=Math.max(O.x,O.y),1===y&&(V=O.y)}else w=this.startSizeConstantMax,1===y&&(V=this.startSizeConstantMax)}if(this._sizeOverLifetime&&this._sizeOverLifetime.enbale){this._sizeOverLifetime.size;w*=this._sizeOverLifetime.size.getMaxSizeInGradient()}var b=t._tempVector30,P=b.elements,L=NaN,F=NaN;switch(y){case 0:L=w*t.halfKSqrtOf2,ct.scale(T,w,b),ct.subtract(n,b,n),ct.add(i,b,i);break;case 1:var B=t._tempVector31,U=t._tempVector32,H=t._tempVector33,z=t._tempVector34;this._velocityOverLifetime&&this._velocityOverLifetime.enbale||(ct.multiply(E,v,U),ct.multiply(E,p,H));var G=V*e.stretchedBillboardLengthScale,k=ct.scalarLength(U)*e.stretchedBillboardSpeedScale+G,W=ct.scalarLength(H)*e.stretchedBillboardSpeedScale+G,X=t._tempVector35,j=t._tempVector36;ct.normalize(U,X),ct.scale(X,k,z),ct.subtract(I,z,z),ct.normalize(H,j),ct.scale(j,W,B),ct.add(C,B,B),L=w*t.halfKSqrtOf2,ct.scale(T,L,b);var Z=t._tempVector37,Y=t._tempVector38;ct.scale(X,.5,Z),ct.scale(j,.5,Y),ct.multiply(Z,T,Z),ct.multiply(Y,T,Y),ct.add(n,Y,n),ct.min(n,z,n),ct.subtract(n,b,n),ct.subtract(i,Z,i),ct.max(i,B,i),ct.add(i,b,i);break;case 2:F=.5*(w*=Math.cos(.7853981633974483)),P[0]=T.x*F,P[1]=T.z*F,ct.subtract(n,b,n),ct.add(i,b,i);break;case 3:F=.5*(w*=Math.cos(.7853981633974483)),ct.scale(T,F,b),ct.subtract(n,b,n),ct.add(i,b,i)}this._boundingBox.getCorners(this._boundingBoxCorners)},s._updateEmission=function(){if(n.stage.isVisibility)if(this._simulateUpdate)this._simulateUpdate=!1;else{var e=this._startUpdateLoopCount===C.loopCount||this._isPaused?0:n.timer.delta/1e3;e=Math.min(t._maxElapsedTime,e),this._updateParticles(e)}},s._updateParticles=function(e){this._currentTime+=e,this._retireActiveParticles(),this._freeRetiredParticles(),this._totalDelayTime+=e,this._totalDelayTime<this._playStartDelay||this._emission.enbale&&this._isEmitting&&!this._isPaused&&this._advanceTime(e,this._currentTime)},s._updateParticlesSimulationRestart=function(e){this._firstActiveElement=0,this._firstNewElement=0,this._firstFreeElement=0,this._firstRetiredElement=0,this._burstsIndex=0,this._frameRateTime=e,this._emissionTime=0,this._totalDelayTime=0,this._currentTime=e;var t=e;t<this._playStartDelay?this._totalDelayTime=t:this._emission.enbale&&this._advanceTime(e,e)},s._addUpdateEmissionToTimer=function(){n.timer.frameLoop(1,this,this._updateEmission)},s._removeUpdateEmissionToTimer=function(){n.timer.clear(this,this._updateEmission)},s._onOwnerActiveHierarchyChanged=function(e){this._owner.displayedInStage&&(e?this._addUpdateEmissionToTimer():this._removeUpdateEmissionToTimer())},s._onDisplayInStage=function(){this._owner.activeInHierarchy&&this._addUpdateEmissionToTimer()},s._onUnDisplayInStage=function(){this._owner.activeInHierarchy&&this._removeUpdateEmissionToTimer()},s._retireActiveParticles=function(){for(;this._firstActiveElement!=this._firstNewElement;){var e=this._firstActiveElement*this._floatCountPerVertex*this._vertexStride,t=e+this._timeIndex;if(this._currentTime-this._vertices[t]+1e-4<this._vertices[e+this._startLifeTimeIndex])break;this._vertices[t]=this._drawCounter,this._firstActiveElement++,this._firstActiveElement>=this._bufferMaxParticles&&(this._firstActiveElement=0)}},s._freeRetiredParticles=function(){for(;this._firstRetiredElement!=this._firstActiveElement;){var e=this._drawCounter-this._vertices[this._firstRetiredElement*this._floatCountPerVertex*this._vertexStride+this._timeIndex];if(this.isPerformanceMode&&e<3)break;this._firstRetiredElement++,this._firstRetiredElement>=this._bufferMaxParticles&&(this._firstRetiredElement=0)}},s._burst=function(e,t){for(var n=0,i=this._emission._bursts,r=i.length;this._burstsIndex<r;this._burstsIndex++){var a=i[this._burstsIndex],s=a.time;if(!(e<=s&&s<t))break;var o=0;this.autoRandomSeed?o=S.lerp(a.minCount,a.maxCount,Math.random()):(this._rand.seed=this._randomSeeds[0],o=S.lerp(a.minCount,a.maxCount,this._rand.getFloat()),this._randomSeeds[0]=this._rand.seed),n+=o}return n},s._advanceTime=function(e,t){var n=0,i=this._emissionTime;this._emissionTime+=e;var r=0;if(this._emissionTime>this.duration){if(!this.looping){for(this._isPlaying=!1,r=Math.min(this.maxParticles-this.aliveParticleCount,r),n=0;n<r;n++)this.emit(t);return void this.event("stopped")}r+=this._burst(i,this._emissionTime),this._emissionTime-=this.duration,this.event("complete"),this._burstsIndex=0,r+=this._burst(0,this._emissionTime)}else r+=this._burst(i,this._emissionTime);for(r=Math.min(this.maxParticles-this.aliveParticleCount,r),n=0;n<r;n++)this.emit(t);var a=this.emission.emissionRate;if(a>0){var s=1/a;for(this._frameRateTime+=s,this._frameRateTime=this._currentTime-(this._currentTime-this._frameRateTime)%this._maxStartLifetime;this._frameRateTime<=t&&this.emit(this._frameRateTime);)this._frameRateTime+=s;this._frameRateTime=Math.floor(t/s)*s}},s._initBufferDatas=function(){var e=this._ownerRender,t=e.renderMode;if(-1!==t&&this.maxParticles>0){var n,i,r=0,a=0,s=0,o=0,l=0,h=e.mesh;if(4===t&&h){if(h._vertexBuffers.length>1)throw new Error("ShurikenParticleSystem: submesh Count mesh be One or all subMeshes have the same vertexDeclaration.");i=Ye.vertexDeclaration,this._floatCountPerVertex=i.vertexStride/4,this._startLifeTimeIndex=8,this._timeIndex=12,this._vertexStride=h._vertexBuffers[0].vertexCount;var _=this._bufferMaxParticles*this._vertexStride,u=_%65535;if(Math.floor(_/65535)+1>1)throw new Error("ShurikenParticleSystem:the maxParticleCount multiply mesh vertexCount is large than 65535.");this._vertexBuffer=En.create(i,u,35048),this._vertices=new Float32Array(this._floatCountPerVertex*u),this._indexStride=h._indexBuffer.indexCount;var c=h._indexBuffer.getData(),d=this._bufferMaxParticles*this._indexStride;for(this._indexBuffer=xn.create("ushort",d,35044),n=new Uint16Array(d),o=0,r=0;r<this._bufferMaxParticles;r++){var f=r*this._vertexStride;for(a=0,s=c.length;a<s;a++)n[o++]=f+c[a]}this._indexBuffer.setData(n)}else{for(i=Ze.vertexDeclaration,this._floatCountPerVertex=i.vertexStride/4,this._startLifeTimeIndex=7,this._timeIndex=11,this._vertexStride=4,this._vertexBuffer=En.create(i,this._bufferMaxParticles*this._vertexStride,35048),this._vertices=new Float32Array(this._floatCountPerVertex*this._bufferMaxParticles*this._vertexStride),r=0;r<this._bufferMaxParticles;r++)l=r*this._floatCountPerVertex*this._vertexStride,this._vertices[l]=-.5,this._vertices[l+1]=-.5,this._vertices[l+2]=0,this._vertices[l+3]=1,l+=this._floatCountPerVertex,this._vertices[l]=.5,this._vertices[l+1]=-.5,this._vertices[l+2]=1,this._vertices[l+3]=1,l+=this._floatCountPerVertex,this._vertices[l]=.5,this._vertices[l+1]=.5,this._vertices[l+2]=1,this._vertices[l+3]=0,l+=this._floatCountPerVertex,this._vertices[l]=-.5,this._vertices[l+1]=.5,this._vertices[l+2]=0,this._vertices[l+3]=0;for(this._indexStride=6,this._indexBuffer=xn.create("ushort",6*this._bufferMaxParticles,35044),n=new Uint16Array(6*this._bufferMaxParticles),r=0;r<this._bufferMaxParticles;r++){o=6*r;var m=r*this._vertexStride,p=m+2;n[o++]=m,n[o++]=p,n[o++]=m+1,n[o++]=m,n[o++]=m+3,n[o++]=p}this._indexBuffer.setData(n)}}},s._destroy=function(){e.prototype._destroy.call(this),this._owner.displayedInStage&&this._owner.activeInHierarchy&&this._removeUpdateEmissionToTimer(),this._vertexBuffer.dispose(),this._indexBuffer.dispose(),this._emission._destroy(),this._owner=null,this._vertices=null,this._vertexBuffer=null,this._indexBuffer=null,this._emission=null,this._shape=null,this.startLifeTimeGradient=null,this.startLifeTimeGradientMin=null,this.startLifeTimeGradientMax=null,this.startSizeConstantSeparate=null,this.startSizeConstantMinSeparate=null,this.startSizeConstantMaxSeparate=null,this.startRotationConstantSeparate=null,this.startRotationConstantMinSeparate=null,this.startRotationConstantMaxSeparate=null,this.startColorConstant=null,this.startColorConstantMin=null,this.startColorConstantMax=null,this._velocityOverLifetime=null,this._colorOverLifetime=null,this._sizeOverLifetime=null,this._rotationOverLifetime=null,this._textureSheetAnimation=null},s.emit=function(e){var n=t._tempPosition,i=t._tempDirection;if(this._shape.enable)this.autoRandomSeed?this._shape.generatePositionAndDirection(n,i):this._shape.generatePositionAndDirection(n,i,this._rand,this._randomSeeds);else{var r=n.elements,a=i.elements;r[0]=r[1]=r[2]=0,a[0]=a[1]=0,a[2]=1}return this.addParticle(n,i,e)},s.addParticle=function(e,t,n){ct.normalize(t,t);var i=this._firstFreeElement+1;if(i>=this._bufferMaxParticles&&(i=0),i===this._firstRetiredElement)return!1;if(ae.create(this,this._ownerRender,this._owner.transform),this._currentTime-n>=ae.startLifeTime)return!0;var r=NaN,a=NaN,s=NaN,o=NaN,l=NaN,h=NaN,_=NaN,u=this._velocityOverLifetime&&this._velocityOverLifetime.enbale;if(u){var c=this._velocityOverLifetime.velocity.type;2===c||3===c?this.autoRandomSeed?(r=Math.random(),a=Math.random(),s=Math.random()):(this._rand.seed=this._randomSeeds[9],r=this._rand.getFloat(),a=this._rand.getFloat(),s=this._rand.getFloat(),this._randomSeeds[9]=this._rand.seed):u=!1}else u=!1;var d=this._colorOverLifetime&&this._colorOverLifetime.enbale;d&&3===this._colorOverLifetime.color.type?this.autoRandomSeed?o=Math.random():(this._rand.seed=this._randomSeeds[10],o=this._rand.getFloat(),this._randomSeeds[10]=this._rand.seed):d=!1;var f=this._sizeOverLifetime&&this._sizeOverLifetime.enbale;f&&3===this._sizeOverLifetime.size.type?this.autoRandomSeed?l=Math.random():(this._rand.seed=this._randomSeeds[11],l=this._rand.getFloat(),this._randomSeeds[11]=this._rand.seed):f=!1;var m=this._rotationOverLifetime&&this._rotationOverLifetime.enbale;if(m){var p=this._rotationOverLifetime.angularVelocity.type;2===p||3===p?this.autoRandomSeed?h=Math.random():(this._rand.seed=this._randomSeeds[12],h=this._rand.getFloat(),this._randomSeeds[12]=this._rand.seed):m=!1}else m=!1;var v=this._textureSheetAnimation&&this._textureSheetAnimation.enable;v&&3===this._textureSheetAnimation.frame.type?this.autoRandomSeed?_=Math.random():(this._rand.seed=this._randomSeeds[15],_=this._rand.getFloat(),this._randomSeeds[15]=this._rand.seed):v=!1;var g,x=this._firstFreeElement*this._floatCountPerVertex*this._vertexStride,E=ae.startUVInfo[0],S=ae.startUVInfo[1],D=ae.startUVInfo[2],T=ae.startUVInfo[3],M=e.elements,y=t.elements,R=0,A=0,C=0,I=0,w=this._ownerRender;if(4===w.renderMode){var V=w.mesh._vertexBuffers[0];g=V.getData();var N=V.vertexDeclaration;C=N.getVertexElementByUsage(0).offset/4,A=N.getVertexElementByUsage(2).offset/4,R=N.vertexStride/4,I=0}else{this._vertices[x+2]=D,this._vertices[x+3]=T+S;var O=x+this._floatCountPerVertex;this._vertices[O+2]=D+E,this._vertices[O+3]=T+S;var b=O+this._floatCountPerVertex;this._vertices[b+2]=D+E,this._vertices[b+3]=T;var P=b+this._floatCountPerVertex;this._vertices[P+2]=D,this._vertices[P+3]=T}for(var L=x,F=x+this._floatCountPerVertex*this._vertexStride;L<F;L+=this._floatCountPerVertex){var B=0;if(4===w.renderMode){B=L;var U=R*I++,H=U+C;this._vertices[B++]=g[H+0],this._vertices[B++]=g[H+1],this._vertices[B++]=g[H+2];var z=U+A;this._vertices[B++]=D+g[z]*E,this._vertices[B++]=T+g[++z]*S}else B=L+4;switch(this._vertices[B++]=M[0],this._vertices[B++]=M[1],this._vertices[B++]=M[2],this._vertices[B++]=ae.startLifeTime,this._vertices[B++]=y[0],this._vertices[B++]=y[1],this._vertices[B++]=y[2],this._vertices[B++]=n,this._vertices[B++]=ae.startColor[0],this._vertices[B++]=ae.startColor[1],this._vertices[B++]=ae.startColor[2],this._vertices[B++]=ae.startColor[3],this._vertices[B++]=ae.startSize[0],this._vertices[B++]=ae.startSize[1],this._vertices[B++]=ae.startSize[2],this._vertices[B++]=ae.startRotation[0],this._vertices[B++]=ae.startRotation[1],this._vertices[B++]=ae.startRotation[2],this._vertices[B++]=ae.startSpeed,d&&(this._vertices[B+1]=o),f&&(this._vertices[B+2]=l),m&&(this._vertices[B+3]=h),v&&(this._vertices[B+4]=_),u&&(this._vertices[B+5]=r,this._vertices[B+6]=a,this._vertices[B+7]=s),this.simulationSpace){case 0:B+=8,this._vertices[B++]=ae.simulationWorldPostion[0],this._vertices[B++]=ae.simulationWorldPostion[1],this._vertices[B++]=ae.simulationWorldPostion[2],this._vertices[B++]=ae.simulationWorldRotation[0],this._vertices[B++]=ae.simulationWorldRotation[1],this._vertices[B++]=ae.simulationWorldRotation[2],this._vertices[B++]=ae.simulationWorldRotation[3];break;case 1:break;default:throw new Error("ShurikenParticleMaterial: SimulationSpace value is invalid.")}}return this._firstFreeElement=i,!0},s.addNewParticlesToVertexBuffer=function(){var e=0;this._firstNewElement<this._firstFreeElement?(e=this._firstNewElement*this._vertexStride*this._floatCountPerVertex,this._vertexBuffer.setData(this._vertices,e,e,(this._firstFreeElement-this._firstNewElement)*this._vertexStride*this._floatCountPerVertex)):(e=this._firstNewElement*this._vertexStride*this._floatCountPerVertex,this._vertexBuffer.setData(this._vertices,e,e,(this._bufferMaxParticles-this._firstNewElement)*this._vertexStride*this._floatCountPerVertex),this._firstFreeElement>0&&this._vertexBuffer.setData(this._vertices,0,0,this._firstFreeElement*this._vertexStride*this._floatCountPerVertex)),this._firstNewElement=this._firstFreeElement},s._beforeRender=function(e){return this._firstNewElement!=this._firstFreeElement&&this.addNewParticlesToVertexBuffer(),this._drawCounter++,this._firstActiveElement!=this._firstFreeElement&&(this._vertexBuffer._bind(),this._indexBuffer._bind(),!0)},s._render=function(e){var t=0,n=N.mainContext;this._firstActiveElement<this._firstFreeElement?(t=(this._firstFreeElement-this._firstActiveElement)*this._indexStride,n.drawElements(4,t,5123,2*this._firstActiveElement*this._indexStride),C.trianglesFaces+=t/3,C.drawCall++):(t=(this._bufferMaxParticles-this._firstActiveElement)*this._indexStride,n.drawElements(4,t,5123,2*this._firstActiveElement*this._indexStride),C.trianglesFaces+=t/3,C.drawCall++,this._firstFreeElement>0&&(t=this._firstFreeElement*this._indexStride,n.drawElements(4,t,5123,0),C.trianglesFaces+=t/3,C.drawCall++))},s.play=function(){if(this._burstsIndex=0,this._isEmitting=!0,this._isPlaying=!0,this._isPaused=!1,this._emissionTime=0,this._totalDelayTime=0,!this.autoRandomSeed)for(var e=0,n=this._randomSeeds.length;e<n;e++)this._randomSeeds[e]=this.randomSeed[0]+t._RANDOMOFFSET[e];switch(this.startDelayType){case 0:this._playStartDelay=this.startDelay;break;case 1:this.autoRandomSeed?this._playStartDelay=S.lerp(this.startDelayMin,this.startDelayMax,Math.random()):(this._rand.seed=this._randomSeeds[2],this._playStartDelay=S.lerp(this.startDelayMin,this.startDelayMax,this._rand.getFloat()),this._randomSeeds[2]=this._rand.seed);break;default:throw new Error("Utils3D: startDelayType is invalid.")}this._frameRateTime+=this._playStartDelay,this._startUpdateLoopCount=C.loopCount,this.event("played")},s.pause=function(){this._isPaused=!0,this.event("paused")},s.simulate=function(e,t){void 0===t&&(t=!0),this._simulateUpdate=!0,t?this._updateParticlesSimulationRestart(e):(this._isPaused=!1,this._updateParticles(e)),this.pause()},s.stop=function(){this._burstsIndex=0,this._isEmitting=!1,this._emissionTime=0,this.event("stopped")},s.cloneTo=function(e){var t=e;t.duration=this.duration,t.looping=this.looping,t.prewarm=this.prewarm,t.startDelayType=this.startDelayType,t.startDelay=this.startDelay,t.startDelayMin=this.startDelayMin,t.startDelayMax=this.startDelayMax,t._maxStartLifetime=this._maxStartLifetime,t.startLifetimeType=this.startLifetimeType,t.startLifetimeConstant=this.startLifetimeConstant,this.startLifeTimeGradient.cloneTo(t.startLifeTimeGradient),t.startLifetimeConstantMin=this.startLifetimeConstantMin,t.startLifetimeConstantMax=this.startLifetimeConstantMax,this.startLifeTimeGradientMin.cloneTo(t.startLifeTimeGradientMin),this.startLifeTimeGradientMax.cloneTo(t.startLifeTimeGradientMax),t.startSpeedType=this.startSpeedType,t.startSpeedConstant=this.startSpeedConstant,t.startSpeedConstantMin=this.startSpeedConstantMin,t.startSpeedConstantMax=this.startSpeedConstantMax,t.threeDStartSize=this.threeDStartSize,t.startSizeType=this.startSizeType,t.startSizeConstant=this.startSizeConstant,this.startSizeConstantSeparate.cloneTo(t.startSizeConstantSeparate),t.startSizeConstantMin=this.startSizeConstantMin,t.startSizeConstantMax=this.startSizeConstantMax,this.startSizeConstantMinSeparate.cloneTo(t.startSizeConstantMinSeparate),this.startSizeConstantMaxSeparate.cloneTo(t.startSizeConstantMaxSeparate),t.threeDStartRotation=this.threeDStartRotation,t.startRotationType=this.startRotationType,t.startRotationConstant=this.startRotationConstant,this.startRotationConstantSeparate.cloneTo(t.startRotationConstantSeparate),t.startRotationConstantMin=this.startRotationConstantMin,t.startRotationConstantMax=this.startRotationConstantMax,this.startRotationConstantMinSeparate.cloneTo(t.startRotationConstantMinSeparate),this.startRotationConstantMaxSeparate.cloneTo(t.startRotationConstantMaxSeparate),t.randomizeRotationDirection=this.randomizeRotationDirection,t.startColorType=this.startColorType,this.startColorConstant.cloneTo(t.startColorConstant),this.startColorConstantMin.cloneTo(t.startColorConstantMin),this.startColorConstantMax.cloneTo(t.startColorConstantMax),t.gravityModifier=this.gravityModifier,t.simulationSpace=this.simulationSpace,t.scaleMode=this.scaleMode,t.playOnAwake=this.playOnAwake,t.maxParticles=this.maxParticles,this.emission&&(t.emission=this.emission.clone()),this.shape&&(t.shape=this.shape.clone()),this.velocityOverLifetime&&(t.velocityOverLifetime=this.velocityOverLifetime.clone()),this.colorOverLifetime&&(t.colorOverLifetime=this.colorOverLifetime.clone()),this.sizeOverLifetime&&(t.sizeOverLifetime=this.sizeOverLifetime.clone()),this.rotationOverLifetime&&(t.rotationOverLifetime=this.rotationOverLifetime.clone()),this.textureSheetAnimation&&(t.textureSheetAnimation=this.textureSheetAnimation.clone()),t.isPerformanceMode=this.isPerformanceMode,t._isEmitting=this._isEmitting,t._isPlaying=this._isPlaying,t._isPaused=this._isPaused,t._playStartDelay=this._playStartDelay,t._frameRateTime=this._frameRateTime,t._emissionTime=this._emissionTime,t._totalDelayTime=this._totalDelayTime,t._burstsIndex=this._burstsIndex},s.clone=function(){var e=new this.constructor;return this.cloneTo(e),e},s._renderRuntime=function(e,t,n){},a(0,s,"maxParticles",function(){return this._bufferMaxParticles-1},function(e){var t=e+1;t!==this._bufferMaxParticles&&(this._bufferMaxParticles=t,this._vertexBuffer&&(this._vertexBuffer.dispose(),this._indexBuffer.dispose()),this._initBufferDatas())}),a(0,s,"isEmitting",function(){return this._isEmitting}),a(0,s,"isAlive",function(){return!!(this._isPlaying||this.aliveParticleCount>0)}),a(0,s,"shape",function(){return this._shape},function(e){this._shape!==e&&(e&&e.enable?this._ownerRender._addShaderDefine(Hn.SHADERDEFINE_SHAPE):this._ownerRender._removeShaderDefine(Hn.SHADERDEFINE_SHAPE),this._shape=e,this._emission._shape=e)}),a(0,s,"rotationOverLifetime",function(){return this._rotationOverLifetime},function(e){var t=this._ownerRender;if(e){var n=e.angularVelocity;if(!n)return;var i=n.separateAxes,r=n.type;if(e.enbale)switch(i?t._addShaderDefine(Hn.SHADERDEFINE_ROTATIONOVERLIFETIMESEPERATE):t._addShaderDefine(Hn.SHADERDEFINE_ROTATIONOVERLIFETIME),r){case 0:t._addShaderDefine(Hn.SHADERDEFINE_ROTATIONOVERLIFETIMECONSTANT);break;case 1:t._addShaderDefine(Hn.SHADERDEFINE_ROTATIONOVERLIFETIMECURVE);break;case 2:t._addShaderDefine(Hn.SHADERDEFINE_ROTATIONOVERLIFETIMERANDOMCONSTANTS);break;case 3:t._addShaderDefine(Hn.SHADERDEFINE_ROTATIONOVERLIFETIMERANDOMCURVES)}else t._removeShaderDefine(Hn.SHADERDEFINE_ROTATIONOVERLIFETIME),t._removeShaderDefine(Hn.SHADERDEFINE_ROTATIONOVERLIFETIMESEPERATE),t._removeShaderDefine(Hn.SHADERDEFINE_ROTATIONOVERLIFETIMECONSTANT),t._removeShaderDefine(Hn.SHADERDEFINE_ROTATIONOVERLIFETIMECURVE),t._removeShaderDefine(Hn.SHADERDEFINE_ROTATIONOVERLIFETIMERANDOMCONSTANTS),t._removeShaderDefine(Hn.SHADERDEFINE_ROTATIONOVERLIFETIMERANDOMCURVES);switch(r){case 0:i?t._setShaderValueColor(35,n.constantSeparate):t._setShaderValueNumber(34,n.constant);break;case 1:i?(t._setShaderValueBuffer(37,n.gradientX._elements),t._setShaderValueBuffer(38,n.gradientY._elements),t._setShaderValueBuffer(39,n.gradientZ._elements),t._setShaderValueBuffer(40,n.gradientW._elements)):t._setShaderValueBuffer(36,n.gradient._elements);break;case 2:i?(t._setShaderValueColor(35,n.constantMinSeparate),t._setShaderValueColor(42,n.constantMaxSeparate)):(t._setShaderValueNumber(34,n.constantMin),t._setShaderValueNumber(41,n.constantMax));break;case 3:i?(t._setShaderValueBuffer(37,n.gradientXMin._elements),t._setShaderValueBuffer(44,n.gradientXMax._elements),t._setShaderValueBuffer(38,n.gradientYMin._elements),t._setShaderValueBuffer(45,n.gradientYMax._elements),t._setShaderValueBuffer(39,n.gradientZMin._elements),t._setShaderValueBuffer(46,n.gradientZMax._elements),t._setShaderValueBuffer(40,n.gradientWMin._elements),t._setShaderValueBuffer(47,n.gradientWMax._elements)):(t._setShaderValueBuffer(36,n.gradientMin._elements),t._setShaderValueBuffer(43,n.gradientMax._elements))}}else t._removeShaderDefine(Hn.SHADERDEFINE_ROTATIONOVERLIFETIME),t._removeShaderDefine(Hn.SHADERDEFINE_ROTATIONOVERLIFETIMESEPERATE),t._removeShaderDefine(Hn.SHADERDEFINE_ROTATIONOVERLIFETIMECONSTANT),t._removeShaderDefine(Hn.SHADERDEFINE_ROTATIONOVERLIFETIMECURVE),t._removeShaderDefine(Hn.SHADERDEFINE_ROTATIONOVERLIFETIMERANDOMCONSTANTS),t._removeShaderDefine(Hn.SHADERDEFINE_ROTATIONOVERLIFETIMERANDOMCURVES),t._setShaderValueColor(35,null),t._setShaderValueColor(42,null),t._setShaderValueNumber(34,void 0),t._setShaderValueNumber(41,void 0),t._setShaderValueBuffer(37,null),t._setShaderValueBuffer(44,null),t._setShaderValueBuffer(38,null),t._setShaderValueBuffer(45,null),t._setShaderValueBuffer(39,null),t._setShaderValueBuffer(46,null),t._setShaderValueBuffer(40,null),t._setShaderValueBuffer(47,null),t._setShaderValueBuffer(36,null),t._setShaderValueBuffer(43,null);this._rotationOverLifetime=e}),a(0,s,"emission",function(){return this._emission},function(e){this._emission=e,e._particleSystem=this,e._shape=this._shape}),a(0,s,"emissionTime",function(){return this._emissionTime>this.duration?this.duration:this._emissionTime}),a(0,s,"aliveParticleCount",function(){return this._firstNewElement>=this._firstRetiredElement?this._firstNewElement-this._firstRetiredElement:this._bufferMaxParticles-this._firstRetiredElement+this._firstNewElement}),a(0,s,"isPlaying",function(){return this._isPlaying}),a(0,s,"isPaused",function(){return this._isPaused}),a(0,s,"startLifetimeType",function(){return this._startLifetimeType},function(e){var t=0,n=0;switch(this.startLifetimeType){case 0:this._maxStartLifetime=this.startLifetimeConstant;break;case 1:this._maxStartLifetime=-Number.MAX_VALUE;var i=i;for(t=0,n=i.gradientCount;t<n;t++)this._maxStartLifetime=Math.max(this._maxStartLifetime,i.getValueByIndex(t));break;case 2:this._maxStartLifetime=Math.max(this.startLifetimeConstantMin,this.startLifetimeConstantMax);break;case 3:this._maxStartLifetime=-Number.MAX_VALUE;var r=r;for(t=0,n=r.gradientCount;t<n;t++)this._maxStartLifetime=Math.max(this._maxStartLifetime,r.getValueByIndex(t));var a=a;for(t=0,n=a.gradientCount;t<n;t++)this._maxStartLifetime=Math.max(this._maxStartLifetime,a.getValueByIndex(t))}this._startLifetimeType=e}),a(0,s,"_originalBoundingSphere",function(){return this._boundingSphere}),a(0,s,"startLifetimeConstant",function(){return this._startLifetimeConstant},function(e){0===this._startLifetimeType&&(this._maxStartLifetime=e),this._startLifetimeConstant=e}),a(0,s,"startLifetimeConstantMin",function(){return this._startLifetimeConstantMin},function(e){2===this._startLifetimeType&&(this._maxStartLifetime=Math.max(e,this._startLifetimeConstantMax)),this._startLifetimeConstantMin=e}),a(0,s,"startLifeTimeGradient",function(){return this._startLifeTimeGradient},function(e){if(1===this._startLifetimeType){this._maxStartLifetime=-Number.MAX_VALUE;for(var t=0,n=e.gradientCount;t<n;t++)this._maxStartLifetime=Math.max(this._maxStartLifetime,e.getValueByIndex(t))}this._startLifeTimeGradient=e}),a(0,s,"startLifetimeConstantMax",function(){return this._startLifetimeConstantMax},function(e){2===this._startLifetimeType&&(this._maxStartLifetime=Math.max(this._startLifetimeConstantMin,e)),this._startLifetimeConstantMax=e}),a(0,s,"startLifeTimeGradientMin",function(){return this._startLifeTimeGradientMin},function(e){if(3===this._startLifetimeType){var t=0,n=0;for(this._maxStartLifetime=-Number.MAX_VALUE,t=0,n=e.gradientCount;t<n;t++)this._maxStartLifetime=Math.max(this._maxStartLifetime,e.getValueByIndex(t));for(t=0,n=this._startLifeTimeGradientMax.gradientCount;t<n;t++)this._maxStartLifetime=Math.max(this._maxStartLifetime,this._startLifeTimeGradientMax.getValueByIndex(t))}this._startLifeTimeGradientMin=e}),a(0,s,"startLifeTimeGradientMax",function(){return this._startLifeTimeGradientMax},function(e){if(3===this._startLifetimeType){var t=0,n=0;for(this._maxStartLifetime=-Number.MAX_VALUE,t=0,n=this._startLifeTimeGradientMin.gradientCount;t<n;t++)this._maxStartLifetime=Math.max(this._maxStartLifetime,this._startLifeTimeGradientMin.getValueByIndex(t));for(t=0,n=e.gradientCount;t<n;t++)this._maxStartLifetime=Math.max(this._maxStartLifetime,e.getValueByIndex(t))}this._startLifeTimeGradientMax=e}),a(0,s,"velocityOverLifetime",function(){return this._velocityOverLifetime},function(e){var t=this._ownerRender;if(e){var n=e.velocity,i=n.type;if(e.enbale)switch(i){case 0:t._addShaderDefine(Hn.SHADERDEFINE_VELOCITYOVERLIFETIMECONSTANT);break;case 1:t._addShaderDefine(Hn.SHADERDEFINE_VELOCITYOVERLIFETIMECURVE);break;case 2:t._addShaderDefine(Hn.SHADERDEFINE_VELOCITYOVERLIFETIMERANDOMCONSTANT);break;case 3:t._addShaderDefine(Hn.SHADERDEFINE_VELOCITYOVERLIFETIMERANDOMCURVE)}else t._removeShaderDefine(Hn.SHADERDEFINE_VELOCITYOVERLIFETIMECONSTANT),t._removeShaderDefine(Hn.SHADERDEFINE_VELOCITYOVERLIFETIMECURVE),t._removeShaderDefine(Hn.SHADERDEFINE_VELOCITYOVERLIFETIMERANDOMCONSTANT),t._removeShaderDefine(Hn.SHADERDEFINE_VELOCITYOVERLIFETIMERANDOMCURVE);switch(i){case 0:t._setShaderValueColor(13,n.constant);break;case 1:t._setShaderValueBuffer(14,n.gradientX._elements),t._setShaderValueBuffer(15,n.gradientY._elements),t._setShaderValueBuffer(16,n.gradientZ._elements);break;case 2:t._setShaderValueColor(13,n.constantMin),t._setShaderValueColor(17,n.constantMax);break;case 3:t._setShaderValueBuffer(14,n.gradientXMin._elements),t._setShaderValueBuffer(18,n.gradientXMax._elements),t._setShaderValueBuffer(15,n.gradientYMin._elements),t._setShaderValueBuffer(19,n.gradientYMax._elements),t._setShaderValueBuffer(16,n.gradientZMin._elements),t._setShaderValueBuffer(20,n.gradientZMax._elements)}t._setShaderValueInt(21,e.space)}else t._removeShaderDefine(Hn.SHADERDEFINE_VELOCITYOVERLIFETIMECONSTANT),t._removeShaderDefine(Hn.SHADERDEFINE_VELOCITYOVERLIFETIMECURVE),t._removeShaderDefine(Hn.SHADERDEFINE_VELOCITYOVERLIFETIMERANDOMCONSTANT),t._removeShaderDefine(Hn.SHADERDEFINE_VELOCITYOVERLIFETIMERANDOMCURVE),t._setShaderValueColor(13,null),t._setShaderValueBuffer(14,null),t._setShaderValueBuffer(15,null),t._setShaderValueBuffer(16,null),t._setShaderValueColor(13,null),t._setShaderValueColor(17,null),t._setShaderValueBuffer(14,null),t._setShaderValueBuffer(18,null),t._setShaderValueBuffer(15,null),t._setShaderValueBuffer(19,null),t._setShaderValueBuffer(16,null),t._setShaderValueBuffer(20,null),t._setShaderValueInt(21,void 0);this._velocityOverLifetime=e}),a(0,s,"colorOverLifetime",function(){return this._colorOverLifetime},function(e){var t=this._ownerRender;if(e){var n=e.color;if(e.enbale)switch(n.type){case 1:t._addShaderDefine(Hn.SHADERDEFINE_COLOROVERLIFETIME);break;case 3:t._addShaderDefine(Hn.SHADERDEFINE_RANDOMCOLOROVERLIFETIME)}else t._removeShaderDefine(Hn.SHADERDEFINE_COLOROVERLIFETIME),t._removeShaderDefine(Hn.SHADERDEFINE_RANDOMCOLOROVERLIFETIME);switch(n.type){case 1:var i=n.gradient;t._setShaderValueBuffer(22,i._alphaElements),t._setShaderValueBuffer(23,i._rgbElements);break;case 3:var r=n.gradientMin,a=n.gradientMax;t._setShaderValueBuffer(22,r._alphaElements),t._setShaderValueBuffer(23,r._rgbElements),t._setShaderValueBuffer(24,a._alphaElements),t._setShaderValueBuffer(25,a._rgbElements)}}else t._removeShaderDefine(Hn.SHADERDEFINE_COLOROVERLIFETIME),t._removeShaderDefine(Hn.SHADERDEFINE_RANDOMCOLOROVERLIFETIME),t._setShaderValueBuffer(22,i._alphaElements),t._setShaderValueBuffer(23,i._rgbElements),t._setShaderValueBuffer(22,r._alphaElements),t._setShaderValueBuffer(23,r._rgbElements),t._setShaderValueBuffer(24,a._alphaElements),t._setShaderValueBuffer(25,a._rgbElements);this._colorOverLifetime=e}),a(0,s,"sizeOverLifetime",function(){return this._sizeOverLifetime},function(e){var t=this._ownerRender;if(e){var n=e.size,i=n.separateAxes,r=n.type;if(e.enbale)switch(r){case 0:i?t._addShaderDefine(Hn.SHADERDEFINE_SIZEOVERLIFETIMECURVESEPERATE):t._addShaderDefine(Hn.SHADERDEFINE_SIZEOVERLIFETIMECURVE);break;case 2:i?t._addShaderDefine(Hn.SHADERDEFINE_SIZEOVERLIFETIMERANDOMCURVESSEPERATE):t._addShaderDefine(Hn.SHADERDEFINE_SIZEOVERLIFETIMERANDOMCURVES)}else t._removeShaderDefine(Hn.SHADERDEFINE_SIZEOVERLIFETIMECURVE),t._removeShaderDefine(Hn.SHADERDEFINE_SIZEOVERLIFETIMECURVESEPERATE),t._removeShaderDefine(Hn.SHADERDEFINE_SIZEOVERLIFETIMERANDOMCURVES),t._removeShaderDefine(Hn.SHADERDEFINE_SIZEOVERLIFETIMERANDOMCURVESSEPERATE);switch(r){case 0:i?(t._setShaderValueBuffer(27,n.gradientX._elements),t._setShaderValueBuffer(28,n.gradientY._elements),t._setShaderValueBuffer(29,n.gradientZ._elements)):t._setShaderValueBuffer(26,n.gradient._elements);break;case 2:i?(t._setShaderValueBuffer(27,n.gradientXMin._elements),t._setShaderValueBuffer(31,n.gradientXMax._elements),t._setShaderValueBuffer(28,n.gradientYMin._elements),t._setShaderValueBuffer(32,n.gradientYMax._elements),t._setShaderValueBuffer(29,n.gradientZMin._elements),t._setShaderValueBuffer(33,n.gradientZMax._elements)):(t._setShaderValueBuffer(26,n.gradientMin._elements),t._setShaderValueBuffer(30,n.gradientMax._elements))}}else t._removeShaderDefine(Hn.SHADERDEFINE_SIZEOVERLIFETIMECURVE),t._removeShaderDefine(Hn.SHADERDEFINE_SIZEOVERLIFETIMECURVESEPERATE),t._removeShaderDefine(Hn.SHADERDEFINE_SIZEOVERLIFETIMERANDOMCURVES),t._removeShaderDefine(Hn.SHADERDEFINE_SIZEOVERLIFETIMERANDOMCURVESSEPERATE),t._setShaderValueBuffer(27,null),t._setShaderValueBuffer(31,null),t._setShaderValueBuffer(28,null),t._setShaderValueBuffer(32,null),t._setShaderValueBuffer(29,null),t._setShaderValueBuffer(33,null),t._setShaderValueBuffer(26,null),t._setShaderValueBuffer(30,null);this._sizeOverLifetime=e}),a(0,s,"textureSheetAnimation",function(){return this._textureSheetAnimation},function(e){var t=this._ownerRender;if(e){var n=e.frame,i=n.type;if(e.enable)switch(i){case 1:t._addShaderDefine(Hn.SHADERDEFINE_TEXTURESHEETANIMATIONCURVE)}else t._removeShaderDefine(Hn.SHADERDEFINE_TEXTURESHEETANIMATIONCURVE),t._removeShaderDefine(Hn.SHADERDEFINE_TEXTURESHEETANIMATIONRANDOMCURVE);if(1===i||3===i){t._setShaderValueInt(48,e.cycles);var r=e.tiles,a=this._uvLength.elements;a[0]=1/r.x,a[1]=1/r.y,t._setShaderValueVector2(49,this._uvLength)}switch(i){case 1:t._setShaderValueBuffer(50,n.frameOverTimeData._elements);break;case 3:t._setShaderValueBuffer(50,n.frameOverTimeDataMin._elements),t._setShaderValueBuffer(51,n.frameOverTimeDataMax._elements)}}else t._removeShaderDefine(Hn.SHADERDEFINE_TEXTURESHEETANIMATIONCURVE),t._removeShaderDefine(Hn.SHADERDEFINE_TEXTURESHEETANIMATIONRANDOMCURVE),t._setShaderValueInt(48,void 0),t._setShaderValueVector2(49,null),t._setShaderValueBuffer(50,null),t._setShaderValueBuffer(51,null);this._textureSheetAnimation=e}),a(0,s,"_vertexBufferCount",function(){return 1}),a(0,s,"triangleCount",function(){return this._indexBuffer.indexCount/3}),a(0,s,"_originalBoundingBox",function(){return this._boundingBox}),a(0,s,"_originalBoundingBoxCorners",function(){return this._boundingBoxCorners}),t.halfKSqrtOf2=.71,i(t,["_RANDOMOFFSET",function(){return this._RANDOMOFFSET=new Uint32Array([592910910,3276756734,322376503,306581307,1793934638,3737431713,2527743459,2368504881,4085612399,3774601268,326370691,1494990940,1089181156,3159510623,2941263940,2786374529,271901988,4233252447])},"_maxElapsedTime",function(){return this._maxElapsedTime=1/3},"_tempVector30",function(){return this._tempVector30=new ct},"_tempVector31",function(){return this._tempVector31=new ct},"_tempVector32",function(){return this._tempVector32=new ct},"_tempVector33",function(){return this._tempVector33=new ct},"_tempVector34",function(){return this._tempVector34=new ct},"_tempVector35",function(){return this._tempVector35=new ct},"_tempVector36",function(){return this._tempVector36=new ct},"_tempVector37",function(){return this._tempVector37=new ct},"_tempVector38",function(){return this._tempVector38=new ct},"_tempVector39",function(){return this._tempVector39=new ct},"_tempPosition",function(){return this._tempPosition=new ct},"_tempDirection",function(){return this._tempDirection=new ct}]),t}(Nt),sn=function(e){function t(e){this._finalGravity=new ct,this._tempRotationMatrix=new at,t.__super.call(this,e),this._defaultBoundBox=new Je(new ct,new ct),this._renderMode=-1,this.stretchedBillboardCameraSpeedScale=0,this.stretchedBillboardSpeedScale=0,this.stretchedBillboardLengthScale=1}r(t,"laya.d3.core.particleShuriKen.ShurikenParticleRender",Ot);var n=t.prototype;return n._calculateBoundingBox=function(){var e=this._boundingBox.min.elements;e[0]=-Number.MAX_VALUE,e[1]=-Number.MAX_VALUE,e[2]=-Number.MAX_VALUE;var t=this._boundingBox.min.elements;t[0]=Number.MAX_VALUE,t[1]=Number.MAX_VALUE,t[2]=Number.MAX_VALUE},n._calculateBoundingSphere=function(){var e=this._boundingSphere.center.elements;e[0]=0,e[1]=0,e[2]=0,this._boundingSphere.radius=Number.MAX_VALUE},n._renderUpdate=function(e){var t=this._owner.particleSystem,n=this._owner.transform;switch(t.simulationSpace){case 0:break;case 1:this._setShaderValueColor(0,n.position),this._setShaderValueColor(1,n.rotation);break;default:throw new Error("ShurikenParticleMaterial: SimulationSpace value is invalid.")}switch(t.scaleMode){case 0:var i=n.scale;this._setShaderValueColor(4,i),this._setShaderValueColor(5,i);break;case 1:var r=n.localScale;this._setShaderValueColor(4,r),this._setShaderValueColor(5,r);break;case 2:this._setShaderValueColor(4,n.scale),this._setShaderValueColor(5,ct.ONE)}var a=this._finalGravity.elements,s=Mt.gravity.elements,o=t.gravityModifier;a[0]=s[0]*o,a[1]=s[1]*o,a[2]=s[2]*o,this._setShaderValueBuffer(7,a),this._setShaderValueInt(11,t.simulationSpace),this._setShaderValueBool(8,t.threeDStartRotation),this._setShaderValueInt(6,t.scaleMode),this._setShaderValueInt(9,this.stretchedBillboardLengthScale),this._setShaderValueInt(10,this.stretchedBillboardSpeedScale),this._setShaderValueNumber(12,t._currentTime),It.debugMode&&this._renderRenderableBoundBox()},a(0,n,"boundingBox",function(){return this._owner.particleSystem.isAlive?(this._boundingBoxNeedChange&&(this._calculateBoundingBox(),this._boundingBoxNeedChange=!1),this._boundingBox):this._defaultBoundBox}),a(0,n,"renderMode",function(){return this._renderMode},function(e){if(this._renderMode!==e){switch(this._renderMode){case 0:this._removeShaderDefine(Hn.SHADERDEFINE_RENDERMODE_BILLBOARD);break;case 1:this._removeShaderDefine(Hn.SHADERDEFINE_RENDERMODE_STRETCHEDBILLBOARD);break;case 2:this._removeShaderDefine(Hn.SHADERDEFINE_RENDERMODE_HORIZONTALBILLBOARD);break;case 3:this._removeShaderDefine(Hn.SHADERDEFINE_RENDERMODE_VERTICALBILLBOARD);break;case 4:this._removeShaderDefine(Hn.SHADERDEFINE_RENDERMODE_MESH)}switch(this._renderMode=e,e){case 0:this._addShaderDefine(Hn.SHADERDEFINE_RENDERMODE_BILLBOARD);break;case 1:this._addShaderDefine(Hn.SHADERDEFINE_RENDERMODE_STRETCHEDBILLBOARD);break;case 2:this._addShaderDefine(Hn.SHADERDEFINE_RENDERMODE_HORIZONTALBILLBOARD);break;case 3:this._addShaderDefine(Hn.SHADERDEFINE_RENDERMODE_VERTICALBILLBOARD);break;case 4:this._addShaderDefine(Hn.SHADERDEFINE_RENDERMODE_MESH);break;default:throw new Error("ShurikenParticleRender: unknown renderMode Value.")}this._owner.particleSystem._initBufferDatas()}}),a(0,n,"mesh",function(){return this._mesh},function(e){this._mesh!==e&&(this._mesh=e,this._owner.particleSystem._initBufferDatas())}),t}(),on=function(e){function t(e){this._floatCountPerVertex=6,this._owner=null,this._vertices=null,this._vertexBuffer=null,this._firstActiveElement=0,this._firstNewElement=0,this._firstFreeElement=0,this._firstRetiredElement=0,this._currentTime=NaN,this._drawCounter=0,this.scLeft=null,this.scRight=null,this._numPositionMode=0,this._numPositionVelocityMode=0,this._lastTime=NaN,this._needPatch=!1,this._lastPatchAddPos0=null,this._lastPatchAddPos1=null,this._lastPatchAddTime=NaN,this.lifeTime=NaN,this.minSegmentDistance=NaN,this.minInterpDistance=NaN,this.maxSlerpCount=0,this._maxSegments=0,t.__super.call(this),this._tempVector0=new ct,this._tempVector1=new ct,this._tempVector2=new ct,this._tempVector3=new ct,this._posModeLastPosition0=new ct,this._posModeLastPosition1=new ct,this._posModePosition0=new ct,this._posModePosition1=new ct,this._posVelModePosition0=new ct,this._posVelModeVelocity0=new ct,this._posVelModePosition1=new ct,this._posVelModeVelocity1=new ct,this._owner=e,this._lastTime=0,this._firstActiveElement=0,this._firstNewElement=0,this._firstFreeElement=0,this._firstRetiredElement=0,this._currentTime=0,this._drawCounter=0,this._needPatch=!1,this._lastPatchAddPos0=new ct,this._lastPatchAddPos1=new ct,this.scLeft=new B,this.scRight=new B,this.lifeTime=.5,this.minSegmentDistance=.1,this.minInterpDistance=.6,this.maxSlerpCount=128,this._maxSegments=200,this._owner.on("activeinhierarchychanged",this,this._onActiveHierarchyChanged)}r(t,"laya.d3.resource.tempelet.GlitterTemplet",e);var i=t.prototype;return n.imps(i,{"laya.d3.core.render.IRenderable":!0}),i._getVertexBuffer=function(e){return void 0===e&&(e=0),0===e?this._vertexBuffer:null},i._getIndexBuffer=function(){return null},i._initialize=function(){this._vertexBuffer=En.create(ge.vertexDeclaration,2*this.maxSegments,35048),this._vertices=new Float32Array(this.maxSegments*this._floatCountPerVertex*2)},i._onActiveHierarchyChanged=function(e){e||(this._numPositionMode=0,this._numPositionVelocityMode=0,this._firstActiveElement=0,this._firstNewElement=0,this._firstFreeElement=0,this._firstRetiredElement=0,this._currentTime=0,this._drawCounter=0)},i._updateTextureCoordinates=function(){this._firstActiveElement<this._firstFreeElement?this._updateSubTextureCoordinates(this._firstActiveElement,2*(this._firstFreeElement-this._firstActiveElement)):(this._updateSubTextureCoordinates(this._firstActiveElement,2*(this.maxSegments-this._firstActiveElement)),this._firstFreeElement>0&&this._updateSubTextureCoordinates(0,2*this._firstFreeElement))},i._updateSubTextureCoordinates=function(e,t){for(var n=2*e,i=0;i<t;i+=2){var r=n+i,a=r*this._floatCountPerVertex,s=(r+1)*this._floatCountPerVertex;this._vertices[a+3]=this._vertices[s+3]=(this._vertices[a+5]-this._currentTime)/this.lifeTime}},i._retireActiveGlitter=function(){for(var e=this.lifeTime,t=2*this._floatCountPerVertex;this._firstActiveElement!=this._firstNewElement;){var n=this._firstActiveElement*t+5;if(this._currentTime-this._vertices[n]<e)break;this._vertices[n]=this._drawCounter,this._firstActiveElement++,this._firstActiveElement>=this.maxSegments&&(this._firstActiveElement=0)}},i._freeRetiredGlitter=function(){for(var e=2*this._floatCountPerVertex;this._firstRetiredElement!=this._firstActiveElement&&!(this._drawCounter-this._vertices[this._firstRetiredElement*e+5]<3);)this._firstRetiredElement++,this._firstRetiredElement>=this.maxSegments&&(this._firstRetiredElement=0)},i._calcVelocity=function(e,t,n){ct.subtract(e,t,n),ct.scale(n,.5,n)},i._addNewGlitterSegementToVertexBuffer=function(){var e=0;this._firstActiveElement<this._firstFreeElement?(e=2*this._firstActiveElement*this._floatCountPerVertex,this._vertexBuffer.setData(this._vertices,e,e,2*(this._firstFreeElement-this._firstActiveElement)*this._floatCountPerVertex)):(e=2*this._firstActiveElement*this._floatCountPerVertex,this._vertexBuffer.setData(this._vertices,e,e,2*(this.maxSegments-this._firstActiveElement)*this._floatCountPerVertex),this._firstFreeElement>0&&this._vertexBuffer.setData(this._vertices,0,0,2*this._firstFreeElement*this._floatCountPerVertex)),this._firstNewElement=this._firstFreeElement},i._addGlitter=function(e,t,n){this._needPatch&&(this._needPatch=!1,this._addGlitter(this._lastPatchAddPos0,this._lastPatchAddPos1,this._lastPatchAddTime));var i=this._firstFreeElement+1;if(i>=this.maxSegments&&(i=0,e.cloneTo(this._lastPatchAddPos0),t.cloneTo(this._lastPatchAddPos1),this._lastPatchAddTime=n,this._needPatch=!0),i===this._firstRetiredElement)throw new Error("GlitterTemplet:current segement count have large than maxSegments,please adjust the  value of maxSegments or add Glitter Vertex Frequency.");var r=e.elements,a=t.elements,s=0,o=this._firstFreeElement*this._floatCountPerVertex*2;for(s=0;s<3;s++)this._vertices[o+s]=r[s];this._vertices[o+3]=0,this._vertices[o+4]=0,this._vertices[o+5]=n;var l=o+this._floatCountPerVertex;for(s=0;s<3;s++)this._vertices[l+s]=a[s];this._vertices[l+3]=0,this._vertices[l+4]=1,this._vertices[l+5]=n,this._firstFreeElement=i},i._update=function(e){this._currentTime+=e/1e3,this._retireActiveGlitter(),this._freeRetiredGlitter(),this._firstActiveElement==this._firstFreeElement&&(this._currentTime=0),this._firstRetiredElement==this._firstActiveElement&&(this._drawCounter=0),this._updateTextureCoordinates()},i._beforeRender=function(e){return this._firstNewElement!=this._firstFreeElement&&this._addNewGlitterSegementToVertexBuffer(),this._drawCounter++,this._firstActiveElement!=this._firstFreeElement&&(this._vertexBuffer.bindWithIndexBuffer(null),!0)},i._render=function(e){var t=0,n=N.mainContext;this._firstActiveElement<this._firstFreeElement?(t=2*(this._firstFreeElement-this._firstActiveElement),n.drawArrays(5,2*this._firstActiveElement,t),C.trianglesFaces+=t-2,C.drawCall++):(t=2*(this.maxSegments-this._firstActiveElement),n.drawArrays(5,2*this._firstActiveElement,t),C.trianglesFaces+=t-2,C.drawCall++,this._firstFreeElement>0&&(t=2*this._firstFreeElement,n.drawArrays(5,0,t),C.trianglesFaces+=t-2,C.drawCall++))},i.addVertexPosition=function(e,t){if(this._owner.activeInHierarchy)if(this._numPositionMode<2)0===this._numPositionMode?(e.cloneTo(this._posModeLastPosition0),t.cloneTo(this._posModeLastPosition1)):(e.cloneTo(this._posModePosition0),t.cloneTo(this._posModePosition1)),this._numPositionMode++;else{var n=this._tempVector2;this._calcVelocity(e,this._posModeLastPosition0,n);var i=this._tempVector3;this._calcVelocity(t,this._posModeLastPosition1,i),this.addVertexPositionVelocity(this._posModePosition0,n,this._posModePosition1,i),this._posModePosition0.cloneTo(this._posModeLastPosition0),this._posModePosition1.cloneTo(this._posModeLastPosition1),e.cloneTo(this._posModePosition0),t.cloneTo(this._posModePosition1)}},i.addVertexPositionVelocity=function(e,t,n,i){if(this._owner.activeInHierarchy){if(0===this._numPositionVelocityMode)this._numPositionVelocityMode++;else{var r=this._tempVector0;ct.subtract(e,this._posVelModePosition0,r);var a=ct.scalarLength(r);ct.subtract(n,this._posVelModePosition1,r);var s=ct.scalarLength(r),o=0,l=l;if(a<l&&s<l)return;if(1===(o=1+Math.floor(Math.max(a,s)/this.minInterpDistance)))this._addGlitter(e,n,this._currentTime);else{o=Math.min(o,this.maxSlerpCount),this.scLeft.Init(this._posVelModePosition0,this._posVelModeVelocity0,e,t),this.scRight.Init(this._posVelModePosition1,this._posVelModeVelocity1,n,i);for(var h=1/o,_=h,u=this._currentTime-this._lastTime,c=1;c<=o;c++){var d=this._tempVector0;this.scLeft.Slerp(_,d);var f=this._tempVector1;this.scRight.Slerp(_,f);var m=this._lastTime+u*c/o;this._addGlitter(d,f,m),_+=h}}}this._lastTime=this._currentTime,e.cloneTo(this._posVelModePosition0),t.cloneTo(this._posVelModeVelocity0),n.cloneTo(this._posVelModePosition1),i.cloneTo(this._posVelModeVelocity1)}},i._destroy=function(){e.prototype._destroy.call(this),this._tempVector0=null,this._tempVector1=null,this._tempVector2=null,this._tempVector3=null,this._owner=null,this._vertices=null,this._vertexBuffer.dispose(),this._vertexBuffer=null,this.scLeft=null,this.scRight=null,this._posModeLastPosition0=null,this._posModeLastPosition1=null,this._posModePosition0=null,this._posModePosition1=null,this._posVelModePosition0=null,this._posVelModeVelocity0=null,this._posVelModePosition1=null,this._posVelModeVelocity1=null,this._lastPatchAddPos0=null,this._lastPatchAddPos1=null},i._renderRuntime=function(e,t,n){},a(0,i,"maxSegments",function(){return this._maxSegments-1},function(e){var t=e+1;t!==this._maxSegments&&(this._maxSegments=t,this._vertexBuffer&&this._vertexBuffer.dispose(),this._initialize())}),a(0,i,"_vertexBufferCount",function(){return 1}),a(0,i,"triangleCount",function(){var e=0;return this._firstActiveElement<this._firstFreeElement?e=2*(this._firstFreeElement-this._firstActiveElement)-2:(e=2*(this.maxSegments-this._firstActiveElement)-2,e+=2*this._firstFreeElement-2),e}),a(0,i,"_originalBoundingSphere",function(){return e.prototype._$get__originalBoundingSphere.call(this)}),a(0,i,"_originalBoundingBox",function(){return e.prototype._$get__originalBoundingBox.call(this)}),t}(Nt),ln=function(e){function t(e,n,i,r,a,o,l,h){this._owner=null,this._gridSize=NaN,this.memorySize=0,this._numberVertices=0,this._maxNumberIndices=0,this._currentNumberIndices=0,this._numberTriangle=0,this._vertexBuffer=null,this._indexBuffer=null,this._boundingSphere=null,this._boundingBox=null,this._indexArrayBuffer=null,this._boundingBoxCorners=null,this._leafs=null,this._leafNum=0,this._terrainHeightData=null,this._terrainHeightDataWidth=0,this._terrainHeightDataHeight=0,this._chunkOffsetX=0,this._chunkOffsetZ=0,this._cameraCoordinateInverse=!1,this._cameraPos=null,this._currentLOD=0,this._perspectiveFactor=NaN,this._LODTolerance=0,t.__super.call(this),this._owner=e,this._cameraPos=new ct,this._chunkOffsetX=n,this._chunkOffsetZ=i,this._gridSize=r,this._terrainHeightData=a,this._terrainHeightDataWidth=o,this._terrainHeightDataHeight=l,this._leafNum=Et.CHUNK_GRID_NUM/Et.LEAF_GRID_NUM*(Et.CHUNK_GRID_NUM/Et.LEAF_GRID_NUM),this._leafs=s(this._leafNum),this._cameraCoordinateInverse=h;for(var _=0;_<this._leafNum;_++)this._leafs[_]=new Et;this.recreateResource()}r(t,"laya.d3.terrain.TerrainFilter",e);var o=t.prototype;return n.imps(o,{"laya.d3.core.render.IRenderable":!0}),o._destroy=function(){e.prototype._destroy.call(this),this._owner=null,this._vertexBuffer&&this._vertexBuffer.dispose(),this._indexBuffer&&this._indexBuffer.dispose()},o.recreateResource=function(){this._currentNumberIndices=0,this._numberTriangle=0;var e=Et.LEAF_VERTEXT_COUNT,t=Et.LEAF_MAX_INDEX_COUNT;this._numberVertices=e*this._leafNum,this._maxNumberIndices=t*this._leafNum,this._indexArrayBuffer=new Uint16Array(this._maxNumberIndices);var n=Xe.vertexDeclaration,i=n.vertexStride/4,r=new Float32Array(this._numberVertices*i),a=Et.CHUNK_GRID_NUM/Et.LEAF_GRID_NUM,s=0,o=0,l=0;for(s=0;s<this._leafNum;s++)o=s%a,l=Math.floor(s/a),this._leafs[s].calcVertextBuffer(this._chunkOffsetX,this._chunkOffsetZ,o*Et.LEAF_GRID_NUM,l*Et.LEAF_GRID_NUM,this._gridSize,r,s*Et.LEAF_PLANE_VERTEXT_COUNT,i,this._terrainHeightData,this._terrainHeightDataWidth,this._terrainHeightDataHeight,this._cameraCoordinateInverse);for(s=0;s<this._leafNum;s++)o=s%a,l=Math.floor(s/a),this._leafs[s].calcSkirtVertextBuffer(this._chunkOffsetX,this._chunkOffsetZ,o*Et.LEAF_GRID_NUM,l*Et.LEAF_GRID_NUM,this._gridSize,r,this._leafNum*Et.LEAF_PLANE_VERTEXT_COUNT+s*Et.LEAF_SKIRT_VERTEXT_COUNT,i,this._terrainHeightData,this._terrainHeightDataWidth,this._terrainHeightDataHeight);this.assembleIndexInit(),this._vertexBuffer=new En(n,this._numberVertices,35044,!1),this._indexBuffer=new xn("ushort",this._maxNumberIndices,35044,!1),this._vertexBuffer.setData(r),this._indexBuffer.setData(this._indexArrayBuffer),this.memorySize=2*(this._vertexBuffer._byteLength+this._indexBuffer._byteLength),this.calcOriginalBoudingBoxAndSphere()},o.setLODLevel=function(e){if(4!=e.length)return!0;var t=(e[0]+1<<24)+(e[1]+1<<16)+(e[2]+1<<8)+(e[3]+1);return this._currentLOD!=t&&(this._currentLOD=t,!0)},o.assembleIndexInit=function(){this._currentNumberIndices=0,this._numberTriangle=0;for(var e=0,t=0;t<this._leafNum;t++){var n=Et.getPlaneLODIndex(t,0);this._indexArrayBuffer.set(n,e),e+=n.length;var i=Et.getSkirtLODIndex(t,0);this._indexArrayBuffer.set(i,e),e+=i.length,this._currentNumberIndices+=n.length+i.length}this._numberTriangle=this._currentNumberIndices/3},o.isNeedAssemble=function(e,t){var n=Math.min(e.viewport.width,e.viewport.height)/(2*Math.tan(Math.PI*e.fieldOfView/180));return this._perspectiveFactor!=n?(this._perspectiveFactor=n,1):this._LODTolerance!=Ln.LOD_TOLERANCE_VALUE?(this._LODTolerance=Ln.LOD_TOLERANCE_VALUE,1):0==ct.equals(t,this._cameraPos)?(this._cameraPos.x=t.x,this._cameraPos.y=t.y,this._cameraPos.z=t.z,2):0},o.assembleIndex=function(e,n){var i=this.isNeedAssemble(e,n);if(i>0){for(var r=0;r<this._leafNum;r++)t._TEMP_ARRAY_BUFFER[r]=this._leafs[r].determineLod(n,this._perspectiveFactor,Ln.LOD_TOLERANCE_VALUE,1==i);if(this.setLODLevel(t._TEMP_ARRAY_BUFFER)){this._currentNumberIndices=0,this._numberTriangle=0;var a=0;for(r=0;r<this._leafNum;r++){var s=t._TEMP_ARRAY_BUFFER[r],o=Et.getPlaneLODIndex(r,s);this._indexArrayBuffer.set(o,a),a+=o.length;var l=Et.getSkirtLODIndex(r,s);this._indexArrayBuffer.set(l,a),a+=l.length,this._currentNumberIndices+=o.length+l.length}return this._numberTriangle=this._currentNumberIndices/3,!0}}return!1},o.calcOriginalBoudingBoxAndSphere=function(){for(var e=new ut(2147483647,-2147483647),t=0;t<this._leafNum;t++)e.x=this._leafs[t]._sizeOfY.x<e.x?this._leafs[t]._sizeOfY.x:e.x,e.y=this._leafs[t]._sizeOfY.y>e.y?this._leafs[t]._sizeOfY.y:e.y;var n=new ct(this._chunkOffsetX*Et.CHUNK_GRID_NUM*this._gridSize,e.x,this._chunkOffsetZ*Et.CHUNK_GRID_NUM*this._gridSize),i=new ct((this._chunkOffsetX+1)*Et.CHUNK_GRID_NUM*this._gridSize,e.y,(this._chunkOffsetZ+1)*Et.CHUNK_GRID_NUM*this._gridSize);Et.__ADAPT_MATRIX__&&(ct.transformV3ToV3(n,Et.__ADAPT_MATRIX__,n),ct.transformV3ToV3(i,Et.__ADAPT_MATRIX__,i)),this._boundingBox=new Je(n,i);var r=new ct;ct.subtract(i,n,r),ct.scale(r,.5,r);var a=new ct;ct.add(n,r,a),this._boundingSphere=new tt(a,ct.scalarLength(r)),this._boundingBoxCorners=[],this._boundingBoxCorners.length=8,this._boundingBox.getCorners(this._boundingBoxCorners)},o.calcLeafBoudingBox=function(e){for(var t=0;t<this._leafNum;t++)this._leafs[t].calcLeafBoudingBox(e)},o.calcLeafBoudingSphere=function(e,t){for(var n=0;n<this._leafNum;n++)this._leafs[n].calcLeafBoudingSphere(e,t)},o._getVertexBuffer=function(e){return void 0===e&&(e=0),0==e?this._vertexBuffer:null},o._getIndexBuffer=function(){return this._indexBuffer},o._beforeRender=function(e){if(this._vertexBuffer._bind(),this._indexBuffer._bind(),0==e.renderElement._material.blend){var t=e.camera;this.assembleIndex(t,t.position)&&this._indexBuffer.setData(this._indexArrayBuffer)}return!0},o._render=function(e){N.mainContext.drawElements(Ln.RENDER_LINE_MODEL?1:4,this._currentNumberIndices,5123,0),C.trianglesFaces+=this._numberTriangle,C.drawCall++},o._renderRuntime=function(e,t,n){},a(0,o,"_originalBoundingSphere",function(){return this._boundingSphere}),a(0,o,"_originalBoundingBox",function(){return this._boundingBox}),a(0,o,"_vertexBufferCount",function(){return this._numberVertices}),a(0,o,"triangleCount",function(){return this._numberTriangle}),i(t,["_TEMP_ARRAY_BUFFER",function(){return this._TEMP_ARRAY_BUFFER=new Uint32Array(Et.CHUNK_GRID_NUM/Et.LEAF_GRID_NUM*Et.CHUNK_GRID_NUM/Et.LEAF_GRID_NUM)}]),t}(Nt),hn=function(e){function t(e){this._terrainSprite3DOwner=null,t.__super.call(this,e),this._terrainSprite3DOwner=e}r(t,"laya.d3.terrain.TerrainRender",e);var n=t.prototype;return n._calculateBoundingSphere=function(){var e=this._terrainSprite3DOwner.terrainFilter;if(null==e)this._boundingSphere.toDefault();else{var t=e._originalBoundingSphere,n=NaN,i=this._terrainSprite3DOwner.transform,r=i.scale;n=r.x>=r.y&&r.x>=r.z?r.x:r.y>=r.z?r.y:r.z,ct.transformCoordinate(t.center,i.worldMatrix,this._boundingSphere.center),this._boundingSphere.radius=t.radius*n,e.calcLeafBoudingSphere(i.worldMatrix,n)}},n._calculateBoundingBox=function(){var e=this._terrainSprite3DOwner.terrainFilter;if(null==e)this._boundingBox.toDefault();else{for(var t=this._terrainSprite3DOwner.transform.worldMatrix,n=e._boundingBoxCorners,i=0;i<8;i++)ct.transformCoordinate(n[i],t,Ot._tempBoundBoxCorners[i]);Je.createfromPoints(Ot._tempBoundBoxCorners,this._boundingBox),e.calcLeafBoudingBox(t)}},n._renderUpdate=function(e){this._setShaderValueMatrix4x4(0,this._owner.transform.worldMatrix);var t=this._owner.getProjectionViewWorldMatrix(e);this._setShaderValueMatrix4x4(1,t)},n._destroy=function(){e.prototype._destroy.call(this),this._terrainSprite3DOwner=null},t}(Ot),_n=(function(e){function t(e){t.__super.call(this,e)}r(t,"laya.d3.water.WaterRender",e);var n=t.prototype;n._calculateBoundingSphere=function(){},n._calculateBoundingBox=function(){},n._destroy=function(){e.prototype._destroy.call(this)}}(Ot),function(e){function t(){this.__loaded=!1,this._url=null,this._lightmaps=null,this._enableLightCount=3,this._renderTargetTexture=null,this._customRenderQueneIndex=11,this._lastCurrentTime=NaN,this._enableFog=!1,this._enableDepthFog=!1,this._fogStart=NaN,this._fogRange=NaN,this._fogColor=null,this._ambientColor=null,this._shaderValues=null,this._shaderDefineValue=0,this._cullingRendersLength=0,this._cullingRenders=null,this._dynamicBatchManager=null,this.enableLight=!0,this.treeRoot=null,this.treeSize=null,this.treeLevel=0,this.parallelSplitShadowMaps=null,this._componentsMap=null,this._typeComponentsIndices=null,this._components=null,t.__super.call(this),this._renderState=new he,this._lights=[],this._quenes=[],this._cameraPool=[],this._renderableSprite3Ds=[],this.__loaded=!0,this._lightmaps=[],this._shaderValues=new gt,this.parallelSplitShadowMaps=[],this._dynamicBatchManager=new ce,this._cullingRenders=[],this._cullingRendersLength=0,this.enableFog=!1,this.fogStart=300,this.fogRange=1e3,this.fogColor=new ct(.7,.7,.7),this.ambientColor=new ct(.212,.227,.259),N.shaderHighPrecision&&this.addShaderDefine(pt.SHADERDEFINE_HIGHPRECISION),this.on("display",this,this._$3__onDisplay),this.on("undisplay",this,this._onUnDisplay),this._componentsMap=[],this._typeComponentsIndices=[],this._components=[]}r(t,"laya.d3.core.scene.Scene",e);var i=t.prototype;return n.imps(i,{"laya.webgl.submit.ISubmit":!0,"laya.resource.ICreateResource":!0}),i.initOctree=function(e,t,n,i,r){void 0===r&&(r=6),this.treeSize=new ct(e,t,n),this.treeLevel=r,this.treeRoot=new _e(this,0),this.treeRoot.init(i,this.treeSize)},i._$3__onDisplay=function(){n.stage._scenes.push(this),n.stage._scenes.sort(t._sortScenes)},i._onUnDisplay=function(){var e=n.stage._scenes;e.splice(e.indexOf(this),1)},i._prepareUpdateToRenderState=function(e,t){t.elapsedTime=this._lastCurrentTime?this.timer.currTimer-this._lastCurrentTime:0,this._lastCurrentTime=this.timer.currTimer,t.scene=this},i._prepareSceneToRender=function(e){var t=this._lights.length;if(t>0)for(var n=0,i=0;i<t&&!(this._lights[i].updateToWorldState(e)&&++n>=this._enableLightCount);i++);},i._updateChilds=function(e){for(var t=0,n=this._childs.length;t<n;++t)this._childs[t]._update(e)},i._updateChildsConch=function(e){for(var t=0,n=this._childs.length;t<n;++t)this._childs[t]._updateConch(e)},i._preRenderScene=function(e,t,n){var i=t._viewMatrix,r=t._projectionMatrix,a=t._projectionViewMatrix,s=0,o=0,l=t.camera;for(l.useOcclusionCulling?this.treeRoot?de.renderObjectCullingOctree(n,this,l,i,r,a):de.renderObjectCulling(n,this,l,i,r,a):de.renderObjectCullingNoBoundFrustum(this,l,i,r,a),s=0,o=this._quenes.length;s<o;s++)this._quenes[s]&&this._quenes[s]._preRender(t)},i._clear=function(e,t){var n=t._viewport,i=t.camera,r=n.x,a=i.renderTargetSize.height-n.y-n.height,s=n.width,o=n.height;e.viewport(r,a,s,o);var l=256,h=i.renderTarget;switch(i.clearFlag){case 0:var _=i.clearColor;if(_){e.enable(3089),e.scissor(r,a,s,o);var u=_.elements;e.clearColor(u[0],u[1],u[2],u[3]),l|=16384}if(h)switch(_||(l=16384),h.depthStencilFormat){case 33189:l|=256;break;case 36168:l|=1024;break;case 34041:l|=256,l|=1024}e.clear(l),_&&e.disable(3089);break;case 1:case 2:if(h)switch(l=16384,h.depthStencilFormat){case 33189:l|=256;break;case 36168:l|=1024;break;case 34041:l|=256,l|=1024}e.clear(l);break;case 3:break;default:throw new Error("BaseScene:camera clearFlag invalid.")}},i._renderScene=function(e,t){var n,i=t.camera,r=0,a=0;for(r=0;r<2;r++)(n=this._quenes[r])&&(i.renderTarget?n._render(t,!0):n._render(t,!1));if(1===i.clearFlag){var s=i.sky;s&&(O.setCullFace(e,!1),O.setDepthFunc(e,515),O.setDepthMask(e,!1),s._render(t),O.setDepthFunc(e,513),O.setDepthMask(e,!0))}for(r=2,a=this._quenes.length;r<a;r++)(n=this._quenes[r])&&(n._sortAlpha(t.camera.transform.position),i.renderTarget?n._render(t,!0):n._render(t,!1))},i._set3DRenderConfig=function(e){e.disable(3042),O._blend=!1,e.blendFunc(770,771),O._sFactor=770,O._dFactor=771,e.disable(2929),O._depthTest=!1,e.enable(2884),O._cullFace=!0,e.depthMask(1),O._depthMask=!0,e.frontFace(2304),O._frontFace=2304},i._set2DRenderConfig=function(e){O.setBlend(e,!0),O.setBlendFunc(e,1,771),O.setDepthTest(e,!1),O.setCullFace(e,!1),O.setDepthMask(e,!0),O.setFrontFace(e,2305),e.viewport(0,0,M.width,M.height)},i._parseCustomProps=function(e,t,n,i){var r=i.customProps.lightmaps,a=r.length,s=this._lightmaps;s.length=a;for(var o=0;o<a;o++)s[o]=x.getRes(t[r[o].replace("exr","png")]);this.setlightmaps(s);var l=i.customProps.ambientColor;l&&(this.ambientColor=new ct(l[0],l[1],l[2]))},i._addLight=function(e){this._lights.indexOf(e)<0&&this._lights.push(e)},i._removeLight=function(e){var t=this._lights.indexOf(e);t>=0&&this._lights.splice(t,1)},i._updateScene=function(){var e=this._renderState;this._prepareUpdateToRenderState(N.mainContext,e),this._updateComponents(e),this._updateChilds(e),this._lateUpdateComponents(e)},i._updateSceneConch=function(){var e=this._renderState;this._prepareUpdateToRenderState(N.mainContext,e),this._updateComponents(e),this._updateChildsConch(e),this._lateUpdateComponents(e),this._prepareSceneToRender(e);for(var t=0,n=this._cameraPool.length;t<n;t++){var i=this._cameraPool[t];e.camera=i,i._prepareCameraToRender()}},i._preRenderShadow=function(e,t,n,i,r){this.treeRoot?de.renderShadowObjectCullingOctree(this,t,n,i,r):de.renderShadowObjectCulling(this,t,n,i,r);for(var a=0,s=n.length;a<s;a++)n[a]&&n[a]._preRender(e)},i._renderShadowMap=function(e,t,n){var i=this.parallelSplitShadowMaps[0];i._calcAllLightCameraInfo(n);var r=i.PSSMNum;this._preRenderShadow(t,i._lightCulling,i._shadowQuenes,i._lightVPMatrix[0],r),this.addShaderDefine(xt.SHADERDEFINE_CAST_SHADOW);var a,s,o;if(r>1)for(var l=0;l<r;l++)a=i.getRenderTarget(l+1),i.beginRenderTarget(l+1),e.clearColor(1,1,1,1),e.clear(16640),e.viewport(0,0,a.width,a.height),t.camera=o=i.getLightCamera(l),o._prepareCameraToRender(),o._prepareCameraViewProject(o.viewMatrix,o.projectionMatrix),t._projectionViewMatrix=i._lightVPMatrix[l+1],(s=i._shadowQuenes[l])._preRender(t),s._renderShadow(t,!1),i.endRenderTarget(l+1);else a=i.getRenderTarget(1),i.beginRenderTarget(1),e.clearColor(1,1,1,1),e.clear(16640),e.viewport(0,0,a.width,a.height),t.camera=o=i.getLightCamera(0),o._prepareCameraToRender(),o._prepareCameraViewProject(o.viewMatrix,o.projectionMatrix),t._projectionViewMatrix=i._lightVPMatrix[0],(s=i._shadowQuenes[0])._preRender(t),s._renderShadow(t,!0),i.endRenderTarget(1);this.removeShaderDefine(xt.SHADERDEFINE_CAST_SHADOW)},i.addTreeNode=function(e){this.treeRoot.addTreeNode(e)},i.removeTreeNode=function(e){this.treeSize&&e._treeNode&&e._treeNode.removeObject(e)},i.setlightmaps=function(e){this._lightmaps=e;for(var t=0,n=this._renderableSprite3Ds.length;t<n;t++)this._renderableSprite3Ds[t]._render._applyLightMapParams()},i.getlightmaps=function(){return this._lightmaps},i.addChildAt=function(e,t){if(!(e instanceof laya.d3.core.Sprite3D))throw new Error("Sprite3D:Node type must Sprite3D.");if(!e||this.destroyed||e===this)return e;if(e.zOrder&&this._set$P("hasZorder",!0),t>=0&&t<=this._childs.length){if(e._parent===this){var n=this.getChildIndex(e);this._childs.splice(n,1),this._childs.splice(t,0,e),this.conchModel&&(this.conchModel.removeChild(e.conchModel),this.conchModel.addChildAt(e.conchModel,t)),this._childChanged()}else{e.parent&&e.parent.removeChild(e),this._childs===D.ARRAY_EMPTY&&(this._childs=[]),this._childs.splice(t,0,e),this.conchModel&&this.conchModel.addChildAt(e.conchModel,t),e.parent=this;var i=e;i.transform._onWorldTransform(),i._setBelongScene(this),i.active&&i._activeHierarchy()}return e}throw new Error("appendChildAt:The index is out of bounds")},i.addChild=function(e){if(!(e instanceof laya.d3.core.Sprite3D))throw new Error("Sprite3D:Node type must Sprite3D.");if(!e||this.destroyed||e===this)return e;if(e.zOrder&&this._set$P("hasZorder",!0),e._parent===this){var t=this.getChildIndex(e);t!==this._childs.length-1&&(this._childs.splice(t,1),this._childs.push(e),this.conchModel&&(this.conchModel.removeChild(e.conchModel),this.conchModel.addChildAt(e.conchModel,this._childs.length-1)),this._childChanged())}else{e.parent&&e.parent.removeChild(e),this._childs===D.ARRAY_EMPTY&&(this._childs=[]),this._childs.push(e),this.conchModel&&this.conchModel.addChildAt(e.conchModel,this._childs.length-1),e.parent=this,this._childChanged();var n=e;n.transform._onWorldTransform(),n._setBelongScene(this),n.active&&n._activeHierarchy()}return e},i.removeChildAt=function(e){var t=this.getChildAt(e);if(t){var n=t;n.transform.parent=null,n.active&&n._inActiveHierarchy(),n._setUnBelongScene(),this._childs.splice(e,1),this.conchModel&&this.conchModel.removeChild(t.conchModel),t.parent=null}return t},i.removeChildren=function(e,t){if(void 0===e&&(e=0),void 0===t&&(t=2147483647),this._childs&&this._childs.length>0){var n=this._childs;if(0===e&&t>=a){var i=n;this._childs=D.ARRAY_EMPTY}else i=n.splice(e,t-e);for(var r=0,a=i.length;r<a;r++){i[r].parent=null;var s=i[r];s.transform.parent=null,s.active&&s._inActiveHierarchy(),s._setUnBelongScene(),this.conchModel&&this.conchModel.removeChild(i[r].conchModel)}}return this},i.addFrustumCullingObject=function(e){this.treeRoot?this.addTreeNode(e):(this._cullingRendersLength===this._cullingRenders.length?this._cullingRenders.push(e):this._cullingRenders[this._cullingRendersLength]=e,e._indexInSceneFrustumCullingObjects=this._cullingRendersLength++)},i.removeFrustumCullingObject=function(e){if(this.treeRoot)this.removeTreeNode(e);else{this._cullingRendersLength--;var t=e._indexInSceneFrustumCullingObjects;if(t!==this._cullingRendersLength){var n=this._cullingRenders[this._cullingRendersLength];this._cullingRenders[t]=n,n._indexInSceneFrustumCullingObjects=t,e._indexInSceneFrustumCullingObjects=-1}}},i.getRenderQueue=function(e){return this._quenes[e]||(this._quenes[e]=new le(this))},i.addRenderQuene=function(){this._quenes[this._customRenderQueneIndex++]=new le(this)},i.addShaderDefine=function(e){this._shaderDefineValue|=e},i.removeShaderDefine=function(e){this._shaderDefineValue&=~e},i.addScript=function(e){return this._addComponent(e)},i.getScriptByType=function(e,t){return void 0===t&&(t=0),this._getComponentByType(e,t)},i.getScriptsByType=function(e,t){this._getComponentsByType(e,t)},i.getScriptByIndex=function(e){return this._getComponentByIndex(e)},i.removeScriptByType=function(e,t){void 0===t&&(t=0),this._removeComponentByType(e,t)},i.removeScriptsByType=function(e){this._removeComponentByType(e)},i.removeAllScript=function(){this._removeAllComponent()},i.render=function(e,t,n){T._context.ctx._renderKey=0,this._childs.length>0&&e.addRenderObject(this)},i.renderSubmit=function(){var e=N.mainContext,t=this._renderState;this._set3DRenderConfig(e),this._prepareSceneToRender(this._renderState);var n,i=0,r=0;if(It.debugMode||_e.debugMode)for(i=0,r=this._cameraPool.length;i<r;i++)n=this._cameraPool[i],It._debugPhasorSprite.begin(1,n),n.activeInHierarchy&&n._renderCamera(e,t,this),It._debugPhasorSprite.end();else for(i=0,r=this._cameraPool.length;i<r;i++)(n=this._cameraPool[i]).activeInHierarchy&&n._renderCamera(e,t,this);return this._set2DRenderConfig(e),1},i.onAsynLoaded=function(e,t,n){if(!this.destroyed){var i=JSON.parse(t[0]);if("Scene"!==i.type)throw new Error("Scene: the .lh file root type must be Scene,please use other function to  load  this file.");var r=t[1];Ct._createNodeByJson(this,i,this,r),this.event("hierarchyloaded",[this]),this.__loaded=!0}},i.destroy=function(t){void 0===t&&(t=!0),this.destroyed||(e.prototype.destroy.call(this,t),this._renderState=null,this._lights=null,this._lightmaps=null,this._renderTargetTexture=null,this._shaderValues=null,this._cullingRenders=null,this._dynamicBatchManager=null,this._quenes=null,this._cameraPool=null,this._renderableSprite3Ds=null,this.treeRoot=null,this.treeSize=null,this.parallelSplitShadowMaps=null,this._typeComponentsIndices=null,this._components=null,x.clearRes(this.url))},i.getRenderType=function(){return 0},i.releaseRender=function(){},i.createConchModel=function(){var e=new ConchScene;return e.init(512,512,512,4),e},i._addComponent=function(e){var t,n=this._componentsMap.indexOf(e);if(-1===n)t=[],this._componentsMap.push(e),this._typeComponentsIndices.push(t);else if(t=this._typeComponentsIndices[n],this._components[t[0]].isSingleton)throw new Error("无法单实例创建"+e+"组件，"+e+"组件已存在！");var i=m.getInstance(e);t.push(this._components.length),this._components.push(i);var r=this;return i._initialize(r),i},i._removeComponent=function(e,t){var n=this._typeComponentsIndices[e],i=n[t],r=this._components[i];this._components.splice(i,1),n.splice(t,1),0===n.length&&(this._typeComponentsIndices.splice(e,1),this._componentsMap.splice(e,1));for(var a=0,s=this._componentsMap.length;a<s;a++)for(var o=(n=this._typeComponentsIndices[a]).length-1;o>=0;o--){var l=n[o];if(!(l>i))break;n[o]=--l}r._destroy()},i._getComponentByType=function(e,t){void 0===t&&(t=0);var n=this._componentsMap.indexOf(e);return-1===n?null:this._components[this._typeComponentsIndices[n][t]]},i._getComponentsByType=function(e,t){var n=this._componentsMap.indexOf(e);if(-1!==n){var i=this._typeComponentsIndices[n],r=i.length;t.length=r;for(var a=0;a<r;a++)t[a]=this._components[i[a]]}else t.length=0},i._getComponentByIndex=function(e){return this._components[e]},i._removeComponentByType=function(e,t){void 0===t&&(t=0);var n=this._componentsMap.indexOf(e);-1!==n&&this._removeComponent(n,t)},i._removeComponentsByType=function(e){var t=this._componentsMap.indexOf(e);if(-1!==t)for(var n=this._typeComponentsIndices[t],i=0,r=n.length;i<r;n.length<r?r--:i++)this._removeComponent(t,i)},i._removeAllComponent=function(){for(var e=0,t=this._componentsMap.length;e<t;this._componentsMap.length<t?t--:e++)this._removeComponentsByType(this._componentsMap[e])},i._updateComponents=function(e){for(var t=0,n=this._components.length;t<n;t++){var i=this._components[t];!i.started&&(i._start(e),i.started=!0),i.enable&&i._update(e)}},i._lateUpdateComponents=function(e){for(var t=0;t<this._components.length;t++){var n=this._components[t];!n.started&&(n._start(e),n.started=!0),n.enable&&n._lateUpdate(e)}},i._preRenderUpdateComponents=function(e){for(var t=0;t<this._components.length;t++){var n=this._components[t];!n.started&&(n._start(e),n.started=!0),n.enable&&n._preRenderUpdate(e)}},i._postRenderUpdateComponents=function(e){for(var t=0;t<this._components.length;t++){var n=this._components[t];!n.started&&(n._start(e),n.started=!0),n.enable&&n._postRenderUpdate(e)}},a(0,i,"_loaded",null,function(e){this.__loaded=e}),a(0,i,"fogColor",function(){return this._fogColor},function(e){this._fogColor=e,this._shaderValues.setValue(0,e.elements)}),a(0,i,"enableFog",function(){return this._enableFog},function(e){this._enableFog!==e&&(this._enableFog=e,e?(this.addShaderDefine(pt.SHADERDEFINE_FOG),this.removeShaderDefine(pt.SAHDERDEFINE_DEPTHFOG)):this.removeShaderDefine(pt.SHADERDEFINE_FOG))}),a(0,i,"url",function(){return this._url},function(e){this._url=e}),a(0,i,"loaded",function(){return this.__loaded}),a(0,i,"enableDepthFog",function(){return this._enableDepthFog},function(e){this._enableDepthFog!=e&&(this._enableDepthFog=e,e?(this.addShaderDefine(pt.SAHDERDEFINE_DEPTHFOG),this.removeShaderDefine(pt.SHADERDEFINE_FOG)):this.removeShaderDefine(pt.SAHDERDEFINE_DEPTHFOG))}),a(0,i,"fogStart",function(){return this._fogStart},function(e){this._fogStart=e,this._shaderValues.setValue(1,e)}),a(0,i,"fogRange",function(){return this._fogRange},function(e){this._fogRange=e,this._shaderValues.setValue(2,e)}),a(0,i,"ambientColor",function(){return this._ambientColor},function(e){this._ambientColor=e,this._shaderValues.setValue(21,e.elements)}),a(0,i,"scene",function(){return this}),a(0,i,"renderableSprite3Ds",function(){return this._renderableSprite3Ds.slice()}),t._sortScenes=function(e,i){if(e.parent===n.stage&&i.parent===n.stage){var r=n.stage._childs;return r.indexOf(e)-r.indexOf(i)}return e.parent!==n.stage&&i.parent!==n.stage?t._sortScenes(e.parent,i.parent):e.parent===n.stage?-1:1},t.load=function(e){return n.loader.create(e,null,null,t)},t.FOGCOLOR=0,t.FOGSTART=1,t.FOGRANGE=2,t.LIGHTDIRECTION=3,t.LIGHTDIRCOLOR=4,t.POINTLIGHTPOS=5,t.POINTLIGHTRANGE=6,t.POINTLIGHTATTENUATION=7,t.POINTLIGHTCOLOR=8,t.SPOTLIGHTPOS=9,t.SPOTLIGHTDIRECTION=10,t.SPOTLIGHTSPOT=11,t.SPOTLIGHTRANGE=12,t.SPOTLIGHTATTENUATION=13,t.SPOTLIGHTCOLOR=14,t.SHADOWDISTANCE=15,t.SHADOWLIGHTVIEWPROJECT=16,t.SHADOWMAPPCFOFFSET=17,t.SHADOWMAPTEXTURE1=18,t.SHADOWMAPTEXTURE2=19,t.SHADOWMAPTEXTURE3=20,t.AMBIENTCOLOR=21,t}(A)),un=function(e){function t(e){t.__super.call(this),this.__loaded=!0,this._projectionViewWorldUpdateLoopCount=-1,this._projectionViewWorldMatrix=new at,this._shaderValues=new gt,this._colliders=[],this.name=e||"Sprite3D-"+t._nameNumberCounter++,this._activeInHierarchy=!1,this._id=++t._uniqueIDCounter,this.layer=H.currentCreationLayer,this._transform=new bt(this),this.active=!0}r(t,"laya.d3.core.Sprite3D",kt);var i=t.prototype;return n.imps(i,{"laya.d3.core.render.IUpdate":!0,"laya.resource.ICreateResource":!0,"laya.d3.core.IClone":!0}),i._parseCustomRTS=function(e){var t=e.translate,n=this.transform.localPosition,i=n.elements;i[0]=t[0],i[1]=t[1],i[2]=t[2],this.transform.localPosition=n;var r=e.rotation,a=this.transform.localRotation,s=a.elements;s[0]=r[0],s[1]=r[1],s[2]=r[2],s[3]=r[3],this.transform.localRotation=a;var o=e.scale,l=this.transform.localScale,h=l.elements;h[0]=o[0],h[1]=o[1],h[2]=o[2],this.transform.localScale=l},i._parseCustomComponent=function(e,t,n){for(var i in n){var r=n[i];switch(i){case"Animator":var a=this.addComponent(Jt);if(r.avatarPath)a.avatar=x.getRes(t[r.avatarPath]);else{var s=r.avatar;if(s){a.avatar=x.getRes(t[s.path]);var o=s.linkSprites;o&&e.once("hierarchyloaded",this,this._onRootNodeHierarchyLoaded,[a,o])}}for(var l=r.clipPaths,h=l.length,_=0;_<h;_++)a.addClip(x.getRes(t[l[_]]));a.clip=x.getRes(t[l[0]]);var u=r.entryPlayIndex;u>=0&&a.play(x.getRes(t[l[u]]).name)}}},i._onRootNodeHierarchyLoaded=function(e,t){for(var n in t){for(var i=this,r=t[n],a=0,s=r.length;a<s;a++){var o=r[a];if(""===o)break;if(!(i=i.getChildByName(o)))break}i&&e.linkSprite3DToAvatarNode(n,i)}},i._setHierarchyAnimator=function(e,t){this._changeHierarchyAnimator(e);for(var n=0,i=this._childs.length;n<i;n++){var r=this._childs[n];r._hierarchyAnimator==t&&r._setHierarchyAnimator(e,t)}},i._clearHierarchyAnimator=function(e,t){this._changeHierarchyAnimator(t);for(var n=0,i=this._childs.length;n<i;n++){var r=this._childs[n];r._hierarchyAnimator==e&&r._clearHierarchyAnimator(e,t)}},i._getAnimatorToLinkSprite3D=function(e,t,n){var i=this.getComponentByType(Jt);if(i&&(i.avatar?i.avatar._version||e._setAnimatorToLinkAvatar(i,t):e._setAnimatorToLinkSprite3DNoAvatar(i,t,n)),this._parent&&this._parent instanceof laya.d3.core.Sprite3D){n.unshift(this._parent.name);var r=this._parent;r._hierarchyAnimator&&r._getAnimatorToLinkSprite3D(e,t,n)}},i._setAnimatorToLinkSprite3DNoAvatar=function(e,t,n){var i=0,r=0;for(i=0,r=e.getClipCount();i<r;i++)e._handleSpriteOwnersBySprite(i,t,n,this);for(i=0,r=this._childs.length;i<r;i++){var a=this._childs[i];n.push(a.name),a._setAnimatorToLinkSprite3DNoAvatar(e,t,n)}},i._changeHierarchyAnimator=function(e){this._hierarchyAnimator=e},i._isLinkSpriteToAnimationNode=function(e,t,n){var i=e._avatarNodes.indexOf(t),r=e._cacheSpriteToNodesMap;if(n)this._transform.dummy=t._transform,e._cacheNodesToSpriteMap[i]=r.length,r.push(i);else{this._transform.dummy=null;var a=e._cacheNodesToSpriteMap[i];e._cacheNodesToSpriteMap[i]=null,r.splice(a,1)}},i._setBelongScene=function(e){this._scene=e;for(var t=0,n=this._childs.length;t<n;t++)this._childs[t]._setBelongScene(e)},i._setUnBelongScene=function(){this._scene=null;for(var e=0,t=this._childs.length;e<t;e++)this._childs[e]._setUnBelongScene()},i._activeHierarchy=function(){this._activeInHierarchy=!0,this._addSelfRenderObjects(),this.event("activeinhierarchychanged",!0);for(var e=0,t=this._childs.length;e<t;e++){var n=this._childs[e];n._active&&n._activeHierarchy()}},i._inActiveHierarchy=function(){this._activeInHierarchy=!1,this._clearSelfRenderObjects(),this.event("activeinhierarchychanged",!1);for(var e=0,t=this._childs.length;e<t;e++){var n=this._childs[e];n._active&&n._inActiveHierarchy()}},i._addComponent=function(e){var t,n=this._componentsMap.indexOf(e);if(-1===n)t=[],this._componentsMap.push(e),this._typeComponentsIndices.push(t);else if(t=this._typeComponentsIndices[n],this._components[t[0]].isSingleton)throw new Error("无法单实例创建"+e+"组件，"+e+"组件已存在！");var i=m.getInstance(e);if(t.push(this._components.length),this._components.push(i),i instanceof laya.d3.component.physics.Collider)this._layer._colliders.push(i),this._colliders.push(i);else if(i instanceof laya.d3.component.Animator){var r=i;this._setHierarchyAnimator(r,this._parent?this._parent._hierarchyAnimator:null),this._setAnimatorToLinkSprite3DNoAvatar(r,!0,[])}return i._initialize(this),i},i._removeComponent=function(e,t){var n=this._typeComponentsIndices[e],i=n[t],r=this._components[i];if(r instanceof laya.d3.component.physics.Collider){var a=r,s=this._layer._colliders;s.splice(s.indexOf(a),1),this._colliders.splice(this._colliders.indexOf(a),1)}else if(r instanceof laya.d3.component.Animator){var o=r;this._clearHierarchyAnimator(o,this._parent?this._parent._hierarchyAnimator:null)}this._components.splice(i,1),n.splice(t,1),0===n.length&&(this._typeComponentsIndices.splice(e,1),this._componentsMap.splice(e,1));for(var l=0,h=this._componentsMap.length;l<h;l++)for(var _=(n=this._typeComponentsIndices[l]).length-1;_>=0;_--){var u=n[_];if(!(u>i))break;n[_]=--u}r._destroy()},i.createConchModel=function(){return null},i._clearSelfRenderObjects=function(){},i._addSelfRenderObjects=function(){},i._parseCustomProps=function(e,t,n,i){},i._updateChilds=function(e){var t=this._childs.length;if(0!==t)for(var n=0;n<t;++n)this._childs[n]._update(e)},i._updateChildsConch=function(e){var t=this._childs.length;if(0!==t)for(var n=0;n<t;++n)this._childs[n]._update(e)},i._getSortID=function(e,t){return 1e3*t.id+e._getVertexBuffer().vertexDeclaration.id},i._update=function(e){e.owner=this,this._activeInHierarchy&&(this._updateComponents(e),this._lateUpdateComponents(e),C.spriteCount++,this._childs.length&&this._updateChilds(e))},i._updateConch=function(e){e.owner=this,this._activeInHierarchy&&(this._updateComponents(e),this._lateUpdateComponents(e),C.spriteCount++,this._childs.length&&this._updateChilds(e))},i.getProjectionViewWorldMatrix=function(e){return at.multiply(e,this.transform.worldMatrix,this._projectionViewWorldMatrix),this._projectionViewWorldMatrix},i.loadHierarchy=function(e){this.addChild(laya.d3.core.Sprite3D.load(e))},i.addChildAt=function(e,t){if(!(e instanceof laya.d3.core.Sprite3D))throw new Error("Sprite3D:Node type must Sprite3D.");if(!e||this.destroyed||e===this)return e;if(e.zOrder&&this._set$P("hasZorder",!0),t>=0&&t<=this._childs.length){if(e._parent===this){var n=this.getChildIndex(e);this._childs.splice(n,1),this._childs.splice(t,0,e),this.conchModel&&(this.conchModel.removeChild(e.conchModel),this.conchModel.addChildAt(e.conchModel,t)),this._childChanged()}else{e.parent&&e.parent.removeChild(e),this._childs===D.ARRAY_EMPTY&&(this._childs=[]),this._childs.splice(t,0,e),this.conchModel&&this.conchModel.addChildAt(e.conchModel,t),e.parent=this;var i=e;i.transform.parent=this.transform,this._hierarchyAnimator&&(!i._hierarchyAnimator&&i._setHierarchyAnimator(this._hierarchyAnimator,null),this._getAnimatorToLinkSprite3D(i,!0,[i.name])),this._scene&&(i._setBelongScene(this._scene),this._activeInHierarchy&&i._active&&i._activeHierarchy())}return e}throw new Error("appendChildAt:The index is out of bounds")},i.addChild=function(e){if(!(e instanceof laya.d3.core.Sprite3D))throw new Error("Sprite3D:Node type must Sprite3D.");if(!e||this.destroyed||e===this)return e;if(e.zOrder&&this._set$P("hasZorder",!0),e._parent===this){var t=this.getChildIndex(e);t!==this._childs.length-1&&(this._childs.splice(t,1),this._childs.push(e),this.conchModel&&(this.conchModel.removeChild(e.conchModel),this.conchModel.addChildAt(e.conchModel,this._childs.length-1)),this._childChanged())}else{e.parent&&e.parent.removeChild(e),this._childs===D.ARRAY_EMPTY&&(this._childs=[]),this._childs.push(e),this.conchModel&&this.conchModel.addChildAt(e.conchModel,this._childs.length-1),e.parent=this,this._childChanged();var n=e;n.transform.parent=this.transform,this._hierarchyAnimator&&(!n._hierarchyAnimator&&n._setHierarchyAnimator(this._hierarchyAnimator,null),this._getAnimatorToLinkSprite3D(n,!0,[n.name])),this._scene&&(n._setBelongScene(this._scene),this._activeInHierarchy&&n._active&&n._activeHierarchy())}return e},i.removeChildAt=function(e){var t=this.getChildAt(e);if(t){var n=t;n.transform.parent=null,this._scene&&(this._activeInHierarchy&&n._active&&n._inActiveHierarchy(),n._setUnBelongScene()),this._hierarchyAnimator&&(n._hierarchyAnimator==this._hierarchyAnimator&&n._clearHierarchyAnimator(this._hierarchyAnimator,null),this._getAnimatorToLinkSprite3D(n,!1,[n.name])),this._childs.splice(e,1),this.conchModel&&this.conchModel.removeChild(t.conchModel),t.parent=null}return t},i.removeChildren=function(e,t){if(void 0===e&&(e=0),void 0===t&&(t=2147483647),this._childs&&this._childs.length>0){var n=this._childs;if(0===e&&t>=a){var i=n;this._childs=D.ARRAY_EMPTY}else i=n.splice(e,t-e);for(var r=0,a=i.length;r<a;r++){i[r].parent=null;var s=i[r];s.transform.parent=null,this._scene&&(this._activeInHierarchy&&s._active&&s._inActiveHierarchy(),s._setUnBelongScene()),this._hierarchyAnimator&&(s._hierarchyAnimator==this._hierarchyAnimator&&s._clearHierarchyAnimator(this._hierarchyAnimator,null),this._getAnimatorToLinkSprite3D(s,!1,[s.name])),this.conchModel&&this.conchModel.removeChild(i[r].conchModel)}}return this},i.addComponent=function(e){return this._addComponent(e)},i.getComponentByType=function(e,t){return void 0===t&&(t=0),this._getComponentByType(e,t)},i.getComponentsByType=function(e,t){return this._getComponentsByType(e,t)},i.getComponentByIndex=function(e){return this._getComponentByIndex(e)},i.removeComponentByType=function(e,t){void 0===t&&(t=0),this._removeComponentByType(e,t)},i.removeComponentsByType=function(e){this._removeComponentByType(e)},i.removeAllComponent=function(){this._removeAllComponent()},i.onAsynLoaded=function(e,t,n){if(!this.destroyed){var i=JSON.parse(t[0]);if("Sprite3D"!==i.type)throw new Error("Sprite3D: The .lh file root type must be Sprite3D,please use other function to  load  this file.");var r=t[1];Ct._createNodeByJson(this,i,this,r),this.event("hierarchyloaded",[this]),this.__loaded=!0}},i.cloneTo=function(e){if(this.destroyed)throw new Error("Sprite3D: Can't be cloned if the Spriote3D has destroyed.");var t=e;t.name=this.name,t.destroyed=this.destroyed,t.timer=this.timer,t._$P=this._$P,t.active=this._active;var n=t.transform.localPosition;this.transform.localPosition.cloneTo(n),t.transform.localPosition=n;var i=t.transform.localRotation;this.transform.localRotation.cloneTo(i),t.transform.localRotation=i;var r=t.transform.localScale;this.transform.localScale.cloneTo(r),t.transform.localScale=r,t.isStatic=this.isStatic;var a=0,s=0;for(a=0,s=this._componentsMap.length;a<s;a++){var o=t.addComponent(this._componentsMap[a]);this._components[a]._cloneTo(o)}for(a=0,s=this._childs.length;a<s;a++)t.addChild(this._childs[a].clone())},i.clone=function(){var e=new this.constructor;return this.cloneTo(e),e},i.destroy=function(e){if(void 0===e&&(e=!0),!this.destroyed){laya.display.Node.prototype.destroy.call(this,e);var t=0,n=0;for(t=0,n=this._components.length;t<n;t++)this._components[t]._destroy();this._components=null,this._componentsMap=null,this._typeComponentsIndices=null,this._transform=null;var i=this._layer._colliders;for(t=0,n=this._colliders.length;t<n;t++)i.splice(i.indexOf(this._colliders[t]),1);this._colliders=null,x.clearRes(this.url)}},i._handleSpriteToAvatar=function(e,t){e._avatarNodes;var n=e._avatarNodeMap[this.name];n&&n.name===this.name&&!this._transform.dummy&&this._isLinkSpriteToAnimationNode(e,n,t)},i._setAnimatorToLinkAvatar=function(e,t){this._handleSpriteToAvatar(e,t);for(var n=0,i=this._childs.length;n<i;n++)this._childs[n]._setAnimatorToLinkAvatar(e,t)},a(0,i,"activeInHierarchy",function(){return this._activeInHierarchy}),a(0,i,"_loaded",null,function(e){this.__loaded=e}),a(0,i,"active",function(){return this._active},function(e){this._active!==e&&(this._active=e,this._scene&&(this._parent===this._scene||this._parent._activeInHierarchy)&&(e?this._activeHierarchy():this._inActiveHierarchy()))}),a(0,i,"componentsCount",function(){return this._components.length}),a(0,i,"loaded",function(){return this.__loaded}),a(0,i,"id",function(){return this._id}),a(0,i,"url",function(){return this._url},function(e){this._url=e}),a(0,i,"layer",function(){return this._layer},function(e){if(!e)throw new Error("Layer value can be null.");var t=0,n=this._colliders.length;if(this._layer){var i=this._layer._colliders;for(t=0;t<n;t++)i.splice(i.indexOf(this._colliders[t]),1)}var r=e._colliders;for(t=0;t<n;t++)r.push(this._colliders[t]);this._layer=e,this.event("layerchanged",e)}),a(0,i,"scene",function(){return this._scene}),a(0,i,"transform",function(){return this._transform}),t.instantiate=function(e,t,n,i,r){void 0===n&&(n=!0);var a=e.clone();t&&t.addChild(a);var s=a.transform;if(n){var o=s.worldMatrix;e.transform.worldMatrix.cloneTo(o),s.worldMatrix=o}else i&&(s.position=i),r&&(s.rotation=r);return a},t.load=function(e){return n.loader.create(e,null,null,t)},t.WORLDMATRIX=0,t.MVPMATRIX=1,t._uniqueIDCounter=0,t._nameNumberCounter=0,t}(),cn=function(e){function t(e,n,i,r,a,s,o,l){if(this.customCompile=!1,this._curActTexIndex=0,this._program=null,this._attributeParams=null,this._uniformParams=null,this._attributeParamsMap=[],this._sceneUniformParamsMap=[],this._cameraUniformParamsMap=[],this._spriteUniformParamsMap=[],this._materialUniformParamsMap=[],this._renderElementUniformParamsMap=[],t.__super.call(this),!e||!n)throw"Shader Error";(T.isConchApp||T.isFlash)&&(this.customCompile=!0),this._id=++t._count,this._vs=e,this._ps=n,this._attributeMap=i,this._sceneUniformMap=r,this._cameraUniformMap=a,this._spriteUniformMap=s,this._materialUniformMap=o,this._renderElementUniformMap=l,this.recreateResource()}r(t,"laya.d3.shader.Shader3D",u);var n=t.prototype;return n.recreateResource=function(){this._compile(),this.completeCreate(),this.memorySize=0},n.detoryResource=function(){N.mainContext.deleteShader(this._vshader),N.mainContext.deleteShader(this._pshader),N.mainContext.deleteProgram(this._program),this._vshader=this._pshader=this._program=null,this._attributeParams=null,this._uniformParams=null,this.memorySize=0,this._curActTexIndex=0},n._compile=function(){if(this._vs&&this._ps&&!this._attributeParams&&!this._uniformParams){this._reCompile=!0,this._attributeParams=[],this._uniformParams=[];var e,n=[this._vs,this._ps];this.customCompile&&(e=this._preGetParams(this._vs,this._ps));var i=N.mainContext;if(this._program=i.createProgram(),this._vshader=t._createShader(i,n[0],35633),this._pshader=t._createShader(i,n[1],35632),i.attachShader(this._program,this._vshader),i.attachShader(this._program,this._pshader),i.linkProgram(this._program),pt.debugMode&&!this.customCompile&&!i.getProgramParameter(this._program,35714))throw i.getProgramInfoLog(this._program);var r,a=0,s=0,o=this.customCompile?e.attributes.length:i.getProgramParameter(this._program,35721);for(a=0;a<o;a++){var l=this.customCompile?e.attributes[a]:i.getActiveAttrib(this._program,a);r={vartype:"attribute",ivartype:0,attrib:l,location:i.getAttribLocation(this._program,l.name),name:l.name,type:l.type,isArray:!1,isSame:!1,preValue:null,indexOfParams:0},this._attributeParams.push(r)}var h=this.customCompile?e.uniforms.length:i.getProgramParameter(this._program,35718);for(a=0;a<h;a++){var _=this.customCompile?e.uniforms[a]:i.getActiveUniform(this._program,a);(r={vartype:"uniform",ivartype:1,attrib:l,location:i.getUniformLocation(this._program,_.name),name:_.name,type:_.type,isArray:!1,isSame:!1,preValue:null,indexOfParams:0}).name.indexOf("[0]")>0&&(r.name=r.name.substr(0,r.name.length-3),r.isArray=!0,r.location=i.getUniformLocation(this._program,r.name)),this._uniformParams.push(r)}for(a=0,s=this._attributeParams.length;a<s;a++)(r=this._attributeParams[a]).indexOfParams=a,r.index=1,r.value=[r.location,null],r.codename=r.name,r.name=null!=this._attributeMap[r.codename]?this._attributeMap[r.codename]:r.codename,this._attributeParamsMap.push(r.name),this._attributeParamsMap.push(r),r._this=this,r.uploadedValue=[],r.fun=this._attribute;for(a=0,s=this._uniformParams.length;a<s;a++)switch(r=this._uniformParams[a],r.indexOfParams=a,r.index=1,r.value=[r.location,null],r.codename=r.name,null!=this._sceneUniformMap[r.codename]?(r.name=this._sceneUniformMap[r.codename],this._sceneUniformParamsMap.push(r.name),this._sceneUniformParamsMap.push(r)):null!=this._cameraUniformMap[r.codename]?(r.name=this._cameraUniformMap[r.codename],this._cameraUniformParamsMap.push(r.name),this._cameraUniformParamsMap.push(r)):null!=this._spriteUniformMap[r.codename]?(r.name=this._spriteUniformMap[r.codename],this._spriteUniformParamsMap.push(r.name),this._spriteUniformParamsMap.push(r)):null!=this._materialUniformMap[r.codename]?(r.name=this._materialUniformMap[r.codename],this._materialUniformParamsMap.push(r.name),this._materialUniformParamsMap.push(r)):null!=this._renderElementUniformMap[r.codename]?(r.name=this._renderElementUniformMap[r.codename],this._renderElementUniformParamsMap.push(r.name),this._renderElementUniformParamsMap.push(r)):console.log("Shader:can't find uinform name:"+r.codename+"in shader file."),r._this=this,r.uploadedValue=[],r.type){case 5124:r.fun=r.isArray?this._uniform1iv:this._uniform1i;break;case 5126:r.fun=r.isArray?this._uniform1fv:this._uniform1f;break;case 35664:r.fun=r.isArray?this._uniform_vec2v:this._uniform_vec2;break;case 35665:r.fun=r.isArray?this._uniform_vec3v:this._uniform_vec3;break;case 35666:r.fun=r.isArray?this._uniform_vec4v:this._uniform_vec4;break;case 35678:r.fun=this._uniform_sampler2D;break;case 35680:r.fun=this._uniform_samplerCube;break;case 35676:r.fun=this._uniformMatrix4fv;break;case 35670:r.fun=this._uniform1i;break;case 35674:r.fun=this._uinformMatrix2fv;break;case 35675:r.fun=this._uinformMatrix3fv;break;default:throw new Error("compile shader err!")}}},n._attribute=function(e,t){var n=N.mainContext,i=d._enableAtributes,r=e.location;return i[r]||n.enableVertexAttribArray(r),n.vertexAttribPointer(r,t[0],t[1],t[2],t[3],t[4]),i[r]=d._bindVertexBuffer,1},n._uniform1f=function(e,t){var n=e.uploadedValue;return n[0]!==t?(N.mainContext.uniform1f(e.location,n[0]=t),1):0},n._uniform1fv=function(e,t){if(t.length<4){var n=e.uploadedValue;return n[0]!==t[0]||n[1]!==t[1]||n[2]!==t[2]||n[3]!==t[3]?(N.mainContext.uniform1fv(e.location,t),n[0]=t[0],n[1]=t[1],n[2]=t[2],n[3]=t[3],1):0}return N.mainContext.uniform1fv(e.location,t),1},n._uniform_vec2=function(e,t){var n=e.uploadedValue;return n[0]!==t[0]||n[1]!==t[1]?(N.mainContext.uniform2f(e.location,n[0]=t[0],n[1]=t[1]),1):0},n._uniform_vec2v=function(e,t){if(t.length<2){var n=e.uploadedValue;return n[0]!==t[0]||n[1]!==t[1]||n[2]!==t[2]||n[3]!==t[3]?(N.mainContext.uniform2fv(e.location,t),n[0]=t[0],n[1]=t[1],n[2]=t[2],n[3]=t[3],1):0}return N.mainContext.uniform2fv(e.location,t),1},n._uniform_vec3=function(e,t){var n=e.uploadedValue;return n[0]!==t[0]||n[1]!==t[1]||n[2]!==t[2]?(N.mainContext.uniform3f(e.location,n[0]=t[0],n[1]=t[1],n[2]=t[2]),1):0},n._uniform_vec3v=function(e,t){return N.mainContext.uniform3fv(e.location,t),1},n._uniform_vec4=function(e,t){var n=e.uploadedValue;return n[0]!==t[0]||n[1]!==t[1]||n[2]!==t[2]||n[3]!==t[3]?(N.mainContext.uniform4f(e.location,n[0]=t[0],n[1]=t[1],n[2]=t[2],n[3]=t[3]),1):0},n._uniform_vec4v=function(e,t){return N.mainContext.uniform4fv(e.location,t),1},n._uniformMatrix2fv=function(e,t){return N.mainContext.uniformMatrix2fv(e.location,!1,t),1},n._uniformMatrix3fv=function(e,t){return N.mainContext.uniformMatrix3fv(e.location,!1,t),1},n._uniformMatrix4fv=function(e,t){return N.mainContext.uniformMatrix4fv(e.location,!1,t),1},n._uinformMatrix2fv=function(e,t){return N.mainContext.uniformMatrix2fv(e.location,!1,t),1},n._uinformMatrix3fv=function(e,t){return N.mainContext.uniformMatrix3fv(e.location,!1,t),1},n._uniform1i=function(e,t){var n=e.uploadedValue;return n[0]!==t?(N.mainContext.uniform1i(e.location,n[0]=t),1):0},n._uniform1iv=function(e,t){return N.mainContext.uniform1iv(e.location,t),1},n._uniform_ivec2=function(e,t){var n=e.uploadedValue;return n[0]!==t[0]||n[1]!==t[1]?(N.mainContext.uniform2i(e.location,n[0]=t[0],n[1]=t[1]),1):0},n._uniform_ivec2v=function(e,t){return N.mainContext.uniform2iv(e.location,t),1},n._uniform_vec3i=function(e,t){var n=e.uploadedValue;return n[0]!==t[0]||n[1]!==t[1]||n[2]!==t[2]?(N.mainContext.uniform3i(e.location,n[0]=t[0],n[1]=t[1],n[2]=t[2]),1):0},n._uniform_vec3vi=function(e,t){return N.mainContext.uniform3iv(e.location,t),1},n._uniform_vec4i=function(e,t){var n=e.uploadedValue;return n[0]!==t[0]||n[1]!==t[1]||n[2]!==t[2]||n[3]!==t[3]?(N.mainContext.uniform4i(e.location,n[0]=t[0],n[1]=t[1],n[2]=t[2],n[3]=t[3]),1):0},n._uniform_vec4vi=function(e,t){return N.mainContext.uniform4iv(e.location,t),1},n._uniform_sampler2D=function(e,n){var i=N.mainContext,r=e.uploadedValue;if(null==r[0]){if(this._curActTexIndex>7)throw new Error("Shader3D: shader support textures max count is 8,can't large than it.");return r[0]=this._curActTexIndex,i.uniform1i(e.location,this._curActTexIndex),i.activeTexture(t._TEXTURES[this._curActTexIndex]),n&&O.bindTexture(i,3553,n),this._curActTexIndex++,1}return i.activeTexture(t._TEXTURES[r[0]]),n&&O.bindTexture(i,3553,n),0},n._uniform_samplerCube=function(e,n){var i=N.mainContext,r=e.uploadedValue;if(null==r[0]){if(this._curActTexIndex>7)throw new Error("Shader3D: shader support textures max count is 8,can't large than it.");return r[0]=this._curActTexIndex,i.uniform1i(e.location,this._curActTexIndex),i.activeTexture(t._TEXTURES[this._curActTexIndex]),n?O.bindTexture(i,34067,n):O.bindTexture(i,34067,In.grayTexture.source),this._curActTexIndex++,1}return i.activeTexture(t._TEXTURES[r[0]]),n?O.bindTexture(i,34067,n):O.bindTexture(i,34067,In.grayTexture.source),0},n._noSetValue=function(e){console.log("no....:"+e.name)},n.uploadTexture2D=function(e){C.shaderCall++;var t=N.mainContext;t.activeTexture(33984),O.bindTexture(t,3553,e)},n.bind=function(){return u.activeShader=this,u.bindShader=this,this.activeResource(),O.UseProgram(this._program)},n.uploadAttributes=function(e,t){for(var n,i,r=0,a=0,s=this._attributeParamsMap.length;a<s;a+=2)i=this._attributeParamsMap[a+1],null!=(n=e[this._attributeParamsMap[a]])&&(t&&t[i.name]&&t[i.name].bind(),r+=i.fun.call(this,i,n));C.shaderCall+=r},n.uploadSceneUniforms=function(e){for(var t,n,i=0,r=0,a=this._sceneUniformParamsMap.length;r<a;r+=2)n=this._sceneUniformParamsMap[r+1],null!=(t=e[this._sceneUniformParamsMap[r]])&&(i+=n.fun.call(this,n,t));C.shaderCall+=i},n.uploadCameraUniforms=function(e){for(var t,n,i=0,r=0,a=this._cameraUniformParamsMap.length;r<a;r+=2)n=this._cameraUniformParamsMap[r+1],null!=(t=e[this._cameraUniformParamsMap[r]])&&(i+=n.fun.call(this,n,t));C.shaderCall+=i},n.uploadSpriteUniforms=function(e){for(var t,n,i=0,r=0,a=this._spriteUniformParamsMap.length;r<a;r+=2)n=this._spriteUniformParamsMap[r+1],null!=(t=e[this._spriteUniformParamsMap[r]])&&(i+=n.fun.call(this,n,t));C.shaderCall+=i},n.uploadMaterialUniforms=function(e){for(var t,n,i=0,r=0,a=this._materialUniformParamsMap.length;r<a;r+=2)n=this._materialUniformParamsMap[r+1],null!=(t=e[this._materialUniformParamsMap[r]])&&(i+=n.fun.call(this,n,t));C.shaderCall+=i},n.uploadRenderElementUniforms=function(e){for(var t,n,i=0,r=0,a=this._renderElementUniformParamsMap.length;r<a;r+=2)n=this._renderElementUniformParamsMap[r+1],null!=(t=e[this._renderElementUniformParamsMap[r]])&&(i+=n.fun.call(this,n,t));C.shaderCall+=i},n._preGetParams=function(e,t){var n=[e,t],i={},r=[],a=[],s={},o=[];i.attributes=r,i.uniforms=a,i.defines=s;for(var l=new RegExp("(/\\*([^*]|[\\r\\\n]|(\\*+([^*/]|[\\r\\n])))*\\*+/)|(//.*)","g"),h=new RegExp("(\".*\")|('.*')|([#\\w\\*-\\.+/()=<>{}\\\\]+)|([,;:\\\\])","g"),_=0,u=0,c=0;c<2;c++){n[c]=n[c].replace(l,"");var d,f=n[c].match(h);for(_=0,u=f.length;_<u;_++){var m=f[_];if("attribute"==m||"uniform"==m)_=this.parseOne(r,a,f,_,m,!0);else{if("#define"==m){o[m=f[++_]]=1;continue}if("#ifdef"==m){s[d=f[++_]]=s[d]||[];for(_++;_<u;_++)if("attribute"==(m=f[_])||"uniform"==m)_=this.parseOne(r,a,f,_,m,o[d]);else if("#else"==m)for(_++;_<u;_++)if("attribute"==(m=f[_])||"uniform"==m)_=this.parseOne(r,a,f,_,m,!o[d]);else if("#endif"==m)break}}}}return i},n.parseOne=function(e,n,i,r,a,s){var o={type:t.shaderParamsMap[i[r+1]],name:i[r+2],size:isNaN(parseInt(i[r+3]))?1:parseInt(i[r+3])};return s&&("attribute"==a?e.push(o):n.push(o)),":"==i[r+3]&&(o.type=i[r+4],r+=2),r+=2},t.create=function(e,n,i,r,a,s,o,l){return new t(e,n,i,r,a,s,o,l)},t.addInclude=function(e,n){if(!n||0===n.length)throw new Error("add shader include file err:"+e);if(t._includeFiles[e])throw new Error("add shader include file err, has add:"+e);t._includeFiles[e]=n},t._createShader=function(e,t,n){var i=e.createShader(n);if(e.shaderSource(i,t),e.compileShader(i),pt.debugMode&&!e.getShaderParameter(i,35713))throw e.getShaderInfoLog(i);return i},t.PERIOD_RENDERELEMENT=0,t.PERIOD_MATERIAL=1,t.PERIOD_SPRITE=2,t.PERIOD_CAMERA=3,t.PERIOD_SCENE=4,t._TEXTURES=[33984,33985,33986,33987,33988,33989,33990,33991],t._includeFiles={},t._count=0,i(t,["shaderParamsMap",function(){return this.shaderParamsMap={float:5126,int:5124,bool:35670,vec2:35664,vec3:35665,vec4:35666,ivec2:35667,ivec3:35668,ivec4:35669,bvec2:35671,bvec3:35672,bvec4:35673,mat2:35674,mat3:35675,mat4:35676,sampler2D:35678,samplerCube:35680}},"nameKey",function(){return this.nameKey=new I}]),t}(),dn=function(e){function t(){t.__super.call(this),this.setShaderName("ExtendTerrain"),this.renderMode=1}r(t,"laya.d3.core.material.ExtendTerrainMaterial",jt);var n=t.prototype;return n._setDetailNum=function(e){switch(e){case 1:this._addShaderDefine(laya.d3.core.material.ExtendTerrainMaterial.SHADERDEFINE_DETAIL_NUM1),this._removeShaderDefine(laya.d3.core.material.ExtendTerrainMaterial.SHADERDEFINE_DETAIL_NUM2),this._removeShaderDefine(laya.d3.core.material.ExtendTerrainMaterial.SHADERDEFINE_DETAIL_NUM3),this._removeShaderDefine(laya.d3.core.material.ExtendTerrainMaterial.SHADERDEFINE_DETAIL_NUM4),this._removeShaderDefine(laya.d3.core.material.ExtendTerrainMaterial.SHADERDEFINE_DETAIL_NUM5);break;case 2:this._addShaderDefine(laya.d3.core.material.ExtendTerrainMaterial.SHADERDEFINE_DETAIL_NUM2),this._removeShaderDefine(laya.d3.core.material.ExtendTerrainMaterial.SHADERDEFINE_DETAIL_NUM1),this._removeShaderDefine(laya.d3.core.material.ExtendTerrainMaterial.SHADERDEFINE_DETAIL_NUM3),this._removeShaderDefine(laya.d3.core.material.ExtendTerrainMaterial.SHADERDEFINE_DETAIL_NUM4),this._removeShaderDefine(laya.d3.core.material.ExtendTerrainMaterial.SHADERDEFINE_DETAIL_NUM5);break;case 3:this._addShaderDefine(laya.d3.core.material.ExtendTerrainMaterial.SHADERDEFINE_DETAIL_NUM3),this._removeShaderDefine(laya.d3.core.material.ExtendTerrainMaterial.SHADERDEFINE_DETAIL_NUM1),this._removeShaderDefine(laya.d3.core.material.ExtendTerrainMaterial.SHADERDEFINE_DETAIL_NUM2),this._removeShaderDefine(laya.d3.core.material.ExtendTerrainMaterial.SHADERDEFINE_DETAIL_NUM4),this._removeShaderDefine(laya.d3.core.material.ExtendTerrainMaterial.SHADERDEFINE_DETAIL_NUM5);break;case 4:this._addShaderDefine(laya.d3.core.material.ExtendTerrainMaterial.SHADERDEFINE_DETAIL_NUM4),this._removeShaderDefine(laya.d3.core.material.ExtendTerrainMaterial.SHADERDEFINE_DETAIL_NUM1),this._removeShaderDefine(laya.d3.core.material.ExtendTerrainMaterial.SHADERDEFINE_DETAIL_NUM2),this._removeShaderDefine(laya.d3.core.material.ExtendTerrainMaterial.SHADERDEFINE_DETAIL_NUM3),this._removeShaderDefine(laya.d3.core.material.ExtendTerrainMaterial.SHADERDEFINE_DETAIL_NUM5);break;case 5:this._addShaderDefine(laya.d3.core.material.ExtendTerrainMaterial.SHADERDEFINE_DETAIL_NUM5),this._removeShaderDefine(laya.d3.core.material.ExtendTerrainMaterial.SHADERDEFINE_DETAIL_NUM1),this._removeShaderDefine(laya.d3.core.material.ExtendTerrainMaterial.SHADERDEFINE_DETAIL_NUM2),this._removeShaderDefine(laya.d3.core.material.ExtendTerrainMaterial.SHADERDEFINE_DETAIL_NUM3),this._removeShaderDefine(laya.d3.core.material.ExtendTerrainMaterial.SHADERDEFINE_DETAIL_NUM4)}},n.disableLight=function(){this._addDisablePublicShaderDefine(pt.SHADERDEFINE_POINTLIGHT|pt.SHADERDEFINE_SPOTLIGHT|pt.SHADERDEFINE_DIRECTIONLIGHT)},a(0,n,"diffuseScaleOffset2",null,function(e){this._setColor(7,e)}),a(0,n,"splatAlphaTexture",function(){return this._getTexture(0)},function(e){this._setTexture(0,e)}),a(0,n,"diffuseScaleOffset3",null,function(e){this._setColor(8,e)}),a(0,n,"diffuseTexture1",null,function(e){this._setTexture(1,e),this._setDetailNum(1)}),a(0,n,"renderMode",null,function(e){switch(e){case 1:this.renderQueue=1,this.depthWrite=!0,this.depthTest=!0,this.cull=2,this.blend=0,this.depthFunc=513;break;case 2:this.renderQueue=1,this.depthWrite=!1,this.depthTest=!0,this.cull=2,this.blend=1,this.srcBlend=770,this.dstBlend=771,this.depthFunc=515;break;default:throw new Error("ExtendTerrainMaterial:renderMode value error.")}this._conchMaterial&&this._conchMaterial.setRenderMode(e)}),a(0,n,"diffuseTexture2",function(){return this._getTexture(2)},function(e){this._setTexture(2,e),this._setDetailNum(2)}),a(0,n,"diffuseScaleOffset1",null,function(e){this._setColor(6,e)}),a(0,n,"diffuseTexture3",function(){return this._getTexture(3)},function(e){this._setTexture(3,e),this._setDetailNum(3)}),a(0,n,"diffuseTexture4",function(){return this._getTexture(4)},function(e){this._setTexture(4,e),this._setDetailNum(4)}),a(0,n,"diffuseTexture5",function(){return this._getTexture(5)},function(e){this._setTexture(5,e),this._setDetailNum(5)}),a(0,n,"diffuseScaleOffset4",null,function(e){this._setColor(9,e)}),a(0,n,"diffuseScaleOffset5",null,function(e){this._setColor(10,e)}),a(0,n,"albedo",function(){return this._getColor(14)},function(e){this._setColor(14,e)}),a(0,n,"ambientColor",function(){return this._getColor(11)},function(e){this._setColor(11,e)}),a(0,n,"diffuseColor",function(){return this._getColor(12)},function(e){this._setColor(12,e)}),a(0,n,"specularColor",function(){return this._getColor(13)},function(e){this._setColor(13,e)}),t.RENDERMODE_OPAQUE=1,t.RENDERMODE_TRANSPARENT=2,t.SPLATALPHATEXTURE=0,t.DIFFUSETEXTURE1=1,t.DIFFUSETEXTURE2=2,t.DIFFUSETEXTURE3=3,t.DIFFUSETEXTURE4=4,t.DIFFUSETEXTURE5=5,t.DIFFUSESCALEOFFSET1=6,t.DIFFUSESCALEOFFSET2=7,t.DIFFUSESCALEOFFSET3=8,t.DIFFUSESCALEOFFSET4=9,t.DIFFUSESCALEOFFSET5=10,t.MATERIALAMBIENT=11,t.MATERIALDIFFUSE=12,t.MATERIALSPECULAR=13,t.MATERIALALBEDO=14,t.SHADERDEFINE_DETAIL_NUM1=0,t.SHADERDEFINE_DETAIL_NUM2=0,t.SHADERDEFINE_DETAIL_NUM3=0,t.SHADERDEFINE_DETAIL_NUM4=0,t.SHADERDEFINE_DETAIL_NUM5=0,t}(),fn=function(e){function t(){t.__super.call(this),this.setShaderName("GLITTER"),this.renderMode=1,this._setColor(3,new dt(1,1,1,1)),this._setColor(2,new dt(1,1,1,1))}r(t,"laya.d3.core.material.GlitterMaterial",e);var s=t.prototype;return s.setShaderName=function(t){e.prototype.setShaderName.call(this,t)},a(0,s,"renderMode",null,function(e){switch(e){case 1:this.renderQueue=1,this.depthWrite=!0,this.cull=2,this.blend=0;break;case 2:this.renderQueue=1,this.depthWrite=!0,this.cull=0,this.blend=0;break;case 13:this.renderQueue=2,this.depthWrite=!0,this.cull=2,this.blend=1,this.srcBlend=770,this.dstBlend=771;break;case 14:this.renderQueue=2,this.depthWrite=!0,this.cull=0,this.blend=1,this.srcBlend=770,this.dstBlend=771;break;case 15:this.renderQueue=2,this.depthWrite=!0,this.cull=2,this.blend=1,this.srcBlend=770,this.dstBlend=1;break;case 16:this.renderQueue=2,this.depthWrite=!0,this.cull=0,this.blend=1,this.srcBlend=770,this.dstBlend=1;break;case 5:this.renderQueue=2,this.depthWrite=!1,this.cull=2,this.blend=1,this.srcBlend=770,this.dstBlend=771;break;case 6:this.renderQueue=2,this.depthWrite=!1,this.cull=0,this.blend=1,this.srcBlend=770,this.dstBlend=771;break;case 7:this.renderQueue=2,this.depthWrite=!1,this.cull=2,this.blend=1,this.srcBlend=770,this.dstBlend=1;break;case 8:this.renderQueue=2,this.depthWrite=!1,this.cull=0,this.blend=1,this.srcBlend=770,this.dstBlend=1;break;case 9:this.renderQueue=2,this.depthTest=!1,this.cull=2,this.blend=1,this.srcBlend=770,this.dstBlend=771;break;case 10:this.renderQueue=2,this.depthTest=!1,this.cull=0,this.blend=1,this.srcBlend=770,this.dstBlend=771;break;case 11:this.renderQueue=2,this.depthTest=!1,this.cull=2,this.blend=1,this.srcBlend=770,this.dstBlend=1;break;case 12:this.renderQueue=2,this.depthTest=!1,this.cull=0,this.blend=1,this.srcBlend=770,this.dstBlend=1;break;default:throw new Error("Material:renderMode value error.")}this._conchMaterial&&this._conchMaterial.setRenderMode(e)}),a(0,s,"diffuseTexture",function(){return this._getTexture(1)},function(e){this._setTexture(1,e)}),a(0,s,"albedo",function(){return this._getColor(2)},function(e){this._setColor(2,e)}),a(0,s,"color",function(){return this._getColor(3)},function(e){this._setColor(3,e)}),t.load=function(e){return n.loader.create(e,null,null,t)},t.RENDERMODE_OPAQUE=1,t.RENDERMODE_OPAQUEDOUBLEFACE=2,t.RENDERMODE_TRANSPARENT=13,t.RENDERMODE_TRANSPARENTDOUBLEFACE=14,t.RENDERMODE_ADDTIVE=15,t.RENDERMODE_ADDTIVEDOUBLEFACE=16,t.RENDERMODE_DEPTHREAD_TRANSPARENT=5,t.RENDERMODE_DEPTHREAD_TRANSPARENTDOUBLEFACE=6,t.RENDERMODE_DEPTHREAD_ADDTIVE=7,t.RENDERMODE_DEPTHREAD_ADDTIVEDOUBLEFACE=8,t.RENDERMODE_NONDEPTH_TRANSPARENT=9,t.RENDERMODE_NONDEPTH_TRANSPARENTDOUBLEFACE=10,t.RENDERMODE_NONDEPTH_ADDTIVE=11,t.RENDERMODE_NONDEPTH_ADDTIVEDOUBLEFACE=12,t.DIFFUSETEXTURE=1,t.ALBEDO=2,t.UNICOLOR=3,i(t,["defaultMaterial",function(){return this.defaultMaterial=new t}]),t}(jt),mn=function(e){function t(){if(this._transformUV=null,t.__super.call(this),!laya.d3.core.material.PBRMaterial.pbrlutTex){var e=c.window.__pbrlutdata;if(!e)throw alert("no pbr lutdata, need pbrlut.js"),"no pbr lutdata, need pbrlut.js";var n=Mn.create(new Uint32Array(e).buffer,256,256,9728,9728,!1);laya.d3.core.material.PBRMaterial.pbrlutTex=n}this._setTexture(4,laya.d3.core.material.PBRMaterial.pbrlutTex),this.setShaderName("PBR"),this._setNumber(0,.5),this.use_groundtruth=!1}r(t,"laya.d3.core.material.PBRMaterial",e);var s=t.prototype;return s.disableLight=function(){this._addDisablePublicShaderDefine(pt.SHADERDEFINE_POINTLIGHT|pt.SHADERDEFINE_SPOTLIGHT|pt.SHADERDEFINE_DIRECTIONLIGHT)},s.disableFog=function(){this._addDisablePublicShaderDefine(pt.SHADERDEFINE_FOG)},s.onAsynLoaded=function(t,n,i){e.prototype.onAsynLoaded.call(this,t,n,i)},s.radicalInverse_VdC=function(e){var t=new Uint32Array(1);return function(e){return e=e<<16|e>>>16,e=(1431655765&e)<<1|(2863311530&e)>>>1,e=(858993459&e)<<2|(3435973836&e)>>>2,e=(252645135&e)<<4|(4042322160&e)>>>4,e=(16711935&e)<<8|(4278255360&e)>>>8,t[0]=e,2.3283064365386963e-10*t[0]}(e)},s.createHammersleyTex=function(e,t){var n=new Uint8Array(e*t*4),i=0,r=0;for(r=0;r<e*t;r++){var a=this.radicalInverse_VdC(r);n[i++]=255*a,n[i++]=0,n[i++]=0,n[i++]=255}return n},a(0,s,"normalTexture",function(){return this._getTexture(2)},function(e){this._setTexture(2,e)}),a(0,s,"has_tangent",null,function(e){this._addShaderDefine(t.SHADERDEFINE_HAS_TANGENT)}),a(0,s,"roughness",function(){return this._getNumber(6)},function(e){this._setNumber(6,e),this._addShaderDefine(t.SHADERDEFINE_FIX_ROUGHNESS)}),a(0,s,"metaless",function(){return this._getNumber(7)},function(e){this._setNumber(7,e),this._addShaderDefine(t.SHADERDEFINE_FIX_METALESS)}),a(0,s,"pbrlutTexture",function(){return this._getTexture(4)},function(e){this._setTexture(4,e)}),a(0,s,"use_groundtruth",null,function(e){if(e){if(this._addShaderDefine(t.SHADERDEFINE_USE_GROUNDTRUTH),!laya.d3.core.material.PBRMaterial.HammersleyNoiseTex){var n=this.createHammersleyTex(32,32);laya.d3.core.material.PBRMaterial.HammersleyNoiseTex=Mn.create(n.buffer,32,32,9728,9728,!1)}this._setTexture(15,t.HammersleyNoiseTex)}else laya.d3.core.material.PBRMaterial.HammersleyNoiseTex=null,this._removeShaderDefine(t.SHADERDEFINE_USE_GROUNDTRUTH)}),a(0,s,"transformUV",function(){return this._transformUV},function(e){this._transformUV=e,this._setMatrix4x4(8,e.matrix),this._conchMaterial&&this._conchMaterial.setShaderValue(8,e.matrix.elements,0)}),a(0,s,"diffuseTexture",function(){return this._getTexture(1)},function(e){this._setTexture(1,e)}),a(0,s,"renderMode",null,function(e){switch(e){case 1:this.renderQueue=1,this.depthWrite=!0,this.cull=2,this.blend=0,this.alphaTest=!1;break;case 2:this.renderQueue=1,this.depthWrite=!0,this.cull=0,this.blend=0,this.alphaTest=!1;break;case 3:this.depthWrite=!0,this.cull=2,this.blend=0,this.renderQueue=1;break;case 13:this.renderQueue=2,this.depthWrite=!0,this.cull=2,this.blend=1,this.srcBlend=770,this.dstBlend=771;break;default:throw new Error("PBRMaterial:renderMode value error.")}}),a(0,s,"pbrInfoTexture",function(){return this._getTexture(3)},function(e){this._setTexture(3,e),this._addShaderDefine(t.SHADERDEFINE_HAS_PBRINFO)}),a(0,s,"testClipZ",null,function(e){this._addShaderDefine(t.SHADERDEFINE_TEST_CLIPZ)}),t.load=function(e){return n.loader.create(e,null,null,t)},t.DIFFUSETEXTURE=1,t.NORMALTEXTURE=2,t.PBRINFOTEXTURE=3,t.PBRLUTTEXTURE=4,t.UVANIAGE=5,t.MATERIALROUGHNESS=6,t.MATERIALMETALESS=7,t.UVMATRIX=8,t.UVAGE=9,t.AOOBJPOS=14,t.HSNOISETEXTURE=15,t.SHADERDEFINE_FIX_ROUGHNESS=0,t.SHADERDEFINE_FIX_METALESS=0,t.SHADERDEFINE_HAS_TANGENT=0,t.SHADERDEFINE_TEST_CLIPZ=0,t.SHADERDEFINE_HAS_PBRINFO=0,t.SHADERDEFINE_USE_GROUNDTRUTH=0,t.RENDERMODE_OPAQUE=1,t.RENDERMODE_OPAQUEDOUBLEFACE=2,t.RENDERMODE_CUTOUT=3,t.RENDERMODE_CUTOUTDOUBLEFACE=4,t.RENDERMODE_TRANSPARENT=13,t.pbrlutTex=null,t.HammersleyNoiseTex=null,i(t,["defaultMaterial",function(){return this.defaultMaterial=new t}]),t}(jt),pn=function(e){function t(){this._transformUV=null,t.__super.call(this),this.setShaderName("SIMPLE"),this._setColor(9,new ct(.6,.6,.6)),this._setColor(10,new ct(1,1,1)),this._setColor(11,new dt(1,1,1,8)),this._setColor(12,new ct(1,1,1)),this._setColor(7,new dt(1,1,1,1)),this._setNumber(0,.5),this._setColor(15,new dt(1,1,0,0)),this.renderMode=1}r(t,"laya.d3.core.material.StandardMaterial",e);var s=t.prototype;return s.disableLight=function(){this._addDisablePublicShaderDefine(pt.SHADERDEFINE_POINTLIGHT|pt.SHADERDEFINE_SPOTLIGHT|pt.SHADERDEFINE_DIRECTIONLIGHT)},s.disableFog=function(){this._addDisablePublicShaderDefine(pt.SHADERDEFINE_FOG)},s.onAsynLoaded=function(n,i,r){var a=i[0];if(a.version)e.prototype.onAsynLoaded.call(this,n,i,r);else{var s=i[1],o=a.props;for(var l in o)this[l]=o[l];t._parseStandardMaterial(s,this,a),this._endLoaded()}},s.cloneTo=function(t){e.prototype.cloneTo.call(this,t);var n=t;this._transformUV&&(n._transformUV=this._transformUV.clone())},a(0,s,"ambientColor",function(){return this._getColor(9)},function(e){this._setColor(9,e)}),a(0,s,"ambientTexture",function(){return this._getTexture(5)},function(e){e?this._addShaderDefine(laya.d3.core.material.StandardMaterial.SHADERDEFINE_AMBIENTMAP):this._removeShaderDefine(laya.d3.core.material.StandardMaterial.SHADERDEFINE_AMBIENTMAP),this._setTexture(5,e)}),a(0,s,"renderMode",null,function(e){switch(e){case 1:this.renderQueue=1,this.depthWrite=!0,this.cull=2,this.blend=0,this.alphaTest=!1;break;case 2:this.renderQueue=1,this.depthWrite=!0,this.cull=0,this.blend=0,this.alphaTest=!1;break;case 3:this.depthWrite=!0,this.cull=2,this.blend=0,this.renderQueue=1,this.alphaTest=!0;break;case 4:this.renderQueue=1,this.depthWrite=!0,this.cull=0,this.blend=0,this.alphaTest=!0;break;case 13:this.renderQueue=2,this.depthWrite=!0,this.cull=2,this.blend=1,this.srcBlend=770,this.dstBlend=771,this.alphaTest=!1;break;case 14:this.renderQueue=2,this.depthWrite=!0,this.cull=0,this.blend=1,this.srcBlend=770,this.dstBlend=771,this.alphaTest=!1;break;case 15:this.renderQueue=2,this.depthWrite=!0,this.cull=2,this.blend=1,this.srcBlend=770,this.dstBlend=1,this.alphaTest=!1;break;case 16:this.renderQueue=2,this.depthWrite=!0,this.cull=0,this.blend=1,this.srcBlend=770,this.dstBlend=1,this.alphaTest=!1;break;case 5:this.renderQueue=2,this.depthWrite=!1,this.cull=2,this.blend=1,this.srcBlend=770,this.dstBlend=771,this.alphaTest=!1;break;case 6:this.renderQueue=2,this.depthWrite=!1,this.cull=0,this.blend=1,this.srcBlend=770,this.dstBlend=771,this.alphaTest=!1;break;case 7:this.renderQueue=2,this.depthWrite=!1,this.cull=2,this.blend=1,this.srcBlend=770,this.dstBlend=1,this.alphaTest=!1;break;case 8:this.renderQueue=2,this.depthWrite=!1,this.cull=0,this.blend=1,this.srcBlend=770,this.dstBlend=1,this.alphaTest=!1;break;case 9:this.renderQueue=2,this.depthTest=!1,this.cull=2,this.blend=1,this.srcBlend=770,this.dstBlend=771,this.alphaTest=!1;break;case 10:this.renderQueue=2,this.depthTest=!1,this.cull=0,this.blend=1,this.srcBlend=770,this.dstBlend=771,this.alphaTest=!1;break;case 11:this.renderQueue=2,this.depthTest=!1,this.cull=2,this.blend=1,this.srcBlend=770,this.dstBlend=1,this.alphaTest=!1;break;case 12:this.renderQueue=2,this.depthTest=!1,this.cull=0,this.blend=1,this.srcBlend=770,this.dstBlend=1,this.alphaTest=!1;break;default:throw new Error("Material:renderMode value error.")}this._conchMaterial&&this._conchMaterial.setRenderMode(e)}),a(0,s,"normalTexture",function(){return this._getTexture(2)},function(e){e?this._addShaderDefine(laya.d3.core.material.StandardMaterial.SHADERDEFINE_NORMALMAP):this._removeShaderDefine(laya.d3.core.material.StandardMaterial.SHADERDEFINE_NORMALMAP),this._setTexture(2,e)}),a(0,s,"reflectColor",function(){return this._getColor(12)},function(e){this._setColor(12,e)}),a(0,s,"tilingOffset",function(){return this._getColor(15)},function(e){if(e){var t=e.elements;1!=t[0]||1!=t[1]||0!=t[2]||0!=t[3]?this._addShaderDefine(laya.d3.core.material.StandardMaterial.SHADERDEFINE_TILINGOFFSET):this._removeShaderDefine(laya.d3.core.material.StandardMaterial.SHADERDEFINE_TILINGOFFSET)}else this._removeShaderDefine(laya.d3.core.material.StandardMaterial.SHADERDEFINE_TILINGOFFSET);this._setColor(15,e)}),a(0,s,"albedo",function(){return this._getColor(7)},function(e){this._setColor(7,e)}),a(0,s,"diffuseColor",function(){return this._getColor(10)},function(e){this._setColor(10,e)}),a(0,s,"specularColor",function(){return this._getColor(11)},function(e){this._setColor(11,e)}),a(0,s,"diffuseTexture",function(){return this._getTexture(1)},function(e){e?this._addShaderDefine(laya.d3.core.material.StandardMaterial.SHADERDEFINE_DIFFUSEMAP):this._removeShaderDefine(laya.d3.core.material.StandardMaterial.SHADERDEFINE_DIFFUSEMAP),this._setTexture(1,e)}),a(0,s,"specularTexture",function(){return this._getTexture(3)},function(e){e?this._addShaderDefine(laya.d3.core.material.StandardMaterial.SHADERDEFINE_SPECULARMAP):this._removeShaderDefine(laya.d3.core.material.StandardMaterial.SHADERDEFINE_SPECULARMAP),this._setTexture(3,e)}),a(0,s,"emissiveTexture",function(){return this._getTexture(4)},function(e){e?this._addShaderDefine(laya.d3.core.material.StandardMaterial.SHADERDEFINE_EMISSIVEMAP):this._removeShaderDefine(laya.d3.core.material.StandardMaterial.SHADERDEFINE_EMISSIVEMAP),this._setTexture(4,e)}),a(0,s,"reflectTexture",function(){return this._getTexture(6)},function(e){e?this._addShaderDefine(laya.d3.core.material.StandardMaterial.SHADERDEFINE_REFLECTMAP):this._removeShaderDefine(laya.d3.core.material.StandardMaterial.SHADERDEFINE_REFLECTMAP),this._setTexture(6,e)}),a(0,s,"transformUV",function(){return this._transformUV},function(e){this._transformUV=e,this._setMatrix4x4(13,e.matrix),e?this._addShaderDefine(laya.d3.core.material.StandardMaterial.SHADERDEFINE_UVTRANSFORM):this._removeShaderDefine(laya.d3.core.material.StandardMaterial.SHADERDEFINE_UVTRANSFORM),this._conchMaterial&&this._conchMaterial.setShaderValue(13,e.matrix.elements,0)}),t.load=function(e){return n.loader.create(e,null,null,t)},t._parseStandardMaterial=function(e,t,n){var i=n.customProps,r=i.ambientColor;t.ambientColor=new ct(r[0],r[1],r[2]);var a=i.diffuseColor;t.diffuseColor=new ct(a[0],a[1],a[2]);var s=i.specularColor;t.specularColor=new dt(s[0],s[1],s[2],s[3]);var o=i.reflectColor;t.reflectColor=new ct(o[0],o[1],o[2]);var l=i.albedoColor;l&&(t.albedo=new dt(l[0],l[1],l[2],l[3]));var h=i.diffuseTexture.texture2D;h&&(t.diffuseTexture=x.getRes(e[h]));var _=i.normalTexture.texture2D;_&&(t.normalTexture=x.getRes(e[_]));var u=i.specularTexture.texture2D;u&&(t.specularTexture=x.getRes(e[u]));var c=i.emissiveTexture.texture2D;c&&(t.emissiveTexture=x.getRes(e[c]));var d=i.ambientTexture.texture2D;d&&(t.ambientTexture=x.getRes(e[d]));var f=i.reflectTexture.texture2D;f&&(t.reflectTexture=x.getRes(e[f]))},t.RENDERMODE_OPAQUE=1,t.RENDERMODE_OPAQUEDOUBLEFACE=2,t.RENDERMODE_CUTOUT=3,t.RENDERMODE_CUTOUTDOUBLEFACE=4,t.RENDERMODE_TRANSPARENT=13,t.RENDERMODE_TRANSPARENTDOUBLEFACE=14,t.RENDERMODE_ADDTIVE=15,t.RENDERMODE_ADDTIVEDOUBLEFACE=16,t.RENDERMODE_DEPTHREAD_TRANSPARENT=5,t.RENDERMODE_DEPTHREAD_TRANSPARENTDOUBLEFACE=6,t.RENDERMODE_DEPTHREAD_ADDTIVE=7,t.RENDERMODE_DEPTHREAD_ADDTIVEDOUBLEFACE=8,t.RENDERMODE_NONDEPTH_TRANSPARENT=9,t.RENDERMODE_NONDEPTH_TRANSPARENTDOUBLEFACE=10,t.RENDERMODE_NONDEPTH_ADDTIVE=11,t.RENDERMODE_NONDEPTH_ADDTIVEDOUBLEFACE=12,t.SHADERDEFINE_DIFFUSEMAP=0,t.SHADERDEFINE_NORMALMAP=0,t.SHADERDEFINE_SPECULARMAP=0,t.SHADERDEFINE_EMISSIVEMAP=0,t.SHADERDEFINE_AMBIENTMAP=0,t.SHADERDEFINE_REFLECTMAP=0,t.SHADERDEFINE_UVTRANSFORM=0,t.SHADERDEFINE_TILINGOFFSET=0,t.DIFFUSETEXTURE=1,t.NORMALTEXTURE=2,t.SPECULARTEXTURE=3,t.EMISSIVETEXTURE=4,t.AMBIENTTEXTURE=5,t.REFLECTTEXTURE=6,t.ALBEDO=7,t.UVANIAGE=8,t.MATERIALAMBIENT=9,t.MATERIALDIFFUSE=10,t.MATERIALSPECULAR=11,t.MATERIALREFLECT=12,t.UVMATRIX=13,t.UVAGE=14,t.TILINGOFFSET=15,i(t,["defaultMaterial",function(){return this.defaultMaterial=new t}]),t}(jt),vn=function(e){function t(){this._diffuseScale1=null,this._diffuseScale2=null,this._diffuseScale3=null,this._diffuseScale4=null,t.__super.call(this),this.setShaderName("Terrain"),this.renderMode=1,this._diffuseScale1=new ut,this._diffuseScale2=new ut,this._diffuseScale3=new ut,this._diffuseScale4=new ut,this.ambientColor=new ct(.6,.6,.6),this.diffuseColor=new ct(1,1,1),this.specularColor=new dt(.2,.2,.2,32)}r(t,"laya.d3.core.material.TerrainMaterial",e);var s=t.prototype;return s.setDiffuseScale1=function(e,t){this._diffuseScale1.x=e,this._diffuseScale1.y=t,this._setColor(6,this._diffuseScale1)},s.setDiffuseScale2=function(e,t){this._diffuseScale2.x=e,this._diffuseScale2.y=t,this._setColor(7,this._diffuseScale2)},s.setDiffuseScale3=function(e,t){this._diffuseScale3.x=e,this._diffuseScale3.y=t,this._setColor(8,this._diffuseScale3)},s.setDiffuseScale4=function(e,t){this._diffuseScale4.x=e,this._diffuseScale4.y=t,this._setColor(9,this._diffuseScale4)},s.setDetailNum=function(e){switch(e){case 1:this._addShaderDefine(laya.d3.core.material.TerrainMaterial.SHADERDEFINE_DETAIL_NUM1),this._removeShaderDefine(laya.d3.core.material.TerrainMaterial.SHADERDEFINE_DETAIL_NUM2),this._removeShaderDefine(laya.d3.core.material.TerrainMaterial.SHADERDEFINE_DETAIL_NUM3),this._removeShaderDefine(laya.d3.core.material.TerrainMaterial.SHADERDEFINE_DETAIL_NUM4);break;case 2:this._addShaderDefine(laya.d3.core.material.TerrainMaterial.SHADERDEFINE_DETAIL_NUM2),this._removeShaderDefine(laya.d3.core.material.TerrainMaterial.SHADERDEFINE_DETAIL_NUM1),this._removeShaderDefine(laya.d3.core.material.TerrainMaterial.SHADERDEFINE_DETAIL_NUM3),this._removeShaderDefine(laya.d3.core.material.TerrainMaterial.SHADERDEFINE_DETAIL_NUM4);break;case 3:this._addShaderDefine(laya.d3.core.material.TerrainMaterial.SHADERDEFINE_DETAIL_NUM3),this._removeShaderDefine(laya.d3.core.material.TerrainMaterial.SHADERDEFINE_DETAIL_NUM1),this._removeShaderDefine(laya.d3.core.material.TerrainMaterial.SHADERDEFINE_DETAIL_NUM2),this._removeShaderDefine(laya.d3.core.material.TerrainMaterial.SHADERDEFINE_DETAIL_NUM4);break;case 4:this._addShaderDefine(laya.d3.core.material.TerrainMaterial.SHADERDEFINE_DETAIL_NUM4),this._removeShaderDefine(laya.d3.core.material.TerrainMaterial.SHADERDEFINE_DETAIL_NUM1),this._removeShaderDefine(laya.d3.core.material.TerrainMaterial.SHADERDEFINE_DETAIL_NUM2),this._removeShaderDefine(laya.d3.core.material.TerrainMaterial.SHADERDEFINE_DETAIL_NUM3)}},s.disableLight=function(){this._addDisablePublicShaderDefine(pt.SHADERDEFINE_POINTLIGHT|pt.SHADERDEFINE_SPOTLIGHT|pt.SHADERDEFINE_DIRECTIONLIGHT)},s.setShaderName=function(t){e.prototype.setShaderName.call(this,t)},a(0,s,"renderMode",null,function(e){switch(e){case 1:this.renderQueue=1,this.depthWrite=!0,this.depthTest=!0,this.cull=2,this.blend=0,this.depthFunc=513;break;case 2:this.renderQueue=1,this.depthWrite=!1,this.depthTest=!0,this.cull=2,this.blend=1,this.srcBlend=770,this.dstBlend=771,this.depthFunc=515;break;default:throw new Error("TerrainMaterial:renderMode value error.")}this._conchMaterial&&this._conchMaterial.setRenderMode(e)}),a(0,s,"diffuseTexture2",function(){return this._getTexture(3)},function(e){this._setTexture(3,e)}),a(0,s,"ambientColor",function(){return this._getColor(10)},function(e){this._setColor(10,e)}),a(0,s,"diffuseTexture4",function(){return this._getTexture(5)},function(e){this._setTexture(5,e)}),a(0,s,"diffuseColor",function(){return this._getColor(11)},function(e){this._setColor(11,e)}),a(0,s,"diffuseTexture1",function(){return this._getTexture(2)},function(e){this._setTexture(2,e)}),a(0,s,"specularColor",function(){return this._getColor(12)},function(e){this._setColor(12,e)}),a(0,s,"diffuseTexture3",function(){return this._getTexture(4)},function(e){this._setTexture(4,e)}),a(0,s,"splatAlphaTexture",function(){return this._getTexture(0)},function(e){this._setTexture(0,e)}),a(0,s,"normalTexture",function(){return this._getTexture(1)},function(e){this._setTexture(1,e)}),t.load=function(e){return n.loader.create(e,null,null,t)},t.RENDERMODE_OPAQUE=1,t.RENDERMODE_TRANSPARENT=2,t.SPLATALPHATEXTURE=0,t.NORMALTEXTURE=1,t.DIFFUSETEXTURE1=2,t.DIFFUSETEXTURE2=3,t.DIFFUSETEXTURE3=4,t.DIFFUSETEXTURE4=5,t.DIFFUSESCALE1=6,t.DIFFUSESCALE2=7,t.DIFFUSESCALE3=8,t.DIFFUSESCALE4=9,t.MATERIALAMBIENT=10,t.MATERIALDIFFUSE=11,t.MATERIALSPECULAR=12,t.SHADERDEFINE_DETAIL_NUM1=0,t.SHADERDEFINE_DETAIL_NUM2=0,t.SHADERDEFINE_DETAIL_NUM3=0,t.SHADERDEFINE_DETAIL_NUM4=0,i(t,["defaultMaterial",function(){return this.defaultMaterial=new t}]),t}(jt),gn=function(e){function t(){this._useVertexDeep=!1,t.__super.call(this),this.setShaderName("Water")}r(t,"laya.d3.core.material.WaterMaterial",e);var s=t.prototype;return s.disableFog=function(){this._addDisablePublicShaderDefine(pt.SHADERDEFINE_FOG)},s.onAsynLoaded=function(t,n,i){e.prototype.onAsynLoaded.call(this,t,n,i)},a(0,s,"diffuseTexture",function(){return this._getTexture(1)},function(e){this._setTexture(1,e)}),a(0,s,"normalTexture",function(){return this._getTexture(2)},function(e){this._setTexture(2,e)}),a(0,s,"underWaterTexture",function(){return this._getTexture(3)},function(e){this._setTexture(3,e)}),a(0,s,"deepColorTexture",function(){return this._getTexture(10)},function(e){this._setTexture(10,e)}),a(0,s,"useFoam",null,function(e){e?this._addShaderDefine(t.SHADERDEFINE_USE_FOAM):this._removeShaderDefine(t.SHADERDEFINE_USE_FOAM)}),a(0,s,"skyTexture",function(){return this._getTexture(11)},function(e){this._setTexture(11,e)}),a(0,s,"deepScale",function(){return this._getNumber(20)},function(e){this._setNumber(20,e)}),a(0,s,"detailTexture",function(){return this._getTexture(9)},function(e){this._setTexture(9,e)}),a(0,s,"foamTexture",function(){return this._getTexture(17)},function(e){this._setTexture(17,e)}),a(0,s,"waterInfoTexture",function(){return this._getTexture(16)},function(e){this._setTexture(16,e)}),a(0,s,"vertexDispTexture",function(){return this._getTexture(4)},function(e){this._setTexture(4,e)}),a(0,s,"currentTm",function(){return this._getNumber(8)},function(e){this._setNumber(8,e)}),a(0,s,"waveInfo",function(){return this._getBuffer(12)},function(e){this._setBuffer(12,e)}),a(0,s,"waveInfoD",function(){return this._getBuffer(13)},function(e){this._setBuffer(13,e)}),a(0,s,"waveMainDir",function(){return this._getNumber(14)},function(e){this._setNumber(14,e*Math.PI/180)}),a(0,s,"geoWaveUVScale",function(){return this._getNumber(18)},function(e){this._setNumber(18,e)}),a(0,s,"windSpeed",function(){return 0},function(e){}),a(0,s,"scrsize",null,function(e){this._setBuffer(15,e)}),a(0,s,"seaColor",function(){return this._getBuffer(19)},function(e){this._setBuffer(19,e)}),a(0,s,"useVertexDeep",function(){return this._useVertexDeep},function(e){this._useVertexDeep=e,e?this._addShaderDefine(t.SHADERDEFINE_USEVERTEXHEIGHT):this._removeShaderDefine(t.SHADERDEFINE_USEVERTEXHEIGHT)}),a(0,s,"windDir",function(){return 0},function(e){}),a(0,s,"useRefractTexture",null,function(e){e?this._addShaderDefine(t.SHADERDEFINE_USE_REFRACT_TEX):this._removeShaderDefine(t.SHADERDEFINE_USE_REFRACT_TEX)}),a(0,s,"renderMode",null,function(e){switch(e){case 1:this.renderQueue=1,this.depthWrite=!0,this.cull=2,this.blend=0,this.alphaTest=!1;break;case 2:this.renderQueue=1,this.depthWrite=!0,this.cull=0,this.blend=0,this.alphaTest=!1;break;case 3:this.depthWrite=!0,this.cull=2,this.blend=0,this.renderQueue=1;break;case 13:this.renderQueue=2,this.depthWrite=!0,this.cull=2,this.blend=1,this.srcBlend=770,this.dstBlend=771;break;default:throw new Error("PBRMaterial:renderMode value error.")}}),t.load=function(e){return n.loader.create(e,null,null,t)},t.DIFFUSETEXTURE=1,t.NORMALTEXTURE=2,t.UNDERWATERTEXTURE=3,t.VERTEXDISPTEXTURE=4,t.UVANIAGE=5,t.UVMATRIX=6,t.UVAGE=7,t.CURTM=8,t.DETAILTEXTURE=9,t.DEEPCOLORTEXTURE=10,t.SKYTEXTURE=11,t.WAVEINFO=12,t.WAVEINFOD=13,t.WAVEMAINDIR=14,t.SCRSIZE=15,t.WATERINFO=16,t.FOAMTEXTURE=17,t.GEOWAVE_UV_SCALE=18,t.SEA_COLOR=19,t.WAVEINFODEEPSCALE=20,t.SHADERDEFINE_SHOW_NORMAL=0,t.SHADERDEFINE_CUBE_ENV=0,t.SHADERDEFINE_HDR_ENV=0,t.SHADERDEFINE_USE_FOAM=0,t.SHADERDEFINE_USE_REFRACT_TEX=0,t.SHADERDEFINE_USEVERTEXHEIGHT=0,t.RENDERMODE_OPAQUE=1,t.RENDERMODE_OPAQUEDOUBLEFACE=2,t.RENDERMODE_CUTOUT=3,t.RENDERMODE_CUTOUTDOUBLEFACE=4,t.RENDERMODE_TRANSPARENT=13,i(t,["defaultMaterial",function(){return this.defaultMaterial=new t}]),t}(jt),xn=function(e){function t(e,n,i,r){this._indexType=null,this._indexTypeByteCount=0,this._indexCount=0,this._canRead=!1,void 0===i&&(i=35044),void 0===r&&(r=!1),t.__super.call(this),this._indexType=e,this._indexCount=n,this._bufferUsage=i,this._bufferType=34963,this._canRead=r;var a=0;if("ushort"==e)this._indexTypeByteCount=2;else{if("ubyte"!=e)throw new Error("unidentification index type.");this._indexTypeByteCount=1}a=this._indexTypeByteCount*n,this._byteLength=a,T.isConchNode||(this._bind(),d._gl.bufferData(this._bufferType,a,this._bufferUsage)),r?("ushort"==e?this._buffer=new Uint16Array(n):"ubyte"==e&&(this._buffer=new Uint8Array(n)),this.memorySize=2*a):this.memorySize=a}r(t,"laya.d3.graphics.IndexBuffer3D",e);var n=t.prototype;return n.setData=function(e,t,n,i){void 0===t&&(t=0),void 0===n&&(n=0),void 0===i&&(i=4294967295);var r=0;if("ushort"==this._indexType?(r=2,0===n&&4294967295===i||(e=new Uint16Array(e.buffer,n*r,i))):"ubyte"==this._indexType&&(r=1,0===n&&4294967295===i||(e=new Uint8Array(e.buffer,n*r,i))),T.isConchNode||(this._bind(),d._gl.bufferSubData(this._bufferType,t*r,e)),this._canRead)if(0!==t||0!==n||4294967295!==i){var a=this._buffer.length-t;i>a&&(i=a);for(var s=0;s<i;s++)this._buffer[t+s]=e[s]}else this._buffer=e},n.getData=function(){if(this._canRead)return this._buffer;throw new Error("Can't read data from VertexBuffer with only write flag!")},n.detoryResource=function(){e.prototype.detoryResource.call(this),this._buffer=null,this.memorySize=0},a(0,n,"indexType",function(){return this._indexType}),a(0,n,"indexTypeByteCount",function(){return this._indexTypeByteCount}),a(0,n,"indexCount",function(){return this._indexCount}),a(0,n,"canRead",function(){return this._canRead}),t.INDEXTYPE_UBYTE="ubyte",t.INDEXTYPE_USHORT="ushort",t.create=function(e,n,i,r){return void 0===i&&(i=35044),void 0===r&&(r=!1),new t(e,n,i,r)},t}(d),En=function(e){function t(e,n,i,r){this._vertexDeclaration=null,this._vertexCount=0,this._canRead=!1,void 0===r&&(r=!1),t.__super.call(this),this._vertexDeclaration=e,this._vertexCount=n,this._bufferUsage=i,this._bufferType=34962,this._canRead=r,this.memorySize=this._byteLength=this._vertexDeclaration.vertexStride*n,T.isConchNode||(this._bind(),d._gl.bufferData(this._bufferType,this._byteLength,this._bufferUsage)),r&&(this._buffer=new Float32Array(this._byteLength/4))}r(t,"laya.d3.graphics.VertexBuffer3D",e);var n=t.prototype;return n.bindWithIndexBuffer=function(e){e&&e._bind(),this._bind()},n.setData=function(e,t,n,i){if(void 0===t&&(t=0),void 0===n&&(n=0),void 0===i&&(i=4294967295),0===n&&4294967295===i||(e=new Float32Array(e.buffer,4*n,i)),T.isConchNode||(this._bind(),d._gl.bufferSubData(this._bufferType,4*t,e)),this._canRead)if(0!==t||0!==n||4294967295!==i){var r=this._buffer.length-t;i>r&&(i=r);for(var a=0;a<i;a++)this._buffer[t+a]=e[a]}else this._buffer=e},n.getData=function(){if(this._canRead)return this._buffer;throw new Error("Can't read data from VertexBuffer with only write flag!")},n.detoryResource=function(){for(var t=N.mainContext,n=this._vertexDeclaration.getVertexElements(),i=d._enableAtributes,r=0,a=n.length;r<a;r++)i[r]===this._glBuffer&&(t.disableVertexAttribArray(r),i[r]=null);e.prototype.detoryResource.call(this),this._buffer=null,this._vertexDeclaration=null,this.memorySize=0},a(0,n,"vertexDeclaration",function(){return this._vertexDeclaration}),a(0,n,"vertexCount",function(){return this._vertexCount}),a(0,n,"canRead",function(){return this._canRead}),t.create=function(e,n,i,r){return void 0===i&&(i=35044),void 0===r&&(r=!1),new t(e,n,i,r)},t}(d),Sn=function(e){function t(){t.__super.call(this),this.setShaderName("PARTICLESHURIKEN"),this.renderMode=6}r(t,"laya.d3.core.particleShuriKen.ShurikenParticleMaterial",e);var s=t.prototype;return s.onAsynLoaded=function(n,i,r){var a=i[0];if(a.version)e.prototype.onAsynLoaded.call(this,n,i,r);else{var s=i[1],o=a.props;for(var l in o)this[l]=o[l];t._parseShurikenParticleMaterial(s,this,a),this._endLoaded()}},a(0,s,"renderMode",null,function(e){switch(e){case 1:this.renderQueue=1,this.depthWrite=!0,this.cull=2,this.blend=0,this.alphaTest=!1,this._removeShaderDefine(t.SHADERDEFINE_ADDTIVEFOG);break;case 2:this.renderQueue=1,this.depthWrite=!0,this.cull=0,this.blend=0,this.alphaTest=!1,this._removeShaderDefine(t.SHADERDEFINE_ADDTIVEFOG);break;case 3:this.depthWrite=!0,this.cull=2,this.blend=0,this.renderQueue=1,this.alphaTest=!0,this._removeShaderDefine(t.SHADERDEFINE_ADDTIVEFOG);break;case 4:this.renderQueue=1,this.depthWrite=!0,this.cull=0,this.blend=0,this.alphaTest=!0,this._removeShaderDefine(t.SHADERDEFINE_ADDTIVEFOG);break;case 13:this.renderQueue=2,this.depthWrite=!0,this.cull=2,this.blend=1,this.srcBlend=770,this.dstBlend=771,this.alphaTest=!1,this._removeShaderDefine(t.SHADERDEFINE_ADDTIVEFOG);break;case 14:this.renderQueue=2,this.depthWrite=!0,this.cull=0,this.blend=1,this.srcBlend=770,this.dstBlend=771,this.alphaTest=!1,this._removeShaderDefine(t.SHADERDEFINE_ADDTIVEFOG);break;case 15:this.renderQueue=2,this.depthWrite=!0,this.cull=2,this.blend=1,this.srcBlend=770,this.dstBlend=1,this.alphaTest=!1,this._addShaderDefine(t.SHADERDEFINE_ADDTIVEFOG);break;case 16:this.renderQueue=2,this.depthWrite=!0,this.cull=0,this.blend=1,this.srcBlend=770,this.dstBlend=1,this.alphaTest=!1,this._addShaderDefine(t.SHADERDEFINE_ADDTIVEFOG);break;case 5:this.renderQueue=2,this.depthWrite=!1,this.cull=2,this.blend=1,this.srcBlend=770,this.dstBlend=771,this.alphaTest=!1,this._removeShaderDefine(t.SHADERDEFINE_ADDTIVEFOG);break;case 6:this.renderQueue=2,this.depthWrite=!1,this.cull=0,this.blend=1,this.srcBlend=770,this.dstBlend=771,this.alphaTest=!1,this._removeShaderDefine(t.SHADERDEFINE_ADDTIVEFOG);break;case 7:this.renderQueue=2,this.depthWrite=!1,this.cull=2,this.blend=1,this.srcBlend=770,this.dstBlend=1,this.alphaTest=!1,this._addShaderDefine(t.SHADERDEFINE_ADDTIVEFOG);break;case 8:this.renderQueue=2,this.depthWrite=!1,this.cull=0,this.blend=1,this.srcBlend=770,this.dstBlend=1,this.alphaTest=!1,this._addShaderDefine(t.SHADERDEFINE_ADDTIVEFOG);break;case 9:this.renderQueue=2,this.depthTest=!1,this.cull=2,this.blend=1,this.srcBlend=770,this.dstBlend=771,this.alphaTest=!1,this._removeShaderDefine(t.SHADERDEFINE_ADDTIVEFOG);break;case 10:this.renderQueue=2,this.depthTest=!1,this.cull=0,this.blend=1,this.srcBlend=770,this.dstBlend=771,this.alphaTest=!1,this._removeShaderDefine(t.SHADERDEFINE_ADDTIVEFOG);break;case 11:this.renderQueue=2,this.depthTest=!1,this.cull=2,this.blend=1,this.srcBlend=770,this.dstBlend=1,this.alphaTest=!1,this._addShaderDefine(t.SHADERDEFINE_ADDTIVEFOG);break;case 12:this.renderQueue=2,this.depthTest=!1,this.cull=0,this.blend=1,this.srcBlend=770,this.dstBlend=1,this.alphaTest=!1,this._addShaderDefine(t.SHADERDEFINE_ADDTIVEFOG);break;default:throw new Error("Material:renderMode value error.")}this._conchMaterial&&this._conchMaterial.setRenderMode(e)}),a(0,s,"tintColor",function(){return this._getColor(2)},function(e){e?this._addShaderDefine(laya.d3.core.particleShuriKen.ShurikenParticleMaterial.SHADERDEFINE_TINTCOLOR):this._removeShaderDefine(laya.d3.core.particleShuriKen.ShurikenParticleMaterial.SHADERDEFINE_TINTCOLOR),this._setColor(2,e)}),a(0,s,"diffuseTexture",function(){return this._getTexture(0)},function(e){e?this._addShaderDefine(laya.d3.core.particleShuriKen.ShurikenParticleMaterial.SHADERDEFINE_DIFFUSEMAP):this._removeShaderDefine(laya.d3.core.particleShuriKen.ShurikenParticleMaterial.SHADERDEFINE_DIFFUSEMAP),this._setTexture(1,e)}),t.load=function(e){return n.loader.create(e,null,null,t)},t._parseShurikenParticleMaterial=function(e,t,n){var i=n.customProps,r=i.diffuseTexture.texture2D;r&&(t.diffuseTexture=x.getRes(e[r]));var a=i.tintColor;a&&(t.tintColor=new dt(a[0],a[1],a[2],a[3]))},t.RENDERMODE_OPAQUE=1,t.RENDERMODE_OPAQUEDOUBLEFACE=2,t.RENDERMODE_CUTOUT=3,t.RENDERMODE_CUTOUTDOUBLEFACE=4,t.RENDERMODE_TRANSPARENT=13,t.RENDERMODE_TRANSPARENTDOUBLEFACE=14,t.RENDERMODE_ADDTIVE=15,t.RENDERMODE_ADDTIVEDOUBLEFACE=16,t.RENDERMODE_DEPTHREAD_TRANSPARENT=5,t.RENDERMODE_DEPTHREAD_TRANSPARENTDOUBLEFACE=6,t.RENDERMODE_DEPTHREAD_ADDTIVE=7,t.RENDERMODE_DEPTHREAD_ADDTIVEDOUBLEFACE=8,t.RENDERMODE_NONDEPTH_TRANSPARENT=9,t.RENDERMODE_NONDEPTH_TRANSPARENTDOUBLEFACE=10,t.RENDERMODE_NONDEPTH_ADDTIVE=11,t.RENDERMODE_NONDEPTH_ADDTIVEDOUBLEFACE=12,t.SHADERDEFINE_DIFFUSEMAP=0,t.SHADERDEFINE_TINTCOLOR=0,t.SHADERDEFINE_ADDTIVEFOG=0,t.DIFFUSETEXTURE=1,t.TINTCOLOR=2,t._diffuseTextureIndex=0,i(t,["defaultMaterial",function(){return this.defaultMaterial=new t}]),t}(jt),Dn=function(e){function t(){this._startTm=0,t.__super.call(this),laya.d3.water.WaterDetailMaterial.init(),this.setShaderName("WaterDetail"),this.cull=0,this._startTm=n.timer.currTimer}r(t,"laya.d3.water.WaterDetailMaterial",jt);var i=t.prototype;return a(0,i,"currentTm",function(){return this._getNumber(1)},function(e){this._setNumber(1,e-this._startTm)}),a(0,i,"waveInfo",function(){return this._getBuffer(12)},function(e){this._setBuffer(12,e)}),a(0,i,"waveInfoD",function(){return this._getBuffer(13)},function(e){this._setBuffer(13,e)}),a(0,i,"texWaveUVScale",function(){return this._getNumber(15)},function(e){this._setNumber(15,e)}),t.init=function(){if(!laya.d3.water.WaterDetailMaterial._bInited){laya.d3.water.WaterDetailMaterial._bInited=!0;var e=cn.nameKey.add("WaterDetail");pt.add(e,"\nattribute vec3 a_position;\nattribute vec3 a_normal;\nattribute vec2 uv;\n\nvarying vec2 vUv;\nvarying vec3 vWorldNorm;\nvarying vec3 vWorldTangent;\nvarying vec3 vWorldBinormal;\n\n\nvoid main() {\n\tvec3 pos = a_position;\n\tif(pos.z!=0.)pos.y=pos.z;\n\tpos.z=0.5;\n\tgl_Position = vec4(pos,1.);\n    vUv = uv;\n\t//vWorldNorm = normalize((modelMat*vec4(a_normal,0.0)).xyz);\n\t//vWorldTangent = normalize((modelMat*vec4(tangent,0.0)).xyz);\n\t//vWorldBinormal = normalize((modelMat*vec4(binormal,0.0)).xyz);\n}\n",'precision highp float;\nprecision lowp int;\n\nconst float PI = 3.14159265358979323846264;\nconst float _2PI = 6.2831853071796;\nvarying vec2 vUv;\nvarying vec3 vWorldNorm;\nvarying vec3 vWorldTangent;\nvarying vec3 vWorldBinormal;\n\nuniform float u_curTm;\n\n#include "WaveFunction.glsl"\n\nvoid main() {\n\tvec3 wave_N,wave_B,wave_T;\n\tcalcWave(u_curTm, vUv,wave_B,wave_T,wave_N);\n\tgl_FragColor.rgb = normalize(wave_N)*0.5+vec3(0.5);// vec3(0.1,.4,0.1);\n    gl_FragColor.a = 1.0;\n}\n',{a_position:0,a_normal:3,uv:2},{u_curTm:[1,1],u_WaveInfo:[12,1],u_WaveInfoD:[13,1],TEXWAVE_UV_SCALE:[15,1]})}},t.CURTM=1,t.WAVEINFO=12,t.WAVEINFOD=13,t.WAVEMAINDIR=14,t.TEXWAVE_UV_SCALE=15,t._bInited=!1,t}(),Tn=(function(e){function t(){this._animationSprites=null,this._animationSpritesInitLocalMatrix=null,this._tempCurAnimationData=null,this._curOriginalData=null,this._lastFrameIndex=-1,this._curAnimationDatas=null,t.__super.call(this),this._animationSprites=[],this._animationSpritesInitLocalMatrix=[]}r(t,"laya.d3.component.animation.RigidAnimations",e);var i=t.prototype;i._init=function(){for(var e=this._templet.getNodes(this.currentAnimationClipIndex),t=this._owner,n=e.length,i=0,r=new Uint16Array(this._templet.getPublicExtData()),a=0;a<n;a++){var s=r.slice(i+1,i+1+r[i]);i+=r[i]+1;for(var o=1;o<s.length;o++){s[o];t=t._childs[s[o]]}var l=t.getChildByName(e[a].name);if(!l)break;this._animationSprites[a]=l;var h=this._animationSpritesInitLocalMatrix[a];h||(h=this._animationSpritesInitLocalMatrix[a]=new at),l.transform.localMatrix.cloneTo(h),t=this._owner}},i._animtionPlay=function(){this._templet.loaded?this._init():this._templet.once("loaded",this,this._init)},i._animtionStop=function(){if(this._lastFrameIndex=-1,this._player.returnToZeroStopped){this._curAnimationDatas=null;for(var e=0;e<this._animationSprites.length;e++)this._animationSprites[e].transform.localMatrix=this._animationSpritesInitLocalMatrix[e]}},i._effectAnimation=function(e){for(var t=0,n=this._animationSprites.length;t<n;t++){for(var i=this._animationSprites[t],r=i.transform.localMatrix,a=r.elements,s=0;s<16;s++)a[s]=this._curAnimationDatas[16*t+s];i.transform.localMatrix=r}},i._load=function(t){e.prototype._load.call(this,t),this._player.on("stopped",this,this._animtionStop),this._player.on("played",this,this._animtionPlay)},i._update=function(e){if(2===this._player.state&&this._templet&&this._templet.loaded){var t=this._player.playbackRate*n.timer.scale,i=this._player.cachePlayRate,r=this._player.isCache&&t>=i,a=r?this.currentFrameIndex:-1;if(-1===a||this._lastFrameIndex!==a){var s=this.currentAnimationClipIndex,o=this._templet.getNodes(s),l=this._templet._animationDatasCache;if(r){var h=this._templet.getAnimationDataWithCache(i,l,s,a);if(h)return this._curAnimationDatas=h,this._lastFrameIndex=a,void this._effectAnimation(o)}var _=16*o.length;r?this._curAnimationDatas=new Float32Array(_):(this._tempCurAnimationData||(this._tempCurAnimationData=new Float32Array(_)),this._curAnimationDatas=this._tempCurAnimationData),this._curOriginalData||(this._curOriginalData=new Float32Array(this._templet.getTotalkeyframesLength(s))),r?this._templet.getOriginalData(s,this._curOriginalData,this._player._fullFrames[s],a,this._player.currentFrameTime):this._templet.getOriginalDataUnfixedRate(s,this._curOriginalData,this._player.currentPlayTime),Ct._computeRootAnimationData(o,this._curOriginalData,this._curAnimationDatas),r&&this._templet.setAnimationDataWithCache(i,l,s,a,this._curAnimationDatas),this._lastFrameIndex=a,this._effectAnimation(o)}}},i._unload=function(t){e.prototype._unload.call(this,t),this._animationSprites=null,this._animationSpritesInitLocalMatrix=null,this._tempCurAnimationData=null,this._curOriginalData=null,this._curAnimationDatas=null},a(0,i,"url",null,function(e){console.log("Warning: discard property,please use templet property instead.");var t=n.loader.create(e,null,null,l);this._templet!==t&&(0!==this._player.state&&this._player.stop(!0),this._templet=t,this._player.templet=t,this._curOriginalData=null,this._curAnimationDatas=null,this._tempCurAnimationData=null,this._templet._animationDatasCache||(this._templet._animationDatasCache=[]),this.event("animationchanged",this))}),a(0,i,"templet",e.prototype._$get_templet,function(e){this._templet!==e&&(0!==this._player.state&&this._player.stop(!0),this._templet=e,this._player.templet=e,this._curOriginalData=null,this._curAnimationDatas=null,this._tempCurAnimationData=null,this._templet._animationDatasCache||(this._templet._animationDatasCache=[]),this.event("animationchanged",this))})}($t),function(e){function t(){this._tempCurAnimationData=null,this._tempCurBonesData=null,this._curOriginalData=null,this._lastFrameIndex=-1,this._curMeshAnimationData=null,this._curBonesDatas=null,this._curAnimationDatas=null,this._ownerMesh=null,this._boneIndexToMeshList=null,this._oldVersion=!1,t.__super.call(this),this._boneIndexToMeshList=[]}r(t,"laya.d3.component.animation.SkinAnimations",e);var i=t.prototype;return i._computeBoneIndexToMeshOnTemplet=function(){this._templet.loaded?this._computeBoneIndexToMeshOnMesh():this._templet.once("loaded",this,this._computeBoneIndexToMeshOnMesh)},i._computeBoneIndexToMeshOnMesh=function(){"LAYAANIMATION:02"===this._templet._aniVersion?this._oldVersion=!1:this._oldVersion=!0;var e=this._owner.meshFilter.sharedMesh;e.loaded?this._computeBoneIndexToMesh(e):e.on("loaded",this,this._computeBoneIndexToMesh)},i._computeBoneIndexToMesh=function(e){var t=e._boneNames;if(t)for(var n=t.length,i=this._templet._anis,r=0,a=i.length;r<a;r++){var s=this._boneIndexToMeshList[r];s||(s=this._boneIndexToMeshList[r]=[]),s.length=n;for(var o=i[r],l=0;l<n;l++)s[l]=o.bone3DMap[t[l]]}},i._getAnimationDatasWithCache=function(e,t,n,i,r){var a=n[i];if(a){var s=a[e];if(s){var o=s[t.id];return o?o[r]:null}return null}return null},i._setAnimationDatasWithCache=function(e,t,n,i,r,a){var s=n[i]||(n[i]={}),o=s[e]||(s[e]={});(o[t.id]||(o[t.id]=[]))[r]=a},i._onAnimationPlayMeshLoaded=function(){for(var e=this._ownerMesh.meshRender._renderElements,t=0,n=e.length;t<n;t++)e[t]._canDynamicBatch=!1},i._onAnimationPlay=function(){this._ownerMesh._render._addShaderDefine(zn.SHADERDEFINE_BONE);var e=this._ownerMesh.meshFilter.sharedMesh;e.loaded?this._onAnimationPlayMeshLoaded():e.once("loaded",this,this._onAnimationPlayMeshLoaded)},i._onAnimationStop=function(){this._lastFrameIndex=-1,this._player.returnToZeroStopped&&(this._curBonesDatas=null,this._curAnimationDatas=null,this._ownerMesh._render._removeShaderDefine(zn.SHADERDEFINE_BONE));for(var e=this._ownerMesh.meshRender._renderElements,t=0,n=e.length;t<n;t++)e[t]._canDynamicBatch=!0},i._load=function(t){e.prototype._load.call(this,t),this._ownerMesh=t,this._player.on("played",this,this._onAnimationPlay),this._player.on("stopped",this,this._onAnimationStop),this._owner.meshFilter.on("meshchanged",this,this._computeBoneIndexToMeshOnTemplet)},i._update=function(e){var i=this._ownerMesh.meshFilter.sharedMesh;if(2===this._player.state&&this._templet&&this._templet.loaded&&i.loaded){var r=this._player.playbackRate*n.timer.scale,a=this._player.cachePlayRate,s=this._player.isCache&&r>=a,o=s?this.currentFrameIndex:-1;if(-1===o||this._lastFrameIndex!==o){var l=this.currentAnimationClipIndex,h=this._templet._animationDatasCache[0],_=this._templet._animationDatasCache[1];if(s){var u=this._getAnimationDatasWithCache(a,i,_,l,o);if(u)return this._curAnimationDatas=u,this._curBonesDatas=this._templet.getAnimationDataWithCache(a,h,l,o),void(this._lastFrameIndex=o)}var c=!1;s&&(this._curBonesDatas=this._templet.getAnimationDataWithCache(a,h,l,o),c=!!this._curBonesDatas);var d=this._templet.getNodes(l),f=16*d.length,m=i.InverseAbsoluteBindPoses;this._oldVersion?this._curMeshAnimationData||(this._curMeshAnimationData=new Float32Array(f)):this._curMeshAnimationData||(this._curMeshAnimationData=new Float32Array(16*m.length));var p,v,g=0,x=0,E=0,S=i.getSubMeshCount();if(s){for(this._curAnimationDatas=[],this._curAnimationDatas.length=S,g=0;g<S;g++)for(p=this._curAnimationDatas[g]=[],E=(v=i.getSubMesh(g))._boneIndicesList.length,p.length=E,x=0;x<E;x++)p[x]=new Float32Array(16*v._boneIndicesList[x].length);c||(this._curBonesDatas=new Float32Array(f))}else{if(!this._tempCurAnimationData)for(this._tempCurAnimationData=[],this._tempCurAnimationData.length=S,g=0;g<S;g++)for(p=this._tempCurAnimationData[g]=[],E=(v=i.getSubMesh(g))._boneIndicesList.length,p.length=E,x=0;x<E;x++)p[x]=new Float32Array(16*v._boneIndicesList[x].length);this._tempCurBonesData||(this._tempCurBonesData=new Float32Array(f)),this._curAnimationDatas=this._tempCurAnimationData,this._curBonesDatas=this._tempCurBonesData}if(this._curOriginalData||(this._curOriginalData=new Float32Array(this._templet.getTotalkeyframesLength(l))),s?this._templet.getOriginalData(l,this._curOriginalData,this._player._fullFrames[l],o,this._player.currentFrameTime):this._templet.getOriginalDataUnfixedRate(l,this._curOriginalData,this._player.currentPlayTime),this._oldVersion)s&&c?Ct._computeAnimationDatasByArrayAndMatrixFastOld(m,this._curBonesDatas,this._curMeshAnimationData):Ct._computeBoneAndAnimationDatasByBindPoseMatrxixOld(d,this._curOriginalData,m,this._curBonesDatas,this._curMeshAnimationData);else{var D=this._boneIndexToMeshList[l];s&&c?Ct._computeAnimationDatasByArrayAndMatrixFast(m,this._curBonesDatas,this._curMeshAnimationData,D):Ct._computeBoneAndAnimationDatasByBindPoseMatrxix(d,this._curOriginalData,m,this._curBonesDatas,this._curMeshAnimationData,D)}for(g=0;g<S;g++){var T=i.getSubMesh(g)._boneIndicesList;for(E=T.length,p=this._curAnimationDatas[g],x=0;x<E;x++)t._splitAnimationDatas(T[x],this._curMeshAnimationData,p[x])}s&&(this._setAnimationDatasWithCache(a,i,_,l,o,this._curAnimationDatas),c||this._templet.setAnimationDataWithCache(a,h,l,o,this._curBonesDatas)),this._lastFrameIndex=o}}},i._preRenderUpdate=function(e){var t=e.renderElement.renderObj;this._curAnimationDatas?t._skinAnimationDatas=this._curAnimationDatas[t._indexInMesh]:t._skinAnimationDatas=null},i._unload=function(t){2==this.player.state&&this._ownerMesh._render._removeShaderDefine(zn.SHADERDEFINE_BONE),this._templet&&!this._templet.loaded&&this._templet.off("loaded",this,this._computeBoneIndexToMeshOnMesh);var n=this._ownerMesh.meshFilter.sharedMesh;n.loaded||n.off("loaded",this,this._onAnimationPlayMeshLoaded),e.prototype._unload.call(this,t),this._tempCurAnimationData=null,this._tempCurBonesData=null,this._curOriginalData=null,this._curMeshAnimationData=null,this._curBonesDatas=null,this._curAnimationDatas=null,this._ownerMesh=null},a(0,i,"curBonesDatas",function(){return this._curBonesDatas}),a(0,i,"templet",e.prototype._$get_templet,function(e){this._templet!==e&&(0!==this._player.state&&this._player.stop(!0),this._templet=e,this._player.templet=e,this._computeBoneIndexToMeshOnTemplet(),this._curOriginalData=null,this._curMeshAnimationData=null,this._tempCurBonesData=null,this._tempCurAnimationData=null,this._templet._animationDatasCache||(this._templet._animationDatasCache=[[],[]]),this.event("animationchanged",this))}),t._splitAnimationDatas=function(e,t,n){for(var i=0,r=e.length,a=0;i<r;i++)for(var s=0;s<16;s++,a++)n[a]=t[(e[i]<<4)+s]},t}($t)),Mn=(function(e){function t(){this._size=null,this._transformOrientedBoundBox=null,this.center=null,t.__super.call(this),this._needUpdate=!1}r(t,"laya.d3.component.physics.BoxCollider",en);var n=t.prototype;n._updateCollider=function(){if(this._needUpdate){var e=this._owner.transform;e.worldMatrix.cloneTo(this._transformOrientedBoundBox.transformation),ct.multiply(e.scale,this.center,t._deviationV3),ct.transformQuat(t._deviationV3,e.rotation,t._deviationV3),this._transformOrientedBoundBox.getCenter(t._obbCenterV3),ct.add(t._obbCenterV3,t._deviationV3,t._deviationV3),this._transformOrientedBoundBox.transformation.setTranslationVector(t._deviationV3),this._needUpdate=!1}},n._onGeometryFilterLoaded=function(){this.destroyed||this._initBoundBox()},n._onWorldMatrixChanged=function(){this._needUpdate=!0},n._initBoundBox=function(){var e=this.owner._geometryFilter._originalBoundingBox;st.createByBoundBox(e,this._transformOrientedBoundBox);var t=this._transformOrientedBoundBox.extents;this._size=new ct(2*t.x,2*t.y,2*t.z),this.center=new ct,ct.add(e.min,e.max,this.center),ct.scale(this.center,.5,this.center),this.owner.transform.on("worldmatrixneedchanged",this,this._onWorldMatrixChanged),this._needUpdate=!0},n._initialize=function(e){if(laya.d3.component.Component3D.prototype._initialize.call(this,e),this._owner instanceof laya.d3.core.RenderableSprite3D){var t=e;this._transformOrientedBoundBox=new st(new ct,new at),t._geometryFilter._isAsyncLoaded?this._initBoundBox():t._geometryFilter.once("loaded",this,this._onGeometryFilterLoaded)}else this._transformOrientedBoundBox=new st(new ct,new at),this._size=new ct,this.center=new ct,e.transform.on("worldmatrixneedchanged",this,this._onWorldMatrixChanged),this._needUpdate=!0},n.raycast=function(e,t,n){void 0===n&&(n=Number.MAX_VALUE),this._updateCollider();var i=this._transformOrientedBoundBox.intersectsRay(e,t.position);return-1!==i&&i<=n?(t.distance=i,t.sprite3D=this._owner,!0):(t.distance=-1,t.sprite3D=null,!1)},a(0,n,"boundBox",function(){return this._updateCollider(),this._transformOrientedBoundBox}),a(0,n,"size",function(){return this._size},function(e){this._size=e,ct.scale(e,.5,this._transformOrientedBoundBox.extents)}),i(t,["_deviationV3",function(){return this._deviationV3=new ct},"_obbCenterV3",function(){return this._obbCenterV3=new ct}])}(),function(e){function t(){this._transformBoundSphere=null,this._mesh=null,t.__super.call(this),this._transformBoundSphere=new tt(new ct(0,0,0),0)}r(t,"laya.d3.component.physics.MeshCollider",en);var n=t.prototype;n._raycastMesh=function(e,n,i,r){void 0===r&&(r=Number.MAX_VALUE);var a=n.transform.worldMatrix,s=t._tempMatrix4x40;a.invert(s);var o=e.origin,l=e.direction,h=t._tempRay0;ct.transformCoordinate(o,s,h.origin),ct.TransformNormal(l,s,h.direction);for(var _=Number.MAX_VALUE,u=0,c=this._mesh.getRenderElementsCount();u<c;u++){var d=this._mesh.getRenderElement(u),f=d._getVertexBuffer(0),m=f.getData(),p=d._getIndexBuffer().getData(),v=t._tempRaycastHit;if(yt.rayIntersectsPositionsAndIndices(h,m,f.vertexDeclaration,p,v)){ct.transformCoordinate(v.position,a,v.position);var g=t._tempVector30;ct.subtract(o,v.position,g);var x=ct.scalarLength(g);if(x<r&&x<_){v.distance=x,v.sprite3D=n;var E=v.trianglePositions;ct.transformCoordinate(E[0],a,E[0]),ct.transformCoordinate(E[1],a,E[1]),ct.transformCoordinate(E[2],a,E[2]);var S=v.triangleNormals;return ct.transformCoordinate(S[0],a,S[0]),ct.transformCoordinate(S[1],a,S[1]),ct.transformCoordinate(S[2],a,S[2]),_=x,v.cloneTo(i),!0}return!1}}return!1},n._initialize=function(e){if(laya.d3.component.Component3D.prototype._initialize.call(this,e),this._owner instanceof laya.d3.core.MeshSprite3D){var t=e;this._mesh=t.meshFilter.sharedMesh}},n.raycast=function(e,t,n){if(void 0===n&&(n=Number.MAX_VALUE),null==this._mesh||!this._mesh.loaded)return!1;var i=NaN,r=this._owner.transform,a=r.scale;i=a.x>=a.y&&a.x>=a.z?a.x:a.y>=a.z?a.y:a.z;var s=this._mesh.boundingSphere;ct.transformCoordinate(s.center,r.worldMatrix,this._transformBoundSphere.center),this._transformBoundSphere.radius=s.radius*i;var o=this._transformBoundSphere.intersectsRayPoint(e,t.position);return!!(-1!==o&&o<=n&&this._raycastMesh(e,this._owner,t,n))||(t.distance=-1,t.sprite3D=null,!1)},a(0,n,"mesh",function(){return this._mesh},function(e){this._mesh=e}),i(t,["_tempRay0",function(){return this._tempRay0=new _t(new ct,new ct)},"_tempVector30",function(){return this._tempVector30=new ct},"_tempMatrix4x40",function(){return this._tempMatrix4x40=new at},"_tempRaycastHit",function(){return this._tempRaycastHit=new Rt}])}(),function(e){function t(){this._originalBoundSphere=null,this._transformBoundSphere=null,t.__super.call(this),this._needUpdate=!1}r(t,"laya.d3.component.physics.SphereCollider",en);var n=t.prototype;n._updateCollider=function(){if(this._needUpdate){var e=NaN,t=this._owner.transform,n=t.scale;e=n.x>=n.y&&n.x>=n.z?n.x:n.y>=n.z?n.y:n.z,ct.transformCoordinate(this._originalBoundSphere.center,t.worldMatrix,this._transformBoundSphere.center),this._transformBoundSphere.radius=this._originalBoundSphere.radius*e,this._needUpdate=!1}},n._onGeometryFilterLoaded=function(){this.destroyed||this._initBoundSphere()},n._onWorldMatrixChanged=function(){this._needUpdate=!0},n._initBoundSphere=function(){this.owner._geometryFilter._originalBoundingSphere.cloneTo(this._originalBoundSphere),this.owner.transform.on("worldmatrixneedchanged",this,this._onWorldMatrixChanged),this._needUpdate=!0},n._initialize=function(e){if(laya.d3.component.Component3D.prototype._initialize.call(this,e),e instanceof laya.d3.core.RenderableSprite3D){var t=e;this._originalBoundSphere=new tt(new ct(0,0,0),0),this._transformBoundSphere=new tt(new ct(0,0,0),0),t._geometryFilter._isAsyncLoaded?this._initBoundSphere():t._geometryFilter.once("loaded",this,this._onGeometryFilterLoaded)}else this._originalBoundSphere=new tt(new ct(0,0,0),.5),this._transformBoundSphere=new tt(new ct(0,0,0),.5),e.transform.on("worldmatrixneedchanged",this,this._onWorldMatrixChanged),this._needUpdate=!0},n.raycast=function(e,t,n){void 0===n&&(n=Number.MAX_VALUE),this._updateCollider();var i=this._transformBoundSphere.intersectsRayPoint(e,t.position);return-1!==i&&i<=n?(t.distance=i,t.sprite3D=this._owner,!0):(t.distance=-1,t.sprite3D=null,!1)},a(0,n,"center",function(){return this._originalBoundSphere.center},function(e){this._originalBoundSphere.center=e}),a(0,n,"radius",function(){return this._originalBoundSphere.radius},function(e){this._originalBoundSphere.radius=e}),a(0,n,"boundSphere",function(){return this._updateCollider(),this._transformBoundSphere})}(),function(e){function t(){this.simLodInfo=null,this._src=null,this._buffer=null,this._mipmaps=null,this._recreateLock=!1,this._needReleaseAgain=!1,t.__super.call(this),this._type=3553}r(t,"laya.d3.resource.DataTexture2D",Zt);var s=t.prototype;return s.genDebugMipmaps=function(){var e=[];return e.push(new Uint8Array(new Uint32Array(131072).fill(4278190335).buffer)),e.push(new Uint8Array(new Uint32Array(32768).fill(4278223103).buffer)),e.push(new Uint8Array(new Uint32Array(8192).fill(4278255615).buffer)),e.push(new Uint8Array(new Uint32Array(2048).fill(4278255360).buffer)),e.push(new Uint8Array(new Uint32Array(512).fill(4286595072).buffer)),e.push(new Uint8Array(new Uint32Array(128).fill(4294901760).buffer)),e.push(new Uint8Array(new Uint32Array(32).fill(4294901888).buffer)),e.push(new Uint8Array(new Uint32Array(8).fill(0).buffer)),e.push(new Uint8Array(new Uint32Array(2).fill(4286611584).buffer)),e.push(new Uint8Array(new Uint32Array(1).fill(4294967295).buffer)),e},s._onTextureLoaded=function(e){},s._createWebGlTexture=function(){if(!this._buffer&&!this._mipmaps)throw"create GLTextur err:no data";var e=N.mainContext;e.getExtension("EXT_shader_texture_lod");var n=this._source=e.createTexture(),i=this._width,r=this._height,a=O.curBindTexTarget,s=O.curBindTexValue;if(O.bindTexture(e,this._type,n),this._mipmaps){if(laya.d3.resource.DataTexture2D.lodasatlas){var o=0;e.texImage2D(this._type,0,6408,this._width,this._height,0,6408,5121,null);for(var l=0;l<this._mipmaps.length;l++){if(this._mipmaps[l].byteLength!=_*u*4)throw"mipmap size error  level:"+l;e.texSubImage2D(this._type,0,t.simLodRect[o++],t.simLodRect[o++],t.simLodRect[o++],t.simLodRect[o++],6408,5121,new Uint8Array(this._mipmaps[l]))}this.minFifter=9729,this.magFifter=9729}else{var _=this._width,u=this._height;for(o=0,e.texImage2D(this._type,0,6408,this._width,this._height,0,6408,5121,null),l=0;l<this._mipmaps.length;l++){if(this._mipmaps[l].byteLength!=_*u*4)throw"mipmap size error  level:"+l;e.texImage2D(this._type,l,6408,_,u,0,6408,5121,new Uint8Array(this._mipmaps[l])),u/=2,(_/=2)<1&&(_=1),u<1&&(u=1),this.minFifter=9987,this.magFifter=9729}}this.mipmap=!1}else e.texImage2D(this._type,0,6408,i,r,0,6408,5121,new Uint8Array(this._buffer));var c=this._minFifter,d=this._magFifter,f=this._repeat?10497:33071,m=h.isPOT(i,r);if(!m)throw"data texture must be POT";this._mipmap||this._mipmaps?-1!==c||(c=9987):-1!==c||(c=9729),-1!==d||(d=9729),e.texParameteri(this._type,10241,c),e.texParameteri(this._type,10240,d),e.texParameteri(this._type,10242,f),this._mipmaps?e.texParameteri(this._type,10243,33071):e.texParameteri(this._type,10243,f),this._mipmap&&e.generateMipmap(this._type),a&&s&&O.bindTexture(e,a,s),this.src&&this.src.length>0&&(this._buffer=null),this.memorySize=m?i*r*4*(1+1/3):i*r*4,this._recreateLock=!1},s.recreateResource=function(){if(this._buffer||null!=this._src&&""!==this._src)if(this._needReleaseAgain=!1,this._buffer||this._mipmaps){if(this._recreateLock)return;this._createWebGlTexture(),this.completeCreate()}else{this._recreateLock=!0}},s.onAsynLoaded=function(e,t,n){var i;n&&(i=n[0].call(this,t)),i&&(this._width=i.width,this._height=i.height,this._buffer=i.data),this._src=e,this._size=new At(this._width,this._height),this._conchTexture?alert("怎么给runtime传递datatexture数据"):this.activeResource(),this._endLoaded()},s.getPixels=function(){return new Uint8Array(this._buffer)},s.detoryResource=function(){this._recreateLock&&(this._needReleaseAgain=!0),this._source&&(N.mainContext.deleteTexture(this._source),this._source=null,this._buffer=null,this.memorySize=0)},a(0,s,"src",function(){return this._src}),t.create=function(e,n,i,r,a,s){if(void 0===r&&(r=9729),void 0===a&&(a=9729),void 0===s&&(s=!0),!e||e.byteLength<n*i*4)throw"DataTexture2D create error";var o=new t;return o._buffer=e,o._width=n,o._height=i,o._mipmap=s,o._magFifter=r,o._minFifter=a,o._size=new At(o._width,o._height),o._conchTexture?alert("怎么给runtime传递datatexture数据"):o.activeResource(),o},t.load=function(e,i,r,a,s){if(void 0===i&&(i=0),void 0===r&&(r=0),void 0===a&&(a=9729),void 0===s&&(s=9729),"mipmaps"===V.getFileExtension(e)){var o=n.loader.create(e,null,null,t,[function(e){this._mipmaps=[];var t=new Uint32Array(e);this._width=t[0];var n=512;if(laya.d3.resource.DataTexture2D.lodasatlas&&(this._width*=2,n=1024),this._width!=n)throw console.error("现在只支持512x256的环境贴图。当前的是"+t[0]),"现在只支持512x256的环境贴图。当前的是"+t[0];this._height=t[1];for(var i=laya.d3.resource.DataTexture2D.lodasatlas?this._width/2:this._width,r=this._height,a=8;;){var s=i*r*4;if(a+s>e.byteLength)throw"load mipmaps data size error ";var o=new Uint8Array(e,a,s);if(this._mipmaps.push(o),a+=s,1==i&&1==r)break;r/=2,(i/=2)<1&&(i=1),r<1&&(r=1)}return null}]);if(laya.d3.resource.DataTexture2D.lodasatlas){o.simLodInfo=new Float32Array(40);for(var l=0;l<o.simLodInfo.length;)o.simLodInfo[l]=(t.simLodRect[l]+.5)/1024,l++,o.simLodInfo[l]=(t.simLodRect[l]+.5)/256,l++,o.simLodInfo[l]=Math.max(t.simLodRect[l]-1,.1)/1024,l++,o.simLodInfo[l]=Math.max(t.simLodRect[l]-1.5,.1)/256,l++}return o}if("number"==typeof i)return n.loader.create(e,null,null,t,[function(e){return this._width=i,this._height=r,this._buffer=e,null}]);if("function"==typeof i)return n.loader.create(e,null,null,t,[i]);throw new Error("unknown params.")},t.lodasatlas=!1,i(t,["simLodRect",function(){return this.simLodRect=new Uint32Array([0,0,512,256,512,0,256,128,768,0,128,64,896,0,64,32,960,0,32,16,992,0,16,8,1008,0,8,4,1016,0,4,2,1020,0,2,1,1022,0,1,1])}]),t}()),yn=function(e){function t(){this._numberVertices=0,this._numberIndices=0,this._vertexBuffer=null,this._indexBuffer=null,t.__super.call(this)}r(t,"laya.d3.resource.models.PrimitiveMesh",Yt);var i=t.prototype;return n.imps(i,{"laya.d3.core.render.IRenderable":!0}),i._getVertexBuffer=function(e){return void 0===e&&(e=0),0===e?this._vertexBuffer:null},i._getIndexBuffer=function(){return this._indexBuffer},i.getRenderElement=function(e){return this},i.getRenderElementsCount=function(){return 1},i.detoryResource=function(){this._vertexBuffer&&(this._vertexBuffer.dispose(),this._vertexBuffer=null),this._indexBuffer&&(this._indexBuffer.dispose(),this._indexBuffer=null),this.memorySize=0},i._beforeRender=function(e){return this._vertexBuffer._bind(),this._indexBuffer._bind(),!0},i._render=function(e){N.mainContext.drawElements(4,this._numberIndices,5123,0),C.drawCall++,C.trianglesFaces+=this._numberIndices/3},i._renderRuntime=function(e,t,n){e.drawSubmesh(t._conchSubmesh,0,4,0,this._numberIndices)},a(0,i,"_vertexBufferCount",function(){return 1}),a(0,i,"triangleCount",function(){return this._indexBuffer.indexCount/3}),a(0,i,"positions",function(){var e,t=[],n=this._vertexBuffer.vertexDeclaration.getVertexElements(),i=0;for(i=0;i<n.length;i++){var r=n[i];if("vector3"===r.elementFormat&&0===r.elementUsage){e=r;break}}var a=this._vertexBuffer.getData();for(i=0;i<a.length;i+=this._vertexBuffer.vertexDeclaration.vertexStride/4){var s=i+e.offset/4,o=new ct(a[s+0],a[s+1],a[s+2]);t.push(o)}return t}),t}(),Rn=function(e){function t(){this._materials=null,this._subMeshes=null,this._vertexBuffers=null,this._indexBuffer=null,this._boneNames=null,this._inverseBindPoses=null,t.__super.call(this),this._subMeshes=[],this._materials=[],this._vertexBuffers=[]}r(t,"laya.d3.resource.models.Mesh",Yt);var i=t.prototype;return i._setSubMeshes=function(e){this._subMeshes=e,this._subMeshCount=e.length;for(var t=0;t<this._subMeshCount;t++)e[t]._indexInMesh=t;this._generateBoundingObject()},i.onAsynLoaded=function(e,t,n){var i=t[0],r=t[1];$e.read(i,this,this._materials,this._subMeshes,r),this.completeCreate(),this._endLoaded()},i.getSubMesh=function(e){return this._subMeshes[e]},i.getSubMeshCount=function(){return this._subMeshes.length},i.getRenderElementsCount=function(){return this._subMeshes.length},i.getRenderElement=function(e){return this._subMeshes[e]},i.detoryResource=function(){for(var e=0;e<this._subMeshes.length;e++)this._subMeshes[e].dispose();this._materials=null,this._subMeshes=null,this._vertexBuffers=null,this._indexBuffer=null,this._boneNames=null,this._inverseBindPoses=null},a(0,i,"positions",function(){var e,t,n,i,r,a=[],s=0,o=0,l=0;if(0!==this._vertexBuffers.length){var h=this._vertexBuffers.length;for(s=0;s<h;s++){for(n=(e=this._vertexBuffers[s]).vertexDeclaration.getVertexElements(),o=0;o<n.length;o++)if("vector3"===(i=n[o]).elementFormat&&0===i.elementUsage){t=i;break}for(r=e.getData(),o=0;o<r.length;o+=e.vertexDeclaration.vertexStride/4)l=o+t.offset/4,a.push(new ct(r[l+0],r[l+1],r[l+2]))}}else{var _=this._subMeshes.length;for(s=0;s<_;s++){for(n=(e=this._subMeshes[s]._getVertexBuffer()).vertexDeclaration.getVertexElements(),o=0;o<n.length;o++)if("vector3"===(i=n[o]).elementFormat&&0===i.elementUsage){t=i;break}for(r=e.getData(),o=0;o<r.length;o+=e.vertexDeclaration.vertexStride/4)l=o+t.offset/4,a.push(new ct(r[l+0],r[l+1],r[l+2]))}}return a}),a(0,i,"materials",function(){return this._materials.slice()}),a(0,i,"InverseAbsoluteBindPoses",function(){return this._inverseBindPoses}),t.load=function(e){return n.loader.create(e,null,null,t)},t}(),An=function(e){function t(e,n,i,r,a,s,o,l,h){this._alreadyResolved=!1,this._surfaceFormat=0,this._surfaceType=0,this._depthStencilFormat=0,this._frameBuffer=null,this._depthStencilBuffer=null,void 0===i&&(i=6408),void 0===r&&(r=5121),void 0===a&&(a=33189),void 0===s&&(s=!1),void 0===o&&(o=!1),void 0===l&&(l=-1),void 0===h&&(h=-1),t.__super.call(this),this._type=3553,this._width=e,this._height=n,this._size=new At(e,n),this._surfaceFormat=i,this._surfaceType=r,this._depthStencilFormat=a,this._mipmap=s,this._repeat=o,this._minFifter=l,this._magFifter=h,this.activeResource(),this._alreadyResolved=!0}r(t,"laya.d3.resource.RenderTexture",e);var n=t.prototype;return n.recreateResource=function(){var e=N.mainContext;this._frameBuffer=e.createFramebuffer(),this._source=e.createTexture();var t=O.curBindTexTarget,n=O.curBindTexValue;O.bindTexture(e,this._type,this._source),e.texImage2D(this._type,0,6408,this._width,this._height,0,this._surfaceFormat,this._surfaceType,null);var i=this._minFifter,r=this._magFifter,a=this._repeat?10497:33071;if(h.isPOT(this._width,this._height)?(this._mipmap?-1!==i||(i=9987):-1!==i||(i=9729),-1!==r||(r=9729),e.texParameteri(this._type,10241,i),e.texParameteri(this._type,10240,r),e.texParameteri(this._type,10242,a),e.texParameteri(this._type,10243,a),this._mipmap&&e.generateMipmap(this._type)):(-1!==i||(i=9729),-1!==r||(r=9729),e.texParameteri(this._type,10241,i),e.texParameteri(this._type,10240,r),e.texParameteri(this._type,10242,33071),e.texParameteri(this._type,10243,33071)),e.bindFramebuffer(36160,this._frameBuffer),e.framebufferTexture2D(36160,36064,3553,this._source,0),this._depthStencilFormat)switch(this._depthStencilBuffer=e.createRenderbuffer(),e.bindRenderbuffer(36161,this._depthStencilBuffer),e.renderbufferStorage(36161,this._depthStencilFormat,this._width,this._height),this._depthStencilFormat){case 33189:e.framebufferRenderbuffer(36160,36096,36161,this._depthStencilBuffer);break;case 36168:e.framebufferRenderbuffer(36160,36128,36161,this._depthStencilBuffer);break;case 34041:e.framebufferRenderbuffer(36160,33306,36161,this._depthStencilBuffer)}e.bindFramebuffer(36160,null),t&&n&&O.bindTexture(e,t,n),e.bindRenderbuffer(36161,null),this.memorySize=this._width*this._height*4,this.completeCreate()},n.start=function(){N.mainContext.bindFramebuffer(36160,this.frameBuffer),t._currentRenderTarget=this,this._alreadyResolved=!1},n.end=function(){N.mainContext.bindFramebuffer(36160,null),t._currentRenderTarget=null,this._alreadyResolved=!0},n.getData=function(e,t,n,i){var r=N.mainContext;if(r.bindFramebuffer(36160,this._frameBuffer),!(36053===r.checkFramebufferStatus(36160)))return r.bindFramebuffer(36160,null),null;var a=new Uint8Array(this._width*this._height*4);return r.readPixels(e,t,n,i,this._surfaceFormat,this._surfaceType,a),r.bindFramebuffer(36160,null),a},n.detoryResource=function(){if(this._frameBuffer){var e=N.mainContext;e.deleteTexture(this._source),e.deleteFramebuffer(this._frameBuffer),e.deleteRenderbuffer(this._depthStencilBuffer),this._source=null,this._frameBuffer=null,this._depthStencilBuffer=null,this.memorySize=0}},a(0,n,"surfaceFormat",function(){return this._surfaceFormat}),a(0,n,"surfaceType",function(){return this._surfaceType}),a(0,n,"depthStencilFormat",function(){return this._depthStencilFormat}),a(0,n,"source",function(){return this._alreadyResolved?e.prototype._$get_source.call(this):null}),a(0,n,"depthStencilBuffer",function(){return this._depthStencilBuffer}),a(0,n,"frameBuffer",function(){return this._frameBuffer}),t._currentRenderTarget=null,t}(Zt),Cn=function(e){function t(e){this._color=null,this._pixels=null,t.__super.call(this),this._type=3553,this._width=1,this._height=1,this._size=new At(this.width,this.height),this._color=e,this._pixels=new Uint8Array([255*e.x,255*e.y,255*e.z,255*e.w])}r(t,"laya.d3.resource.SolidColorTexture2D",e);var n=t.prototype;return n._createWebGlTexture=function(){var e=N.mainContext,t=this._source=e.createTexture(),n=this._width,i=this._height,r=O.curBindTexTarget,a=O.curBindTexValue;O.bindTexture(e,this._type,t),e.texImage2D(this._type,0,6408,n,i,0,6408,5121,this._pixels);var s=this._minFifter,o=this._magFifter,l=this._repeat?10497:33071,_=h.isPOT(n,i);_?(this._mipmap?-1!==s||(s=9987):-1!==s||(s=9729),-1!==o||(o=9729),e.texParameteri(this._type,10241,s),e.texParameteri(this._type,10240,o),e.texParameteri(this._type,10242,l),e.texParameteri(this._type,10243,l),this._mipmap&&e.generateMipmap(this._type)):(-1!==s||(s=9729),-1!==o||(o=9729),e.texParameteri(this._type,10241,s),e.texParameteri(this._type,10240,o),e.texParameteri(this._type,10242,33071),e.texParameteri(this._type,10243,33071)),r&&a&&O.bindTexture(e,r,a),this.memorySize=_?n*i*4*(1+1/3):n*i*4},n.recreateResource=function(){this._createWebGlTexture(),this.completeCreate()},n.detoryResource=function(){this._source&&(N.mainContext.deleteTexture(this._source),this._source=null,this.memorySize=0)},a(0,n,"source",function(){return e.prototype._$get_source.call(this)}),i(t,["magentaTexture",function(){return this.magentaTexture=new t(new dt(1,0,1,1))},"grayTexture",function(){return this.grayTexture=new t(new dt(.5,.5,.5,1))}]),t}(Zt),In=function(e){function t(e){this._color=null,this._pixels=null,this._texCount=6,t.__super.call(this),this._type=34067,this._width=1,this._height=1,this._size=new At(this.width,this.height),this._color=e,this._pixels=new Uint8Array([255*e.x,255*e.y,255*e.z,255*e.w])}r(t,"laya.d3.resource.SolidColorTextureCube",Zt);var n=t.prototype;return n._createWebGlTexture=function(){var e=N.mainContext,t=this._source=e.createTexture(),n=this._width,i=this._height,r=O.curBindTexTarget,a=O.curBindTexValue;O.bindTexture(e,this._type,t),e.texImage2D(34069,0,6408,n,i,0,6408,5121,this._pixels),e.texImage2D(34070,0,6408,n,i,0,6408,5121,this._pixels),e.texImage2D(34071,0,6408,n,i,0,6408,5121,this._pixels),e.texImage2D(34072,0,6408,n,i,0,6408,5121,this._pixels),e.texImage2D(34073,0,6408,n,i,0,6408,5121,this._pixels),e.texImage2D(34074,0,6408,n,i,0,6408,5121,this._pixels);var s=this.minFifter,o=this.magFifter,l=this._repeat?10497:33071,_=h.isPOT(n,i);_?(this.mipmap?-1!==s||(s=9987):-1!==s||(s=9729),-1!==o||(o=9729),e.texParameteri(this._type,10241,s),e.texParameteri(this._type,10240,o),e.texParameteri(this._type,10242,l),e.texParameteri(this._type,10243,l),this.mipmap&&e.generateMipmap(this._type)):(-1!==s||(s=9729),-1!==o||(o=9729),e.texParameteri(this._type,10241,s),e.texParameteri(this._type,10240,o),e.texParameteri(this._type,10242,33071),e.texParameteri(this._type,10243,33071)),r&&a&&O.bindTexture(e,r,a),this.memorySize=_?n*i*4*(1+1/3)*this._texCount:n*i*4*this._texCount},n.recreateResource=function(){this._createWebGlTexture(),this.completeCreate()},n.detoryResource=function(){this._source&&(N.mainContext.deleteTexture(this._source),this._source=null,this.memorySize=0)},i(t,["magentaTexture",function(){return this.magentaTexture=new t(new dt(1,0,1,1))},"grayTexture",function(){return this.grayTexture=new t(new dt(.5,.5,.5,1))}]),t}(),wn=function(e){function t(e,n,i,r){this._canRead=!1,this._image=null,this._pixels=null,void 0===e&&(e=!1),void 0===n&&(n=!0),void 0===i&&(i=6408),void 0===r&&(r=!0),t.__super.call(this),this._type=3553,this._repeat=n,this._canRead=e,this._format=i,this._mipmap=r}r(t,"laya.d3.resource.Texture2D",Zt);var i=t.prototype;return i._createWebGlTexture=function(){if(!this._image)throw"create GLTextur err:no data:"+this._image;var e=N.mainContext,t=this._source=e.createTexture(),n=this._width,i=this._height,r=O.curBindTexTarget,a=O.curBindTexValue;switch(O.bindTexture(e,this._type,t),this._format){case 6407:case 6408:this._canRead?e.texImage2D(this._type,0,this._format,n,i,0,this._format,5121,this._pixels):e.texImage2D(this._type,0,this._format,this._format,5121,this._image);break;case N.compressEtc1.COMPRESSED_RGB_ETC1_WEBGL:e.compressedTexImage2D(this._type,0,this._format,this._width,this._height,0,this._image)}var s=this._minFifter,o=this._magFifter,l=this._repeat?10497:33071,_=h.isPOT(n,i);_?(this._mipmap?-1!==s||(s=9987):-1!==s||(s=9729),-1!==o||(o=9729),e.texParameteri(this._type,10241,s),e.texParameteri(this._type,10240,o),e.texParameteri(this._type,10242,l),e.texParameteri(this._type,10243,l),this._mipmap&&e.generateMipmap(this._type)):(-1!==s||(s=9729),-1!==o||(o=9729),e.texParameteri(this._type,10241,s),e.texParameteri(this._type,10240,o),e.texParameteri(this._type,10242,33071),e.texParameteri(this._type,10243,33071)),r&&a&&O.bindTexture(e,r,a),this._image.onload=null,this._image=null,this.memorySize=_?n*i*4*(1+1/3):n*i*4},i.recreateResource=function(){this.loaded&&(this._createWebGlTexture(),this.completeCreate())},i.onAsynLoaded=function(e,t,n){if(n){var i=n[0];void 0!==i&&(this._canRead=i);var r=n[1];void 0!==r&&(this._repeat=r);var a=n[2];void 0!==a&&(this._format=a);var s=n[3];void 0!==s&&(this._mipmap=s)}switch(this.url=e,this._format){case 6407:case 6408:this._image=t;var o=t.width,l=t.height;this._width=o,this._height=l,this._size=new At(o,l),this._canRead&&(c.canvas.size(o,l),c.canvas.clear(),c.context.drawImage(t,0,0,o,l),this._pixels=new Uint8Array(c.context.getImageData(0,0,o,l).data.buffer));break;case N.compressEtc1.COMPRESSED_RGB_ETC1_WEBGL:var h=new f(t);h.readUTFBytes(4),h.readUTFBytes(2),h.getInt16();h.endian="bigEndian",this._width=h.getInt16(),this._height=h.getInt16(),this._size=new At(this._width,this._height);h.getInt16(),h.getInt16();this._image=new Uint8Array(t,h.pos)}this._conchTexture?this._conchTexture.setTexture2DImage(this._image):this.activeResource(),this._endLoaded()},i.getPixels=function(){if(this._canRead)return this._pixels;throw new Error("Texture2D: must set texture canRead is true.")},i.detoryResource=function(){this._source&&(N.mainContext.deleteTexture(this._source),this._source=null,this._image=null,this.memorySize=0)},a(0,i,"_src",function(){return this.url}),a(0,i,"src",function(){return this.url}),t.load=function(e){return n.loader.create(e,null,null,t)},t}(),Vn=function(e){function t(){this._texCount=6,this._recreateLock=!1,this._needReleaseAgain=!1,t.__super.call(this),this._type=34067}r(t,"laya.d3.resource.TextureCube",Zt);var i=t.prototype;return i._onTextureLoaded=function(e){this._images=e;for(var t=2147483647,n=2147483647,i=0;i<6;i++){var r=e[i];t=Math.min(t,r.width),n=Math.min(n,r.height)}this._width=t,this._height=n,this._size=new At(t,n)},i._createWebGlTexture=function(){var e=0;for(e=0;e<this._texCount;e++)if(!this._images[e])throw"create GLTextur err:no data:"+this._images[e];var t=N.mainContext,n=this._source=t.createTexture(),i=this._width,r=this._height,a=O.curBindTexTarget,s=O.curBindTexValue;O.bindTexture(t,this._type,n),t.texImage2D(34069,0,6408,6408,5121,this._images[0]),t.texImage2D(34070,0,6408,6408,5121,this._images[1]),t.texImage2D(34071,0,6408,6408,5121,this._images[2]),t.texImage2D(34072,0,6408,6408,5121,this._images[3]),t.texImage2D(34073,0,6408,6408,5121,this._images[4]),t.texImage2D(34074,0,6408,6408,5121,this._images[5]);var o=this.minFifter,l=this.magFifter,_=this._repeat?10497:33071,u=h.isPOT(i,r);for(u?(this.mipmap?-1!==o||(o=9987):-1!==o||(o=9729),-1!==l||(l=9729),t.texParameteri(this._type,10241,o),t.texParameteri(this._type,10240,l),t.texParameteri(this._type,10242,_),t.texParameteri(this._type,10243,_),this.mipmap&&t.generateMipmap(this._type)):(-1!==o||(o=9729),-1!==l||(l=9729),t.texParameteri(this._type,10241,o),t.texParameteri(this._type,10240,l),t.texParameteri(this._type,10242,33071),t.texParameteri(this._type,10243,33071)),a&&s&&O.bindTexture(t,a,s),e=0;e<6;e++)this._images[e].onload=null,this._images[e]=null;this.memorySize=u?i*r*4*(1+1/3)*this._texCount:i*r*4*this._texCount,this._recreateLock=!1},i.recreateResource=function(){var e=this;if(null!=this._srcs)if(this._needReleaseAgain=!1,this._images[0]){if(this._recreateLock)return;this._createWebGlTexture(),this.completeCreate()}else{this._recreateLock=!0;for(var t=this,n=0;n<this._texCount;n++){this._images[n]=new c.window.Image,this._images[n].crossOrigin="";var i=n;this._images[i].onload=function(){var n=0;if(t._needReleaseAgain){for(n=0;n<e._texCount;n++)if(!t._images[n].complete)return;for(t._needReleaseAgain=!1,n=0;n<e._texCount;n++)t._images[n].onload=null,t._images[n]=null}else{for(n=0;n<e._texCount;n++)if(!t._images[n].complete)return;t._createWebGlTexture(),t.completeCreate()}},this._images[n].src=this._srcs[n]}}},i.onAsynLoaded=function(e,t,n){this._srcs=e,this._onTextureLoaded(t),this._conchTexture?this._conchTexture.setTextureCubeImages(this._images):this.activeResource(),this._endLoaded()},i.detoryResource=function(){this._recreateLock&&(this._needReleaseAgain=!0),this._source&&(N.mainContext.deleteTexture(this._source),this._source=null,this.memorySize=0)},a(0,i,"srcs",function(){return this._srcs}),a(0,i,"defaulteTexture",function(){return In.grayTexture}),t.load=function(e){return n.loader.create(e,null,null,t)},t}(),Nn=(function(e){function t(){this._numberVertices=0,this._numberIndices=0,this._textureCube=null,t.__super.call(this),this.name="Skybox-"+t._nameNumber,t._nameNumber++,this.loadShaderParams(),this.recreateResource(),this.alphaBlending=1,this.colorIntensity=1}r(t,"laya.d3.resource.models.SkyBox",qt);var n=t.prototype;n._getShader=function(e){var t=e.scene._shaderDefineValue;return this._shader=this._shaderCompile.withCompile(t,0,0),this._shader},n.recreateResource=function(){this._numberVertices=36,this._numberIndices=36;var e=new Uint16Array(this._numberIndices),n=t._vertexDeclaration.vertexStride/4,i=new Float32Array(this._numberVertices*n),r=new ct(-.5,.5,.5),a=new ct(-.5,-.5,.5),s=new ct(.5,.5,.5),o=new ct(.5,-.5,.5),l=new ct(-.5,.5,-.5),h=new ct(.5,.5,-.5),_=new ct(-.5,-.5,-.5),u=new ct(.5,-.5,-.5),c=0;c=this._addVertex(i,c,r),c=this._addVertex(i,c,a),c=this._addVertex(i,c,s),c=this._addVertex(i,c,a),c=this._addVertex(i,c,o),c=this._addVertex(i,c,s),c=this._addVertex(i,c,l),c=this._addVertex(i,c,h),c=this._addVertex(i,c,_),c=this._addVertex(i,c,_),c=this._addVertex(i,c,h),c=this._addVertex(i,c,u),c=this._addVertex(i,c,r),c=this._addVertex(i,c,h),c=this._addVertex(i,c,l),c=this._addVertex(i,c,r),c=this._addVertex(i,c,s),c=this._addVertex(i,c,h),c=this._addVertex(i,c,a),c=this._addVertex(i,c,_),c=this._addVertex(i,c,u),c=this._addVertex(i,c,a),c=this._addVertex(i,c,u),c=this._addVertex(i,c,o),c=this._addVertex(i,c,r),c=this._addVertex(i,c,_),c=this._addVertex(i,c,a),c=this._addVertex(i,c,l),c=this._addVertex(i,c,_),c=this._addVertex(i,c,r),c=this._addVertex(i,c,s),c=this._addVertex(i,c,o),c=this._addVertex(i,c,u),c=this._addVertex(i,c,h),c=this._addVertex(i,c,s),c=this._addVertex(i,c,u);for(var d=0;d<36;d++)e[d]=d;if(this._vertexBuffer=new En(t._vertexDeclaration,this._numberVertices,35044,!0),this._indexBuffer=new xn("ushort",this._numberIndices,35044,!0),this._vertexBuffer.setData(i),this._indexBuffer.setData(e),this.memorySize=2*(this._vertexBuffer._byteLength+this._indexBuffer._byteLength),this.completeCreate(),this._conchSky){this._conchSky.setVBIB(t._vertexDeclaration._conchVertexDeclaration,i,e),this._sharderNameID=cn.nameKey.getID("SkyBox");var f=pt._preCompileShader[this._sharderNameID];this._conchSky.setShader(f._conchShader)}},n._addVertex=function(e,t,n){var i=n.elements;return e[t+0]=i[0],e[t+1]=i[1],e[t+2]=i[2],t+3},n.loadShaderParams=function(){this._sharderNameID=cn.nameKey.getID("SkyBox"),this._shaderCompile=pt._preCompileShader[this._sharderNameID]},n._render=function(e){this._textureCube&&this._textureCube.loaded&&(this._vertexBuffer._bind(),this._indexBuffer._bind(),this._shader=this._getShader(e),this._shader.bind(),e.camera.transform.worldMatrix.cloneTo(t._tempMatrix4x40),t._tempMatrix4x40.transpose(),at.multiply(e._projectionMatrix,t._tempMatrix4x40,t._tempMatrix4x41),e.camera._shaderValues.setValue(4,t._tempMatrix4x41.elements),this._shader.uploadCameraUniforms(e.camera._shaderValues.data),this._shaderValue.setValue(1,this._colorIntensity),this._shaderValue.setValue(2,this._alphaBlending),this._shaderValue.setValue(3,this.textureCube.source),this._shader.uploadAttributes(t._vertexDeclaration.shaderValues.data,null),this._shader.uploadMaterialUniforms(this._shaderValue.data),N.mainContext.drawElements(4,36,5123,0),C.trianglesFaces+=12,C.drawCall++)},a(0,n,"textureCube",function(){return this._textureCube},function(e){this._textureCube=e,this._conchSky&&this._conchSky.setTextureCube(this._textureCube._conchTexture,0,3)}),t._nameNumber=1,i(t,["_tempMatrix4x40",function(){return this._tempMatrix4x40=new at},"_tempMatrix4x41",function(){return this._tempMatrix4x41=new at},"_vertexDeclaration",function(){return this._vertexDeclaration=new pe(12,[new ve(0,"vector3",0)])}])}(),function(e){function t(){this._numberVertices=0,this._numberIndices=0,this._texture=null,this._stacks=16,this._slices=16,this._radius=1,t.__super.call(this),this.name="SkyDome-"+t._nameNumber,t._nameNumber++,this.loadShaderParams(),this.recreateResource(),this.alphaBlending=1,this.colorIntensity=1}r(t,"laya.d3.resource.models.SkyDome",qt);var s=t.prototype;s._getShader=function(e){var t=e.scene._shaderDefineValue;return this._shader=this._shaderCompile.withCompile(t,0,0),this._shader},s.recreateResource=function(){this._numberVertices=(this._stacks+1)*(this._slices+1),this._numberIndices=3*this._stacks*(this._slices+1)*2;for(var e=new Uint16Array(this._numberIndices),n=t._vertexDeclaration.vertexStride/4,i=new Float32Array(this._numberVertices*n),r=Math.PI/this._stacks,a=2*Math.PI/this._slices,s=0,o=0,l=0,h=0;h<this._stacks+1;h++)for(var _=Math.sin(h*r),u=Math.cos(h*r),c=0;c<this._slices+1;c++){var d=_*Math.sin(c*a),f=_*Math.cos(c*a);i[o+0]=d*this._radius,i[o+1]=u*this._radius,i[o+2]=f*this._radius,i[o+3]=-c/this._slices+.75,i[o+4]=h/this._stacks,o+=n,h!=this._stacks-1&&(e[l++]=s+1,e[l++]=s,e[l++]=s+(this._slices+1),e[l++]=s+(this._slices+1),e[l++]=s,e[l++]=s+this._slices,s++)}if(this._vertexBuffer=new En(t._vertexDeclaration,this._numberVertices,35044),this._indexBuffer=new xn("ushort",this._numberIndices,35044),this._vertexBuffer.setData(i),this._indexBuffer.setData(e),this.memorySize=2*(this._vertexBuffer._byteLength+this._indexBuffer._byteLength),this.completeCreate(),this._conchSky){this._conchSky.setVBIB(t._vertexDeclaration._conchVertexDeclaration,i,e),this._sharderNameID=cn.nameKey.getID("SkyDome");var m=pt._preCompileShader[this._sharderNameID];this._conchSky.setShader(m._conchShader)}},s.loadShaderParams=function(){this._sharderNameID=cn.nameKey.getID("SkyDome"),this._shaderCompile=pt._preCompileShader[this._sharderNameID]},s._render=function(e){this._texture&&this._texture.loaded&&(this._vertexBuffer._bind(),this._indexBuffer._bind(),this._shader=this._getShader(e),this._shader.bind(),e.camera.transform.worldMatrix.cloneTo(t._tempMatrix4x40),t._tempMatrix4x40.transpose(),at.multiply(e._projectionMatrix,t._tempMatrix4x40,t._tempMatrix4x41),e.camera._shaderValues.setValue(4,t._tempMatrix4x41.elements),this._shader.uploadCameraUniforms(e.camera._shaderValues.data),this._shaderValue.setValue(1,this._colorIntensity),this._shaderValue.setValue(2,this._alphaBlending),this._shaderValue.setValue(3,this.texture.source),this._shader.uploadAttributes(t._vertexDeclaration.shaderValues.data,null),this._shader.uploadMaterialUniforms(this._shaderValue.data),N.mainContext.drawElements(4,this._indexBuffer.indexCount,5123,0),C.trianglesFaces+=this._numberIndices/3,C.drawCall++)},s.onEnvDescLoaded=function(e){var t="",i=Math.max(e.lastIndexOf("/"),e.lastIndexOf("\\"));i>0&&(t=e.substr(0,i+1));var r=n.loader.getRes(e);void 0!=r.ev&&this.__ownerCamera?this.__ownerCamera._shaderValues.setValue(13,Math.pow(2,r.ev)):this.__ownerCamera._shaderValues.setValue(13,Math.pow(2,0)),this.texture=wn.load(t+r.skytex),this.environmentSpecular=Mn.load(t+r.prefiltedEnv);var a=new Float32Array(r.IrradianceMat);this.envDiffuseSHRed=a.slice(0,16),this.envDiffuseSHGreen=a.slice(16,32),this.envDiffuseSHBlue=a.slice(32,48)},s.loadEnvInfo=function(e){n.loader.load(e,g.create(this,this.onEnvDescLoaded,[e]))},a(0,s,"texture",function(){return this._texture},function(e){this._texture=e,this._conchSky&&this._conchSky.setTexture(this._texture._conchTexture,0,3)}),t._nameNumber=1,i(t,["_tempMatrix4x40",function(){return this._tempMatrix4x40=new at},"_tempMatrix4x41",function(){return this._tempMatrix4x41=new at},"_vertexDeclaration",function(){return this._vertexDeclaration=new pe(20,[new ve(0,"vector3",0),new ve(12,"vector2",2)])}])}(),function(e){function t(e){this._cacheAvatar=null,this._cacheMesh=null,this._cacheAnimationNode=null,this._skinnedDatas=null,this._publicSubSkinnedDatas=null,this._cacheAnimator=null,t.__super.call(this,e),this._cacheAnimationNode=[],this._owner.meshFilter.on("meshchanged",this,this._$3__onMeshChanged)}r(t,"laya.d3.core.SkinnedMeshRender",rn);var n=t.prototype;return n._getCacheAnimationNodes=function(){var e=this._cacheMesh._boneNames,t=e.length;this._cacheAnimationNode.length=t;for(var n=this._cacheAnimator._avatarNodeMap,i=0;i<t;i++)this._cacheAnimationNode[i]=n[e[i]]},n._offComputeBoneIndexToMeshEvent=function(e,t){e.loaded?t.loaded||t.off("loaded",this,this._getCacheAnimationNodes):e.off("loaded",this,this._computeBoneIndexToMeshWithAsyncMesh)},n._computeBoneIndexToMeshWithAsyncAvatar=function(){this._cacheAvatar.loaded?this._computeBoneIndexToMeshWithAsyncMesh():this._cacheAvatar.once("loaded",this,this._computeBoneIndexToMeshWithAsyncMesh)},n._computeBoneIndexToMeshWithAsyncMesh=function(){this._cacheMesh.loaded?this._getCacheAnimationNodes():this._cacheMesh.on("loaded",this,this._getCacheAnimationNodes)},n._$3__onMeshChanged=function(e,t,n){this._cacheMesh=n;var i=n.subMeshCount;this._skinnedDatas=new Float32Array(16*n.InverseAbsoluteBindPoses.length),this._publicSubSkinnedDatas=[],this._publicSubSkinnedDatas.length=i;for(var r=0;r<i;r++)for(var a=this._publicSubSkinnedDatas[r]=[],s=n.getSubMesh(r)._boneIndicesList,o=0,l=s.length;o<l;o++)a[o]=new Float32Array(16*s[o].length);this._cacheAvatar&&(t&&this._offComputeBoneIndexToMeshEvent(this._cacheAvatar,t),n&&this._computeBoneIndexToMeshWithAsyncAvatar())},n._setCacheAvatar=function(e){this._cacheAvatar!==e&&(this._cacheMesh?(this._cacheAvatar&&this._offComputeBoneIndexToMeshEvent(this._cacheAvatar,this._cacheMesh),this._cacheAvatar=e,e&&(this._addShaderDefine(zn.SHADERDEFINE_BONE),this._computeBoneIndexToMeshWithAsyncAvatar())):this._cacheAvatar=e)},n._renderUpdate=function(e){var n,i=this._cacheAnimator,r=this._cacheMesh.subMeshCount;if(i){var a=i.owner;if(this._setShaderValueMatrix4x4(0,a._transform.worldMatrix),n=a.getProjectionViewWorldMatrix(e),this._setShaderValueMatrix4x4(1,n),this._cacheMesh&&this._cacheMesh.loaded&&this._cacheAvatar&&this._cacheAvatar.loaded){var s,o,l,h,_=0,u=0,c=0,d=0;if(0!==i.playState&&i._canCache){if(s=i.currentPlayClip._getSkinnedDatasWithCache(this._cacheMesh,this._cacheAvatar,i.cachePlayRate,i.currentFrameIndex)){for(_=0;_<r;_++)this._renderElements[_]._skinAnimationDatas=s[_];return}for(i._updateTansformProperty(),_=0,u=(o=this._cacheMesh._inverseBindPoses).length;_<u;_++)Ct._mulMatrixArray(this._cacheAnimationNode[_]._transform._getWorldMatrix(),o[_],this._skinnedDatas,16*_);for((s=[]).length=r,_=0;_<r;_++){for(h=s[_]=[],d=(l=this._cacheMesh.getSubMesh(_)._boneIndicesList).length,h.length=d,c=0;c<d;c++)h[c]=new Float32Array(16*l[c].length),t._splitAnimationDatas(l[c],this._skinnedDatas,h[c]);this._renderElements[_]._skinAnimationDatas=h}i.currentPlayClip._cacheSkinnedDatasWithCache(this._cacheMesh,this._cacheAvatar,i.cachePlayRate,i.currentFrameIndex,s)}else{for(_=0,u=(o=this._cacheMesh._inverseBindPoses).length;_<u;_++)Ct._mulMatrixArray(this._cacheAnimationNode[_]._transform._getWorldMatrix(),o[_],this._skinnedDatas,16*_);for(_=0;_<r;_++){for(d=(l=this._cacheMesh.getSubMesh(_)._boneIndicesList).length,h=this._publicSubSkinnedDatas[_],c=0;c<d;c++)t._splitAnimationDatas(l[c],this._skinnedDatas,h[c]);this._renderElements[_]._skinAnimationDatas=h}}}}else this._setShaderValueMatrix4x4(0,this._owner.transform.worldMatrix),n=this._owner.getProjectionViewWorldMatrix(e),this._setShaderValueMatrix4x4(1,n)},t._splitAnimationDatas=function(e,t,n){for(var i=0,r=e.length,a=0;i<r;i++)for(var s=0;s<16;s++,a++)n[a]=t[(e[i]<<4)+s]},t}()),On=function(e){function t(e,i){t.__super.call(this),void 0===e&&(e=.3),void 0===i&&(i=1e3),this._tempVector3=new ct,this._position=new ct,this._up=new ct,this._forward=new ct,this._right=new ct,this._fieldOfView=60,this._useUserProjectionMatrix=!1,this._orthographic=!1,this._viewportExpressedInClipSpace=!0,this._renderTargetSize=At.fullScreen,this._orthographicVerticalSize=10,this.renderingOrder=0,this._nearPlane=e,this._farPlane=i,this.cullingMask=2147483647,this.clearFlag=0,this.useOcclusionCulling=!0,this._calculateProjectionMatrix(),n.stage.on("resize",this,this._onScreenSizeChanged)}r(t,"laya.d3.core.BaseCamera",e);var s=t.prototype;return s.createConchModel=function(){return new ConchCamera},s._sortCamerasByRenderingOrder=function(){if(this._displayedInStage)for(var e=this.scene._cameraPool,t=e.length-1,n=0;n<t;n++)if(e[n].renderingOrder>e[t].renderingOrder){var i=e[n];e[n]=e[t],e[t]=i}},s._calculateProjectionMatrix=function(){},s._onScreenSizeChanged=function(){this._calculateProjectionMatrix()},s._prepareCameraToRender=function(){H._currentCameraCullingMask=this.cullingMask;var e=this._shaderValues;e.setValue(0,this.transform.position.elements),e.setValue(5,this.forward.elements),e.setValue(6,this.up.elements)},s._prepareCameraViewProject=function(e,t){var n=this._shaderValues;n.setValue(1,e.elements),n.setValue(2,t.elements)},s._renderCamera=function(e,t,n){},s.addLayer=function(e){29!==e.number&&30!=e.number&&(this.cullingMask=this.cullingMask|e.mask)},s.removeLayer=function(e){29!==e.number&&30!=e.number&&(this.cullingMask=this.cullingMask&~e.mask)},s.addAllLayers=function(){this.cullingMask=2147483647},s.removeAllLayers=function(){this.cullingMask=0|H.getLayerByNumber(29).mask|H.getLayerByNumber(30).mask},s.ResetProjectionMatrix=function(){this._useUserProjectionMatrix=!1,this._calculateProjectionMatrix()},s.destroy=function(t){void 0===t&&(t=!0),this._sky&&(this._sky._ownerCamera=null,this._sky=null),this.renderTarget=null,n.stage.off("resize",this,this._onScreenSizeChanged),e.prototype.destroy.call(this,t)},s.moveForward=function(e){this._tempVector3.elements[0]=this._tempVector3.elements[1]=0,this._tempVector3.elements[2]=e,this.transform.translate(this._tempVector3)},s.moveRight=function(e){this._tempVector3.elements[1]=this._tempVector3.elements[2]=0,this._tempVector3.elements[0]=e,this.transform.translate(this._tempVector3)},s.moveVertical=function(e){this._tempVector3.elements[0]=this._tempVector3.elements[2]=0,this._tempVector3.elements[1]=e,this.transform.translate(this._tempVector3,!1)},s._addSelfRenderObjects=function(){var e=this.scene._cameraPool,t=e.length;if(t>0){for(var n=t-1;n>=0;n--)if(this.renderingOrder<=e[n].renderingOrder){e.splice(n+1,0,this);break}}else e.push(this),this.scene.conchModel&&this.scene.conchModel.setCurrentCamera(this.conchModel)},s._clearSelfRenderObjects=function(){var e=this.scene._cameraPool;e.splice(e.indexOf(this),1)},a(0,s,"sky",function(){return this._sky},function(e){this._sky=e,e._ownerCamera=this,this.conchModel&&this.conchModel.setSkyMesh(this._sky._conchSky)}),a(0,s,"forward",function(){var e=this.transform.worldMatrix.elements,t=this._forward.elements;return t[0]=-e[8],t[1]=-e[9],t[2]=-e[10],this._forward}),a(0,s,"position",function(){var e=this.transform.worldMatrix.elements,t=this._position.elements;return t[0]=e[12],t[1]=e[13],t[2]=e[14],this._position}),a(0,s,"renderTarget",function(){return this._renderTarget},function(e){this._renderTarget=e,null!=e&&(this._renderTargetSize=e.size)}),a(0,s,"up",function(){var e=this.transform.worldMatrix.elements,t=this._up.elements;return t[0]=e[4],t[1]=e[5],t[2]=e[6],this._up}),a(0,s,"right",function(){var e=this.transform.worldMatrix.elements,t=this._right.elements;return t[0]=e[0],t[1]=e[1],t[2]=e[2],this._right}),a(0,s,"renderTargetSize",function(){return this._renderTargetSize},function(e){null!=this.renderTarget&&this._renderTargetSize,this._renderTargetSize=e,this._calculateProjectionMatrix()}),a(0,s,"fieldOfView",function(){return this._fieldOfView},function(e){this._fieldOfView=e,this._calculateProjectionMatrix()}),a(0,s,"nearPlane",function(){return this._nearPlane},function(e){this._nearPlane=e,this._calculateProjectionMatrix()}),a(0,s,"farPlane",function(){return this._farPlane},function(e){this._farPlane=e,this._calculateProjectionMatrix()}),a(0,s,"orthographic",function(){return this._orthographic},function(e){this._orthographic=e,this._calculateProjectionMatrix()}),a(0,s,"orthographicVerticalSize",function(){return this._orthographicVerticalSize},function(e){this._orthographicVerticalSize=e,this._calculateProjectionMatrix()}),a(0,s,"renderingOrder",function(){return this._renderingOrder},function(e){this._renderingOrder=e,this._sortCamerasByRenderingOrder()}),t.CAMERAPOS=0,t.VIEWMATRIX=1,t.PROJECTMATRIX=2,t.VPMATRIX=3,t.VPMATRIX_NO_TRANSLATE=4,t.CAMERADIRECTION=5,t.CAMERAUP=6,t.ENVIRONMENTDIFFUSE=7,t.ENVIRONMENTSPECULAR=8,t.SIMLODINFO=9,t.DIFFUSEIRRADMATR=10,t.DIFFUSEIRRADMATG=11,t.DIFFUSEIRRADMATB=12,t.HDREXPOSURE=13,t.RENDERINGTYPE_DEFERREDLIGHTING="DEFERREDLIGHTING",t.RENDERINGTYPE_FORWARDRENDERING="FORWARDRENDERING",t.CLEARFLAG_SOLIDCOLOR=0,t.CLEARFLAG_SKY=1,t.CLEARFLAG_DEPTHONLY=2,t.CLEARFLAG_NONE=3,i(t,["_invertYScaleMatrix",function(){return this._invertYScaleMatrix=new at(1,0,0,0,0,-1,0,0,0,0,1,0,0,0,0,1)},"_invertYProjectionMatrix",function(){return this._invertYProjectionMatrix=new at},"_invertYProjectionViewMatrix",function(){return this._invertYProjectionViewMatrix=new at}]),t}(un),bn=function(e){function t(e){this._render=null,this._geometryFilter=null,t.__super.call(this,e)}r(t,"laya.d3.core.RenderableSprite3D",e);var n=t.prototype;return n._addToInitStaticBatchManager=function(){},n._setBelongScene=function(t){e.prototype._setBelongScene.call(this,t),t._renderableSprite3Ds.push(this),this._render._applyLightMapParams()},n._setUnBelongScene=function(){var t=this._scene._renderableSprite3Ds,n=t.indexOf(this);t.splice(n,1),this._render._removeShaderDefine(4),e.prototype._setUnBelongScene.call(this)},n._update=function(e){e.owner=this,this._activeInHierarchy&&(this._updateComponents(e),this._render._updateOctreeNode(),this._lateUpdateComponents(e),C.spriteCount++,this._childs.length&&this._updateChilds(e))},n.destroy=function(t){void 0===t&&(t=!0),e.prototype.destroy.call(this,t),this._render._destroy(),this._render=null},n._updateConch=function(e){e.owner=this,this._activeInHierarchy&&(this._updateComponents(e),this._render._updateOctreeNode(),this._lateUpdateComponents(e),C.spriteCount++,this._childs.length&&this._updateChildsConch(e))},t.SHADERDEFINE_SCALEOFFSETLIGHTINGMAPUV=2,t.SAHDERDEFINE_LIGHTMAP=4,t.LIGHTMAPSCALEOFFSET=2,t.LIGHTMAP=3,t}(un),Pn=function(e){function t(){this._shadow=!1,this._shadowFarPlane=0,this._shadowMapSize=0,this._shadowMapCount=0,this._shadowMapPCFType=0,this._parallelSplitShadowMap=null,this.color=null,t.__super.call(this),this.color=new ct(1,1,1),this._shadow=!1,this._shadowFarPlane=8,this._shadowMapSize=512,this._shadowMapCount=1,this._shadowMapPCFType=0}r(t,"laya.d3.core.light.LightSprite",un);var n=t.prototype;return n._addSelfRenderObjects=function(){this.scene._addLight(this)},n._clearSelfRenderObjects=function(){this.scene._removeLight(this)},n.updateToWorldState=function(e){return!1},a(0,n,"diffuseColor",function(){return console.log("LightSprite: discard property,please use color property instead."),this.color},function(e){console.log("LightSprite: discard property,please use color property instead."),this.color=e}),a(0,n,"shadow",function(){return this._shadow},function(e){throw new Error("LightSprite: must override it.")}),a(0,n,"shadowDistance",function(){return this._shadowFarPlane},function(e){this._shadowFarPlane=e,this._parallelSplitShadowMap&&this._parallelSplitShadowMap.setFarDistance(e)}),a(0,n,"shadowPSSMCount",function(){return this._shadowMapCount},function(e){this._shadowMapCount=e,this._parallelSplitShadowMap&&(this._parallelSplitShadowMap.PSSMNum=e)}),a(0,n,"shadowResolution",function(){return this._shadowMapSize},function(e){this._shadowMapSize=e,this._parallelSplitShadowMap&&this._parallelSplitShadowMap.setShadowMapTextureSize(e)}),a(0,n,"shadowPCFType",function(){return this._shadowMapPCFType},function(e){this._shadowMapPCFType=e,this._parallelSplitShadowMap&&this._parallelSplitShadowMap.setPCFType(e)}),a(0,n,"lightType",function(){return-1}),t.TYPE_DIRECTIONLIGHT=1,t.TYPE_POINTLIGHT=2,t.TYPE_SPOTLIGHT=3,t}(),Ln=function(e){function t(e){this._terrainRes=null,this._lightmapScaleOffset=null,t.__super.call(this),this._lightmapScaleOffset=new dt(1,1,0,0),e&&(this._terrainRes=e,e.loaded?this.buildTerrain(e):e.once("loaded",this,this.buildTerrain))}r(t,"laya.d3.terrain.Terrain",un);var i=t.prototype;return i._parseCustomProps=function(e,t,n,i){this.terrainRes=x.getRes(t[n.dataPath]);var r=n.lightmapIndex;null!=r&&this.setLightmapIndex(r);var a=n.lightmapScaleOffset;a&&this.setLightmapScaleOffset(new dt(a[0],a[1],a[2],a[3]))},i.setLightmapIndex=function(e){for(var t=0;t<this._childs.length;t++)this._childs[t].terrainRender.lightmapIndex=e},i.setLightmapScaleOffset=function(e){if(e){e.cloneTo(this._lightmapScaleOffset);for(var t=0;t<this._childs.length;t++)this._childs[t].terrainRender.lightmapScaleOffset=this._lightmapScaleOffset}},i.disableLight=function(){for(var e=0,t=this._childs.length;e<t;e++)for(var n=this._childs[e],i=0,r=n._render.sharedMaterials.length;i<r;i++)n._render.sharedMaterials[i].disableLight()},i.buildTerrain=function(e){for(var t=e._chunkNumX,n=e._chunkNumZ,i=e._heightData,r=0,a=0;a<n;a++)for(var s=0;s<t;s++){for(var o=new Gn(s,a,e._gridSize,i._terrainHeightData,i._width,i._height,e._cameraCoordinateInverse),l=e._chunkInfos[r++],h=0;h<l.alphaMap.length;h++){var _=l.detailID[h].length,u=_>0?e._detailTextureInfos[l.detailID[h][0]].diffuseTexture:null,c=_>1?e._detailTextureInfos[l.detailID[h][1]].diffuseTexture:null,d=_>2?e._detailTextureInfos[l.detailID[h][2]].diffuseTexture:null,f=_>3?e._detailTextureInfos[l.detailID[h][3]].diffuseTexture:null,m=_>0?e._detailTextureInfos[l.detailID[h][0]].scale:null,p=_>1?e._detailTextureInfos[l.detailID[h][1]].scale:null,v=_>2?e._detailTextureInfos[l.detailID[h][2]].scale:null,g=_>3?e._detailTextureInfos[l.detailID[h][3]].scale:null;o.buildRenderElementAndMaterial(_,l.normalMap,l.alphaMap[h],u,c,d,f,e._materialInfo.ambientColor,e._materialInfo.diffuseColor,e._materialInfo.specularColor,m?m.x:1,m?m.y:1,p?p.x:1,p?p.y:1,v?v.x:1,v?v.y:1,g?g.x:1,g?g.y:1)}o.terrainRender.receiveShadow=!0,o.terrainRender.lightmapScaleOffset=this._lightmapScaleOffset,this.addChild(o)}},i.width=function(){return this._terrainRes._chunkNumX*Et.CHUNK_GRID_NUM*this._terrainRes._gridSize},i.depth=function(){return this._terrainRes._chunkNumZ*Et.CHUNK_GRID_NUM*this._terrainRes._gridSize},i.getHeightXZ=function(e,n){if(!this._terrainRes||!this._terrainRes.loaded)return NaN;if(e-=this.transform.position.x,n-=this.transform.position.z,t.__VECTOR3__||(t.__VECTOR3__=new ct),t.__VECTOR3__.elements[0]=e,t.__VECTOR3__.elements[1]=0,t.__VECTOR3__.elements[2]=n,ct.transformV3ToV3(t.__VECTOR3__,Et.__ADAPT_MATRIX_INV__,t.__VECTOR3__),e=t.__VECTOR3__.elements[0],n=t.__VECTOR3__.elements[2],e<0||e>this.width()||n<0||n>this.depth())return NaN;var i=this._terrainRes._gridSize,r=parseInt(""+e/i),a=parseInt(""+n/i),s=e-r*i,o=n-a*i,l=NaN,h=NaN,_=NaN,u=NaN,c=NaN,d=this._terrainRes._heightData;return s+o>i?(l=d._terrainHeightData[(a+1-1)*d._width+r+1],h=d._terrainHeightData[(a+1-1)*d._width+r],_=d._terrainHeightData[(a-1)*d._width+r+1],u=(i-s)/i,c=(i-o)/i,l+(h-l)*u+(_-l)*c):(l=d._terrainHeightData[Math.max(0,a-1)*d._width+r],h=d._terrainHeightData[Math.min(d._width*d._height-1,(a+1-1)*d._width+r)],_=d._terrainHeightData[Math.min(d._width*d._height-1,Math.max(0,a-1)*d._width+r+1)],u=s/i,c=o/i,l+(h-l)*c+(_-l)*u)},a(0,i,"terrainRes",null,function(e){e&&(this._terrainRes=e,e.loaded?this.buildTerrain(e):e.once("loaded",this,this.buildTerrain))}),t.load=function(e){return n.loader.create(e,null,null,t,null,1,!1)},t.RENDER_LINE_MODEL=!1,t.LOD_TOLERANCE_VALUE=4,t.LOD_DISTANCE_FACTOR=2,t.__VECTOR3__=null,t}(),Fn=(function(e){function t(e,n,i){this._long=NaN,this._width=NaN,this._height=NaN,void 0===e&&(e=1),void 0===n&&(n=1),void 0===i&&(i=1),t.__super.call(this),this._long=e,this._width=n,this._height=i,this.activeResource(),this._generateBoundingObject()}r(t,"laya.d3.resource.models.BoxMesh",yn);var n=t.prototype;n.recreateResource=function(){this._numberVertices=24,this._numberIndices=36;var e=be.vertexDeclaration,t=(e.vertexStride,this._long/2),n=this._height/2,i=this._width/2,r=new Float32Array([-t,n,-i,0,1,0,0,0,t,n,-i,0,1,0,1,0,t,n,i,0,1,0,1,1,-t,n,i,0,1,0,0,1,-t,-n,-i,0,-1,0,0,1,t,-n,-i,0,-1,0,1,1,t,-n,i,0,-1,0,1,0,-t,-n,i,0,-1,0,0,0,-t,n,-i,-1,0,0,0,0,-t,n,i,-1,0,0,1,0,-t,-n,i,-1,0,0,1,1,-t,-n,-i,-1,0,0,0,1,t,n,-i,1,0,0,1,0,t,n,i,1,0,0,0,0,t,-n,i,1,0,0,0,1,t,-n,-i,1,0,0,1,1,-t,n,i,0,0,1,0,0,t,n,i,0,0,1,1,0,t,-n,i,0,0,1,1,1,-t,-n,i,0,0,1,0,1,-t,n,-i,0,0,-1,1,0,t,n,-i,0,0,-1,0,0,t,-n,-i,0,0,-1,0,1,-t,-n,-i,0,0,-1,1,1]),a=new Uint16Array([0,1,2,2,3,0,4,7,6,6,5,4,8,9,10,10,11,8,12,15,14,14,13,12,16,17,18,18,19,16,20,23,22,22,21,20]);this._vertexBuffer=new En(e,this._numberVertices,35044,!0),this._indexBuffer=new xn("ushort",this._numberIndices,35044,!0),this._vertexBuffer.setData(r),this._indexBuffer.setData(a),this.memorySize=2*(this._vertexBuffer._byteLength+this._indexBuffer._byteLength),this.completeCreate()},a(0,n,"long",function(){return this._long},function(e){this._long!==e&&(this._long=e,this.releaseResource(),this.activeResource())}),a(0,n,"width",function(){return this._width},function(e){this._width!==e&&(this._width=e,this.releaseResource(),this.activeResource())}),a(0,n,"height",function(){return this._height},function(e){this._height!==e&&(this._height=e,this.releaseResource(),this.activeResource())})}(),function(e){function t(e,n,i,r){this._radius=NaN,this._height=NaN,this._slices=0,this._stacks=0,void 0===e&&(e=.5),void 0===n&&(n=2),void 0===i&&(i=16),void 0===r&&(r=32),t.__super.call(this),this._radius=e,this._height=n<2*e?2*e:n,this._stacks=i,this._slices=r,this.recreateResource(),this._generateBoundingObject()}r(t,"laya.d3.resource.models.CapsuleMesh",yn);var n=t.prototype;n.recreateResource=function(){this._numberVertices=(this._stacks+1)*(this.slices+1)*2+2*(this._slices+1),this._numberIndices=3*this._stacks*(this._slices+1)*2*2+2*this._slices*3;var e=be.vertexDeclaration,t=e.vertexStride/4,n=new Float32Array(this._numberVertices*t),i=new Uint16Array(this._numberIndices),r=Math.PI/2/this._stacks,a=2*Math.PI/this._slices,s=this._height/2-this._radius,o=0,l=0,h=0,_=0,u=0,c=0,d=0,f=0;for(d=0;d<=this._stacks;d++)for(f=0;f<=this._slices;f++)o=this._radius*Math.cos(d*r)*Math.cos(f*a+Math.PI),l=this._radius*Math.sin(d*r),h=this._radius*Math.cos(d*r)*Math.sin(f*a+Math.PI),n[_++]=o,n[_++]=l+s,n[_++]=h,n[_++]=o,n[_++]=l,n[_++]=h,n[_++]=1-f/this._slices,n[_++]=(1-d/this._stacks)*(Math.PI*this._radius/2/(this._height+Math.PI*this._radius)),d<this._stacks&&(i[u++]=d*(this._slices+1)+f+(this._slices+1),i[u++]=d*(this._slices+1)+f,i[u++]=d*(this._slices+1)+f+1,i[u++]=d*(this._slices+1)+f+this._slices,i[u++]=d*(this._slices+1)+f,i[u++]=d*(this._slices+1)+f+(this._slices+1));for(c+=(this._stacks+1)*(this._slices+1),d=0;d<=this._stacks;d++)for(f=0;f<=this._slices;f++)o=this._radius*Math.cos(d*r)*Math.cos(f*a+Math.PI),l=this._radius*Math.sin(-d*r),h=this._radius*Math.cos(d*r)*Math.sin(f*a+Math.PI),n[_++]=o,n[_++]=l-s,n[_++]=h,n[_++]=o,n[_++]=l,n[_++]=h,n[_++]=1-f/this._slices,n[_++]=(d/this._stacks*(Math.PI*this._radius/2)+(this._height+Math.PI*this._radius/2))/(this._height+Math.PI*this._radius),d<this._stacks&&(i[u++]=c+d*(this._slices+1)+f,i[u++]=c+d*(this._slices+1)+f+(this._slices+1),i[u++]=c+d*(this._slices+1)+f+1,i[u++]=c+d*(this._slices+1)+f,i[u++]=c+d*(this._slices+1)+f+this._slices,i[u++]=c+d*(this._slices+1)+f+(this._slices+1));for(c+=(this._stacks+1)*(this._slices+1),f=0;f<=this._slices;f++)o=this._radius*Math.cos(f*a+Math.PI),l=s,h=this._radius*Math.sin(f*a+Math.PI),n[_++]=o,n[_+8*(this._slices+1)-1]=o,n[_++]=l,n[_+8*(this._slices+1)-1]=-l,n[_++]=h,n[_+8*(this._slices+1)-1]=h,n[_++]=o,n[_+8*(this._slices+1)-1]=o,n[_++]=0,n[_+8*(this._slices+1)-1]=0,n[_++]=h,n[_+8*(this._slices+1)-1]=h,n[_++]=1-1*f/this._slices,n[_+8*(this._slices+1)-1]=1-1*f/this._slices,n[_++]=Math.PI*this._radius/2/(this._height+Math.PI*this._radius),n[_+8*(this._slices+1)-1]=(Math.PI*this._radius/2+this._height)/(this._height+Math.PI*this._radius);for(f=0;f<this._slices;f++)i[u++]=f+c+(this._slices+1),i[u++]=f+c+1,i[u++]=f+c,i[u++]=f+c+(this._slices+1),i[u++]=f+c+(this._slices+1)+1,i[u++]=f+c+1;c+=2*(this._slices+1),this._vertexBuffer=new En(e,this._numberVertices,35044,!0),this._indexBuffer=new xn("ushort",this._numberIndices,35044,!0),this._vertexBuffer.setData(n),this._indexBuffer.setData(i),this.memorySize=2*(this._vertexBuffer._byteLength+this._indexBuffer._byteLength),this.completeCreate()},a(0,n,"radius",function(){return this._radius},function(e){this._radius!==e&&(this._radius=e,this.releaseResource(),this.activeResource())}),a(0,n,"height",function(){return this._height},function(e){this._height!==e&&(this._height=e,this.releaseResource(),this.activeResource())}),a(0,n,"stacks",function(){return this._stacks},function(e){this._stacks!==e&&(this._stacks=e,this.releaseResource(),this.activeResource())}),a(0,n,"slices",function(){return this._slices},function(e){this._slices!==e&&(this._slices=e,this.releaseResource(),this.activeResource())})}(),function(e){function t(e,n,i){this._radius=NaN,this._height=NaN,this._slices=0,void 0===e&&(e=.5),void 0===n&&(n=2),void 0===i&&(i=32),t.__super.call(this),this._radius=e,this._height=n,this._slices=i,this.recreateResource(),this._generateBoundingObject()}r(t,"laya.d3.resource.models.CylinderMesh",yn);var n=t.prototype;n.recreateResource=function(){this._numberVertices=this._slices+1+1+2*(this._slices+1)+(this._slices+1+1),this._numberIndices=3*this._slices+6*this._slices+3*this._slices;for(var e=be.vertexDeclaration,t=e.vertexStride/4,n=new Float32Array(this._numberVertices*t),i=new Uint16Array(this._numberIndices),r=2*Math.PI/this._slices,a=this._height/2,s=0,o=0,l=0,h=0,_=0,u=0,c=0,d=0;d<=this._slices;d++)0===d&&(n[u++]=0,n[u++]=a,n[u++]=0,n[u++]=0,n[u++]=1,n[u++]=0,n[u++]=.5,n[u++]=.5),s=d*r,l=Math.cos(s)*this._radius,h=a,_=Math.sin(s)*this._radius,n[u++]=l,n[u++]=h,n[u++]=_,n[u++]=0,n[u++]=1,n[u++]=0,n[u++]=.5+.5*Math.cos(s),n[u++]=.5+.5*Math.sin(s);for(var f=0;f<this._slices;f++)i[c++]=0,i[c++]=f+1,i[c++]=f+2;o+=this._slices+1+1;for(var m=0;m<=this._slices;m++)s=m*r,l=Math.cos(s+Math.PI)*this._radius,h=a,_=Math.sin(s+Math.PI)*this._radius,n[u++]=l,n[u+8*(this._slices+1)-1]=l,n[u++]=h,n[u+8*(this._slices+1)-1]=-h,n[u++]=_,n[u+8*(this._slices+1)-1]=_,n[u++]=l,n[u+8*(this._slices+1)-1]=l,n[u++]=0,n[u+8*(this._slices+1)-1]=0,n[u++]=_,n[u+8*(this._slices+1)-1]=_,n[u++]=1-1*m/this._slices,n[u+8*(this._slices+1)-1]=1-1*m/this._slices,n[u++]=0,n[u+8*(this._slices+1)-1]=1;u+=8*(this._slices+1);for(var p=0;p<this._slices;p++)i[c++]=p+o+(this._slices+1),i[c++]=p+o+1,i[c++]=p+o,i[c++]=p+o+(this._slices+1),i[c++]=p+o+(this._slices+1)+1,i[c++]=p+o+1;o+=2*(this._slices+1);for(var v=0;v<=this._slices;v++)0===v&&(n[u++]=0,n[u++]=-a,n[u++]=0,n[u++]=0,n[u++]=-1,n[u++]=0,n[u++]=.5,n[u++]=.5),s=v*r,l=Math.cos(s+Math.PI)*this._radius,h=-a,_=Math.sin(s+Math.PI)*this._radius,n[u++]=l,n[u++]=h,n[u++]=_,n[u++]=0,n[u++]=-1,n[u++]=0,n[u++]=.5+.5*Math.cos(s),n[u++]=.5+.5*Math.sin(s);for(var g=0;g<this._slices;g++)i[c++]=0+o,i[c++]=g+2+o,i[c++]=g+1+o;o+=this._slices+1+1,this._vertexBuffer=new En(e,this._numberVertices,35044,!0),this._indexBuffer=new xn("ushort",this._numberIndices,35044,!0),this._vertexBuffer.setData(n),this._indexBuffer.setData(i),this.memorySize=2*(this._vertexBuffer._byteLength+this._indexBuffer._byteLength),this.completeCreate()},a(0,n,"radius",function(){return this._radius},function(e){this._radius!==e&&(this._radius=e,this.releaseResource(),this.activeResource())}),a(0,n,"height",function(){return this._height},function(e){this._height!==e&&(this._height=e,this.releaseResource(),this.activeResource())}),a(0,n,"slices",function(){return this._slices},function(e){this._slices!==e&&(this._slices=e,this.releaseResource(),this.activeResource())})}(),function(e){function t(e,n,i,r){this._long=NaN,this._width=NaN,this._stacks=0,this._slices=0,void 0===e&&(e=10),void 0===n&&(n=10),void 0===i&&(i=10),void 0===r&&(r=10),t.__super.call(this),this._long=e,this._width=n,this._stacks=i,this._slices=r,this.activeResource(),this._generateBoundingObject()}r(t,"laya.d3.resource.models.PlaneMesh",yn);var n=t.prototype;n.recreateResource=function(){this._numberVertices=(this._stacks+1)*(this._slices+1),this._numberIndices=this._stacks*this._slices*2*3;for(var e=new Uint16Array(this._numberIndices),t=be.vertexDeclaration,n=t.vertexStride/4,i=new Float32Array(this._numberVertices*n),r=this._long/2,a=this._width/2,s=this._long/this._stacks,o=this._width/this._slices,l=0,h=0;h<=this._slices;h++)for(var _=0;_<=this._stacks;_++)i[l++]=_*s-r,i[l++]=0,i[l++]=h*o-a,i[l++]=0,i[l++]=1,i[l++]=0,i[l++]=1*_/this._stacks,i[l++]=1*h/this._slices;var u=0;for(h=0;h<this._slices;h++)for(_=0;_<this._stacks;_++)e[u++]=(h+1)*(this._stacks+1)+_,e[u++]=h*(this._stacks+1)+_,e[u++]=(h+1)*(this._stacks+1)+_+1,e[u++]=h*(this._stacks+1)+_,e[u++]=h*(this._stacks+1)+_+1,e[u++]=(h+1)*(this._stacks+1)+_+1;this._vertexBuffer=new En(t,this._numberVertices,35044,!0),this._indexBuffer=new xn("ushort",this._numberIndices,35044,!0),this._vertexBuffer.setData(i),this._indexBuffer.setData(e),this.memorySize=2*(this._vertexBuffer._byteLength+this._indexBuffer._byteLength),this.completeCreate()},a(0,n,"long",function(){return this._long},function(e){this._long!==e&&(this._long=e,this.releaseResource(),this.activeResource())}),a(0,n,"width",function(){return this._width},function(e){this._width!==e&&(this._width=e,this.releaseResource(),this.activeResource())}),a(0,n,"stacks",function(){return this._stacks},function(e){this._stacks!==e&&(this._stacks=e,this.releaseResource(),this.activeResource())}),a(0,n,"slices",function(){return this._slices},function(e){this._slices!==e&&(this._slices=e,this.releaseResource(),this.activeResource())})}(),function(e){function t(e,n){this._long=NaN,this._width=NaN,void 0===e&&(e=1),void 0===n&&(n=1),t.__super.call(this),this._long=e,this._width=n,this.activeResource(),this._generateBoundingObject()}r(t,"laya.d3.resource.models.QuadMesh",yn);var n=t.prototype;return n.recreateResource=function(){this._numberVertices=4,this._numberIndices=6;var e=be.vertexDeclaration,t=(e.vertexStride,this._long/2),n=this._width/2,i=new Float32Array([-t,n,0,0,0,1,0,0,t,n,0,0,0,1,1,0,-t,-n,0,0,0,1,0,1,t,-n,0,0,0,1,1,1]),r=new Uint16Array([0,1,2,3,2,1]);this._vertexBuffer=new En(e,this._numberVertices,35044,!0),this._indexBuffer=new xn("ushort",this._numberIndices,35044,!0),this._vertexBuffer.setData(i),this._indexBuffer.setData(r),this.memorySize=2*(this._vertexBuffer._byteLength+this._indexBuffer._byteLength),this.completeCreate()},a(0,n,"long",function(){return this._long},function(e){this._long!==e&&(this._long=e,this.releaseResource(),this.activeResource())}),a(0,n,"width",function(){return this._width},function(e){this._width!==e&&(this._width=e,this.releaseResource(),this.activeResource())}),t}()),Bn=(function(e){function t(e,n,i){this._radius=NaN,this._slices=0,this._stacks=0,void 0===e&&(e=.5),void 0===n&&(n=32),void 0===i&&(i=32),t.__super.call(this),this._radius=e,this._stacks=n,this._slices=i,this.activeResource(),this._generateBoundingObject()}r(t,"laya.d3.resource.models.SphereMesh",yn);var n=t.prototype;n.recreateResource=function(){this._numberVertices=(this._stacks+1)*(this._slices+1),this._numberIndices=3*this._stacks*(this._slices+1)*2;for(var e=new Uint16Array(this._numberIndices),t=be.vertexDeclaration,n=t.vertexStride/4,i=new Float32Array(this._numberVertices*n),r=Math.PI/this._stacks,a=2*Math.PI/this._slices,s=0,o=0,l=0,h=0;h<this._stacks+1;h++)for(var _=Math.sin(h*r),u=Math.cos(h*r),c=0;c<this._slices+1;c++){var d=_*Math.sin(c*a+1*Math.PI/2),f=_*Math.cos(c*a+1*Math.PI/2);i[o+0]=d*this._radius,i[o+1]=u*this._radius,i[o+2]=f*this._radius,i[o+3]=d,i[o+4]=u,i[o+5]=f,i[o+6]=c/this._slices,i[o+7]=h/this._stacks,o+=n,h!=this._stacks-1&&(e[l++]=s+(this._slices+1),e[l++]=s,e[l++]=s+1,e[l++]=s+this._slices,e[l++]=s,e[l++]=s+(this._slices+1),s++)}this._vertexBuffer=new En(t,this._numberVertices,35044,!0),this._indexBuffer=new xn("ushort",this._numberIndices,35044,!0),this._vertexBuffer.setData(i),this._indexBuffer.setData(e),this.memorySize=2*(this._vertexBuffer._byteLength+this._indexBuffer._byteLength),this.completeCreate()},a(0,n,"radius",function(){return this._radius},function(e){this._radius!==e&&(this._radius=e,this.releaseResource(),this.activeResource())}),a(0,n,"slices",function(){return this._slices},function(e){this._slices!==e&&(this._slices=e,this.releaseResource(),this.activeResource())}),a(0,n,"stacks",function(){return this._stacks},function(e){this._stacks!==e&&(this._stacks=e,this.releaseResource(),this.activeResource())})}(),function(e){function t(e,n,i){void 0===e&&(e=0),void 0===n&&(n=.3),void 0===i&&(i=1e3),this._viewMatrix=new at,this._projectionMatrix=new at,this._projectionViewMatrix=new at,this._viewport=new ft(0,0,0,0),this._normalizedViewport=new ft(0,0,1,1),this._aspectRatio=e,this._boundFrustumUpdate=!0,this._boundFrustum=new et(at.DEFAULT),t.__super.call(this,n,i),this.transform.on("worldmatrixneedchanged",this,this._onWorldMatrixChanged)}r(t,"laya.d3.core.Camera",On);var s=t.prototype;return s._onWorldMatrixChanged=function(){this._boundFrustumUpdate=!0},s._parseCustomProps=function(e,t,n,i){var r=n.clearColor;this.clearColor=new dt(r[0],r[1],r[2],r[3]);var a=n.viewport;this.normalizedViewport=new ft(a[0],a[1],a[2],a[3])},s._calculateProjectionMatrix=function(){if(!this._useUserProjectionMatrix)if(this._orthographic){var e=this.orthographicVerticalSize*this.aspectRatio*.5,t=.5*this.orthographicVerticalSize;at.createOrthoOffCenterRH(-e,e,-t,t,this.nearPlane,this.farPlane,this._projectionMatrix)}else at.createPerspective(3.1416*this.fieldOfView/180,this.aspectRatio,this.nearPlane,this.farPlane,this._projectionMatrix);this._boundFrustumUpdate=!0},s._update=function(e){this.conchModel&&(this.conchModel.setViewMatrix(this.viewMatrix.elements),this.conchModel.setProjectMatrix(this.projectionMatrix.elements)),laya.d3.core.Sprite3D.prototype._update.call(this,e)},s._renderCamera=function(e,t,n){n.parallelSplitShadowMaps[0]&&n._renderShadowMap(e,t,this),t.camera=this,this._prepareCameraToRender(),n._preRenderUpdateComponents(t);var i,r;i=t._viewMatrix=this.viewMatrix;var a=this._renderTarget;a?(a.start(),at.multiply(On._invertYScaleMatrix,this._projectionMatrix,On._invertYProjectionMatrix),at.multiply(On._invertYScaleMatrix,this.projectionViewMatrix,On._invertYProjectionViewMatrix),r=t._projectionMatrix=On._invertYProjectionMatrix,t._projectionViewMatrix=On._invertYProjectionViewMatrix):(r=t._projectionMatrix=this._projectionMatrix,t._projectionViewMatrix=this.projectionViewMatrix),this._prepareCameraViewProject(i,r),t._viewport=this.viewport,n._preRenderScene(e,t,this.boundFrustum),n._clear(e,t),n._renderScene(e,t),n._postRenderUpdateComponents(t),a&&a.end()},s.viewportPointToRay=function(e,t){yt.calculateCursorRay(e,this.viewport,this._projectionMatrix,this.viewMatrix,null,t)},s.normalizedViewportPointToRay=function(e,n){var i=t._tempVector20,r=this.viewport,a=e.elements,s=i.elements;s[0]=a[0]*r.width,s[1]=a[1]*r.height,yt.calculateCursorRay(i,this.viewport,this._projectionMatrix,this.viewMatrix,null,n)},s.worldToViewportPoint=function(e,t){at.multiply(this._projectionMatrix,this._viewMatrix,this._projectionViewMatrix),this.viewport.project(e,this._projectionViewMatrix,t);var i=t.elements;t.z<0||t.z>1?i[0]=i[1]=i[2]=NaN:(i[0]=i[0]/n.stage.clientScaleX,i[1]=i[1]/n.stage.clientScaleY)},s.worldToNormalizedViewportPoint=function(e,t){at.multiply(this._projectionMatrix,this._viewMatrix,this._projectionViewMatrix),this.normalizedViewport.project(e,this._projectionViewMatrix,t);var i=t.elements;t.z<0||t.z>1?i[0]=i[1]=i[2]=NaN:(i[0]=i[0]/n.stage.clientScaleX,i[1]=i[1]/n.stage.clientScaleY)},s.convertScreenCoordToOrthographicCoord=function(e,t){if(this._orthographic){var n=this.orthographicVerticalSize*this.aspectRatio/he.clientWidth,i=this.orthographicVerticalSize/he.clientHeight,r=e.elements,a=t.elements;return a[0]=(-he.clientWidth/2+r[0])*n,a[1]=(he.clientHeight/2-r[1])*i,a[2]=(this.nearPlane-this.farPlane)*(e.z+1)/2-this.nearPlane,ct.transformV3ToV3(t,this.transform.worldMatrix,t),!0}return!1},a(0,s,"projectionViewMatrix",function(){return at.multiply(this.projectionMatrix,this.viewMatrix,this._projectionViewMatrix),this._projectionViewMatrix}),a(0,s,"aspectRatio",function(){if(0===this._aspectRatio){var e=this.viewport;return e.width/e.height}return this._aspectRatio},function(e){if(e<0)throw new Error("Camera: the aspect ratio has to be a positive real number.");this._aspectRatio=e,this._calculateProjectionMatrix()}),a(0,s,"boundFrustum",function(){return this._boundFrustumUpdate&&(this._boundFrustum.matrix=this.projectionViewMatrix),this._boundFrustum}),a(0,s,"needViewport",function(){var e=this.normalizedViewport;return 0===e.x&&0===e.y&&1===e.width&&1===e.height}),a(0,s,"viewport",function(){if(this._viewportExpressedInClipSpace){var e=this._normalizedViewport,t=this.renderTargetSize,n=t.width,i=t.height;this._viewport.x=e.x*n,this._viewport.y=e.y*i,this._viewport.width=e.width*n,this._viewport.height=e.height*i}return this._viewport},function(e){if(null!=this.renderTarget&&(e.x<0||e.y<0||0==e.width||0==e.height))throw new Error("Camera: viewport size invalid.","value");this._viewportExpressedInClipSpace=!1,this._viewport=e,this._calculateProjectionMatrix()}),a(0,s,"normalizedViewport",function(){if(!this._viewportExpressedInClipSpace){var e=this._viewport,t=this.renderTargetSize,n=t.width,i=t.height;this._normalizedViewport.x=e.x/n,this._normalizedViewport.y=e.y/i,this._normalizedViewport.width=e.width/n,this._normalizedViewport.height=e.height/i}return this._normalizedViewport},function(e){if(e.x<0||e.y<0||e.x+e.width>1||e.y+e.height>1)throw new Error("Camera: viewport size invalid.","value");this._viewportExpressedInClipSpace=!0,this._normalizedViewport=e,this._calculateProjectionMatrix()}),a(0,s,"projectionMatrix",function(){return this._projectionMatrix},function(e){this._projectionMatrix=e,this._useUserProjectionMatrix=!0}),a(0,s,"viewMatrix",function(){return this.transform.worldMatrix.invert(this._viewMatrix),this._viewMatrix}),i(t,["_tempVector20",function(){return this._tempVector20=new ut}]),t}()),Un=(function(e){function t(){t.__super.call(this),this._render=new tn(this),this._render.on("materialchanged",this,this._onMaterialChanged);var e=new fn;this._render.sharedMaterial=e,this._geometryFilter=new on(this),e.renderMode=8,this._changeRenderObject(0)}r(t,"laya.d3.core.glitter.Glitter",e);var n=t.prototype;n._changeRenderObject=function(e){var t=this._render._renderElements,n=t[e];n||(n=t[e]=new oe),n._render=this._render;var i=this._render.sharedMaterials[e];i||(i=fn.defaultMaterial);var r=this._geometryFilter;return n._mainSortID=0,n._sprite3D=this,n.renderObj=r,n._material=i,n},n._onMaterialChanged=function(e,t,n){t<e._renderElements.length&&this._changeRenderObject(t)},n._clearSelfRenderObjects=function(){this.scene.removeFrustumCullingObject(this._render)},n._addSelfRenderObjects=function(){this.scene.addFrustumCullingObject(this._render)},n._update=function(t){this._geometryFilter._update(t.elapsedTime),e.prototype._update.call(this,t)},n.addGlitterByPositions=function(e,t){this._geometryFilter.addVertexPosition(e,t)},n.addGlitterByPositionsVelocitys=function(e,t,n,i){this._geometryFilter.addVertexPositionVelocity(e,t,n,i)},n.cloneTo=function(e){laya.d3.core.Sprite3D.prototype.cloneTo.call(this,e);var t=e,n=t.templet,i=this._geometryFilter;n.lifeTime=i.lifeTime,n.minSegmentDistance=i.minSegmentDistance,n.minInterpDistance=i.minInterpDistance,n.maxSlerpCount=i.maxSlerpCount,n._maxSegments=i._maxSegments;var r=t._render,a=this._render;r.sharedMaterials=a.sharedMaterials,r.enable=a.enable},n.destroy=function(t){void 0===t&&(t=!0),this.destroyed||(e.prototype.destroy.call(this,t),this._geometryFilter._destroy(),this._geometryFilter=null)},a(0,n,"templet",function(){return this._geometryFilter}),a(0,n,"glitterRender",function(){return this._render}),t.CURRENTTIME=2,t.DURATION=3}(bn),function(e){function t(){this._updateDirection=!1,this._direction=null,t.__super.call(this),this._updateDirection=!1,this.direction=new ct(0,-.5,-1),this.transform.on("worldmatrixneedchanged",this,this._onWorldMatrixChange)}r(t,"laya.d3.core.light.DirectionLight",e);var n=t.prototype;n._initShadow=function(){if(this._shadow)this._parallelSplitShadowMap=new xt,this.scene.parallelSplitShadowMaps.push(this._parallelSplitShadowMap),this._parallelSplitShadowMap.setInfo(this.scene,this._shadowFarPlane,this.direction,this._shadowMapSize,this._shadowMapCount,this._shadowMapPCFType);else{var e=this.scene.parallelSplitShadowMaps;e.splice(e.indexOf(this._parallelSplitShadowMap),1),this._parallelSplitShadowMap.disposeAllRenderTarget(),this._parallelSplitShadowMap=null,this.scene.removeShaderDefine(xt.SHADERDEFINE_SHADOW_PSSM1),this.scene.removeShaderDefine(xt.SHADERDEFINE_SHADOW_PSSM2),this.scene.removeShaderDefine(xt.SHADERDEFINE_SHADOW_PSSM3)}},n._onWorldMatrixChange=function(){this._updateDirection=!0},n._addSelfRenderObjects=function(){e.prototype._addSelfRenderObjects.call(this),this._shadow&&this._initShadow()},n._clearSelfRenderObjects=function(){var e=this.scene,t=e._shaderValues;t.setValue(4,null),t.setValue(3,null),e.removeShaderDefine(pt.SHADERDEFINE_DIRECTIONLIGHT)},n.updateToWorldState=function(e){var t=e.scene;if(t.enableLight&&this._activeInHierarchy){var n=t._shaderValues;return t.addShaderDefine(pt.SHADERDEFINE_DIRECTIONLIGHT),n.setValue(4,this.color.elements),n.setValue(3,this.direction.elements),!0}return t.removeShaderDefine(pt.SHADERDEFINE_DIRECTIONLIGHT),!1},a(0,n,"direction",function(){return this._updateDirection&&(this.transform.worldMatrix.getForward(this._direction),ct.normalize(this._direction,this._direction),this._updateDirection=!1),this._direction},function(e){var t=this.transform.worldMatrix;t.setForward(e),this.transform.worldMatrix=t,ct.normalize(e,e),this._direction=e,this.shadow&&this._parallelSplitShadowMap&&this._parallelSplitShadowMap._setGlobalParallelLightDir(this._direction)}),a(0,n,"lightType",function(){return 1}),a(0,n,"shadow",e.prototype._$get_shadow,function(e){this._shadow!==e&&(this._shadow=e,this.scene&&this._initShadow())})}(Pn),function(e){function t(){this._attenuation=null,this._range=NaN,t.__super.call(this),this.transform.position=new ct(0,0,0),this._range=6,this._attenuation=new ct(.6,.6,.6)}r(t,"laya.d3.core.light.PointLight",Pn);var n=t.prototype;n._clearSelfRenderObjects=function(){var e=this.scene,t=e._shaderValues;t.setValue(8,null),t.setValue(5,null),t.setValue(6,null),t.setValue(7,null),e.removeShaderDefine(pt.SHADERDEFINE_POINTLIGHT)},n.updateToWorldState=function(e){var t=e.scene;if(t.enableLight&&this._activeInHierarchy){var n=t._shaderValues;return t.addShaderDefine(pt.SHADERDEFINE_POINTLIGHT),n.setValue(8,this.color.elements),n.setValue(5,this.transform.position.elements),n.setValue(6,this.range),n.setValue(7,this.attenuation.elements),!0}return t.removeShaderDefine(pt.SHADERDEFINE_POINTLIGHT),!1},a(0,n,"range",function(){return this._range},function(e){this._range=e}),a(0,n,"lightType",function(){return 2}),a(0,n,"attenuation",function(){return this._attenuation},function(e){this._attenuation=e})}(),function(e){function t(){this._updateDirection=!1,this._direction=null,this._attenuation=null,this._spot=NaN,this._range=NaN,t.__super.call(this),this.transform.position=new ct(0,1,1),this._updateDirection=!1,this.direction=new ct(0,-1,-1),this._attenuation=new ct(.6,.6,.6),this._spot=96,this._range=6,this.transform.on("worldmatrixneedchanged",this,this._onWorldMatrixChange)}r(t,"laya.d3.core.light.SpotLight",Pn);var n=t.prototype;n._onWorldMatrixChange=function(){this._updateDirection=!0},n._clearSelfRenderObjects=function(){var e=this.scene,t=e._shaderValues;t.setValue(14,null),t.setValue(9,null),t.setValue(10,null),t.setValue(12,null),t.setValue(11,null),t.setValue(13,null),e.removeShaderDefine(pt.SHADERDEFINE_SPOTLIGHT)},n.updateToWorldState=function(e){var t=e.scene;if(t.enableLight&&this._activeInHierarchy){var n=t._shaderValues;return t.addShaderDefine(pt.SHADERDEFINE_SPOTLIGHT),n.setValue(14,this.color.elements),n.setValue(9,this.transform.position.elements),n.setValue(10,this.direction.elements),n.setValue(12,this.range),n.setValue(11,this.spot),n.setValue(13,this.attenuation.elements),!0}return t.removeShaderDefine(pt.SHADERDEFINE_SPOTLIGHT),!1},a(0,n,"range",function(){return this._range},function(e){this._range=e}),a(0,n,"direction",function(){return this._updateDirection&&(this.transform.worldMatrix.getForward(this._direction),this._updateDirection=!1),this._direction},function(e){var t=this.transform.worldMatrix;t.setForward(e),this.transform.worldMatrix=t,this._direction=e}),a(0,n,"lightType",function(){return 3}),a(0,n,"attenuation",function(){return this._attenuation},function(e){this._attenuation=e}),a(0,n,"spot",function(){return this._spot},function(e){this._spot=e})}(),function(e){function t(e,n){t.__super.call(this,n),this._geometryFilter=new nn(this),this._render=new rn(this),this._geometryFilter.on("meshchanged",this,this._onMeshChanged),this._render.on("materialchanged",this,this._onMaterialChanged),e&&(this._geometryFilter.sharedMesh=e,e instanceof laya.d3.resource.models.Mesh&&(e.loaded?this._render.sharedMaterials=e.materials:e.once("loaded",this,this._applyMeshMaterials)))}r(t,"laya.d3.core.MeshSprite3D",e);var s=t.prototype;return s._changeRenderObjectByMesh=function(e){var t=this._render._renderElements,n=t[e];n||(n=t[e]=new Ht),n._render=this._render;var i=this._render.sharedMaterials[e];i||(i=pn.defaultMaterial);var r=this._geometryFilter.sharedMesh.getRenderElement(e);if(n._mainSortID=this._getSortID(r,i),n._sprite3D=this,n.renderObj=r,n._material=i,T.isConchNode){var a=r._getVertexBuffer();n._conchSubmesh.setVBIB(a.vertexDeclaration._conchVertexDeclaration,a.getData(),r._getIndexBuffer().getData())}return n},s._changeRenderObjectByMaterial=function(e,t){var n=this._render._renderElements[e];t||(t=pn.defaultMaterial);var i=this._geometryFilter.sharedMesh.getRenderElement(e);return n._mainSortID=this._getSortID(i,t),n._sprite3D=this,n.renderObj=i,n._material=t,T.isConchNode&&n._conchSubmesh.setMaterial(t._conchMaterial),n},s._changeRenderObjectsByMesh=function(){T.isConchNode;var e=this._geometryFilter.sharedMesh.getRenderElementsCount();this._render._renderElements.length=e;for(var t=0;t<e;t++)this._changeRenderObjectByMesh(t)},s._onMeshChanged=function(e){var t=e.sharedMesh;t.loaded?this._changeRenderObjectsByMesh():t.once("loaded",this,this._onMeshLoaded)},s._onMeshLoaded=function(e){e===this.meshFilter.sharedMesh&&this._changeRenderObjectsByMesh()},s._onMaterialChanged=function(e,t,n){t<this._render._renderElements.length&&this._changeRenderObjectByMaterial(t,n)},s._clearSelfRenderObjects=function(){this.scene.removeFrustumCullingObject(this._render)},s._addSelfRenderObjects=function(){this.scene.addFrustumCullingObject(this._render)},s._parseCustomProps=function(e,t,n,i){var r=this.meshRender,a=n.lightmapIndex;null!=a&&(r.lightmapIndex=a);var s=n.lightmapScaleOffset;s&&(r.lightmapScaleOffset=new dt(s[0],s[1],s[2],s[3]));var o,l;if(i.instanceParams)(o=i.instanceParams.loadPath)&&(l=x.getRes(t[o]),this.meshFilter.sharedMesh=l,l.loaded?r.sharedMaterials=l.materials:l.once("loaded",this,this._applyMeshMaterials));else{(o=n.meshPath)&&(l=x.getRes(t[o]),this.meshFilter.sharedMesh=l);var h=n.materials;if(h){var _=r.sharedMaterials,u=h.length;_.length=u;for(var c=0;c<u;c++)_[c]=x.getRes(t[h[c].path]);r.sharedMaterials=_}}},s._applyMeshMaterials=function(e){for(var t=this._render.sharedMaterials,n=e.materials,i=0,r=n.length;i<r;i++)t[i]||(t[i]=n[i]);this._render.sharedMaterials=t},s._addToInitStaticBatchManager=function(){t._staticBatchManager._addInitBatchSprite(this)},s.cloneTo=function(e){laya.d3.core.Sprite3D.prototype.cloneTo.call(this,e);var t=e;t._geometryFilter.sharedMesh=this._geometryFilter.sharedMesh;var n=this._render,i=t._render;i.enable=n.enable,i.sharedMaterials=n.sharedMaterials,i.castShadow=n.castShadow;var r=n.lightmapScaleOffset;r&&(i.lightmapScaleOffset=r.clone()),i.receiveShadow=n.receiveShadow,i.sortingFudge=n.sortingFudge},s.destroy=function(t){if(void 0===t&&(t=!0),!this.destroyed){var n=this.meshFilter.sharedMesh;n.loaded||n.off("loaded",this,this._applyMeshMaterials),e.prototype.destroy.call(this,t),this._geometryFilter._destroy()}},s.createConchModel=function(){return null},a(0,s,"meshFilter",function(){return this._geometryFilter}),a(0,s,"meshRender",function(){return this._render}),t.__init__=function(){fe._staticBatchManagers.push(t._staticBatchManager)},t.load=function(e){return n.loader.create(e,null,null,t,null,1,!1)},i(t,["_staticBatchManager",function(){return this._staticBatchManager=new zt}]),t}(bn)),Hn=function(e){function t(e){t.__super.call(this),this._render=new sn(this),this._render.on("materialchanged",this,this._onMaterialChanged),this._geometryFilter=new an(this),this._changeRenderObject(0),e&&(this._render.sharedMaterial=e)}r(t,"laya.d3.core.particleShuriKen.ShuriKenParticle3D",e);var i=t.prototype;return i._initParticleVelocity=function(e){for(var t=new q,n=e.velocitys,i=0,r=n.length;i<r;i++){var a=n[i];t.add(a.key,a.value)}return t},i._initParticleColor=function(e){var t=new Z,n=e.alphas,i=0,r=0;for(i=0,r=n.length;i<r;i++){var a=n[i];t.addAlpha(a.key,a.value)}var s=e.rgbs;for(i=0,r=s.length;i<r;i++){var o=s[i],l=o.value;t.addRGB(o.key,new ct(l[0],l[1],l[2]))}return t},i._initParticleSize=function(e){for(var t=new q,n=e.sizes,i=0,r=n.length;i<r;i++){var a=n[i];t.add(a.key,a.value)}return t},i._initParticleRotation=function(e){for(var t=new q,n=e.angularVelocitys,i=0,r=n.length;i<r;i++){var a=n[i];t.add(a.key,a.value/180*Math.PI)}return t},i._initParticleFrame=function(e){for(var t=new Y,n=e.frames,i=0,r=n.length;i<r;i++){var a=n[i];t.add(a.key,a.value)}return t},i._changeRenderObject=function(e){var t=this._render._renderElements,n=t[e];n||(n=t[e]=new oe),n._render=this._render;var i=this._render.sharedMaterials[e];i||(i=Sn.defaultMaterial);var r=this._geometryFilter;return n._mainSortID=0,n._sprite3D=this,n.renderObj=r,n._material=i,n},i._onMaterialChanged=function(e,t,n){t<e._renderElements.length&&this._changeRenderObject(t)},i._clearSelfRenderObjects=function(){this.scene.removeFrustumCullingObject(this._render)},i._addSelfRenderObjects=function(){this.scene.addFrustumCullingObject(this._render)},i._parseCustomProps=function(e,n,i,r){var a,s=Math.PI/180,o=0,l=0,h=this.particleRender,_=i.material;if(_)a=x.getRes(n[_.path]);else{var u=i.materialPath;u?a=x.getRes(n[u]):(a=new Sn).diffuseTexture=n?x.getRes(n[i.texturePath]):wn.load(i.texturePath)}h.sharedMaterial=a;var c=i.meshPath;c&&(h.mesh=x.getRes(n[c])),h.renderMode=i.renderMode,h.stretchedBillboardCameraSpeedScale=i.stretchedBillboardCameraSpeedScale,h.stretchedBillboardSpeedScale=i.stretchedBillboardSpeedScale,h.stretchedBillboardLengthScale=i.stretchedBillboardLengthScale,h.sortingFudge=i.sortingFudge?i.sortingFudge:0;var d=this.particleSystem;d.isPerformanceMode=i.isPerformanceMode,d.duration=i.duration,d.looping=i.looping,d.prewarm=i.prewarm,d.startDelayType=i.startDelayType,d.startDelay=i.startDelay,d.startDelayMin=i.startDelayMin,d.startDelayMax=i.startDelayMax,d.startLifetimeType=i.startLifetimeType,d.startLifetimeConstant=i.startLifetimeConstant,d.startLifeTimeGradient=t._initStartLife(i.startLifetimeGradient),d.startLifetimeConstantMin=i.startLifetimeConstantMin,d.startLifetimeConstantMax=i.startLifetimeConstantMax,d.startLifeTimeGradientMin=t._initStartLife(i.startLifetimeGradientMin),d.startLifeTimeGradientMax=t._initStartLife(i.startLifetimeGradientMax),d.startSpeedType=i.startSpeedType,d.startSpeedConstant=i.startSpeedConstant,d.startSpeedConstantMin=i.startSpeedConstantMin,d.startSpeedConstantMax=i.startSpeedConstantMax,d.threeDStartSize=i.threeDStartSize,d.startSizeType=i.startSizeType,d.startSizeConstant=i.startSizeConstant;var f=i.startSizeConstantSeparate,m=d.startSizeConstantSeparate.elements;m[0]=f[0],m[1]=f[1],m[2]=f[2],d.startSizeConstantMin=i.startSizeConstantMin,d.startSizeConstantMax=i.startSizeConstantMax;var p=i.startSizeConstantMinSeparate,v=d.startSizeConstantMinSeparate.elements;v[0]=p[0],v[1]=p[1],v[2]=p[2];var g=i.startSizeConstantMaxSeparate,E=d.startSizeConstantMaxSeparate.elements;E[0]=g[0],E[1]=g[1],E[2]=g[2],d.threeDStartRotation=i.threeDStartRotation,d.startRotationType=i.startRotationType,d.startRotationConstant=i.startRotationConstant*s;var S=i.startRotationConstantSeparate,D=d.startRotationConstantSeparate.elements;D[0]=S[0]*s,D[1]=S[1]*s,D[2]=S[2]*s,d.startRotationConstantMin=i.startRotationConstantMin*s,d.startRotationConstantMax=i.startRotationConstantMax*s;var T=i.startRotationConstantMinSeparate,M=d.startRotationConstantMinSeparate.elements;M[0]=T[0]*s,M[1]=T[1]*s,M[2]=T[2]*s;var y=i.startRotationConstantMaxSeparate,R=d.startRotationConstantMaxSeparate.elements;R[0]=y[0]*s,R[1]=y[1]*s,R[2]=y[2]*s,d.randomizeRotationDirection=i.randomizeRotationDirection,d.startColorType=i.startColorType;var A=i.startColorConstant,C=d.startColorConstant.elements;C[0]=A[0],C[1]=A[1],C[2]=A[2],C[3]=A[3];var I=i.startColorConstantMin,w=d.startColorConstantMin.elements;w[0]=I[0],w[1]=I[1],w[2]=I[2],w[3]=I[3];var V=i.startColorConstantMax,N=d.startColorConstantMax.elements;N[0]=V[0],N[1]=V[1],N[2]=V[2],N[3]=V[3],d.gravityModifier=i.gravityModifier,d.simulationSpace=i.simulationSpace,d.scaleMode=i.scaleMode,d.playOnAwake=i.playOnAwake,d.maxParticles=i.maxParticles;var O=i.autoRandomSeed;null!=O&&(d.autoRandomSeed=O);var b=i.randomSeed;null!=b&&(d.randomSeed[0]=b);var P=i.emission,L=new k;L.emissionRate=P.emissionRate;var F=P.bursts;if(F)for(o=0,l=F.length;o<l;o++){var B=F[o];L.addBurst(new z(B.time,B.min,B.max))}L.enbale=P.enable,d.emission=L;var U,H=i.shape;switch(H.shapeType){case 0:var Z;U=Z=new Ut,Z.radius=H.sphereRadius,Z.emitFromShell=H.sphereEmitFromShell,Z.randomDirection=H.sphereRandomDirection;break;case 1:var Y;U=Y=new Bt,Y.radius=H.hemiSphereRadius,Y.emitFromShell=H.hemiSphereEmitFromShell,Y.randomDirection=H.hemiSphereRandomDirection;break;case 2:var q;U=q=new Ft,q.angle=H.coneAngle*s,q.radius=H.coneRadius,q.length=H.coneLength,q.emitType=H.coneEmitType,q.randomDirection=H.coneRandomDirection;break;case 3:var J;U=J=new Pt,J.x=H.boxX,J.y=H.boxY,J.z=H.boxZ,J.randomDirection=H.boxRandomDirection;break;case 7:var ee;U=ee=new Lt,ee.radius=H.circleRadius,ee.arc=H.circleArc*s,ee.emitFromEdge=H.circleEmitFromEdge,ee.randomDirection=H.circleRandomDirection;break;default:var ae;U=ae=new Lt,ae.radius=H.circleRadius,ae.arc=H.circleArc*s,ae.emitFromEdge=H.circleEmitFromEdge,ae.randomDirection=H.circleRandomDirection}U.enable=H.enable,d.shape=U;var se=i.velocityOverLifetime;if(se){var oe,le=se.velocity;switch(le.type){case 0:var he=le.constant;oe=K.createByConstant(new ct(he[0],he[1],he[2]));break;case 1:oe=K.createByGradient(this._initParticleVelocity(le.gradientX),this._initParticleVelocity(le.gradientY),this._initParticleVelocity(le.gradientZ));break;case 2:var _e=le.constantMin,ue=le.constantMax;oe=K.createByRandomTwoConstant(new ct(_e[0],_e[1],_e[2]),new ct(ue[0],ue[1],ue[2]));break;case 3:oe=K.createByRandomTwoGradient(this._initParticleVelocity(le.gradientXMin),this._initParticleVelocity(le.gradientXMax),this._initParticleVelocity(le.gradientYMin),this._initParticleVelocity(le.gradientYMax),this._initParticleVelocity(le.gradientZMin),this._initParticleVelocity(le.gradientZMax))}var ce=new re(oe);ce.space=se.space,ce.enbale=se.enable,d.velocityOverLifetime=ce}var de=i.colorOverLifetime;if(de){var fe,me=de.color;switch(me.type){case 0:var pe=me.constant;fe=j.createByConstant(new dt(pe[0],pe[1],pe[2],pe[3]));break;case 1:fe=j.createByGradient(this._initParticleColor(me.gradient));break;case 2:var ve=me.constantMin,ge=me.constantMax;fe=j.createByRandomTwoConstant(new dt(ve[0],ve[1],ve[2],ve[3]),new dt(ge[0],ge[1],ge[2],ge[3]));break;case 3:fe=j.createByRandomTwoGradient(this._initParticleColor(me.gradientMin),this._initParticleColor(me.gradientMax))}var xe=new G(fe);xe.enbale=de.enable,d.colorOverLifetime=xe}var Ee=i.sizeOverLifetime;if(Ee){var Se,De=Ee.size;switch(De.type){case 0:Se=De.separateAxes?Q.createByGradientSeparate(this._initParticleSize(De.gradientX),this._initParticleSize(De.gradientY),this._initParticleSize(De.gradientZ)):Q.createByGradient(this._initParticleSize(De.gradient));break;case 1:if(De.separateAxes){var Te=De.constantMinSeparate,Me=De.constantMaxSeparate;Se=Q.createByRandomTwoConstantSeparate(new ct(Te[0],Te[1],Te[2]),new ct(Me[0],Me[1],Me[2]))}else Se=Q.createByRandomTwoConstant(De.constantMin,De.constantMax);break;case 2:Se=De.separateAxes?Q.createByRandomTwoGradientSeparate(this._initParticleSize(De.gradientXMin),this._initParticleSize(De.gradientYMin),this._initParticleSize(De.gradientZMin),this._initParticleSize(De.gradientXMax),this._initParticleSize(De.gradientYMax),this._initParticleSize(De.gradientZMax)):Q.createByRandomTwoGradient(this._initParticleSize(De.gradientMin),this._initParticleSize(De.gradientMax))}var ye=new te(Se);ye.enbale=Ee.enable,d.sizeOverLifetime=ye}var Re=i.rotationOverLifetime;if(Re){var Ae,Ce=Re.angularVelocity;switch(Ce.type){case 0:Ce.separateAxes||(Ae=X.createByConstant(Ce.constant*s));break;case 1:Ce.separateAxes||(Ae=X.createByGradient(this._initParticleRotation(Ce.gradient)));break;case 2:Ce.separateAxes||(Ae=X.createByRandomTwoConstant(Ce.constantMin*s,Ce.constantMax*s));break;case 3:Ce.separateAxes||(Ae=X.createByRandomTwoGradient(this._initParticleRotation(Ce.gradientMin),this._initParticleRotation(Ce.gradientMax)))}var Ie=new $(Ae);Ie.enbale=Re.enable,d.rotationOverLifetime=Ie}var we=i.textureSheetAnimation;if(we){var Ve,Ne=we.frame;switch(Ne.type){case 0:Ve=W.createByConstant(Ne.constant);break;case 1:Ve=W.createByOverTime(this._initParticleFrame(Ne.overTime));break;case 2:Ve=W.createByRandomTwoConstant(Ne.constantMin,Ne.constantMax);break;case 3:Ve=W.createByRandomTwoOverTime(this._initParticleFrame(Ne.overTimeMin),this._initParticleFrame(Ne.overTimeMax))}var Oe,be=we.startFrame;switch(be.type){case 0:Oe=ne.createByConstant(be.constant);break;case 1:Oe=ne.createByRandomTwoConstant(be.constantMin,be.constantMax)}var Pe=new ie(Ve,Oe);Pe.enable=we.enable;var Le=we.tiles;Pe.tiles=new ut(Le[0],Le[1]),Pe.type=we.type,Pe.randomRow=we.randomRow,Pe.cycles=we.cycles,d.textureSheetAnimation=Pe}d.playOnAwake&&d.play()},i.cloneTo=function(e){laya.d3.core.Sprite3D.prototype.cloneTo.call(this,e);var t=e,n=t._geometryFilter;this._geometryFilter.cloneTo(n);var i=t._render,r=this._render;i.sharedMaterials=r.sharedMaterials,i.enable=r.enable,i.renderMode=r.renderMode,i.mesh=r.mesh,i.stretchedBillboardCameraSpeedScale=r.stretchedBillboardCameraSpeedScale,i.stretchedBillboardSpeedScale=r.stretchedBillboardSpeedScale,i.stretchedBillboardLengthScale=r.stretchedBillboardLengthScale,i.sortingFudge=r.sortingFudge},i.destroy=function(t){void 0===t&&(t=!0),this.destroyed||(e.prototype.destroy.call(this,t),this._geometryFilter._destroy(),this._geometryFilter=null)},a(0,i,"particleSystem",function(){return this._geometryFilter}),a(0,i,"particleRender",function(){return this._render}),t.load=function(e){return n.loader.create(e,null,null,t,null,1,!1)},t._initStartLife=function(e){for(var t=new q,n=e.startLifetimes,i=0,r=n.length;i<r;i++){var a=n[i];t.add(a.key,a.value)}return t},t.SHADERDEFINE_RENDERMODE_BILLBOARD=0,t.SHADERDEFINE_RENDERMODE_STRETCHEDBILLBOARD=0,t.SHADERDEFINE_RENDERMODE_HORIZONTALBILLBOARD=0,t.SHADERDEFINE_RENDERMODE_VERTICALBILLBOARD=0,t.SHADERDEFINE_RENDERMODE_MESH=0,t.SHADERDEFINE_RANDOMCOLOROVERLIFETIME=0,t.SHADERDEFINE_COLOROVERLIFETIME=0,t.SHADERDEFINE_VELOCITYOVERLIFETIMECONSTANT=0,t.SHADERDEFINE_VELOCITYOVERLIFETIMECURVE=0,t.SHADERDEFINE_VELOCITYOVERLIFETIMERANDOMCONSTANT=0,t.SHADERDEFINE_VELOCITYOVERLIFETIMERANDOMCURVE=0,t.SHADERDEFINE_TEXTURESHEETANIMATIONCURVE=0,t.SHADERDEFINE_TEXTURESHEETANIMATIONRANDOMCURVE=0,t.SHADERDEFINE_ROTATIONOVERLIFETIME=0,t.SHADERDEFINE_ROTATIONOVERLIFETIMESEPERATE=0,t.SHADERDEFINE_ROTATIONOVERLIFETIMECONSTANT=0,t.SHADERDEFINE_ROTATIONOVERLIFETIMECURVE=0,t.SHADERDEFINE_ROTATIONOVERLIFETIMERANDOMCONSTANTS=0,t.SHADERDEFINE_ROTATIONOVERLIFETIMERANDOMCURVES=0,t.SHADERDEFINE_SIZEOVERLIFETIMECURVE=0,t.SHADERDEFINE_SIZEOVERLIFETIMECURVESEPERATE=0,t.SHADERDEFINE_SIZEOVERLIFETIMERANDOMCURVES=0,t.SHADERDEFINE_SIZEOVERLIFETIMERANDOMCURVESSEPERATE=0,t.SHADERDEFINE_SHAPE=0,t.WORLDPOSITION=0,t.WORLDROTATION=1,t.POSITIONSCALE=4,t.SIZESCALE=5,t.SCALINGMODE=6,t.GRAVITY=7,t.THREEDSTARTROTATION=8,t.STRETCHEDBILLBOARDLENGTHSCALE=9,t.STRETCHEDBILLBOARDSPEEDSCALE=10,t.SIMULATIONSPACE=11,t.CURRENTTIME=12,t.VOLVELOCITYCONST=13,t.VOLVELOCITYGRADIENTX=14,t.VOLVELOCITYGRADIENTY=15,t.VOLVELOCITYGRADIENTZ=16,t.VOLVELOCITYCONSTMAX=17,t.VOLVELOCITYGRADIENTXMAX=18,t.VOLVELOCITYGRADIENTYMAX=19,t.VOLVELOCITYGRADIENTZMAX=20,t.VOLSPACETYPE=21,t.COLOROVERLIFEGRADIENTALPHAS=22,t.COLOROVERLIFEGRADIENTCOLORS=23,t.MAXCOLOROVERLIFEGRADIENTALPHAS=24,t.MAXCOLOROVERLIFEGRADIENTCOLORS=25,t.SOLSIZEGRADIENT=26,t.SOLSIZEGRADIENTX=27,t.SOLSIZEGRADIENTY=28,t.SOLSizeGradientZ=29,t.SOLSizeGradientMax=30,t.SOLSIZEGRADIENTXMAX=31,t.SOLSIZEGRADIENTYMAX=32,t.SOLSizeGradientZMAX=33,t.ROLANGULARVELOCITYCONST=34,t.ROLANGULARVELOCITYCONSTSEPRARATE=35,t.ROLANGULARVELOCITYGRADIENT=36,t.ROLANGULARVELOCITYGRADIENTX=37,t.ROLANGULARVELOCITYGRADIENTY=38,t.ROLANGULARVELOCITYGRADIENTZ=39,t.ROLANGULARVELOCITYGRADIENTW=40,t.ROLANGULARVELOCITYCONSTMAX=41,t.ROLANGULARVELOCITYCONSTMAXSEPRARATE=42,t.ROLANGULARVELOCITYGRADIENTMAX=43,t.ROLANGULARVELOCITYGRADIENTXMAX=44,t.ROLANGULARVELOCITYGRADIENTYMAX=45,t.ROLANGULARVELOCITYGRADIENTZMAX=46,t.ROLANGULARVELOCITYGRADIENTWMAX=47,t.TEXTURESHEETANIMATIONCYCLES=48,t.TEXTURESHEETANIMATIONSUBUVLENGTH=49,t.TEXTURESHEETANIMATIONGRADIENTUVS=50,t.TEXTURESHEETANIMATIONGRADIENTMAXUVS=51,t}(bn),zn=(function(e){function t(e,n,i,r,a){void 0===e&&(e=.1),void 0===n&&(n=0),void 0===i&&(i=0),void 0===r&&(r=.3),void 0===a&&(a=1e3),this._tempMatrix=new at,this._leftViewMatrix=new at,this._leftProjectionMatrix=new at,this._leftProjectionViewMatrix=new at,this._leftViewport=new ft(0,0,0,0),this._leftNormalizedViewport=new ft(0,0,.5,1),this._leftAspectRatio=n,this._rightViewMatrix=new at,this._rightProjectionMatrix=new at,this._rightProjectionViewMatrix=new at,this._rightViewport=new ft(0,0,0,0),this._rightNormalizedViewport=new ft(.5,0,.5,1),this._rightAspectRatio=i,this._pupilDistande=e,this._leftBoundFrustumUpdate=!0,this._leftBoundFrustum=new et(at.DEFAULT),this._rightBoundFrustumUpdate=!0,this._rightBoundFrustum=new et(at.DEFAULT),t.__super.call(this,r,a),this.transform.on("worldmatrixneedchanged",this,this._onWorldMatrixChanged)}r(t,"laya.d3.core.VRCamera",On);var n=t.prototype;n._onWorldMatrixChanged=function(){this._leftBoundFrustumUpdate=this._rightBoundFrustumUpdate=!0},n._calculatePupilOffset=function(){var e=this._tempVector3;return ct.scale(this.right,this._pupilDistande/2,e),e.elements},n._calculateLeftProjectionMatrix=function(){if(!this._useUserProjectionMatrix)if(this._orthographic){var e=this.orthographicVerticalSize*this.leftAspectRatio*.5,t=.5*this.orthographicVerticalSize;at.createOrthoOffCenterRH(-e,e,-t,t,this.nearPlane,this.farPlane,this._leftProjectionMatrix)}else at.createPerspective(3.1416*this.fieldOfView/180,this.leftAspectRatio,this.nearPlane,this.farPlane,this._rightProjectionMatrix);this._leftBoundFrustumUpdate=!0},n._calculateRightProjectionMatrix=function(){if(!this._useUserProjectionMatrix)if(this._orthographic){var e=this.orthographicVerticalSize*this.rightAspectRatio*.5,t=.5*this.orthographicVerticalSize;at.createOrthoOffCenterRH(-e,e,t,t,this.nearPlane,this.farPlane,this._rightProjectionMatrix)}else at.createPerspective(3.1416*this.fieldOfView/180,this.rightAspectRatio,this.nearPlane,this.farPlane,this._rightProjectionMatrix);this._rightBoundFrustumUpdate=!0},n._calculateProjectionMatrix=function(){if(!this._useUserProjectionMatrix)if(this._orthographic){var e=this.orthographicVerticalSize*this.leftAspectRatio*.5,t=.5*this.orthographicVerticalSize,n=this.orthographicVerticalSize*this.rightAspectRatio*.5,i=.5*this.orthographicVerticalSize;at.createOrthoOffCenterRH(-e,e,-t,t,this.nearPlane,this.farPlane,this._leftProjectionMatrix),at.createOrthoOffCenterRH(-n,n,i,i,this.nearPlane,this.farPlane,this._rightProjectionMatrix)}else at.createPerspective(3.1416*this.fieldOfView/180,this.leftAspectRatio,this.nearPlane,this.farPlane,this._leftProjectionMatrix),at.createPerspective(3.1416*this.fieldOfView/180,this.rightAspectRatio,this.nearPlane,this.farPlane,this._rightProjectionMatrix);this._leftBoundFrustumUpdate=this._rightBoundFrustumUpdate=!0},n._renderCamera=function(e,t,n){t.camera=this,this._prepareCameraToRender(),n._preRenderUpdateComponents(t);var i,r;i=t._viewMatrix=this.leftViewMatrix;var a=this._renderTarget;a?(a.start(),at.multiply(On._invertYScaleMatrix,this._leftProjectionMatrix,On._invertYProjectionMatrix),at.multiply(On._invertYScaleMatrix,this.leftProjectionViewMatrix,On._invertYProjectionViewMatrix),r=t._projectionMatrix=On._invertYProjectionMatrix,t._projectionViewMatrix=On._invertYProjectionViewMatrix):(r=t._projectionMatrix=this._leftProjectionMatrix,t._projectionViewMatrix=this.leftProjectionViewMatrix),this._prepareCameraViewProject(i,r),t._viewport=this.leftViewport,n._preRenderScene(e,t,this.leftBoundFrustum),n._clear(e,t),n._renderScene(e,t);var s,o;s=t._viewMatrix=this.rightViewMatrix,a?(a.start(),at.multiply(On._invertYScaleMatrix,this._rightProjectionMatrix,On._invertYProjectionMatrix),at.multiply(On._invertYScaleMatrix,this.rightProjectionViewMatrix,On._invertYProjectionViewMatrix),t._projectionMatrix=On._invertYProjectionMatrix,o=t._projectionViewMatrix=On._invertYProjectionViewMatrix):(o=t._projectionMatrix=this._rightProjectionMatrix,t._projectionViewMatrix=this.rightProjectionViewMatrix),this._prepareCameraViewProject(s,o),t._viewport=this.rightViewport,n._preRenderScene(e,t,this.rightBoundFrustum),n._clear(e,t),n._renderScene(e,t),n._postRenderUpdateComponents(t),a&&a.end()},a(0,n,"rightBoundFrustum",function(){return this._rightBoundFrustumUpdate&&(this._rightBoundFrustum.matrix=this.rightProjectionViewMatrix),this._rightBoundFrustum}),a(0,n,"leftNormalizedViewport",function(){if(!this._viewportExpressedInClipSpace){var e=this._leftViewport,t=this.renderTargetSize,n=t.width,i=t.height;this._leftNormalizedViewport.x=e.x/n,this._leftNormalizedViewport.y=e.y/i,this._leftNormalizedViewport.width=e.width/n,this._leftNormalizedViewport.height=e.height/i}return this._leftNormalizedViewport}),a(0,n,"rightViewport",function(){if(this._viewportExpressedInClipSpace){var e=this._rightNormalizedViewport,t=this.renderTargetSize,n=t.width,i=t.height;this._rightViewport.x=e.x*n,this._rightViewport.y=e.y*i,this._rightViewport.width=e.width*n,this._rightViewport.height=e.height*i}return this._rightViewport}),a(0,n,"viewport",null,function(e){if(null!=this.renderTarget&&(e.x<0||e.y<0||0==e.width||0==e.height))throw new Error("VRCamera: viewport size invalid.","value");this._viewportExpressedInClipSpace=!1,this._leftViewport=new ft(0,0,e.width/2,e.height),this._rightViewport=new ft(e.width/2,0,e.width/2,e.height),this._calculateProjectionMatrix()}),a(0,n,"leftAspectRatio",function(){if(0===this._leftAspectRatio){var e=this.leftViewport;return e.width/e.height}return this._leftAspectRatio}),a(0,n,"rightAspectRatio",function(){if(0===this._rightAspectRatio){var e=this.rightViewport;return e.width/e.height}return this._rightAspectRatio}),a(0,n,"aspectRatio",null,function(e){if(e<0)throw new Error("VRCamera: the aspect ratio has to be a positive real number.");this._leftAspectRatio=e,this._rightAspectRatio=e,this._calculateRightProjectionMatrix()}),a(0,n,"rightNormalizedViewport",function(){if(!this._viewportExpressedInClipSpace){var e=this._rightViewport,t=this.renderTargetSize,n=t.width,i=t.height;this._rightNormalizedViewport.x=e.x/n,this._rightNormalizedViewport.y=e.y/i,this._rightNormalizedViewport.width=e.width/n,this._rightNormalizedViewport.height=e.height/i}return this._rightNormalizedViewport}),a(0,n,"normalizedViewport",null,function(e){if(e.x<0||e.y<0||e.x+e.width>1||e.x+e.height>1)throw new Error("VRCamera: viewport size invalid.","value");this._viewportExpressedInClipSpace=!0,this._leftNormalizedViewport=new ft(0,0,e.width/2,e.height),this._rightNormalizedViewport=new ft(e.width/2,0,e.width/2,e.height),this._calculateProjectionMatrix()}),a(0,n,"leftViewport",function(){if(this._viewportExpressedInClipSpace){var e=this._leftNormalizedViewport,t=this.renderTargetSize,n=t.width,i=t.height;this._leftViewport.x=e.x*n,this._leftViewport.y=e.y*i,this._leftViewport.width=e.width*n,this._leftViewport.height=e.height*i}return this._leftViewport}),a(0,n,"needLeftViewport",function(){var e=this.leftNormalizedViewport;return 0===e.x&&0===e.y&&1===e.width&&1===e.height}),a(0,n,"needRightViewport",function(){var e=this.rightNormalizedViewport;return 0===e.x&&0===e.y&&1===e.width&&1===e.height}),a(0,n,"leftViewMatrix",function(){var e=this._calculatePupilOffset(),t=this._tempMatrix;this.transform.worldMatrix.cloneTo(t);var n=t.elements;return n[12]-=e[0],n[13]-=e[1],n[14]-=e[2],t.invert(this._leftViewMatrix),this._leftViewMatrix}),a(0,n,"rightViewMatrix",function(){var e=this._calculatePupilOffset(),t=this._tempMatrix;this.transform.worldMatrix.cloneTo(t);var n=t.elements;return n[12]+=e[0],n[13]+=e[1],n[14]+=e[2],t.invert(this._rightViewMatrix),this._rightViewMatrix}),a(0,n,"leftProjectionMatrix",function(){return this._leftProjectionMatrix}),a(0,n,"leftProjectionViewMatrix",function(){return at.multiply(this.leftProjectionMatrix,this.leftViewMatrix,this._leftProjectionViewMatrix),this._leftProjectionViewMatrix}),a(0,n,"rightProjectionMatrix",function(){return this._rightProjectionMatrix}),a(0,n,"rightProjectionViewMatrix",function(){return at.multiply(this.rightProjectionMatrix,this.rightViewMatrix,this._rightProjectionViewMatrix),this._rightProjectionViewMatrix}),a(0,n,"leftBoundFrustum",function(){return this._leftBoundFrustumUpdate&&(this._leftBoundFrustum.matrix=this.leftProjectionViewMatrix),this._leftBoundFrustum})}(),function(e){function t(e,n){this._subMeshOffset=null,t.__super.call(this,n),this._subMeshOffset=[];var i=this;this._geometryFilter=new nn(i),this._render=new Nn(i),this._geometryFilter.on("meshchanged",this,this._onMeshChanged),this._render.on("materialchanged",this,this._onMaterialChanged),e&&(this._geometryFilter.sharedMesh=e,e instanceof laya.d3.resource.models.Mesh&&(e.loaded?this._render.sharedMaterials=e.materials:e.once("loaded",this,this._applyMeshMaterials)))}r(t,"laya.d3.core.SkinnedMeshSprite3D",e);var i=t.prototype;return i._changeRenderObjectByMesh=function(e){var t=this._render._renderElements,n=t[e];n||(n=t[e]=new Ht),n._render=this._render;var i=this._render.sharedMaterials[e];i||(i=pn.defaultMaterial);var r=this._geometryFilter.sharedMesh.getRenderElement(e);return n._mainSortID=this._getSortID(r,i),n._sprite3D=this,n.renderObj=r,n._material=i,n},i._changeRenderObjectByMaterial=function(e,t){var n=this._render._renderElements[e];t||(t=pn.defaultMaterial);var i=this._geometryFilter.sharedMesh.getRenderElement(e);return n._mainSortID=this._getSortID(i,t),n._sprite3D=this,n.renderObj=i,n._material=t,n},i._changeRenderObjectsByMesh=function(){var e=this._geometryFilter.sharedMesh.getRenderElementsCount();this._render._renderElements.length=e;for(var t=0;t<e;t++)this._changeRenderObjectByMesh(t)},i._onMeshChanged=function(e){var t=e.sharedMesh;t.loaded?this._changeRenderObjectsByMesh():t.once("loaded",this,this._changeRenderObjectsByMesh)},i._onMaterialChanged=function(e,t,n){t<this._render._renderElements.length&&this._changeRenderObjectByMaterial(t,n)},i._parseCustomProps=function(e,t,n,i){var r=this.skinnedMeshRender,a=n.lightmapIndex;null!=a&&(r.lightmapIndex=a);var s=n.lightmapScaleOffset;s&&(r.lightmapScaleOffset=new dt(s[0],s[1],s[2],s[3]));var o,l;if(i.instanceParams)(o=i.instanceParams.loadPath)&&(l=x.getRes(t[o]),this.meshFilter.sharedMesh=l,l.loaded?r.sharedMaterials=l.materials:l.once("loaded",this,this._applyMeshMaterials));else{(o=n.meshPath)&&(l=x.getRes(t[o]),this.meshFilter.sharedMesh=l);var h=n.materials;if(h){var _=r.sharedMaterials,u=h.length;_.length=u;for(var c=0;c<u;c++)_[c]=x.getRes(t[h[c].path]);r.sharedMaterials=_}}},i._changeHierarchyAnimator=function(e){if(e){var t=this.skinnedMeshRender;t._cacheAnimator=e;var n=e.avatar;n&&t._setCacheAvatar(n)}laya.d3.core.Sprite3D.prototype._changeHierarchyAnimator.call(this,e)},i._clearSelfRenderObjects=function(){this._scene.removeFrustumCullingObject(this._render)},i._addSelfRenderObjects=function(){this._scene.addFrustumCullingObject(this._render)},i._applyMeshMaterials=function(e){for(var t=this._render.sharedMaterials,n=e.materials,i=0,r=n.length;i<r;i++)t[i]||(t[i]=n[i]);this._render.sharedMaterials=t},i.cloneTo=function(e){laya.d3.core.Sprite3D.prototype.cloneTo.call(this,e);var t=e;t._geometryFilter.sharedMesh=this._geometryFilter.sharedMesh;var n=this._render,i=t._render;i.enable=n.enable,i.sharedMaterials=n.sharedMaterials,i.castShadow=n.castShadow;var r=n.lightmapScaleOffset;r&&(i.lightmapScaleOffset=r.clone()),i.receiveShadow=n.receiveShadow,i.sortingFudge=n.sortingFudge},i.destroy=function(t){void 0===t&&(t=!0),this.destroyed||(e.prototype.destroy.call(this,t),this._geometryFilter._destroy())},i.createConchModel=function(){return null},a(0,i,"meshFilter",function(){return this._geometryFilter}),a(0,i,"skinnedMeshRender",function(){return this._render}),t.load=function(e){return n.loader.create(e,null,null,Un,null,1,!1)},t.BONES=0,t.SHADERDEFINE_BONE=8,t}(bn)),Gn=function(e){function t(e,n,i,r,a,s,o,l){t.__super.call(this,l),this._geometryFilter=new ln(this,e,n,i,r,a,s,o),this._render=new hn(this)}r(t,"laya.d3.terrain.TerrainChunk",e);var i=t.prototype;return i.buildRenderElementAndMaterial=function(e,t,n,i,r,a,s,o,l,h,_,u,c,d,f,m,p,v){void 0===_&&(_=1),void 0===u&&(u=1),void 0===c&&(c=1),void 0===d&&(d=1),void 0===f&&(f=1),void 0===m&&(m=1),void 0===p&&(p=1),void 0===v&&(v=1);var g=new vn;l&&(g.diffuseColor=l),o&&(g.ambientColor=o),h&&(g.specularColor=h),g.splatAlphaTexture=x.getRes(n),g.normalTexture=t?x.getRes(t):null,g.diffuseTexture1=i?x.getRes(i):null,g.diffuseTexture2=r?x.getRes(r):null,g.diffuseTexture3=a?x.getRes(a):null,g.diffuseTexture4=s?x.getRes(s):null,g.setDiffuseScale1(_,u),g.setDiffuseScale2(c,d),g.setDiffuseScale3(f,m),g.setDiffuseScale4(p,v),g.setDetailNum(e),0!=this._render._renderElements.length&&(g.renderMode=2);var E=new oe;E._mainSortID=0,E._sprite3D=this,E.renderObj=this._geometryFilter,E._material=g,this._render._materials.push(g),this._render._renderElements.push(E)},i.createConchModel=function(){return null},i._clearSelfRenderObjects=function(){this.scene.removeFrustumCullingObject(this._render)},i._addSelfRenderObjects=function(){this.scene.addFrustumCullingObject(this._render)},i._applyMeshMaterials=function(e){for(var t=this._render.sharedMaterials,n=e.materials,i=0,r=n.length;i<r;i++)t[i]||(t[i]=n[i]);this._render.sharedMaterials=t},i.cloneTo=function(e){console.log("Terrain Chunk can't clone")},i.destroy=function(t){void 0===t&&(t=!0),this.destroyed||(e.prototype.destroy.call(this,t),this._geometryFilter._destroy())},a(0,i,"terrainFilter",function(){return this._geometryFilter}),a(0,i,"terrainRender",function(){return this._render}),t.load=function(e){return n.loader.create(e,null,null,t,null,1,!1)},t}(bn);(function(e){function t(e,n,i){this._minX=NaN,this._minZ=NaN,this._cellSize=null,this._heightMap=null,t.__super.call(this,e,i),this._heightMap=n,this._cellSize=new ut}r(t,"laya.d3.core.MeshTerrainSprite3D",Un);var n=t.prototype;n._disableRotation=function(){var e=this.transform.rotation;e.elements[0]=0,e.elements[1]=0,e.elements[2]=0,e.elements[3]=1,this.transform.rotation=e},n._getScaleX=function(){var e=this.transform.worldMatrix.elements,t=e[0],n=e[1],i=e[2];return Math.sqrt(t*t+n*n+i*i)},n._getScaleZ=function(){var e=this.transform.worldMatrix.elements,t=e[8],n=e[9],i=e[10];return Math.sqrt(t*t+n*n+i*i)},n._initCreateFromMesh=function(e,t){this._heightMap=U.creatFromMesh(this.meshFilter.sharedMesh,e,t,this._cellSize);var n=this.meshFilter.sharedMesh.boundingBox,i=n.min;n.max;this._minX=i.x,this._minZ=i.z},n._initCreateFromMeshHeightMap=function(e,t,n){var i=this,r=this.meshFilter.sharedMesh.boundingBox;e.loaded?(this._heightMap=U.createFromImage(e,t,n),this._computeCellSize(r)):e.once("loaded",null,function(){i._heightMap=U.createFromImage(e,t,n),i._computeCellSize(r)});var a=r.min;r.max;this._minX=a.x,this._minZ=a.z},n._computeCellSize=function(e){var t=e.min,n=e.max,i=t.x,r=t.z,a=n.x-i,s=n.z-r;this._cellSize.elements[0]=a/(this._heightMap.width-1),this._cellSize.elements[1]=s/(this._heightMap.height-1)},n._update=function(e){this._disableRotation(),laya.d3.core.RenderableSprite3D.prototype._update.call(this,e)},n.getHeight=function(e,n){t._tempVector3.elements[0]=e,t._tempVector3.elements[1]=0,t._tempVector3.elements[2]=n,this._disableRotation();var i=this.transform.worldMatrix;i.invert(t._tempMatrix4x4),ct.transformCoordinate(t._tempVector3,t._tempMatrix4x4,t._tempVector3),e=t._tempVector3.elements[0],n=t._tempVector3.elements[2];var r=(e-this._minX)/this._cellSize.x,a=(n-this._minZ)/this._cellSize.y,s=Math.floor(a),o=Math.floor(r),l=r-o,h=a-s,_=NaN,u=NaN,c=i.elements,d=c[4],f=c[5],m=c[6],p=Math.sqrt(d*d+f*f+m*m),v=c[13],g=this._heightMap.getHeight(s,o+1),x=this._heightMap.getHeight(s+1,o);if(isNaN(g)||isNaN(x))return NaN;if(l+h<=1){var E=this._heightMap.getHeight(s,o);return isNaN(E)?NaN:(_=g-E,u=x-E,(E+l*_+h*u)*p+v)}var S=this._heightMap.getHeight(s+1,o+1);return isNaN(S)?NaN:(_=x-S,u=g-S,(S+(1-l)*_+(1-h)*u)*p+v)},a(0,n,"minX",function(){var e=this.transform.worldMatrix.elements;return this._minX*this._getScaleX()+e[12]}),a(0,n,"width",function(){return(this._heightMap.width-1)*this._cellSize.x*this._getScaleX()}),a(0,n,"minZ",function(){var e=this.transform.worldMatrix.elements;return this._minZ*this._getScaleZ()+e[14]}),a(0,n,"depth",function(){return(this._heightMap.height-1)*this._cellSize.y*this._getScaleZ()}),t.createFromMesh=function(e,n,i,r){var a=new t(e,null,r);return e.loaded?a._initCreateFromMesh(n,i):e.once("loaded",a,a._initCreateFromMesh,[n,i]),a},t.createFromMeshAndHeightMap=function(e,n,i,r,a){var s=new t(e,null,a);return e.loaded?s._initCreateFromMeshHeightMap(n,i,r):e.once("loaded",s,s._initCreateFromMeshHeightMap,[n,i,r]),s},i(t,["_tempVector3",function(){return this._tempVector3=new ct},"_tempMatrix4x4",function(){return this._tempMatrix4x4=new at}])})(),function(t){function s(e,t){this.mtl=null,this.detailMtl=null,this.mesh=null,this.useRefrTex=!0,this.renderDetailWav=!0,this._stop=!1,this._texWave=null,this._texRefract=null,this._detailMesh=null,this._texWaveDegTest=0,this._shownormal=!1,this._refractQueue=null,this._meshLoaded=!1,this._waterFogStart=0,this._waterFogRange=20,this.startTm=0,this.curTm=0,this._syncObj=null,this.afterDescLoaded=null,this._geoWaveInfo=new Float32Array(4*s._waveInfoEleNum),this._geoWaveInfoDir=new Float32Array(8),this._texWaveInfo=new Float32Array(15*s._waveInfoEleNum),this._texWaveInfoDir=new Float32Array(30),this._texWaveTrans=new Float32Array(9),this._refractObjStack=[],this._refractObjecs=[],this._scrSizeInfo=new Float32Array(2),this._waterColor=new ct,s.__super.call(this,e,t),this.mtl=new gn,this.startTm=n.timer.currTimer,this.curTm=0}r(s,"laya.d3.water.WaterSprite",Un);var o=s.prototype;o._getWaveInfo=function(e,t,n,i,r,a,o){var l=n*s._waveInfoEleNum,h=2*n,_=i*s.deg2rad;t[h++]=Math.cos(_),t[h++]=Math.sin(_),e[l++]=a,e[l++]=o,e[l++]=s._2pi/r,e[l++]=7.846987702957/Math.sqrt(r)},o.onDescLoaded=function(e){var t=this,n=Rn.load(e.mesh);this._texWave=new An(e.detailTexSize[0],e.detailTexSize[1],6408,5121,33189,!1,!1),this.useRefrTex?(this._texRefract=new An(e.refracTexSize[0],e.refracTexSize[1]),this._texRefract.repeat=!1,this._texRefract.mipmap=!0,this.mtl.useRefractTexture=!0):this.mtl.useRefractTexture=!1,this._geometryFilter.sharedMesh=n,n.once("loaded",this,this._applyMeshMaterials),n.on("loaded",this,this.onMeshLoaded),".ltc"===e.skyTexture.substr(e.skyTexture.length-4).toLowerCase()?(this.mtl.skyTexture=Vn.load(e.skyTexture),this.mtl._addShaderDefine(gn.SHADERDEFINE_CUBE_ENV)):(this.mtl.skyTexture=wn.load(e.skyTexture),this.mtl._removeShaderDefine(gn.SHADERDEFINE_CUBE_ENV)),e.hdrsky&&this.mtl._addShaderDefine(gn.SHADERDEFINE_HDR_ENV),void 0!=e.deepScale&&(this.mtl.deepScale=e.deepScale),e.useVertexDeep&&(this.mtl.useVertexDeep=!0),this.mtl.skyTexture.repeat=!0;var i=wn.load(e.infoTexture);i.repeat=!1,this.mtl.waterInfoTexture=i;var r=wn.load(e.foamTexture);if(r.repeat=!0,this.mtl.foamTexture=r,this.mtl.renderMode=13,this.mtl.waveMainDir=e.geoWaveData[0].dir,this.mtl.geoWaveUVScale=e.geoWaveUVScale,this._detailMesh=new Fn(2,2),this.detailMtl=new Dn,this.detailMtl.texWaveUVScale=e.detailWaveUVScale,4!=e.geoWaveData.length)throw"error 3";if(4!=e.detailData.length)throw"error 4";e.geoWaveData.forEach(function(e,n){t._getWaveInfo(t._geoWaveInfo,t._geoWaveInfoDir,n,e.dir,e.L,e.Q,e.A)});e.detailData.forEach(function(e,n){t._getWaveInfo(t._texWaveInfo,t._texWaveInfoDir,n,e.dir,e.L,1.5,.01*e.L)}),this._waterColor.x=e.color[0]/255,this._waterColor.y=e.color[1]/255,this._waterColor.z=e.color[2]/255,this.mtl.seaColor=new Float32Array([this._waterColor.x,this._waterColor.y,this._waterColor.z]),this._waterFogStart=e.fogStart,this._waterFogRange=e.fogRange,this.afterDescLoaded&&this.afterDescLoaded.call(this)},o.onMeshLoaded=function(){if(this._refractQueue=new le(this._scene),this._scrSizeInfo[0]=n.stage.width,this._scrSizeInfo[1]=n.stage.height,this.mtl.scrsize=this._scrSizeInfo,this.meshRender.sharedMaterial=this.mtl,!(this._render._renderElements.length>0))throw"error2";this._render._renderElements[0]._onPreRenderFunction=this.onPreRender,this._meshLoaded=!0},o.stop=function(){this._stop=!this._stop},o.addRefractObj=function(e){this._refractObjStack.push(e),this._refractObjecs.push(e)},o.onPreRender=function(t){var i=this;if(this._meshLoaded){if(this._refractObjStack.length)for(var r=0;r<this._refractObjStack.length;r++){var a=this._refractObjStack[r];a._render._renderElements.length&&(a._render._renderElements.forEach(function(e){i._refractQueue._addRenderElement(e)}),this._refractObjStack.splice(r,1),r--)}var o=N.mainContext,l=o.getParameter(2929),h=o.getParameter(2884),_=o.getParameter(2978),u=!1;if(this.useRefrTex&&(this._texRefract.start(),u=!0,o.viewport(0,0,this._texRefract.width,this._texRefract.height),o.clearColor(this._waterColor.x,this._waterColor.y,this._waterColor.z,1),o.clear(16640),this._refractObjecs.forEach(function(e){e._renderUpdate(t._projectionViewMatrix)}),this._refractQueue._preRender(t),this._refractQueue._render(t,!1),this._texRefract.end(),this._texRefract.repeat=!0),this.renderDetailWav){this._texWave.start(),o.disable(2929),o.disable(2884),u=!0,o.viewport(0,0,s.detailTexWidth,s.detailTexHeight);var c=this._detailMesh.getRenderElement(0);c._beforeRender(t),this.detailMtl.currentTm=n.timer.currTimer,this.detailMtl.waveInfo=this._texWaveInfo,this.detailMtl.waveInfoD=this._texWaveInfoDir;var d=this.detailMtl._getShader(0,0,0);d.bind();var f=this._detailMesh._getVertexBuffer(0);d.uploadAttributes(f.vertexDeclaration.shaderValues.data,null),this.detailMtl._upload(),c._render(t),this._texWave.end(),l&&o.enable(2929),h&&o.enable(2884)}u&&o.viewport(_[0],_[1],_[2],_[3]),this._syncObj?this.mtl.detailTexture=this._syncObj._texWave:this.mtl.detailTexture=this._texWave,this.mtl.waveInfo=this._geoWaveInfo,this.mtl.waveInfoD=this._geoWaveInfoDir,this.mtl.underWaterTexture=this._texRefract,this._stop||(this._syncObj?this.curTm=this._syncObj.curTm:this.curTm=n.timer.currTimer-this.startTm,this.mtl._setNumber(8,this.curTm)),e.shownormal&&!this._shownormal&&(this._shownormal=!0,this.mtl._addShaderDefine(gn.SHADERDEFINE_SHOW_NORMAL)),e.shownormal&&this._shownormal&&(this._shownormal=!1,this.mtl._removeShaderDefine(gn.SHADERDEFINE_SHOW_NORMAL))}},o._update=function(e){laya.d3.core.RenderableSprite3D.prototype._update.call(this,e)},a(0,o,"src",null,function(e){var t=new x;t.on("complete",this,this.onDescLoaded),t.load(e)}),a(0,o,"syncObj",null,function(e){this._syncObj=e,this.renderDetailWav=!1}),s._waveInfoEleNum=4,s.detailTexWidth=256,s.detailTexHeight=256,i(s,["deg2rad",function(){return this.deg2rad=Math.PI/180},"_2pi",function(){return this._2pi=2*Math.PI}])}();n.__init([pt])}(window,document,Laya);