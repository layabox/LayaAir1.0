!function(e,t,n){var i=(n.un,n.uns,n["static"]),r=n["class"],a=n.getset,s=(n.__newvec,laya.ani.AnimationPlayer),o=(laya.ani.AnimationState,laya.maths.Arith),h=(laya.resource.Bitmap,laya.utils.Browser),l=laya.webgl.utils.Buffer,u=(laya.webgl.utils.Buffer2D,laya.utils.Byte),_=laya.utils.ClassUtils,c=n.Config,d=laya.particle.emitter.EmitterBase,f=(laya.events.Event,laya.events.EventDispatcher),m=laya.utils.Handler,p=laya.webgl.utils.IndexBuffer2D,v=laya.ani.KeyframesAniTemplet,g=laya.net.Loader,x=laya.display.Node,T=(laya.particle.ParticleSetting,laya.particle.shader.ParticleShader),C=laya.particle.ParticleTemplateWebGL,b=(laya.maths.Rectangle,laya.renders.Render),I=(laya.renders.RenderContext,laya.renders.RenderSprite,laya.webgl.utils.RenderState2D),E=laya.resource.Resource,D=laya.utils.RunDriver,M=laya.webgl.shader.Shader,y=laya.webgl.shader.ShaderDefines,w=laya.display.Sprite,V=laya.utils.Stat,A=laya.net.URL,P=laya.webgl.utils.ValusArray,S=laya.webgl.utils.VertexBuffer2D,R=laya.webgl.WebGL,O=laya.webgl.WebGLContext;laya.webgl.canvas.WebGLContext2D,laya.webgl.resource.WebGLImage;n["interface"]("laya.d3.graphics.IVertex"),n["interface"]("laya.d3.core.render.IRenderable"),n["interface"]("laya.d3.core.render.IUpdate");var N=(function(){function e(){this.texturePath=null,this.lifeTime=.5,this.minSegmentDistance=.1,this.minInterpDistance=.6,this.maxSlerpCount=128,this.maxSegments=200,this.color=new Me(1,1,1,1)}return r(e,"laya.d3.core.glitter.GlitterSetting"),e}(),function(){function e(){this._tempVector30=new De,this._tempVector31=new De,this._tempVector32=new De,this._a=new De,this._b=new De,this._c=new De,this._d=new De}r(e,"laya.d3.core.glitter.SplineCurvePositionVelocity");var t=e.prototype;return t.Init=function(e,t,n,i){e.cloneTo(this._d),t.cloneTo(this._c),De.scale(e,2,this._a),De.scale(n,2,this._tempVector30),De.subtract(this._a,this._tempVector30,this._a),De.add(this._a,t,this._a),De.add(this._a,i,this._a),De.scale(n,3,this._b),De.scale(e,3,this._tempVector30),De.subtract(this._b,this._tempVector30,this._b),De.subtract(this._b,i,this._b),De.scale(t,2,this._tempVector30),De.subtract(this._b,this._tempVector30,this._b)},t.Slerp=function(e,t){De.scale(this._a,e*e*e,this._tempVector30),De.scale(this._b,e*e,this._tempVector31),De.scale(this._c,e,this._tempVector32),De.add(this._tempVector30,this._tempVector31,t),De.add(t,this._tempVector32,t),De.add(t,this._d,t)},e}()),L=function(){function e(e,t,n,i){this._datas=null,this._w=0,this._h=0,this._minHeight=NaN,this._maxHeight=NaN,this._datas=[],this._w=e,this._h=t,this._minHeight=n,this._maxHeight=i}r(e,"laya.d3.core.HeightMap");var t=e.prototype;return t._inBounds=function(e,t){return e>=0&&e<this._h&&t>=0&&t<this._w},t.getHeight=function(e,t){return this._inBounds(e,t)?this._datas[e][t]:NaN},a(0,t,"width",function(){return this._w}),a(0,t,"height",function(){return this._h}),a(0,t,"minHeight",function(){return this._minHeight}),a(0,t,"maxHeight",function(){return this._maxHeight}),e.creatFromMesh=function(t,n,i,r){for(var a=[],s=[],o=t.getSubMeshCount(),h=0;o>h;h++){for(var l=t.getSubMesh(h),u=l._getVertexBuffer(),_=u.getData(),c=[],d=0;d<_.length;d+=u.vertexDeclaration.vertexStride/4){var f=new De(_[d+0],_[d+1],_[d+2]);c.push(f)}a.push(c);var m=l._getIndexBuffer();s.push(m.getData())}var p=t.boundingBox,v=p.min.x,g=p.min.z,x=p.max.x,T=p.max.z,C=p.min.y,b=p.max.y,I=x-v,E=T-g,D=r.elements[0]=I/(n-1),M=r.elements[1]=E/(i-1),y=new e(n,i,C,b),w=e._tempRay,V=w.direction.elements;V[0]=0,V[1]=-1,V[2]=0;var A=.1,P=b+A;w.origin.elements[1]=P;for(var S=0;n>S;S++){var R=g+S*M;y._datas[S]=[];for(var O=0;i>O;O++){var N=v+O*D,L=w.origin.elements;L[0]=N,L[2]=R;var B=e._getPosition(w,a,s);y._datas[S][O]=B===Number.MAX_VALUE?NaN:P-B}}return y},e.createFromImage=function(t,n,i){var r=t.width,a=t.height,s=new e(r,a,n,i),o=(i-n)/254;h.canvas.size(r,a),h.context.drawImage(t._image,0,0,r,a);for(var l=h.context.getImageData(0,0,r,a).data,u=0,_=0;r>_;_++)for(var c=s._datas[_]=[],d=0;a>d;d++){var f=l[u++],m=l[u++],p=l[u++],v=l[u++];255==f&&255==m&&255==p&&255==v?c[d]=NaN:c[d]=(f+m+p)/3*o+n}return s},e._getPosition=function(e,t,n){for(var i=Number.MAX_VALUE,r=0;r<t.length;r++)for(var a=t[r],s=n[r],o=0;o<s.length;o+=3){var h=a[s[o+0]],l=a[s[o+1]],u=a[s[o+2]],_=Ve.rayIntersectsTriangle(e,h,l,u);!isNaN(_)&&i>_&&(i=_)}return i},i(e,["_tempRay",function(){return this._tempRay=new Ie(new De,new De)}]),e}(),B=function(){function e(){if(this._id=0,this._number=0,this._mask=0,this._active=!0,this._visible=!0,this.name=null,this._id=e._uniqueIDCounter,e._uniqueIDCounter++,this._id>32)throw new Error("不允许创建Layer，请参考函数getLayerByNumber、getLayerByMask、getLayerByName！")}r(e,"laya.d3.core.Layer");var t=e.prototype;return a(0,t,"number",function(){return this._number}),a(0,t,"mask",function(){return this._mask}),a(0,t,"active",function(){return this._active},function(t){29!==this._number&&30!=this._number&&(this._active=t,t?e._activeLayers=e._activeLayers|this.mask:e._activeLayers=e._activeLayers&~this.mask)}),a(0,t,"visible",function(){return this._visible},function(t){29!==this._number&&30!=this._number&&(this._visible=t,t?e._visibleLayers=e._visibleLayers|this.mask:e._visibleLayers=e._visibleLayers&~this.mask)}),a(1,e,"activeLayers",function(){return e._activeLayers},function(t){e._activeLayers=t|e.getLayerByNumber(29).mask|e.getLayerByNumber(30).mask;for(var n=0;n<e._layerList.length;n++){var i=e._layerList[n];i._active=0!==(i._mask&e._activeLayers)}}),a(1,e,"visibleLayers",function(){return e._visibleLayers},function(t){e._visibleLayers=t|e.getLayerByNumber(29).mask|e.getLayerByNumber(30).mask;for(var n=0;n<e._layerList.length;n++){var i=e._layerList[n];i._visible=0!==(i._mask&e._visibleLayers)}}),e.__init__=function(){e._layerList.length=31;for(var t=0;31>t;t++){var n=new e;e._layerList[t]=n,0===t?n.name="Default Layer":29===t?n.name="Reserved Layer0":30===t?n.name="Reserved Layer1":n.name="Layer-"+t,n._number=t,n._mask=Math.pow(2,t)}e._activeLayers=2147483647,e._visibleLayers=2147483647,e._currentCameraCullingMask=2147483647,e.currentCreationLayer=e._layerList[0]},e.getLayerByNumber=function(t){if(0>t||t>30)throw new Error("无法返回指定Layer，该number超出范围！");return e._layerList[t]},e.getLayerByMask=function(t){for(var n=0;31>n;n++)if(e._layerList[n].mask===t)return e._layerList[n];throw new Error("无法返回指定Layer,该mask不存在")},e.getLayerByName=function(t){for(var n=0;31>n;n++)if(e._layerList[n].name===t)return e._layerList[n];throw new Error("无法返回指定Layer,该name不存在")},e.isActive=function(t){return 0!=(t&e._activeLayers)},e.isVisible=function(t){return 0!=(t&e._currentCameraCullingMask&e._visibleLayers)},e._uniqueIDCounter=1,e._layerCount=31,e._layerList=[],e._activeLayers=0,e._visibleLayers=0,e._currentCameraCullingMask=0,e.currentCreationLayer=null,e}(),F=(function(){function e(){this._tempInt0=0,this._tempInt1=0,this._tempUint0=0,this._tempUint1=0,this._tempUint2=0,this._tempUint3=0,this._tempUint4=0,this._tempUint5=0,this._tempUint6=0,this._tempUint7=0,this._tempNumver0=NaN,this._tempNumver1=NaN,this._tempNumver2=NaN,this._tempNumver3=NaN,this._floatSizePerVer=7,this._defaultBufferSize=600*this._floatSizePerVer,this._vb=null,this._posInVBData=0,this._ib=null,this._posInIBData=0,this._primitiveType=NaN,this._hasBegun=!1,this._numVertsPerPrimitive=0,this._renderState=null,this._sharderNameID=0,this._shader=null,this._posShaderValue=[3,5126,!1,28,0],this._colorShaderValue=[4,5126,!1,28,12],this._albedo=new Me(1,1,1,1),this._vbData=new Float32Array(this._defaultBufferSize),this._ibData=new Uint16Array(this._defaultBufferSize),this._wvpMatrix=new Te,this._vb=new S(-1,35048),this._ib=new p,this._sharderNameID=M.nameKey.get("SIMPLE")}r(e,"laya.d3.core.PhasorSpriter3D");var t=e.prototype;return t.line=function(e,t,n,i,r,a,s,o,h,l,u,_,c,d){return this._hasBegun&&1===this._primitiveType||this.drawLinesException(),(this._posInVBData+2*this._floatSizePerVer>this._vbData.length||this._posInIBData+2>this._ibData.length)&&this.flush(),this._tempUint0=this._posInVBData/this._floatSizePerVer,this.addVertex(e,t,n,i,r,a,s),this.addVertex(o,h,l,u,_,c,d),this.addIndexes(this._tempUint0,this._tempUint0+1),this},t.circle=function(e,t,n,i,r,a){for(this._hasBegun&&1===this._primitiveType||this.drawLinesException(),this._tempUint0=2*t,(this._posInVBData+this._tempUint0*this._floatSizePerVer>this._vbData.length||this._posInIBData+2*this._tempUint0>this._ibData.length)&&this.flush(),this._tempUint1=this._posInVBData/this._floatSizePerVer,this._tempNumver0=0,this._tempInt0=0;this._tempNumver0<6.2832;this._tempNumver0=this._tempNumver0+3.1416/t,this._tempInt0++)this.addVertex(Math.sin(this._tempNumver0)*e,Math.cos(this._tempNumver0)*e,0,n,i,r,a),0===this._tempInt0?this.addIndexes(this._tempUint1):this._tempInt0===this._tempUint0-1?(this._tempUint2=this._tempUint1+this._tempInt0,this.addIndexes(this._tempUint2,this._tempUint2,this._tempUint1)):(this._tempUint2=this._tempUint1+this._tempInt0,this.addIndexes(this._tempUint2,this._tempUint2));return this},t.plane=function(e,t,n,i,r,a,s,o,h){return this._hasBegun&&4===this._primitiveType||this.drawTrianglesException(),(this._posInVBData+4*this._floatSizePerVer>this._vbData.length||this._posInIBData+6>this._ibData.length)&&this.flush(),this._tempNumver0=i/2,this._tempNumver1=r/2,this._tempUint0=this._posInVBData/this._floatSizePerVer,this.addVertex(e-this._tempNumver0,t+this._tempNumver1,n,a,s,o,h),this.addVertex(e+this._tempNumver0,t+this._tempNumver1,n,a,s,o,h),this.addVertex(e-this._tempNumver0,t-this._tempNumver1,n,a,s,o,h),this.addVertex(e+this._tempNumver0,t-this._tempNumver1,n,a,s,o,h),this._tempUint1=this._tempUint0+1,this._tempUint2=this._tempUint0+2,this.addIndexes(this._tempUint0,this._tempUint1,this._tempUint2,this._tempUint2,this._tempUint1,this._tempUint0+3),this},t.box=function(e,t,n,i,r,a,s,o,h,l){return this._hasBegun&&4===this._primitiveType||this.drawTrianglesException(),(this._posInVBData+8*this._floatSizePerVer>this._vbData.length||this._posInIBData+36>this._ibData.length)&&this.flush(),this._tempNumver0=i/2,this._tempNumver1=r/2,this._tempNumver2=a/2,this._tempUint0=this._posInVBData/this._floatSizePerVer,this.addVertex(e-this._tempNumver0,t+this._tempNumver1,n+this._tempNumver2,s,o,h,l),this.addVertex(e+this._tempNumver0,t+this._tempNumver1,n+this._tempNumver2,s,o,h,l),this.addVertex(e-this._tempNumver0,t-this._tempNumver1,n+this._tempNumver2,s,o,h,l),this.addVertex(e+this._tempNumver0,t-this._tempNumver1,n+this._tempNumver2,s,o,h,l),this.addVertex(e+this._tempNumver0,t+this._tempNumver1,n-this._tempNumver2,s,o,h,l),this.addVertex(e-this._tempNumver0,t+this._tempNumver1,n-this._tempNumver2,s,o,h,l),this.addVertex(e+this._tempNumver0,t-this._tempNumver1,n-this._tempNumver2,s,o,h,l),this.addVertex(e-this._tempNumver0,t-this._tempNumver1,n-this._tempNumver2,s,o,h,l),this._tempUint1=this._tempUint0+1,this._tempUint2=this._tempUint0+2,this._tempUint3=this._tempUint0+3,this._tempUint4=this._tempUint0+4,this._tempUint5=this._tempUint0+5,this._tempUint6=this._tempUint0+6,this._tempUint7=this._tempUint0+7,this.addIndexes(this._tempUint0,this._tempUint1,this._tempUint2,this._tempUint2,this._tempUint1,this._tempUint3,this._tempUint4,this._tempUint5,this._tempUint6,this._tempUint6,this._tempUint5,this._tempUint7,this._tempUint5,this._tempUint0,this._tempUint7,this._tempUint7,this._tempUint0,this._tempUint2,this._tempUint1,this._tempUint4,this._tempUint3,this._tempUint3,this._tempUint4,this._tempUint6,this._tempUint5,this._tempUint4,this._tempUint0,this._tempUint0,this._tempUint4,this._tempUint1,this._tempUint2,this._tempUint3,this._tempUint7,this._tempUint7,this._tempUint3,this._tempUint6),this},t.cone=function(e,t,n,i,r,a,s){for(this._hasBegun&&4===this._primitiveType||this.drawTrianglesException(),(this._posInVBData+(2*n+2)*this._floatSizePerVer>this._vbData.length||this._posInIBData+6*n>this._ibData.length)&&this.flush(),this._tempUint0=this._posInVBData,this._tempUint1=this._posInVBData/this._floatSizePerVer,this._tempNumver0=2*Math.PI/n,this.addVertexIndex(0,t,0,i,r,a,s,this._tempUint0),this.addVertexIndex(0,0,0,i,r,a,s,this._tempUint0+this._floatSizePerVer),this._tempInt0=2,this._tempNumver1=0,this._tempInt1=0;this._tempInt1<n;this._tempInt1++)this._tempNumver2=Math.cos(this._tempNumver1),this._tempNumver3=Math.sin(this._tempNumver1),this.addVertexIndex(e*this._tempNumver2,0,e*this._tempNumver3,i,r,a,s,this._tempUint0+this._tempInt0*this._floatSizePerVer),this.addIndexes(this._tempUint1,this._tempUint1+this._tempInt0),this._tempInt1==n-1?this.addIndexes(this._tempUint1+2):this.addIndexes(this._tempUint1+this._tempInt0+1),this.addVertexIndex(e*this._tempNumver2,0,e*this._tempNumver3,i,r,a,s,this._tempUint0+(this._tempInt0+n)*this._floatSizePerVer),this.addIndexes(this._tempUint1+1),this._tempInt1==n-1?this.addIndexes(this._tempUint1+n+2):this.addIndexes(this._tempUint1+this._tempInt0+n+1),this.addIndexes(this._tempUint1+this._tempInt0+n),this._tempInt0++,this._tempNumver1+=this._tempNumver0;return this},t.boundingBoxLine=function(e,t,n,i,r,a,s,o,h,l){return this._hasBegun&&1===this._primitiveType||this.drawLinesException(),(this._posInVBData+8*this._floatSizePerVer>this._vbData.length||this._posInIBData+48>this._ibData.length)&&this.flush(),this._tempUint0=this._posInVBData/this._floatSizePerVer,this.addVertex(e,r,a,s,o,h,l),this.addVertex(i,r,a,s,o,h,l),this.addVertex(e,t,a,s,o,h,l),this.addVertex(i,t,a,s,o,h,l),this.addVertex(i,r,n,s,o,h,l),this.addVertex(e,r,n,s,o,h,l),this.addVertex(i,t,n,s,o,h,l),this.addVertex(e,t,n,s,o,h,l),this._tempUint1=this._tempUint0+1,this._tempUint2=this._tempUint0+2,this._tempUint3=this._tempUint0+3,this._tempUint4=this._tempUint0+4,this._tempUint5=this._tempUint0+5,this._tempUint6=this._tempUint0+6,this._tempUint7=this._tempUint0+7,this.addIndexes(this._tempUint0,this._tempUint1,this._tempUint1,this._tempUint3,this._tempUint3,this._tempUint2,this._tempUint2,this._tempUint0,this._tempUint4,this._tempUint5,this._tempUint5,this._tempUint7,this._tempUint7,this._tempUint6,this._tempUint6,this._tempUint4,this._tempUint5,this._tempUint0,this._tempUint0,this._tempUint2,this._tempUint2,this._tempUint7,this._tempUint7,this._tempUint5,this._tempUint1,this._tempUint4,this._tempUint4,this._tempUint6,this._tempUint6,this._tempUint3,this._tempUint3,this._tempUint1,this._tempUint5,this._tempUint4,this._tempUint4,this._tempUint1,this._tempUint1,this._tempUint0,this._tempUint0,this._tempUint5,this._tempUint2,this._tempUint3,this._tempUint3,this._tempUint6,this._tempUint6,this._tempUint7,this._tempUint7,this._tempUint2),this},t.addVertex=function(e,t,n,i,r,a,s){return this._hasBegun||this.addVertexIndexException(),this._vbData[this._posInVBData]=e,this._vbData[this._posInVBData+1]=t,this._vbData[this._posInVBData+2]=n,this._vbData[this._posInVBData+3]=i,this._vbData[this._posInVBData+4]=r,this._vbData[this._posInVBData+5]=a,this._vbData[this._posInVBData+6]=s,this._posInVBData+=this._floatSizePerVer,this},t.addVertexIndex=function(e,t,n,i,r,a,s,o){return this._hasBegun||this.addVertexIndexException(),this._vbData[o]=e,this._vbData[o+1]=t,this._vbData[o+2]=n,this._vbData[o+3]=i,this._vbData[o+4]=r,this._vbData[o+5]=a,this._vbData[o+6]=s,o+=this._floatSizePerVer,o>this._posInVBData&&(this._posInVBData=o),this},t.addIndexes=function(e){var t=arguments;this._hasBegun||this.addVertexIndexException();for(var n=0;n<t.length;n++)this._ibData[this._posInIBData]=t[n],this._posInIBData++;return this},t.begin=function(e,t,n){return this._hasBegun&&this.beginException0(),1!==e&&4!==e&&this.beginException1(),this._primitiveType=e,this._wvpMatrix=t,this._renderState=n,this._hasBegun=!0,this},t.end=function(){return this._hasBegun||this.endException(),this.flush(),this._hasBegun=!1,this},t.flush=function(){if(0!==this._posInVBData){this._ib.clear(),this._ib.append(this._ibData),this._vb.clear(),this._vb.append(this._vbData),this._vb.bind_upload(this._ib);var e=this._renderState.shaderValue.length,t=this._renderState.shaderDefs.getValue();this._shader=this.getShader(this._renderState),this._renderState.shaderValue.pushValue("POSITION",this._posShaderValue),this._renderState.shaderValue.pushValue("COLOR",this._colorShaderValue),this._renderState.shaderValue.pushValue("MVPMATRIX",this._wvpMatrix.elements),this._renderState.shaderValue.pushValue("ALBEDO",this._albedo.elements),this._shader.uploadArray(this._renderState.shaderValue.data,this._renderState.shaderValue.length,null),this._renderState.shaderDefs.setValue(t),this._renderState.shaderValue.length=e,V.drawCall++,R.mainContext.drawElements(this._primitiveType,this._posInIBData,5123,0),this._posInIBData=0,this._posInVBData=0}},t.getShader=function(e){var t=e.shaderDefs._value;e.shaderDefs._value=-449&t,e.shaderDefs.add(32);var n=e.shaderDefs.getValue()|e.shadingMode+2e-4*this._sharderNameID,i=this._shader?this._shader:M.getShader(n);return i||(i=M.withCompile(this._sharderNameID,e.shadingMode,e.shaderDefs.toNameDic(),n,null))},t.addVertexIndexException=function(){throw new Error("请先调用begin()函数")},t.beginException0=function(){throw new Error("调用begin()前请确保已成功调用end()！")},t.beginException1=function(){throw new Error("只支持“LINES”和“TRIANGLES”两种基元！")},t.endException=function(){throw new Error("调用end()前请确保已成功调用begin()！")},t.drawLinesException=function(){throw new Error("您必须确保在此之前已调用begin()且使用“LINES”基元！")},t.drawTrianglesException=function(){throw new Error("您必须确保在此之前已调用begin()且使用“TRIANGLES”基元！")},e}(),function(){function e(){this.depthTest=!0,this.depthMask=1,this.blend=!1,this.cullFace=!0,this.sFactor=1,this.dFactor=0,this.frontFace=2304}return r(e,"laya.d3.core.render.RenderConfig"),e}()),U=function(){function e(){this._type=0,this._mainSortID=0,this._renderCullingObject=null,this._sprite3D=null,this._material=null,this._renderObj=null,this._staticBatch=null,this._batchIndexStart=0,this._batchIndexEnd=0}r(e,"laya.d3.core.render.RenderElement");var t=e.prototype;return t.getStaticBatchBakedVertexs=function(t){var n=4,i=this._renderObj._getVertexBuffer(t),r=i.getData().slice(),a=i.vertexDeclaration,s=a.getVertexElementByUsage("POSITION").offset/n,o=a.getVertexElementByUsage("NORMAL").offset/n,h=this._staticBatch._rootSprite.transform.worldMatrix,l=this._sprite3D.transform.worldMatrix,u=e._tempMatrix4x40,_=e._tempMatrix4x41;h.invert(u),Te.multiply(u,l,_);var c=e._tempQuaternion0;_.decompose(e._tempVector30,c,e._tempVector31);for(var d=a.vertexStride/n,f=0,m=r.length;m>f;f+=d){var p=f+s;Se.transformVector3ArrayToVector3ArrayCoordinate(r,p,_,r,p),Se.transformVector3ArrayByQuat(r,o,c,r,o)}return r},t.getDynamicBatchBakedVertexs=function(e){for(var t=4,n=this._renderObj._getVertexBuffer(e),i=n.getData().slice(),r=n.vertexDeclaration,a=r.getVertexElementByUsage("POSITION").offset/t,s=r.getVertexElementByUsage("NORMAL").offset/t,o=this._sprite3D.transform,h=o.worldMatrix,l=o.rotation,u=r.vertexStride/t,_=0,c=i.length;c>_;_+=u){var d=_+a;Se.transformVector3ArrayToVector3ArrayCoordinate(i,d,h,i,d),Se.transformVector3ArrayByQuat(i,s,l,i,s)}return i},t.getBakedIndices=function(){return this._renderObj._getIndexBuffer().getData()},a(0,t,"renderObj",function(){return this._renderObj},function(e){this._renderObj!==e&&(this._renderObj=e)}),i(e,["_tempVector30",function(){return this._tempVector30=new De},"_tempVector31",function(){return this._tempVector31=new De},"_tempQuaternion0",function(){return this._tempQuaternion0=new be},"_tempMatrix4x40",function(){return this._tempMatrix4x40=new Te},"_tempMatrix4x41",function(){return this._tempMatrix4x41=new Te}]),e}(),G=function(){function e(t,n){this._id=0,this._needSort=!1,this._renderElements=null,this._staticBatches=null,this._renderableRenderObjects=null,this._renderConfig=null,this._staticBatchCombineRenderElements=null,this._dynamicBatchCombineRenderElements=null,this._finalElements=null,this._scene=null,this._id=++e._uniqueIDCounter,this._needSort=!1,this._renderConfig=t,this._scene=n,this._renderElements=[],this._renderableRenderObjects=[],this._staticBatchCombineRenderElements=[],this._dynamicBatchCombineRenderElements=[],this._staticBatches=[]}r(e,"laya.d3.core.render.RenderQueue");var t=e.prototype;return t._sortAlphaFunc=function(t,n){return t._renderCullingObject&&n._renderCullingObject?De.distance(n._renderCullingObject._boundingSphere.center,e._cameraPosition)-De.distance(t._renderCullingObject._boundingSphere.center,e._cameraPosition):0},t._begainRenderElement=function(e,t,n){return t._beforeRender(e)?(e.shaderValue.pushArray(t._getVertexBuffer(0).vertexDeclaration.shaderValues),!0):!1},t._endRenderElement=function(e,t,n){n._upload(e,t._getVertexBuffer(0).vertexDeclaration,null)&&t._render(e)},t._preRenderUpdateComponents=function(e,t){for(var n=0;n<e.componentsCount;n++){var i=e.getComponentByIndex(n);!i.started&&(i._start(t),i.started=!0),i.isActive&&i._preRenderUpdate(t)}},t._postRenderUpdateComponents=function(e,t){for(var n=0;n<e.componentsCount;n++){var i=e.getComponentByIndex(n);!i.started&&(i._start(t),i.started=!0),i.isActive&&i._postRenderUpdate(t)}},t._sortAlpha=function(t){e._cameraPosition=t,this._finalElements.sort(this._sortAlphaFunc)},t._setState=function(e,t){O.setDepthTest(e,this._renderConfig.depthTest),O.setDepthMask(e,this._renderConfig.depthMask),O.setBlend(e,this._renderConfig.blend),O.setBlendFunc(e,this._renderConfig.sFactor,this._renderConfig.dFactor),O.setCullFace(e,this._renderConfig.cullFace),t.camera.renderTarget?O.setFrontFaceCCW(e,2304===this._renderConfig.frontFace?2305:2304):O.setFrontFaceCCW(e,this._renderConfig.frontFace)},t._preRender=function(e){this._staticBatchCombineRenderElements.length=0;for(var t=0,n=this._staticBatches.length;n>t;t++)this._staticBatches[t]._getRenderElement(this._staticBatchCombineRenderElements);this._finalElements=this._renderElements.concat(this._staticBatchCombineRenderElements,this._dynamicBatchCombineRenderElements)},t._render=function(e){for(var t=e.shaderValue.length,n=e.shaderDefs.getValue(),i=0,r=this._finalElements.length;r>i;i++){var a,s,o=this._finalElements[i];if(0===o._type){var h=o._sprite3D;e.owner=h,e.renderElement=o,this._preRenderUpdateComponents(h,e),a=o.renderObj,s=o._material,this._begainRenderElement(e,a,s)&&(s._setLoopShaderParams(e,e.projectionViewMatrix,h.transform.worldMatrix,o.renderObj,s),this._endRenderElement(e,a,s)),this._postRenderUpdateComponents(h,e)}else if(1===o._type){var l=o.renderObj;e.owner=null,e.renderElement=o,e._batchIndexStart=o._batchIndexStart,e._batchIndexEnd=o._batchIndexEnd,a=o.renderObj,s=o._material,this._begainRenderElement(e,a,s)&&(o._material._setLoopShaderParams(e,e.projectionViewMatrix,l._rootSprite.transform.worldMatrix,o.renderObj,o._material),this._endRenderElement(e,a,s))}else if(2===o._type){o.renderObj;e.owner=null,e.renderElement=o,e._batchIndexStart=o._batchIndexStart,e._batchIndexEnd=o._batchIndexEnd,a=o.renderObj,s=o._material,this._begainRenderElement(e,a,s)&&(o._material._setLoopShaderParams(e,e.projectionViewMatrix,Te.DEFAULT,o.renderObj,o._material),this._endRenderElement(e,a,s))}e.shaderDefs.setValue(n),e.shaderValue.length=t}},t._clearRenderElements=function(){this._staticBatches.length=0,this._dynamicBatchCombineRenderElements.length=0,this._renderElements.length=0,this._needSort=!0},t._addRenderElement=function(e){this._renderElements.push(e),this._needSort=!0},t._addStaticBatch=function(e){this._staticBatches.push(e)},t._addDynamicBatchElement=function(e){this._dynamicBatchCombineRenderElements.push(e)},a(0,t,"id",function(){return this._id}),e._uniqueIDCounter=0,e.OPAQUE=1,e.OPAQUE_DOUBLEFACE=2,e.ALPHA_BLEND=3,e.ALPHA_BLEND_DOUBLEFACE=4,e.ALPHA_ADDTIVE_BLEND=5,e.ALPHA_ADDTIVE_BLEND_DOUBLEFACE=6,e.DEPTHREAD_ALPHA_BLEND=7,e.DEPTHREAD_ALPHA_BLEND_DOUBLEFACE=8,e.DEPTHREAD_ALPHA_ADDTIVE_BLEND=9,e.DEPTHREAD_ALPHA_ADDTIVE_BLEND_DOUBLEFACE=10,e.NONDEPTH_ALPHA_BLEND=11,e.NONDEPTH_ALPHA_BLEND_DOUBLEFACE=12,e.NONDEPTH_ALPHA_ADDTIVE_BLEND=13,e.NONDEPTH_ALPHA_ADDTIVE_BLEND_DOUBLEFACE=14,e._cameraPosition=null,e}(),H=function(){function e(){this._shadingMode=0,this.elapsedTime=NaN,this.loopCount=0,this.context=null,this.scene=null,this.owner=null,this.renderElement=null,this._staticBatch=null,this._batchIndexStart=0,this._batchIndexEnd=0,this.camera=null,this.viewMatrix=null,this.projectionMatrix=null,this.projectionViewMatrix=null,this.cameraBoundingFrustum=null,this.viewport=null,this.worldShaderValue=new P,this.shaderValue=new P,this.shaderDefs=new Ue,this.reset()}r(e,"laya.d3.core.render.RenderState");var t=e.prototype;return t.reset=function(){this.worldShaderValue.length=0,this.shaderValue.length=0,this.shaderDefs.setValue(0),R.frameShaderHighPrecision&&this.shaderDefs.setValue(1048576)},a(0,t,"shadingMode",function(){return this._shadingMode},function(e){this.shaderDefs.remove(4==e?8:4),this.shaderDefs.add(e),this._shadingMode=e}),e.VERTEXSHADERING=4,e.PIXELSHADERING=8,e.clientWidth=0,e.clientHeight=0,e}(),j=function(){function e(e){this._vertexDeclaration=null,this._vertexDatas=null,this._indexDatas=null,this._vertexBuffer=null,this._indexBuffer=null,this._currentCombineVertexCount=0,this._currentCombineIndexCount=0,this._combineRenderElements=null,this._materials=null,this._materialToRenderElementsOffsets=null,this._merageElements=null,this._combineRenderElementPool=null,this._combineRenderElementPoolIndex=0,this._currentCombineVertexCount=0,this._currentCombineIndexCount=0,this._combineRenderElements=[],this._materialToRenderElementsOffsets=[],this._materials=[],this._merageElements=[],this._combineRenderElementPool=[],this._combineRenderElementPoolIndex=0,this._vertexDeclaration=e}r(e,"laya.d3.graphics.DynamicBatch");var t=e.prototype;return n.imps(t,{"laya.d3.core.render.IRenderable":!0}),t._getVertexBuffer=function(e){return void 0===e&&(e=0),0===e?this._vertexBuffer:null},t._getIndexBuffer=function(){return this._indexBuffer},t._testTangent=function(e){},t._getCombineRenderElementFromPool=function(){var e=this._combineRenderElementPool[this._combineRenderElementPoolIndex++];return e||(this._combineRenderElementPool[this._combineRenderElementPoolIndex-1]=new U)},t._getRenderElement=function(){this._vertexDatas||(this._vertexDatas=new Float32Array(this._vertexDeclaration.vertexStride/4*e.maxVertexCount),this._indexDatas=new Uint16Array(e.maxIndexCount),this._vertexBuffer=it.create(this._vertexDeclaration,e.maxVertexCount,35048),this._indexBuffer=nt.create("ushort",e.maxIndexCount,35048)),this._merageElements.length=0;for(var t=0,n=0,i=0,r=this._combineRenderElements.length;r>i;i++){var a=this._combineRenderElements[i],s=a.getDynamicBatchBakedVertexs(0),o=a.getBakedIndices(),h=t/(this._vertexDeclaration.vertexStride/4),l=n,u=l+o.length;a._batchIndexStart=l,a._batchIndexEnd=u,this._indexDatas.set(o,n);for(var _=l;u>_;_++)this._indexDatas[_]=h+this._indexDatas[_];n+=o.length,this._vertexDatas.set(s,t),t+=s.length}for(this._vertexBuffer.setData(this._vertexDatas),this._indexBuffer.setData(this._indexDatas),this._combineRenderElementPoolIndex=0,i=0,r=this._materials.length;r>i;i++){var c=this._getCombineRenderElementFromPool();c._type=2,c._staticBatch=null,c.renderObj=this;var d=this._combineRenderElements[this._materialToRenderElementsOffsets[i]]._batchIndexStart,f=i+1===this._materialToRenderElementsOffsets.length?n:this._combineRenderElements[this._materialToRenderElementsOffsets[i+1]]._batchIndexStart;c._batchIndexStart=d,c._batchIndexEnd=f,c._material=this._materials[i],this._merageElements.push(c)}},t._addCombineRenderObjTest=function(t){var n=t.renderObj,i=this._currentCombineIndexCount+n._getIndexBuffer().indexCount,r=this._currentCombineVertexCount+n._getVertexBuffer().vertexCount;return!(r>e.maxVertexCount||i>e.maxIndexCount)},t._addCombineRenderObj=function(e){var t=e.renderObj;this._combineRenderElements.push(e),this._currentCombineIndexCount=this._currentCombineIndexCount+t._getIndexBuffer().indexCount,this._currentCombineVertexCount=this._currentCombineVertexCount+t._getVertexBuffer().vertexCount},t._addCombineMaterial=function(e){this._materials.push(e)},t._addMaterialToRenderElementOffset=function(e){this._materialToRenderElementsOffsets.push(e)},t._clearRenderElements=function(){this._combineRenderElements.length=0,this._materials.length=0,this._materialToRenderElementsOffsets.length=0,this._currentCombineVertexCount=0,this._currentCombineIndexCount=0},t._addToRenderQueue=function(e){this._getRenderElement();for(var t=0,n=this._materials.length;n>t;t++)e.getRenderQueue(this._materials[t].renderQueue)._addDynamicBatchElement(this._merageElements[t])},t._beforeRender=function(e){return this._vertexBuffer._bind(),this._indexBuffer._bind(),!0},t._render=function(e){var t=e._batchIndexEnd-e._batchIndexStart;e.context.drawElements(4,t,5123,2*e._batchIndexStart),V.drawCall++,V.trianglesFaces+=t/3},a(0,t,"indexOfHost",function(){return 0}),a(0,t,"_vertexBufferCount",function(){return 1}),a(0,t,"combineRenderElementsCount",function(){return this._combineRenderElements.length}),a(0,t,"triangleCount",function(){return this._indexBuffer.indexCount/3}),e.maxVertexCount=2e4,e.maxIndexCount=4e4,e.maxCombineTriangleCount=50,e}(),k=function(){function e(){this._dynamicBatches=null,this._prepareDynamicBatchCombineElements=null,this._dynamicBatches={},this._prepareDynamicBatchCombineElements=[]}r(e,"laya.d3.graphics.DynamicBatchManager");var t=e.prototype;return t.getDynamicBatch=function(e,t){var n,i=e.id.toString()+t;return this._dynamicBatches[i]?n=this._dynamicBatches[i]:this._dynamicBatches[i]=n=new j(e),n},t._garbageCollection=function(){for(var e in this._dynamicBatches)0===this._dynamicBatches[e].combineRenderElementsCount&&delete this._dynamicBatches[e]},t._addPrepareRenderElement=function(e){this._prepareDynamicBatchCombineElements.push(e)},t._finishCombineDynamicBatch=function(t){this._prepareDynamicBatchCombineElements.sort(e._sortPrepareDynamicBatch);for(var n,i,r,a,s,o,h,l,u=-1,_=!0,c=0,d=-1,f=0,m=this._prepareDynamicBatchCombineElements.length;m>f;f++){s=this._prepareDynamicBatchCombineElements[f];var p=s.renderObj._getVertexBuffer(0).vertexDeclaration,v=i!==p;v&&(c=0,i=p);var g=c!==u;if(g&&(u=c),(v||g)&&(o=this.getDynamicBatch(p,c),n=null),_)if(o._addCombineRenderObjTest(s)){if(a=s._material,n!==a)h&&(t.getRenderQueue(l._material.renderQueue)._addRenderElement(l),h=null,l=null,d=-1),h=a,d=o.combineRenderElementsCount,l=s,n=a;else if(h){var x=l.renderObj,T=s.renderObj;x._getVertexBuffer().vertexCount+T._getVertexBuffer().vertexCount>j.maxVertexCount||x._getIndexBuffer().indexCount+T._getIndexBuffer().indexCount>j.maxIndexCount?(t.getRenderQueue(l._material.renderQueue)._addRenderElement(l),h=a,d=o.combineRenderElementsCount,l=s):(o._addCombineMaterial(h),o._addMaterialToRenderElementOffset(d),o._addCombineRenderObj(l),h=null,l=null,d=-1,o._addCombineRenderObj(s))}else o._addCombineRenderObj(s);_=!0}else h&&(t.getRenderQueue(l._material.renderQueue)._addRenderElement(l),h=null,l=null,d=-1),c++,_=!1;else r=this._prepareDynamicBatchCombineElements[f-1],o._addMaterialToRenderElementOffset(o.combineRenderElementsCount),n=r._material,o._addCombineMaterial(n),o._addCombineRenderObj(r),_=!0,a=s._material,n!==a?(h=a,d=o.combineRenderElementsCount,l=s):o._addCombineRenderObj(s),n=a}h&&(t.getRenderQueue(l._material.renderQueue)._addRenderElement(l),h=null,l=null,d=-1),this._prepareDynamicBatchCombineElements.length=0},t._clearRenderElements=function(){for(var e in this._dynamicBatches)this._dynamicBatches[e]._clearRenderElements()},t._addToRenderQueue=function(e){for(var t in this._dynamicBatches){var n=this._dynamicBatches[t];n.combineRenderElementsCount>0&&n._addToRenderQueue(e)}},t.dispose=function(){this._dynamicBatches=null},e._sortPrepareDynamicBatch=function(e,t){return e._mainSortID-t._mainSortID},e}(),z=function(){function e(){}return r(e,"laya.d3.graphics.FrustumCulling"),e.RenderObjectCulling=function(e,t){var n,i,r=0,a=0,s=0,o=0,h=t._quenes,l=t._staticBatchManager,u=t._dynamicBatchManager,_=t._frustumCullingObjects;for(r=0,a=h.length;a>r;r++)h[r]&&h[r]._clearRenderElements();for(l._clearRenderElements(),u._clearRenderElements(),
r=0,a=_.length;a>r;r++)if(n=_[r],B.isVisible(n._layerMask)&&n._ownerEnable&&n._enable&&0!==e.ContainsBoundSphere(n._boundingSphere))for(s=0,o=n._renderElements.length;o>s;s++){i=n._renderElements[s];var c=i._staticBatch;if(c&&c._material===i._material)c._addRenderElement(i);else{var d=i.renderObj;d.triangleCount<50&&1===d._vertexBufferCount&&d._getIndexBuffer()&&i._material.renderQueue<3?u._addPrepareRenderElement(i):t.getRenderQueue(i._material.renderQueue)._addRenderElement(i)}}l._addToRenderQueue(t),u._finishCombineDynamicBatch(t),u._addToRenderQueue(t)},e}(),W=function(){function e(){this._render=null,this._renderElements=null,this._layerMask=0,this._ownerEnable=!1,this._enable=!1,this._renderElements=[]}r(e,"laya.d3.graphics.RenderCullingObject");var t=e.prototype;return a(0,t,"_boundingSphere",function(){return this._render.boundingSphere}),e}(),X=function(){function e(e,t,n){this._vertexBuffer=null,this._indexBuffer=null,this._renderElements=null,this._combineRenderElementPool=null,this._combineRenderElementPoolIndex=0,this._combineRenderElements=null,this._currentCombineVertexCount=0,this._currentCombineIndexCount=0,this._needFinishCombine=!1,this._rootSprite=null,this._vertexDeclaration=null,this._material=null,this._currentCombineVertexCount=0,this._currentCombineIndexCount=0,this._needFinishCombine=!1,this._renderElements=[],this._combineRenderElements=[],this._combineRenderElementPool=[],this._combineRenderElementPoolIndex=0,this._rootSprite=e,this._vertexDeclaration=t,this._material=n}r(e,"laya.d3.graphics.StaticBatch");var t=e.prototype;return n.imps(t,{"laya.d3.core.render.IRenderable":!0}),t._testTangent=function(e){},t._getVertexBuffer=function(e){return void 0===e&&(e=0),0===e?this._vertexBuffer:null},t._getIndexBuffer=function(){return this._indexBuffer},t._getCombineRenderElementFromPool=function(){var e=this._combineRenderElementPool[this._combineRenderElementPoolIndex++];return e||(this._combineRenderElementPool[this._combineRenderElementPoolIndex-1]=new U)},t._addCombineRenderObjTest=function(t){var n=t.renderObj,i=this._currentCombineVertexCount+n._getVertexBuffer().vertexCount;return!(i>e.maxVertexCount)},t._addCombineRenderObj=function(e){var t=e.renderObj;this._combineRenderElements.push(e),e._staticBatch=this,this._currentCombineIndexCount=this._currentCombineIndexCount+t._getIndexBuffer().indexCount,this._currentCombineVertexCount=this._currentCombineVertexCount+t._getVertexBuffer().vertexCount,this._needFinishCombine=!0},t._deleteCombineRenderObj=function(e){var t=e.renderObj,n=this._combineRenderElements.indexOf(e);-1!==n&&(this._combineRenderElements.splice(n,1),e._staticBatch=null,this._currentCombineIndexCount=this._currentCombineIndexCount-t._getIndexBuffer().indexCount,this._currentCombineVertexCount=this._currentCombineVertexCount-t._getVertexBuffer().vertexCount,this._needFinishCombine=!0)},t._finshCombine=function(){if(this._needFinishCombine){var e=0,t=0,n=new Float32Array(this._vertexDeclaration.vertexStride/4*this._currentCombineVertexCount),i=new Uint16Array(this._currentCombineIndexCount);this._vertexBuffer&&(this._vertexBuffer.dispose(),this._indexBuffer.dispose()),this._vertexBuffer=it.create(this._vertexDeclaration,this._currentCombineVertexCount,35044),this._indexBuffer=nt.create("ushort",this._currentCombineIndexCount,35044);for(var r=0,a=this._combineRenderElements.length;a>r;r++){var s=this._combineRenderElements[r],o=s.getStaticBatchBakedVertexs(0),h=s.getBakedIndices(),l=e/(this._vertexDeclaration.vertexStride/4),u=t,_=u+h.length;s._batchIndexStart=u,s._batchIndexEnd=_,i.set(h,t);for(var c=u;_>c;c++)i[c]=l+i[c];t+=h.length,n.set(o,e),e+=o.length}this._vertexBuffer.setData(n),this._indexBuffer.setData(i),this._needFinishCombine=!1}},t._clearRenderElements=function(){this._renderElements.length=0},t._addRenderElement=function(e){for(var t=0,n=this._renderElements.length;n>t;t++)if(this._renderElements[t]._batchIndexStart>e._batchIndexStart)return void this._renderElements.splice(t,0,e);this._renderElements.push(e)},t._getRenderElement=function(e){this._combineRenderElementPoolIndex=0;var t=this._renderElements.length,n=this._getCombineRenderElementFromPool();if(n._type=1,n._staticBatch=null,n.renderObj=this,n._batchIndexStart=this._renderElements[0]._batchIndexStart,n._batchIndexEnd=this._renderElements[0]._batchIndexEnd,n._material=this._material,n._material=this._material,e.push(n),t>1)for(var i=1;t>i;i++){var r=this._renderElements[i];this._renderElements[i-1]._batchIndexEnd!==r._batchIndexStart?(n=this._getCombineRenderElementFromPool(),n._type=1,n._staticBatch=null,n.renderObj=this,n._batchIndexStart=r._batchIndexStart,n._batchIndexEnd=r._batchIndexEnd,n._material=this._material,e.push(n)):n._batchIndexEnd=r._batchIndexEnd}},t._addToRenderQueue=function(e){this._renderElements.length>0&&e.getRenderQueue(this._material.renderQueue)._addStaticBatch(this)},t._beforeRender=function(e){return this._vertexBuffer._bind(),this._indexBuffer._bind(),!0},t._render=function(e){var t=e._batchIndexEnd-e._batchIndexStart;e.context.drawElements(4,t,5123,2*e._batchIndexStart),V.drawCall++,V.trianglesFaces+=t/3},a(0,t,"_vertexBufferCount",function(){return 1}),a(0,t,"indexOfHost",function(){return 0}),a(0,t,"triangleCount",function(){return this._indexBuffer.indexCount/3}),e._addToRenderQueueStaticBatch=function(t,n){var i=0,r=0;if(n instanceof laya.d3.core.MeshSprite3D&&n.isStatic){var a=n.meshRender.renderCullingObject._renderElements;for(i=0,r=a.length;r>i;i++){var s=a[i];1===s.renderObj._vertexBufferCount&&t._staticBatchManager._addPrepareRenderElement(s)}}for(i=0,r=n.numChildren;r>i;i++)e._addToRenderQueueStaticBatch(t,n._childs[i])},e.combine=function(t){var n=t.scene;if(!n)throw new Error("BaseScene: staticBatchRoot is not a part of scene.");e._addToRenderQueueStaticBatch(n,t),n._staticBatchManager._finishCombineStaticBatch(t)},e.maxVertexCount=65535,e}(),q=function(){function e(){this._staticBatches=null,this._prepareStaticBatchCombineElements=null,this._staticBatches={},this._prepareStaticBatchCombineElements=[]}r(e,"laya.d3.graphics.StaticBatchManager");var t=e.prototype;return t._finshCombine=function(){for(var e in this._staticBatches)this._staticBatches[e]._finshCombine()},t.getStaticBatch=function(e,t,n,i){var r,a=e.id.toString()+n.id.toString()+t.id.toString()+i;return this._staticBatches[a]?r=this._staticBatches[a]:this._staticBatches[a]=r=new X(e,t,n),r},t._garbageCollection=function(){for(var e in this._staticBatches)0===this._staticBatches[e].combineRenderElementsCount&&delete this._staticBatches[e]},t._addPrepareRenderElement=function(e){this._prepareStaticBatchCombineElements.push(e)},t._finishCombineStaticBatch=function(t){this._prepareStaticBatchCombineElements.sort(e._sortPrepareStaticBatch);for(var n,i,r,a,s,o,h,l=!1,u=0,_=0,c=this._prepareStaticBatchCombineElements.length;c>_;_++){if(a=this._prepareStaticBatchCombineElements[_],o=a.renderObj._getVertexBuffer(0),i===o.vertexDeclaration&&n===a._material)if(l)r._addCombineRenderObjTest(a)?(h=a._staticBatch,h&&h!==r&&h._deleteCombineRenderObj(a),r._addCombineRenderObj(a)):(l=!1,u++);else{s=this._prepareStaticBatchCombineElements[_-1];var d=s.renderObj,f=a.renderObj;d._getVertexBuffer().vertexCount+f._getVertexBuffer().vertexCount>X.maxVertexCount?l=!1:(r=this.getStaticBatch(t,i,n,u),h=s._staticBatch,h&&h!==r&&h._deleteCombineRenderObj(s),r._addCombineRenderObj(s),h=a._staticBatch,h&&h!==r&&h._deleteCombineRenderObj(a),r._addCombineRenderObj(a),l=!0)}else l=!1,u=0;n=a._material,i=o.vertexDeclaration}this._garbageCollection(),this._finshCombine(),this._prepareStaticBatchCombineElements.length=0},t._clearRenderElements=function(){for(var e in this._staticBatches)this._staticBatches[e]._clearRenderElements()},t._addToRenderQueue=function(e){for(var t in this._staticBatches)this._staticBatches[t]._addToRenderQueue(e)},t.dispose=function(){this._staticBatches=null},e._sortPrepareStaticBatch=function(e,t){var n=e._mainSortID-t._mainSortID;return 0===n?e.renderObj.triangleCount-t.renderObj.triangleCount:n},e}(),Q=function(){function e(t,n){if(this._id=0,this._shaderValues=null,this._shaderDefine=0,this._vertexStride=0,this._vertexElements=null,this._vertexElementsDic=null,this._id=++e._uniqueIDCounter,this._id>e.maxVertexDeclaration)throw new Error("VertexDeclaration: VertexDeclaration count should not large than ",e.maxVertexDeclaration);this._shaderValues=new P,this._vertexElementsDic={},this._vertexStride=t,this._vertexElements=n;for(var i=0;i<n.length;i++){var r=n[i],a=r.elementUsage;this._vertexElementsDic[a]=r;var s=[e._getTypeSize(r.elementFormat)/4,5126,!1,this._vertexStride,r.offset];switch(this._shaderValues.pushValue(a,s),a){case"UV":this._shaderDefine|=2097152;break;case"COLOR":this._shaderDefine|=32}}}r(e,"laya.d3.graphics.VertexDeclaration");var t=e.prototype;return t.getVertexElements=function(){return this._vertexElements.slice()},t.getVertexElementByUsage=function(e){return this._vertexElementsDic[e]},t.unBinding=function(){},a(0,t,"id",function(){return this._id}),a(0,t,"shaderDefine",function(){return this._shaderDefine}),a(0,t,"shaderValues",function(){return this._shaderValues}),a(0,t,"vertexStride",function(){return this._vertexStride}),e._getTypeSize=function(e){switch(e){case"single":return 4;case"vector2":return 8;case"vector3":return 12;case"vector4":return 16;case"volor":return 4;case"byte4":return 4;case"short2":return 4;case"short4":return 8;case"normalizedshort2":return 4;case"normalizedshort4":return 8;case"halfvector2":return 4;case"halfvector4":return 8}return 0},e.getVertexStride=function(t){for(var n=0,i=0;i<t.Length;i++){var r=t[i],a=r.offset+e._getTypeSize(r.elementFormat);a>n&&(n=a)}return n},e._maxVertexDeclarationBit=1e3,e._uniqueIDCounter=1,i(e,["maxVertexDeclaration",function(){return this.maxVertexDeclaration=2147483647-1e3*Math.floor(2147483.647)}]),e}(),Y=function(){function e(e,t,n){this.offset=0,this.elementFormat=null,this.elementUsage=null,this.offset=e,this.elementFormat=t,this.elementUsage=n}return r(e,"laya.d3.graphics.VertexElement"),e}(),Z=(function(){function e(){}return r(e,"laya.d3.graphics.VertexElementFormat"),e.Single="single",e.Vector2="vector2",e.Vector3="vector3",e.Vector4="vector4",e.Color="volor",e.Byte4="byte4",e.Short2="short2",e.Short4="short4",e.NormalizedShort2="normalizedshort2",e.NormalizedShort4="normalizedshort4",e.HalfVector2="halfvector2",e.HalfVector4="halfvector4",e}(),function(){function e(){}return r(e,"laya.d3.graphics.VertexElementUsage"),e.POSITION0="POSITION",e.COLOR0="COLOR",e.TEXTURECOORDINATE0="UV",e.NORMAL0="NORMAL",e.BINORMAL0="BINORMAL",e.TANGENT0="TANGENT0",e.BLENDINDICES0="BLENDINDICES",e.BLENDWEIGHT0="BLENDWEIGHT",e.DEPTH0="DEPTH",e.FOG0="FOG",e.POINTSIZE0="POINTSIZE",e.SAMPLE0="SAMPLE",e.TESSELLATEFACTOR0="TESSELLATEFACTOR",e.COLOR1="COLOR1",e.NEXTTEXTURECOORDINATE0="NEXTUV",e.TEXTURECOORDINATE1="UV1",e.NEXTTEXTURECOORDINATE1="NEXTUV1",e.CORNERTEXTURECOORDINATE0="CORNERTEXTURECOORDINATE",e.VELOCITY0="VELOCITY",e.STARTCOLOR0="STARTCOLOR",e.ENDCOLOR0="ENDCOLOR",e.SIZEROTATION0="SIZEROTATION",e.RADIUS0="RADIUS",e.RADIAN0="RADIAN",e.AGEADDSCALE0="AGEADDSCALE",e.TIME0="TIME",e}(),function(){function e(e,t,n){this._position=null,this._textureCoordinate0=null,this._time=NaN,this._position=e,this._textureCoordinate0=t,this._time=n}r(e,"laya.d3.graphics.VertexGlitter");var t=e.prototype;return n.imps(t,{"laya.d3.graphics.IVertex":!0}),a(0,t,"position",function(){return this._position}),a(0,t,"textureCoordinate",function(){return this._textureCoordinate0}),a(0,t,"time",function(){return this._time}),a(0,t,"vertexDeclaration",function(){return e._vertexDeclaration}),a(1,e,"vertexDeclaration",function(){return e._vertexDeclaration}),i(e,["_vertexDeclaration",function(){return this._vertexDeclaration=new Q(24,[new Y(0,"vector3","POSITION"),new Y(12,"vector2","UV"),new Y(20,"single","TIME")])}]),e}()),K=function(){function e(e,t,n,i,r,a,s,o,h,l){this._cornerTextureCoordinate=null,this._position=null,this._velocity=null,this._startColor=null,this._endColor=null,this._sizeRotation=null,this._radius=null,this._radian=null,this._ageAddScale=NaN,this._time=NaN,this._cornerTextureCoordinate=e,this._position=t,this._velocity=n,this._startColor=i,this._endColor=r,this._sizeRotation=a,this._radius=s,this._radian=o,this._ageAddScale=h,this._time=l}r(e,"laya.d3.graphics.VertexParticle");var t=e.prototype;return n.imps(t,{"laya.d3.graphics.IVertex":!0}),a(0,t,"cornerTextureCoordinate",function(){return this._cornerTextureCoordinate}),a(0,t,"velocity",function(){return this._velocity}),a(0,t,"position",function(){return this._position}),a(0,t,"radius",function(){return this._radius}),a(0,t,"startColor",function(){return this._startColor}),a(0,t,"endColor",function(){return this._endColor}),a(0,t,"radian",function(){return this._radian}),a(0,t,"sizeRotation",function(){return this._sizeRotation}),a(0,t,"ageAddScale",function(){return this._ageAddScale}),a(0,t,"time",function(){return this._time}),a(0,t,"vertexDeclaration",function(){return e._vertexDeclaration}),a(1,e,"vertexDeclaration",function(){return e._vertexDeclaration}),i(e,["_vertexDeclaration",function(){return this._vertexDeclaration=new Q(116,[new Y(0,"vector4","CORNERTEXTURECOORDINATE"),new Y(16,"vector3","POSITION"),new Y(28,"vector3","VELOCITY"),new Y(40,"vector4","STARTCOLOR"),new Y(56,"vector4","ENDCOLOR"),new Y(72,"vector3","SIZEROTATION"),new Y(84,"vector2","RADIUS"),new Y(92,"vector4","RADIAN"),new Y(108,"single","AGEADDSCALE"),new Y(112,"single","TIME")])}]),e}(),$=function(){function e(e,t,n){this._position=null,this._normal=null,this._color=null,this._position=e,this._normal=t,this._color=n}r(e,"laya.d3.graphics.VertexPositionNormalColor");var t=e.prototype;return n.imps(t,{"laya.d3.graphics.IVertex":!0}),a(0,t,"position",function(){return this._position}),a(0,t,"normal",function(){return this._normal}),a(0,t,"color",function(){return this._color}),a(0,t,"vertexDeclaration",function(){return e._vertexDeclaration}),a(1,e,"vertexDeclaration",function(){return e._vertexDeclaration}),i(e,["_vertexDeclaration",function(){return this._vertexDeclaration=new Q(40,[new Y(0,"vector3","POSITION"),new Y(12,"vector3","NORMAL"),new Y(24,"vector4","COLOR")])}]),e}(),J=function(){function e(e,t,n,i,r){this._position=null,this._normal=null,this._color=null,this._blendIndex=null,this._blendWeight=null,this._position=e,this._normal=t,this._color=n,this._blendIndex=i,this._blendWeight=r}r(e,"laya.d3.graphics.VertexPositionNormalColorSkin");var t=e.prototype;return n.imps(t,{"laya.d3.graphics.IVertex":!0}),a(0,t,"position",function(){return this._position}),a(0,t,"blendIndex",function(){return this._blendIndex}),a(0,t,"normal",function(){return this._normal}),a(0,t,"color",function(){return this._color}),a(0,t,"blendWeight",function(){return this._blendWeight}),a(0,t,"vertexDeclaration",function(){return e._vertexDeclaration}),a(1,e,"vertexDeclaration",function(){return e._vertexDeclaration}),i(e,["_vertexDeclaration",function(){return this._vertexDeclaration=new Q(72,[new Y(0,"vector3","POSITION"),new Y(12,"vector3","NORMAL"),new Y(24,"vector4","COLOR"),new Y(40,"vector4","BLENDWEIGHT"),new Y(56,"vector4","BLENDINDICES")])}]),e}(),ee=function(){function e(e,t,n,i,r,a){this._position=null,this._normal=null,this._color=null,this._blendIndex=null,this._blendWeight=null,this._tangent=null,this._position=e,this._normal=t,this._color=n,this._tangent=i,this._blendIndex=r,this._blendWeight=a}r(e,"laya.d3.graphics.VertexPositionNormalColorSkinTangent");var t=e.prototype;return n.imps(t,{"laya.d3.graphics.IVertex":!0}),a(0,t,"position",function(){return this._position}),a(0,t,"blendIndex",function(){return this._blendIndex}),a(0,t,"normal",function(){return this._normal}),a(0,t,"color",function(){return this._color}),a(0,t,"tangent",function(){return this._tangent}),a(0,t,"blendWeight",function(){return this._blendWeight}),a(0,t,"vertexDeclaration",function(){return e._vertexDeclaration}),a(1,e,"vertexDeclaration",function(){return e._vertexDeclaration}),i(e,["_vertexDeclaration",function(){return this._vertexDeclaration=new Q(84,[new Y(0,"vector3","POSITION"),new Y(12,"vector3","NORMAL"),new Y(24,"vector4","COLOR"),new Y(40,"vector4","BLENDWEIGHT"),new Y(56,"vector4","BLENDINDICES"),new Y(72,"vector3","TANGENT0")])}]),e}(),te=function(){function e(e,t,n,i){this._position=null,this._normal=null,this._color=null,this._tangent=null,this._position=e,this._normal=t,this._color=n,this._tangent=i}r(e,"laya.d3.graphics.VertexPositionNormalColorTangent");var t=e.prototype;return n.imps(t,{"laya.d3.graphics.IVertex":!0}),a(0,t,"position",function(){return this._position}),a(0,t,"normal",function(){return this._normal}),a(0,t,"color",function(){return this._color}),a(0,t,"tangent",function(){return this._tangent}),a(0,t,"vertexDeclaration",function(){return e._vertexDeclaration}),a(1,e,"vertexDeclaration",function(){return e._vertexDeclaration}),i(e,["_vertexDeclaration",function(){return this._vertexDeclaration=new Q(52,[new Y(0,"vector3","POSITION"),new Y(12,"vector3","NORMAL"),new Y(24,"vector4","COLOR"),new Y(40,"vector3","TANGENT0")])}]),e}(),ne=function(){function e(e,t,n,i){this._position=null,this._normal=null,this._color=null,this._textureCoordinate=null,this._position=e,this._normal=t,this._color=n,this._textureCoordinate=i}r(e,"laya.d3.graphics.VertexPositionNormalColorTexture");var t=e.prototype;return n.imps(t,{"laya.d3.graphics.IVertex":!0}),a(0,t,"position",function(){return this._position}),a(0,t,"normal",function(){return this._normal}),a(0,t,"color",function(){return this._color}),a(0,t,"textureCoordinate",function(){return this._textureCoordinate}),a(0,t,"vertexDeclaration",function(){return e._vertexDeclaration}),a(1,e,"vertexDeclaration",function(){return e._vertexDeclaration}),i(e,["_vertexDeclaration",function(){return this._vertexDeclaration=new Q(48,[new Y(0,"vector3","POSITION"),new Y(12,"vector3","NORMAL"),new Y(24,"vector4","COLOR"),new Y(40,"vector2","UV")])}]),e}(),ie=function(){function e(e,t,n,i,r){this._position=null,this._normal=null,this._color=null,this._textureCoordinate0=null,this._textureCoordinate1=null,this._position=e,this._normal=t,this._color=n,this._textureCoordinate0=i,this._textureCoordinate1=r}r(e,"laya.d3.graphics.VertexPositionNormalColorTexture0Texture1");var t=e.prototype;return n.imps(t,{"laya.d3.graphics.IVertex":!0}),a(0,t,"position",function(){return this._position}),a(0,t,"normal",function(){return this._normal}),a(0,t,"textureCoordinate0",function(){return this._textureCoordinate0}),a(0,t,"color",function(){return this._color}),a(0,t,"textureCoordinate1",function(){return this._textureCoordinate1}),a(0,t,"vertexDeclaration",function(){return e._vertexDeclaration}),a(1,e,"vertexDeclaration",function(){return e._vertexDeclaration}),i(e,["_vertexDeclaration",function(){return this._vertexDeclaration=new Q(56,[new Y(0,"vector3","POSITION"),new Y(12,"vector3","NORMAL"),new Y(24,"vector4","COLOR"),new Y(40,"vector2","UV"),new Y(48,"vector2","UV1")])}]),e}(),re=function(){function e(e,t,n,i,r,a,s){this._position=null,this._normal=null,this._color=null,this._textureCoordinate0=null,this._textureCoordinate1=null,this._blendIndex=null,this._blendWeight=null,this._position=e,this._normal=t,this._color=n,this._textureCoordinate0=i,this._textureCoordinate1=r,this._blendIndex=a,this._blendWeight=s}r(e,"laya.d3.graphics.VertexPositionNormalColorTexture0Texture1Skin");var t=e.prototype;return n.imps(t,{"laya.d3.graphics.IVertex":!0}),a(0,t,"position",function(){return this._position}),a(0,t,"blendIndex",function(){return this._blendIndex}),a(0,t,"normal",function(){return this._normal}),a(0,t,"textureCoordinate0",function(){return this._textureCoordinate0}),a(0,t,"color",function(){return this._color}),a(0,t,"blendWeight",function(){return this._blendWeight}),a(0,t,"textureCoordinate1",function(){return this._textureCoordinate1}),a(0,t,"vertexDeclaration",function(){return e._vertexDeclaration}),a(1,e,"vertexDeclaration",function(){return e._vertexDeclaration}),i(e,["_vertexDeclaration",function(){return this._vertexDeclaration=new Q(88,[new Y(0,"vector3","POSITION"),new Y(12,"vector3","NORMAL"),new Y(24,"vector4","COLOR"),new Y(40,"vector2","UV"),new Y(48,"vector2","UV1"),new Y(56,"vector4","BLENDWEIGHT"),new Y(72,"vector4","BLENDINDICES")])}]),e}(),ae=(function(){function e(){this._position=null,this._normal=null,this._color=null,this._textureCoordinate0=null,this._textureCoordinate1=null,this._blendIndex=null,this._blendWeight=null,this._tangent=null}r(e,"laya.d3.graphics.VertexPositionNormalColorTexture0Texture1SkinTangent");var t=e.prototype;return n.imps(t,{"laya.d3.graphics.IVertex":!0}),t.VertexPositionNormalColorTexture0SkinTangent=function(e,t,n,i,r,a,s,o){this._position=e,this._normal=t,this._color=n,this._textureCoordinate0=i,this._textureCoordinate1=r,this._tangent=a,this._blendIndex=s,this._blendWeight=o},a(0,t,"position",function(){return this._position}),a(0,t,"blendIndex",function(){return this._blendIndex}),a(0,t,"normal",function(){return this._normal}),a(0,t,"textureCoordinate0",function(){return this._textureCoordinate0}),a(0,t,"color",function(){return this._color}),a(0,t,"tangent",function(){return this._tangent}),a(0,t,"blendWeight",function(){return this._blendWeight}),a(0,t,"textureCoordinate1",function(){return this._textureCoordinate1}),a(0,t,"vertexDeclaration",function(){return e._vertexDeclaration}),a(1,e,"vertexDeclaration",function(){return e._vertexDeclaration}),i(e,["_vertexDeclaration",function(){return this._vertexDeclaration=new Q(100,[new Y(0,"vector3","POSITION"),new Y(12,"vector3","NORMAL"),new Y(24,"vector4","COLOR"),new Y(40,"vector2","UV"),new Y(48,"vector2","UV1"),new Y(56,"vector4","BLENDWEIGHT"),new Y(72,"vector4","BLENDINDICES"),new Y(88,"vector3","TANGENT0")])}]),e}(),function(){function e(){this._position=null,this._normal=null,this._color=null,this._textureCoordinate0=null,this._textureCoordinate1=null,this._tangent=null}r(e,"laya.d3.graphics.VertexPositionNormalColorTexture0Texture1Tangent");var t=e.prototype;return n.imps(t,{"laya.d3.graphics.IVertex":!0}),t.VertexPositionNormalColorTexture0Tangent=function(e,t,n,i,r,a){this._position=e,this._normal=t,this._color=n,this._textureCoordinate0=i,this._textureCoordinate1=r,this._tangent=a},a(0,t,"position",function(){return this._position}),a(0,t,"normal",function(){return this._normal}),a(0,t,"textureCoordinate0",function(){return this._textureCoordinate0}),a(0,t,"color",function(){return this._color}),a(0,t,"tangent",function(){return this._tangent}),a(0,t,"textureCoordinate1",function(){return this._textureCoordinate1}),a(0,t,"vertexDeclaration",function(){return e._vertexDeclaration}),a(1,e,"vertexDeclaration",function(){return e._vertexDeclaration}),i(e,["_vertexDeclaration",function(){return this._vertexDeclaration=new Q(68,[new Y(0,"vector3","POSITION"),new Y(12,"vector3","NORMAL"),new Y(24,"vector4","COLOR"),new Y(40,"vector2","UV"),new Y(48,"vector2","UV1"),new Y(56,"vector3","TANGENT0")])}]),e}(),function(){function e(e,t,n,i,r,a){this._position=null,this._normal=null,this._color=null,this._textureCoordinate=null,this._blendIndex=null,this._blendWeight=null,this._position=e,this._normal=t,this._color=n,this._textureCoordinate=i,this._blendIndex=r,this._blendWeight=a}r(e,"laya.d3.graphics.VertexPositionNormalColorTextureSkin");var t=e.prototype;return n.imps(t,{"laya.d3.graphics.IVertex":!0}),a(0,t,"position",function(){return this._position}),a(0,t,"blendIndex",function(){return this._blendIndex}),a(0,t,"normal",function(){return this._normal}),a(0,t,"color",function(){return this._color}),a(0,t,"blendWeight",function(){return this._blendWeight}),a(0,t,"textureCoordinate",function(){return this._textureCoordinate}),a(0,t,"vertexDeclaration",function(){return e._vertexDeclaration}),a(1,e,"vertexDeclaration",function(){return e._vertexDeclaration}),i(e,["_vertexDeclaration",function(){return this._vertexDeclaration=new Q(80,[new Y(0,"vector3","POSITION"),new Y(12,"vector3","NORMAL"),new Y(24,"vector4","COLOR"),new Y(40,"vector2","UV"),new Y(48,"vector4","BLENDWEIGHT"),new Y(64,"vector4","BLENDINDICES")])}]),e}()),se=function(){function e(e,t,n,i,r,a,s){this._position=null,this._normal=null,this._color=null,this._textureCoordinate=null,this._blendIndex=null,this._blendWeight=null,this._tangent=null,this._position=e,this._normal=t,this._color=n,this._textureCoordinate=i,this._tangent=r,this._blendIndex=a,this._blendWeight=s}r(e,"laya.d3.graphics.VertexPositionNormalColorTextureSkinTangent");var t=e.prototype;return n.imps(t,{"laya.d3.graphics.IVertex":!0}),a(0,t,"position",function(){return this._position}),a(0,t,"blendIndex",function(){return this._blendIndex}),a(0,t,"normal",function(){return this._normal}),a(0,t,"color",function(){return this._color}),a(0,t,"tangent",function(){return this._tangent}),a(0,t,"blendWeight",function(){return this._blendWeight}),a(0,t,"textureCoordinate",function(){return this._textureCoordinate}),a(0,t,"vertexDeclaration",function(){return e._vertexDeclaration}),a(1,e,"vertexDeclaration",function(){return e._vertexDeclaration}),i(e,["_vertexDeclaration",function(){return this._vertexDeclaration=new Q(92,[new Y(0,"vector3","POSITION"),new Y(12,"vector3","NORMAL"),new Y(24,"vector4","COLOR"),new Y(40,"vector2","UV"),new Y(48,"vector4","BLENDWEIGHT"),new Y(64,"vector4","BLENDINDICES"),new Y(80,"vector3","TANGENT0")])}]),e}(),oe=function(){function e(e,t,n,i,r){this._position=null,this._normal=null,this._color=null,this._textureCoordinate=null,this._tangent=null,this._position=e,this._normal=t,this._color=n,this._textureCoordinate=i,this._tangent=r}r(e,"laya.d3.graphics.VertexPositionNormalColorTextureTangent");var t=e.prototype;return n.imps(t,{"laya.d3.graphics.IVertex":!0}),a(0,t,"position",function(){return this._position}),a(0,t,"normal",function(){return this._normal}),a(0,t,"color",function(){return this._color}),a(0,t,"tangent",function(){return this._tangent}),a(0,t,"textureCoordinate",function(){return this._textureCoordinate}),a(0,t,"vertexDeclaration",function(){return e._vertexDeclaration}),a(1,e,"vertexDeclaration",function(){return e._vertexDeclaration}),i(e,["_vertexDeclaration",function(){return this._vertexDeclaration=new Q(60,[new Y(0,"vector3","POSITION"),new Y(12,"vector3","NORMAL"),new Y(24,"vector4","COLOR"),new Y(40,"vector2","UV"),new Y(48,"vector3","TANGENT0")])}]),e}(),he=function(){function e(e,t,n){this._position=null,this._normal=null,this._textureCoordinate=null,this._position=e,this._normal=t,this._textureCoordinate=n}r(e,"laya.d3.graphics.VertexPositionNormalTexture");var t=e.prototype;return n.imps(t,{"laya.d3.graphics.IVertex":!0}),a(0,t,"position",function(){return this._position}),a(0,t,"normal",function(){return this._normal}),a(0,t,"textureCoordinate",function(){return this._textureCoordinate}),a(0,t,"vertexDeclaration",function(){return e._vertexDeclaration}),a(1,e,"vertexDeclaration",function(){return e._vertexDeclaration}),i(e,["_vertexDeclaration",function(){return this._vertexDeclaration=new Q(32,[new Y(0,"vector3","POSITION"),new Y(12,"vector3","NORMAL"),new Y(24,"vector2","UV")])}]),e}(),le=function(){function e(e,t,n,i){this._position=null,this._normal=null,this._textureCoordinate0=null,this._textureCoordinate1=null,this._position=e,this._normal=t,this._textureCoordinate0=n,this._textureCoordinate1=i}r(e,"laya.d3.graphics.VertexPositionNormalTexture0Texture1");var t=e.prototype;return n.imps(t,{"laya.d3.graphics.IVertex":!0}),a(0,t,"position",function(){return this._position}),a(0,t,"normal",function(){return this._normal}),a(0,t,"textureCoordinate0",function(){return this._textureCoordinate0}),a(0,t,"textureCoordinate1",function(){return this._textureCoordinate1}),a(0,t,"vertexDeclaration",function(){return e._vertexDeclaration}),a(1,e,"vertexDeclaration",function(){return e._vertexDeclaration}),i(e,["_vertexDeclaration",function(){return this._vertexDeclaration=new Q(40,[new Y(0,"vector3","POSITION"),new Y(12,"vector3","NORMAL"),new Y(24,"vector2","UV"),new Y(32,"vector2","UV1")])}]),e}(),ue=function(){function e(e,t,n,i,r,a){this._position=null,this._normal=null,this._textureCoordinate0=null,this._textureCoordinate1=null,this._blendIndex=null,this._blendWeight=null,this._position=e,this._normal=t,this._textureCoordinate0=n,this._textureCoordinate1=i,this._blendIndex=r,this._blendWeight=a}r(e,"laya.d3.graphics.VertexPositionNormalTexture0Texture1Skin");var t=e.prototype;return n.imps(t,{"laya.d3.graphics.IVertex":!0}),a(0,t,"position",function(){return this._position}),a(0,t,"blendIndex",function(){return this._blendIndex}),a(0,t,"normal",function(){return this._normal}),a(0,t,"textureCoordinate0",function(){return this._textureCoordinate0}),a(0,t,"blendWeight",function(){return this._blendWeight}),a(0,t,"textureCoordinate1",function(){return this._textureCoordinate1}),a(0,t,"vertexDeclaration",function(){return e._vertexDeclaration}),a(1,e,"vertexDeclaration",function(){return e._vertexDeclaration}),i(e,["_vertexDeclaration",function(){return this._vertexDeclaration=new Q(72,[new Y(0,"vector3","POSITION"),new Y(12,"vector3","NORMAL"),new Y(24,"vector2","UV"),new Y(32,"vector2","UV1"),new Y(40,"vector4","BLENDWEIGHT"),new Y(56,"vector4","BLENDINDICES")])}]),e}(),_e=(function(){function e(){this._position=null,this._normal=null,this._textureCoordinate0=null,this._textureCoordinate1=null,this._blendIndex=null,this._blendWeight=null,this._tangent=null}r(e,"laya.d3.graphics.VertexPositionNormalTexture0Texture1SkinTangent");var t=e.prototype;return n.imps(t,{"laya.d3.graphics.IVertex":!0}),t.VertexPositionNormalTexture0SkinTangent=function(e,t,n,i,r,a,s){this._position=e,this._normal=t,this._textureCoordinate0=n,this._textureCoordinate1=i,this._tangent=r,this._blendIndex=a,this._blendWeight=s},a(0,t,"position",function(){return this._position}),a(0,t,"blendIndex",function(){return this._blendIndex}),a(0,t,"normal",function(){return this._normal}),a(0,t,"textureCoordinate0",function(){return this._textureCoordinate0}),a(0,t,"blendWeight",function(){return this._blendWeight}),a(0,t,"textureCoordinate1",function(){return this._textureCoordinate1}),a(0,t,"tangent",function(){return this._tangent}),a(0,t,"vertexDeclaration",function(){return e._vertexDeclaration}),a(1,e,"vertexDeclaration",function(){return e._vertexDeclaration}),i(e,["_vertexDeclaration",function(){return this._vertexDeclaration=new Q(84,[new Y(0,"vector3","POSITION"),new Y(12,"vector3","NORMAL"),new Y(24,"vector2","UV"),new Y(32,"vector2","UV1"),new Y(40,"vector4","BLENDWEIGHT"),new Y(56,"vector4","BLENDINDICES"),new Y(72,"vector3","TANGENT0")])}]),e}(),function(){function e(){this._position=null,this._normal=null,this._textureCoordinate0=null,this._textureCoordinate1=null,this._tangent=null}r(e,"laya.d3.graphics.VertexPositionNormalTexture0Texture1Tangent");var t=e.prototype;return n.imps(t,{"laya.d3.graphics.IVertex":!0}),t.VertexPositionNormalTexture0Tangent=function(e,t,n,i,r){this._position=e,this._normal=t,this._textureCoordinate0=n,this._textureCoordinate1=i,this._tangent=r},a(0,t,"position",function(){return this._position}),a(0,t,"normal",function(){return this._normal}),a(0,t,"textureCoordinate0",function(){return this._textureCoordinate0}),a(0,t,"textureCoordinate1",function(){return this._textureCoordinate1}),a(0,t,"tangent",function(){return this._tangent}),a(0,t,"vertexDeclaration",function(){return e._vertexDeclaration}),a(1,e,"vertexDeclaration",function(){return e._vertexDeclaration}),i(e,["_vertexDeclaration",function(){return this._vertexDeclaration=new Q(52,[new Y(0,"vector3","POSITION"),new Y(12,"vector3","NORMAL"),new Y(24,"vector2","UV"),new Y(32,"vector2","UV1"),new Y(40,"vector3","TANGENT0")])}]),e}(),function(){function e(e,t,n,i,r){this._position=null,this._normal=null,this._textureCoordinate=null,this._blendIndex=null,this._blendWeight=null,this._position=e,this._normal=t,
this._textureCoordinate=n,this._blendIndex=i,this._blendWeight=r}r(e,"laya.d3.graphics.VertexPositionNormalTextureSkin");var t=e.prototype;return n.imps(t,{"laya.d3.graphics.IVertex":!0}),a(0,t,"position",function(){return this._position}),a(0,t,"blendIndex",function(){return this._blendIndex}),a(0,t,"normal",function(){return this._normal}),a(0,t,"blendWeight",function(){return this._blendWeight}),a(0,t,"textureCoordinate",function(){return this._textureCoordinate}),a(0,t,"vertexDeclaration",function(){return e._vertexDeclaration}),a(1,e,"vertexDeclaration",function(){return e._vertexDeclaration}),i(e,["_vertexDeclaration",function(){return this._vertexDeclaration=new Q(64,[new Y(0,"vector3","POSITION"),new Y(12,"vector3","NORMAL"),new Y(24,"vector2","UV"),new Y(32,"vector4","BLENDWEIGHT"),new Y(48,"vector4","BLENDINDICES")])}]),e}()),ce=function(){function e(e,t,n,i,r,a){this._position=null,this._normal=null,this._textureCoordinate=null,this._blendIndex=null,this._blendWeight=null,this._tangent=null,this._position=e,this._normal=t,this._textureCoordinate=n,this._tangent=i,this._blendIndex=r,this._blendWeight=a}r(e,"laya.d3.graphics.VertexPositionNormalTextureSkinTangent");var t=e.prototype;return n.imps(t,{"laya.d3.graphics.IVertex":!0}),a(0,t,"position",function(){return this._position}),a(0,t,"blendIndex",function(){return this._blendIndex}),a(0,t,"normal",function(){return this._normal}),a(0,t,"blendWeight",function(){return this._blendWeight}),a(0,t,"textureCoordinate",function(){return this._textureCoordinate}),a(0,t,"tangent",function(){return this._tangent}),a(0,t,"vertexDeclaration",function(){return e._vertexDeclaration}),a(1,e,"vertexDeclaration",function(){return e._vertexDeclaration}),i(e,["_vertexDeclaration",function(){return this._vertexDeclaration=new Q(76,[new Y(0,"vector3","POSITION"),new Y(12,"vector3","NORMAL"),new Y(24,"vector2","UV"),new Y(32,"vector4","BLENDWEIGHT"),new Y(48,"vector4","BLENDINDICES"),new Y(64,"vector3","TANGENT0")])}]),e}(),de=function(){function e(e,t,n,i){this._position=null,this._normal=null,this._textureCoordinate=null,this._tangent=null,this._position=e,this._normal=t,this._textureCoordinate=n,this._tangent=i}r(e,"laya.d3.graphics.VertexPositionNormalTextureTangent");var t=e.prototype;return n.imps(t,{"laya.d3.graphics.IVertex":!0}),a(0,t,"position",function(){return this._position}),a(0,t,"normal",function(){return this._normal}),a(0,t,"textureCoordinate",function(){return this._textureCoordinate}),a(0,t,"tangent",function(){return this._tangent}),a(0,t,"vertexDeclaration",function(){return e._vertexDeclaration}),a(1,e,"vertexDeclaration",function(){return e._vertexDeclaration}),i(e,["_vertexDeclaration",function(){return this._vertexDeclaration=new Q(44,[new Y(0,"vector3","POSITION"),new Y(12,"vector3","NORMAL"),new Y(24,"vector2","UV"),new Y(32,"vector3","TANGENT0")])}]),e}(),fe=function(){function e(e,t,n,i){this._version=null,this._strings=["BLOCK","DATA","STRINGS"],this._materials=null,this._fileData=null,this._readData=null,this._mesh=null,this._BLOCK={count:0},this._DATA={offset:0,size:0},this._STRINGS={offset:0,size:0},this._shaderAttributes=null,this._mesh=t,this._materials=n,this._onLoaded(e,i)}r(e,"laya.d3.loaders.LoadModel");var t=e.prototype;return t._onLoaded=function(e,t){var n=A.basePath;A.basePath=A.getPath(A.formatURL(t)),this._fileData=e,this._readData=new u(this._fileData),this._readData.pos=0,this._version=this._readData.readUTFString(),this.READ_BLOCK();for(var i=0;i<this._BLOCK.count;i++){var r=this._readData.getUint16(),a=this._strings[r],s=this["READ_"+a];if(null==s)throw new Error("model file err,no this function:"+r+" "+a);if(!s.call(this))break}return A.basePath=n,this._mesh},t.onError=function(){},t._readString=function(){return this._strings[this._readData.getUint16()]},t.READ_BLOCK=function(){this._readData.getUint16();return this._BLOCK.count=this._readData.getUint16(),!0},t.READ_DATA=function(){return this._DATA.offset=this._readData.getUint32(),this._DATA.size=this._readData.getUint32(),!0},t.READ_STRINGS=function(){this._STRINGS.offset=this._readData.getUint16(),this._STRINGS.size=this._readData.getUint16();var e=this._readData.pos;this._readData.pos=this._STRINGS.offset+this._DATA.offset;for(var t=0;t<this._STRINGS.size;t++)this._strings[t]=this._readData.readUTFString();return this._readData.pos=e,!0},t.READ_MATERIAL=function(){var e=this._readData.getUint16(),t=this._readString(),n=this._readString();if("null"!==n){n=A.formatURL(n);var i=E.materialCache[n];i?this._materials[e]=i:(i=this._materials[e]=E.materialCache[n]=new Ye,i.setShaderName(t),Ne.createFromFile(n,i))}else this._materials[e]=new Ne;return!0},t.READ_MESH=function(){this._readString();switch(this._version){case"LAYAMODEL:01":console.log("Warning: The (.lm) file is converted by old fbxTools,please reConverted it use  lastest fbxTools version,later we will remove the  support of old version (.lm) support.");break;case"LAYASKINANI:01":var e=this._readData.__getBuffer(),t=0,n=0,i=this._readData.getUint32(),r=this._readData.getUint32(),a=new Float32Array(e.slice(i+this._DATA.offset,i+this._DATA.offset+r));for(this.mesh._bindPoses=[],t=0,n=a.length;n>t;t+=16){var s=new Te(a[t+0],a[t+1],a[t+2],a[t+3],a[t+4],a[t+5],a[t+6],a[t+7],a[t+8],a[t+9],a[t+10],a[t+11],a[t+12],a[t+13],a[t+14],a[t+15]);this.mesh._bindPoses.push(s)}var o=this._readData.getUint32(),h=this._readData.getUint32(),l=new Float32Array(e.slice(o+this._DATA.offset,o+this._DATA.offset+h));for(this.mesh._inverseBindPoses=[],t=0,n=l.length;n>t;t+=16){var u=new Te(l[t+0],l[t+1],l[t+2],l[t+3],l[t+4],l[t+5],l[t+6],l[t+7],l[t+8],l[t+9],l[t+10],l[t+11],l[t+12],l[t+13],l[t+14],l[t+15]);this.mesh._inverseBindPoses.push(u)}break;default:throw new Error("LoadModel:unknown version.")}return!0},t.READ_SUBMESH=function(){var t=(this._readString(),this._readData.getUint8(),this._readString());this._shaderAttributes=t.match(e._attrReg);var n=this._readData.getUint32(),i=this._readData.getUint32(),r=(this._readData.getUint32(),this._readData.getUint32(),this._readData.getUint32()),a=this._readData.getUint32(),s=this._readData.getUint32(),o=this._readData.getUint32(),h=this._readData.__getBuffer(),l=new we,u=this._getVertexDeclaration(),_=it.create(u,a/u.vertexStride,35044,!0),c=r+this._DATA.offset,d=h.slice(c,c+a);_.setData(new Float32Array(d)),l._vertexBuffer=_;for(var f=_.vertexDeclaration.getVertexElements(),m=0;m<f.length;m++)l._bufferUsage[f[m].elementUsage]=_;var p=nt.create("ushort",i/2,35044,!0),v=n+this._DATA.offset,g=h.slice(v,v+i);p.setData(new Uint16Array(g)),l._indexBuffer=p;var x=h.slice(s+this._DATA.offset,s+this._DATA.offset+o);return l._boneIndices=new Uint8Array(x),this._mesh._add(l),!0},t.READ_DATAAREA=function(){return!1},t._getVertexDeclaration=function(){for(var e=!1,t=!1,n=!1,i=!1,r=!1,a=!1,s=!1,o=0;o<this._shaderAttributes.length;o+=8)switch(this._shaderAttributes[o]){case"POSITION":e=!0;break;case"NORMAL":t=!0;break;case"COLOR":n=!0;break;case"UV":i=!0;break;case"UV1":r=!0;break;case"BLENDWEIGHT":a=!0;break;case"BLENDINDICES":s=!0}var h;return e&&t&&n&&i&&r&&a&&s?h=re.vertexDeclaration:e&&t&&i&&r&&a&&s?h=ue.vertexDeclaration:e&&t&&n&&i&&a&&s?h=ae.vertexDeclaration:e&&t&&i&&a&&s?h=_e.vertexDeclaration:e&&t&&n&&a&&s?h=J.vertexDeclaration:e&&t&&n&&i&&r?h=ie.vertexDeclaration:e&&t&&i&&r?h=le.vertexDeclaration:e&&t&&n&&i?h=ne.vertexDeclaration:e&&t&&i?h=he.vertexDeclaration:e&&t&&n&&(h=$.vertexDeclaration),h},a(0,t,"mesh",function(){return this._mesh}),e._attrReg=new RegExp("(\\w+)|([:,;])","g"),e}(),me=function(){function e(e,t){this.min=null,this.max=null,this.min=e,this.max=t}r(e,"laya.d3.math.BoundBox");var t=e.prototype;return t.getCorners=function(e){e.length=8;var t=this.min.elements,n=this.max.elements,i=t[0],r=t[1],a=t[2],s=n[0],o=n[1],h=n[2];e[0]=new De(i,o,h),e[1]=new De(s,o,h),e[2]=new De(s,r,h),e[3]=new De(i,r,h),e[4]=new De(i,o,a),e[5]=new De(s,o,a),e[6]=new De(s,r,a),e[7]=new De(i,r,a)},t.toDefault=function(){this.min.toDefault(),this.max.toDefault()},e.createfromPoints=function(e,t){if(null==e)throw new Error("points");for(var n=new De(Number.MAX_VALUE),i=new De(-Number.MAX_VALUE),r=0;r<e.length;++r)De.min(n,e[r],n),De.max(i,e[r],i);t.min=n,t.max=i},e}(),pe=function(){function e(t){this._matrix=null,this._near=null,this._far=null,this._left=null,this._right=null,this._top=null,this._bottom=null,this._matrix=t,this._near=new Ce(new De),this._far=new Ce(new De),this._left=new Ce(new De),this._right=new Ce(new De),this._top=new Ce(new De),this._bottom=new Ce(new De),e._getPlanesFromMatrix(this._matrix,this._near,this._far,this._left,this._right,this._top,this._bottom)}r(e,"laya.d3.math.BoundFrustum");var t=e.prototype;return t.equalsBoundFrustum=function(e){return this._matrix.equalsOtherMatrix(e.matrix)},t.equalsObj=function(e){if(e instanceof laya.d3.math.BoundFrustum){var t=e;return this.equalsBoundFrustum(t)}return!1},t.getPlane=function(e){switch(e){case 0:return this._near;case 1:return this._far;case 2:return this._left;case 3:return this._right;case 4:return this._top;case 5:return this._bottom;default:return null}},t.getCorners=function(t){t[0]=e.get3PlaneInterPoint(this._near,this._bottom,this._right),t[1]=e.get3PlaneInterPoint(this._near,this._top,this._right),t[2]=e.get3PlaneInterPoint(this._near,this._top,this._left),t[3]=e.get3PlaneInterPoint(this._near,this._bottom,this._left),t[4]=e.get3PlaneInterPoint(this._far,this._bottom,this._right),t[5]=e.get3PlaneInterPoint(this._far,this._top,this._right),t[6]=e.get3PlaneInterPoint(this._far,this._top,this._left),t[7]=e.get3PlaneInterPoint(this._far,this._bottom,this._left)},t.ContainsPoint=function(e){for(var t=Ce.PlaneIntersectionType_Front,n=Ce.PlaneIntersectionType_Front,i=0;6>i;i++){switch(i){case 0:n=ge.intersectsPlaneAndPoint(this._near,e);break;case 1:n=ge.intersectsPlaneAndPoint(this._far,e);break;case 2:n=ge.intersectsPlaneAndPoint(this._left,e);break;case 3:n=ge.intersectsPlaneAndPoint(this._right,e);break;case 4:n=ge.intersectsPlaneAndPoint(this._top,e);break;case 5:n=ge.intersectsPlaneAndPoint(this._bottom,e)}switch(n){case Ce.PlaneIntersectionType_Back:return 0;case Ce.PlaneIntersectionType_Intersecting:t=Ce.PlaneIntersectionType_Intersecting}}switch(t){case Ce.PlaneIntersectionType_Intersecting:return 2;default:return 1}},t.ContainsBoundBox=function(t){for(var n,i=1,r=0;6>r;r++){if(n=this.getPlane(r),this._getBoxToPlanePVertexNVertex(t,n.normal,e._tempV30,e._tempV31),ge.intersectsPlaneAndPoint(n,e._tempV30)==Ce.PlaneIntersectionType_Back)return 0;ge.intersectsPlaneAndPoint(n,e._tempV31)==Ce.PlaneIntersectionType_Back&&(i=2)}return i},t.ContainsBoundSphere=function(e){for(var t=Ce.PlaneIntersectionType_Front,n=Ce.PlaneIntersectionType_Front,i=0;6>i;i++){switch(i){case 0:n=ge.intersectsPlaneAndSphere(this._near,e);break;case 1:n=ge.intersectsPlaneAndSphere(this._far,e);break;case 2:n=ge.intersectsPlaneAndSphere(this._left,e);break;case 3:n=ge.intersectsPlaneAndSphere(this._right,e);break;case 4:n=ge.intersectsPlaneAndSphere(this._top,e);break;case 5:n=ge.intersectsPlaneAndSphere(this._bottom,e)}switch(n){case Ce.PlaneIntersectionType_Back:return 0;case Ce.PlaneIntersectionType_Intersecting:t=Ce.PlaneIntersectionType_Intersecting}}switch(t){case Ce.PlaneIntersectionType_Intersecting:return 2;default:return 1}},t._getBoxToPlanePVertexNVertex=function(e,t,n,i){var r=e.min,a=r.elements,s=e.max,o=s.elements,h=t.elements,l=h[0],u=h[1],_=h[2];n=r;var c=n.elements;l>=0&&(c[0]=o[0]),u>=0&&(c[1]=o[1]),_>=0&&(c[2]=o[2]),i=s;var d=i.elements;l>=0&&(d[0]=a[0]),u>=0&&(d[1]=a[1]),_>=0&&(d[2]=a[2])},a(0,t,"bottom",function(){return this._bottom}),a(0,t,"matrix",function(){return this._matrix},function(t){this._matrix=t,e._getPlanesFromMatrix(this._matrix,this._near,this._far,this._left,this._right,this._top,this._bottom)}),a(0,t,"top",function(){return this._top}),a(0,t,"near",function(){return this._near}),a(0,t,"far",function(){return this._far}),a(0,t,"left",function(){return this._left}),a(0,t,"right",function(){return this._right}),e._getPlanesFromMatrix=function(e,t,n,i,r,a,s){var o=e.elements,h=o[0],l=o[1],u=o[2],_=o[3],c=o[4],d=o[5],f=o[6],m=o[7],p=o[8],v=o[9],g=o[10],x=o[11],T=o[12],C=o[13],b=o[14],I=o[15],E=t.normal.elements;E[0]=u,E[1]=f,E[2]=g,t.distance=b,t.normalize();var D=n.normal.elements;D[0]=_-u,D[1]=m-f,D[2]=x-g,n.distance=I-b,n.normalize();var M=i.normal.elements;M[0]=_+h,M[1]=m+c,M[2]=x+p,i.distance=I+T,i.normalize();var y=r.normal.elements;y[0]=_-h,y[1]=m-c,y[2]=x-p,r.distance=I-T,r.normalize();var w=a.normal.elements;w[0]=_-l,w[1]=m-d,w[2]=x-v,a.distance=I-C,a.normalize();var V=s.normal.elements;V[0]=_+l,V[1]=m+d,V[2]=x+v,s.distance=I+C,s.normalize()},e.get3PlaneInterPoint=function(t,n,i){var r=t.normal,a=n.normal,s=i.normal;De.cross(a,s,e._tempV30),De.cross(s,r,e._tempV31),De.cross(r,a,e._tempV32);var o=De.dot(r,e._tempV30),h=De.dot(a,e._tempV31),l=De.dot(s,e._tempV32);De.scale(e._tempV30,-t.distance/o,e._tempV33),De.scale(e._tempV31,-n.distance/h,e._tempV34),De.scale(e._tempV32,-i.distance/l,e._tempV35),De.add(e._tempV33,e._tempV34,e._tempV36),De.add(e._tempV35,e._tempV36,e._tempV37);var u=e._tempV37;return u},i(e,["_tempV30",function(){return this._tempV30=new De},"_tempV31",function(){return this._tempV31=new De},"_tempV32",function(){return this._tempV32=new De},"_tempV33",function(){return this._tempV33=new De},"_tempV34",function(){return this._tempV34=new De},"_tempV35",function(){return this._tempV35=new De},"_tempV36",function(){return this._tempV36=new De},"_tempV37",function(){return this._tempV37=new De}]),e}(),ve=function(){function e(e,t){this.center=null,this.radius=NaN,this.center=e,this.radius=t}r(e,"laya.d3.math.BoundSphere");var t=e.prototype;return t.toDefault=function(){this.center.toDefault(),this.radius=0},e.createFromSubPoints=function(t,n,i,r){if(null==t)throw new Error("points");if(0>n||n>=t.length)throw new Error("start"+n+"Must be in the range [0, "+(t.length-1)+"]");if(0>i||n+i>t.length)throw new Error("count"+i+"Must be in the range <= "+t.length+"}");var a=n+i,s=e._tempVector3;s.elements[0]=0,s.elements[1]=0,s.elements[2]=0;for(var o=n;a>o;++o)De.add(t[o],s,s);var h=r.center;De.scale(s,1/i,h);var l=0;for(o=n;a>o;++o){var u=De.distanceSquared(h,t[o]);u>l&&(l=u)}r.radius=Math.sqrt(l)},e.createfromPoints=function(t,n){if(null==t)throw new Error("points");e.createFromSubPoints(t,0,t.length,n)},i(e,["_tempVector3",function(){return this._tempVector3=new De}]),e}(),ge=function(){function e(){}return r(e,"laya.d3.math.Collision"),e.distancePlaneToPoint=function(e,t){var n=De.dot(e.normal,t);return n-e.distance},e.distanceBoxToPoint=function(e,t){var n=e.min.elements,i=n[0],r=n[1],a=n[2],s=e.max.elements,o=s[0],h=s[1],l=s[2],u=t.elements,_=u[0],c=u[1],d=u[2],f=0;return i>_&&(f+=(i-_)*(i-_)),_>o&&(f+=(o-_)*(o-_)),r>c&&(f+=(r-c)*(r-c)),c>h&&(f+=(h-c)*(h-c)),a>d&&(f+=(a-d)*(a-d)),d>l&&(f+=(l-d)*(l-d)),Math.sqrt(f)},e.distanceBoxToBox=function(e,t){var n=e.min.elements,i=n[0],r=n[1],a=n[2],s=e.max.elements,o=s[0],h=s[1],l=s[2],u=t.min.elements,_=u[0],c=u[1],d=u[2],f=t.max.elements,m=f[0],p=f[1],v=f[2],g=0,x=NaN;return i>m?(x=i-m,g+=x*x):_>o&&(x=_-o,g+=x*x),r>p?(x=r-p,g+=x*x):c>h&&(x=c-h,g+=x*x),a>v?(x=a-v,g+=x*x):d>l&&(x=d-l,g+=x*x),Math.sqrt(g)},e.distanceSphereToPoint=function(e,t){var n=Math.sqrt(De.distanceSquared(e.center,t));return n-=e.radius,Math.max(n,0)},e.distanceSphereToSphere=function(e,t){var n=Math.sqrt(De.distanceSquared(e.center,t.center));return n-=e.radius+t.radius,Math.max(n,0)},e.intersectsRayAndPoint=function(t,n){De.subtract(t.origin,n,e._tempV30);var i=De.dot(e._tempV30,t.direction),r=De.dot(e._tempV30,e._tempV30)-xe.zeroTolerance;if(r>0&&i>0)return!1;var a=i*i-r;return!(0>a)},e.intersectsRayAndRay=function(t,n,i){var r=t.origin,a=r.elements,s=a[0],o=a[1],h=a[2],l=t.direction,u=l.elements,_=u[0],c=u[1],d=u[2],f=n.origin,m=f.elements,p=m[0],v=m[1],g=m[2],x=n.direction,T=x.elements,C=T[0],b=T[1],I=T[2];De.cross(l,x,e._tempV30);var E=e._tempV30.elements,D=De.scalarLength(e._tempV30);if(xe.isZero(D)&&xe.nearEqual(p,s)&&xe.nearEqual(v,o)&&xe.nearEqual(g,h))return i=De.ZERO,!0;D*=D;var M=p-s,y=v-o,w=g-h,V=C,A=b,P=I,S=E[0],R=E[1],O=E[2],N=M*A*O+y*P*S+w*V*R-M*P*R-y*V*O-w*A*S;V=_,A=c,P=d;var L=N/D;De.scale(l,L,e._tempV30),De.scale(x,L,e._tempV31),De.add(r,e._tempV30,e._tempV32),De.add(f,e._tempV31,e._tempV33);var B=e._tempV32.elements,F=e._tempV33.elements;return xe.nearEqual(F[0],B[0])&&xe.nearEqual(F[1],B[1])&&xe.nearEqual(F[2],B[2])?(i=e._tempV32,!0):(i=De.ZERO,!1)},e.intersectsRayAndPlaneRD=function(e,t,n){var i=t.normal,r=De.dot(i,e.direction);if(xe.isZero(r))return n=0,!1;var a=De.dot(i,e.origin);return n=(-t.distance-a)/r,0>n?(n=0,!1):!0},e.intersectsRayAndPlaneRP=function(t,n,i){var r=NaN;return e.intersectsRayAndPlaneRD(t,n,r)?(De.scale(t.direction,r,e._tempV30),De.add(t.origin,e._tempV30,e._tempV31),i=e._tempV31,!0):(i=De.ZERO,!1)},e.intersectsRayAndBoxRD=function(e,t,n){var i=e.origin.elements,r=i[0],a=i[1],s=i[2],o=e.direction.elements,h=o[0],l=o[1],u=o[2],_=t.min.elements,c=_[0],d=_[1],f=_[2],m=t.max.elements,p=m[0],v=m[1],g=m[2];n=0;var x=xe.MaxValue;if(xe.isZero(h)){if(c>r||r>p)return n=0,!1}else{var T=1/h,C=(c-r)*T,b=(p-r)*T;if(C>b){var I=C;C=b,b=I}if(n=Math.max(C,n),x=Math.min(b,x),n>x)return n=0,!1}if(xe.isZero(l)){if(d>a||a>v)return n=0,!1}else{var E=1/l,D=(d-a)*E,M=(v-a)*E;if(D>M){var y=D;D=M,M=y}if(n=Math.max(D,n),x=Math.min(M,x),n>x)return n=0,!1}if(xe.isZero(u)){if(f>s||s>g)return n=0,!1}else{var w=1/u,V=(f-s)*w,A=(g-s)*w;if(V>A){var P=V;V=A,A=P}if(n=Math.max(V,n),x=Math.min(A,x),n>x)return n=0,!1}return!0},e.intersectsRayAndBoxRP=function(t,n,i){var r=NaN;return e.intersectsRayAndBoxRD(t,n,r)?(De.scale(t.direction,r,e._tempV30),De.add(t.origin,e._tempV30,e._tempV31),i=e._tempV31,!0):(i=De.ZERO,!1)},e.intersectsRayAndSphereRD=function(t,n,i){var r=n.radius;De.subtract(t.origin,n.center,e._tempV30);var a=De.dot(e._tempV30,t.direction),s=De.dot(e._tempV30,e._tempV30)-r*r;if(s>0&&a>0)return i=0,!1;var o=a*a-s;return 0>o?(i=0,!1):(i=-a-Math.sqrt(o),0>i&&(i=0),!0)},e.intersectsRayAndSphereRP=function(t,n,i){var r=NaN;return e.intersectsRayAndSphereRD(t,n,r)?(De.scale(t.direction,r,e._tempV30),De.add(t.origin,e._tempV30,e._tempV31),i=e._tempV31,!0):(i=De.ZERO,!1)},e.intersectsPlaneAndPoint=function(e,t){var n=De.dot(e.normal,t)+e.distance;return n>0?Ce.PlaneIntersectionType_Front:0>n?Ce.PlaneIntersectionType_Back:Ce.PlaneIntersectionType_Intersecting},e.intersectsPlaneAndPlane=function(t,n){De.cross(t.normal,n.normal,e._tempV30);var i=De.dot(e._tempV30,e._tempV30);return!xe.isZero(i)},e.intersectsPlaneAndPlaneRL=function(t,n,i){var r=t.normal,a=n.normal;De.cross(r,a,e._tempV34);var s=De.dot(e._tempV34,e._tempV34);return xe.isZero(s)?!1:(De.scale(a,t.distance,e._tempV30),De.scale(r,n.distance,e._tempV31),De.subtract(e._tempV30,e._tempV31,e._tempV32),De.cross(e._tempV32,e._tempV34,e._tempV33),De.normalize(e._tempV34,e._tempV34),i=new Ie(e._tempV33,e._tempV34),!0)},e.intersectsPlaneAndBox=function(t,n){var i=t.distance,r=t.normal,a=r.elements,s=a[0],o=a[1],h=a[2],l=n.min.elements,u=l[0],_=l[1],c=l[2],d=n.max.elements,f=d[0],m=d[1],p=d[2];e._tempV30.elements[0]=s>0?u:f,e._tempV30.elements[1]=o>0?_:m,e._tempV30.elements[2]=h>0?c:p,e._tempV31.elements[0]=s>0?f:u,e._tempV31.elements[1]=o>0?m:_,e._tempV31.elements[2]=h>0?p:c;var v=De.dot(r,e._tempV30);return v+i>0?Ce.PlaneIntersectionType_Front:(v=De.dot(r,e._tempV31),0>v+i?Ce.PlaneIntersectionType_Back:Ce.PlaneIntersectionType_Intersecting)},e.intersectsPlaneAndSphere=function(e,t){var n=t.radius,i=De.dot(e.normal,t.center)+e.distance;return i>n?Ce.PlaneIntersectionType_Front:-n>i?Ce.PlaneIntersectionType_Back:Ce.PlaneIntersectionType_Intersecting},e.intersectsBoxAndBox=function(e,t){var n=e.min.elements,i=(n[1],n[2],e.max.elements),r=(i[1],i[2],t.min.elements),a=(r[1],r[2],t.max.elements);a[1],a[2];return n[0]>a[0]||r[0]>i[0]?!1:n[1]>a[1]||r[1]>i[1]?!1:!(n[2]>a[2]||r[2]>i[2])},e.intersectsBoxAndSphere=function(t,n){var i=n.center,r=n.radius;De.Clamp(i,t.min,t.max,e._tempV30);var a=De.distanceSquared(i,e._tempV30);return r*r>=a},e.intersectsSphereAndSphere=function(e,t){var n=e.radius+t.radius;return De.distanceSquared(e.center,t.center)<=n*n},i(e,["_tempV30",function(){return this._tempV30=new De},"_tempV31",function(){return this._tempV31=new De},"_tempV32",function(){return this._tempV32=new De},"_tempV33",function(){return this._tempV33=new De},"_tempV34",function(){return this._tempV34=new De}]),e}(),xe=(function(){function e(){}return r(e,"laya.d3.math.ContainmentType"),e.Disjoint=0,e.Contains=1,e.Intersects=2,e}(),function(){function e(){}return r(e,"laya.d3.math.MathUtils3D"),e.isZero=function(t){return Math.abs(t)<e.zeroTolerance},e.nearEqual=function(t,n){return!!e.isZero(t-n)},i(e,["zeroTolerance",function(){return this.zeroTolerance=1e-6},"MaxValue",function(){return this.MaxValue=3.40282347e38},"MinValue",function(){return this.MinValue=-3.40282347e38}]),e}()),Te=(function(){function e(){var e=this.elements=new Float32Array(9);e[0]=1,e[1]=0,e[2]=0,e[3]=0,e[4]=1,e[5]=0,e[6]=0,e[7]=0,e[8]=1}r(e,"laya.d3.math.Matrix3x3");var t=e.prototype;return t.determinant=function(){var e=this.elements,t=e[0],n=e[1],i=e[2],r=e[3],a=e[4],s=e[5],o=e[6],h=e[7],l=e[8];return t*(l*a-s*h)+n*(-l*r+s*o)+i*(h*r-a*o)},t.translate=function(e,t){var n=t.elements,i=this.elements,r=e.elements,a=i[0],s=i[1],o=i[2],h=i[3],l=i[4],u=i[5],_=i[6],c=i[7],d=i[8],f=r[0],m=r[1];n[0]=a,n[1]=s,n[2]=o,n[3]=h,n[4]=l,n[5]=u,n[6]=f*a+m*h+_,n[7]=f*s+m*l+c,n[8]=f*o+m*u+d},t.rotate=function(e,t){var n=t.elements,i=this.elements,r=i[0],a=i[1],s=i[2],o=i[3],h=i[4],l=i[5],u=i[6],_=i[7],c=i[8],d=Math.sin(e),f=Math.cos(e);n[0]=f*r+d*o,n[1]=f*a+d*h,n[2]=f*s+d*l,n[3]=f*o-d*r,n[4]=f*h-d*a,n[5]=f*l-d*s,n[6]=u,n[7]=_,n[8]=c},t.scale=function(e,t){var n=t.elements,i=this.elements,r=e.elements,a=r[0],s=r[1];n[0]=a*i[0],n[1]=a*i[1],n[2]=a*i[2],n[3]=s*i[3],n[4]=s*i[4],n[5]=s*i[5],n[6]=i[6],n[7]=i[7],n[8]=i[8]},t.invert=function(e){var t=e.elements,n=this.elements,i=n[0],r=n[1],a=n[2],s=n[3],o=n[4],h=n[5],l=n[6],u=n[7],_=n[8],c=_*o-h*u,d=-_*s+h*l,f=u*s-o*l,m=i*c+r*d+a*f;m||(e=null),m=1/m,t[0]=c*m,t[1]=(-_*r+a*u)*m,t[2]=(h*r-a*o)*m,t[3]=d*m,t[4]=(_*i-a*l)*m,t[5]=(-h*i+a*s)*m,t[6]=f*m,t[7]=(-u*i+r*l)*m,t[8]=(o*i-r*s)*m},t.transpose=function(e){var t=e.elements,n=this.elements;if(e===this){var i=n[1],r=n[2],a=n[5];t[1]=n[3],t[2]=n[6],t[3]=i,t[5]=n[7],t[6]=r,t[7]=a}else t[0]=n[0],t[1]=n[3],t[2]=n[6],t[3]=n[1],t[4]=n[4],t[5]=n[7],t[6]=n[2],t[7]=n[5],t[8]=n[8]},t.identity=function(){var e=this.elements;e[0]=1,e[1]=0,e[2]=0,e[3]=0,e[4]=1,e[5]=0,e[6]=0,e[7]=0,e[8]=1},t.cloneTo=function(e){var t,n,i;if(n=this.elements,i=e.elements,n!==i)for(t=0;9>t;++t)i[t]=n[t]},t.copyFrom=function(e){var t,n,i;if(n=e.elements,i=this.elements,n!==i)for(t=0;9>t;++t)i[t]=n[t]},t.copyFromArray=function(e){var t,n;if(n=this.elements,e!==n)for(t=0;9>t;++t)n[t]=e[t]},e.createFromTranslation=function(e,t){var n=(t.elements,e.elements);t[0]=1,t[1]=0,t[2]=0,t[3]=0,t[4]=1,t[5]=0,t[6]=n[0],t[7]=n[1],t[8]=1},e.createFromRotation=function(e,t){var n=t.elements,i=Math.sin(e),r=Math.cos(e);n[0]=r,n[1]=i,n[2]=0,n[3]=-i,n[4]=r,n[5]=0,n[6]=0,n[7]=0,n[8]=1},e.createFromScaling=function(e,t){var n=t.elements,i=e.elements;n[0]=i[0],n[1]=0,n[2]=0,n[3]=0,n[4]=i[1],n[5]=0,n[6]=0,n[7]=0,n[8]=1},e.createFromMatrix4x4=function(e,t){t[0]=e[0],t[1]=e[1],t[2]=e[2],t[3]=e[4],t[4]=e[5],t[5]=e[6],t[6]=e[8],t[7]=e[9],t[8]=e[10]},e.multiply=function(e,t,n){var i=n.elements,r=e.elements,a=t.elements,s=r[0],o=r[1],h=r[2],l=r[3],u=r[4],_=r[5],c=r[6],d=r[7],f=r[8],m=a[0],p=a[1],v=a[2],g=a[3],x=a[4],T=a[5],C=a[6],b=a[7],I=a[8];i[0]=m*s+p*l+v*c,i[1]=m*o+p*u+v*d,i[2]=m*h+p*_+v*f,i[3]=g*s+x*l+T*c,i[4]=g*o+x*u+T*d,i[5]=g*h+x*_+T*f,i[6]=C*s+b*l+I*c,i[7]=C*o+b*u+I*d,i[8]=C*h+b*_+I*f},e.DEFAULT=new e,e}(),function(){function e(e,t,n,i,r,a,s,o,h,l,u,_,c,d,f,m){void 0===e&&(e=1),void 0===t&&(t=0),void 0===n&&(n=0),void 0===i&&(i=0),void 0===r&&(r=0),void 0===a&&(a=1),void 0===s&&(s=0),void 0===o&&(o=0),void 0===h&&(h=0),void 0===l&&(l=0),void 0===u&&(u=1),void 0===_&&(_=0),void 0===c&&(c=0),void 0===d&&(d=0),void 0===f&&(f=0),void 0===m&&(m=1);var p=this.elements=new Float32Array(16);p[0]=e,p[1]=t,p[2]=n,p[3]=i,p[4]=r,p[5]=a,p[6]=s,p[7]=o,p[8]=h,p[9]=l,p[10]=u,p[11]=_,p[12]=c,p[13]=d,p[14]=f,p[15]=m}r(e,"laya.d3.math.Matrix4x4");var t=e.prototype;return t.equalsOtherMatrix=function(e){var t=this.elements,n=e.elements;return xe.nearEqual(t[0],n[0])&&xe.nearEqual(t[1],n[1])&&xe.nearEqual(t[2],n[2])&&xe.nearEqual(t[3],n[3])&&xe.nearEqual(t[4],n[4])&&xe.nearEqual(t[5],n[5])&&xe.nearEqual(t[6],n[6])&&xe.nearEqual(t[7],n[7])&&xe.nearEqual(t[8],n[8])&&xe.nearEqual(t[9],n[9])&&xe.nearEqual(t[10],n[10])&&xe.nearEqual(t[11],n[11])&&xe.nearEqual(t[12],n[12])&&xe.nearEqual(t[13],n[13])&&xe.nearEqual(t[14],n[14])&&xe.nearEqual(t[15],n[15])},t.decompose=function(t,n,i){var r=this.elements,a=t.elements,s=n.elements,o=i.elements;if(a[0]=r[12],a[1]=r[13],a[2]=r[14],o[0]=Math.sqrt(r[0]*r[0]+r[1]*r[1]+r[2]*r[2]),o[1]=Math.sqrt(r[4]*r[4]+r[5]*r[5]+r[6]*r[6]),o[2]=Math.sqrt(r[8]*r[8]+r[9]*r[9]+r[10]*r[10]),xe.isZero(o[0])||xe.isZero(o[1])||xe.isZero(o[2]))return s[0]=s[1]=s[2]=0,s[3]=1,!1;var h=new e,l=h.elements;return l[0]=r[0]/o[0],l[1]=r[1]/o[0],l[2]=r[2]/o[0],l[4]=r[4]/o[1],l[5]=r[5]/o[1],l[6]=r[6]/o[1],l[8]=r[8]/o[2],l[9]=r[9]/o[2],l[10]=r[10]/o[2],h[15]=1,be.createFromMatrix4x4(h,n),!0},t.normalize=function(){var e=this.elements,t=e[0],n=e[1],i=e[2],r=Math.sqrt(t*t+n*n+i*i);return r?void(1!=r&&(r=1/r,e[0]=t*r,e[1]=n*r,e[2]=i*r)):(e[0]=0,e[1]=0,void(e[2]=0))},t.transpose=function(){var e,t;return e=this.elements,t=e[1],e[1]=e[4],e[4]=t,t=e[2],e[2]=e[8],e[8]=t,t=e[3],e[3]=e[12],e[12]=t,t=e[6],e[6]=e[9],e[9]=t,t=e[7],e[7]=e[13],e[13]=t,t=e[11],e[11]=e[14],e[14]=t,this},t.invert=function(e){var t=this.elements,n=e.elements,i=t[0],r=t[1],a=t[2],s=t[3],o=t[4],h=t[5],l=t[6],u=t[7],_=t[8],c=t[9],d=t[10],f=t[11],m=t[12],p=t[13],v=t[14],g=t[15],x=i*h-r*o,T=i*l-a*o,C=i*u-s*o,b=r*l-a*h,I=r*u-s*h,E=a*u-s*l,D=_*p-c*m,M=_*v-d*m,y=_*g-f*m,w=c*v-d*p,V=c*g-f*p,A=d*g-f*v,P=x*A-T*V+C*w+b*y-I*M+E*D;0!==Math.abs(P)&&(P=1/P,n[0]=(h*A-l*V+u*w)*P,n[1]=(a*V-r*A-s*w)*P,n[2]=(p*E-v*I+g*b)*P,n[3]=(d*I-c*E-f*b)*P,n[4]=(l*y-o*A-u*M)*P,n[5]=(i*A-a*y+s*M)*P,n[6]=(v*C-m*E-g*T)*P,n[7]=(_*E-d*C+f*T)*P,n[8]=(o*V-h*y+u*D)*P,n[9]=(r*y-i*V-s*D)*P,n[10]=(m*I-p*C+g*x)*P,n[11]=(c*C-_*I-f*x)*P,n[12]=(h*M-o*w-l*D)*P,n[13]=(i*w-r*M+a*D)*P,n[14]=(p*T-m*b-v*x)*P,n[15]=(_*b-c*T+d*x)*P)},t.identity=function(){var e=this.elements;e[1]=e[2]=e[3]=e[4]=e[6]=e[7]=e[8]=e[9]=e[11]=e[12]=e[13]=e[14]=0,e[0]=e[5]=e[10]=e[15]=1},t.cloneTo=function(e){var t,n,i;if(n=this.elements,i=e.elements,n!==i)for(t=0;16>t;++t)i[t]=n[t]},t.copyFrom=function(e){var t,n,i;if(n=e.elements,i=this.elements,n!==i)for(t=0;16>t;++t)i[t]=n[t]},t.copyFromArray=function(e){var t,n;if(n=this.elements,e!==n)for(t=0;16>t;++t)n[t]=e[t]},e.createRotationX=function(e,t){var n=t.elements,i=Math.sin(e),r=Math.cos(e);n[1]=n[2]=n[3]=n[4]=n[7]=n[8]=n[11]=n[12]=n[13]=n[14]=0,n[0]=n[15]=1,n[5]=n[10]=r,n[6]=i,n[9]=-i},e.createRotationY=function(e,t){var n=t.elements,i=Math.sin(e),r=Math.cos(e);n[1]=n[3]=n[4]=n[6]=n[7]=n[9]=n[11]=n[12]=n[13]=n[14]=0,n[5]=n[15]=1,n[0]=n[10]=r,n[2]=-i,n[8]=i},e.createRotationZ=function(e,t){var n=t.elements,i=Math.sin(e),r=Math.cos(e);n[2]=n[3]=n[6]=n[7]=n[8]=n[9]=n[11]=n[12]=n[13]=n[14]=0,n[10]=n[15]=1,n[0]=n[5]=r,n[1]=i,n[4]=-i},e.createTranslate=function(e,t){var n=e.elements,i=t.elements;i[4]=i[8]=i[1]=i[9]=i[2]=i[6]=i[3]=i[7]=i[11]=0,i[0]=i[5]=i[10]=i[15]=1,i[12]=n[0],i[13]=n[1],i[14]=n[2]},e.createScaling=function(e,t){var n=e.elements,i=t.elements;i[0]=n[0],i[5]=n[1],i[10]=n[2],i[1]=i[4]=i[8]=i[12]=i[9]=i[13]=i[2]=i[6]=i[14]=i[3]=i[7]=i[11]=0,i[15]=1},e.multiply=function(e,t,n){var i,r,a,s,o,h,l,u;if(r=n.elements,a=e.elements,s=t.elements,r===s)for(s=new Float32Array(16),i=0;16>i;++i)s[i]=r[i];for(i=0;4>i;i++)o=a[i],h=a[i+4],l=a[i+8],u=a[i+12],r[i]=o*s[0]+h*s[1]+l*s[2]+u*s[3],r[i+4]=o*s[4]+h*s[5]+l*s[6]+u*s[7],r[i+8]=o*s[8]+h*s[9]+l*s[10]+u*s[11],r[i+12]=o*s[12]+h*s[13]+l*s[14]+u*s[15]},e.createFromQuaternion=function(e,t){var n=t.elements,i=e.elements,r=i[0],a=i[1],s=i[2],o=i[3],h=r+r,l=a+a,u=s+s,_=r*h,c=a*h,d=a*l,f=s*h,m=s*l,p=s*u,v=o*h,g=o*l,x=o*u;n[0]=1-d-p,n[1]=c+x,n[2]=f-g,n[3]=0,n[4]=c-x,n[5]=1-_-p,n[6]=m+v,n[7]=0,n[8]=f+g,n[9]=m-v,n[10]=1-_-d,n[11]=0,n[12]=0,n[13]=0,n[14]=0,t[15]=1},e.createAffineTransformation=function(e,t,n,i){var r=e.elements,a=t.elements,s=n.elements,o=i.elements,h=a[0],l=a[1],u=a[2],_=a[3],c=h+h,d=l+l,f=u+u,m=h*c,p=h*d,v=h*f,g=l*d,x=l*f,T=u*f,C=_*c,b=_*d,I=_*f,E=s[0],D=s[1],M=s[2];o[0]=(1-(g+T))*E,o[1]=(p+I)*E,o[2]=(v-b)*E,o[3]=0,o[4]=(p-I)*D,o[5]=(1-(m+T))*D,o[6]=(x+C)*D,o[7]=0,o[8]=(v+b)*M,o[9]=(x-C)*M,o[10]=(1-(m+g))*M,o[11]=0,o[12]=r[0],o[13]=r[1],o[14]=r[2],o[15]=1},e.createLookAt=function(e,t,n,i){var r,a,s,o,h,l,u,_,c,d,f=e.elements,m=t.elements,p=n.elements,v=i.elements,g=f[0],x=f[1],T=f[2],C=p[0],b=p[1],I=p[2],E=m[0],D=m[1],M=m[2];return Math.abs(g-E)<xe.zeroTolerance&&Math.abs(x-D)<xe.zeroTolerance&&Math.abs(T-M)<xe.zeroTolerance?void i.identity():(u=g-E,_=x-D,c=T-M,d=1/Math.sqrt(u*u+_*_+c*c),u*=d,_*=d,c*=d,r=b*c-I*_,a=I*u-C*c,s=C*_-b*u,d=Math.sqrt(r*r+a*a+s*s),d?(d=1/d,r*=d,a*=d,s*=d):r=a=s=0,o=_*s-c*a,h=c*r-u*s,l=u*a-_*r,d=Math.sqrt(o*o+h*h+l*l),d?(d=1/d,o*=d,h*=d,l*=d):o=h=l=0,v[0]=r,v[1]=o,v[2]=u,v[3]=0,v[4]=a,v[5]=h,v[6]=_,v[7]=0,v[8]=s,v[9]=l,v[10]=c,v[11]=0,v[12]=-(r*g+a*x+s*T),v[13]=-(o*g+h*x+l*T),v[14]=-(u*g+_*x+c*T),void(v[15]=1))},e.createPerspective=function(e,t,n,i,r){var a=r.elements,s=1/Math.tan(.5*e),o=i/(n-i);a[0]=s/t,a[5]=s,a[10]=o,a[11]=-1,a[14]=o*n,a[1]=a[2]=a[3]=a[4]=a[6]=a[7]=a[8]=a[9]=a[12]=a[13]=a[15]=0},e.createOrthogonal=function(e,t,n,i,r,a,s){var o=s.elements,h=1/(e-t),l=1/(n-i),u=1/(r-a);o[1]=o[2]=o[3]=o[4]=o[6]=o[7]=o[8]=o[9]=o[11]=0,o[15]=1,o[0]=-2*h,o[5]=-2*l,o[10]=2*u,o[12]=(e+t)*h,o[13]=(i+n)*l,o[14]=(a+r)*u},e.TEMP=new e,e.DEFAULT=new e,e}()),Ce=function(){function e(e,t){this.normal=null,this.distance=NaN,void 0===t&&(t=0),this.normal=e,this.distance=t}r(e,"laya.d3.math.Plane");var t=e.prototype;return t.normalize=function(){var e=this.normal.elements,t=e[0],n=e[1],i=e[2],r=1/Math.sqrt(t*t+n*n+i*i);e[0]=t*r,e[1]=n*r,e[2]=i*r,this.distance*=r},e.createPlaneBy3P=function(t,n,i){var r=t.elements,a=n.elements,s=i.elements,o=a[0]-r[0],h=a[1]-r[1],l=a[2]-r[2],u=s[0]-r[0],_=s[1]-r[1],c=s[2]-r[2],d=h*c-l*_,f=l*u-o*c,m=o*_-h*u,p=1/Math.sqrt(d*d+f*f+m*m),v=d*p,g=f*p,x=m*p,T=e._TEMPVec3.elements;T[0]=v,T[1]=g,T[2]=x;var C=-(v*r[0]+g*r[1]+x*r[2]),b=new e(e._TEMPVec3,C);return b},e.PlaneIntersectionType_Back=0,e.PlaneIntersectionType_Front=1,e.PlaneIntersectionType_Intersecting=2,i(e,["_TEMPVec3",function(){return this._TEMPVec3=new De}]),e}(),be=function(){function e(e,t,n,i){this.elements=new Float32Array(4),void 0===e&&(e=0),void 0===t&&(t=0),void 0===n&&(n=0),void 0===i&&(i=1),this.elements[0]=e,this.elements[1]=t,this.elements[2]=n,this.elements[3]=i}r(e,"laya.d3.math.Quaternion");var t=e.prototype;return t.scaling=function(e,t){var n=t.elements,i=this.elements;n[0]=i[0]*e,n[1]=i[1]*e,n[2]=i[2]*e,n[3]=i[3]*e},t.normalize=function(e){var t=e.elements,n=this.elements,i=n[0],r=n[1],a=n[2],s=n[3],o=i*i+r*r+a*a+s*s;o>0&&(o=1/Math.sqrt(o),t[0]=i*o,t[1]=r*o,t[2]=a*o,t[3]=s*o)},t.length=function(){var e=this.elements,t=e[0],n=e[1],i=e[2],r=e[3];return Math.sqrt(t*t+n*n+i*i+r*r)},t.rotateX=function(e,t){var n=t.elements,i=this.elements;e*=.5;var r=i[0],a=i[1],s=i[2],o=i[3],h=Math.sin(e),l=Math.cos(e);n[0]=r*l+o*h,n[1]=a*l+s*h,n[2]=s*l-a*h,n[3]=o*l-r*h},t.rotateY=function(e,t){var n=t.elements,i=this.elements;e*=.5;var r=i[0],a=i[1],s=i[2],o=i[3],h=Math.sin(e),l=Math.cos(e);n[0]=r*l-s*h,n[1]=a*l+o*h,n[2]=s*l+r*h,n[3]=o*l-a*h},t.rotateZ=function(e,t){var n=t.elements,i=this.elements;e*=.5;var r=i[0],a=i[1],s=i[2],o=i[3],h=Math.sin(e),l=Math.cos(e);n[0]=r*l+a*h,n[1]=a*l-r*h,n[2]=s*l+o*h,n[3]=o*l-s*h},t.getYawPitchRoll=function(t){
De.transformQuat(De.ForwardRH,this,e.TEMPVector31),De.transformQuat(De.Up,this,e.TEMPVector32);var n=e.TEMPVector32.elements;e.angleTo(De.ZERO,e.TEMPVector31,e.TEMPVector33);var i=e.TEMPVector33.elements;i[0]==Math.PI/2?(i[1]=e.arcTanAngle(n[2],n[0]),i[2]=0):i[0]==-Math.PI/2?(i[1]=e.arcTanAngle(-n[2],-n[0]),i[2]=0):(Te.createRotationY(-i[1],e.TEMPMatrix0),Te.createRotationX(-i[0],e.TEMPMatrix1),De.transformCoordinate(e.TEMPVector32,e.TEMPMatrix0,e.TEMPVector32),De.transformCoordinate(e.TEMPVector32,e.TEMPMatrix1,e.TEMPVector32),i[2]=e.arcTanAngle(n[1],-n[0])),i[1]<=-Math.PI&&(i[1]=Math.PI),i[2]<=-Math.PI&&(i[2]=Math.PI),i[1]>=Math.PI&&i[2]>=Math.PI&&(i[1]=0,i[2]=0,i[0]=Math.PI-i[0]);var r=t.elements;r[0]=i[1],r[1]=i[0],r[2]=i[2]},t.invert=function(e){var t=e.elements,n=this.elements,i=n[0],r=n[1],a=n[2],s=n[3],o=i*i+r*r+a*a+s*s,h=o?1/o:0;t[0]=-i*h,t[1]=-r*h,t[2]=-a*h,t[3]=s*h},t.identity=function(){var e=this.elements;e[0]=0,e[1]=0,e[2]=0,e[3]=1},t.cloneTo=function(e){var t,n,i;if(n=this.elements,i=e.elements,n!==i)for(t=0;4>t;++t)i[t]=n[t]},t.copyFrom=function(e){var t,n,i;if(n=e.elements,i=this.elements,n!==i)for(t=0;4>t;++t)i[t]=n[t]},t.copyFromArray=function(e){var t,n;if(n=this.elements,e!==n)for(t=0;4>t;++t)n[t]=e[t]},a(0,t,"x",function(){return this.elements[0]}),a(0,t,"y",function(){return this.elements[1]}),a(0,t,"z",function(){return this.elements[2]}),a(0,t,"w",function(){return this.elements[3]}),e.createFromYawPitchRoll=function(e,t,n,i){var r=.5*n,a=.5*t,s=.5*e,o=Math.sin(r),h=Math.cos(r),l=Math.sin(a),u=Math.cos(a),_=Math.sin(s),c=Math.cos(s),d=i.elements;d[0]=c*l*h+_*u*o,d[1]=_*u*h-c*l*o,d[2]=c*u*o-_*l*h,d[3]=c*u*h+_*l*o},e.multiply=function(e,t,n){var i=e.elements,r=t.elements,a=n.elements,s=i[0],o=i[1],h=i[2],l=i[3],u=r[0],_=r[1],c=r[2],d=r[3],f=o*c-h*_,m=h*u-s*c,p=s*_-o*u,v=s*u+o*_+h*c;a[0]=s*d+u*l+f,a[1]=o*d+_*l+m,a[2]=h*d+c*l+p,a[3]=l*d-v},e.arcTanAngle=function(e,t){return 0==e?1==t?Math.PI/2:-Math.PI/2:e>0?Math.atan(t/e):0>e?t>0?Math.atan(t/e)+Math.PI:Math.atan(t/e)-Math.PI:0},e.angleTo=function(t,n,i){De.subtract(n,t,e.TEMPVector30),De.normalize(e.TEMPVector30,e.TEMPVector30),i.elements[0]=Math.asin(e.TEMPVector30.y),i.elements[1]=e.arcTanAngle(-e.TEMPVector30.z,-e.TEMPVector30.x)},e.createFromAxisAngle=function(e,t,n){var i=n.elements,r=e.elements;t=.5*t;var a=Math.sin(t);i[0]=a*r[0],i[1]=a*r[1],i[2]=a*r[2],i[3]=Math.cos(t)},e.createFromMatrix3x3=function(e,t){var n,i=t.elements,r=e.elements,a=r[0]+r[4]+r[8];if(a>0)n=Math.sqrt(a+1),i[3]=.5*n,n=.5/n,i[0]=(r[5]-r[7])*n,i[1]=(r[6]-r[2])*n,i[2]=(r[1]-r[3])*n;else{var s=0;r[4]>r[0]&&(s=1),r[8]>r[3*s+s]&&(s=2);var o=(s+1)%3,h=(s+2)%3;n=Math.sqrt(r[3*s+s]-r[3*o+o]-r[3*h+h]+1),i[s]=.5*n,n=.5/n,i[3]=(r[3*o+h]-r[3*h+o])*n,i[o]=(r[3*o+s]+r[3*s+o])*n,i[h]=(r[3*h+s]+r[3*s+h])*n}},e.createFromMatrix4x4=function(e,t){var n,i,r=e.elements,a=t.elements,s=r[0]+r[5]+r[10];s>0?(n=Math.sqrt(s+1),a[3]=.5*n,n=.5/n,a[0]=(r[6]-r[9])*n,a[1]=(r[8]-r[2])*n,a[2]=(r[1]-r[4])*n):r[0]>=r[5]&&r[0]>=r[10]?(n=Math.sqrt(1+r[0]-r[5]-r[10]),i=.5/n,a[0]=.5*n,a[1]=(r[1]+r[4])*i,a[2]=(r[2]+r[8])*i,a[3]=(r[6]-r[9])*i):r[5]>r[10]?(n=Math.sqrt(1+r[5]-r[0]-r[10]),i=.5/n,a[0]=(r[4]+r[1])*i,a[1]=.5*n,a[2]=(r[9]+r[6])*i,a[3]=(r[8]-r[2])*i):(n=Math.sqrt(1+r[10]-r[0]-r[5]),i=.5/n,a[0]=(r[8]+r[2])*i,a[1]=(r[9]+r[6])*i,a[2]=.5*n,a[3]=(r[1]-r[4])*i)},e.slerp=function(e,t,n,i){var r,a,s,o,h,l=e.elements,u=t.elements,_=i.elements,c=l[0],d=l[1],f=l[2],m=l[3],p=u[0],v=u[1],g=u[2],x=u[3];return a=c*p+d*v+f*g+m*x,0>a&&(a=-a,p=-p,v=-v,g=-g,x=-x),1-a>1e-6?(r=Math.acos(a),s=Math.sin(r),o=Math.sin((1-n)*r)/s,h=Math.sin(n*r)/s):(o=1-n,h=n),_[0]=o*c+h*p,_[1]=o*d+h*v,_[2]=o*f+h*g,_[3]=o*m+h*x,_},e.lerp=function(e,t,n,i){var r=i.elements,a=e.elements,s=t.elements,o=a[0],h=a[1],l=a[2],u=a[3];r[0]=o+n*(s[0]-o),r[1]=h+n*(s[1]-h),r[2]=l+n*(s[2]-l),r[3]=u+n*(s[3]-u)},e.add=function(e,t,n){var i=n.elements,r=e.elements,a=t.elements;i[0]=r[0]+a[0],i[1]=r[1]+a[1],i[2]=r[2]+a[2],i[3]=r[3]+a[3]},e.dot=function(e,t){var n=e.elements,i=t.elements;return n[0]*i[0]+n[1]*i[1]+n[2]*i[2]+n[3]*i[3]},e.DEFAULT=new e,i(e,["TEMPVector30",function(){return this.TEMPVector30=new De},"TEMPVector31",function(){return this.TEMPVector31=new De},"TEMPVector32",function(){return this.TEMPVector32=new De},"TEMPVector33",function(){return this.TEMPVector33=new De},"TEMPMatrix0",function(){return this.TEMPMatrix0=new Te},"TEMPMatrix1",function(){return this.TEMPMatrix1=new Te}]),e}(),Ie=function(){function e(e,t){this.origin=null,this.direction=null,this.origin=e,this.direction=t}return r(e,"laya.d3.math.Ray"),e}(),Ee=function(){function e(e,t){this.elements=new Float32Array(2),void 0===e&&(e=0),void 0===t&&(t=0);var n=this.elements;n[0]=e,n[1]=t}r(e,"laya.d3.math.Vector2");var t=e.prototype;return t.clone=function(e){var t=this.elements,n=e.elements;t[0]=n[0],t[1]=n[1]},a(0,t,"x",function(){return this.elements[0]}),a(0,t,"y",function(){return this.elements[1]}),i(e,["ZERO",function(){return this.ZERO=new e(0,0)},"ONE",function(){return this.ONE=new e(1,1)}]),e}(),De=function(){function e(e,t,n){this.elements=new Float32Array(3),void 0===e&&(e=0),void 0===t&&(t=0),void 0===n&&(n=0);var i=this.elements;i[0]=e,i[1]=t,i[2]=n}r(e,"laya.d3.math.Vector3");var t=e.prototype;return t.copyFrom=function(e){var t=this.elements,n=e.elements;return t[0]=n[0],t[1]=n[1],t[2]=n[2],this},t.clone=function(){var t=new e,n=t.elements,i=this.elements;return n[0]=i[0],n[1]=i[1],n[2]=i[2],t},t.cloneTo=function(e){var t=e.elements,n=this.elements;t[0]=n[0],t[1]=n[1],t[2]=n[2]},t.toDefault=function(){this.elements[0]=0,this.elements[1]=0,this.elements[2]=0},a(0,t,"x",function(){return this.elements[0]},function(e){this.elements[0]=e}),a(0,t,"y",function(){return this.elements[1]},function(e){this.elements[1]=e}),a(0,t,"z",function(){return this.elements[2]},function(e){this.elements[2]=e}),e.distanceSquared=function(e,t){var n=e.elements,i=t.elements,r=n[0]-i[0],a=n[1]-i[1],s=n[2]-i[2];return r*r+a*a+s*s},e.distance=function(e,t){var n=e.elements,i=t.elements,r=n[0]-i[0],a=n[1]-i[1],s=n[2]-i[2];return Math.sqrt(r*r+a*a+s*s)},e.min=function(e,t,n){var i=n.elements,r=e.elements,a=t.elements;i[0]=Math.min(r[0],a[0]),i[1]=Math.min(r[1],a[1]),i[2]=Math.min(r[2],a[2])},e.max=function(e,t,n){var i=n.elements,r=e.elements,a=t.elements;i[0]=Math.max(r[0],a[0]),i[1]=Math.max(r[1],a[1]),i[2]=Math.max(r[2],a[2])},e.transformQuat=function(e,t,n){var i=n.elements,r=e.elements,a=t.elements,s=r[0],o=r[1],h=r[2],l=a[0],u=a[1],_=a[2],c=a[3],d=c*s+u*h-_*o,f=c*o+_*s-l*h,m=c*h+l*o-u*s,p=-l*s-u*o-_*h;i[0]=d*c+p*-l+f*-_-m*-u,i[1]=f*c+p*-u+m*-l-d*-_,i[2]=m*c+p*-_+d*-u-f*-l},e.scalarLength=function(e){var t=e.elements,n=t[0],i=t[1],r=t[2];return Math.sqrt(n*n+i*i+r*r)},e.normalize=function(e,t){var n=e.elements,i=t.elements,r=n[0],a=n[1],s=n[2],o=r*r+a*a+s*s;o>0&&(o=1/Math.sqrt(o),i[0]=n[0]*o,i[1]=n[1]*o,i[2]=n[2]*o)},e.multiply=function(e,t,n){var i=n.elements,r=e.elements,a=t.elements;i[0]=r[0]*a[0],i[1]=r[1]*a[1],i[2]=r[2]*a[2]},e.scale=function(e,t,n){var i=n.elements,r=e.elements;i[0]=r[0]*t,i[1]=r[1]*t,i[2]=r[2]*t},e.lerp=function(e,t,n,i){var r=i.elements,a=e.elements,s=t.elements,o=a[0],h=a[1],l=a[2];r[0]=o+n*(s[0]-o),r[1]=h+n*(s[1]-h),r[2]=l+n*(s[2]-l)},e.transformV3ToV3=function(t,n,i){var r=new Me;e.transformV3ToV4(t,n,r);var a=r.elements,s=i.elements;s[0]=a[0],s[1]=a[1],s[2]=a[2]},e.transformV3ToV4=function(e,t,n){var i=e.elements,r=i[0],a=i[1],s=i[2],o=t.elements,h=n.elements;h[0]=r*o[0]+a*o[4]+s*o[8]+o[12],h[1]=r*o[1]+a*o[5]+s*o[9]+o[13],h[2]=r*o[2]+a*o[6]+s*o[10]+o[14],h[3]=r*o[3]+a*o[7]+s*o[11]+o[15]},e.TransformNormal=function(e,t,n){var i=e.elements,r=i[0],a=i[1],s=i[2],o=t.elements,h=n.elements;h[0]=r*o[0]+a*o[4]+s*o[8],h[1]=r*o[1]+a*o[5]+s*o[9],h[2]=r*o[2]+a*o[6]+s*o[10]},e.transformCoordinate=function(t,n,i){var r=e.TEMPVec4.elements,a=t.elements,s=a[0],o=a[1],h=a[2],l=n.elements;r[0]=s*l[0]+o*l[4]+h*l[8]+l[12],r[1]=s*l[1]+o*l[5]+h*l[9]+l[13],r[2]=s*l[2]+o*l[6]+h*l[10]+l[14],r[3]=1/(s*l[3]+o*l[7]+h*l[11]+l[15]);var u=i.elements;u[0]=r[0]*r[3],u[1]=r[1]*r[3],u[2]=r[2]*r[3]},e.Clamp=function(e,t,n,i){var r=e.elements,a=r[0],s=r[1],o=r[2],h=t.elements,l=h[0],u=h[1],_=h[2],c=n.elements,d=c[0],f=c[1],m=c[2],p=i.elements;a=a>d?d:a,a=l>a?l:a,s=s>f?f:s,s=u>s?u:s,o=o>m?m:o,o=_>o?_:o,p[0]=a,p[1]=s,p[2]=o},e.add=function(e,t,n){var i=n.elements,r=e.elements,a=t.elements;i[0]=r[0]+a[0],i[1]=r[1]+a[1],i[2]=r[2]+a[2]},e.subtract=function(e,t,n){var i=n.elements,r=e.elements,a=t.elements;i[0]=r[0]-a[0],i[1]=r[1]-a[1],i[2]=r[2]-a[2]},e.cross=function(e,t,n){var i=e.elements,r=t.elements,a=n.elements,s=i[0],o=i[1],h=i[2],l=r[0],u=r[1],_=r[2];a[0]=o*_-h*u,a[1]=h*l-s*_,a[2]=s*u-o*l},e.dot=function(e,t){var n=e.elements,i=t.elements,r=n[0]*i[0]+n[1]*i[1]+n[2]*i[2];return r},e.equals=function(e,t){var n=e.elements,i=t.elements;return xe.nearEqual(Math.abs(n[0]),Math.abs(i[0]))&&xe.nearEqual(Math.abs(n[1]),Math.abs(i[1]))&&xe.nearEqual(Math.abs(n[2]),Math.abs(i[2]))},i(e,["TEMPVec4",function(){return this.TEMPVec4=new Me},"ZERO",function(){return this.ZERO=new e(0,0,0)},"ONE",function(){return this.ONE=new e(1,1,1)},"UnitX",function(){return this.UnitX=new e(1,0,0)},"UnitY",function(){return this.UnitY=new e(0,1,0)},"UnitZ",function(){return this.UnitZ=new e(0,0,1)},"ForwardRH",function(){return this.ForwardRH=new e(0,0,-1)},"ForwardLH",function(){return this.ForwardLH=new e(0,0,1)},"Up",function(){return this.Up=new e(0,1,0)}]),e}(),Me=function(){function e(e,t,n,i){this.elements=new Float32Array(4),void 0===e&&(e=0),void 0===t&&(t=0),void 0===n&&(n=0),void 0===i&&(i=0);var r=this.elements;r[0]=e,r[1]=t,r[2]=n,r[3]=i}r(e,"laya.d3.math.Vector4");var t=e.prototype;return t.copyFrom=function(e){var t=this.elements,n=e.elements;return t[0]=n[0],t[1]=n[1],t[2]=n[2],t[3]=n[3],this},a(0,t,"x",function(){return this.elements[0]}),a(0,t,"y",function(){return this.elements[1]}),a(0,t,"z",function(){return this.elements[2]}),a(0,t,"w",function(){return this.elements[3]}),e.lerp=function(e,t,n,i){var r=i.elements,a=e.elements,s=t.elements,o=a[0],h=a[1],l=a[2],u=a[3];r[0]=o+n*(s[0]-o),r[1]=h+n*(s[1]-h),r[2]=l+n*(s[2]-l),r[3]=u+n*(s[3]-u)},i(e,["ZERO",function(){return this.ZERO=new e}]),e}(),ye=function(){function e(e,t,n,i){this.minDepth=0,this.maxDepth=1,this.x=e,this.y=t,this.width=n,this.height=i}r(e,"laya.d3.math.Viewport");var t=e.prototype;return t.project=function(e,t,n){De.transformV3ToV3(e,t,n);var i=e.elements,r=t.elements,a=n.elements,s=i[0]*r[3]+i[1]*r[7]+i[2]*r[11]+r[15];1!==s&&(a[0]=a[0]/s,a[1]=a[1]/s,a[2]=a[2]/s),a[0]=.5*(a[0]+1)*this.width+this.x,a[1]=.5*(-a[1]+1)*this.height+this.y,a[2]=a[2]*(this.maxDepth-this.minDepth)+this.minDepth},t.unprojectFromMat=function(e,t,n){var i=e.elements,r=t.elements,a=n.elements;a[0]=(i[0]-this.x)/this.width*2-1,a[1]=-((i[1]-this.y)/this.height*2-1);var s=(this.maxDepth-this.minDepth)/2;a[2]=(i[2]-this.minDepth-s)/s;var o=a[0]*r[3]+a[1]*r[7]+a[2]*r[11]+r[15];De.transformV3ToV3(n,t,n),1!==o&&(a[0]=a[0]/o,a[1]=a[1]/o,a[2]=a[2]/o)},t.unprojectFromWVP=function(t,n,i,r,a){Te.multiply(n,i,e._tempMatrix4x4),r&&Te.multiply(e._tempMatrix4x4,r,e._tempMatrix4x4),e._tempMatrix4x4.invert(e._tempMatrix4x4),this.unprojectFromMat(t,e._tempMatrix4x4,a)},i(e,["_tempMatrix4x4",function(){return this._tempMatrix4x4=new Te}]),e}(),we=function(){function e(){this._indexBuffer=null,this._vertexBuffer=null,this._boneIndices=null,this._bufferUsage=null,this._indexInMesh=0,this._bufferUsage={}}r(e,"laya.d3.resource.models.SubMesh");var t=e.prototype;return n.imps(t,{"laya.d3.core.render.IRenderable":!0,"laya.resource.IDispose":!0}),t._testTangent=function(e){var t=this._vertexBuffer,n=t.vertexDeclaration,i=e.renderElement._material;if(i.normalTexture&&!n.getVertexElementByUsage("TANGENT0")){var r=t.getData(),a=Se.generateTangent(r,n.vertexStride/4,n.getVertexElementByUsage("POSITION").offset/4,n.getVertexElementByUsage("UV").offset/4,this._indexBuffer.getData());n=Se.getVertexTangentDeclaration(n.getVertexElements());var s=it.create(n,35044);s.setData(a),t.dispose(),this._vertexBuffer=s,this._bufferUsage.TANGENT0=s}},t._getVertexBuffer=function(e){return void 0===e&&(e=0),0===e?this._vertexBuffer:null},t._getIndexBuffer=function(){return this._indexBuffer},t._beforeRender=function(e){return this._testTangent(e),this._vertexBuffer._bind(),this._indexBuffer._bind(),!0},t._render=function(e){var t=this._indexBuffer.indexCount;e.context.drawElements(4,t,5123,0),V.drawCall++,V.trianglesFaces+=t/3},t.dispose=function(){this._boneIndices=null,this._indexBuffer.dispose(),this._vertexBuffer.dispose()},a(0,t,"_vertexBufferCount",function(){return 1}),a(0,t,"indexOfHost",function(){return this._indexInMesh}),a(0,t,"triangleCount",function(){return this._indexBuffer.indexCount/3}),e}(),Ve=(function(){function e(){}return r(e,"laya.d3.utils.Physics"),e.rayCastNode=function(t,n,i){if(n instanceof laya.d3.core.MeshSprite3D){var r=n,a=n.transform.worldMatrix,s=e._tempMatrix4x40;a.invert(s);var o=e._tempVector30,h=e._tempVector31,l=t.origin,u=t.direction;l.cloneTo(o),u.cloneTo(h),De.transformCoordinate(l,s,l),De.TransformNormal(u,s,u),De.normalize(u,u);for(var _=r.meshRender.renderCullingObject._renderElements,c=0,d=_.length;d>c;c++){var f=_[c].renderObj,m=f._getVertexBuffer(0),p=m.getData(),v=f._getIndexBuffer().getData(),g=e._tempRaycastHit0,x=Ve.rayIntersectsPositionsAndIndices(t,p,m.vertexDeclaration,v,g);if(x){De.transformCoordinate(g.position,a,g.position);var T=g.trianglePositions;De.transformCoordinate(T[0],a,T[0]),De.transformCoordinate(T[1],a,T[1]),De.transformCoordinate(T[2],a,T[2]);var C=g.triangleNormals;De.transformCoordinate(C[0],a,C[0]),De.transformCoordinate(C[1],a,C[1]),De.transformCoordinate(C[2],a,C[2]);var b=e._tempVector33;De.subtract(o,g.position,b),i.distance=De.scalarLength(b)}x&&g.distance<i.distance&&g.copy(i)}o.cloneTo(l),h.cloneTo(u)}for(var I=0,E=n._childs.length;E>I;I++)e.rayCast(t,n._childs[I],i)},e.rayCast=function(t,n,i){i.position.toDefault(),i.distance=Number.MAX_VALUE,i.trianglePositions[0].toDefault(),i.trianglePositions[1].toDefault(),i.trianglePositions[2].toDefault(),i.triangleNormals[0].toDefault(),i.triangleNormals[1].toDefault(),i.triangleNormals[2].toDefault(),e.rayCastNode(t,n,i)},i(e,["_tempVector30",function(){return this._tempVector30=new De},"_tempVector31",function(){return this._tempVector31=new De},"_tempVector33",function(){return this._tempVector33=new De},"_tempMatrix4x40",function(){return this._tempMatrix4x40=new Te},"_tempRaycastHit0",function(){return this._tempRaycastHit0=new Ae}]),e}(),function(){function e(){}return r(e,"laya.d3.utils.Picker"),e.calculateCursorRay=function(t,n,i,r,a,s){var o=t.elements[0],h=t.elements[1],l=e._tempVector30,u=l.elements;u[0]=o,u[1]=h,u[2]=n.minDepth;var _=e._tempVector31,c=_.elements;c[0]=o,c[1]=h,c[2]=n.maxDepth;var d=s.origin,f=e._tempVector32;n.unprojectFromWVP(l,i,r,a,d),n.unprojectFromWVP(_,i,r,a,f);var m=s.direction.elements;m[0]=f.x-d.x,m[1]=f.y-d.y,m[2]=f.z-d.z,De.normalize(s.direction,s.direction)},e.rayIntersectsPositionsAndIndices=function(t,n,i,r,a){for(var s=i.vertexStride/4,o=i.getVertexElementByUsage("POSITION").offset/4,h=Number.MAX_VALUE,l=-1,u=-1,_=-1,c=0;c<r.length;c+=3){var d=e._tempVector35,f=d.elements,m=r[c]*s,p=m+o;f[0]=n[p],f[1]=n[p+1],f[2]=n[p+2];var v=e._tempVector36,g=v.elements,x=r[c+1]*s,T=x+o;g[0]=n[T],g[1]=n[T+1],g[2]=n[T+2];var C=e._tempVector37,b=C.elements,I=r[c+2]*s,E=I+o;b[0]=n[E],b[1]=n[E+1],b[2]=n[E+2];var D=laya.d3.utils.Picker.rayIntersectsTriangle(t,d,v,C);!isNaN(D)&&h>D&&(h=D,l=m,u=x,_=I)}if(h!==Number.MAX_VALUE){a.distance=h,De.normalize(t.direction,t.direction),De.scale(t.direction,h,a.position),De.add(t.origin,a.position,a.position);var M=a.trianglePositions,y=M[0],w=M[1],V=M[2],A=y.elements,P=w.elements,S=V.elements,R=l+o;A[0]=n[R],A[1]=n[R+1],A[2]=n[R+2];var O=u+o;P[0]=n[O],P[1]=n[O+1],P[2]=n[O+2];var N=_+o;S[0]=n[N],S[1]=n[N+1],S[2]=n[N+2];var L=i.getVertexElementByUsage("NORMAL");if(L){var B=L.offset/4,F=a.triangleNormals,U=F[0],G=F[1],H=F[2],j=U.elements,k=G.elements,z=H.elements,W=l+B;j[0]=n[W],j[1]=n[W+1],j[2]=n[W+2];var X=u+B;k[0]=n[X],k[1]=n[X+1],k[2]=n[X+2];var q=_+B;z[0]=n[q],z[1]=n[q+1],z[2]=n[q+2]}return!0}return a.position.toDefault(),a.distance=Number.MAX_VALUE,a.trianglePositions[0].toDefault(),a.trianglePositions[1].toDefault(),a.trianglePositions[2].toDefault(),a.triangleNormals[0].toDefault(),a.triangleNormals[1].toDefault(),a.triangleNormals[2].toDefault(),!1},e.rayIntersectsTriangle=function(t,n,i,r){var a,s=e._tempVector30,o=e._tempVector31;De.subtract(i,n,s),De.subtract(r,n,o);var h=e._tempVector32;De.cross(t.direction,o,h);var l;if(l=De.dot(s,h),l>-Number.MIN_VALUE&&l<Number.MIN_VALUE)return a=Number.NaN;var u=1/l,_=e._tempVector33;De.subtract(t.origin,n,_);var c;if(c=De.dot(_,h),c*=u,0>c||c>1)return a=Number.NaN;var d=e._tempVector34;De.cross(_,s,d);var f;if(f=De.dot(t.direction,d),f*=u,0>f||c+f>1)return a=Number.NaN;var m;return m=De.dot(o,d),m*=u,a=0>m?Number.NaN:m},i(e,["_tempVector30",function(){return this._tempVector30=new De},"_tempVector31",function(){return this._tempVector31=new De},"_tempVector32",function(){return this._tempVector32=new De},"_tempVector33",function(){return this._tempVector33=new De},"_tempVector34",function(){return this._tempVector34=new De},"_tempVector35",function(){return this._tempVector35=new De},"_tempVector36",function(){return this._tempVector36=new De},"_tempVector37",function(){return this._tempVector37=new De}]),e}()),Ae=function(){function e(){this.distance=NaN,this.trianglePositions=null,this.triangleNormals=null,this.position=null,this.distance=Number.MAX_VALUE,this.trianglePositions=[new De,new De,new De],this.trianglePositions.length=3,this.triangleNormals=[new De,new De,new De],this.triangleNormals.length=3,this.position=new De}r(e,"laya.d3.utils.RaycastHit");var t=e.prototype;return t.copy=function(e){e.distance=this.distance,this.trianglePositions[0].cloneTo(e.trianglePositions[0]),this.trianglePositions[1].cloneTo(e.trianglePositions[1]),this.trianglePositions[2].cloneTo(e.trianglePositions[2]),this.triangleNormals[0].cloneTo(e.triangleNormals[0]),this.triangleNormals[1].cloneTo(e.triangleNormals[1]),this.triangleNormals[2].cloneTo(e.triangleNormals[2]),this.position.cloneTo(e.position)},e}(),Pe=function(){function e(e,t){this._width=0,this._height=0,this._width=e,this._height=t}r(e,"laya.d3.utils.Size");var t=e.prototype;return a(0,t,"width",function(){return-1===this._width?H.clientWidth:this._width}),a(0,t,"height",function(){return-1===this._height?H.clientHeight:this._height}),a(1,e,"fullScreen",function(){return new e(-1,-1)}),e}(),Se=function(){function e(){}return r(e,"laya.d3.utils.Utils3D"),e._getTexturePath=function(e){var t=e.length-4;return e.indexOf(".dds")!=t&&e.indexOf(".tga")!=t&&e.indexOf(".exr")!=t&&e.indexOf(".DDS")!=t&&e.indexOf(".TGA")!=t&&e.indexOf(".EXR")!=t||(e=e.substr(0,t)+".png"),e=A.formatURL(e)},e._rotationTransformScaleSkinAnimation=function(t,n,i,r,a,s,o,h,l,u,_,c){var d=e._tempArray16_0,f=e._tempArray16_1,m=e._tempArray16_2,p=r+r,v=a+a,g=s+s,x=r*p,T=a*p,C=a*v,b=s*p,I=s*v,E=s*g,D=o*p,M=o*v,y=o*g;d[15]=1,d[0]=1-C-E,d[1]=T+y,d[2]=b-M,d[4]=T-y,d[5]=1-x-E,d[6]=I+D,d[8]=b+M,d[9]=I-D,d[10]=1-x-C,f[15]=1,f[0]=h,f[5]=l,f[10]=u;var w,V,A,P,S;for(w=0;4>w;w++)V=d[w],A=d[w+4],P=d[w+8],S=d[w+12],m[w]=V,m[w+4]=A,m[w+8]=P,m[w+12]=V*t+A*n+P*i+S;for(w=0;4>w;w++)V=m[w],A=m[w+4],P=m[w+8],S=m[w+12],_[w+c]=V*f[0]+A*f[1]+P*f[2]+S*f[3],_[w+c+4]=V*f[4]+A*f[5]+P*f[6]+S*f[7],_[w+c+8]=V*f[8]+A*f[9]+P*f[10]+S*f[11],_[w+c+12]=V*f[12]+A*f[13]+P*f[14]+S*f[15]},e._parseHierarchyProp=function(e,t,n){switch(t){case"translate":e.transform.localPosition=new De(n[0],n[1],n[2]);break;case"rotation":e.transform.localRotation=new be(n[0],n[1],n[2],n[3]);break;case"scale":e.transform.localScale=new De(n[0],n[1],n[2])}},e._parseHierarchyNode=function(e){return e?new tt(at.load(e.loadPath)):new Ge},e._parseMaterial=function(t,i,r){switch(i){case"ambientColor":t.ambientColor=new De(r[0],r[1],r[2]);break;case"diffuseColor":t.diffuseColor=new De(r[0],r[1],r[2]);break;case"specularColor":t.specularColor=new Me(r[0],r[1],r[2],r[3]);break;case"reflectColor":t.reflectColor=new De(r[0],r[1],r[2]);break;case"diffuseTexture":r.texture2D&&n.loader.load(e._getTexturePath(r.texture2D),m.create(null,function(e){t.diffuseTexture=e}),null,"texture2d");break;case"normalTexture":r.texture2D&&n.loader.load(e._getTexturePath(r.texture2D),m.create(null,function(e){t.normalTexture=e}),null,"texture2d");break;case"specularTexture":r.texture2D&&n.loader.load(e._getTexturePath(r.texture2D),m.create(null,function(e){t.specularTexture=e}),null,"texture2d");break;case"emissiveTexture":r.texture2D&&n.loader.load(e._getTexturePath(r.texture2D),m.create(null,function(e){t.emissiveTexture=e}),null,"texture2d");break;case"ambientTexture":r.texture2D&&n.loader.load(e._getTexturePath(r.texture2D),m.create(null,function(e){t.ambientTexture=e}),null,"texture2d");break;case"reflectTexture":r.texture2D&&n.loader.load(e._getTexturePath(r.texture2D),m.create(null,function(e){t.reflectTexture=e}),null,"texture2d")}},e._computeBoneAndAnimationDatas=function(e,t,n,i,r){var a,s,o=0,h=0,l=n.length/2,u=e.length;for(a=0;u>a;o+=e[a].keyframeWidth,h+=16,a++)laya.d3.utils.Utils3D._rotationTransformScaleSkinAnimation(t[o+7],t[o+8],t[o+9],t[o+3],t[o+4],t[o+5],t[o+6],t[o+0],t[o+1],t[o+2],i,h),0!=a&&(s=16*e[a].parentIndex,laya.d3.utils.Utils3D.mulMatrixByArray(i,s,i,h,i,h));for(a=0;l>a;a+=16)laya.d3.utils.Utils3D.mulMatrixByArrayFast(i,a,n,l+a,r,a)},e._computeAnimationDatas=function(e,t,n){for(var i=e.length/2,r=0;i>r;r+=16)laya.d3.utils.Utils3D.mulMatrixByArrayFast(t,r,e,i+r,n,r)},e._computeBoneAndAnimationDatasByBindPoseMatrxix=function(e,t,n,i,r){var a,s,o=0,h=0,l=e.length;for(a=0;l>a;o+=e[a].keyframeWidth,h+=16,a++)laya.d3.utils.Utils3D._rotationTransformScaleSkinAnimation(t[o+7],t[o+8],t[o+9],t[o+3],t[o+4],t[o+5],t[o+6],t[o+0],t[o+1],t[o+2],i,h),0!=a&&(s=16*e[a].parentIndex,laya.d3.utils.Utils3D.mulMatrixByArray(i,s,i,h,i,h));var u=n.length;for(a=0;u>a;a++){var _=16*a;laya.d3.utils.Utils3D.mulMatrixByArrayAndMatrixFast(i,_,n[a],r,_)}},e._computeAnimationDatasByArrayAndMatrixFast=function(e,t,n){for(var i=e.length,r=0;i>r;r++){var a=16*r;laya.d3.utils.Utils3D.mulMatrixByArrayAndMatrixFast(t,a,e[r],n,a)}},e._computeRootAnimationData=function(e,t,n){for(var i=0,r=0,a=0,s=e.length;s>i;r+=e[i].keyframeWidth,a+=16,i++)laya.d3.utils.Utils3D.createAffineTransformationArray(t[r+0],t[r+1],t[r+2],t[r+3],t[r+4],t[r+5],t[r+6],t[r+7],t[r+8],t[r+9],n,a)},e.generateTangent=function(t,n,i,r,a){for(var s=3,o=n+s,h=new Float32Array(o*(t.length/n)),l=0;l<a.length;l+=3){var u=a[l+0],_=a[l+1],c=a[l+2],d=n*u+i,f=e._tempVector3_0;f.x=t[d+0],f.y=t[d+1],f.z=t[d+2];var m=n*_+i,p=e._tempVector3_1;p.x=t[m+0],p.y=t[m+1],p.z=t[m+2];var v=n*c+i,g=e._tempVector3_2;g.x=t[v+0],g.y=t[v+1],g.z=t[v+2];var x=n*u+r,T=t[x+0],C=t[x+1],b=n*_+r,I=t[b+0],E=t[b+1],D=n*c+r,M=t[D+0],y=t[D+1],w=e._tempVector3_3;De.subtract(p,f,w);var V=e._tempVector3_4;De.subtract(g,f,V),De.scale(w,y-C,w),De.scale(V,E-C,V);var A=e._tempVector3_5;De.subtract(w,V,A),De.scale(A,1/((I-T)*(y-C)-(E-C)*(M-T)),A);var P=0;for(P=0;n>P;P++)h[o*u+P]=t[n*u+P];for(P=0;s>P;P++)h[o*u+n+P]=+A.elements[P];for(P=0;n>P;P++)h[o*_+P]=t[n*_+P];for(P=0;s>P;P++)h[o*_+n+P]=+A.elements[P];for(P=0;n>P;P++)h[o*c+P]=t[n*c+P];for(P=0;s>P;P++)h[o*c+n+P]=+A.elements[P]}for(l=0;l<h.length;l+=o){var S=o*l+n,R=e._tempVector3_6;R.x=h[S+0],R.y=h[S+1],R.z=h[S+2],De.normalize(R,R),h[S+0]=R.x,h[S+1]=R.y,h[S+2]=R.z}return h},e.getVertexTangentDeclaration=function(e){for(var t=!1,n=!1,i=!1,r=!1,a=!1,s=!1,o=0;o<e.length;o++)switch(e[o].elementUsage){case"POSITION":t=!0;break;case"NORMAL":n=!0;break;case"COLOR":i=!0;break;case"UV":r=!0;break;case"BLENDWEIGHT":a=!0;break;case"BLENDINDICES":s=!0}var h;return t&&n&&i&&r&&a&&s?h=se.vertexDeclaration:t&&n&&r&&a&&s?h=ce.vertexDeclaration:t&&n&&i&&a&&s?h=ee.vertexDeclaration:t&&n&&i&&r?h=oe.vertexDeclaration:t&&n&&r?h=de.vertexDeclaration:t&&n&&i&&(h=te.vertexDeclaration),h},e.transformVector3ArrayByQuat=function(e,t,n,i,r){var a=n.elements,s=e[t],o=e[t+1],h=e[t+2],l=a[0],u=a[1],_=a[2],c=a[3],d=c*s+u*h-_*o,f=c*o+_*s-l*h,m=c*h+l*o-u*s,p=-l*s-u*o-_*h;i[r]=d*c+p*-l+f*-_-m*-u,i[r+1]=f*c+p*-u+m*-l-d*-_,i[r+2]=m*c+p*-_+d*-u-f*-l},e.mulMatrixByArray=function(t,n,i,r,a,s){var o,h,l,u,_;if(a===i){for(i=e._tempArray16_3,o=0;16>o;++o)i[o]=a[s+o];r=0}for(o=0;4>o;o++)h=t[n+o],l=t[n+o+4],u=t[n+o+8],_=t[n+o+12],a[s+o]=h*i[r+0]+l*i[r+1]+u*i[r+2]+_*i[r+3],a[s+o+4]=h*i[r+4]+l*i[r+5]+u*i[r+6]+_*i[r+7],a[s+o+8]=h*i[r+8]+l*i[r+9]+u*i[r+10]+_*i[r+11],a[s+o+12]=h*i[r+12]+l*i[r+13]+u*i[r+14]+_*i[r+15]},e.mulMatrixByArrayFast=function(e,t,n,i,r,a){var s,o,h,l,u;for(s=0;4>s;s++)o=e[t+s],h=e[t+s+4],l=e[t+s+8],u=e[t+s+12],r[a+s]=o*n[i+0]+h*n[i+1]+l*n[i+2]+u*n[i+3],r[a+s+4]=o*n[i+4]+h*n[i+5]+l*n[i+6]+u*n[i+7],r[a+s+8]=o*n[i+8]+h*n[i+9]+l*n[i+10]+u*n[i+11],r[a+s+12]=o*n[i+12]+h*n[i+13]+l*n[i+14]+u*n[i+15]},e.mulMatrixByArrayAndMatrixFast=function(e,t,n,i,r){var a,s,o,h,l,u=n.elements,_=u[0],c=u[1],d=u[2],f=u[3],m=u[4],p=u[5],v=u[6],g=u[7],x=u[8],T=u[9],C=u[10],b=u[11],I=u[12],E=u[13],D=u[14],M=u[15],y=t,w=t+4,V=t+8,A=t+12,P=r,S=r+4,R=r+8,O=r+12;for(a=0;4>a;a++)s=e[y+a],o=e[w+a],h=e[V+a],l=e[A+a],i[P+a]=s*_+o*c+h*d+l*f,i[S+a]=s*m+o*p+h*v+l*g,i[R+a]=s*x+o*T+h*C+l*b,i[O+a]=s*I+o*E+h*D+l*M},e.createAffineTransformationArray=function(e,t,n,i,r,a,s,o,h,l,u,_){var c=i+i,d=r+r,f=a+a,m=i*c,p=i*d,v=i*f,g=r*d,x=r*f,T=a*f,C=s*c,b=s*d,I=s*f;u[_+0]=(1-(g+T))*o,u[_+1]=(p+I)*o,u[_+2]=(v-b)*o,u[_+3]=0,u[_+4]=(p-I)*h,u[_+5]=(1-(m+T))*h,u[_+6]=(x+C)*h,u[_+7]=0,u[_+8]=(v+b)*l,u[_+9]=(x-C)*l,u[_+10]=(1-(m+g))*l,u[_+11]=0,u[_+12]=e,u[_+13]=t,u[_+14]=n,u[_+15]=1},e.transformVector3ArrayToVector3ArrayCoordinate=function(t,n,i,r,a){var s=e._tempArray4_0,o=t[n+0],h=t[n+1],l=t[n+2],u=i.elements;s[0]=o*u[0]+h*u[4]+l*u[8]+u[12],s[1]=o*u[1]+h*u[5]+l*u[9]+u[13],s[2]=o*u[2]+h*u[6]+l*u[10]+u[14],s[3]=1/(o*u[3]+h*u[7]+l*u[11]+u[15]),r[a+0]=s[0]*s[3],r[a+1]=s[1]*s[3],r[a+2]=s[2]*s[3]},e.convert3DCoordTo2DScreenCoord=function(e,t){var n=e.elements,i=t.elements;i[0]=-H.clientWidth/2+n[0],i[1]=H.clientHeight/2-n[1],i[2]=n[2]},e._tempVector3_0=new De,e._tempVector3_1=new De,e._tempVector3_2=new De,e._tempVector3_3=new De,e._tempVector3_4=new De,e._tempVector3_5=new De,e._tempVector3_6=new De,e._tempArray4_0=new Float32Array(4),e._tempArray16_0=new Float32Array(16),e._tempArray16_1=new Float32Array(16),e._tempArray16_2=new Float32Array(16),e._tempArray16_3=new Float32Array(16),i(e,["_typeToFunO",function(){return this._typeToFunO={INT16:"writeInt16",SHORT:"writeInt16",UINT16:"writeUint16",UINT32:"writeUint32",FLOAT32:"writeFloat32",INT:"writeInt32",UINT:"writeUint32",BYTE:"writeByte",STRING:"writeUTFString"}}]),e}(),Re=(function(){function e(){}return r(e,"Laya3D"),e._initShader=function(){M.addInclude("LightHelper.glsl","\nstruct DirectionLight\n{\n vec3 Direction;\n vec3 Diffuse;\n vec3 Ambient;\n vec3 Specular;\n};\n\nstruct PointLight\n{\n vec3 Diffuse;\n vec3 Ambient;\n vec3 Specular;\n vec3 Attenuation;\n vec3 Position;\n float Range;\n};\n\nstruct SpotLight\n{\n vec3 Diffuse;\n vec3 Ambient;\n vec3 Specular;\n vec3 Attenuation;\n vec3 Position;\n vec3 Direction;\n float Spot;\n float Range;\n};\n\n\nvoid  computeDirectionLight(in vec3 matDif,in vec3 matAmb,in vec4 matSpe,in DirectionLight dirLight,in vec3 normal,in vec3 toEye,out vec3 dif,out vec3 amb,out vec3 spec)\n{\n	dif=vec3(0.0);//不初始化在IOS中闪烁，PC中不会闪烁\n	amb=vec3(0.0);\n	spec=vec3(0.0);\n	vec3 lightVec=-normalize(dirLight.Direction);\n	\n	amb=matAmb*dirLight.Ambient;\n	\n	float  diffuseFactor=dot(lightVec, normal);\n	\n	if(diffuseFactor>0.0)\n	{\n	   vec3 v = reflect(-lightVec, normal);\n	   float specFactor = pow(max(dot(v, toEye), 0.0), matSpe.w);\n	   \n	   dif = diffuseFactor * matDif * dirLight.Diffuse;\n	   spec = specFactor * matSpe.rgb * dirLight.Specular;\n	}\n	\n}\n\nvoid computePointLight(in vec3 matDif,in vec3 matAmb,in vec4 matSpe,in PointLight poiLight, in vec3 pos,in vec3 normal,in vec3 toEye,out vec3 dif,out vec3 amb,out vec3 spec)\n{\n	dif=vec3(0.0);\n	amb=vec3(0.0);\n	spec=vec3(0.0);\n	vec3 lightVec = poiLight.Position - pos;\n		\n	float d = length(lightVec);\n	\n	if( d > poiLight.Range )\n		return;\n		\n	lightVec /= d; \n	\n	amb = matAmb * poiLight.Ambient;	\n\n	float diffuseFactor = dot(lightVec, normal);\n\n	if( diffuseFactor > 0.0 )\n	{\n		vec3 v= reflect(-lightVec, normal);\n		float specFactor = pow(max(dot(v, toEye), 0.0), matSpe.w);\n					\n		dif = diffuseFactor * matDif * poiLight.Diffuse;\n		spec = specFactor * matSpe.rgb * poiLight.Specular;\n	}\n\n	float attenuate = 1.0 / dot(poiLight.Attenuation, vec3(1.0, d, d*d));\n\n	dif *= attenuate;\n	spec*= attenuate;\n}\n\nvoid ComputeSpotLight(in vec3 matDif,in vec3 matAmb,in vec4 matSpe,in SpotLight spoLight,in vec3 pos, in vec3 normal,in vec3 toEye,out vec3 dif,out vec3 amb,out vec3 spec)\n{\n	amb = vec3(0.0);\n	dif =vec3(0.0);\n	spec= vec3(0.0);\n	vec3 lightVec = spoLight.Position - pos;\n		\n	float d = length(lightVec);\n	\n	if( d > spoLight.Range)\n		return;\n		\n	lightVec /= d; \n	\n	amb = matAmb * spoLight.Ambient;	\n\n	float diffuseFactor = dot(lightVec, normal);\n\n	if(diffuseFactor > 0.0)\n	{\n		vec3 v= reflect(-lightVec, normal);\n		float specFactor = pow(max(dot(v, toEye), 0.0), matSpe.w);\n					\n		dif = diffuseFactor * matDif * spoLight.Diffuse;\n		spec = specFactor * matSpe.rgb * spoLight.Specular;\n	}\n	\n	float spot = pow(max(dot(-lightVec, normalize(spoLight.Direction)), 0.0), spoLight.Spot);\n\n	float attenuate = spot/dot(spoLight.Attenuation, vec3(1.0, d, d*d));\n\n	amb *= spot;\n	dif *= attenuate;\n	spec*= attenuate;\n}\n\nvec3 NormalSampleToWorldSpace(vec3 normalMapSample, vec3 unitNormal, vec3 tangent)\n{\n	vec3 normalT = 2.0*normalMapSample - 1.0;\n\n	// Build orthonormal basis.\n	vec3 N = normalize(unitNormal);\n	vec3 T = normalize( tangent- dot(tangent, N)*N);\n	vec3 B = cross(T, N);\n\n	mat3 TBN = mat3(T, B, N);\n\n	// Transform from tangent space to world space.\n	vec3 bumpedNormal = TBN*normalT;\n\n	return bumpedNormal;\n}\n"),M.addInclude("VRHelper.glsl","\nvec4 DistortFishEye(vec4 p)\n{\n    vec2 v = p.xy / p.w;\n    float radius = length(v);// Convert to polar coords\n    if (radius > 0.0)\n    {\n      float theta = atan(v.y,v.x);\n      \n      radius = pow(radius, 0.93);// Distort:\n\n      v.x = radius * cos(theta);// Convert back to Cartesian\n      v.y = radius * sin(theta);\n      p.xy = v.xy * p.w;\n    }\n    return p;\n}");var e,t,n={a_Position:"POSITION",a_Color:"COLOR",a_Normal:"NORMAL",a_Texcoord0:"UV",a_Texcoord1:"UV1",a_TexcoordNext0:"NEXTUV",a_BoneWeights:"BLENDWEIGHT",a_BoneIndices:"BLENDINDICES",a_Tangent0:"TANGENT0",u_WorldMat:"MATRIX1",u_CameraPos:"CAMERAPOS",u_DiffuseTexture:"DIFFUSETEXTURE",u_SpecularTexture:"SPECULARTEXTURE",u_NormalTexture:"NORMALTEXTURE",u_AmbientTexture:"AMBIENTTEXTURE",u_ReflectTexture:"REFLECTTEXTURE",u_MvpMatrix:"MVPMATRIX",u_Bones:"MATRIXARRAY0",u_FogStart:"FOGSTART",u_FogRange:"FOGRANGE",u_FogColor:"FOGCOLOR",u_Albedo:"ALBEDO",u_AlphaTestValue:"ALPHATESTVALUE",u_UVMatrix:"MATRIX2",u_UVAge:"FLOAT0",u_UVAniAge:"UVAGEX","u_DirectionLight.Direction":"LIGHTDIRECTION","u_DirectionLight.Diffuse":"LIGHTDIRDIFFUSE","u_DirectionLight.Ambient":"LIGHTDIRAMBIENT","u_DirectionLight.Specular":"LIGHTDIRSPECULAR","u_PointLight.Position":"POINTLIGHTPOS","u_PointLight.Range":"POINTLIGHTRANGE","u_PointLight.Attenuation":"POINTLIGHTATTENUATION","u_PointLight.Diffuse":"POINTLIGHTDIFFUSE","u_PointLight.Ambient":"POINTLIGHTAMBIENT","u_PointLight.Specular":"POINTLIGHTSPECULAR",u_MaterialDiffuse:"MATERIALDIFFUSE",u_MaterialAmbient:"MATERIALAMBIENT",u_MaterialSpecular:"MATERIALSPECULAR",u_MaterialReflect:"MATERIALREFLECT","u_SpotLight.Position":"SPOTLIGHTPOS","u_SpotLight.Direction":"SPOTLIGHTDIRECTION","u_SpotLight.Range":"SPOTLIGHTRANGE","u_SpotLight.Spot":"SPOTLIGHTSPOT","u_SpotLight.Attenuation":"SPOTLIGHTATTENUATION","u_SpotLight.Diffuse":"SPOTLIGHTDIFFUSE",
"u_SpotLight.Ambient":"SPOTLIGHTAMBIENT","u_SpotLight.Specular":"SPOTLIGHTSPECULAR"},i=M.nameKey.add("SIMPLE");e='#include?DIRECTIONLIGHT||POINTLIGHT||SPOTLIGHT "LightHelper.glsl";\n\nattribute vec4 a_Position;\nuniform mat4 u_MvpMatrix;\n\n#include?VR "VRHelper.glsl";\n\n\n\n#ifdef DIFFUSEMAP||((DIRECTIONLIGHT||POINTLIGHT||SPOTLIGHT)&&COLOR&&SPECULARMAP)\nattribute vec2 a_Texcoord0;\nvarying vec2 v_Texcoord0;\n  #ifdef MIXUV\n  attribute vec2 a_TexcoordNext0;\n  uniform float  u_UVAge;\n  #endif\n  #ifdef UVTRANSFORM\n  uniform mat4 u_UVMatrix;\n  #endif\n#endif\n\n#ifdef AMBIENTMAP\nattribute vec2 a_Texcoord1;\nvarying vec2 v_Texcoord1;\n#endif\n\n\n#ifdef COLOR\nattribute vec4 a_Color;\nvarying vec4 v_Color;\n#endif\n\n#ifdef BONE\nattribute vec4 a_BoneIndices;\nattribute vec4 a_BoneWeights;\nconst int c_MaxBoneCount = 24;\nuniform mat4 u_Bones[c_MaxBoneCount];\n#endif\n\n#ifdef DIRECTIONLIGHT||POINTLIGHT||SPOTLIGHT||REFLECTMAP\nattribute vec3 a_Normal;\n#endif\n\n#ifdef DIRECTIONLIGHT||POINTLIGHT||SPOTLIGHT||FOG||REFLECTMAP\nuniform mat4 u_WorldMat;\nuniform vec3 u_CameraPos;\n#endif\n\n#ifdef DIRECTIONLIGHT\nuniform DirectionLight u_DirectionLight;\n#endif\n\n#ifdef POINTLIGHT\nuniform PointLight u_PointLight;\n#endif\n\n#ifdef SPOTLIGHT\nuniform SpotLight u_SpotLight;\n#endif\n\n#ifdef DIRECTIONLIGHT||POINTLIGHT||SPOTLIGHT\nuniform vec3 u_MaterialDiffuse;\nuniform vec4 u_MaterialSpecular;\n\nvarying vec3 v_Diffuse;\nvarying vec3 v_Ambient;\nvarying vec3 v_Specular;\n#endif\n\n#ifdef DIRECTIONLIGHT||POINTLIGHT||SPOTLIGHT||AMBIENTMAP\nuniform vec3 u_MaterialAmbient;\n#endif\n\n#ifdef FOG\nvarying float v_ToEyeLength;\n#endif\n\n#ifdef REFLECTMAP\nvarying vec3 v_ToEye;\nvarying vec3 v_Normal;\n#endif\n\n\nvoid main()\n{\n #ifdef BONE\n mat4 skinTransform=mat4(0.0);\n skinTransform += u_Bones[int(a_BoneIndices.x)] * a_BoneWeights.x;\n skinTransform += u_Bones[int(a_BoneIndices.y)] * a_BoneWeights.y;\n skinTransform += u_Bones[int(a_BoneIndices.z)] * a_BoneWeights.z;\n skinTransform += u_Bones[int(a_BoneIndices.w)] * a_BoneWeights.w;\n vec4 position=skinTransform*a_Position;\n   #ifdef VR\n   gl_Position = DistortFishEye(u_MvpMatrix * position);\n   #else\n   gl_Position = u_MvpMatrix * position;\n   #endif\n #else\n   #ifdef VR\n   gl_Position = DistortFishEye(u_MvpMatrix * a_Position);\n   #else\n   gl_Position = u_MvpMatrix * a_Position;\n   #endif\n #endif\n \n \n#ifdef DIRECTIONLIGHT||POINTLIGHT||SPOTLIGHT||REFLECTMAP\n  #ifdef BONE\n  vec3 normal=normalize( mat3(u_WorldMat*skinTransform)*a_Normal);\n  #else\n  vec3 normal=normalize( mat3(u_WorldMat)*a_Normal);\n  #endif\n \n  #ifdef REFLECTMAP\n  v_Normal=normal;\n  #endif\n#endif\n \n\n#ifdef DIRECTIONLIGHT||POINTLIGHT||SPOTLIGHT\n  v_Diffuse=vec3(0.0);\n  v_Ambient=vec3(0.0);\n  v_Specular=vec3(0.0);\n  vec3 dif, amb, spe;\n#endif\n\n\n#ifdef DIRECTIONLIGHT||POINTLIGHT||SPOTLIGHT||FOG||REFLECTMAP\n  #ifdef BONE\n  vec3 positionWorld=(u_WorldMat*position).xyz;\n  #else\n  vec3 positionWorld=(u_WorldMat*a_Position).xyz;\n  #endif\n#endif\n\n#ifdef DIRECTIONLIGHT||POINTLIGHT||SPOTLIGHT||FOG||REFLECTMAP\nvec3 toEye;\n  #ifdef FOG\n  toEye=u_CameraPos-positionWorld;\n  v_ToEyeLength=length(toEye);\n  toEye/=v_ToEyeLength;\n  #else\n  toEye=normalize(u_CameraPos-positionWorld);\n  #endif\n \n  #ifdef REFLECTMAP\n  v_ToEye=toEye;\n  #endif\n#endif\n \n#ifdef DIRECTIONLIGHT\ncomputeDirectionLight(u_MaterialDiffuse,u_MaterialAmbient,u_MaterialSpecular,u_DirectionLight,normal,toEye, dif, amb, spe);\nv_Diffuse+=dif;\nv_Ambient+=amb;\nv_Specular+=spe;\n#endif\n \n#ifdef POINTLIGHT\ncomputePointLight(u_MaterialDiffuse,u_MaterialAmbient,u_MaterialSpecular,u_PointLight,positionWorld,normal,toEye, dif, amb, spe);\nv_Diffuse+=dif;\nv_Ambient+=amb;\nv_Specular+=spe;\n#endif\n\n#ifdef SPOTLIGHT\nComputeSpotLight(u_MaterialDiffuse,u_MaterialAmbient,u_MaterialSpecular,u_SpotLight,positionWorld,normal,toEye, dif, amb, spe);\nv_Diffuse+=dif;\nv_Ambient+=amb;\nv_Specular+=spe;\n#endif\n  \n#ifdef DIFFUSEMAP||((DIRECTIONLIGHT||POINTLIGHT||SPOTLIGHT)&&COLOR&&SPECULARMAP)\n  #ifdef MIXUV\n  v_Texcoord0=mix(a_Texcoord0,a_TexcoordNext0,u_UVAge);\n  #else\n  v_Texcoord0=a_Texcoord0;\n  #endif\n  #ifdef UVTRANSFORM\n  v_Texcoord0=(u_UVMatrix*vec4(v_Texcoord0,0.0,1.0)).xy;\n  #endif\n#endif\n\n#ifdef AMBIENTMAP\nv_Texcoord1=a_Texcoord1;\n#endif\n  \n#ifdef COLOR\nv_Color=a_Color;\n#endif\n}',t="#ifdef FSHIGHPRECISION\nprecision highp float;\n#else\nprecision mediump float;\n#endif\n\nuniform vec4 u_Albedo;\n\n#ifdef ALPHATEST\nuniform float u_AlphaTestValue;\n#endif\n\n#ifdef DIFFUSEMAP\nuniform sampler2D u_DiffuseTexture;\n#endif\n\n#ifdef REFLECTMAP\nuniform samplerCube u_ReflectTexture;\nuniform vec3 u_MaterialReflect;\n#endif\n\n\n#ifdef DIFFUSEMAP||((DIRECTIONLIGHT||POINTLIGHT||SPOTLIGHT)&&COLOR&&SPECULARMAP)\nvarying vec2 v_Texcoord0;\n#endif\n\n#ifdef AMBIENTMAP\nvarying vec2 v_Texcoord1;\nuniform sampler2D u_AmbientTexture;\n#endif\n\n#ifdef DIRECTIONLIGHT||POINTLIGHT||SPOTLIGHT||AMBIENTMAP\nuniform vec3 u_MaterialAmbient;\n#endif\n\n#ifdef COLOR\nvarying vec4 v_Color;\n#endif\n\n#ifdef DIRECTIONLIGHT||POINTLIGHT||SPOTLIGHT\nvarying vec3 v_Diffuse;\nvarying vec3 v_Ambient;\nvarying vec3 v_Specular;\n  #ifdef (DIFFUSEMAP||COLOR)&&SPECULARMAP\n  uniform sampler2D u_SpecularTexture;\n  #endif\n#endif\n\n#ifdef FOG\nuniform float u_FogStart;\nuniform float u_FogRange;\nuniform vec3 u_FogColor;\nvarying float v_ToEyeLength;\n#endif\n\n#ifdef MIXUV\nuniform float  u_UVAniAge;\n#endif\n\n#ifdef REFLECTMAP\nvarying vec3 v_Normal;\nvarying vec3 v_ToEye;\n#endif\n\n\nvoid main()\n{\n #ifdef DIFFUSEMAP&&!COLOR\n gl_FragColor=texture2D(u_DiffuseTexture, v_Texcoord0);\n #endif \n \n #ifdef COLOR&&!DIFFUSEMAP\n gl_FragColor=v_Color;\n #endif \n \n #ifdef DIFFUSEMAP&&COLOR\n vec4 texColor=texture2D(u_DiffuseTexture, v_Texcoord0);\n gl_FragColor=texColor*v_Color;\n #endif\n \n #ifdef !DIFFUSEMAP&&!COLOR\n gl_FragColor=vec4(1.0,1.0,1.0,1.0);\n #endif \n \n #ifdef AMBIENTMAP\n gl_FragColor.rgb=gl_FragColor.rgb*(u_MaterialAmbient+texture2D(u_AmbientTexture, v_Texcoord1).rgb);\n #endif \n \n gl_FragColor=gl_FragColor*u_Albedo;\n  \n #ifdef ALPHATEST\n   if(gl_FragColor.a-u_AlphaTestValue<0.0)\n    discard;\n #endif\n \n \n #ifdef REFLECTMAP\n vec3 normal=normalize(v_Normal);\n #endif 	\n\n  \n #ifdef DIRECTIONLIGHT||POINTLIGHT||SPOTLIGHT\n   #ifdef (DIFFUSEMAP||COLOR)&&SPECULARMAP\n   vec3 specular =v_Specular*texture2D(u_SpecularTexture,v_Texcoord0).rgb;\n   gl_FragColor =vec4( gl_FragColor.rgb*(v_Ambient + v_Diffuse)+specular,gl_FragColor.a);\n   #else\n   gl_FragColor =vec4( gl_FragColor.rgb*(v_Ambient + v_Diffuse)+v_Specular,gl_FragColor.a);\n   #endif\n #endif\n \n #ifdef REFLECTMAP\n vec3 incident = -v_ToEye;\n vec3 reflectionVector = reflect(incident,v_Normal);\n vec3 reflectionColor  = textureCube(u_ReflectTexture,reflectionVector).rgb;\n gl_FragColor.rgb += u_MaterialReflect*reflectionColor;\n #endif\n \n #ifdef FOG\n float lerpFact=clamp((v_ToEyeLength-u_FogStart)/u_FogRange,0.0,1.0);\n gl_FragColor.rgb=mix(gl_FragColor.rgb,u_FogColor,lerpFact);\n #endif\n}\n\n",M.preCompile(i,4096,e,t,n),e='#include?VR "VRHelper.glsl";\nattribute vec4 a_Position;\nuniform mat4 u_MvpMatrix;\n\n\n\n#ifdef DIFFUSEMAP||((DIRECTIONLIGHT||POINTLIGHT||SPOTLIGHT)&&(COLOR&&SPECULARMAP||NORMALMAP))\nattribute vec2 a_Texcoord0;\nvarying vec2 v_Texcoord0;\n  #ifdef MIXUV\n  attribute vec2 a_TexcoordNext0;\n  uniform float  u_UVAge;\n  #endif\n  #ifdef UVTRANSFORM \n  uniform mat4 u_UVMatrix;\n  #endif\n#endif\n\n#ifdef AMBIENTMAP\nattribute vec2 a_Texcoord1;\nvarying vec2 v_Texcoord1;\n#endif\n\n#ifdef COLOR\nattribute vec4 a_Color;\nvarying vec4 v_Color;\n#endif\n\n#ifdef BONE\nattribute vec4 a_BoneIndices;\nattribute vec4 a_BoneWeights;\nconst int c_MaxBoneCount = 24;\nuniform mat4 u_Bones[c_MaxBoneCount];\n#endif\n\n#ifdef DIRECTIONLIGHT||POINTLIGHT||SPOTLIGHT||REFLECTMAP\nattribute vec3 a_Normal;\nvarying vec3 v_Normal;\n#endif\n\n#ifdef (DIRECTIONLIGHT||POINTLIGHT||SPOTLIGHT||REFLECTMAP)&&NORMALMAP\nattribute vec3 a_Tangent0;\nvarying vec3 v_Tangent0;\n#endif\n\n#ifdef DIRECTIONLIGHT||POINTLIGHT||SPOTLIGHT||FOG||REFLECTMAP\nuniform mat4 u_WorldMat;\nvarying vec3 v_PositionWorld;\n#endif\n\n\nvoid main()\n{\n #ifdef BONE\n mat4 skinTransform=mat4(0.0);\n skinTransform += u_Bones[int(a_BoneIndices.x)] * a_BoneWeights.x;\n skinTransform += u_Bones[int(a_BoneIndices.y)] * a_BoneWeights.y;\n skinTransform += u_Bones[int(a_BoneIndices.z)] * a_BoneWeights.z;\n skinTransform += u_Bones[int(a_BoneIndices.w)] * a_BoneWeights.w;\n vec4 position=skinTransform*a_Position;\n   #ifdef VR\n   gl_Position = DistortFishEye(u_MvpMatrix * position);\n   #else\n   gl_Position = u_MvpMatrix * position;\n   #endif\n #else\n   #ifdef VR\n   gl_Position = DistortFishEye(u_MvpMatrix * a_Position);\n   #else\n   gl_Position = u_MvpMatrix * a_Position;\n   #endif\n #endif\n \n\n #ifdef DIRECTIONLIGHT||POINTLIGHT||SPOTLIGHT||REFLECTMAP\n mat3 worldMat;\n   #ifdef BONE\n   worldMat=mat3(u_WorldMat*skinTransform);\n   #else\n   worldMat=mat3(u_WorldMat);\n   #endif  \n v_Normal=worldMat*a_Normal;\n   #ifdef (DIRECTIONLIGHT||POINTLIGHT||SPOTLIGHT)&&NORMALMAP\n   v_Tangent0=worldMat*a_Tangent0;\n   #endif\n #endif\n \n #ifdef DIRECTIONLIGHT||POINTLIGHT||SPOTLIGHT||FOG\n   #ifdef BONE\n   v_PositionWorld=(u_WorldMat*position).xyz;\n   #else\n   v_PositionWorld=(u_WorldMat*a_Position).xyz;\n   #endif\n #endif\n \n#ifdef DIFFUSEMAP||((DIRECTIONLIGHT||POINTLIGHT||SPOTLIGHT)&&(COLOR&&SPECULARMAP||NORMALMAP))\n  #ifdef MIXUV\n  v_Texcoord0=mix(a_Texcoord0,a_TexcoordNext0,u_UVAge);\n  #else\n  v_Texcoord0=a_Texcoord0;\n  #endif\n  #ifdef UVTRANSFORM\n  v_Texcoord0=(u_UVMatrix*vec4(v_Texcoord0,0.0,1.0)).xy;\n  #endif\n#endif\n\n#ifdef AMBIENTMAP\nv_Texcoord1=a_Texcoord1;\n#endif\n\n  \n#ifdef COLOR\nv_Color=a_Color;\n#endif\n}',t='#ifdef FSHIGHPRECISION\nprecision highp float;\n#else\nprecision mediump float;\n#endif\n\n#include?DIRECTIONLIGHT||POINTLIGHT||SPOTLIGHT "LightHelper.glsl";\n\nuniform vec4 u_Albedo;\n\n#ifdef ALPHATEST\nuniform float u_AlphaTestValue;\n#endif\n\n#ifdef DIFFUSEMAP\nuniform sampler2D u_DiffuseTexture;\n#endif\n\n#ifdef REFLECTMAP\nuniform samplerCube u_ReflectTexture;\nuniform vec3 u_MaterialReflect;\n#endif\n\n#ifdef DIFFUSEMAP||((DIRECTIONLIGHT||POINTLIGHT||SPOTLIGHT)&&(COLOR&&SPECULARMAP||NORMALMAP))\nvarying vec2 v_Texcoord0;\n#endif\n\n#ifdef AMBIENTMAP\nvarying vec2 v_Texcoord1;\nuniform sampler2D u_AmbientTexture;\n#endif\n\n#ifdef COLOR\nvarying vec4 v_Color;\n#endif\n\n#ifdef DIRECTIONLIGHT||POINTLIGHT||SPOTLIGHT\nuniform vec3 u_MaterialDiffuse;\nuniform vec4 u_MaterialSpecular;\n  #ifdef (DIFFUSEMAP||COLOR)&&SPECULARMAP \n  uniform sampler2D u_SpecularTexture;\n  #endif\n#endif\n\n#ifdef DIRECTIONLIGHT||POINTLIGHT||SPOTLIGHT||AMBIENTMAP\nuniform vec3 u_MaterialAmbient;\n#endif\n\n#ifdef FOG\nuniform float u_FogStart;\nuniform float u_FogRange;\nuniform vec3 u_FogColor;\n#endif\n\n#ifdef MIXUV\nuniform float  u_UVAniAge;\n#endif\n\n\n#ifdef DIRECTIONLIGHT||POINTLIGHT||SPOTLIGHT||REFLECTMAP\nvarying vec3 v_Normal;\n#endif\n\n#ifdef (DIRECTIONLIGHT||POINTLIGHT||SPOTLIGHT)&&NORMALMAP\nuniform sampler2D u_NormalTexture;\nvarying vec3 v_Tangent0;\n#endif\n\n#ifdef DIRECTIONLIGHT\nuniform DirectionLight u_DirectionLight;\n#endif\n\n#ifdef POINTLIGHT\nuniform PointLight u_PointLight;\n#endif\n\n#ifdef SPOTLIGHT\nuniform SpotLight u_SpotLight;\n#endif\n\n\n#ifdef DIRECTIONLIGHT||POINTLIGHT||SPOTLIGHT||FOG||REFLECTMAP\nuniform vec3 u_CameraPos;\nvarying vec3 v_PositionWorld;\n#endif\n\n\nvoid main()\n{\n  #ifdef DIFFUSEMAP&&!COLOR\n  gl_FragColor=texture2D(u_DiffuseTexture, v_Texcoord0);\n  #endif \n  \n  #ifdef COLOR&&!DIFFUSEMAP\n  gl_FragColor=v_Color;\n  #endif \n  \n  #ifdef DIFFUSEMAP&&COLOR\n  vec4 texColor=texture2D(u_DiffuseTexture, v_Texcoord0);\n  gl_FragColor=texColor*v_Color;\n  #endif\n  \n  #ifdef !DIFFUSEMAP&&!COLOR\n  gl_FragColor=vec4(1.0,1.0,1.0,1.0);\n  #endif \n  \n  #ifdef AMBIENTMAP\n  gl_FragColor.rgb=gl_FragColor.rgb*(u_MaterialAmbient+texture2D(u_AmbientTexture, v_Texcoord1).rgb);\n  #endif \n  \n  gl_FragColor=gl_FragColor*u_Albedo;\n  \n  #ifdef ALPHATEST\n  if(gl_FragColor.a-u_AlphaTestValue<0.0)\n    discard;\n  #endif\n  \n  \n  #ifdef DIRECTIONLIGHT||POINTLIGHT||SPOTLIGHT||REFLECTMAP\n  vec3 normal;\n    #ifdef (DIRECTIONLIGHT||POINTLIGHT||SPOTLIGHT)&&NORMALMAP\n    vec3 normalMapSample = texture2D(u_NormalTexture, v_Texcoord0).rgb;\n	normal = normalize(NormalSampleToWorldSpace(normalMapSample, v_Normal, v_Tangent0));\n	#else\n	normal = normalize(v_Normal);\n    #endif\n  #endif\n	\n  #ifdef DIRECTIONLIGHT||POINTLIGHT||SPOTLIGHT\n  vec3 diffuse = vec3(0.0);\n  vec3 ambient = vec3(0.0);\n  vec3 specular= vec3(0.0);\n  vec3 dif, amb, spe;\n  #endif\n  \n  #ifdef DIRECTIONLIGHT||POINTLIGHT||SPOTLIGHT||FOG||REFLECTMAP\n  vec3 toEye;\n    #ifdef FOG\n	toEye=u_CameraPos-v_PositionWorld;\n    float toEyeLength=length(toEye);\n    toEye/=toEyeLength;\n    #else\n	toEye=normalize(u_CameraPos-v_PositionWorld);\n    #endif\n  #endif\n	\n  #ifdef DIRECTIONLIGHT\n  computeDirectionLight(u_MaterialDiffuse,u_MaterialAmbient,u_MaterialSpecular,u_DirectionLight,normal,toEye, dif, amb, spe);\n  diffuse+=dif;\n  ambient+=amb;\n  specular+=spe;\n  #endif\n \n  #ifdef POINTLIGHT\n  computePointLight(u_MaterialDiffuse,u_MaterialAmbient,u_MaterialSpecular,u_PointLight,v_PositionWorld,normal,toEye, dif, amb, spe);\n  diffuse+=dif;\n  ambient+=amb;\n  specular+=spe;\n  #endif\n\n  #ifdef SPOTLIGHT\n  ComputeSpotLight(u_MaterialDiffuse,u_MaterialAmbient,u_MaterialSpecular,u_SpotLight,v_PositionWorld,normal,toEye, dif, amb, spe);\n  diffuse+=dif;\n  ambient+=amb;\n  specular+=spe;\n  #endif\n  \n\n  \n  \n  \n  #ifdef DIRECTIONLIGHT||POINTLIGHT||SPOTLIGHT\n    #ifdef (DIFFUSEMAP||COLOR)&&SPECULARMAP\n    specular =specular*texture2D(u_SpecularTexture, v_Texcoord0).rgb;\n    #endif\n  gl_FragColor =vec4( gl_FragColor.rgb*(ambient + diffuse) + specular,gl_FragColor.a);\n  #endif\n  \n  #ifdef REFLECTMAP\n  vec3 incident = -toEye;\n  vec3 reflectionVector = reflect(incident,normal);\n  vec3 reflectionColor  = textureCube(u_ReflectTexture,reflectionVector).rgb;\n  gl_FragColor.rgb += u_MaterialReflect*reflectionColor;\n  #endif\n  \n  #ifdef FOG\n  float lerpFact=clamp((toEyeLength-u_FogStart)/u_FogRange,0.0,1.0);\n  gl_FragColor.rgb=mix(gl_FragColor.rgb,u_FogColor,lerpFact);\n  #endif\n}\n\n',M.preCompile(i,8192,e,t,n),n={a_Position:"POSITION",a_Texcoord:"UV",u_FogStart:"FOGSTART",u_FogRange:"FOGRANGE",u_FogColor:"FOGCOLOR",u_WorldMat:"MATRIX1",u_CameraPos:"CAMERAPOS",u_BlendTexture:"DIFFUSETEXTURE",u_LayerTexture0:"NORMALTEXTURE",u_LayerTexture1:"SPECULARTEXTURE",u_LayerTexture2:"EMISSIVETEXTURE",u_LayerTexture3:"AMBIENTTEXTURE",u_MvpMatrix:"MVPMATRIX",u_Albedo:"ALBEDO",u_Ambient:"MATERIALAMBIENT",u_UVMatrix:"MATRIX2"};var r=M.nameKey.add("TERRAIN");e='#include?VR "VRHelper.glsl";\nattribute vec4 a_Position;\nuniform mat4 u_MvpMatrix;\nuniform mat4 u_UVMatrix;\n\n#ifdef DIFFUSEMAP&&NORMALMAP&&SPECULARMAP&&EMISSIVEMAP&&AMBIENTMAP\nattribute vec2 a_Texcoord;\nvarying vec2 v_Texcoord;\nvarying vec2 v_TiledTexcoord;\n#endif\n\n#ifdef FOG\nuniform mat4 u_WorldMat;\nvarying vec3 v_PositionWorld;\n#endif\n\n\nvoid main()\n{\n #ifdef VR\n gl_Position = DistortFishEye(u_MvpMatrix * a_Position);\n #else\n gl_Position = u_MvpMatrix * a_Position;\n #endif\n \n #ifdef FOG\n v_PositionWorld=(u_WorldMat*a_Position).xyz;\n #endif\n \n #ifdef DIFFUSEMAP&&NORMALMAP&&SPECULARMAP&&EMISSIVEMAP&&AMBIENTMAP\n v_Texcoord=a_Texcoord;\n v_TiledTexcoord=(u_UVMatrix*vec4(a_Texcoord,0.0,1.0)).xy;\n #endif\n}',t="#ifdef FSHIGHPRECISION\nprecision highp float;\n#else\nprecision mediump float;\n#endif\n\nuniform vec4 u_Albedo;\nuniform vec3 u_Ambient;\n\n#ifdef FOG\nuniform vec3 u_CameraPos;\nvarying vec3 v_PositionWorld;\n\nuniform float u_FogStart;\nuniform float u_FogRange;\nuniform vec3 u_FogColor;\n#endif\n\n#ifdef DIFFUSEMAP&&NORMALMAP&&SPECULARMAP&&EMISSIVEMAP&&AMBIENTMAP\n  varying vec2 v_Texcoord;\n  varying vec2 v_TiledTexcoord;\n  uniform sampler2D u_BlendTexture;\n  uniform sampler2D u_LayerTexture0;\n  uniform sampler2D u_LayerTexture1;\n  uniform sampler2D u_LayerTexture2;\n  uniform sampler2D u_LayerTexture3;\n#endif\n\nvoid main()\n{	\n  #ifdef DIFFUSEMAP&&NORMALMAP&&SPECULARMAP&&EMISSIVEMAP&&AMBIENTMAP\n  vec4 blend=texture2D(u_BlendTexture, v_Texcoord);\n  vec4 c0=texture2D(u_LayerTexture0, v_TiledTexcoord);\n  vec4 c1=texture2D(u_LayerTexture1, v_TiledTexcoord);\n  vec4 c2=texture2D(u_LayerTexture2, v_TiledTexcoord);\n  vec4 c3=texture2D(u_LayerTexture3, v_TiledTexcoord);\n  vec4 texColor = c0;\n  texColor = mix(texColor, c1, blend.r);\n  texColor = mix(texColor, c2, blend.g);\n  texColor = mix(texColor, c3, blend.b);\n  gl_FragColor=vec4(texColor.rgb*u_Ambient.rgb*blend.a,1.0);\n  gl_FragColor=gl_FragColor*u_Albedo;\n  #endif \n  \n  #ifdef FOG\n  vec3 toEye=u_CameraPos-v_PositionWorld;\n  float toEyeLength=length(toEye);\n  \n  float lerpFact=clamp((toEyeLength-u_FogStart)/u_FogRange,0.0,1.0);\n  gl_FragColor.rgb=mix(gl_FragColor.rgb,u_FogColor,lerpFact);\n  #endif\n}\n\n",M.preCompile(r,4096,e,t,n),M.preCompile(r,8192,e,t,n),n={a_CornerTextureCoordinate:"CORNERTEXTURECOORDINATE",a_Position:"POSITION",a_Velocity:"VELOCITY",a_StartColor:"STARTCOLOR",a_EndColor:"ENDCOLOR",a_SizeRotation:"SIZEROTATION",a_Radius:"RADIUS",a_Radian:"RADIAN",a_AgeAddScale:"AGEADDSCALE",a_Time:"TIME",u_WorldMat:"MVPMATRIX",u_View:"MATRIX1",u_Projection:"MATRIX2",u_ViewportScale:"VIEWPORTSCALE",u_CurrentTime:"CURRENTTIME",u_Duration:"DURATION",u_Gravity:"GRAVITY",u_EndVelocity:"ENDVELOCITY",u_texture:"DIFFUSETEXTURE"};var a=M.nameKey.add("PARTICLE");M.preCompile(a,4096,T.vs,T.ps,n),M.preCompile(a,8192,T.vs,T.ps,n),n={a_CornerTextureCoordinate:"CORNERTEXTURECOORDINATE",a_Position:"POSITION",a_Velocity:"VELOCITY",a_StartColor:"STARTCOLOR",a_EndColor:"ENDCOLOR",a_SizeRotation:"SIZEROTATION",a_Radius:"RADIUS",a_Radian:"RADIAN",a_AgeAddScale:"AGEADDSCALE",a_Time:"TIME",u_WorldMat:"MVPMATRIX",u_View:"MATRIX1",u_Projection:"MATRIX2",u_ViewportScale:"VIEWPORTSCALE",u_CurrentTime:"CURRENTTIME",u_Duration:"DURATION",u_Gravity:"GRAVITY",u_EndVelocity:"ENDVELOCITY",u_texture:"DIFFUSETEXTURE"};var s=M.nameKey.add("U3DPARTICLE");M.preCompile(s,4096,T.vs,T.ps,n),M.preCompile(s,8192,T.vs,T.ps,n),n={a_Position:"POSITION",a_Texcoord0:"UV",a_Time:"TIME",u_Texture:"DIFFUSETEXTURE",u_MvpMatrix:"MVPMATRIX",u_Albedo:"ALBEDO",u_CurrentTime:"CURRENTTIME",u_Color:"UNICOLOR",u_Duration:"DURATION"};var o=M.nameKey.add("GLITTER");e="attribute vec4 a_Position;\nattribute vec2 a_Texcoord0;\nattribute float a_Time;\n\nuniform mat4 u_MvpMatrix;\nuniform  float u_CurrentTime;\nuniform  vec4 u_Color;\nuniform float u_Duration;\n\nvarying vec2 v_Texcoord;\nvarying vec4 v_Color;\n\n\nvoid main()\n{\n  gl_Position = u_MvpMatrix * a_Position;\n  \n  float age = u_CurrentTime-a_Time;\n  float normalizedAge = clamp(age / u_Duration,0.0,1.0);\n   \n  v_Texcoord=a_Texcoord0;\n  \n  v_Color=u_Color;\n  v_Color.a*=1.0-normalizedAge;\n}\n",t="#ifdef FSHIGHPRECISION\nprecision highp float;\n#else\nprecision mediump float;\n#endif\n\nuniform vec4 u_Albedo;\nuniform sampler2D u_Texture;\n\nvarying vec2 v_Texcoord;\nvarying vec4 v_Color;\n\n\nvoid main()\n{	\n  gl_FragColor=texture2D(u_Texture, v_Texcoord)*v_Color;\n  gl_FragColor=gl_FragColor*u_Albedo;\n}\n\n",M.preCompile(o,4096,e,t,n),M.preCompile(o,8192,e,t,n),n={a_Position:"POSITION",a_Color:"COLOR",a_Texcoord0:"UV",a_TexcoordNext0:"NEXTUV",a_Texcoord1:"UV1",a_TexcoordNext1:"NEXTUV1",u_DiffuseTexture:"DIFFUSETEXTURE",u_SpecularTexture:"SPECULARTEXTURE",u_MvpMatrix:"MVPMATRIX",u_FogStart:"FOGSTART",u_FogRange:"FOGRANGE",u_FogColor:"FOGCOLOR",u_Albedo:"ALBEDO",u_UVAge:"FLOAT0",u_UVAniAge:"UVAGEX"};var h=M.nameKey.add("SIMPLE_EFFECT");e="attribute vec4 a_Position;\nuniform mat4 u_MvpMatrix;\n\n#ifdef DIFFUSEMAP\nattribute vec2 a_Texcoord0;\nattribute vec2 a_Texcoord1;\nvarying vec2 v_Texcoord0;\nvarying vec2 v_Texcoord1;\n#ifdef MIXUV\nattribute vec2 a_TexcoordNext0;\nattribute vec2 a_TexcoordNext1;\nuniform float  u_UVAge;\n#endif\n#endif\n\n#ifdef COLOR\nattribute vec4 a_Color;\nvarying vec4 v_Color;\n#endif\n\n\nvoid main()\n{\n gl_Position = u_MvpMatrix * a_Position;\n \n \n #ifdef DIFFUSEMAP\n  #ifdef MIXUV\n  v_Texcoord0=mix(a_Texcoord0,a_TexcoordNext0,u_UVAge);\n   v_Texcoord1=mix(a_Texcoord1,a_TexcoordNext1,u_UVAge);\n  #else\n  v_Texcoord0=a_Texcoord0;\n  v_Texcoord1=a_Texcoord1;\n  #endif\n #endif\n  \n #ifdef COLOR\n v_Color=a_Color;\n #endif\n}",t="#ifdef FSHIGHPRECISION\nprecision highp float;\n#else\nprecision mediump float;\n#endif\n\nuniform float u_Luminance;\n\n#ifdef DIFFUSEMAP\nvarying vec2 v_Texcoord0;\nuniform sampler2D u_DiffuseTexture;\n#endif\n\n#ifdef SPECULARMAP \nvarying vec2 v_Texcoord1;\nuniform sampler2D u_SpecularTexture;\n#endif\n\n#ifdef COLOR\nvarying vec4 v_Color;\n#endif\n\n\n\n#ifdef FOG\nuniform float u_FogStart;\nuniform float u_FogRange;\nuniform vec3 u_FogColor;\n#endif\n\nvoid main()\n{\n  \n  #ifdef DIFFUSEMAP&&!COLOR\n  gl_FragColor=texture2D(u_DiffuseTexture, v_Texcoord0);\n  #endif \n  \n  #ifdef COLOR&&!DIFFUSEMAP\n  gl_FragColor=v_Color;\n  #endif \n  \n  #ifdef DIFFUSEMAP&&COLOR\n  vec4 texColor=texture2D(u_DiffuseTexture, v_Texcoord0);\n  gl_FragColor=texColor*v_Color;\n  #endif\n  \n  #ifdef SPECULARMAP \n  vec4 specularColor=texture2D(u_SpecularTexture, v_Texcoord1);\n  gl_FragColor=gl_FragColor*specularColor;\n  #endif\n \n  gl_FragColor.rgb=gl_FragColor.rgb*u_Luminance;\n  \n  #ifdef FOG\n  float lerpFact=clamp((toEyeLength-u_FogStart)/u_FogRange,0.0,1.0);\n  gl_FragColor.rgb=mix(gl_FragColor.rgb,u_FogColor,lerpFact);\n  #endif\n}\n\n",M.preCompile(h,4096,e,t,n),e="attribute vec4 a_Position;\nuniform mat4 u_MvpMatrix;\n\n#ifdef DIFFUSEMAP\nattribute vec2 a_Texcoord0;\nattribute vec2 a_Texcoord1;\nvarying vec2 v_Texcoord0;\nvarying vec2 v_Texcoord1;\n#ifdef MIXUV\nattribute vec2 a_TexcoordNext0;\nattribute vec2 a_TexcoordNext1;\nuniform float  u_UVAge;\n#endif\n#endif\n\n#ifdef COLOR\nattribute vec4 a_Color;\nvarying vec4 v_Color;\n#endif\n\n\nvoid main()\n{\n gl_Position = u_MvpMatrix * a_Position;\n \n \n #ifdef DIFFUSEMAP\n  #ifdef MIXUV\n  v_Texcoord0=mix(a_Texcoord0,a_TexcoordNext0,u_UVAge);\n   v_Texcoord1=mix(a_Texcoord1,a_TexcoordNext1,u_UVAge);\n  #else\n  v_Texcoord0=a_Texcoord0;\n  v_Texcoord1=a_Texcoord1;\n  #endif\n #endif\n  \n #ifdef COLOR\n v_Color=a_Color;\n #endif\n}",t="#ifdef FSHIGHPRECISION\nprecision highp float;\n#else\nprecision mediump float;\n#endif\n\nuniform float u_Luminance;\n\n#ifdef DIFFUSEMAP\nvarying vec2 v_Texcoord0;\nuniform sampler2D u_DiffuseTexture;\n#endif\n\n#ifdef SPECULARMAP \nvarying vec2 v_Texcoord1;\nuniform sampler2D u_SpecularTexture;\n#endif\n\n#ifdef COLOR\nvarying vec4 v_Color;\n#endif\n\n\n\n#ifdef FOG\nuniform float u_FogStart;\nuniform float u_FogRange;\nuniform vec3 u_FogColor;\n#endif\n\nvoid main()\n{\n  \n  #ifdef DIFFUSEMAP&&!COLOR\n  gl_FragColor=texture2D(u_DiffuseTexture, v_Texcoord0);\n  #endif \n  \n  #ifdef COLOR&&!DIFFUSEMAP\n  gl_FragColor=v_Color;\n  #endif \n  \n  #ifdef DIFFUSEMAP&&COLOR\n  vec4 texColor=texture2D(u_DiffuseTexture, v_Texcoord0);\n  gl_FragColor=texColor*v_Color;\n  #endif\n  \n  #ifdef SPECULARMAP \n  vec4 specularColor=texture2D(u_SpecularTexture, v_Texcoord1);\n  gl_FragColor=gl_FragColor*specularColor;\n  #endif\n \n  gl_FragColor.rgb=gl_FragColor.rgb*u_Luminance;\n  \n  #ifdef FOG\n  float lerpFact=clamp((toEyeLength-u_FogStart)/u_FogRange,0.0,1.0);\n  gl_FragColor.rgb=mix(gl_FragColor.rgb,u_FogColor,lerpFact);\n  #endif\n}\n\n",M.preCompile(h,8192,e,t,n),n={a_Position:"POSITION",u_MvpMatrix:"MVPMATRIX",u_Intensity:"INTENSITY",u_AlphaBlending:"ALPHABLENDING",u_CubeTexture:"DIFFUSETEXTURE"};var l=M.nameKey.add("SkyBox");e="attribute vec4 a_Position;\nuniform mat4 u_MvpMatrix;\nvarying vec3 v_Texcoord;\n\n\nvoid main()\n{\n  gl_Position = (u_MvpMatrix*a_Position).xyww;\n  v_Texcoord=a_Position.xyz;\n}\n",t="#ifdef FSHIGHPRECISION\nprecision highp float;\n#else\nprecision mediump float;\n#endif\n\nuniform float u_Intensity;\nuniform float u_AlphaBlending;\nuniform samplerCube u_CubeTexture;\n\nvarying vec3 v_Texcoord;\n\n\nvoid main()\n{	\n  gl_FragColor=vec4(textureCube(u_CubeTexture, v_Texcoord).rgb*u_Intensity,u_AlphaBlending);\n}\n\n",M.preCompile(l,4096,e,t,n),e="attribute vec4 a_Position;\nuniform mat4 u_MvpMatrix;\nvarying vec3 v_Texcoord;\n\n\nvoid main()\n{\n  gl_Position = (u_MvpMatrix*a_Position).xyww;\n  v_Texcoord=a_Position.xyz;\n}\n",t="#ifdef FSHIGHPRECISION\nprecision highp float;\n#else\nprecision mediump float;\n#endif\n\nuniform float u_Intensity;\nuniform float u_AlphaBlending;\nuniform samplerCube u_CubeTexture;\n\nvarying vec3 v_Texcoord;\n\n\nvoid main()\n{	\n  gl_FragColor=vec4(textureCube(u_CubeTexture, v_Texcoord).rgb*u_Intensity,u_AlphaBlending);\n}\n\n",M.preCompile(l,8192,e,t,n),n={a_Position:"POSITION",a_Texcoord0:"UV",u_MvpMatrix:"MVPMATRIX",u_Intensity:"INTENSITY",u_AlphaBlending:"ALPHABLENDING",u_texture:"DIFFUSETEXTURE"};var u=M.nameKey.add("SkyDome");e="attribute vec4 a_Position;\nattribute vec2 a_Texcoord0;\nuniform mat4 u_MvpMatrix;\nvarying vec2 v_Texcoord;\n\n\nvoid main()\n{\n  gl_Position = (u_MvpMatrix*a_Position).xyww;\n  v_Texcoord = a_Texcoord0;\n}\n",t="#ifdef FSHIGHPRECISION\nprecision highp float;\n#else\nprecision mediump float;\n#endif\n\nuniform float u_Intensity;\nuniform float u_AlphaBlending;\nuniform sampler2D u_texture;\n\nvarying vec2 v_Texcoord;\n\n\nvoid main()\n{	\n  gl_FragColor=vec4(texture2D(u_texture, v_Texcoord).rgb*u_Intensity,u_AlphaBlending);\n}\n\n",M.preCompile(u,4096,e,t,n),e="attribute vec4 a_Position;\nattribute vec2 a_Texcoord0;\nuniform mat4 u_MvpMatrix;\nvarying vec2 v_Texcoord;\n\n\nvoid main()\n{\n  gl_Position = (u_MvpMatrix*a_Position).xyww;\n  v_Texcoord = a_Texcoord0;\n}\n",t="#ifdef FSHIGHPRECISION\nprecision highp float;\n#else\nprecision mediump float;\n#endif\n\nuniform float u_Intensity;\nuniform float u_AlphaBlending;\nuniform sampler2D u_texture;\n\nvarying vec2 v_Texcoord;\n\n\nvoid main()\n{	\n  gl_FragColor=vec4(texture2D(u_texture, v_Texcoord).rgb*u_Intensity,u_AlphaBlending);\n}\n\n",M.preCompile(u,8192,e,t,n)},e._regClassforJson=function(){_.regClass("Sprite3D",Ge),_.regClass("MeshSprite3D",tt),_.regClass("Material",Ne)},e._loadTexture2D=function(e){var t=e.url,n=A.basePath;A.basePath=A.getPath(t);var i=new ot(t);A.basePath=n,i.on("loaded",null,function(t){e.endLoad(t)})},e._loadTextureCube=function(e){var t=e.url.split(","),n=A.basePath;A.basePath=A.getPath(t[0]);var i=new ht(t);A.basePath=n,i.on("loaded",null,function(t){e.endLoad(t)})},e.init=function(t,i,r){return void 0===r&&(r=!1),R.enable()?(g.parserMap.texture2d=e._loadTexture2D,g.parserMap.texturecube=e._loadTextureCube,D.changeWebGLSize=function(e,t){R.onStageResize(e,t),H.clientWidth=e,H.clientHeight=t},c.isAntialias=r,b.is3DMode=!0,n.init(t,i),B.__init__(),Ue.__init__(),e._initShader(),void e._regClassforJson()):void alert("Laya3D init err,must support webGL!")},e}(),function(e){function t(){this._id=0,this._cachedOwnerLayerMask=0,this._cachedOwnerEnable=!1,this._enable=!1,this._owner=null,this.started=!1,t.__super.call(this),this._id=t._uniqueIDCounter,t._uniqueIDCounter++}r(t,"laya.d3.component.Component3D",e);var i=t.prototype;return n.imps(i,{"laya.d3.core.render.IUpdate":!0}),i._onLayerChanged=function(e){this._cachedOwnerLayerMask=e.mask},i._onEnableChanged=function(e){this._cachedOwnerEnable=e},i._initialize=function(e){this._owner=e,this.enable=!0,this.started=!1,this._cachedOwnerLayerMask=e.layer.mask,this._owner.on("layerchanged",this,this._onLayerChanged),this._cachedOwnerEnable=e.enable,this._owner.on("enabledchanged",this,this._onEnableChanged),this._load(e)},i._uninitialize=function(){this._unload(this.owner),this._owner.off("layerchanged",this,this._onLayerChanged),this._owner.off("enabledchanged",this,this._onEnableChanged),this._owner=null},i._load=function(e){},i._start=function(e){},i._update=function(e){},i._lateUpdate=function(e){},i._preRenderUpdate=function(e){},i._postRenderUpdate=function(e){},i._unload=function(e){},a(0,i,"id",function(){return this._id}),a(0,i,"owner",function(){return this._owner}),a(0,i,"enable",function(){return this._enable},function(e){this._enable!==e&&(this._enable=e,this.event("enabledchanged",this._enable))}),a(0,i,"isActive",function(){return B.isActive(this._cachedOwnerLayerMask)&&this._cachedOwnerEnable&&this._enable}),a(0,i,"isVisible",function(){return B.isVisible(this._cachedOwnerLayerMask)&&this._cachedOwnerEnable&&this._enable}),t._uniqueIDCounter=1,t}(f)),Oe=function(e){function t(e){this._owner=null,this._enable=!1,this._renderCullingObject=null,this._materials=null,this._boundingSphereNeedChange=!1,this._boundingBoxNeedChange=!1,this._boundingSphere=null,this._boundingBox=null,t.__super.call(this),this._owner=e,this._enable=!0,this._boundingBox=new me(new De,new De),this._boundingSphere=new ve(new De,0),this._boundingSphereNeedChange=!0,this._boundingBoxNeedChange=!0,this._renderCullingObject=new W,this._renderCullingObject._render=this,this._renderCullingObject._layerMask=this._owner.layer.mask,this._renderCullingObject._ownerEnable=this._owner.enable,this._renderCullingObject._enable=this._enable,this._materials=[],this._owner.transform.on("worldmatrixneedchanged",this,this._onWorldMatNeedChange),this._owner.on("layerchanged",this,this._onOwnerLayerChanged),this._owner.on("enabledchanged",this,this._onOwnerEnableChanged),this.on("enabledchanged",this,this._onEnableChanged)}r(t,"laya.d3.core.render.BaseRender",e);var i=t.prototype;return n.imps(i,{"laya.resource.IDispose":!0}),i._onWorldMatNeedChange=function(){this._boundingSphereNeedChange=!0,this._boundingBoxNeedChange=!0},i._onOwnerLayerChanged=function(e){this._renderCullingObject._layerMask=e.mask},i._onOwnerEnableChanged=function(e){this._renderCullingObject._ownerEnable=e},i._onEnableChanged=function(e,t){this._renderCullingObject._enable=t},i._calculateBoundingSphere=function(){throw"BaseRender: must override it."},i._calculateBoundingBox=function(){throw"BaseRender: must override it."},i.dispose=function(){this._owner.transform.off("worldmatrixneedchanged",this,this._onWorldMatNeedChange),this._owner.off("layerchanged",this,this._onOwnerLayerChanged),this._owner.off("enabledchanged",this,this._onOwnerEnableChanged),this.off("enabledchanged",this,this._onEnableChanged)},a(0,i,"enable",function(){return this._enable},function(e){this._enable=e,this.event("enabledchanged",[this,e])}),a(0,i,"material",function(){var e=this._materials[0];if(e&&!e._isInstance){var t=new e.constructor;e.copy(t),t.name=t.name+"(Instance)",t._isInstance=!0,this._materials[0]=t,this.event("materialchanged",[this,0,t])}return this._materials[0]},function(e){this._materials[0]=e,this.event("materialchanged",[this,0,e])}),a(0,i,"renderCullingObject",function(){return this._renderCullingObject}),a(0,i,"boundingBox",function(){return this._boundingBoxNeedChange&&(this._calculateBoundingBox(),this._boundingBoxNeedChange=!1),this._boundingBox}),a(0,i,"materials",function(){for(var e=0,t=this._materials.length;t>e;e++){var n=this._materials[e];if(!n._isInstance){var i=new n.constructor;n.copy(i),i.name=i.name+"(Instance)",i._isInstance=!0,this._materials[e]=i,this.event("materialchanged",[this,e,i])}}return this._materials.slice()},function(e){if(!e)throw new Error("MeshRender: materials value can't be null.");this._materials=e;for(var t=0,n=e.length;n>t;t++)this.event("materialchanged",[this,t,e[t]])}),a(0,i,"sharedMaterial",function(){return this._materials[0]},function(e){this._materials[0]=e,this.event("materialchanged",[this,0,e])}),a(0,i,"boundingSphere",function(){return this._boundingSphereNeedChange&&(this._calculateBoundingSphere(),this._boundingSphereNeedChange=!1),this._boundingSphere}),a(0,i,"sharedMaterials",function(){var e=this._materials.slice();
return e},function(e){if(!e)throw new Error("MeshRender: shadredMaterials value can't be null.");this._materials=e;for(var t=0,n=e.length;n>t;t++)this.event("materialchanged",[this,t,e[t]])}),t}(f),Ne=function(e){function t(){this._id=0,this._loaded=!0,this._renderQueue=0,this._renderMode=0,this._sharderNameID=0,this._shaderDefine=0,this._disableShaderDefine=0,this._shaderValues=null,this._texturesloaded=!1,this._textures=null,this._colors=null,this._numbers=null,this._matrix4x4s=null,this._textureSharderIndices=null,this._colorSharderIndices=null,this._numberSharderIndices=null,this._matrix4x4SharderIndices=null,this._isInstance=!1,this.name=null,this.shader=null,t.__super.call(this),this._id=++t._uniqueIDCounter,this._shaderDefine=0,this._disableShaderDefine=0,this._shaderValues=new P,this._textures=[],this._colors=[],this._numbers=[],this._matrix4x4s=[],this._textureSharderIndices=[],this._colorSharderIndices=[],this._numberSharderIndices=[],this._matrix4x4SharderIndices=[],this.renderMode=1}r(t,"laya.d3.core.material.BaseMaterial",e);var n=t.prototype;return n._eventLoaded=function(){this._loaded=!0,this.event("loaded",this)},n._textureLoadCompleted=function(){var e,t=0,n=0;for(t=0,n=this._textures.length;n>t;t++)if(e=this._textures[t],e&&!e.loaded)return!1;for(t=0,n=this._textures.length;n>t;t++)e=this._textures[t],e&&(e.source?this._uploadTexture(t,e):this._uploadTexture(t,st.pickTexture));return this._texturesloaded=!0},n._getShader=function(e,t){var n=e.shaderDefs,i=e.shaderDefs._value;i|=t.shaderDefine|this._shaderDefine,this._disableShaderDefine&&(i&=~this._disableShaderDefine),n._value=i;var r=(n._value|e.shadingMode)+2e-4*this._sharderNameID;this.shader=M.withCompile(this._sharderNameID,e.shadingMode,n.toNameDic(),r,null)},n._uploadTexture=function(e,t){var n=this._shaderValues;n.data[this._textureSharderIndices[e]]=t.source},n._addShaderDefine=function(e){this._shaderDefine|=e},n._removeShaderDefine=function(e){this._shaderDefine&=~e},n._addDisableShaderDefine=function(e){this._disableShaderDefine|=e},n._removeDisableShaderDefine=function(e){this._disableShaderDefine&=~e},n._setMatrix4x4=function(e,t,n){var i=this._shaderValues,r=this._matrix4x4SharderIndices[e];!r&&n&&(this._matrix4x4SharderIndices[e]=r=i.length+1,i.pushValue(t,null)),i.data[r]=n.elements,this._matrix4x4s[e]=n},n._getMatrix4x4=function(e){return this._matrix4x4s[e]},n._setNumber=function(e,t,n){var i=this._shaderValues,r=this._numberSharderIndices[e];!r&&n&&(this._numberSharderIndices[e]=r=i.length+1,i.pushValue(t,null)),i.data[r]=n,this._numbers[e]=n},n._getNumber=function(e){return this._numbers[e]},n._setColor=function(e,t,n){var i=this._shaderValues,r=this._colorSharderIndices[e];!r&&n&&(this._colorSharderIndices[e]=r=i.length+1,i.pushValue(t,null)),i.data[r]=n.elements,this._colors[e]=n},n._getColor=function(e){return this._colors[e]},n._setTexture=function(e,t,n){var i=this._shaderValues,r=this._textureSharderIndices[t];!r&&e&&(this._textureSharderIndices[t]=r=i.length+1,i.pushValue(n,null)),this._textures[t]=e,e&&(this._texturesloaded=!1)},n._getTexture=function(e){return this._textures[e]},n._upload=function(e,t,n){if(!this._textureLoadCompleted())return!1;this._getShader(e,t);var i=e.shaderValue;return i.pushArray(this._shaderValues),this.shader.uploadArray(i.data,i.length,n),!0},n.setShaderName=function(e){this._sharderNameID=M.nameKey.get(e)},n._setLoopShaderParams=function(e,t,n,i,r){throw new Error("Marterial:must override it.")},n.copy=function(e){return e._loaded=this._loaded,e._renderQueue=this._renderQueue,e._renderMode=this._renderMode,e._textures=this._textures.slice(),e._colors=this._colors.slice(),e._numbers=this._numbers.slice(),e._matrix4x4s=this._matrix4x4s.slice(),e._textureSharderIndices=this._textureSharderIndices.slice(),e._colorSharderIndices=this._colorSharderIndices.slice(),e._numberSharderIndices=this._numberSharderIndices.slice(),e._matrix4x4SharderIndices=this._matrix4x4SharderIndices.slice(),e._texturesloaded=this._texturesloaded,e.shader=this.shader,e._sharderNameID=this._sharderNameID,e._disableShaderDefine=this._disableShaderDefine,e._shaderDefine=this._shaderDefine,e.name=this.name,this._shaderValues.copyTo(e._shaderValues),e},a(0,n,"id",function(){return this._id}),a(0,n,"loaded",function(){return this._loaded}),a(0,n,"renderQueue",function(){return this._renderQueue}),a(0,n,"renderMode",function(){return this._renderMode},function(e){switch(this._renderMode=e,e){case 1:this._renderQueue=1,this.event("renderqueuechanged",this);break;case 2:this._renderQueue=2,this.event("renderqueuechanged",this);break;case 3:this._renderQueue=1,this.event("renderqueuechanged",this);break;case 4:this._renderQueue=2,this.event("renderqueuechanged",this);break;case 13:this._renderQueue=3,this.event("renderqueuechanged",this);break;case 14:this._renderQueue=4,this.event("renderqueuechanged",this);break;case 15:this._renderQueue=5,this.event("renderqueuechanged",this);break;case 16:this._renderQueue=6,this.event("renderqueuechanged",this);break;case 5:this._renderQueue=7,this.event("renderqueuechanged",this);break;case 6:this._renderQueue=8,this.event("renderqueuechanged",this);break;case 7:this._renderQueue=9,this.event("renderqueuechanged",this);break;case 8:this._renderQueue=10,this.event("renderqueuechanged",this);break;case 9:this._renderQueue=11,this.event("renderqueuechanged",this);break;case 10:this._renderQueue=12,this.event("renderqueuechanged",this);break;case 11:this._renderQueue=13,this.event("renderqueuechanged",this);break;case 12:this._renderQueue=14,this.event("renderqueuechanged",this);break;default:throw new Error("Material:renderMode value error.")}3===this._renderMode||4===this._renderMode?this._shaderDefine|=2048:this._shaderDefine=-2049&this._shaderDefine}),t.createFromFile=function(e,t){t._loaded=!1;var n=new g,i=function(n){var i=A.basePath;A.basePath=A.getPath(A.formatURL(e)),_.createByJson(n,t,null,m.create(null,Se._parseMaterial,null,!1)),A.basePath=i,t._eventLoaded()};n.once("complete",null,i),n.load(e,"json")},t._uniqueIDCounter=0,t.RENDERMODE_OPAQUE=1,t.RENDERMODE_OPAQUEDOUBLEFACE=2,t.RENDERMODE_CUTOUT=3,t.RENDERMODE_CUTOUTDOUBLEFACE=4,t.RENDERMODE_TRANSPARENT=13,t.RENDERMODE_TRANSPARENTDOUBLEFACE=14,t.RENDERMODE_ADDTIVE=15,t.RENDERMODE_ADDTIVEDOUBLEFACE=16,t.RENDERMODE_DEPTHREAD_TRANSPARENT=5,t.RENDERMODE_DEPTHREAD_TRANSPARENTDOUBLEFACE=6,t.RENDERMODE_DEPTHREAD_ADDTIVE=7,t.RENDERMODE_DEPTHREAD_ADDTIVEDOUBLEFACE=8,t.RENDERMODE_NONDEPTH_TRANSPARENT=9,t.RENDERMODE_NONDEPTH_TRANSPARENTDOUBLEFACE=10,t.RENDERMODE_NONDEPTH_ADDTIVE=11,t.RENDERMODE_NONDEPTH_ADDTIVEDOUBLEFACE=12,t}(f),Le=function(e){function t(e){this._owner=null,this._sharedMesh=null,t.__super.call(this),this._owner=e}r(t,"laya.d3.core.MeshFilter",e);var n=t.prototype;return a(0,n,"sharedMesh",function(){return this._sharedMesh},function(e){var t=this._sharedMesh;this._sharedMesh=e,this.event("meshchanged",[this,t,e])}),t}(f),Be=function(e){function t(e){this._owner=null,this._preWorldTransformModifyID=-1,this._localUpdate=!1,this._worldUpdate=!0,this._parent=null,t.__super.call(this),this._tempMatrix0=new Te,this._tempQuaternion0=new be,this._tempVector30=new De,this._localPosition=new De,this._localRotation=new be(0,0,0,1),this._localScale=new De(1,1,1),this._localMatrix=new Te,this._position=new De,this._rotation=new be(0,0,0,1),this._scale=new De(1,1,1),this._worldMatrix=new Te,this._forward=new De,this._up=new De,this._right=new De,this._owner=e}r(t,"laya.d3.core.Transform3D",e);var n=t.prototype;return n._updateLocalMatrix=function(){Te.createAffineTransformation(this._localPosition,this._localRotation,this._localScale,this._localMatrix)},n._onLocalTransform=function(){this._localUpdate=!0},n._onWorldTransform=function(){if(!this._worldUpdate){this._worldUpdate=!0,this.event("worldmatrixneedchanged");for(var e=0,t=this._owner._childs.length;t>e;e++)this._owner._childs[e].transform._onWorldTransform()}},n.translate=function(e,t){void 0===t&&(t=!0),t?(Te.createFromQuaternion(this.localRotation,this._tempMatrix0),De.transformCoordinate(e,this._tempMatrix0,this._tempVector30),De.add(this.localPosition,this._tempVector30,this._localPosition),this.localPosition=this._localPosition):(De.add(this.position,e,this._position),this.position=this._position)},n.rotate=function(e,t,n){void 0===t&&(t=!0),void 0===n&&(n=!0);var i;n?i=e:(De.scale(e,Math.PI/180,this._tempVector30),i=this._tempVector30),be.createFromYawPitchRoll(i.y,i.x,i.z,this._tempQuaternion0),t?(be.multiply(this._localRotation,this._tempQuaternion0,this._localRotation),this.localRotation=this._localRotation):(be.multiply(this._tempQuaternion0,this.rotation,this._rotation),this.rotation=this._rotation)},a(0,n,"localPosition",function(){return this._localPosition},function(e){this._localPosition=e,this._onLocalTransform(),this._onWorldTransform()}),a(0,n,"worldNeedUpdate",function(){return this._worldUpdate}),a(0,n,"position",function(){if(null!==this._parent){var e=this.worldMatrix.elements;this._position.elements[0]=e[12],this._position.elements[1]=e[13],this._position.elements[2]=e[14]}else this._localPosition.cloneTo(this._position);return this._position},function(e){null!==this._parent?(this._parent.worldMatrix.invert(this._tempMatrix0),De.transformCoordinate(e,this._tempMatrix0,this._localPosition),this.localPosition=this._localPosition):(e.cloneTo(this._localPosition),this.localPosition=this._localPosition)}),a(0,n,"worldMatrix",function(){return this._worldUpdate?(null!=this._parent?Te.multiply(this._parent.worldMatrix,this.localMatrix,this._worldMatrix):this.localMatrix.cloneTo(this._worldMatrix),this._worldUpdate=!1,this._worldMatrix):this._worldMatrix},function(e){null===this._parent?this.localMatrix=e:(this._parent.worldMatrix.invert(this._localMatrix),Te.multiply(this._localMatrix,e,this._localMatrix),this.localMatrix=this._localMatrix)}),a(0,n,"localMatrix",function(){return this._localUpdate&&(this._updateLocalMatrix(),this._localUpdate=!1),this._localMatrix},function(e){this._localMatrix=e,this._localMatrix.decompose(this._localPosition,this._localRotation,this._localScale),this._onWorldTransform()}),a(0,n,"localRotation",function(){return this._localRotation},function(e){this._localRotation=e,this._localRotation.normalize(this._localRotation),this._onLocalTransform(),this._onWorldTransform()}),a(0,n,"rotation",function(){return null!==this._parent?this.worldMatrix.decompose(this._position,this._rotation,this._scale):this._localRotation.cloneTo(this._rotation),this._rotation},function(e){null!==this._parent?(this._parent.rotation.invert(this._tempQuaternion0),be.multiply(e,this._tempQuaternion0,this._localRotation),this.localRotation=this._localRotation):(e.cloneTo(this._localRotation),this.localRotation=this._localRotation)}),a(0,n,"localScale",function(){return this._localScale},function(e){this._localScale=e,this._onLocalTransform(),this._onWorldTransform()}),a(0,n,"localRotationEuler",null,function(e){be.createFromYawPitchRoll(e.y,e.x,e.z,this._localRotation),this._onLocalTransform(),this._onWorldTransform()}),a(0,n,"scale",function(){return null!==this._parent?De.multiply(this._parent.scale,this._localScale,this._scale):this._localScale.cloneTo(this._scale),this._scale}),a(0,n,"rotationEuler",null,function(e){be.createFromYawPitchRoll(e.y,e.x,e.z,this._rotation),this.rotation=this._rotation}),a(0,n,"forward",function(){var e=this.worldMatrix.elements;return this._forward.elements[0]=-e[8],this._forward.elements[1]=-e[9],this._forward.elements[2]=-e[10],this._forward}),a(0,n,"parent",null,function(e){this._parent=e,this._onWorldTransform()}),a(0,n,"up",function(){var e=this.worldMatrix.elements;return this._up.elements[0]=e[4],this._up.elements[1]=e[5],this._up.elements[2]=e[6],this._up}),a(0,n,"right",function(){var e=this.worldMatrix.elements;return this._right.elements[0]=e[0],this._right.elements[1]=e[1],this._right.elements[2]=e[2],this._right}),t}(f),Fe=(function(e){function t(){this._rotation=0,this._matNeedUpdte=!1,t.__super.call(this),this._tempTitlingV3=new De,this._tempRotationMatrix=new Te,this._tempTitlingMatrix=new Te,this._matrix=new Te,this._offset=new Ee,this._tiling=new Ee}r(t,"laya.d3.core.TransformUV",e);var n=t.prototype;return n._updateMatrix=function(){this._tempTitlingV3.elements[0]=this._tiling.x,this._tempTitlingV3.elements[1]=this._tiling.y,this._tempTitlingV3.elements[2]=1,Te.createScaling(this._tempTitlingV3,this._tempTitlingMatrix),Te.createRotationZ(this._rotation,this._tempRotationMatrix),Te.multiply(this._tempRotationMatrix,this._tempTitlingMatrix,this._matrix);var e=this._matrix.elements;e[12]=this._offset.x,e[13]=this._offset.y,e[14]=0},a(0,n,"matrix",function(){return this._matNeedUpdte&&(this._updateMatrix(),this._matNeedUpdte=!1),this._matrix}),a(0,n,"offset",function(){return this._offset},function(e){this._offset=e,this._matNeedUpdte=!0}),a(0,n,"rotation",function(){return this._rotation},function(e){this._rotation=e,this._matNeedUpdte=!0}),a(0,n,"tiling",function(){return this._tiling},function(e){this._tiling=e,this._matNeedUpdte=!0}),t}(f),function(e){function t(e,n){this._floatCountPerVertex=6,this._owner=null,this._vertices=null,this._vertexBuffer=null,this._firstActiveElement=0,this._firstNewElement=0,this._firstFreeElement=0,this._firstRetiredElement=0,this._currentTime=NaN,this._drawCounter=0,this.scLeft=null,this.scRight=null,this._numPositionMode=0,this._numPositionVelocityMode=0,this._lastTime=NaN,this._needPatch=!1,this._lastPatchAddPos0=null,this._lastPatchAddPos1=null,this._lastPatchAddTime=NaN,this.setting=null,t.__super.call(this),this._tempVector0=new De,this._tempVector1=new De,this._tempVector2=new De,this._tempVector3=new De,this._albedo=new Me(1,1,1,1),this._posModeLastPosition0=new De,this._posModeLastPosition1=new De,this._posModePosition0=new De,this._posModePosition1=new De,this._posVelModePosition0=new De,this._posVelModeVelocity0=new De,this._posVelModePosition1=new De,this._posVelModeVelocity1=new De,this._owner=e,this._lastTime=0,this._lastPatchAddPos0=new De,this._lastPatchAddPos1=new De,this.scLeft=new N,this.scRight=new N,this._firstActiveElement=0,this._firstNewElement=0,this._firstFreeElement=0,this._firstRetiredElement=0,this._currentTime=0,this._drawCounter=0,this._needPatch=!1,this.setting=n,this._initialize(),this._loadContent(),this._owner.on("enabledchanged",this,this._onEnableChanged)}r(t,"laya.d3.resource.tempelet.GlitterTemplet",e);var i=t.prototype;return n.imps(i,{"laya.d3.core.render.IRenderable":!0}),i._getVertexBuffer=function(e){return void 0===e&&(e=0),0===e?this._vertexBuffer:null},i._getIndexBuffer=function(){return null},i._initialize=function(){this._vertices=new Float32Array(this.setting.maxSegments*this._floatCountPerVertex*2)},i._loadContent=function(){this._vertexBuffer=it.create(Z.vertexDeclaration,2*this.setting.maxSegments,35048)},i._onEnableChanged=function(e){e||(this._numPositionMode=0,this._numPositionVelocityMode=0,this._firstActiveElement=0,this._firstNewElement=0,this._firstFreeElement=0,this._firstRetiredElement=0,this._currentTime=0,this._drawCounter=0)},i._updateTextureCoordinates=function(){this._firstActiveElement<this._firstFreeElement?this._updateSubTextureCoordinates(this._firstActiveElement,2*(this._firstFreeElement-this._firstActiveElement)):(this._updateSubTextureCoordinates(this._firstActiveElement,2*(this.setting.maxSegments-this._firstActiveElement)),this._firstFreeElement>0&&this._updateSubTextureCoordinates(0,2*this._firstFreeElement))},i._updateSubTextureCoordinates=function(e,t){for(var n=2*e,i=0;t>i;i+=2){var r=n+i,a=r*this._floatCountPerVertex,s=(r+1)*this._floatCountPerVertex;this._vertices[a+3]=this._vertices[s+3]=(this._vertices[a+5]-this._currentTime)/this.setting.lifeTime}},i._retireActiveGlitter=function(){for(var e=this.setting.lifeTime,t=2*this._floatCountPerVertex;this._firstActiveElement!=this._firstNewElement;){var n=this._firstActiveElement*t+5,i=this._currentTime-this._vertices[n];if(e>i)break;this._vertices[n]=this._drawCounter,this._firstActiveElement++,this._firstActiveElement>=this.setting.maxSegments&&(this._firstActiveElement=0)}},i._freeRetiredGlitter=function(){for(var e=2*this._floatCountPerVertex;this._firstRetiredElement!=this._firstActiveElement;){var t=this._drawCounter-this._vertices[this._firstRetiredElement*e+5];if(3>t)break;this._firstRetiredElement++,this._firstRetiredElement>=this.setting.maxSegments&&(this._firstRetiredElement=0)}},i._calcVelocity=function(e,t,n){De.subtract(e,t,n),De.scale(n,.5,n)},i._addNewGlitterSegementToVertexBuffer=function(){var e=0;this._firstActiveElement<this._firstFreeElement?(e=2*this._firstActiveElement*this._floatCountPerVertex,this._vertexBuffer.setData(this._vertices,e,e,2*(this._firstFreeElement-this._firstActiveElement)*this._floatCountPerVertex)):(e=2*this._firstActiveElement*this._floatCountPerVertex,this._vertexBuffer.setData(this._vertices,e,e,2*(this.setting.maxSegments-this._firstActiveElement)*this._floatCountPerVertex),this._firstFreeElement>0&&this._vertexBuffer.setData(this._vertices,0,0,2*this._firstFreeElement*this._floatCountPerVertex)),this._firstNewElement=this._firstFreeElement},i._addGlitter=function(e,t,n){this._needPatch&&(this._needPatch=!1,this._addGlitter(this._lastPatchAddPos0,this._lastPatchAddPos1,this._lastPatchAddTime));var i=this._firstFreeElement+1;if(i>=this.setting.maxSegments&&(i=0,e.cloneTo(this._lastPatchAddPos0),t.cloneTo(this._lastPatchAddPos1),this._lastPatchAddTime=n,this._needPatch=!0),i===this._firstRetiredElement)throw new Error("GlitterTemplet:current segement count have large than maxSegments,please adjust the  value of maxSegments or add Glitter Vertex Frequency.");var r=e.elements,a=t.elements,s=0,o=this._firstFreeElement*this._floatCountPerVertex*2;for(s=0;3>s;s++)this._vertices[o+s]=r[s];this._vertices[o+3]=0,this._vertices[o+4]=0,this._vertices[o+5]=n;var h=o+this._floatCountPerVertex;for(s=0;3>s;s++)this._vertices[h+s]=a[s];this._vertices[h+3]=0,this._vertices[h+4]=1,this._vertices[h+5]=n,this._firstFreeElement=i},i._update=function(e){this._currentTime+=e/1e3,this._retireActiveGlitter(),this._freeRetiredGlitter(),this._firstActiveElement==this._firstFreeElement&&(this._currentTime=0),this._firstRetiredElement==this._firstActiveElement&&(this._drawCounter=0),this._updateTextureCoordinates()},i._beforeRender=function(e){return this._firstNewElement!=this._firstFreeElement&&this._addNewGlitterSegementToVertexBuffer(),this._drawCounter++,this._firstActiveElement!=this._firstFreeElement?(this._vertexBuffer.bindWithIndexBuffer(null),!0):!1},i._render=function(e){var t=0,n=R.mainContext;this._firstActiveElement<this._firstFreeElement?(t=2*(this._firstFreeElement-this._firstActiveElement),n.drawArrays(5,2*this._firstActiveElement,t),V.trianglesFaces+=t-2,V.drawCall++):(t=2*(this.setting.maxSegments-this._firstActiveElement),n.drawArrays(5,2*this._firstActiveElement,t),V.trianglesFaces+=t-2,V.drawCall++,this._firstFreeElement>0&&(t=2*this._firstFreeElement,n.drawArrays(5,0,t),V.trianglesFaces+=t-2,V.drawCall++))},i.addVertexPosition=function(e,t){if(this._owner.enable)if(this._numPositionMode<2)0===this._numPositionMode?(e.cloneTo(this._posModeLastPosition0),t.cloneTo(this._posModeLastPosition1)):(e.cloneTo(this._posModePosition0),t.cloneTo(this._posModePosition1)),this._numPositionMode++;else{var n=this._tempVector2;this._calcVelocity(e,this._posModeLastPosition0,n);var i=this._tempVector3;this._calcVelocity(t,this._posModeLastPosition1,i),this.addVertexPositionVelocity(this._posModePosition0,n,this._posModePosition1,i),this._posModePosition0.cloneTo(this._posModeLastPosition0),this._posModePosition1.cloneTo(this._posModeLastPosition1),e.cloneTo(this._posModePosition0),t.cloneTo(this._posModePosition1)}},i.addVertexPositionVelocity=function(e,t,n,i){if(this._owner.enable){if(0===this._numPositionVelocityMode)this._numPositionVelocityMode++;else{var r=this._tempVector0;De.subtract(e,this._posVelModePosition0,r);var a=De.scalarLength(r);De.subtract(n,this._posVelModePosition1,r);var s=De.scalarLength(r),o=0,h=this.setting.minSegmentDistance;if(h>a&&h>s)return;if(o=1+Math.floor(Math.max(a,s)/this.setting.minInterpDistance),1===o)this._addGlitter(e,n,this._currentTime);else{o=Math.min(o,this.setting.maxSlerpCount),this.scLeft.Init(this._posVelModePosition0,this._posVelModeVelocity0,e,t),this.scRight.Init(this._posVelModePosition1,this._posVelModeVelocity1,n,i);for(var l=1/o,u=l,_=this._currentTime-this._lastTime,c=1;o>=c;c++){var d=this._tempVector0;this.scLeft.Slerp(u,d);var f=this._tempVector1;this.scRight.Slerp(u,f);var m=this._lastTime+_*c/o;this._addGlitter(d,f,m),u+=l}}}this._lastTime=this._currentTime,e.cloneTo(this._posVelModePosition0),t.cloneTo(this._posVelModeVelocity0),n.cloneTo(this._posVelModePosition1),i.cloneTo(this._posVelModeVelocity1)}},i.dispose=function(){this._owner.off("enabledchanged",this,this._onEnableChanged)},a(0,i,"indexOfHost",function(){return 0}),a(0,i,"_vertexBufferCount",function(){return 1}),a(0,i,"triangleCount",function(){var e=0;return this._firstActiveElement<this._firstFreeElement?e=2*(this._firstFreeElement-this._firstActiveElement)-2:(e=2*(this.setting.maxSegments-this._firstActiveElement)-2,e+=2*this._firstFreeElement-2),e}),t}(f)),Ue=(function(e){function t(e){this._settings=null,this._particle3D=null,t.__super.call(this),this._resultPosition=new De,this._resultVelocity=new De,this.centerPosition=new De,this.size=new De,this.velocity=new De,this.velocityAddVariance=new De,this._particle3D=e;for(var n=e.templet.settings,i=0;3>i;i++)this.centerPosition.elements[i]=n.boxEmitterCenterPosition[i],this.size.elements[i]=n.boxEmitterSize[i],this.velocity.elements[i]=n.boxEmitterVelocity[i],this.velocityAddVariance.elements[i]=n.boxEmitterVelocityAddVariance[i];this.emissionRate=n.emissionRate}r(t,"laya.d3.core.particle.EmitterBox",e);var n=t.prototype;return n._randomPositionOnBox=function(){var e=this._resultPosition.elements,t=this.centerPosition.elements,n=this.size.elements;return e[0]=t[0]+n[0]*(Math.random()-.5),e[1]=t[1]+n[1]*(Math.random()-.5),e[2]=t[2]+n[2]*(Math.random()-.5),this._resultPosition},n._randomVelocityOnBox=function(){var e=this._resultVelocity.elements,t=this.velocity.elements,n=this.velocityAddVariance.elements;return e[0]=t[0]+n[0]*Math.random(),e[1]=t[1]+n[1]*Math.random(),e[2]=t[2]+n[2]*Math.random(),this._resultVelocity},n.emit=function(){e.prototype.emit.call(this),this._particle3D.templet.addParticle(this._randomPositionOnBox(),this._randomVelocityOnBox())},n.update=function(e){this.advanceTime(e.elapsedTime/1e3)},t}(d),function(e){function t(e){this._settings=null,this._particle3D=null,t.__super.call(this),this._resultPosition=new De,this._resultVelocity=new De,this.position=new De,this.positionVariance=new De,this.velocity=new De,this.velocityAddVariance=new De,this._particle3D=e;for(var n=e.templet.settings,i=0;3>i;i++)this.position.elements[i]=n.pointEmitterPosition[i],this.positionVariance.elements[i]=n.pointEmitterPositionVariance[i],this.velocity.elements[i]=n.pointEmitterVelocity[i],this.velocityAddVariance.elements[i]=n.pointEmitterVelocityAddVariance[i];this.emissionRate=n.emissionRate}r(t,"laya.d3.core.particle.EmitterPoint",e);var n=t.prototype;return n._randomPositionOnPoint=function(){var e=this._resultPosition.elements,t=this.position.elements,n=this.positionVariance.elements;return e[0]=t[0]+n[0]*(Math.random()-.5)*2,e[1]=t[1]+n[1]*(Math.random()-.5)*2,e[2]=t[2]+n[2]*(Math.random()-.5)*2,this._resultPosition},n._randomVelocityOnPoint=function(){var e=this._resultVelocity.elements,t=this.velocity.elements,n=this.velocityAddVariance.elements;return e[0]=t[0]+n[0]*Math.random(),e[1]=t[1]+n[1]*Math.random(),e[2]=t[2]+n[2]*Math.random(),this._resultVelocity},n.emit=function(){e.prototype.emit.call(this),this._particle3D.templet.addParticle(this._randomPositionOnPoint(),this._randomVelocityOnPoint())},n.update=function(e){this.advanceTime(e.elapsedTime/1e3)},t}(d),function(e){function t(e){this._settings=null,this._particle3D=null,this.radius=30,this.velocity=0,this.velocityAddVariance=0,this.up=2,t.__super.call(this),this._resultPosition=new De,this._resultVelocity=new De,this._direction=new De,this.centerPosition=new De,this._particle3D=e;for(var n=e.templet.settings,i=0;3>i;i++)this.centerPosition.elements[i]=n.ringEmitterCenterPosition[i];this.radius=n.ringEmitterRadius,this.velocity=n.ringEmitterVelocity,this.velocityAddVariance=n.ringEmitterVelocityAddVariance,this.emissionRate=n.emissionRate}r(t,"laya.d3.core.particle.EmitterRing",e);var n=t.prototype;return n._randomPointOnRing=function(){var e=Math.random()*Math.PI*2,t=Math.cos(e),n=Math.sin(e),i=this._resultPosition.elements,r=this.centerPosition.elements;switch(this.up){case 0:i[0]=r[0]+0,i[1]=r[1]+t*this.radius,i[2]=r[2]+n*this.radius;break;case 1:i[0]=r[0]+t*this.radius,i[1]=r[1]+0,i[2]=r[2]+n*this.radius;break;case 2:i[0]=r[0]+t*this.radius,i[1]=r[1]+n*this.radius,i[2]=r[2]+0}return this._resultPosition},n._randomVelocityOnRing=function(){var e=this._resultVelocity.elements;this._resultPosition.cloneTo(this._direction),De.normalize(this._direction,this._direction);var t=this._direction.elements;return e[0]=t[0]*(this.velocity+this.velocityAddVariance*Math.random()),e[1]=t[1]*(this.velocity+this.velocityAddVariance*Math.random()),e[2]=t[2]*(this.velocity+this.velocityAddVariance*Math.random()),this._resultVelocity},n.emit=function(){e.prototype.emit.call(this),this._particle3D.templet.addParticle(this._randomPointOnRing(),this._randomVelocityOnRing())},n.update=function(e){this.advanceTime(e/1e3)},t}(d),function(e){function t(e){this._settings=null,this._particle3D=null,this.radius=1,this.velocity=0,this.velocityAddVariance=0,t.__super.call(this),this._reultPosition=new De,this._resultVelocity=new De,this._direction=new De,this.centerPosition=new De,this._particle3D=e;for(var n=e.templet.settings,i=0;3>i;i++)this.centerPosition.elements[i]=n.sphereEmitterCenterPosition[i];this.radius=n.sphereEmitterRadius,this.velocity=n.sphereEmitterVelocity,this.velocityAddVariance=n.sphereEmitterVelocityAddVariance,this.emissionRate=n.emissionRate}r(t,"laya.d3.core.particle.EmitterSphere",e);var n=t.prototype;return n._randomPositionOnSphere=function(){var e=Math.random()*Math.PI*2,t=Math.random()*Math.PI*2,n=Math.cos(e)*this.radius,i=Math.sin(e)*this.radius,r=Math.cos(t)*n,a=Math.sin(t)*n,s=this._reultPosition.elements,o=this.centerPosition.elements;return s[0]=o[0]+r,s[1]=o[1]+i,s[2]=o[2]+a,this._reultPosition},n._randomVelocityOnSphere=function(){var e=this._resultVelocity.elements;this._reultPosition.cloneTo(this._direction),De.normalize(this._direction,this._direction);var t=this._direction.elements;return e[0]=t[0]*(this.velocity+this.velocityAddVariance*Math.random()),e[1]=t[1]*(this.velocity+this.velocityAddVariance*Math.random()),e[2]=t[2]*(this.velocity+this.velocityAddVariance*Math.random()),this._resultVelocity},n.emit=function(){e.prototype.emit.call(this),this._particle3D.templet.addParticle(this._randomPositionOnSphere(),this._randomVelocityOnSphere())},n.update=function(e){this.advanceTime(e.elapsedTime/1e3)},t}(d),function(e){function t(){t.__super.call(this)}r(t,"laya.d3.core.glitter.SplineCurvePosition",e);var n=t.prototype;return n._CalcVelocity=function(e,t,n){De.subtract(e,t,n),De.scale(n,.5,n)},n.Init=function(t,n,i,r){this._CalcVelocity(n,t,this._tempVector30),this._CalcVelocity(r,i,this._tempVector31),e.prototype.Init.call(this,n,this._tempVector30,r,this._tempVector31)},t}(N),function(e){function t(){t.__super.call(this,t._name2int,t._int2name,t._int2nameMap)}return r(t,"laya.d3.shader.ShaderDefines3D",e),t.__init__=function(){t.reg("FSHIGHPRECISION",1048576),t.reg("DIFFUSEMAP",1),t.reg("NORMALMAP",2),t.reg("SPECULARMAP",4),t.reg("EMISSIVEMAP",8),t.reg("AMBIENTMAP",16),t.reg("REFLECTMAP",262144),t.reg("PARTICLE3D",32768),t.reg("COLOR",32),t.reg("UV",2097152),t.reg("VERTEXSHADERING",4096),t.reg("PIXELSHADERING",8192),t.reg("SKINNED",1024),t.reg("DIRECTIONLIGHT",64),t.reg("POINTLIGHT",128),t.reg("SPOTLIGHT",256),t.reg("BONE",512),t.reg("ALPHATEST",2048),t.reg("UVTRANSFORM",16384),t.reg("MIXUV",65536),t.reg("FOG",131072),t.reg("VR",524288)},t.reg=function(e,n){y._reg(e,n,t._name2int,t._int2name)},t.toText=function(e,t,n){return y._toText(e,t,n)},t.toInt=function(e){return y._toInt(e,t._name2int)},t.DIFFUSEMAP=1,t.NORMALMAP=2,t.SPECULARMAP=4,t.EMISSIVEMAP=8,t.AMBIENTMAP=16,t.REFLECTMAP=262144,t.VR=524288,t.FSHIGHPRECISION=1048576,t.UVTRANSFORM=16384,t.MIXUV=65536,t.FOG=131072,t.UV=2097152,t.COLOR=32,t.DIRECTIONLIGHT=64,t.POINTLIGHT=128,t.SPOTLIGHT=256,t.BONE=512,t.SKINNED=1024,t.ALPHATEST=2048,t.PARTICLE3D=32768,t.VERTEXSHADERING=4096,t.PIXELSHADERING=8192,t._name2int={},t._int2name=[],t._int2nameMap=[],t}(y)),Ge=function(e){function t(e){this._isInStage=!1,this._id=0,this._enable=!1,this._layerMask=0,this._componentsMap=[],this.transform=null,this.isStatic=!1,t.__super.call(this),this._components=[],e?this.name=e:this.name="Sprite3D-"+t._nameNumberCounter++,this._enable=!0,this._id=t._uniqueIDCounter,t._uniqueIDCounter++,this.layer=B.currentCreationLayer,this.transform=new Be(this),this.on("added",this,this._onAdded),this.on("removed",this,this._onRemoved)}r(t,"laya.d3.core.Sprite3D",e);var i=t.prototype;return n.imps(i,{"laya.d3.core.render.IUpdate":!0,"laya.resource.IDispose":!0}),i._onAdded=function(){this.transform.parent=this._parent.transform;var e=n.stage.contains(this);e&&this._addSelfAndChildrenRenderObjects(),e&&this._changeSelfAndChildrenInStage(!0)},i._onRemoved=function(){this.transform.parent=null;var e=n.stage.contains(this);e&&this._clearSelfAndChildrenRenderObjects(),e&&this._changeSelfAndChildrenInStage(!1)},i._changeSelfAndChildrenInStage=function(e){this._isInStage=e,this.event("instagechanged",e);for(var t=this._childs,n=0,i=t.length;i>n;n++)this._childs[n]._changeSelfAndChildrenInStage(e)},i._clearSelfRenderObjects=function(){},i._addSelfRenderObjects=function(){},i._clearSelfAndChildrenRenderObjects=function(){this._clearSelfRenderObjects();for(var e=0,t=this._childs.length;t>e;e++)this._childs[e]._clearSelfAndChildrenRenderObjects()},i._addSelfAndChildrenRenderObjects=function(){this._addSelfRenderObjects();for(var e=0,t=this._childs.length;t>e;e++)this._childs[e]._addSelfAndChildrenRenderObjects()},i._updateComponents=function(e){for(var t=0,n=this._components.length;n>t;t++){var i=this._components[t];!i.started&&(i._start(e),i.started=!0),i.isActive&&i._update(e)}},i._lateUpdateComponents=function(e){for(var t=0;t<this._components.length;t++){var n=this._components[t];!n.started&&(n._start(e),n.started=!0),n.isActive&&n._lateUpdate(e)}},i._updateChilds=function(e){var t=this._childs.length;if(0!==t)for(var n=0;t>n;++n){var i=this._childs[n];i._update(e)}},i._getSortID=function(e,t){return+e._getVertexBuffer().vertexDeclaration.id+1e3*t.id},i._update=function(e){e.owner=this,this._enable&&(this._updateComponents(e),this._lateUpdateComponents(e)),V.spriteCount++,this._childs.length&&this._updateChilds(e)},i.addChildAt=function(t,n){if(!(t instanceof laya.d3.core.Sprite3D))throw new Error("Sprite3D:Node type must Sprite3D.");return e.prototype.addChildAt.call(this,t,n)},i.addChild=function(t){if(!(t instanceof laya.d3.core.Sprite3D))throw new Error("Sprite3D:Node type must Sprite3D.");return e.prototype.addChild.call(this,t)},i.addComponent=function(e){if(void 0!==this._componentsMap[e])throw new Error("无法创建"+e+"组件，"+e+"组件已存在！");var t=_.getInstance(e);return t._initialize(this),this._componentsMap[e]=this._components.length,this._components.push(t),this.event("componentadded",t),t},i.getComponentByType=function(e){return void 0===this._componentsMap[e]?null:this._components[this._componentsMap[e]]},i.getComponentByIndex=function(e){return this._components[e]},i.removeComponent=function(e){if(void 0!==this._componentsMap[e]){var t=this._components[this._componentsMap[e]];this._components.splice(this._componentsMap[e],1),
delete this._componentsMap[e],this.event("componentremoved",t)}},i.removeAllComponent=function(){for(var e in this._componentsMap)this.removeComponent(e)},i.loadHierarchy=function(e){var t=this;if(null!==e){var n=new g;e=A.formatURL(e);var i=this,r=function(n){var r=A.basePath;A.basePath=A.getPath(A.formatURL(e));var a=_.createByJson(n,null,i,m.create(null,Se._parseHierarchyProp,null,!1),m.create(null,Se._parseHierarchyNode,null,!1));t.addChild(a),A.basePath=r,t.event("hierarchyloaded",[i,a])};n.once("complete",null,r),n.load(e,"text")}},i.dispose=function(){this.off("added",this,this._onAdded),this.off("removed",this,this._onRemoved);for(var e=0,t=this._components.length;t>e;e++)this._components[e]._uninitialize()},a(0,i,"id",function(){return this._id}),a(0,i,"isInStage",function(){return this._isInStage}),a(0,i,"enable",function(){return this._enable},function(e){this._enable!==e&&(this._enable=e,this.event("enabledchanged",this._enable))}),a(0,i,"active",function(){return B.isActive(this._layerMask)&&this._enable}),a(0,i,"visible",function(){return B.isVisible(this._layerMask)&&this._enable}),a(0,i,"layer",function(){return B.getLayerByMask(this._layerMask)},function(e){this._layerMask=e.mask,this.event("layerchanged",e)}),a(0,i,"componentsCount",function(){return this._components.length}),a(0,i,"scene",function(){return this.parent?this.parent.scene:null}),t._uniqueIDCounter=1,t._nameNumberCounter=0,t}(x),He=function(e){function t(){this._width=0,this._height=0,this._size=null,this._repeat=!1,this._mipmap=!1,this._minFifter=0,this._magFifter=0,this._source=null,this._loaded=!1,t.__super.call(this),this._repeat=!0,this._mipmap=!0,this._minFifter=-1,this._magFifter=-1}r(t,"laya.d3.resource.BaseTexture",e);var n=t.prototype;return a(0,n,"magFifter",function(){return this._magFifter}),a(0,n,"width",function(){return this._width}),a(0,n,"repeat",function(){return this._repeat}),a(0,n,"source",function(){return this.activeResource(),this._source}),a(0,n,"height",function(){return this._height}),a(0,n,"loaded",function(){return this._loaded}),a(0,n,"size",function(){return this._size}),a(0,n,"mipmap",function(){return this._mipmap}),a(0,n,"minFifter",function(){return this._minFifter}),t}(E),je=function(e){function t(){this._loaded=!1,this._subMeshCount=0,this._boundingBox=null,this._boundingSphere=null,t.__super.call(this),this._loaded=!1}r(t,"laya.d3.resource.models.BaseMesh",e);var n=t.prototype;return n.getRenderElementsCount=function(){throw new Error("未Override,请重载该属性！")},n.getRenderElement=function(e){throw new Error("未Override,请重载该属性！")},n.Render=function(){throw new Error("未Override,请重载该方法！")},n.RenderSubMesh=function(e){throw new Error("未Override,请重载该方法！")},a(0,n,"loaded",function(){return this._loaded}),a(0,n,"subMeshCount",function(){return this._subMeshCount}),a(0,n,"boundingBox",function(){return this._boundingBox}),a(0,n,"boundingSphere",function(){return this._boundingSphere}),a(0,n,"positions",function(){throw new Error("未Override,请重载该属性！")}),t}(E),ke=function(e){function t(){t.__super.call(this)}r(t,"laya.d3.resource.models.Sky",e);var n=t.prototype;return n._render=function(e){},t}(E),ze=function(e){function t(){this._url=null,this._player=null,this._templet=null,t.__super.call(this),this._player=new s}r(t,"laya.d3.component.animation.KeyframeAnimations",e);var i=t.prototype;return i._updateAnimtionPlayer=function(){this._player.update(n.timer.delta)},i._addUpdatePlayerToTimer=function(){n.timer.frameLoop(1,this,this._updateAnimtionPlayer)},i._removeUpdatePlayerToTimer=function(){n.timer.clear(this,this._updateAnimtionPlayer)},i._onOwnerEnableChanged=function(e){this._owner.isInStage&&(e?this._addUpdatePlayerToTimer():this._removeUpdatePlayerToTimer())},i._onIsInStageChanged=function(e){this._owner.enable&&(e?this._addUpdatePlayerToTimer():this._removeUpdatePlayerToTimer())},i._load=function(e){this._owner.isInStage&&this._owner.enable&&this._addUpdatePlayerToTimer(),this._owner.on("enabledchanged",this,this._onOwnerEnableChanged),this._owner.on("instagechanged",this,this._onIsInStageChanged)},i._unload=function(e){this._owner.isInStage&&this._owner.enable&&this._removeUpdatePlayerToTimer(),this._owner.off("enabledchanged",this,this._onOwnerEnableChanged),this._owner.off("instagechanged",this,this._onIsInStageChanged)},i.stop=function(e){void 0===e&&(e=!0),this._player.stop(e)},a(0,i,"player",function(){return this._player}),a(0,i,"url",function(){return this._url},function(e){0!==this._player.state&&this._player.stop(!0),this._url=A.formatURL(e);var t=E.animationCache[this._url],n=this;if(t)this._templet=t,this._player.templet=t;else{t=E.animationCache[this._url]=new v,this._templet=t,this._player.templet=t;var i=function(e){var n=e;t.parse(n)},r=new g;r.once("complete",null,i),r.load(this._url,"arraybuffer")}this.event("actionchanged",this),t.loaded?this.event("loaded",this):t.once("loaded",null,function(e){n.event("loaded",n)})}),a(0,i,"currentFrameIndex",function(){return this._player.currentKeyframeIndex}),a(0,i,"NodeCount",function(){return this._templet.getNodeCount(this._player.currentAnimationClipIndex)}),a(0,i,"currentAnimationClipIndex",function(){return this._player.currentAnimationClipIndex}),t}(Re),We=(function(e){function t(){this._attachSkeleton=null,this._data=null,this._extenData=null,this.attachBones=null,this.matrixs=null,t.__super.call(this),this.attachBones=[],this.matrixs=[]}r(t,"laya.d3.component.AttachPoint",e);var n=t.prototype;return n._load=function(t){e.prototype._load.call(this,t),this._attachSkeleton=t.getComponentByType(lt)},n._update=function(e){var t=this._attachSkeleton.player;if(this._attachSkeleton&&2===t.state&&this._attachSkeleton.curBonesDatas){this.matrixs.length=this.attachBones.length;for(var n=0;n<this.attachBones.length;n++){var i=this._attachSkeleton._templet.getNodeIndexWithName(t.currentAnimationClipIndex,this.attachBones[n]);this._data=this._attachSkeleton.curBonesDatas.subarray(16*i,16*(i+1));var r=this.matrixs[n];r||(r=this.matrixs[n]=new Te),r.copyFromArray(this._data),Te.multiply(this.owner.transform.worldMatrix,r,r)}}},t}(Re),function(e){function t(){t.__super.call(this)}return r(t,"laya.d3.component.Script",e),t}(Re),function(e){function t(e){t.__super.call(this,e)}r(t,"laya.d3.core.GlitterRender",e);var n=t.prototype;return n._calculateBoundingBox=function(){var e=this._boundingBox.min.elements;e[0]=-Number.MAX_VALUE,e[1]=-Number.MAX_VALUE,e[2]=-Number.MAX_VALUE;var t=this._boundingBox.min.elements;t[0]=Number.MAX_VALUE,t[1]=Number.MAX_VALUE,t[2]=Number.MAX_VALUE},n._calculateBoundingSphere=function(){var e=this._boundingSphere.center.elements;e[0]=0,e[1]=0,e[2]=0,this._boundingSphere.radius=Number.MAX_VALUE},t}(Oe)),Xe=function(e){function t(e){this._meshSprite3DOwner=null,this.castShadow=!1,this.receiveShadow=!1,t.__super.call(this,e),this._meshSprite3DOwner=e,this.castShadow=!0,this.receiveShadow=!0,this._meshSprite3DOwner.meshFilter.on("meshchanged",this,this._onMeshChanged)}r(t,"laya.d3.core.MeshRender",e);var n=t.prototype;return n._onMeshChanged=function(e,t,n){n.loaded?(this._boundingSphereNeedChange=!0,this._boundingBoxNeedChange=!0):n.once("loaded",this,this._onMeshLoaed)},n._onMeshLoaed=function(e,t){this._boundingSphereNeedChange=!0,this._boundingBoxNeedChange=!0},n._calculateBoundingSphere=function(){if(null===this._meshSprite3DOwner.meshFilter.sharedMesh||null===this._meshSprite3DOwner.meshFilter.sharedMesh.boundingSphere)this._boundingSphere.toDefault();else{var e=this._meshSprite3DOwner.meshFilter.sharedMesh.boundingSphere,t=NaN,n=this._meshSprite3DOwner.transform,i=n.scale;t=i.x>=i.y&&i.x>=i.z?i.x:i.y>=i.z?i.y:i.z,De.transformCoordinate(e.center,n.worldMatrix,this._boundingSphere.center),this._boundingSphere.radius=e.radius*t}},n._calculateBoundingBox=function(){if(null===this._meshSprite3DOwner.meshFilter.sharedMesh||null===this._meshSprite3DOwner.meshFilter.sharedMesh.boundingBox)this._boundingBox.toDefault();else{var e=this._meshSprite3DOwner.meshFilter.sharedMesh.boundingBox,t=this._meshSprite3DOwner.transform.worldMatrix;De.transformCoordinate(e.min,t,this._boundingBox.min),De.transformCoordinate(e.max,t,this._boundingBox.max)}},n.dispose=function(){this._meshSprite3DOwner.meshFilter.off("meshchanged",this,this._onMeshChanged)},t}(Oe),qe=function(e){function t(){t.__super.call(this)}r(t,"laya.d3.core.material.GlitterMaterial",e);var n=t.prototype;return n._setLoopShaderParams=function(e,t,n,i,r){var a=e.owner,s=a.templet,o=s.setting;e.shaderValue.pushValue("UNICOLOR",o.color.elements),e.shaderValue.pushValue("MVPMATRIX",e.projectionViewMatrix.elements),e.shaderValue.pushValue("DURATION",o.lifeTime),e.shaderValue.pushValue("ALBEDO",s._albedo.elements),e.shaderValue.pushValue("CURRENTTIME",s._currentTime)},a(0,n,"diffuseTexture",function(){return this._getTexture(0)},function(e){e?this._addShaderDefine(1):this._removeShaderDefine(1),this._setTexture(e,0,"DIFFUSETEXTURE")}),t._diffuseTextureIndex=0,i(t,["defaultMaterial",function(){return this.defaultMaterial=new t}]),t}(Ne),Qe=function(e){function t(){t.__super.call(this),this._addShaderDefine(32768)}r(t,"laya.d3.core.material.ParticleMaterial",e);var n=t.prototype;return n._setLoopShaderParams=function(e,t,n,i,r){var a=e.owner,s=a.templet,o=s.settings;e.shaderValue.pushValue("DURATION",o.duration),e.shaderValue.pushValue("GRAVITY",o.gravity),e.shaderValue.pushValue("ENDVELOCITY",o.endVelocity),e.shaderValue.pushValue("MVPMATRIX",n.elements),e.shaderValue.pushValue("MATRIX1",e.viewMatrix.elements),e.shaderValue.pushValue("MATRIX2",e.projectionMatrix.elements);var h=e.viewport.width/e.viewport.height,l=new Ee(.5/h,-.5);e.shaderValue.pushValue("VIEWPORTSCALE",l.elements),e.shaderValue.pushValue("CURRENTTIME",s._currentTime)},a(0,n,"diffuseTexture",function(){return this._getTexture(0)},function(e){e?this._addShaderDefine(1):this._removeShaderDefine(1),this._setTexture(e,0,"DIFFUSETEXTURE")}),t._diffuseTextureIndex=0,i(t,["defaultMaterial",function(){return this.defaultMaterial=new t}]),t}(Ne),Ye=function(e){function t(){this._transformUV=null,t.__super.call(this),this._setColor(0,"MATERIALAMBIENT",t.AMBIENTCOLORVALUE),this._setColor(1,"MATERIALDIFFUSE",t.DIFFUSECOLORVALUE),this._setColor(2,"MATERIALSPECULAR",t.SPECULARCOLORVALUE),this._setColor(3,"MATERIALREFLECT",t.REFLECTCOLORVALUE),this._setColor(4,"ALBEDO",t.ALBEDO),this._setNumber(0,"ALPHATESTVALUE",.5)}r(t,"laya.d3.core.material.StandardMaterial",e);var n=t.prototype;return n.disableLight=function(){this._addDisableShaderDefine(448)},n._setLoopShaderParams=function(e,n,i,r,a){this._transformUV&&this._transformUV.matrix;var s;i===Te.DEFAULT?s=n:(s=t._tempMatrix4x40,Te.multiply(n,i,s)),e.shaderValue.pushValue("MATRIX1",i.elements),e.shaderValue.pushValue("MVPMATRIX",s.elements)},n.copy=function(t){var n=t;return n._transformUV=this._transformUV,e.prototype.copy.call(this,n)},a(0,n,"ambientColor",function(){this._getColor(0)},function(e){this._setColor(0,"MATERIALAMBIENT",e)}),a(0,n,"diffuseColor",function(){this._getColor(1)},function(e){this._setColor(1,"MATERIALDIFFUSE",e)}),a(0,n,"normalTexture",function(){return this._getTexture(1)},function(e){e?this._addShaderDefine(2):this._removeShaderDefine(2),this._setTexture(e,1,"NORMALTEXTURE")}),a(0,n,"specularColor",function(){this._getColor(2)},function(e){this._setColor(2,"MATERIALSPECULAR",e)}),a(0,n,"reflectColor",function(){this._getColor(3)},function(e){this._setColor(3,"MATERIALREFLECT",e)}),a(0,n,"reflectTexture",function(){return this._getTexture(5)},function(e){e?this._addShaderDefine(262144):this._removeShaderDefine(262144),this._setTexture(e,5,"REFLECTTEXTURE")}),a(0,n,"specularTexture",function(){return this._getTexture(2)},function(e){e?this._addShaderDefine(4):this._removeShaderDefine(4),this._setTexture(e,2,"SPECULARTEXTURE")}),a(0,n,"albedo",function(){this._getColor(4)},function(e){this._setColor(4,"ALBEDO",e)}),a(0,n,"diffuseTexture",function(){return this._getTexture(0)},function(e){e?this._addShaderDefine(1):this._removeShaderDefine(1),this._setTexture(e,0,"DIFFUSETEXTURE")}),a(0,n,"alphaTestValue",function(){return this._getNumber(0)},function(e){this._setNumber(0,"ALPHATESTVALUE",e)}),a(0,n,"emissiveTexture",function(){return this._getTexture(3)},function(e){e?this._addShaderDefine(8):this._removeShaderDefine(8),this._setTexture(e,3,"EMISSIVETEXTURE")}),a(0,n,"ambientTexture",function(){return this._getTexture(4)},function(e){e?this._addShaderDefine(16):this._removeShaderDefine(16),this._setTexture(e,4,"AMBIENTTEXTURE")}),a(0,n,"transformUV",function(){return this._transformUV},function(e){this._transformUV=e,this._setMatrix4x4(0,"MATRIX2",e.matrix),e?this._addShaderDefine(16384):this._removeShaderDefine(16384)}),t._ambientColorIndex=0,t._diffuseColorIndex=1,t._speclarColorIndex=2,t._reflectColorIndex=3,t._albedoColorIndex=4,t._alphaTestValueIndex=0,t._diffuseTextureIndex=0,t._normalTextureIndex=1,t._specularTextureIndex=2,t._emissiveTextureIndex=3,t._ambientTextureIndex=4,t._reflectTextureIndex=5,t.TRANSFORMUV=0,i(t,["_tempMatrix4x40",function(){return this._tempMatrix4x40=new Te},"defaultMaterial",function(){return this.defaultMaterial=new t},"AMBIENTCOLORVALUE",function(){return this.AMBIENTCOLORVALUE=new De(.6,.6,.6)},"DIFFUSECOLORVALUE",function(){return this.DIFFUSECOLORVALUE=new De(1,1,1)},"SPECULARCOLORVALUE",function(){return this.SPECULARCOLORVALUE=new Me(1,1,1,8)},"REFLECTCOLORVALUE",function(){return this.REFLECTCOLORVALUE=new De(1,1,1)},"ALBEDO",function(){return this.ALBEDO=new Me(1,1,1,1)}]),t}(Ne),Ze=function(e){function t(e){t.__super.call(this,e)}r(t,"laya.d3.core.ParticleRender",e);var n=t.prototype;return n._calculateBoundingBox=function(){var e=this._boundingBox.min.elements;e[0]=-Number.MAX_VALUE,e[1]=-Number.MAX_VALUE,e[2]=-Number.MAX_VALUE;var t=this._boundingBox.min.elements;t[0]=Number.MAX_VALUE,t[1]=Number.MAX_VALUE,t[2]=Number.MAX_VALUE},n._calculateBoundingSphere=function(){var e=this._boundingSphere.center.elements;e[0]=0,e[1]=0,e[2]=0,this._boundingSphere.radius=Number.MAX_VALUE},t}(Oe),Ke=function(e){function t(e,n){this._owner=null,this._vertexBuffer3D=null,this._indexBuffer3D=null,t.__super.call(this,n),this._owner=e,this.initialize(),this._vertexBuffer=this._vertexBuffer3D=it.create(K.vertexDeclaration,4*n.maxPartices,35048),this._indexBuffer=this._indexBuffer3D=nt.create("ushort",6*n.maxPartices,35044,!0),this.loadContent()}r(t,"laya.d3.resource.tempelet.ParticleTemplet3D",e);var i=t.prototype;return n.imps(i,{"laya.d3.core.render.IRenderable":!0}),i._getVertexBuffer=function(e){return void 0===e&&(e=0),0===e?this._vertexBuffer3D:null},i._getIndexBuffer=function(){return this._indexBuffer3D},i.addParticle=function(e,t){this.addParticleArray(e.elements,t.elements)},i.loadContent=function(){for(var e=new Uint16Array(6*this.settings.maxPartices),t=0;t<this.settings.maxPartices;t++)e[6*t+0]=4*t+0,e[6*t+1]=4*t+1,e[6*t+2]=4*t+2,e[6*t+3]=4*t+0,e[6*t+4]=4*t+2,e[6*t+5]=4*t+3;this._indexBuffer3D.setData(e)},i.addNewParticlesToVertexBuffer=function(){var e=0;this._firstNewElement<this._firstFreeElement?(e=4*this._firstNewElement*this._floatCountPerVertex,this._vertexBuffer3D.setData(this._vertices,e,e,4*(this._firstFreeElement-this._firstNewElement)*this._floatCountPerVertex)):(e=4*this._firstNewElement*this._floatCountPerVertex,this._vertexBuffer3D.setData(this._vertices,e,e,4*(this.settings.maxPartices-this._firstNewElement)*this._floatCountPerVertex),this._firstFreeElement>0&&this._vertexBuffer3D.setData(this._vertices,0,0,4*this._firstFreeElement*this._floatCountPerVertex)),this._firstNewElement=this._firstFreeElement},i._beforeRender=function(e){return this._firstNewElement!=this._firstFreeElement&&this.addNewParticlesToVertexBuffer(),this._drawCounter++,this._firstActiveElement!=this._firstFreeElement?(this._vertexBuffer3D._bind(),this._indexBuffer._bind(),!0):!1},i._render=function(e){var t=0,n=R.mainContext;this._firstActiveElement<this._firstFreeElement?(t=6*(this._firstFreeElement-this._firstActiveElement),n.drawElements(4,t,5123,6*this._firstActiveElement*2),V.trianglesFaces+=t/3,V.drawCall++):(t=6*(this.settings.maxPartices-this._firstActiveElement),n.drawElements(4,t,5123,6*this._firstActiveElement*2),V.trianglesFaces+=t/3,V.drawCall++,this._firstFreeElement>0&&(t=6*this._firstFreeElement,n.drawElements(4,t,5123,0),V.trianglesFaces+=t/3,V.drawCall++))},a(0,i,"indexOfHost",function(){return 0}),a(0,i,"_vertexBufferCount",function(){return 1}),a(0,i,"triangleCount",function(){return this._indexBuffer3D.indexCount/3}),t}(C),$e=function(e){function t(){this._invertYProjectionMatrix=null,this._invertYProjectionViewMatrix=null,this._invertYScaleMatrix=null,this._isInStage=!1,this._boundFrustum=null,this._enableLightCount=3,this._renderTargetTexture=null,this._customRenderQueneIndex=11,this._lastCurrentTime=NaN,this._staticBatchManager=null,this._dynamicBatchManager=null,this.enableFog=!1,this.fogStart=NaN,this.fogRange=NaN,this.fogColor=null,this.enableLight=!0,t.__super.call(this),this._renderState=new H,this._lights=new Array,this._shadingMode=8192,this._renderConfigs=[],this._frustumCullingObjects=[],this._quenes=[],this._cameraPool=[],this._invertYProjectionMatrix=new Te,this._invertYProjectionViewMatrix=new Te,this._invertYScaleMatrix=new Te,Te.createScaling(new De(1,-1,1),this._invertYScaleMatrix),this._staticBatchManager=new q,this._dynamicBatchManager=new k,this._boundFrustum=new pe(Te.DEFAULT),this.enableFog=!1,this.fogStart=300,this.fogRange=1e3,this.fogColor=new De(.7,.7,.7);var e;e=this._renderConfigs[1]=new F,e=this._renderConfigs[2]=new F,e.cullFace=!1,e=this._renderConfigs[3]=new F,e.blend=!0,e.sFactor=770,e.dFactor=771,e=this._renderConfigs[4]=new F,e.cullFace=!1,e.blend=!0,e.sFactor=770,e.dFactor=771,e=this._renderConfigs[5]=new F,e.blend=!0,e.sFactor=770,e.dFactor=1,e=this._renderConfigs[6]=new F,e.cullFace=!1,e.blend=!0,e.sFactor=770,e.dFactor=1,e=this._renderConfigs[7]=new F,e.blend=!0,e.depthMask=0,e.sFactor=770,e.dFactor=771,e=this._renderConfigs[9]=new F,e.blend=!0,e.depthMask=0,e.sFactor=770,e.dFactor=1,e=this._renderConfigs[8]=new F,e.cullFace=!1,e.blend=!0,e.depthMask=0,e.sFactor=770,e.dFactor=771,e=this._renderConfigs[10]=new F,e.cullFace=!1,e.blend=!0,e.depthMask=0,e.sFactor=770,e.dFactor=1,e=this._renderConfigs[11]=new F,e.blend=!0,e.depthTest=!1,e.sFactor=770,e.dFactor=771,e=this._renderConfigs[13]=new F,e.blend=!0,e.depthTest=!1,e.sFactor=770,e.dFactor=1,e=this._renderConfigs[12]=new F,e.cullFace=!1,e.blend=!0,e.depthTest=!1,e.sFactor=770,e.dFactor=771,e=this._renderConfigs[14]=new F,e.cullFace=!1,e.blend=!0,e.depthTest=!1,e.sFactor=770,e.dFactor=1,this.on("added",this,this._onAdded),this.on("removed",this,this._onRemoved)}r(t,"laya.d3.core.scene.BaseScene",e);var i=t.prototype;return n.imps(i,{"laya.webgl.submit.ISubmit":!0}),i._onAdded=function(){var e=n.stage.contains(this);e&&this._addSelfAndChildrenRenderObjects(),e&&this._changeSelfAndChildrenInStage(!0)},i._onRemoved=function(){var e=n.stage.contains(this);e&&this._clearSelfAndChildrenRenderObjects(),e&&this._changeSelfAndChildrenInStage(!1)},i._changeSelfAndChildrenInStage=function(e){this._isInStage=e,this.event("instagechanged",e);for(var t=this._childs,n=0,i=t.length;i>n;n++)this._childs[n]._changeSelfAndChildrenInStage(e)},i._clearSelfAndChildrenRenderObjects=function(){for(var e=0,t=this._childs.length;t>e;e++)this._childs[e]._clearSelfAndChildrenRenderObjects()},i._addSelfAndChildrenRenderObjects=function(){for(var e=0,t=this._childs.length;t>e;e++)this._childs[e]._addSelfAndChildrenRenderObjects()},i._prepareScene=function(e,t,n){B._currentCameraCullingMask=t.cullingMask,n.context=R.mainContext,n.elapsedTime=this._lastCurrentTime?this.timer.currTimer-this._lastCurrentTime:0,this._lastCurrentTime=this.timer.currTimer,n.reset(),n.loopCount=V.loopCount,n.shadingMode=this._shadingMode,n.scene=this,n.camera=t;var i=n.worldShaderValue;V.loopCount;if(t&&i.pushValue("CAMERAPOS",t.transform.position.elements),this._lights.length>0)for(var r=0,a=0;a<this._lights.length;a++){var s=this._lights[a];if(s.active){if(r++,r>this._enableLightCount)break;s.updateToWorldState(n)}}this.enableFog&&(i.pushValue("FOGSTART",this.fogStart),i.pushValue("FOGRANGE",this.fogRange),i.pushValue("FOGCOLOR",this.fogColor.elements)),n.shaderValue.pushArray(i);var o=n.shaderDefs;this.enableFog&&(o._value=o._value|=131072)},i._updateScene=function(e){this._updateChilds(e)},i._updateChilds=function(e){for(var t=0,n=this._childs.length;n>t;++t){var i=this._childs[t];i._update(e)}},i._preRenderScene=function(e,t){this._boundFrustum.matrix=t.projectionViewMatrix,z.RenderObjectCulling(this._boundFrustum,this);for(var n=0,i=this._quenes.length;i>n;n++)this._quenes[n]&&this._quenes[n]._preRender(t)},i._clear=function(e,t){var n=t.viewport,i=t.camera,r=i.renderTargetSize.height;e.viewport(n.x,r-n.y-n.height,n.width,n.height);var a=0;switch(i.clearFlag){case 0:if(i.clearColor){e.enable(3089),e.scissor(n.x,r-n.y-n.height,n.width,n.height);var s=i.clearColor.elements;if(e.clearColor(s[0],s[1],s[2],s[3]),a=16384,i.renderTarget)switch(i.renderTarget.depthStencilFormat){case 33189:a|=256;break;case 36168:a|=1024;break;case 34041:a|=256,a|=1024}else a|=256;e.clear(a),e.disable(3089)}else e.clear(256);break;case 1:case 2:if(i.renderTarget)switch(i.renderTarget.depthStencilFormat){case 33189:a|=256;break;case 36168:a|=1024;break;case 34041:a|=256,a|=1024}else a|=256;break;case 3:break;default:throw new Error("BaseScene:camera clearFlag invalid.")}},i._renderScene=function(e,t){var n,i=t.camera,r=0,a=0;for(r=0;3>r;r++)n=this._quenes[r],n&&(n._setState(e,t),n._render(t));if(1===i.clearFlag){var s=i.sky;s&&(O.setCullFace(e,!1),O.setDepthFunc(e,515),O.setDepthMask(e,0),s._render(t),O.setDepthFunc(e,513),O.setDepthMask(e,1))}for(r=3,a=this._quenes.length;a>r;r++)n=this._quenes[r],n&&(n._sortAlpha(t.camera.transform.position),n._setState(e,t),n._render(t))},i._set3DRenderConfig=function(e){e.disable(3042),O._blend=!1,e.blendFunc(770,771),O._sFactor=770,O._dFactor=771,e.disable(2929),O._depthTest=!1,e.enable(2884),O._cullFace=!0,e.depthMask(1),O._depthMask=1,e.frontFace(2304),O._frontFace=2304},i._set2DRenderConfig=function(e){O.setBlend(e,!0),O.setBlendFunc(e,770,771),O.setDepthTest(e,!1),O.setCullFace(e,!1),O.setDepthMask(e,1),O.setFrontFaceCCW(e,2305),e.viewport(0,0,I.width,I.height)},i._addLight=function(e){this._lights.indexOf(e)<0&&this._lights.push(e)},i._removeLight=function(e){var t=this._lights.indexOf(e);t>=0&&this._lights.splice(t,1)},i.addChildAt=function(e,t){if(!(e instanceof laya.d3.core.Sprite3D))throw new Error("Sprite3D:Node type must Sprite3D.");return laya.display.Node.prototype.addChildAt.call(this,e,t)},i.addChild=function(e){if(!(e instanceof laya.d3.core.Sprite3D))throw new Error("Sprite3D:Node type must Sprite3D.");return laya.display.Node.prototype.addChild.call(this,e)},i.addFrustumCullingObject=function(e){this._frustumCullingObjects.push(e)},i.removeFrustumCullingObject=function(e){var t=this._frustumCullingObjects.indexOf(e);-1!==t&&this._frustumCullingObjects.splice(t,1)},i.getRenderQueue=function(e){return this._quenes[e]||(this._quenes[e]=new G(this._renderConfigs[e],this))},i.addRenderQuene=function(e){this._quenes[this._customRenderQueneIndex++]=new G(e,this)},i.beforeUpate=function(e){},i.lateUpate=function(e){},i.beforeRender=function(e){},i.lateRender=function(e){},i.render=function(t,n,i){b._context.ctx._shader2D.glTexture=null,this._childs.length>0&&t.addRenderObject(this),this._renderType&=-2049,e.prototype.render.call(this,t,n,i)},i.renderSubmit=function(){return 1},i.getRenderType=function(){return 0},i.releaseRender=function(){},a(0,i,"scene",function(){return this}),a(0,i,"isInStage",function(){return this._isInStage}),a(0,i,"shadingMode",function(){return 4096==this._shadingMode?0:8192},function(e){if(0!==e&&1!==e)throw Error("Scene set shadingMode,must:0 or 1,value="+e);this._shadingMode=0===e?4096:8192}),t.VERTEX_SHADING=0,t.PIXEL_SHADING=1,t}(w),Je=function(e){function t(e,i){this._projectionMatrixModifyID=0,t.__super.call(this),void 0===e&&(e=.1),void 0===i&&(i=1e3),this._tempVector3=new De,this._up=new De,this._forward=new De,this._right=new De,this._fieldOfView=60,this._useUserProjectionMatrix=!1,this._orthographic=!1,this._viewportExpressedInClipSpace=!0,this._renderTargetSize=Pe.fullScreen,this._orthographicVerticalSize=10,this.renderingOrder=0,this._nearPlane=e,this._farPlane=i,this.cullingMask=2147483647,this.clearColor=new Me(.26,.26,.26,1),this.clearFlag=0,this._calculateProjectionMatrix(),n.stage.on("resize",this,this._onScreenSizeChanged)}r(t,"laya.d3.core.BaseCamera",e);var i=t.prototype;return i._sortCamerasByRenderingOrder=function(){if(this.isInStage)for(var e=this.scene._cameraPool,t=e.length-1,n=0;t>n;n++)if(e[n].renderingOrder>e[t].renderingOrder){var i=e[n];e[n]=e[t],e[t]=i}},i._calculateProjectionMatrix=function(){},i._onScreenSizeChanged=function(){this._calculateProjectionMatrix()},i.addLayer=function(e){29!==e.number&&30!=e.number&&(this.cullingMask=this.cullingMask|e.mask)},i.removeLayer=function(e){29!==e.number&&30!=e.number&&(this.cullingMask=this.cullingMask&~e.mask)},i.addAllLayers=function(){this.cullingMask=2147483647},i.removeAllLayers=function(){this.cullingMask=0|B.getLayerByNumber(29).mask|B.getLayerByNumber(30).mask},i.ResetProjectionMatrix=function(){this._useUserProjectionMatrix=!1,this._calculateProjectionMatrix()},i.destroy=function(e){void 0===e&&(e=!0),this.sky=null,this.renderTarget=null,n.stage.off("resize",this,this._onScreenSizeChanged),laya.display.Node.prototype.destroy.call(this,e)},i.moveForward=function(e){this._tempVector3.elements[0]=this._tempVector3.elements[1]=0,this._tempVector3.elements[2]=e,this.transform.translate(this._tempVector3)},i.moveRight=function(e){this._tempVector3.elements[1]=this._tempVector3.elements[2]=0,this._tempVector3.elements[0]=e,this.transform.translate(this._tempVector3)},i.moveVertical=function(e){this._tempVector3.elements[0]=this._tempVector3.elements[2]=0,this._tempVector3.elements[1]=e,this.transform.translate(this._tempVector3,!1)},i._addSelfRenderObjects=function(){var e=this.scene._cameraPool,t=e.length;if(t>0){for(var n=t-1;n>=0;n--)if(this.renderingOrder<=e[n].renderingOrder){e.splice(n+1,0,this);break}}else e.push(this)},i._clearSelfRenderObjects=function(){var e=this.scene._cameraPool;e.splice(e.indexOf(this),1)},a(0,i,"position",function(){var e=this.transform.worldMatrix.elements,t=this._position.elements;return t[0]=e[12],t[1]=e[13],t[2]=e[14],this._position}),a(0,i,"renderTargetSize",function(){return this._renderTargetSize},function(e){null!=this.renderTarget&&this._renderTargetSize!=e,this._renderTargetSize=e,this._calculateProjectionMatrix()}),a(0,i,"up",function(){var e=this.transform.worldMatrix.elements,t=this._up.elements;return t[0]=e[4],t[1]=e[5],t[2]=e[6],this._up}),a(0,i,"fieldOfView",function(){return this._fieldOfView},function(e){this._fieldOfView=e,this._calculateProjectionMatrix()}),a(0,i,"forward",function(){var e=this.transform.worldMatrix.elements,t=this._forward.elements;return t[0]=-e[8],t[1]=-e[9],t[2]=-e[10],this._forward}),a(0,i,"right",function(){var e=this.transform.worldMatrix.elements,t=this._right.elements;return t[0]=e[0],t[1]=e[1],t[2]=e[2],this._right}),a(0,i,"farPlane",function(){return this._farPlane},function(e){this._farPlane=e,this._calculateProjectionMatrix()}),a(0,i,"renderingOrder",function(){return this._renderingOrder},function(e){this._renderingOrder=e,this._sortCamerasByRenderingOrder()}),a(0,i,"renderTarget",function(){return this._renderTarget},function(e){this._renderTarget=e,null!=e&&(this._renderTargetSize=e.size)}),a(0,i,"nearPlane",function(){return this._nearPlane},function(e){this._nearPlane=e,this._calculateProjectionMatrix()}),a(0,i,"orthographicProjection",function(){return this._orthographic},function(e){this._orthographic=e,this._calculateProjectionMatrix()}),a(0,i,"orthographicVerticalSize",function(){return this._orthographicVerticalSize},function(e){this._orthographicVerticalSize=e,this._calculateProjectionMatrix()}),t.RENDERINGTYPE_DEFERREDLIGHTING="DEFERREDLIGHTING",t.RENDERINGTYPE_FORWARDRENDERING="FORWARDRENDERING",t.CLEARFLAG_SOLIDCOLOR=0,t.CLEARFLAG_SKY=1,t.CLEARFLAG_DEPTHONLY=2,t.CLEARFLAG_NONE=3,t}(Ge),et=(function(e){function t(e){this._templet=null,this._glitterRender=null,t.__super.call(this),this._glitterRender=new We(this),this._glitterRender.on("materialchanged",this,this._onMaterialChanged);var i=new qe;i.setShaderName("GLITTER"),e.texturePath&&n.loader.load(e.texturePath,m.create(null,function(e){i.diffuseTexture=e}),null,"texture2d"),this._glitterRender.sharedMaterial=i,this._templet=new Fe(this,e),i.renderMode=8,this._changeRenderObject(0)}r(t,"laya.d3.core.glitter.Glitter",e);var i=t.prototype;return i._changeRenderObject=function(e){var t=this._glitterRender.renderCullingObject._renderElements,n=t[e];n||(n=t[e]=new U),n._renderCullingObject=this._glitterRender.renderCullingObject;var i=this._glitterRender.sharedMaterials[e];i||(i=qe.defaultMaterial);var r=this._templet;return n._mainSortID=0,n._sprite3D=this,n.renderObj=r,n._material=i,n},i._onMaterialChanged=function(e,t,n){var i=e.renderCullingObject._renderElements.length;i>t&&this._changeRenderObject(t)},i._clearSelfRenderObjects=function(){this.scene.removeFrustumCullingObject(this._glitterRender.renderCullingObject)},i._addSelfRenderObjects=function(){this.scene.addFrustumCullingObject(this._glitterRender.renderCullingObject)},i._update=function(e){this._templet._update(e.elapsedTime),e.owner=this,V.spriteCount++,this._childs.length&&this._updateChilds(e)},i.addGlitterByPositions=function(e,t){this._templet.addVertexPosition(e,t)},i.addGlitterByPositionsVelocitys=function(e,t,n,i){this._templet.addVertexPositionVelocity(e,t,n,i)},i.dispose=function(){e.prototype.dispose.call(this),this._glitterRender.off("materialchanged",this,this._onMaterialChanged),this._templet.dispose()},a(0,i,"glitterRender",function(){return this._glitterRender}),a(0,i,"templet",function(){return this._templet}),t}(Ge),function(e){function t(){this._diffuseColor=null,this._ambientColor=null,this._specularColor=null,this._reflectColor=null,t.__super.call(this),this.on("added",this,this._$3__onAdded),this.on("removed",this,this._$3__onRemoved),this._diffuseColor=new De(.8,.8,.8),this._ambientColor=new De(.6,.6,.6),this._specularColor=new De(1,1,1),this._reflectColor=new De(1,1,1)}r(t,"laya.d3.core.light.LightSprite",e);var n=t.prototype;return n._$3__onRemoved=function(){this.scene._removeLight(this)},n._$3__onAdded=function(){this.scene._addLight(this)},n.updateToWorldState=function(e){},a(0,n,"diffuseColor",function(){return this._diffuseColor},function(e){this._diffuseColor=e}),a(0,n,"lightType",function(){return-1}),a(0,n,"ambientColor",function(){return this._ambientColor},function(e){this._ambientColor=e}),a(0,n,"specularColor",function(){return this._specularColor},function(e){this._specularColor=e}),a(0,n,"reflectColor",function(){return this._reflectColor},function(e){this._reflectColor=e}),t.TYPE_DIRECTIONLIGHT=1,t.TYPE_POINTLIGHT=2,t.TYPE_SPOTLIGHT=3,t}(Ge)),tt=function(e){function t(e,n){this._meshFilter=null,this._meshRender=null,t.__super.call(this,n),this._meshFilter=new Le(this),this._meshRender=new Xe(this),this._meshFilter.on("meshchanged",this,this._onMeshChanged),this._meshRender.on("materialchanged",this,this._onMaterialChanged),this._meshFilter.sharedMesh=e,e instanceof laya.d3.resource.models.Mesh&&(e.loaded?this._meshRender.sharedMaterials=e.materials:e.once("loaded",this,this._applyMeshMaterials))}r(t,"laya.d3.core.MeshSprite3D",e);var n=t.prototype;return n._applyMeshMaterials=function(e){for(var t=this._meshRender.sharedMaterials,n=e.materials,i=0,r=n.length;r>i;i++)t[i]||(t[i]=n[i]);this._meshRender.sharedMaterials=t},n._changeRenderObjectByMesh=function(e){var t=this._meshRender.renderCullingObject._renderElements,n=t[e];n||(n=t[e]=new U),n._renderCullingObject=this._meshRender.renderCullingObject;
var i=this._meshRender.sharedMaterials[e];i||(i=Ye.defaultMaterial);var r=this._meshFilter.sharedMesh.getRenderElement(e);return n._mainSortID=this._getSortID(r,i),n._sprite3D=this,n.renderObj=r,n._material=i,n},n._changeRenderObjectByMaterial=function(e,t){var n=this._meshRender.renderCullingObject._renderElements[e],i=this._meshFilter.sharedMesh.getRenderElement(e);return n._mainSortID=this._getSortID(i,t),n._sprite3D=this,n.renderObj=i,n._material=t,n},n._changeRenderObjectsByMesh=function(){var e=this._meshFilter.sharedMesh.getRenderElementsCount();this._meshRender.renderCullingObject._renderElements.length=e;for(var t=0;e>t;t++)this._changeRenderObjectByMesh(t)},n._onMeshChanged=function(e){var t=e.sharedMesh;t.loaded?this._changeRenderObjectsByMesh():t.once("loaded",this,this._onMeshLoaded)},n._onMeshLoaded=function(e){e===this.meshFilter.sharedMesh&&this._changeRenderObjectsByMesh()},n._onMaterialChanged=function(e,t,n){var i=this._meshRender.renderCullingObject._renderElements.length;i>t&&this._changeRenderObjectByMaterial(t,n)},n._clearSelfRenderObjects=function(){this.scene.removeFrustumCullingObject(this._meshRender.renderCullingObject)},n._addSelfRenderObjects=function(){this.scene.addFrustumCullingObject(this._meshRender.renderCullingObject)},n._update=function(e){e.owner=this,this._enable&&(this._updateComponents(e),this._lateUpdateComponents(e)),V.spriteCount++,this._childs.length&&this._updateChilds(e)},n.dispose=function(){e.prototype.dispose.call(this),this._meshFilter.off("meshchanged",this,this._onMeshChanged),this._meshRender.off("materialchanged",this,this._onMaterialChanged)},a(0,n,"meshFilter",function(){return this._meshFilter}),a(0,n,"meshRender",function(){return this._meshRender}),t}(Ge),nt=(function(e){function t(e){this._templet=null,this._particleRender=null,t.__super.call(this),this._particleRender=new Ze(this),this._particleRender.on("materialchanged",this,this._onMaterialChanged);var i=new Qe;i.setShaderName("PARTICLE"),e.textureName&&n.loader.load(e.textureName,m.create(null,function(e){i.diffuseTexture=e}),null,"texture2d"),this._particleRender.sharedMaterial=i,this._templet=new Ke(this,e),0===e.blendState?i.renderMode=5:1===e.blendState&&(i.renderMode=7),this._changeRenderObject(0)}r(t,"laya.d3.core.particle.Particle3D",e);var i=t.prototype;return i._changeRenderObject=function(e){var t=this._particleRender.renderCullingObject._renderElements,n=t[e];n||(n=t[e]=new U),n._renderCullingObject=this._particleRender.renderCullingObject;var i=this._particleRender.sharedMaterials[e];i||(i=Qe.defaultMaterial);var r=this._templet;return n._mainSortID=0,n._sprite3D=this,n.renderObj=r,n._material=i,n},i._onMaterialChanged=function(e,t,n){var i=e.renderCullingObject._renderElements.length;i>t&&this._changeRenderObject(t)},i._clearSelfRenderObjects=function(){this.scene.removeFrustumCullingObject(this._particleRender.renderCullingObject)},i._addSelfRenderObjects=function(){this.scene.addFrustumCullingObject(this._particleRender.renderCullingObject)},i._update=function(e){this._templet.update(e.elapsedTime),e.owner=this,V.spriteCount++,this._childs.length&&this._updateChilds(e)},i.addParticle=function(e,t){De.add(this.transform.localPosition,e,e),this._templet.addParticle(e,t)},i.dispose=function(){e.prototype.dispose.call(this),this._particleRender.off("materialchanged",this,this._onMaterialChanged)},a(0,i,"templet",function(){return this._templet}),a(0,i,"particleRender",function(){return this._particleRender}),t}(Ge),function(e){function t(e,n,i,r){this._indexType=null,this._indexTypeByteCount=0,this._indexCount=0,this._canRead=!1,void 0===i&&(i=35044),void 0===r&&(r=!1),t.__super.call(this),this._indexType=e,this._indexCount=n,this._bufferUsage=i,this._bufferType=34963,this._canRead=r,this._bind();var a=0;if("ushort"==e)this._indexTypeByteCount=2;else{if("ubyte"!=e)throw new Error("unidentification index type.");this._indexTypeByteCount=1}a=this._indexTypeByteCount*n,this._byteLength=a,l._gl.bufferData(this._bufferType,a,this._bufferUsage),r?("ushort"==e?this._buffer=new Uint16Array(n):"ubyte"==e&&(this._buffer=new Uint8Array(n)),this.memorySize=2*a):this.memorySize=a}r(t,"laya.d3.graphics.IndexBuffer3D",e);var n=t.prototype;return n.setData=function(e,t,n,i){void 0===t&&(t=0),void 0===n&&(n=0),void 0===i&&(i=4294967295);var r=0;if("ushort"==this._indexType?(r=2,0===n&&4294967295===i||(e=new Uint16Array(e.buffer,n*r,i))):"ubyte"==this._indexType&&(r=1,0===n&&4294967295===i||(e=new Uint8Array(e.buffer,n*r,i))),this._bind(),l._gl.bufferSubData(this._bufferType,t*r,e),this._canRead)if(0!==t||0!==n||4294967295!==i){var a=this._buffer.length-t;i>a&&(i=a);for(var s=0;i>s;s++)this._buffer[t+s]=e[s]}else this._buffer=e},n.getData=function(){if(this._canRead)return this._buffer;throw new Error("Can't read data from VertexBuffer with only write flag!")},n.dispose=function(){this._buffer=null,e.prototype.dispose.call(this),this.memorySize=0},a(0,n,"indexType",function(){return this._indexType}),a(0,n,"indexTypeByteCount",function(){return this._indexTypeByteCount}),a(0,n,"indexCount",function(){return this._indexCount}),a(0,n,"canRead",function(){return this._canRead}),t.INDEXTYPE_UBYTE="ubyte",t.INDEXTYPE_USHORT="ushort",t.create=function(e,n,i,r){return void 0===i&&(i=35044),void 0===r&&(r=!1),new t(e,n,i,r)},t}(l)),it=function(e){function t(e,n,i,r){this._vertexDeclaration=null,this._vertexCount=0,this._canRead=!1,void 0===r&&(r=!1),t.__super.call(this),this._vertexDeclaration=e,this._vertexCount=n,this._bufferUsage=i,this._bufferType=34962,this._canRead=r,this._bind();var a=this._vertexDeclaration.vertexStride*n;this.memorySize=a,this._byteLength=a,l._gl.bufferData(this._bufferType,a,this._bufferUsage),r&&(this._buffer=new Float32Array(a/4))}r(t,"laya.d3.graphics.VertexBuffer3D",e);var n=t.prototype;return n.bindWithIndexBuffer=function(e){e&&e._bind(),this._bind()},n.setData=function(e,t,n,i){if(void 0===t&&(t=0),void 0===n&&(n=0),void 0===i&&(i=4294967295),0===n&&4294967295===i||(e=new Float32Array(e.buffer,4*n,i)),this._bind(),l._gl.bufferSubData(this._bufferType,4*t,e),this._canRead)if(0!==t||0!==n||4294967295!==i){var r=this._buffer.length-t;i>r&&(i=r);for(var a=0;i>a;a++)this._buffer[t+a]=e[a]}else this._buffer=e},n.getData=function(){if(this._canRead)return this._buffer;throw new Error("Can't read data from VertexBuffer with only write flag!")},n.detoryResource=function(){for(var t=this._vertexDeclaration.getVertexElements(),n=0;n<t.length;n++)R.mainContext.disableVertexAttribArray(n);e.prototype.detoryResource.call(this)},n.dispose=function(){e.prototype.dispose.call(this),this._buffer=null,this._vertexDeclaration=null,this.memorySize=0},a(0,n,"vertexDeclaration",function(){return this._vertexDeclaration}),a(0,n,"vertexCount",function(){return this._vertexCount}),a(0,n,"canRead",function(){return this._canRead}),t.create=function(e,n,i,r){return void 0===i&&(i=35044),void 0===r&&(r=!1),new t(e,n,i,r)},t}(l),rt=function(e){function t(){this._numberVertices=0,this._numberIndices=0,this._vertexBuffer=null,this._indexBuffer=null,this._indexOfHost=0,t.__super.call(this),this._indexOfHost=0}r(t,"laya.d3.resource.models.PrimitiveMesh",e);var i=t.prototype;return n.imps(i,{"laya.d3.core.render.IRenderable":!0}),i._getVertexBuffer=function(e){return void 0===e&&(e=0),0===e?this._vertexBuffer:null},i._getIndexBuffer=function(){return this._indexBuffer},i.getRenderElement=function(e){return this},i.getRenderElementsCount=function(){return 1},i.detoryResource=function(){this._vertexBuffer&&(this._vertexBuffer.dispose(),this._vertexBuffer=null),this._indexBuffer&&(this._indexBuffer.dispose(),this._indexBuffer=null),this.memorySize=0},i._beforeRender=function(e){return this._vertexBuffer._bind(),this._indexBuffer._bind(),!0},i._render=function(e){e.context.drawElements(4,this._numberIndices,5123,0),V.drawCall++,V.trianglesFaces+=this._numberIndices/3},a(0,i,"indexOfHost",function(){return this._indexOfHost}),a(0,i,"_vertexBufferCount",function(){return 1}),a(0,i,"triangleCount",function(){return this._indexBuffer.indexCount/3}),a(0,i,"positions",function(){var e,t=[],n=this._vertexBuffer.vertexDeclaration.getVertexElements(),i=0;for(i=0;i<n.length;i++){var r=n[i];if("vector3"===r.elementFormat&&"POSITION"===r.elementUsage){e=r;break}}var a=this._vertexBuffer.getData();for(i=0;i<a.length;i+=this._vertexBuffer.vertexDeclaration.vertexStride/4){var s=i+e.offset/4,o=new De(a[s+0],a[s+1],a[s+2]);t.push(o)}return t}),t}(je),at=function(e){function t(){this._materials=null,this._subMeshes=null,this._bindPoses=null,this._inverseBindPoses=null,t.__super.call(this),this._subMeshes=[],this._materials=[],this._loaded?this._generateBoundingObject():this.once("loaded",this,this._generateBoundingObject)}r(t,"laya.d3.resource.models.Mesh",e);var n=t.prototype;return n._generateBoundingObject=function(){var e=this.positions;this._boundingBox=new me(new De,new De),me.createfromPoints(e,this._boundingBox),this._boundingSphere=new ve(new De,0),ve.createfromPoints(e,this._boundingSphere)},n._add=function(e){e._indexInMesh=this._subMeshes.length,this._subMeshes.push(e),this._subMeshCount++},n._remove=function(e){var t=this._subMeshes.indexOf(e);return 0>t?!1:(this._subMeshes.splice(t,1),this._subMeshCount--,!0)},n.getSubMesh=function(e){return this._subMeshes[e]},n.getSubMeshCount=function(){return this._subMeshes.length},n.clear=function(){return this._subMeshes.length=0,this._subMeshCount=0,this},n.getRenderElementsCount=function(){return this._subMeshes.length},n.getRenderElement=function(e){return this._subMeshes[e]},n.dispose=function(){this._resourceManager.removeResource(this),laya.resource.Resource.prototype.dispose.call(this);for(var e=0;e<this._subMeshes.length;e++)this._subMeshes[e].dispose();this._subMeshes=null,this._subMeshCount=0},a(0,n,"positions",function(){for(var e=[],t=this._subMeshes.length,n=0;t>n;n++){var i,r=this._subMeshes[n],a=r._getVertexBuffer(),s=a.vertexDeclaration.getVertexElements(),o=0;for(o=0;o<s.length;o++){var h=s[o];if("vector3"===h.elementFormat&&"POSITION"===h.elementUsage){i=h;break}}var l=a.getData();for(o=0;o<l.length;o+=a.vertexDeclaration.vertexStride/4){var u=o+i.offset/4,_=new De(l[u+0],l[u+1],l[u+2]);e.push(_)}}return e}),a(0,n,"InverseAbsoluteBindPoses",function(){return this._inverseBindPoses}),a(0,n,"materials",function(){return this._materials.slice()}),a(0,n,"bindPoses",function(){return this._bindPoses}),t.load=function(e){e=A.formatURL(e);var n=E.meshCache[e];if(!n){n=E.meshCache[e]=new t;var i=new g;i.once("complete",null,function(t){new fe(t,n,n._materials,e),n._loaded=!0,n.event("loaded",n)}),i.load(e,"arraybuffer")}return n},t}(je),st=(function(e){function t(e,n,i,r,a,s,o,h,l){this._alreadyResolved=!1,this._surfaceFormat=0,this._surfaceType=0,this._depthStencilFormat=0,this._frameBuffer=null,this._depthStencilBuffer=null,void 0===i&&(i=6408),void 0===r&&(r=5121),void 0===a&&(a=33189),void 0===s&&(s=!1),void 0===o&&(o=!1),void 0===h&&(h=-1),void 0===l&&(l=-1),t.__super.call(this),this._width=e,this._height=n,this._size=new Pe(e,n),this._surfaceFormat=i,this._surfaceType=r,this._depthStencilFormat=a,this._mipmap=s,this._repeat=o,this._minFifter=h,this._magFifter=l,this.activeResource(),this._loaded=!0,this._alreadyResolved=!0}r(t,"laya.d3.resource.RenderTexture",e);var n=t.prototype;return n.recreateResource=function(){this.startCreate();var e=R.mainContext;this._frameBuffer=e.createFramebuffer(),this._source=e.createTexture();var t=O.curBindTexTarget,n=O.curBindTexValue;O.bindTexture(e,3553,this._source),e.texImage2D(3553,0,6408,this._width,this._height,0,this._surfaceFormat,this._surfaceType,null);var i=this._minFifter,r=this._magFifter,a=this._repeat?10497:33071,s=o.isPOT(this._width,this._height);if(s?(this._mipmap?-1!==i||(i=9987):-1!==i||(i=9729),-1!==r||(r=9729),e.texParameteri(3553,10241,i),e.texParameteri(3553,10240,r),e.texParameteri(3553,10242,a),e.texParameteri(3553,10243,a),this._mipmap&&e.generateMipmap(3553)):(-1!==i||(i=9729),-1!==r||(r=9729),e.texParameteri(3553,10241,i),e.texParameteri(3553,10240,r),e.texParameteri(3553,10242,33071),e.texParameteri(3553,10243,33071)),e.bindFramebuffer(36160,this._frameBuffer),e.framebufferTexture2D(36160,36064,3553,this._source,0),this._depthStencilFormat)switch(this._depthStencilBuffer=e.createRenderbuffer(),e.bindRenderbuffer(36161,this._depthStencilBuffer),e.renderbufferStorage(36161,this._depthStencilFormat,this._width,this._height),this._depthStencilFormat){case 33189:e.framebufferRenderbuffer(36160,36096,36161,this._depthStencilBuffer);break;case 36168:e.framebufferRenderbuffer(36160,36128,36161,this._depthStencilBuffer);break;case 34041:e.framebufferRenderbuffer(36160,33306,36161,this._depthStencilBuffer)}e.bindFramebuffer(36160,null),t&&n&&O.bindTexture(e,t,n),e.bindRenderbuffer(36161,null),this.memorySize=this._width*this._height*4,this.completeCreate()},n.start=function(){R.mainContext.bindFramebuffer(36160,this.frameBuffer),t._currentRenderTarget=this,this._alreadyResolved=!1},n.end=function(){R.mainContext.bindFramebuffer(36160,null),t._currentRenderTarget=null,this._alreadyResolved=!0},n.getData=function(e,t,n,i){var r=R.mainContext;r.bindFramebuffer(36160,this._frameBuffer);var a=36053===r.checkFramebufferStatus(36160);if(!a)return r.bindFramebuffer(36160,null),null;var s=new Uint8Array(this._width*this._height*4);return r.readPixels(e,t,n,i,this._surfaceFormat,this._surfaceType,s),r.bindFramebuffer(36160,null),s},n.detoryResource=function(){if(this._frameBuffer){var e=R.mainContext;e.deleteTexture(this._source),e.deleteFramebuffer(this._frameBuffer),e.deleteRenderbuffer(this._depthStencilBuffer),this._source=null,this._frameBuffer=null,this._depthStencilBuffer=null,this.memorySize=0}},a(0,n,"depthStencilBuffer",function(){return this._depthStencilBuffer}),a(0,n,"surfaceFormat",function(){return this._surfaceFormat}),a(0,n,"surfaceType",function(){return this._surfaceType}),a(0,n,"depthStencilFormat",function(){return this._depthStencilFormat}),a(0,n,"frameBuffer",function(){return this._frameBuffer}),a(0,n,"source",function(){return this._alreadyResolved?e.prototype._$get_source.call(this):null}),t._currentRenderTarget=null,t}(He),function(e){function t(e){this._color=null,this._pixels=null,t.__super.call(this),this._width=1,this._height=1,this._size=new Pe(this.width,this.height),this._color=e,this._pixels=new Uint8Array([255*e.x,255*e.y,255*e.z,255*e.w])}r(t,"laya.d3.resource.SolidColorTexture2D",e);var n=t.prototype;return n._createWebGlTexture=function(){var e=R.mainContext,t=this._source=e.createTexture(),n=this._width,i=this._height,r=O.curBindTexTarget,a=O.curBindTexValue;O.bindTexture(e,3553,t),e.texImage2D(3553,0,6408,n,i,0,6408,5121,this._pixels);var s=this._minFifter,h=this._magFifter,l=this._repeat?10497:33071,u=o.isPOT(n,i);u?(this._mipmap?-1!==s||(s=9987):-1!==s||(s=9729),-1!==h||(h=9729),e.texParameteri(3553,10241,s),e.texParameteri(3553,10240,h),e.texParameteri(3553,10242,l),e.texParameteri(3553,10243,l),this._mipmap&&e.generateMipmap(3553)):(-1!==s||(s=9729),-1!==h||(h=9729),e.texParameteri(3553,10241,s),e.texParameteri(3553,10240,h),e.texParameteri(3553,10242,33071),e.texParameteri(3553,10243,33071)),r&&a&&O.bindTexture(e,r,a),u?this.memorySize=n*i*4*(1+1/3):this.memorySize=n*i*4},n.recreateResource=function(){this.startCreate(),this._createWebGlTexture(),this.completeCreate()},n.detoryResource=function(){this._source&&(R.mainContext.deleteTexture(this._source),this._source=null,this.memorySize=0)},a(0,n,"source",function(){return e.prototype._$get_source.call(this)}),i(t,["pickTexture",function(){return this.pickTexture=new t(new Me(1,0,1,1))}]),t}(He)),ot=(function(e){function t(){this._sharderNameID=0,this._shader=null,this._numberVertices=0,this._numberIndices=0,this._vertexBuffer=null,this._indexBuffer=null,this._alphaBlending=1,this._colorIntensity=1,this._textureCube=null,this._shaderValue=new P,t.__super.call(this),this.name="Skybox-"+t._nameNumber,t._nameNumber++,this.loadShaderParams(),this.recreateResource()}r(t,"laya.d3.resource.models.SkyBox",e);var n=t.prototype;return n._getShader=function(e){var t=e.shaderDefs,n=t._value,i=(t._value|e.shadingMode)+2e-4*this._sharderNameID;return this._shader=M.withCompile(this._sharderNameID,e.shadingMode,e.shaderDefs.toNameDic(),i,null),t._value=n,this._shader},n.recreateResource=function(){this.startCreate(),this._numberVertices=36,this._numberIndices=36;var e=new Uint16Array(this._numberIndices),n=t._vertexDeclaration.vertexStride/4,i=new Float32Array(this._numberVertices*n),r=1,a=1,s=1,o=r/2,h=a/2,l=s/2,u=new De(-o,h,l),_=new De(-o,-h,l),c=new De(o,h,l),d=new De(o,-h,l),f=new De(-o,h,-l),m=new De(o,h,-l),p=new De(-o,-h,-l),v=new De(o,-h,-l),g=0;g=this._addVertex(i,g,u),g=this._addVertex(i,g,_),g=this._addVertex(i,g,c),g=this._addVertex(i,g,_),g=this._addVertex(i,g,d),g=this._addVertex(i,g,c),g=this._addVertex(i,g,f),g=this._addVertex(i,g,m),g=this._addVertex(i,g,p),g=this._addVertex(i,g,p),g=this._addVertex(i,g,m),g=this._addVertex(i,g,v),g=this._addVertex(i,g,u),g=this._addVertex(i,g,m),g=this._addVertex(i,g,f),g=this._addVertex(i,g,u),g=this._addVertex(i,g,c),g=this._addVertex(i,g,m),g=this._addVertex(i,g,_),g=this._addVertex(i,g,p),g=this._addVertex(i,g,v),g=this._addVertex(i,g,_),g=this._addVertex(i,g,v),g=this._addVertex(i,g,d),g=this._addVertex(i,g,u),g=this._addVertex(i,g,p),g=this._addVertex(i,g,_),g=this._addVertex(i,g,f),g=this._addVertex(i,g,p),g=this._addVertex(i,g,u),g=this._addVertex(i,g,c),g=this._addVertex(i,g,d),g=this._addVertex(i,g,v),g=this._addVertex(i,g,m),g=this._addVertex(i,g,c),g=this._addVertex(i,g,v);for(var x=0;36>x;x++)e[x]=x;this._vertexBuffer=new it(t._vertexDeclaration,this._numberVertices,35044,!0),this._indexBuffer=new nt("ushort",this._numberIndices,35044,!0),this._vertexBuffer.setData(i),this._indexBuffer.setData(e),this.memorySize=2*(this._vertexBuffer.byteLength+this._indexBuffer.byteLength),this.completeCreate()},n._addVertex=function(e,t,n){var i=n.elements;return e[t+0]=i[0],e[t+1]=i[1],e[t+2]=i[2],t+3},n.loadShaderParams=function(){this._sharderNameID=M.nameKey.get("SkyBox"),this._shaderValue.pushValue("DIFFUSETEXTURE",null)},n._render=function(e){if(this._textureCube&&this._textureCube.loaded){this._vertexBuffer._bind(),this._indexBuffer._bind(),this._shader=this._getShader(e);var n=this._shaderValue.length;this._shaderValue.pushArray(e.shaderValue),this._shaderValue.pushArray(this._vertexBuffer.vertexDeclaration.shaderValues),e.camera.transform.worldMatrix.cloneTo(t._tempMatrix4x40),t._tempMatrix4x40.transpose(),Te.multiply(e.projectionMatrix,t._tempMatrix4x40,t._tempMatrix4x41),this._shaderValue.pushValue("MVPMATRIX",t._tempMatrix4x41.elements),this._shaderValue.pushValue("INTENSITY",this._colorIntensity),this._shaderValue.pushValue("ALPHABLENDING",this.alphaBlending),this._shaderValue.data[1]=this.textureCube.source,this._shader.uploadArray(this._shaderValue.data,this._shaderValue.length,null),this._shaderValue.length=n,R.mainContext.drawElements(4,36,5123,0),V.trianglesFaces+=12,V.drawCall++}},a(0,n,"alphaBlending",function(){return this._alphaBlending},function(e){this._alphaBlending=e,this._alphaBlending<0&&(this._alphaBlending=0),this._alphaBlending>1&&(this._alphaBlending=1)}),a(0,n,"colorIntensity",function(){return this._colorIntensity},function(e){this._colorIntensity=e,this._colorIntensity<0&&(this._colorIntensity=0)}),a(0,n,"textureCube",function(){return this._textureCube},function(e){this._textureCube=e}),t._nameNumber=1,i(t,["_tempMatrix4x40",function(){return this._tempMatrix4x40=new Te},"_tempMatrix4x41",function(){return this._tempMatrix4x41=new Te},"_vertexDeclaration",function(){return this._vertexDeclaration=new Q(12,[new Y(0,"vector3","POSITION")])}]),t}(ke),function(e){function t(){this._sharderNameID=0,this._shader=null,this._numberVertices=0,this._numberIndices=0,this._vertexBuffer=null,this._indexBuffer=null,this._alphaBlending=1,this._colorIntensity=1,this._texture=null,this._stacks=16,this._slices=16,this._radius=1,this._shaderValue=new P,t.__super.call(this),this.name="SkyDome-"+t._nameNumber,t._nameNumber++,this.loadShaderParams(),this.recreateResource()}r(t,"laya.d3.resource.models.SkyDome",e);var n=t.prototype;return n._getShader=function(e){var t=e.shaderDefs,n=t._value,i=(t._value|e.shadingMode)+2e-4*this._sharderNameID;return this._shader=M.withCompile(this._sharderNameID,e.shadingMode,e.shaderDefs.toNameDic(),i,null),t._value=n,this._shader},n.recreateResource=function(){this.startCreate(),this._numberVertices=(this._stacks+1)*(this._slices+1),this._numberIndices=3*this._stacks*(this._slices+1)*2;for(var e=new Uint16Array(this._numberIndices),n=t._vertexDeclaration.vertexStride/4,i=new Float32Array(this._numberVertices*n),r=Math.PI/this._stacks,a=2*Math.PI/this._slices,s=0,o=0,h=0,l=0;l<this._stacks+1;l++)for(var u=Math.sin(l*r),_=Math.cos(l*r),c=0;c<this._slices+1;c++){var d=u*Math.sin(c*a),f=u*Math.cos(c*a);i[o+0]=d*this._radius,i[o+1]=_*this._radius,i[o+2]=f*this._radius,i[o+3]=c/this._slices,i[o+4]=l/this._stacks,o+=n,l!=this._stacks-1&&(e[h++]=s+1,e[h++]=s,e[h++]=s+(this._slices+1),e[h++]=s+(this._slices+1),e[h++]=s,e[h++]=s+this._slices,s++)}this._vertexBuffer=new it(t._vertexDeclaration,this._numberVertices,35044),this._indexBuffer=new nt("ushort",this._numberIndices,35044),this._vertexBuffer.setData(i),this._indexBuffer.setData(e),this.memorySize=2*(this._vertexBuffer.byteLength+this._indexBuffer.byteLength),this.completeCreate()},n.loadShaderParams=function(){this._sharderNameID=M.nameKey.get("SkyDome"),this._shaderValue.pushValue("DIFFUSETEXTURE",null)},n._render=function(e){if(this._texture&&this._texture.loaded){this._vertexBuffer._bind(),this._indexBuffer._bind(),this._shader=this._getShader(e);var n=this._shaderValue.length;this._shaderValue.pushArray(e.shaderValue),this._shaderValue.pushArray(this._vertexBuffer.vertexDeclaration.shaderValues),e.camera.transform.worldMatrix.cloneTo(t._tempMatrix4x40),t._tempMatrix4x40.transpose(),Te.multiply(e.projectionMatrix,t._tempMatrix4x40,t._tempMatrix4x41),this._shaderValue.pushValue("MVPMATRIX",t._tempMatrix4x41.elements),this._shaderValue.pushValue("INTENSITY",this._colorIntensity),this._shaderValue.pushValue("ALPHABLENDING",this.alphaBlending),this._shaderValue.data[1]=this.texture.source,this._shader.uploadArray(this._shaderValue.data,this._shaderValue.length,null),this._shaderValue.length=n,R.mainContext.drawElements(4,this._indexBuffer.indexCount,5123,0),V.trianglesFaces+=this._numberIndices/3,V.drawCall++}},a(0,n,"alphaBlending",function(){return this._alphaBlending},function(e){this._alphaBlending=e,this._alphaBlending<0&&(this._alphaBlending=0),this._alphaBlending>1&&(this._alphaBlending=1)}),a(0,n,"colorIntensity",function(){return this._colorIntensity},function(e){this._colorIntensity=e,this._colorIntensity<0&&(this._colorIntensity=0)}),a(0,n,"texture",function(){return this._texture},function(e){this._texture=e}),t._nameNumber=1,i(t,["_tempMatrix4x40",function(){return this._tempMatrix4x40=new Te},"_tempMatrix4x41",function(){return this._tempMatrix4x41=new Te},"_vertexDeclaration",function(){return this._vertexDeclaration=new Q(20,[new Y(0,"vector3","POSITION"),new Y(12,"vector2","UV")])}]),t}(ke),function(e){function t(e){this._src=null,this._image=null,this._recreateLock=!1,this._needReleaseAgain=!1,t.__super.call(this),this._src=e,this._image=new h.window.Image,this._image.crossOrigin="";var n=new g;n.once("complete",this,this._onTextureLoaded),n.load(e,"nativeimage",!1)}r(t,"laya.d3.resource.Texture2D",e);var n=t.prototype;return n._onTextureLoaded=function(e){this._image=e;var t=e.width,n=e.height;this._width=t,this._height=n,this._size=new Pe(t,n),this._loaded=!0,this.event("loaded",this)},n._createWebGlTexture=function(){if(!this._image)throw"create GLTextur err:no data:"+this._image;var e=R.mainContext,t=this._source=e.createTexture(),n=this._width,i=this._height,r=O.curBindTexTarget,a=O.curBindTexValue;O.bindTexture(e,3553,t),e.texImage2D(3553,0,6408,6408,5121,this._image);var s=this._minFifter,h=this._magFifter,l=this._repeat?10497:33071,u=o.isPOT(n,i);u?(this._mipmap?-1!==s||(s=9987):-1!==s||(s=9729),-1!==h||(h=9729),e.texParameteri(3553,10241,s),e.texParameteri(3553,10240,h),e.texParameteri(3553,10242,l),e.texParameteri(3553,10243,l),this._mipmap&&e.generateMipmap(3553)):(-1!==s||(s=9729),-1!==h||(h=9729),e.texParameteri(3553,10241,s),e.texParameteri(3553,10240,h),e.texParameteri(3553,10242,33071),e.texParameteri(3553,10243,33071)),r&&a&&O.bindTexture(e,r,a),this._image.onload=null,this._image=null,u?this.memorySize=n*i*4*(1+1/3):this.memorySize=n*i*4,this._recreateLock=!1},n.recreateResource=function(){if(null!=this._src&&""!==this._src)if(this._needReleaseAgain=!1,this._image){if(this._recreateLock)return;this.startCreate(),this._createWebGlTexture(),this.completeCreate()}else{this._recreateLock=!0,this.startCreate();var e=this;this._image=new h.window.Image,this._image.crossOrigin="",this._image.onload=function(){return e._needReleaseAgain?(e._needReleaseAgain=!1,e._image.onload=null,void(e._image=null)):(e._createWebGlTexture(),void e.completeCreate())},this._image.src=this._src}},n.detoryResource=function(){this._recreateLock&&(this._needReleaseAgain=!0),this._source&&(R.mainContext.deleteTexture(this._source),this._source=null,this._image=null,this.memorySize=0)},a(0,n,"src",function(){return this._src}),t}(He)),ht=function(e){function t(e,i){if(this._texCount=6,this._recreateLock=!1,this._needReleaseAgain=!1,void 0===i&&(i=512),t.__super.call(this),e.length<this._texCount)throw new Error("srcs路径数组长度小于6！");this._loadedImgCount=0,this._srcs=e,this._width=i,this._height=i,this._images=[];for(var r=0;r<this._texCount;r++)n.loader.load(this._srcs[r],m.create(this,this._onSubCubeTextureLoaded,[r],!0),null,"nativeimage",1,!1)}r(t,"laya.d3.resource.TextureCube",e);var i=t.prototype;return i._onSubCubeTextureLoaded=function(e,t){this._images[e]=t,this._loadedImgCount++,this._loadedImgCount==this._texCount&&(this._loaded=!0,this.event("loaded",this))},i._createWebGlTexture=function(){var e=0;for(e=0;e<this._texCount;e++)if(!this._images[e])throw"create GLTextur err:no data:"+this._images[e];var t=R.mainContext,n=this._source=t.createTexture(),i=this._width,r=this._height,a=O.curBindTexTarget,s=O.curBindTexValue;O.bindTexture(t,34067,n),t.texImage2D(34069,0,6408,6408,5121,this._images[0]),t.texImage2D(34070,0,6408,6408,5121,this._images[1]),t.texImage2D(34071,0,6408,6408,5121,this._images[2]),t.texImage2D(34072,0,6408,6408,5121,this._images[3]),t.texImage2D(34073,0,6408,6408,5121,this._images[4]),t.texImage2D(34074,0,6408,6408,5121,this._images[5]);var h=this.minFifter,l=this.magFifter,u=this.repeat?10497:33071,_=o.isPOT(i,r);for(_?(this.mipmap?-1!==h||(h=9987):-1!==h||(h=9729),-1!==l||(l=9729),t.texParameteri(34067,10241,h),t.texParameteri(34067,10240,l),t.texParameteri(34067,10242,u),t.texParameteri(34067,10243,u),this.mipmap&&t.generateMipmap(34067)):(-1!==h||(h=9729),-1!==l||(l=9729),t.texParameteri(34067,10241,h),t.texParameteri(34067,10240,l),t.texParameteri(34067,10242,33071),t.texParameteri(34067,10243,33071)),a&&s&&O.bindTexture(t,a,s),e=0;6>e;e++)this._images[e].onload=null,this._images[e]=null;_?this.memorySize=i*r*4*(1+1/3)*this._texCount:this.memorySize=i*r*4*this._texCount,this._recreateLock=!1},i.recreateResource=function(){var e=this;if(null!=this._srcs)if(this._needReleaseAgain=!1,this._images[0]){if(this._recreateLock)return;this.startCreate(),this._createWebGlTexture(),this.completeCreate()}else{this._recreateLock=!0,this.startCreate();for(var t=this,n=0;n<this._texCount;n++){this._images[n]=new h.window.Image,this._images[n].crossOrigin="";var i=n;this._images[i].onload=function(){var n=0;if(t._needReleaseAgain){for(n=0;n<e._texCount;n++)if(!t._images[n].complete)return;for(t._needReleaseAgain=!1,n=0;n<e._texCount;n++)t._images[n].onload=null,t._images[n]=null}else{for(n=0;n<e._texCount;n++)if(!t._images[n].complete)return;t._createWebGlTexture(),t.completeCreate()}},this._images[n].src=this._srcs[n]}}},i.detoryResource=function(){this._recreateLock&&(this._needReleaseAgain=!0),this._source&&(R.mainContext.deleteTexture(this._source),this._source=null,this.memorySize=0)},a(0,i,"srcs",function(){return this._srcs}),t}(He),lt=(function(e){function t(){this._tempCurAnimationData=null,this._lastFrameIndex=-1,this._currentTransform=null,this._originalAnimationTransform=null,this._originalFov=0,this._camera=null,this._cacheAnimationDatas=[],this._currentAnimationData=null,this.localMode=!0,this.addMode=!0,this._tempVector30=new De,this._tempVector31=new De,this._tempVector32=new De,t.__super.call(this)}r(t,"laya.d3.component.animation.CameraAnimations",e);var n=t.prototype;return n._effect=function(){var e=0;for(e=0;3>e;e++)this._tempVector30.elements[e]=this._currentAnimationData[e],this._tempVector31.elements[e]=this._currentAnimationData[e+3],this._tempVector32.elements[e]=this._currentAnimationData[e+6];this._currentTransform||(this._currentTransform=new Te),Te.createLookAt(this._tempVector30,this._tempVector31,this._tempVector32,this._currentTransform),this._currentTransform.invert(this._currentTransform),this.addMode&&Te.multiply(this._originalAnimationTransform,this._currentTransform,this._currentTransform),this.localMode?this.owner.transform.localMatrix=this._currentTransform:this.owner.transform.worldMatrix=this._currentTransform,this._camera.fieldOfView=this._currentAnimationData[9]},n._load=function(e){var t=this;if(!(e instanceof laya.d3.core.Camera))throw new Error("该Sprite3D并非Camera");this._camera=e,this._player.on("stopped",this,function(){t._player.returnToZeroStopped&&(t.localMode?t._originalAnimationTransform&&(e.transform.localMatrix=t._originalAnimationTransform):t._originalAnimationTransform&&(e.transform.worldMatrix=t._originalAnimationTransform),t._camera.fieldOfView=t._originalFov)})},n._update=function(e){if(this._templet&&this._templet.loaded&&2===this._player.state){var t=this._player.playbackRate*e.scene.timer.scale,n=this._player.isCache&&t>=1?this.currentFrameIndex:-1,i=this.currentAnimationClipIndex;if(-1!==n&&this._lastFrameIndex===n)return void laya.d3.component.Component3D.prototype._update.call(this,e);if(this._player.isCache&&t>=1){var r=this._templet.getAnimationDataWithCache(this._player.cacheFrameRate,this._cacheAnimationDatas,i,n);if(r)return this._currentAnimationData=r,this._lastFrameIndex=n,laya.d3.component.Component3D.prototype._update.call(this,e),void this._effect()}var a=this._templet.getNodes(i),s=a.length;this._player.isCache&&t>=1?this._currentAnimationData=new Float32Array(10*s):(this._tempCurAnimationData||(this._tempCurAnimationData=new Float32Array(10*s)),this._currentAnimationData=this._tempCurAnimationData),this._player.isCache&&t>=1?this._templet.getOriginalData(i,this._currentAnimationData,this._player._fullFrames[i],n,this._player.currentPlayTime):this._templet.getOriginalDataUnfixedRate(i,this._currentAnimationData,this._player.currentPlayTime),this._player.isCache&&t>=1&&this._templet.setAnimationDataWithCache(this._player.cacheFrameRate,this._cacheAnimationDatas,i,n,this._currentAnimationData),this._lastFrameIndex=n,laya.d3.component.Component3D.prototype._update.call(this,e),this._effect()}},t}(ze),function(e){function t(){this._animationSprites=null,this._animationSpritesInitLocalMatrix=null,this._tempCurAnimationData=null,this._curOriginalData=null,this._lastFrameIndex=-1,this._curAnimationDatas=null,t.__super.call(this),this._animationSprites=[],this._animationSpritesInitLocalMatrix=[]}r(t,"laya.d3.component.animation.RigidAnimations",e);var n=t.prototype;return n._init=function(){for(var e=this._templet.getNodes(this.currentAnimationClipIndex),t=this._owner,n=e.length,i=0,r=new Uint16Array(this._templet.getPublicExtData()),a=0;n>a;a++){var s=r.slice(i+1,i+1+r[i]);i+=r[i]+1;for(var o=1;o<s.length;o++){s[o];t=t._childs[s[o]]}var h=t.getChildByName(e[a].name);if(!h)break;
this._animationSprites[a]=h;var l=this._animationSpritesInitLocalMatrix[a];l||(l=this._animationSpritesInitLocalMatrix[a]=new Te),h.transform.localMatrix.cloneTo(l),t=this._owner}},n._animtionPlay=function(){this._templet.loaded?this._init():this._templet.once("loaded",this,this._init)},n._animtionStop=function(){if(this._lastFrameIndex=-1,this._player.returnToZeroStopped){this._curAnimationDatas=null;for(var e=0;e<this._animationSprites.length;e++)this._animationSprites[e].transform.localMatrix=this._animationSpritesInitLocalMatrix[e]}},n._effectAnimation=function(e){for(var t=0,n=this._animationSprites.length;n>t;t++){for(var i=this._animationSprites[t],r=i.transform.localMatrix,a=r.elements,s=0;16>s;s++)a[s]=this._curAnimationDatas[16*t+s];i.transform.localMatrix=r}},n._load=function(t){e.prototype._load.call(this,t),this._player.on("stopped",this,this._animtionStop),this._player.on("played",this,this._animtionPlay)},n._update=function(e){if(2===this._player.state&&this._templet&&this._templet.loaded){var t=this._player.playbackRate*e.scene.timer.scale,n=this._player.cachePlayRate,i=this._player.isCache&&t>=n,r=i?this.currentFrameIndex:-1;if(-1===r||this._lastFrameIndex!==r){var a=this.currentAnimationClipIndex,s=this._templet.getNodes(a),o=this._templet._animationDatasCache;if(i){var h=this._templet.getAnimationDataWithCache(n,o,a,r);if(h)return this._curAnimationDatas=h,this._lastFrameIndex=r,void this._effectAnimation(s)}var l=16*s.length;i?this._curAnimationDatas=new Float32Array(l):(this._tempCurAnimationData||(this._tempCurAnimationData=new Float32Array(l)),this._curAnimationDatas=this._tempCurAnimationData),this._curOriginalData||(this._curOriginalData=new Float32Array(this._templet.getTotalkeyframesLength(a))),i?this._templet.getOriginalData(a,this._curOriginalData,this._player._fullFrames[a],r,this._player.currentFrameTime):this._templet.getOriginalDataUnfixedRate(a,this._curOriginalData,this._player.currentPlayTime),Se._computeRootAnimationData(s,this._curOriginalData,this._curAnimationDatas),i&&this._templet.setAnimationDataWithCache(n,o,a,r,this._curAnimationDatas),this._lastFrameIndex=r,this._effectAnimation(s)}}},n._unload=function(t){e.prototype._unload.call(this,t),this._player.off("stopped",this,this._animtionStop),this._player.off("played",this,this._animtionPlay)},a(0,n,"url",e.prototype._$get_url,function(t){e.prototype._$set_url.call(this,t),this._curOriginalData=null,this._curAnimationDatas=null,this._tempCurAnimationData=null,this._templet._animationDatasCache||(this._templet._animationDatasCache=[])}),t}(ze),function(e){function t(){this._tempCurAnimationData=null,this._tempCurBonesData=null,this._curOriginalData=null,this._extenData=null,this._lastFrameIndex=-1,this._curMeshAnimationData=null,this._curBonesDatas=null,this._curAnimationDatas=null,this._ownerMesh=null,t.__super.call(this)}r(t,"laya.d3.component.animation.SkinAnimations",e);var n=t.prototype;return n._getAnimationDatasWithCache=function(e,t,n,i,r){var a=n[i];if(a){var s=a[e];if(s){var o=s[t.id];return o?o[r]:null}return null}return null},n._setAnimationDatasWithCache=function(e,t,n,i,r,a){var s=n[i]||(n[i]={}),o=s[e]||(s[e]={}),h=o[t.id]||(o[t.id]=[]);h[r]=a},n._onAnimationStop=function(){this._lastFrameIndex=-1,this._player.returnToZeroStopped&&(this._curBonesDatas=null,this._curAnimationDatas=null)},n._load=function(t){e.prototype._load.call(this,t),this._ownerMesh=t,this._player.on("stopped",this,this._onAnimationStop)},n.preComputeKeyFrames=function(e){if(!this._templet.loaded||!this._ownerMesh.meshFilter.sharedMesh.loaded)throw new Error("SkinAnimations: must to be sure animation templet and mesh templet has loaded.");for(var n=this._player.cachePlayRate,i=this._player.cacheFrameRateInterval*n,r=Math.floor(this._templet.getAniDuration(e)/i),a=0;r>=a;a++){var s=this._templet._animationDatasCache[0],o=this._templet._animationDatasCache[1],h=this._ownerMesh.meshFilter.sharedMesh,l=this._getAnimationDatasWithCache(n,h,o,e,a);if(!l){var u=this._templet.getNodes(e),_=16*u.length;this._curMeshAnimationData||(this._curMeshAnimationData=new Float32Array(_));var c=0,d=0;for(this._curAnimationDatas=[],c=0,d=h.getSubMeshCount();d>c;c++)this._curAnimationDatas[c]=new Float32Array(16*h.getSubMesh(c)._boneIndices.length);this._curBonesDatas=new Float32Array(_),this._curOriginalData||(this._curOriginalData=new Float32Array(this._templet.getTotalkeyframesLength(e))),this._templet.getOriginalData(e,this._curOriginalData,this._player._fullFrames[e],a,i*a);var f=h.InverseAbsoluteBindPoses;for(f?Se._computeBoneAndAnimationDatasByBindPoseMatrxix(u,this._curOriginalData,f,this._curBonesDatas,this._curMeshAnimationData):(this._extenData||(this._extenData=new Float32Array(this._templet.getPublicExtData())),Se._computeBoneAndAnimationDatas(u,this._curOriginalData,this._extenData,this._curBonesDatas,this._curMeshAnimationData)),c=0,d=h.getSubMeshCount();d>c;c++){var m=h.getSubMesh(c);t._computeSubMeshAniDatas(c,m._boneIndices,this._curMeshAnimationData,this._curAnimationDatas)}this._setAnimationDatasWithCache(n,h,o,e,a,this._curAnimationDatas),this._templet.setAnimationDataWithCache(n,s,e,a,this._curBonesDatas)}}},n._update=function(e){var n=this._ownerMesh.meshFilter.sharedMesh;if(2===this._player.state&&this._templet&&this._templet.loaded&&n.loaded){var i=this._player.playbackRate*e.scene.timer.scale,r=this._player.cachePlayRate,a=this._player.isCache&&i>=r,s=a?this.currentFrameIndex:-1;if(-1===s||this._lastFrameIndex!==s){var o=this.currentAnimationClipIndex,h=this._templet._animationDatasCache[0],l=this._templet._animationDatasCache[1];if(a){var u=this._getAnimationDatasWithCache(r,n,l,o,s);if(u)return this._curAnimationDatas=u,this._curBonesDatas=this._templet.getAnimationDataWithCache(r,h,o,s),void(this._lastFrameIndex=s)}var _=!1;a&&(this._curBonesDatas=this._templet.getAnimationDataWithCache(r,h,o,s),_=!!this._curBonesDatas);var c=this._templet.getNodes(o),d=16*c.length;this._curMeshAnimationData||(this._curMeshAnimationData=new Float32Array(d));var f=0,m=0;if(a){for(this._curAnimationDatas=[],f=0,m=n.getSubMeshCount();m>f;f++)this._curAnimationDatas[f]=new Float32Array(16*n.getSubMesh(f)._boneIndices.length);_||(this._curBonesDatas=new Float32Array(d))}else{if(!this._tempCurAnimationData)for(this._tempCurAnimationData=[],f=0,m=n.getSubMeshCount();m>f;f++)this._tempCurAnimationData[f]=new Float32Array(16*n.getSubMesh(f)._boneIndices.length);this._tempCurBonesData||(this._tempCurBonesData=new Float32Array(d)),this._curAnimationDatas=this._tempCurAnimationData,this._curBonesDatas=this._tempCurBonesData}this._curOriginalData||(this._curOriginalData=new Float32Array(this._templet.getTotalkeyframesLength(o))),a?this._templet.getOriginalData(o,this._curOriginalData,this._player._fullFrames[o],s,this._player.currentFrameTime):this._templet.getOriginalDataUnfixedRate(o,this._curOriginalData,this._player.currentPlayTime);var p=n.InverseAbsoluteBindPoses;for(p?a&&_?Se._computeAnimationDatasByArrayAndMatrixFast(p,this._curBonesDatas,this._curMeshAnimationData):Se._computeBoneAndAnimationDatasByBindPoseMatrxix(c,this._curOriginalData,p,this._curBonesDatas,this._curMeshAnimationData):(this._extenData||(this._extenData=new Float32Array(this._templet.getPublicExtData())),a&&_?Se._computeAnimationDatas(this._extenData,this._curBonesDatas,this._curMeshAnimationData):Se._computeBoneAndAnimationDatas(c,this._curOriginalData,this._extenData,this._curBonesDatas,this._curMeshAnimationData)),f=0,m=n.getSubMeshCount();m>f;f++){var v=n.getSubMesh(f);t._computeSubMeshAniDatas(f,v._boneIndices,this._curMeshAnimationData,this._curAnimationDatas)}a&&(this._setAnimationDatasWithCache(r,n,l,o,s,this._curAnimationDatas),_||this._templet.setAnimationDataWithCache(r,h,o,s,this._curBonesDatas)),this._lastFrameIndex=s}}},n._preRenderUpdate=function(e){if(this._curAnimationDatas){e.shaderDefs.addInt(512);var t=e.renderElement.renderObj.indexOfHost;e.shaderValue.pushValue("MATRIXARRAY0",this._curAnimationDatas[t])}},n._unload=function(t){e.prototype._unload.call(this,t),this._player.off("stopped",this,this._onAnimationStop)},a(0,n,"curBonesDatas",function(){return this._curBonesDatas}),a(0,n,"curAnimationDatas",function(){return this._curAnimationDatas}),a(0,n,"url",e.prototype._$get_url,function(t){e.prototype._$set_url.call(this,t),this._curOriginalData=this._extenData=null,this._curMeshAnimationData=null,this._tempCurBonesData=null,this._tempCurAnimationData=null,this._templet._animationDatasCache||(this._templet._animationDatasCache=[[],[]])}),t._computeSubMeshAniDatas=function(e,t,n,i){for(var r=i[e],a=0,s=t.length,o=0;s>a;a++)for(var h=0;16>h;h++,o++)r[o]=n[(t[a]<<4)+h]},t._copyBone=function(e,t,n){for(var i=0,r=e.length,a=0;r>i;i++)for(var s=0;16>s;s++,a++)n[a]=t[(e[i]<<4)+s]},t}(ze));(function(e){function t(){this._nodes=null,this._lasstInitIndex=-1,this._materials=null,this._mesh=null,this._meshDataInited=!1,this._uvDatasCount=0,this._subMeshIndexToNodeIndex=[],this._keyframeAges=[],this._ages=[],this._bufferUsages=[],this._originalShaderAttributes=[],this._uvShaderValues=[],this._uvNextShaderValues=[],this._uvAnimationBuffers=[],t.__super.call(this),this._meshDataInited=!1}r(t,"laya.d3.component.animation.UVAnimations",e);var n=t.prototype;return n._initMeshData=function(){this._materials=this._mesh.meshRender.sharedMaterials,this._meshDataInited=!0},n._initAnimationData=function(e){},n._load=function(e){if(!(e instanceof laya.d3.core.MeshSprite3D))throw new Error("该Sprite3D并非Mesh");this._mesh=e,e.on("loaded",this,function(e){}),this.on("loaded",this,function(){}),this.player.on("played",this,function(){}),this.player.on("stopped",this,function(){})},n._update=function(e){if(this.player.update(e.elapsedTime),this._templet&&this._templet.loaded&&2===this.player.state){for(var t=this.currentAnimationClipIndex,n=this._templet.getNodesCurrentFrameIndex(t,this.player.currentPlayTime),i=0;i<this._nodes.length;i++){var r=n[i];this._keyframeAges[i]=(this.player.currentPlayTime-this._nodes[i].keyFrame[r].startTime)/this._nodes[i].keyFrame[r].duration,this._ages[i]=this.player.currentPlayTime/this._nodes[i].playTime;var a=this._nodes[i].keyframeWidth/this._uvDatasCount;this._uvShaderValues[i]||(this._uvShaderValues[i]=[]),this._uvNextShaderValues[i]||(this._uvNextShaderValues[i]=[]);for(var s=0;s<this._uvDatasCount;s++){var o=[2,5126,!1,0,r*a*4],h=[2,5126,!1,0,(r+1)*a*4];this._uvShaderValues[i][s]=o,this._uvNextShaderValues[i][s]=h}}laya.d3.component.Component3D.prototype._update.call(this,e)}},n._preRenderUpdate=function(e){},t})(ze),function(e){function t(){t.__super.call(this)}r(t,"laya.d3.core.scene.Scene",e);var n=t.prototype;return n.renderCamera=function(e,t,n){this._prepareScene(e,n,t),this.beforeUpate(t),this._updateScene(t),this.lateUpate(t),this.beforeRender(t);var i=n.renderTarget;i?(i.start(),Te.multiply(this._invertYScaleMatrix,n.projectionMatrix,this._invertYProjectionMatrix),Te.multiply(this._invertYScaleMatrix,n.projectionViewMatrix,this._invertYProjectionViewMatrix),t.projectionMatrix=this._invertYProjectionMatrix,t.projectionViewMatrix=this._invertYProjectionViewMatrix):(t.projectionMatrix=n.projectionMatrix,t.projectionViewMatrix=n.projectionViewMatrix),t.viewMatrix=n.viewMatrix,t.viewport=n.viewport,this._preRenderScene(e,t),this._clear(e,t),this._renderScene(e,t),this.lateRender(t),i&&i.end()},n.renderSubmit=function(){var e=R.mainContext,t=this._renderState;this._set3DRenderConfig(e);for(var n=0,i=this._cameraPool.length;i>n;n++){var r=this._cameraPool[n];r.enable&&this.renderCamera(e,t,r)}return this._set2DRenderConfig(e),1},t}($e),function(e){function t(){t.__super.call(this)}r(t,"laya.d3.core.scene.VRScene",e);var n=t.prototype;return n.renderCamera=function(e,t,n){this._prepareScene(e,n,t),t.shaderDefs.add(524288),this.beforeUpate(t),this._updateScene(t),this.lateUpate(t),this.beforeRender(t);var i=n.renderTarget;i?(i.start(),Te.multiply(this._invertYScaleMatrix,n.leftProjectionMatrix,this._invertYProjectionMatrix),Te.multiply(this._invertYScaleMatrix,n.leftProjectionViewMatrix,this._invertYProjectionViewMatrix),t.projectionMatrix=this._invertYProjectionMatrix,t.projectionViewMatrix=this._invertYProjectionViewMatrix):(t.projectionMatrix=n.leftProjectionMatrix,t.projectionViewMatrix=n.leftProjectionViewMatrix),t.viewMatrix=n.leftViewMatrix,t.viewport=n.leftViewport,this._preRenderScene(e,t),this._clear(e,t),this._renderScene(e,t),i?(i.start(),Te.multiply(this._invertYScaleMatrix,n.rightProjectionMatrix,this._invertYProjectionMatrix),Te.multiply(this._invertYScaleMatrix,n.rightProjectionViewMatrix,this._invertYProjectionViewMatrix),t.projectionMatrix=this._invertYProjectionMatrix,t.projectionViewMatrix=this._invertYProjectionViewMatrix):(t.projectionMatrix=n.rightProjectionMatrix,t.projectionViewMatrix=n.rightProjectionViewMatrix),t.viewMatrix=n.rightViewMatrix,t.viewport=n.rightViewport,this._preRenderScene(e,t),this._clear(e,t),this._renderScene(e,t),this.lateRender(t),i&&i.end()},n.renderSubmit=function(){var e=R.mainContext,t=this._renderState;this._set3DRenderConfig(e);for(var n=0,i=this._cameraPool.length;i>n;n++){var r=this._cameraPool[n];r.enable&&this.renderCamera(e,t,r)}return this._set2DRenderConfig(e),1},t}($e),function(e){function t(e,n,i){void 0===e&&(e=0),void 0===n&&(n=.1),void 0===i&&(i=1e3),this._viewMatrix=new Te,this._projectionMatrix=new Te,this._projectionViewMatrix=new Te,this._viewport=new ye(0,0,0,0),this._normalizedViewport=new ye(0,0,1,1),this._aspectRatio=e,t.__super.call(this,n,i)}r(t,"laya.d3.core.Camera",e);var n=t.prototype;return n._calculateProjectionMatrix=function(){if(!this._useUserProjectionMatrix)if(this.orthographicProjection){var e=this.orthographicVerticalSize*this.aspectRatio*.5,t=.5*this.orthographicVerticalSize;Te.createOrthogonal(-e,e,-t,t,this.nearPlane,this.farPlane,this._projectionMatrix)}else Te.createPerspective(3.1416*this.fieldOfView/180,this.aspectRatio,this.nearPlane,this.farPlane,this._projectionMatrix);this._projectionMatrixModifyID+=.01/this.id},n.viewportPointToRay=function(e,t){Ve.calculateCursorRay(e,this.viewport,this._projectionMatrix,this.viewMatrix,null,t)},n.normalizedViewportPointToRay=function(e,n){var i=t._tempVector2,r=this.viewport,a=e.elements,s=i.elements;s[0]=a[0]*r.width,s[1]=a[1]*r.height,Ve.calculateCursorRay(i,this.viewport,this._projectionMatrix,this.viewMatrix,null,n)},n.worldToViewportPoint=function(e,t){if(Te.multiply(this._projectionMatrix,this._viewMatrix,this._projectionViewMatrix),this.viewport.project(e,this._projectionViewMatrix,t),t.z<0||t.z>1){var n=t.elements;n[0]=n[1]=n[2]=NaN}},n.worldToNormalizedViewportPoint=function(e,t){if(Te.multiply(this._projectionMatrix,this._viewMatrix,this._projectionViewMatrix),this.normalizedViewport.project(e,this._projectionViewMatrix,t),t.z<0||t.z>1){var n=t.elements;n[0]=n[1]=n[2]=NaN}},a(0,n,"aspectRatio",function(){if(0===this._aspectRatio){var e=this.viewport;return e.width/e.height}return this._aspectRatio},function(e){if(0>e)throw new Error("Camera: the aspect ratio has to be a positive real number.");this._aspectRatio=e,this._calculateProjectionMatrix()}),a(0,n,"normalizedViewport",function(){if(!this._viewportExpressedInClipSpace){var e=this._viewport,t=this.renderTargetSize,n=t.width,i=t.height;this._normalizedViewport.x=e.x/n,this._normalizedViewport.y=e.y/i,this._normalizedViewport.width=e.width/n,this._normalizedViewport.height=e.height/i}return this._normalizedViewport},function(e){if(e.x<0||e.y<0||e.x+e.width>1||e.x+e.height>1)throw new Error("Camera: viewport size invalid.","value");this._viewportExpressedInClipSpace=!0,this._normalizedViewport=e,this._calculateProjectionMatrix()}),a(0,n,"viewport",function(){if(this._viewportExpressedInClipSpace){var e=this._normalizedViewport,t=this.renderTargetSize,n=t.width,i=t.height;this._viewport.x=e.x*n,this._viewport.y=e.y*i,this._viewport.width=e.width*n,this._viewport.height=e.height*i}return this._viewport},function(e){if(null!=this.renderTarget&&(e.x<0||e.y<0||0==e.width||0==e.height))throw new Error("Camera: viewport size invalid.","value");this._viewportExpressedInClipSpace=!1,this._viewport=e,this._calculateProjectionMatrix()}),a(0,n,"needViewport",function(){var e=this.normalizedViewport;return 0===e.x&&0===e.y&&1===e.width&&1===e.height}),a(0,n,"viewMatrix",function(){return this.transform.worldMatrix.invert(this._viewMatrix),this._viewMatrix}),a(0,n,"projectionMatrix",function(){return this._projectionMatrix},function(e){this._projectionMatrix=e,this._useUserProjectionMatrix=!0}),a(0,n,"projectionViewMatrix",function(){return Te.multiply(this.projectionMatrix,this.viewMatrix,this._projectionViewMatrix),this._projectionViewMatrix}),i(t,["_tempVector2",function(){return this._tempVector2=new Ee}]),t}(Je),function(e){function t(){this._direction=null,t.__super.call(this),this._diffuseColor=new De(1,1,1),this._ambientColor=new De(.6,.6,.6),this._specularColor=new De(1,1,1),this._reflectColor=new De(1,1,1),this._direction=new De(0,-.5,-1)}r(t,"laya.d3.core.light.DirectionLight",e);var n=t.prototype;return n.updateToWorldState=function(e){if(e.scene.enableLight){var t=e.worldShaderValue;V.loopCount;e.shaderDefs.add(64),t.pushValue("LIGHTDIRDIFFUSE",this.diffuseColor.elements),t.pushValue("LIGHTDIRAMBIENT",this.ambientColor.elements),t.pushValue("LIGHTDIRSPECULAR",this.specularColor.elements),t.pushValue("LIGHTDIRECTION",this.direction.elements)}},a(0,n,"direction",function(){return this._direction},function(e){this._direction=e}),a(0,n,"lightType",function(){return 1}),t}(et),function(e){function t(){this._attenuation=null,this._range=NaN,t.__super.call(this),this._diffuseColor=new De(1,1,1),this._ambientColor=new De(.2,.2,.2),this._specularColor=new De(1,0,0),this._reflectColor=new De(1,1,1),this.transform.position=new De(0,0,0),this._range=6,this._attenuation=new De(.6,.6,.6)}r(t,"laya.d3.core.light.PointLight",e);var n=t.prototype;return n.updateToWorldState=function(e){if(e.scene.enableLight){var t=e.worldShaderValue;V.loopCount;e.shaderDefs.add(128),t.pushValue("POINTLIGHTDIFFUSE",this.diffuseColor.elements),t.pushValue("POINTLIGHTAMBIENT",this.ambientColor.elements),t.pushValue("POINTLIGHTSPECULAR",this.specularColor.elements),t.pushValue("POINTLIGHTPOS",this.transform.position.elements),t.pushValue("POINTLIGHTRANGE",this.range),t.pushValue("POINTLIGHTATTENUATION",this.attenuation.elements)}},a(0,n,"range",function(){return this._range},function(e){this._range=e}),a(0,n,"attenuation",function(){return this._attenuation},function(e){this._attenuation=e}),a(0,n,"lightType",function(){return 2}),t}(et),function(e){function t(){this._direction=null,this._attenuation=null,this._spot=NaN,this._range=NaN,t.__super.call(this),this._diffuseColor=new De(1,1,1),this._ambientColor=new De(.2,.2,.2),this._specularColor=new De(1,1,1),this._reflectColor=new De(1,1,1),this.transform.position=new De(0,1,1),this._direction=new De(0,-1,-1),this._attenuation=new De(.6,.6,.6),this._spot=96,this._range=6}r(t,"laya.d3.core.light.SpotLight",e);var n=t.prototype;return n.updateToWorldState=function(e){if(e.scene.enableLight){var t=e.worldShaderValue;V.loopCount;e.shaderDefs.add(256),t.pushValue("SPOTLIGHTDIFFUSE",this.diffuseColor.elements),t.pushValue("SPOTLIGHTAMBIENT",this.ambientColor.elements),t.pushValue("SPOTLIGHTSPECULAR",this.specularColor.elements),t.pushValue("SPOTLIGHTPOS",this.transform.position.elements),t.pushValue("SPOTLIGHTDIRECTION",this.direction.elements),t.pushValue("SPOTLIGHTRANGE",this.range),t.pushValue("SPOTLIGHTSPOT",this.spot),t.pushValue("SPOTLIGHTATTENUATION",this.attenuation.elements)}},a(0,n,"direction",function(){return this._direction},function(e){this._direction=e}),a(0,n,"attenuation",function(){return this._attenuation},function(e){this._attenuation=e}),a(0,n,"spot",function(){return this._spot},function(e){this._spot=e}),a(0,n,"range",function(){return this._range},function(e){this._range=e}),a(0,n,"lightType",function(){return 3}),t}(et),function(e){function t(e,n,i,r,a){void 0===e&&(e=.1),void 0===n&&(n=0),void 0===i&&(i=0),void 0===r&&(r=.1),void 0===a&&(a=1e3),this._tempMatrix=new Te,this._leftViewMatrix=new Te,this._leftProjectionMatrix=new Te,this._leftProjectionViewMatrix=new Te,this._leftViewport=new ye(0,0,0,0),this._leftNormalizedViewport=new ye(0,0,.5,1),this._leftAspectRatio=n,this._rightViewMatrix=new Te,this._rightProjectionMatrix=new Te,this._rightProjectionViewMatrix=new Te,this._rightViewport=new ye(0,0,0,0),this._rightNormalizedViewport=new ye(.5,0,.5,1),this._rightAspectRatio=i,this._pupilDistande=e,t.__super.call(this,r,a)}r(t,"laya.d3.core.VRCamera",e);var n=t.prototype;return n._calculatePupilOffset=function(){var e=this._tempVector3;return De.scale(this.right,this._pupilDistande/2,e),e.elements},n._calculateLeftProjectionMatrix=function(){if(!this._useUserProjectionMatrix)if(this.orthographicProjection){var e=this.orthographicVerticalSize*this.leftAspectRatio*.5,t=.5*this.orthographicVerticalSize;Te.createOrthogonal(-e,e,-t,t,this.nearPlane,this.farPlane,this._leftProjectionMatrix)}else Te.createPerspective(3.1416*this.fieldOfView/180,this.leftAspectRatio,this.nearPlane,this.farPlane,this._rightProjectionMatrix);this._projectionMatrixModifyID+=.01/this.id},n._calculateRightProjectionMatrix=function(){if(!this._useUserProjectionMatrix)if(this.orthographicProjection){var e=this.orthographicVerticalSize*this.rightAspectRatio*.5,t=.5*this.orthographicVerticalSize;Te.createOrthogonal(-e,e,t,t,this.nearPlane,this.farPlane,this._rightProjectionMatrix)}else Te.createPerspective(3.1416*this.fieldOfView/180,this.rightAspectRatio,this.nearPlane,this.farPlane,this._rightProjectionMatrix);this._projectionMatrixModifyID+=.01/this.id},n._calculateProjectionMatrix=function(){if(!this._useUserProjectionMatrix)if(this.orthographicProjection){var e=this.orthographicVerticalSize*this.leftAspectRatio*.5,t=.5*this.orthographicVerticalSize,n=this.orthographicVerticalSize*this.rightAspectRatio*.5,i=.5*this.orthographicVerticalSize;Te.createOrthogonal(-e,e,-t,t,this.nearPlane,this.farPlane,this._leftProjectionMatrix),Te.createOrthogonal(-n,n,i,i,this.nearPlane,this.farPlane,this._rightProjectionMatrix)}else Te.createPerspective(3.1416*this.fieldOfView/180,this.leftAspectRatio,this.nearPlane,this.farPlane,this._leftProjectionMatrix),Te.createPerspective(3.1416*this.fieldOfView/180,this.rightAspectRatio,this.nearPlane,this.farPlane,this._rightProjectionMatrix);this._projectionMatrixModifyID+=.01/this.id},a(0,n,"aspectRatio",null,function(e){if(0>e)throw new Error("VRCamera: the aspect ratio has to be a positive real number.");this._leftAspectRatio=e,this._rightAspectRatio=e,this._calculateRightProjectionMatrix()}),a(0,n,"normalizedViewport",null,function(e){if(e.x<0||e.y<0||e.x+e.width>1||e.x+e.height>1)throw new Error("VRCamera: viewport size invalid.","value");this._viewportExpressedInClipSpace=!0,this._leftNormalizedViewport=new ye(0,0,e.width/2,e.height),this._rightNormalizedViewport=new ye(e.width/2,0,e.width/2,e.height),this._calculateProjectionMatrix()}),a(0,n,"leftAspectRatio",function(){if(0===this._leftAspectRatio){var e=this.leftViewport;return e.width/e.height}return this._leftAspectRatio}),a(0,n,"rightProjectionViewMatrix",function(){return Te.multiply(this.rightProjectionMatrix,this.rightViewMatrix,this._rightProjectionViewMatrix),this._rightProjectionViewMatrix}),a(0,n,"viewport",null,function(e){if(null!=this.renderTarget&&(e.x<0||e.y<0||0==e.width||0==e.height))throw new Error("VRCamera: viewport size invalid.","value");this._viewportExpressedInClipSpace=!1,this._leftViewport=new ye(0,0,e.width/2,e.height),this._rightViewport=new ye(e.width/2,0,e.width/2,e.height),this._calculateProjectionMatrix()}),a(0,n,"leftViewport",function(){if(this._viewportExpressedInClipSpace){var e=this._leftNormalizedViewport,t=this.renderTargetSize,n=t.width,i=t.height;this._leftViewport.x=e.x*n,this._leftViewport.y=e.y*i,this._leftViewport.width=e.width*n,this._leftViewport.height=e.height*i}return this._leftViewport}),a(0,n,"rightNormalizedViewport",function(){if(!this._viewportExpressedInClipSpace){var e=this._rightViewport,t=this.renderTargetSize,n=t.width,i=t.height;this._rightNormalizedViewport.x=e.x/n,this._rightNormalizedViewport.y=e.y/i,this._rightNormalizedViewport.width=e.width/n,this._rightNormalizedViewport.height=e.height/i}return this._rightNormalizedViewport}),a(0,n,"rightAspectRatio",function(){if(0===this._rightAspectRatio){var e=this.rightViewport;return e.width/e.height}return this._rightAspectRatio}),a(0,n,"rightViewport",function(){if(this._viewportExpressedInClipSpace){var e=this._rightNormalizedViewport,t=this.renderTargetSize,n=t.width,i=t.height;this._rightViewport.x=e.x*n,this._rightViewport.y=e.y*i,this._rightViewport.width=e.width*n,this._rightViewport.height=e.height*i}return this._rightViewport}),a(0,n,"leftNormalizedViewport",function(){if(!this._viewportExpressedInClipSpace){var e=this._leftViewport,t=this.renderTargetSize,n=t.width,i=t.height;this._leftNormalizedViewport.x=e.x/n,this._leftNormalizedViewport.y=e.y/i,this._leftNormalizedViewport.width=e.width/n,this._leftNormalizedViewport.height=e.height/i}return this._leftNormalizedViewport}),a(0,n,"needLeftViewport",function(){var e=this.leftNormalizedViewport;return 0===e.x&&0===e.y&&1===e.width&&1===e.height}),a(0,n,"needRightViewport",function(){var e=this.rightNormalizedViewport;return 0===e.x&&0===e.y&&1===e.width&&1===e.height}),a(0,n,"leftViewMatrix",function(){var e=this._calculatePupilOffset(),t=this._tempMatrix;this.transform.worldMatrix.cloneTo(t);var n=t.elements;return n[12]-=e[0],n[13]-=e[1],n[14]-=e[2],t.invert(this._leftViewMatrix),this._leftViewMatrix}),a(0,n,"rightViewMatrix",function(){var e=this._calculatePupilOffset(),t=this._tempMatrix;this.transform.worldMatrix.cloneTo(t);var n=t.elements;return n[12]+=e[0],n[13]+=e[1],n[14]+=e[2],t.invert(this._rightViewMatrix),this._rightViewMatrix}),a(0,n,"leftProjectionMatrix",function(){return this._leftProjectionMatrix}),a(0,n,"rightProjectionMatrix",function(){return this._rightProjectionMatrix}),a(0,n,"leftProjectionViewMatrix",function(){return Te.multiply(this.leftProjectionMatrix,this.leftViewMatrix,this._leftProjectionViewMatrix),this._leftProjectionViewMatrix}),t}(Je),function(e){function t(e,n,i){this._minX=NaN,this._minZ=NaN,this._cellSize=null,this._heightMap=null,t.__super.call(this,e,i),this._heightMap=n,this._cellSize=new Ee}r(t,"laya.d3.core.MeshTerrainSprite3D",e);var n=t.prototype;return n._disableRotation=function(){var e=this.transform.rotation;e.elements[0]=0,e.elements[1]=0,e.elements[2]=0,e.elements[3]=1,this.transform.rotation=e},n._getScaleX=function(){var e=this.transform.worldMatrix,t=e.elements,n=t[0],i=t[1],r=t[2];return Math.sqrt(n*n+i*i+r*r)},n._getScaleZ=function(){var e=this.transform.worldMatrix,t=e.elements,n=t[8],i=t[9],r=t[10];return Math.sqrt(n*n+i*i+r*r)},n._initCreateFromMesh=function(e,t){this._heightMap=L.creatFromMesh(this.meshFilter.sharedMesh,e,t,this._cellSize);var n=this.meshFilter.sharedMesh.boundingBox,i=n.min;n.max;this._minX=i.x,this._minZ=i.z},n._createFromMeshAndHeightMapMeshLoaded=function(e,t,n,i){this._initCreateFromMeshHeightMap(t,n,i)},n._initCreateFromMeshHeightMap=function(e,t,n){var i=this,r=this.meshFilter.sharedMesh.boundingBox;e.loaded?(this._heightMap=L.createFromImage(e,t,n),this._computeCellSize(r)):e.once("loaded",null,function(){i._heightMap=L.createFromImage(e,t,n),i._computeCellSize(r)});var a=r.min;r.max;this._minX=a.x,this._minZ=a.z},n._computeCellSize=function(e){var t=e.min,n=e.max,i=t.x,r=t.z,a=n.x,s=n.z,o=a-i,h=s-r;this._cellSize.elements[0]=o/(this._heightMap.width-1),this._cellSize.elements[1]=h/(this._heightMap.height-1)},n._update=function(t){this._disableRotation(),e.prototype._update.call(this,t)},n.getHeight=function(e,n){t._tempVector3.elements[0]=e,t._tempVector3.elements[1]=0,t._tempVector3.elements[2]=n,this._disableRotation();var i=this.transform.worldMatrix;i.invert(t._tempMatrix4x4),De.transformCoordinate(t._tempVector3,t._tempMatrix4x4,t._tempVector3),e=t._tempVector3.elements[0],n=t._tempVector3.elements[2];var r=(e-this._minX)/this._cellSize.x,a=(n-this._minZ)/this._cellSize.y,s=Math.floor(a),o=Math.floor(r),h=r-o,l=a-s,u=NaN,_=NaN,c=i.elements,d=c[4],f=c[5],m=c[6],p=Math.sqrt(d*d+f*f+m*m),v=c[13],g=this._heightMap.getHeight(s,o+1),x=this._heightMap.getHeight(s+1,o);if(isNaN(g)||isNaN(x))return NaN;if(1>=h+l){var T=this._heightMap.getHeight(s,o);return isNaN(T)?NaN:(u=g-T,_=x-T,(T+h*u+l*_)*p+v)}var C=this._heightMap.getHeight(s+1,o+1);return isNaN(C)?NaN:(u=x-C,_=g-C,(C+(1-h)*u+(1-l)*_)*p+v)},a(0,n,"minX",function(){var e=this.transform.worldMatrix,t=e.elements;return this._minX*this._getScaleX()+t[12]}),a(0,n,"minZ",function(){var e=this.transform.worldMatrix,t=e.elements;return this._minZ*this._getScaleZ()+t[14]}),a(0,n,"width",function(){return(this._heightMap.width-1)*this._cellSize.x*this._getScaleX()}),a(0,n,"depth",function(){return(this._heightMap.height-1)*this._cellSize.y*this._getScaleZ()}),t.createFromMesh=function(e,n,i,r){var a=new t(e,null,r);return e.loaded?a._initCreateFromMesh(n,i):e.once("loaded",a,a._initCreateFromMesh,[n,i]),a},t.createFromMeshAndHeightMap=function(e,n,i,r,a){var s=new t(e,null,a);return e.loaded?s._initCreateFromMeshHeightMap(n,i,r):e.once("loaded",s,s._createFromMeshAndHeightMapMeshLoaded,[n,r]),s},i(t,["_tempVector3",function(){return this._tempVector3=new De},"_tempMatrix4x4",function(){return this._tempMatrix4x4=new Te}]),t}(tt),function(e){function t(e,n,i){this._long=NaN,this._width=NaN,this._height=NaN,void 0===e&&(e=1),void 0===n&&(n=1),void 0===i&&(i=1),t.__super.call(this),this._long=e,this._width=n,this._height=i,this.recreateResource(),this._loaded=!0;var r=this.positions;this._boundingBox=new me(new De,new De),me.createfromPoints(r,this._boundingBox),this._boundingSphere=new ve(new De,0),ve.createfromPoints(r,this._boundingSphere)}r(t,"laya.d3.resource.models.BoxMesh",e);var n=t.prototype;return n.recreateResource=function(){this.startCreate(),this._numberVertices=24,this._numberIndices=36;var e=new Uint16Array(this._numberIndices),t=he.vertexDeclaration,n=t.vertexStride/4,i=new Float32Array(this._numberVertices*n),r=this._long/2,a=this._width/2,s=0;i[s+0]=-r,i[s+1]=this._height,i[s+2]=-a,i[s+3]=0,i[s+4]=1,i[s+5]=0,i[s+6]=0,i[s+7]=0,s+=8,i[s+0]=r,i[s+1]=this._height,i[s+2]=-a,i[s+3]=0,i[s+4]=1,i[s+5]=0,i[s+6]=1,i[s+7]=0,s+=8,i[s+0]=r,i[s+1]=this._height,i[s+2]=a,i[s+3]=0,i[s+4]=1,i[s+5]=0,i[s+6]=1,i[s+7]=1,s+=8,i[s+0]=-r,i[s+1]=this._height,i[s+2]=a,i[s+3]=0,i[s+4]=1,i[s+5]=0,i[s+6]=0,i[s+7]=1,s+=8,i[s+0]=-r,i[s+1]=0,i[s+2]=-a,i[s+3]=0,i[s+4]=-1,i[s+5]=0,i[s+6]=1,i[s+7]=0,s+=8,i[s+0]=r,i[s+1]=0,i[s+2]=-a,i[s+3]=0,i[s+4]=-1,i[s+5]=0,i[s+6]=0,i[s+7]=0,s+=8,i[s+0]=r,i[s+1]=0,i[s+2]=a,i[s+3]=0,i[s+4]=-1,i[s+5]=0,i[s+6]=0,i[s+7]=1,s+=8,i[s+0]=-r,i[s+1]=0,i[s+2]=a,i[s+3]=0,i[s+4]=-1,i[s+5]=0,i[s+6]=1,i[s+7]=1,s+=8,i[s+0]=-r,i[s+1]=this._height,i[s+2]=-a,i[s+3]=-1,i[s+4]=0,i[s+5]=0,i[s+6]=0,i[s+7]=0,s+=8,i[s+0]=-r,i[s+1]=this._height,i[s+2]=a,i[s+3]=-1,i[s+4]=0,i[s+5]=0,i[s+6]=1,i[s+7]=0,s+=8,i[s+0]=-r,i[s+1]=0,i[s+2]=a,i[s+3]=-1,i[s+4]=0,i[s+5]=0,i[s+6]=1,i[s+7]=1,s+=8,i[s+0]=-r,i[s+1]=0,i[s+2]=-a,i[s+3]=-1,i[s+4]=0,i[s+5]=0,i[s+6]=0,i[s+7]=1,s+=8,i[s+0]=r,i[s+1]=this._height,i[s+2]=-a,i[s+3]=1,i[s+4]=0,i[s+5]=0,i[s+6]=1,i[s+7]=0,s+=8,i[s+0]=r,i[s+1]=this._height,i[s+2]=a,i[s+3]=1,i[s+4]=0,i[s+5]=0,i[s+6]=0,i[s+7]=0,s+=8,i[s+0]=r,i[s+1]=0,i[s+2]=a,i[s+3]=1,i[s+4]=0,i[s+5]=0,i[s+6]=0,i[s+7]=1,s+=8,i[s+0]=r,i[s+1]=0,i[s+2]=-a,i[s+3]=1,i[s+4]=0,i[s+5]=0,i[s+6]=1,i[s+7]=1,s+=8,i[s+0]=-r,i[s+1]=this._height,i[s+2]=a,i[s+3]=0,i[s+4]=0,i[s+5]=1,i[s+6]=0,i[s+7]=0,s+=8,i[s+0]=r,i[s+1]=this._height,i[s+2]=a,i[s+3]=0,i[s+4]=0,i[s+5]=1,i[s+6]=1,i[s+7]=0,s+=8,i[s+0]=r,i[s+1]=0,i[s+2]=a,i[s+3]=0,i[s+4]=0,i[s+5]=1,i[s+6]=1,i[s+7]=1,s+=8,i[s+0]=-r,i[s+1]=0,i[s+2]=a,i[s+3]=0,i[s+4]=0,i[s+5]=1,i[s+6]=0,i[s+7]=1,s+=8,i[s+0]=-r,i[s+1]=this._height,i[s+2]=-a,i[s+3]=0,
i[s+4]=0,i[s+5]=-1,i[s+6]=1,i[s+7]=0,s+=8,i[s+0]=r,i[s+1]=this._height,i[s+2]=-a,i[s+3]=0,i[s+4]=0,i[s+5]=-1,i[s+6]=0,i[s+7]=0,s+=8,i[s+0]=r,i[s+1]=0,i[s+2]=-a,i[s+3]=0,i[s+4]=0,i[s+5]=-1,i[s+6]=0,i[s+7]=1,s+=8,i[s+0]=-r,i[s+1]=0,i[s+2]=-a,i[s+3]=0,i[s+4]=0,i[s+5]=-1,i[s+6]=1,i[s+7]=1;var o=0;e[o+0]=0,e[o+1]=1,e[o+2]=2,o+=3,e[o+0]=2,e[o+1]=3,e[o+2]=0,o+=3,e[o+0]=4,e[o+1]=7,e[o+2]=6,o+=3,e[o+0]=6,e[o+1]=5,e[o+2]=4,o+=3,e[o+0]=8,e[o+1]=9,e[o+2]=10,o+=3,e[o+0]=10,e[o+1]=11,e[o+2]=8,o+=3,e[o+0]=12,e[o+1]=15,e[o+2]=14,o+=3,e[o+0]=14,e[o+1]=13,e[o+2]=12,o+=3,e[o+0]=16,e[o+1]=17,e[o+2]=18,o+=3,e[o+0]=18,e[o+1]=19,e[o+2]=16,o+=3,e[o+0]=20,e[o+1]=23,e[o+2]=22,o+=3,e[o+0]=22,e[o+1]=21,e[o+2]=20,this._vertexBuffer=new it(t,this._numberVertices,35044,!0),this._indexBuffer=new nt("ushort",this._numberIndices,35044,!0),this._vertexBuffer.setData(i),this._indexBuffer.setData(e),this.memorySize=2*(this._vertexBuffer.byteLength+this._indexBuffer.byteLength),this.completeCreate()},a(0,n,"height",function(){return this._height},function(e){this._height=e,this.recreateResource()}),a(0,n,"long",function(){return this._long},function(e){this._long=e,this.recreateResource()}),a(0,n,"width",function(){return this._width},function(e){this._width=e,this.recreateResource()}),t}(rt),function(e){function t(e,n,i,r){this._radius=NaN,this._height=NaN,this._slices=0,this._stacks=0,void 0===e&&(e=10),void 0===n&&(n=10),void 0===i&&(i=8),void 0===r&&(r=8),t.__super.call(this),this._radius=e,this._height=n,this._stacks=i,this._slices=r,this.recreateResource(),this._loaded=!0;var a=this.positions;this._boundingBox=new me(new De,new De),me.createfromPoints(a,this._boundingBox),this._boundingSphere=new ve(new De,0),ve.createfromPoints(a,this._boundingSphere)}r(t,"laya.d3.resource.models.CylinderMesh",e);var n=t.prototype;return n.recreateResource=function(){this.startCreate(),this._numberVertices=(this._stacks+1+2)*(this._slices+1),this._numberIndices=2*(this._slices-1+this._stacks*this._slices)*3;for(var e=new Uint16Array(this._numberIndices),t=he.vertexDeclaration,n=t.vertexStride/4,i=new Float32Array(this._numberVertices*n),r=2*Math.PI/this._slices,a=0,s=.5,o=.5,h=.5,l=.5,u=.5,_=0,c=0,d=1,f=1,m=0,p=0,v=0,g=0;g<this._slices+1;g++){var x=Math.cos(a),T=Math.sin(a);a+=r,i[v++]=this._radius*x,i[v++]=this._radius*T,i[v++]=0,i[v++]=0,i[v++]=0,i[v++]=-1,i[v++]=h*x+s,i[v++]=h*T+o}for(g=2;g<this._slices+1;g++)e[m++]=0,e[m++]=g-1,e[m++]=g;p+=this._slices+1;for(var C=this._height/this._stacks,b=0,I=0;I<this._stacks+1;I++){for(g=0;g<this._slices+1;g++){var E=i[g*n],D=i[g*n+1];if(i[v++]=E,i[v++]=D,i[v++]=b,i[v++]=E,i[v++]=D,i[v++]=0,i[v++]=_+g*(d-_)/this._slices,i[v++]=f+I*(c-f)/this._stacks,I>0&&g>0){var M=p-1,y=p,w=p-(this._slices+1),V=p-(this._slices+1)-1;e[m++]=V,e[m++]=M,e[m++]=y,e[m++]=V,e[m++]=y,e[m++]=w}p++}b+=C}for(g=0;g<this._slices+1;g++)E=i[g*n],D=i[g*n+1],i[v++]=E,i[v++]=D,i[v++]=this._height,i[v++]=0,i[v++]=0,i[v++]=1,i[v++]=h*E/this._radius+l,i[v++]=h*D/this._radius+u;for(g=2;g<this._slices+1;g++)e[m++]=p,e[m++]=p+g,e[m++]=p+g-1;p+=this._slices+1,this._vertexBuffer=new it(t,this._numberVertices,35044,!0),this._indexBuffer=new nt("ushort",this._numberIndices,35044,!0),this._vertexBuffer.setData(i),this._indexBuffer.setData(e),this.memorySize=2*(this._vertexBuffer.byteLength+this._indexBuffer.byteLength),this.completeCreate()},a(0,n,"radius",function(){return this._radius},function(e){this._radius=e,this.recreateResource()}),a(0,n,"slices",function(){return this._slices},function(e){this._slices=e,this.recreateResource()}),a(0,n,"stacks",function(){return this._stacks},function(e){this._stacks=e,this.recreateResource()}),t}(rt),function(e){function t(e,n,i){this._radius=NaN,this._slices=0,this._stacks=0,void 0===e&&(e=10),void 0===n&&(n=8),void 0===i&&(i=8),t.__super.call(this),this._radius=e,this._stacks=n,this._slices=i,this.recreateResource(),this._loaded=!0;var r=this.positions;this._boundingBox=new me(new De,new De),me.createfromPoints(r,this._boundingBox),this._boundingSphere=new ve(new De,0),ve.createfromPoints(r,this._boundingSphere)}r(t,"laya.d3.resource.models.SphereMesh",e);var n=t.prototype;return n.recreateResource=function(){this.startCreate(),this._numberVertices=(this._stacks+1)*(this._slices+1),this._numberIndices=3*this._stacks*(this._slices+1)*2;for(var e=new Uint16Array(this._numberIndices),t=he.vertexDeclaration,n=t.vertexStride/4,i=new Float32Array(this._numberVertices*n),r=Math.PI/this._stacks,a=2*Math.PI/this._slices,s=0,o=0,h=0,l=0;l<this._stacks+1;l++)for(var u=Math.sin(l*r),_=Math.cos(l*r),c=0;c<this._slices+1;c++){var d=u*Math.sin(c*a),f=u*Math.cos(c*a);i[o+0]=d*this._radius,i[o+1]=_*this._radius,i[o+2]=f*this._radius,i[o+3]=d,i[o+4]=_,i[o+5]=f,i[o+6]=c/this._slices,i[o+7]=l/this._stacks,o+=n,l!=this._stacks-1&&(e[h++]=s+(this._slices+1),e[h++]=s,e[h++]=s+1,e[h++]=s+this._slices,e[h++]=s,e[h++]=s+(this._slices+1),s++)}this._vertexBuffer=new it(t,this._numberVertices,35044,!0),this._indexBuffer=new nt("ushort",this._numberIndices,35044,!0),this._vertexBuffer.setData(i),this._indexBuffer.setData(e),this.memorySize=2*(this._vertexBuffer.byteLength+this._indexBuffer.byteLength),this.completeCreate()},a(0,n,"radius",function(){return this._radius},function(e){this._radius=e,this.recreateResource()}),a(0,n,"slices",function(){return this._slices},function(e){this._slices=e,this.recreateResource()}),a(0,n,"stacks",function(){return this._stacks},function(e){this._stacks=e,this.recreateResource()}),t}(rt)}(window,document,Laya);