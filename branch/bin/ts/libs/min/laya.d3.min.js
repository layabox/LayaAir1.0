!function(e,t,n){var i=(n.un,n.uns,n.static),r=n.class,a=n.getset,s=n.__newvec,o=laya.ani.AnimationPlayer,l=(laya.ani.AnimationState,laya.ani.AnimationTemplet),h=laya.maths.Arith,u=laya.webgl.shader.BaseShader,c=(laya.resource.Bitmap,laya.utils.Browser),_=laya.webgl.utils.Buffer,d=(laya.webgl.utils.Buffer2D,laya.utils.Byte),m=laya.utils.ClassUtils,f=n.Config,p=laya.particle.emitter.EmitterBase,v=(laya.events.Event,laya.events.EventDispatcher),g=laya.utils.Handler,x=(laya.webgl.utils.IndexBuffer2D,laya.net.Loader),E=laya.net.LoaderManager,M=laya.maths.MathUtil,T=laya.display.Node,S=(laya.particle.ParticleSetting,laya.particle.shader.ParticleShader),y=laya.particle.ParticleTemplateWebGL,D=(laya.maths.Rectangle,laya.renders.Render),R=(laya.renders.RenderContext,laya.renders.RenderSprite,laya.webgl.utils.RenderSprite3D,laya.webgl.utils.RenderState2D),C=laya.resource.Resource,V=laya.utils.RunDriver,A=(laya.webgl.shader.Shader,laya.webgl.utils.ShaderCompile,laya.webgl.shader.ShaderValue,laya.display.Sprite),I=laya.utils.Stat,b=laya.utils.StringKey,w=laya.net.URL,O=laya.utils.Utils,N=(laya.webgl.utils.VertexBuffer2D,laya.webgl.WebGL),P=laya.webgl.WebGLContext;laya.webgl.canvas.WebGLContext2D,laya.webgl.resource.WebGLImage;n.interface("laya.d3.core.IClone"),n.interface("laya.d3.graphics.IVertex"),n.interface("laya.d3.core.render.IUpdate"),n.interface("laya.d3.core.scene.ITreeNode"),n.interface("laya.d3.core.render.IRenderable");var L=function(){function e(){this._tempVector30=new rt,this._tempVector31=new rt,this._tempVector32=new rt,this._a=new rt,this._b=new rt,this._c=new rt,this._d=new rt}r(e,"laya.d3.core.glitter.SplineCurvePositionVelocity");var t=e.prototype;return t.Init=function(e,t,n,i){e.cloneTo(this._d),t.cloneTo(this._c),rt.scale(e,2,this._a),rt.scale(n,2,this._tempVector30),rt.subtract(this._a,this._tempVector30,this._a),rt.add(this._a,t,this._a),rt.add(this._a,i,this._a),rt.scale(n,3,this._b),rt.scale(e,3,this._tempVector30),rt.subtract(this._b,this._tempVector30,this._b),rt.subtract(this._b,i,this._b),rt.scale(t,2,this._tempVector30),rt.subtract(this._b,this._tempVector30,this._b)},t.Slerp=function(e,t){rt.scale(this._a,e*e*e,this._tempVector30),rt.scale(this._b,e*e,this._tempVector31),rt.scale(this._c,e,this._tempVector32),rt.add(this._tempVector30,this._tempVector31,t),rt.add(t,this._tempVector32,t),rt.add(t,this._d,t)},e}(),B=function(){function e(e,t,n,i){this._datas=null,this._w=0,this._h=0,this._minHeight=NaN,this._maxHeight=NaN,this._datas=[],this._w=e,this._h=t,this._minHeight=n,this._maxHeight=i}r(e,"laya.d3.core.HeightMap");var t=e.prototype;return t._inBounds=function(e,t){return e>=0&&e<this._h&&t>=0&&t<this._w},t.getHeight=function(e,t){return this._inBounds(e,t)?this._datas[e][t]:NaN},a(0,t,"width",function(){return this._w}),a(0,t,"height",function(){return this._h}),a(0,t,"maxHeight",function(){return this._maxHeight}),a(0,t,"minHeight",function(){return this._minHeight}),e.creatFromMesh=function(t,n,i,r){for(var a=[],s=[],o=t.getSubMeshCount(),l=0;l<o;l++){for(var h=t.getSubMesh(l),u=h._getVertexBuffer(),c=u.getData(),_=[],d=0;d<c.length;d+=u.vertexDeclaration.vertexStride/4){var m=new rt(c[d+0],c[d+1],c[d+2]);_.push(m)}a.push(_);var f=h._getIndexBuffer();s.push(f.getData())}var p=t.boundingBox,v=p.min.x,g=p.min.z,x=p.max.x,E=p.max.z,M=p.min.y,T=p.max.y,S=x-v,y=E-g,D=r.elements[0]=S/(n-1),R=r.elements[1]=y/(i-1),C=new e(n,i,M,T),V=e._tempRay,A=V.direction.elements;A[0]=0,A[1]=-1,A[2]=0;var I=T+.1;V.origin.elements[1]=I;for(var b=0;b<n;b++){var w=g+b*R;C._datas[b]=[];for(var O=0;O<i;O++){var N=v+O*D,P=V.origin.elements;P[0]=N,P[2]=w;var L=e._getPosition(V,a,s);C._datas[b][O]=L===Number.MAX_VALUE?NaN:I-L}}return C},e.createFromImage=function(t,n,i){for(var r=t.width,a=t.height,s=new e(r,a,n,i),o=(i-n)/254,l=t.getPixels(),h=0,u=0;u<r;u++)for(var c=s._datas[u]=[],_=0;_<a;_++){var d=l[h++],m=l[h++],f=l[h++],p=l[h++];c[_]=255==d&&255==m&&255==f&&255==p?NaN:(d+m+f)/3*o+n}return s},e._getPosition=function(e,t,n){for(var i=Number.MAX_VALUE,r=0;r<t.length;r++)for(var a=t[r],s=n[r],o=0;o<s.length;o+=3){var l=a[s[o+0]],h=a[s[o+1]],u=a[s[o+2]],c=ut.rayIntersectsTriangle(e,l,h,u);!isNaN(c)&&c<i&&(i=c)}return i},i(e,["_tempRay",function(){return this._tempRay=new nt(new rt,new rt)}]),e}(),F=function(){function e(){if(this._id=0,this._number=0,this._mask=0,this._active=!0,this._visible=!0,this._colliders=null,this.name=null,e._uniqueIDCounter>31)throw new Error("不允许创建Layer，请参考函数getLayerByNumber、getLayerByMask、getLayerByName！");this._id=e._uniqueIDCounter,e._uniqueIDCounter++,this._colliders=[]}r(e,"laya.d3.core.Layer");var t=e.prototype;return a(0,t,"number",function(){return this._number}),a(0,t,"visible",function(){return this._visible},function(t){29!==this._number&&30!=this._number&&(this._visible=t,e._visibleLayers=t?e._visibleLayers|this.mask:e._visibleLayers&~this.mask)}),a(0,t,"mask",function(){return this._mask}),a(0,t,"active",function(){return this._active},function(t){29!==this._number&&30!=this._number&&(this._active=t,e._activeLayers=t?e._activeLayers|this.mask:e._activeLayers&~this.mask)}),a(1,e,"activeLayers",function(){return e._activeLayers},function(t){e._activeLayers=t|e.getLayerByNumber(29).mask|e.getLayerByNumber(30).mask;for(var n=0,i=e._layerList.length;n<i;n++){var r=e._layerList[n];r._active=0!=(r._mask&e._activeLayers)}}),a(1,e,"visibleLayers",function(){return e._visibleLayers},function(t){e._visibleLayers=t|e.getLayerByNumber(29).mask|e.getLayerByNumber(30).mask;for(var n=0,i=e._layerList.length;n<i;n++){var r=e._layerList[n];r._visible=0!=(r._mask&e._visibleLayers)}}),e.__init__=function(){e._layerList.length=31;for(var t=0;t<31;t++){var n=new e;e._layerList[t]=n,n.name=0===t?"Default Layer":29===t?"Reserved Layer0":30===t?"Reserved Layer1":"Layer-"+t,n._number=t,n._mask=Math.pow(2,t)}e._activeLayers=2147483647,e._visibleLayers=2147483647,e._currentCameraCullingMask=2147483647,e.currentCreationLayer=e._layerList[0]},e.getLayerByNumber=function(t){if(t<0||t>30)throw new Error("无法返回指定Layer，该number超出范围！");return e._layerList[t]},e.getLayerByMask=function(t){for(var n=0;n<31;n++)if(e._layerList[n].mask===t)return e._layerList[n];throw new Error("无法返回指定Layer,该mask不存在")},e.getLayerByName=function(t){for(var n=0;n<31;n++)if(e._layerList[n].name===t)return e._layerList[n];throw new Error("无法返回指定Layer,该name不存在")},e.isActive=function(t){return 0!=(t&e._activeLayers)},e.isVisible=function(t){return 0!=(t&e._currentCameraCullingMask&e._visibleLayers)},e._uniqueIDCounter=1,e._layerCount=31,e._layerList=[],e._activeLayers=0,e._visibleLayers=0,e._currentCameraCullingMask=0,e.currentCreationLayer=null,e}(),U=function(){function e(e,t,n){this._time=NaN,this._minCount=0,this._maxCount=0,this._time=e,this._minCount=t,this._maxCount=n}r(e,"laya.d3.core.particleShuriKen.module.Burst");var t=e.prototype;return n.imps(t,{"laya.d3.core.IClone":!0}),t.cloneTo=function(e){var t=e;t._time=this._time,t._minCount=this._minCount,t._maxCount=this._maxCount},t.clone=function(){var e=new this.constructor;return this.cloneTo(e),e},a(0,t,"time",function(){return this._time}),a(0,t,"minCount",function(){return this._minCount}),a(0,t,"maxCount",function(){return this._maxCount}),e}(),z=function(){function e(e){this._color=null,this.enbale=!1,this._color=e}r(e,"laya.d3.core.particleShuriKen.module.ColorOverLifetime");var t=e.prototype;return t.cloneTo=function(e){var t=e;this._color.cloneTo(t._color),t.enbale=this.enbale},t.clone=function(){var e;switch(this._color.type){case 0:e=j.createByConstant(this._color.constant.clone());break;case 1:e=j.createByGradient(this._color.gradient.clone());break;case 2:e=j.createByRandomTwoConstant(this._color.constantMin.clone(),this._color.constantMax.clone());break;case 3:e=j.createByRandomTwoGradient(this._color.gradientMin.clone(),this._color.gradientMax.clone())}var t=new this.constructor(e);return t.enbale=this.enbale,t},a(0,t,"color",function(){return this._color}),e}(),H=function(){function e(){this._destroyed=!1,this._emissionRate=0,this._minEmissionTime=NaN,this._particleSystem=null,this._shape=null,this._bursts=null,this.enbale=!1,this._destroyed=!1,this.emissionRate=10,this._bursts=[]}r(e,"laya.d3.core.particleShuriKen.module.Emission");var t=e.prototype;return n.imps(t,{"laya.d3.core.IClone":!0,"laya.resource.IDestroy":!0}),t._destroy=function(){this._bursts=null,this._particleSystem=null,this._destroyed=!0},t.getBurstsCount=function(){return this._bursts.length},t.getBurstByIndex=function(e){return this._bursts[e]},t.addBurst=function(e){var t=this._bursts.length;if(t>0)for(var n=0;n<t;n++)this._bursts[n].time>e.time&&this._bursts.splice(n,0,e);else this._bursts.push(e)},t.removeBurst=function(e){var t=this._bursts.indexOf(e);t!==-1&&this._bursts.splice(t,1)},t.removeBurstByIndex=function(e){this._bursts.splice(e,1)},t.clearBurst=function(){this._bursts.length=0},t.cloneTo=function(e){var t=e,n=t._bursts;n.length=this._bursts.length;for(var i=0,r=this._bursts.length;i<r;i++){var a=n[i];a?this._bursts[i].cloneTo(a):n[i]=this._bursts[i].clone()}t._minEmissionTime=this._minEmissionTime,t._emissionRate=this._emissionRate,t.enbale=this.enbale},t.clone=function(){var e=new this.constructor;return this.cloneTo(e),e},a(0,t,"destroyed",function(){return this._destroyed}),a(0,t,"emissionRate",function(){return this._emissionRate},function(e){if(e<0)throw new Error("ParticleBaseShape:emissionRate value must large or equal than 0.");this._emissionRate=e,this._minEmissionTime=0===e?2147483647:1/e}),e}(),G=function(){function e(){this._type=0,this._constant=0,this._overTime=null,this._constantMin=0,this._constantMax=0,this._overTimeMin=null,this._overTimeMax=null}r(e,"laya.d3.core.particleShuriKen.module.FrameOverTime");var t=e.prototype;return n.imps(t,{"laya.d3.core.IClone":!0}),t.cloneTo=function(e){var t=e;t._type=this._type,t._constant=this._constant,this._overTime.cloneTo(t._overTime),t._constantMin=this._constantMin,t._constantMax=this._constantMax,this._overTimeMin.cloneTo(t._overTimeMin),this._overTimeMax.cloneTo(t._overTimeMax)},t.clone=function(){var e=new this.constructor;return this.cloneTo(e),e},a(0,t,"frameOverTimeData",function(){return this._overTime}),a(0,t,"constant",function(){return this._constant}),a(0,t,"type",function(){return this._type}),a(0,t,"frameOverTimeDataMin",function(){return this._overTimeMin}),a(0,t,"constantMin",function(){return this._constantMin}),a(0,t,"frameOverTimeDataMax",function(){return this._overTimeMax}),a(0,t,"constantMax",function(){return this._constantMax}),e.createByConstant=function(t){var n=new e;return n._type=0,n._constant=t,n},e.createByOverTime=function(t){var n=new e;return n._type=1,n._overTime=t,n},e.createByRandomTwoConstant=function(t,n){var i=new e;return i._type=2,i._constantMin=t,i._constantMax=n,i},e.createByRandomTwoOverTime=function(t,n){var i=new e;return i._type=3,i._overTimeMin=t,i._overTimeMax=n,i},e}(),k=function(){function e(){this._type=0,this._separateAxes=!1,this._constant=NaN,this._constantSeparate=null,this._gradient=null,this._gradientX=null,this._gradientY=null,this._gradientZ=null,this._constantMin=NaN,this._constantMax=NaN,this._constantMinSeparate=null,this._constantMaxSeparate=null,this._gradientMin=null,this._gradientMax=null,this._gradientXMin=null,this._gradientXMax=null,this._gradientYMin=null,this._gradientYMax=null,this._gradientZMin=null,this._gradientZMax=null}r(e,"laya.d3.core.particleShuriKen.module.GradientAngularVelocity");var t=e.prototype;return n.imps(t,{"laya.d3.core.IClone":!0}),t.cloneTo=function(e){var t=e;t._type=this._type,t._separateAxes=this._separateAxes,t._constant=this._constant,this._constantSeparate.cloneTo(t._constantSeparate),this._gradient.cloneTo(t._gradient),this._gradientX.cloneTo(t._gradientX),this._gradientY.cloneTo(t._gradientY),this._gradientZ.cloneTo(t._gradientZ),t._constantMin=this._constantMin,t._constantMax=this._constantMax,this._constantMinSeparate.cloneTo(t._constantMinSeparate),this._constantMaxSeparate.cloneTo(t._constantMaxSeparate),this._gradientMin.cloneTo(t._gradientMin),this._gradientMax.cloneTo(t._gradientMax),this._gradientXMin.cloneTo(t._gradientXMin),this._gradientXMax.cloneTo(t._gradientXMax),this._gradientYMin.cloneTo(t._gradientYMin),this._gradientYMax.cloneTo(t._gradientYMax),this._gradientZMin.cloneTo(t._gradientZMin),this._gradientZMax.cloneTo(t._gradientZMax)},t.clone=function(){var e=new this.constructor;return this.cloneTo(e),e},a(0,t,"gradientZ",function(){return this._gradientZ}),a(0,t,"constant",function(){return this._constant}),a(0,t,"gradient",function(){return this._gradient}),a(0,t,"separateAxes",function(){return this._separateAxes}),a(0,t,"type",function(){return this._type}),a(0,t,"constantSeparate",function(){return this._constantSeparate}),a(0,t,"gradientMin",function(){return this._gradientMin}),a(0,t,"constantMin",function(){return this._constantMin}),a(0,t,"gradientX",function(){return this._gradientX}),a(0,t,"gradientY",function(){return this._gradientY}),a(0,t,"gradientMax",function(){return this._gradientMax}),a(0,t,"constantMax",function(){return this._constantMax}),a(0,t,"constantMinSeparate",function(){return this._constantMinSeparate}),a(0,t,"constantMaxSeparate",function(){return this._constantMaxSeparate}),a(0,t,"gradientXMin",function(){return this._gradientXMin}),a(0,t,"gradientXMax",function(){return this._gradientXMax}),a(0,t,"gradientYMin",function(){return this._gradientYMin}),a(0,t,"gradientYMax",function(){return this._gradientYMax}),a(0,t,"gradientZMin",function(){return this._gradientZMin}),a(0,t,"gradientZMax",function(){return this._gradientZMax}),e.createByConstant=function(t){var n=new e;return n._type=0,n._separateAxes=!1,n._constant=t,n},e.createByConstantSeparate=function(t){var n=new e;return n._type=0,n._separateAxes=!0,n._constantSeparate=t,n},e.createByGradient=function(t){var n=new e;return n._type=1,n._separateAxes=!1,n._gradient=t,n},e.createByGradientSeparate=function(t,n,i){var r=new e;return r._type=1,r._separateAxes=!0,r._gradientX=t,r._gradientY=n,r._gradientZ=i,r},e.createByRandomTwoConstant=function(t,n){var i=new e;return i._type=2,i._separateAxes=!1,i._constantMin=t,i._constantMax=n,i},e.createByRandomTwoConstantSeparate=function(t,n){var i=new e;return i._type=2,i._separateAxes=!0,i._constantMinSeparate=t,i._constantMaxSeparate=n,i},e.createByRandomTwoGradient=function(t,n){var i=new e;return i._type=3,i._separateAxes=!1,i._gradientMin=t,i._gradientMax=n,i},e.createByRandomTwoGradientSeparate=function(t,n,i,r,a,s){var o=new e;return o._type=3,o._separateAxes=!0,o._gradientXMin=t,o._gradientXMax=n,o._gradientYMin=i,o._gradientYMax=r,o._gradientZMin=a,o._gradientZMax=s,o},e}(),j=function(){function e(){this._type=0,this._constant=null,this._constantMin=null,this._constantMax=null,this._gradient=null,this._gradientMin=null,this._gradientMax=null}r(e,"laya.d3.core.particleShuriKen.module.GradientColor");var t=e.prototype;return n.imps(t,{"laya.d3.core.IClone":!0}),t.cloneTo=function(e){var t=e;t._type=this._type,this._constant.cloneTo(t._constant),this._constantMin.cloneTo(t._constantMin),this._constantMax.cloneTo(t._constantMax),this._gradient.cloneTo(t._gradient),this._gradientMin.cloneTo(t._gradientMin),this._gradientMax.cloneTo(t._gradientMax)},t.clone=function(){var e=new this.constructor;return this.cloneTo(e),e},a(0,t,"gradient",function(){return this._gradient}),a(0,t,"constant",function(){return this._constant}),a(0,t,"type",function(){return this._type}),a(0,t,"gradientMin",function(){return this._gradientMin}),a(0,t,"constantMin",function(){return this._constantMin}),a(0,t,"gradientMax",function(){return this._gradientMax}),a(0,t,"constantMax",function(){return this._constantMax}),e.createByConstant=function(t){var n=new e;return n._type=0,n._constant=t,n},e.createByGradient=function(t){var n=new e;return n._type=1,n._gradient=t,n},e.createByRandomTwoConstant=function(t,n){var i=new e;return i._type=2,i._constantMin=t,i._constantMax=n,i},e.createByRandomTwoGradient=function(t,n){var i=new e;return i._type=3,i._gradientMin=t,i._gradientMax=n,i},e}(),Y=function(){function e(){this._alphaCurrentLength=0,this._rgbCurrentLength=0,this._alphaElements=null,this._rgbElements=null,this._alphaElements=new Float32Array(8),this._rgbElements=new Float32Array(16)}r(e,"laya.d3.core.particleShuriKen.module.GradientDataColor");var t=e.prototype;return n.imps(t,{"laya.d3.core.IClone":!0}),t.addAlpha=function(e,t){if(!(this._alphaCurrentLength<8))throw new Error("GradientDataColor:Alpha count must less than 4.");this._alphaElements[this._alphaCurrentLength++]=e,this._alphaElements[this._alphaCurrentLength++]=t},t.addRGB=function(e,t){if(!(this._rgbCurrentLength<16))throw new Error("GradientDataColor:RGB count must less than 4.");this._rgbElements[this._rgbCurrentLength++]=e,this._rgbElements[this._rgbCurrentLength++]=t.x,this._rgbElements[this._rgbCurrentLength++]=t.y,this._rgbElements[this._rgbCurrentLength++]=t.z},t.cloneTo=function(e){var t=e,n=0,i=0;t._alphaCurrentLength=this._alphaCurrentLength;var r=t._alphaElements;for(r.length=this._alphaElements.length,n=0,i=this._alphaElements.length;n<i;n++)r[n]=this._alphaElements[n];t._rgbCurrentLength=this._rgbCurrentLength;var a=t._rgbElements;for(a.length=this._rgbElements.length,n=0,i=this._rgbElements.length;n<i;n++)a[n]=this._rgbElements[n]},t.clone=function(){var e=new this.constructor;return this.cloneTo(e),e},a(0,t,"alphaGradientCount",function(){return this._alphaCurrentLength/2}),a(0,t,"rgbGradientCount",function(){return this._rgbCurrentLength/4}),e}(),W=function(){function e(){this._currentLength=0,this._elements=null,this._elements=new Float32Array(8)}r(e,"laya.d3.core.particleShuriKen.module.GradientDataInt");var t=e.prototype;return n.imps(t,{"laya.d3.core.IClone":!0}),t.add=function(e,t){if(!(this._currentLength<8))throw new Error("GradientDataInt:  Count must less than 4.");this._elements[this._currentLength++]=e,this._elements[this._currentLength++]=t},t.cloneTo=function(e){var t=e;t._currentLength=this._currentLength;var n=t._elements;n.length=this._elements.length;for(var i=0,r=this._elements.length;i<r;i++)n[i]=this._elements[i]},t.clone=function(){var e=new this.constructor;return this.cloneTo(e),e},a(0,t,"gradientCount",function(){return this._currentLength/2}),e}(),X=function(){function e(){this._currentLength=0,this._elements=null,this._elements=new Float32Array(8)}r(e,"laya.d3.core.particleShuriKen.module.GradientDataNumber");var t=e.prototype;return n.imps(t,{"laya.d3.core.IClone":!0}),t.add=function(e,t){if(!(this._currentLength<8))throw new Error("GradientDataNumber: Count must less than 4.");this._elements[this._currentLength++]=e,this._elements[this._currentLength++]=t},t.getKeyByIndex=function(e){return this._elements[2*e]},t.getValueByIndex=function(e){return this._elements[2*e+1]},t.cloneTo=function(e){var t=e;t._currentLength=this._currentLength;var n=t._elements;n.length=this._elements.length;for(var i=0,r=this._elements.length;i<r;i++)n[i]=this._elements[i]},t.clone=function(){var e=new this.constructor;return this.cloneTo(e),e},a(0,t,"gradientCount",function(){return this._currentLength/2}),e}(),q=(function(){function e(){this._currentLength=0,this._elements=null,this._elements=new Float32Array(12)}r(e,"laya.d3.core.particleShuriKen.module.GradientDataVector2");var t=e.prototype;n.imps(t,{"laya.d3.core.IClone":!0}),t.add=function(e,t){if(!(this._currentLength<8))throw new Error("GradientDataVector2:  Count must less than 4.");this._elements[this._currentLength++]=e,this._elements[this._currentLength++]=t.x,this._elements[this._currentLength++]=t.y},t.cloneTo=function(e){var t=e;t._currentLength=this._currentLength;var n=t._elements;n.length=this._elements.length;for(var i=0,r=this._elements.length;i<r;i++)n[i]=this._elements[i]},t.clone=function(){var e=new this.constructor;return this.cloneTo(e),e},a(0,t,"gradientCount",function(){return this._currentLength/3}),e}(),function(){function e(){this._type=0,this._separateAxes=!1,this._gradient=null,this._gradientX=null,this._gradientY=null,this._gradientZ=null,this._constantMin=NaN,this._constantMax=NaN,this._constantMinSeparate=null,this._constantMaxSeparate=null,this._gradientMin=null,this._gradientMax=null,this._gradientXMin=null,this._gradientXMax=null,this._gradientYMin=null,this._gradientYMax=null,this._gradientZMin=null,this._gradientZMax=null}r(e,"laya.d3.core.particleShuriKen.module.GradientSize");var t=e.prototype;return n.imps(t,{"laya.d3.core.IClone":!0}),t.cloneTo=function(e){var t=e;t._type=this._type,t._separateAxes=this._separateAxes,this._gradient.cloneTo(t._gradient),this._gradientX.cloneTo(t._gradientX),this._gradientY.cloneTo(t._gradientY),this._gradientZ.cloneTo(t._gradientZ),t._constantMin=this._constantMin,t._constantMax=this._constantMax,this._constantMinSeparate.cloneTo(t._constantMinSeparate),this._constantMaxSeparate.cloneTo(t._constantMaxSeparate),this._gradientMin.cloneTo(t._gradientMin),this._gradientMax.cloneTo(t._gradientMax),this._gradientXMin.cloneTo(t._gradientXMin),this._gradientXMax.cloneTo(t._gradientXMax),this._gradientYMin.cloneTo(t._gradientYMin),this._gradientYMax.cloneTo(t._gradientYMax),this._gradientZMin.cloneTo(t._gradientZMin),this._gradientZMax.cloneTo(t._gradientZMax)},t.clone=function(){var e=new this.constructor;return this.cloneTo(e),e},a(0,t,"gradientZ",function(){return this._gradientZ}),a(0,t,"gradient",function(){return this._gradient}),a(0,t,"separateAxes",function(){return this._separateAxes}),a(0,t,"type",function(){return this._type}),a(0,t,"gradientMin",function(){return this._gradientMin}),a(0,t,"constantMin",function(){return this._constantMin}),a(0,t,"gradientX",function(){return this._gradientX}),a(0,t,"gradientY",function(){return this._gradientY}),a(0,t,"gradientMax",function(){return this._gradientMax}),a(0,t,"constantMax",function(){return this._constantMax}),a(0,t,"constantMinSeparate",function(){return this._constantMinSeparate}),a(0,t,"constantMaxSeparate",function(){return this._constantMaxSeparate}),a(0,t,"gradientXMin",function(){return this._gradientXMin}),a(0,t,"gradientXMax",function(){return this._gradientXMax}),a(0,t,"gradientYMin",function(){return this._gradientYMin}),a(0,t,"gradientYMax",function(){return this._gradientYMax}),a(0,t,"gradientZMin",function(){return this._gradientZMin}),a(0,t,"gradientZMax",function(){return this._gradientZMax}),e.createByGradient=function(t){var n=new e;return n._type=0,n._separateAxes=!1,n._gradient=t,n},e.createByGradientSeparate=function(t,n,i){var r=new e;return r._type=0,r._separateAxes=!0,r._gradientX=t,r._gradientY=n,r._gradientZ=i,r},e.createByRandomTwoConstant=function(t,n){var i=new e;return i._type=1,i._separateAxes=!1,i._constantMin=t,i._constantMax=n,i},e.createByRandomTwoConstantSeparate=function(t,n){var i=new e;return i._type=1,i._separateAxes=!0,i._constantMinSeparate=t,i._constantMaxSeparate=n,i},e.createByRandomTwoGradient=function(t,n){var i=new e;return i._type=2,i._separateAxes=!1,i._gradientMin=t,i._gradientMax=n,i},e.createByRandomTwoGradientSeparate=function(t,n,i,r,a,s){var o=new e;return o._type=2,o._separateAxes=!0,o._gradientXMin=t,o._gradientXMax=n,o._gradientYMin=i,o._gradientYMax=r,o._gradientZMin=a,o._gradientZMax=s,o},e}()),Z=function(){function e(){this._type=0,this._constant=null,this._gradientX=null,this._gradientY=null,this._gradientZ=null,this._constantMin=null,this._constantMax=null,this._gradientXMin=null,this._gradientXMax=null,this._gradientYMin=null,this._gradientYMax=null,this._gradientZMin=null,this._gradientZMax=null}r(e,"laya.d3.core.particleShuriKen.module.GradientVelocity");var t=e.prototype;return n.imps(t,{"laya.d3.core.IClone":!0}),t.cloneTo=function(e){var t=e;t._type=this._type,this._constant.cloneTo(t._constant),this._gradientX.cloneTo(t._gradientX),this._gradientY.cloneTo(t._gradientY),this._gradientZ.cloneTo(t._gradientZ),this._constantMin.cloneTo(t._constantMin),this._constantMax.cloneTo(t._constantMax),this._gradientXMin.cloneTo(t._gradientXMin),this._gradientXMax.cloneTo(t._gradientXMax),this._gradientYMin.cloneTo(t._gradientYMin),this._gradientYMax.cloneTo(t._gradientYMax),this._gradientZMin.cloneTo(t._gradientZMin),this._gradientZMax.cloneTo(t._gradientZMax)},t.clone=function(){var e=new this.constructor;return this.cloneTo(e),e},a(0,t,"gradientZ",function(){return this._gradientZ}),a(0,t,"constant",function(){return this._constant}),a(0,t,"type",function(){return this._type}),a(0,t,"gradientXMax",function(){return this._gradientXMax}),a(0,t,"constantMin",function(){return this._constantMin}),a(0,t,"gradientX",function(){return this._gradientX}),a(0,t,"gradientY",function(){return this._gradientY}),a(0,t,"gradientXMin",function(){return this._gradientXMin}),a(0,t,"constantMax",function(){return this._constantMax}),a(0,t,"gradientYMin",function(){return this._gradientYMin}),a(0,t,"gradientYMax",function(){return this._gradientYMax}),a(0,t,"gradientZMin",function(){return this._gradientZMin}),a(0,t,"gradientZMax",function(){return this._gradientZMax}),e.createByConstant=function(t){var n=new e;return n._type=0,n._constant=t,n},e.createByGradient=function(t,n,i){var r=new e;return r._type=1,r._gradientX=t,r._gradientY=n,r._gradientZ=i,r},e.createByRandomTwoConstant=function(t,n){var i=new e;return i._type=2,i._constantMin=t,i._constantMax=n,i},e.createByRandomTwoGradient=function(t,n,i,r,a,s){var o=new e;return o._type=3,o._gradientXMin=t,o._gradientXMax=n,o._gradientYMin=i,o._gradientYMax=r,o._gradientZMin=a,o._gradientZMax=s,o},e}(),Q=function(){function e(e){this._angularVelocity=null,this.enbale=!1,this._angularVelocity=e}r(e,"laya.d3.core.particleShuriKen.module.RotationOverLifetime");var t=e.prototype;return n.imps(t,{"laya.d3.core.IClone":!0}),t.cloneTo=function(e){var t=e;this._angularVelocity.cloneTo(t._angularVelocity),t.enbale=this.enbale},t.clone=function(){var e;switch(this._angularVelocity.type){case 0:e=this._angularVelocity.separateAxes?k.createByConstantSeparate(this._angularVelocity.constantSeparate.clone()):k.createByConstant(this._angularVelocity.constant);break;case 1:e=this._angularVelocity.separateAxes?k.createByGradientSeparate(this._angularVelocity.gradientX.clone(),this._angularVelocity.gradientY.clone(),this._angularVelocity.gradientZ.clone()):k.createByGradient(this._angularVelocity.gradient.clone());break;case 2:e=this._angularVelocity.separateAxes?k.createByRandomTwoConstantSeparate(this._angularVelocity.constantMinSeparate.clone(),this._angularVelocity.constantMaxSeparate.clone()):k.createByRandomTwoConstant(this._angularVelocity.constantMin,this._angularVelocity.constantMax);break;case 3:e=this._angularVelocity.separateAxes?k.createByRandomTwoGradientSeparate(this._angularVelocity.gradientXMin.clone(),this._angularVelocity.gradientYMin.clone(),this._angularVelocity.gradientZMin.clone(),this._angularVelocity.gradientXMax.clone(),this._angularVelocity.gradientYMax.clone(),this._angularVelocity.gradientZMax.clone()):k.createByRandomTwoGradient(this._angularVelocity.gradientMin.clone(),this._angularVelocity.gradientMax.clone())}var t=new this.constructor(e);return t.enbale=this.enbale,t},a(0,t,"angularVelocity",function(){return this._angularVelocity}),e}(),K=function(){function e(){this.enable=!1}r(e,"laya.d3.core.particleShuriKen.module.shape.BaseShape");var t=e.prototype;return n.imps(t,{"laya.d3.core.IClone":!0}),t.generatePositionAndDirection=function(e,t,n,i){throw new Error("BaseShape: must override it.")},t.cloneTo=function(e){e.enable=this.enable},t.clone=function(){var e=new this.constructor;return this.cloneTo(e),e},e}(),$=function(){function e(){}return r(e,"laya.d3.core.particleShuriKen.module.shape.ShapeUtils"),e._randomPointUnitArcCircle=function(e,t,n){var i=t.elements,r=NaN;r=n?n.getFloat()*e:Math.random()*e,i[0]=Math.cos(r),i[1]=Math.sin(r)},e._randomPointInsideUnitArcCircle=function(t,n,i){var r=n.elements;e._randomPointUnitArcCircle(t,n,i);var a=NaN;a=i?Math.pow(i.getFloat(),.5):Math.pow(Math.random(),.5),r[0]=r[0]*a,r[1]=r[1]*a},e._randomPointUnitCircle=function(e,t){var n=e.elements,i=NaN;i=t?t.getFloat()*Math.PI*2:Math.random()*Math.PI*2,n[0]=Math.cos(i),n[1]=Math.sin(i)},e._randomPointInsideUnitCircle=function(t,n){var i=t.elements;e._randomPointUnitCircle(t);var r=NaN;r=n?Math.pow(n.getFloat(),.5):Math.pow(Math.random(),.5),i[0]=i[0]*r,i[1]=i[1]*r},e._randomPointUnitSphere=function(e,t){var n=e.elements,i=NaN,r=NaN;t?(i=n[2]=2*t.getFloat()-1,r=t.getFloat()*Math.PI*2):(i=n[2]=2*Math.random()-1,r=Math.random()*Math.PI*2);var a=Math.sqrt(1-i*i);n[0]=a*Math.cos(r),n[1]=a*Math.sin(r)},e._randomPointInsideUnitSphere=function(t,n){var i=t.elements;e._randomPointUnitSphere(t);var r=NaN;r=n?Math.pow(n.getFloat(),1/3):Math.pow(Math.random(),1/3),i[0]=i[0]*r,i[1]=i[1]*r,i[2]=i[2]*r},e._randomPointInsideHalfUnitBox=function(e,t){var n=e.elements;t?(n[0]=t.getFloat()-.5,n[1]=t.getFloat()-.5,n[2]=t.getFloat()-.5):(n[0]=Math.random()-.5,n[1]=Math.random()-.5,n[2]=Math.random()-.5)},e}(),J=function(){function e(e){this._size=null,this.enbale=!1,this._size=e}r(e,"laya.d3.core.particleShuriKen.module.SizeOverLifetime");var t=e.prototype;return n.imps(t,{"laya.d3.core.IClone":!0}),t.cloneTo=function(e){var t=e;this._size.cloneTo(t._size),t.enbale=this.enbale},t.clone=function(){var e;switch(this._size.type){case 0:e=this._size.separateAxes?q.createByGradientSeparate(this._size.gradientX.clone(),this._size.gradientY.clone(),this._size.gradientZ.clone()):q.createByGradient(this._size.gradient.clone());break;case 1:e=this._size.separateAxes?q.createByRandomTwoConstantSeparate(this._size.constantMinSeparate.clone(),this._size.constantMaxSeparate.clone()):q.createByRandomTwoConstant(this._size.constantMin,this._size.constantMax);break;case 2:e=this._size.separateAxes?q.createByRandomTwoGradientSeparate(this._size.gradientXMin.clone(),this._size.gradientYMin.clone(),this._size.gradientZMin.clone(),this._size.gradientXMax.clone(),this._size.gradientYMax.clone(),this._size.gradientZMax.clone()):q.createByRandomTwoGradient(this._size.gradientMin.clone(),this._size.gradientMax.clone())}var t=new this.constructor(e);return t.enbale=this.enbale,t},a(0,t,"size",function(){return this._size}),e}(),ee=function(){function e(){this._type=0,this._constant=NaN,this._constantMin=NaN,this._constantMax=NaN}r(e,"laya.d3.core.particleShuriKen.module.StartFrame");var t=e.prototype;return n.imps(t,{"laya.d3.core.IClone":!0}),t.cloneTo=function(e){var t=e;t._type=this._type,t._constant=this._constant,t._constantMin=this._constantMin,t._constantMax=this._constantMax},t.clone=function(){var e=new this.constructor;return this.cloneTo(e),e},a(0,t,"constant",function(){return this._constant}),a(0,t,"type",function(){return this._type}),a(0,t,"constantMin",function(){return this._constantMin}),a(0,t,"constantMax",function(){return this._constantMax}),e.createByConstant=function(t){var n=new e;return n._type=0,n._constant=t,n},e.createByRandomTwoConstant=function(t,n){var i=new e;return i._type=1,i._constantMin=t,i._constantMax=n,i},e}(),te=function(){function e(e,t){this._frame=null,this._startFrame=null,this.tiles=null,this.type=0,this.randomRow=!1,this.cycles=0,this.enableUVChannels=0,this.enbale=!1,this.tiles=new it(1,1),this.type=0,this.randomRow=!0,this.cycles=1,this.enableUVChannels=1,this._frame=e,this._startFrame=t}r(e,"laya.d3.core.particleShuriKen.module.TextureSheetAnimation");var t=e.prototype;return n.imps(t,{"laya.d3.core.IClone":!0}),t.cloneTo=function(e){var t=e;this.tiles.cloneTo(t.tiles),t.type=this.type,t.randomRow=this.randomRow,this._frame.cloneTo(t._frame),this._startFrame.cloneTo(t._startFrame),t.cycles=this.cycles,t.enableUVChannels=this.enableUVChannels,t.enbale=this.enbale},t.clone=function(){var e;switch(this._frame.type){case 0:e=G.createByConstant(this._frame.constant);break;case 1:e=G.createByOverTime(this._frame.frameOverTimeData.clone());break;case 2:
e=G.createByRandomTwoConstant(this._frame.constantMin,this._frame.constantMax);break;case 3:e=G.createByRandomTwoOverTime(this._frame.frameOverTimeDataMin.clone(),this._frame.frameOverTimeDataMax.clone())}var t;switch(this._startFrame.type){case 0:t=ee.createByConstant(this._startFrame.constant);break;case 1:t=ee.createByRandomTwoConstant(this._startFrame.constantMin,this._startFrame.constantMax)}var n=new this.constructor(e,t);return this.tiles.cloneTo(n.tiles),n.type=this.type,n.randomRow=this.randomRow,n.cycles=this.cycles,n.enableUVChannels=this.enableUVChannels,n.enbale=this.enbale,n},a(0,t,"frame",function(){return this._frame}),a(0,t,"startFrame",function(){return this._startFrame}),e}(),ne=function(){function e(e){this._velocity=null,this.enbale=!1,this.space=0,this._velocity=e}r(e,"laya.d3.core.particleShuriKen.module.VelocityOverLifetime");var t=e.prototype;return n.imps(t,{"laya.d3.core.IClone":!0}),t.cloneTo=function(e){var t=e;this._velocity.cloneTo(t._velocity),t.enbale=this.enbale,t.space=this.space},t.clone=function(){var e;switch(this._velocity.type){case 0:e=Z.createByConstant(this._velocity.constant.clone());break;case 1:e=Z.createByGradient(this._velocity.gradientX.clone(),this._velocity.gradientY.clone(),this._velocity.gradientZ.clone());break;case 2:e=Z.createByRandomTwoConstant(this._velocity.constantMin.clone(),this._velocity.constantMax.clone());break;case 3:e=Z.createByRandomTwoGradient(this._velocity.gradientXMin.clone(),this._velocity.gradientYMin.clone(),this._velocity.gradientZMin.clone(),this._velocity.gradientXMax.clone(),this._velocity.gradientYMax.clone(),this._velocity.gradientZMax.clone())}var t=new this.constructor(e);return t.enbale=this.enbale,t.space=this.space,t},a(0,t,"velocity",function(){return this._velocity}),e}(),ie=function(){function e(){this.startLifeTime=NaN,this.position=null,this.direction=null,this.startColor=null,this.startSize=null,this.startRotation0=null,this.startRotation1=null,this.startRotation2=null,this.time=NaN,this.startSpeed=NaN,this.startUVInfo=null,this.simulationWorldPostion=null}return r(e,"laya.d3.core.particleShuriKen.ShurikenParticleData"),e._getStartLifetimeFromGradient=function(e,t){for(var n=1,i=e.gradientCount;n<i;n++){var r=e.getKeyByIndex(n);if(r>=t){var a=e.getKeyByIndex(n-1),s=(t-a)/(r-a);return M.lerp(e.getValueByIndex(n-1),e.getValueByIndex(n),s)}}throw new Error("ShurikenParticleData: can't get value foam startLifeTimeGradient.")},e.create=function(t,n,i,r,a,s){var o=t.autoRandomSeed,l=t._rand,h=t._randomSeeds,u=new e;switch(u.position=i,u.direction=r,u.startColor=e._tempStartColor,t.startColorType){case 0:var c=u.startColor,_=t.startColorConstant.elements;c[0]=_[0],c[1]=_[1],c[2]=_[2],c[3]=_[3];break;case 2:o?M.lerpVector4(t.startColorConstantMin.elements,t.startColorConstantMax.elements,Math.random(),u.startColor):(l.seed=h[3],M.lerpVector4(t.startColorConstantMin.elements,t.startColorConstantMax.elements,l.getFloat(),u.startColor),h[3]=l.seed)}var d=t.colorOverLifetime;if(d&&d.enbale){var m=u.startColor,f=d.color;switch(f.type){case 0:m[0]=m[0]*f.constant.x,m[1]=m[1]*f.constant.y,m[2]=m[2]*f.constant.z,m[3]=m[3]*f.constant.w;break;case 2:var p=NaN;o?p=Math.random():(l.seed=h[10],p=l.getFloat(),h[10]=l.seed);var v=f.constantMin,g=f.constantMax;m[0]=m[0]*M.lerp(v.x,g.x,p),m[1]=m[1]*M.lerp(v.y,g.y,p),m[2]=m[2]*M.lerp(v.z,g.z,p),m[3]=m[3]*M.lerp(v.w,g.w,p)}}u.startSize=e._tempStartSize;var x=u.startSize;switch(t.startSizeType){case 0:if(t.threeDStartSize){var E=t.startSizeConstantSeparate;x[0]=E.x,x[1]=E.y,x[2]=E.z}else x[0]=x[1]=x[2]=t.startSizeConstant;break;case 2:if(t.threeDStartSize){var T=t.startSizeConstantMinSeparate,S=t.startSizeConstantMaxSeparate;o?(x[0]=M.lerp(T.x,S.x,Math.random()),x[1]=M.lerp(T.y,S.y,Math.random()),x[2]=M.lerp(T.z,S.z,Math.random())):(l.seed=h[4],x[0]=M.lerp(T.x,S.x,l.getFloat()),x[1]=M.lerp(T.y,S.y,l.getFloat()),x[2]=M.lerp(T.z,S.z,l.getFloat()),h[4]=l.seed)}else o?x[0]=x[1]=x[2]=M.lerp(t.startSizeConstantMin,t.startSizeConstantMax,Math.random()):(l.seed=h[4],x[0]=x[1]=x[2]=M.lerp(t.startSizeConstantMin,t.startSizeConstantMax,l.getFloat()),h[4]=l.seed)}var y=t.sizeOverLifetime;if(y&&y.enbale&&1===y.size.type){var D=y.size;if(D.separateAxes)o?(x[0]=x[0]*M.lerp(D.constantMinSeparate.x,D.constantMaxSeparate.x,Math.random()),x[1]=x[1]*M.lerp(D.constantMinSeparate.y,D.constantMaxSeparate.y,Math.random()),x[2]=x[2]*M.lerp(D.constantMinSeparate.z,D.constantMaxSeparate.z,Math.random())):(l.seed=h[11],x[0]=x[0]*M.lerp(D.constantMinSeparate.x,D.constantMaxSeparate.x,l.getFloat()),x[1]=x[1]*M.lerp(D.constantMinSeparate.y,D.constantMaxSeparate.y,l.getFloat()),x[2]=x[2]*M.lerp(D.constantMinSeparate.z,D.constantMaxSeparate.z,l.getFloat()),h[11]=l.seed);else{var R=NaN;o?R=M.lerp(D.constantMin,D.constantMax,Math.random()):(l.seed=h[11],R=M.lerp(D.constantMin,D.constantMax,l.getFloat()),h[11]=l.seed),x[0]=x[0]*R,x[1]=x[1]*R,x[2]=x[2]*R}}var C,V,A,I;switch(t.startRotationType){case 0:if(t.threeDStartRotation&&1!==n.renderMode&&1!==n.renderMode){var b=t.startRotationConstantSeparate;Ke.createRotationYawPitchRoll(b.y,b.x,b.z,e._tempRotationMatrix),I=e._tempRotationMatrix.elements,u.startRotation0=e._tempStartRotation0,C=u.startRotation0,C[0]=I[0],C[1]=I[1],C[2]=I[2],u.startRotation1=e._tempStartRotation1,V=u.startRotation1,V[0]=I[4],V[1]=I[5],V[2]=I[6],u.startRotation2=e._tempStartRotation2,A=u.startRotation2,A[0]=I[8],A[1]=I[9],A[2]=I[10]}else u.startRotation0=e._tempStartRotation0,C=u.startRotation0,C[0]=C[1]=C[2]=t.startRotationConstant;break;case 2:if(t.threeDStartRotation&&1!==n.renderMode&&2!==n.renderMode){u.startRotation0=e._tempStartRotation0,C=u.startRotation0;var w=t.startRotationConstantMinSeparate,O=t.startRotationConstantMaxSeparate;o?Ke.createRotationYawPitchRoll(M.lerp(w.y,O.y,Math.random()),M.lerp(w.x,O.x,Math.random()),M.lerp(w.z,O.z,Math.random()),e._tempRotationMatrix):(l.seed=h[5],Ke.createRotationYawPitchRoll(M.lerp(w.y,O.y,l.getFloat()),M.lerp(w.x,O.x,l.getFloat()),M.lerp(w.z,O.z,l.getFloat()),e._tempRotationMatrix),h[5]=l.seed),I=e._tempRotationMatrix.elements,u.startRotation0=e._tempStartRotation0,C=u.startRotation0,C[0]=I[0],C[1]=I[1],C[2]=I[2],u.startRotation1=e._tempStartRotation1,V=u.startRotation1,V[0]=I[4],V[1]=I[5],V[2]=I[6],u.startRotation2=e._tempStartRotation2,A=u.startRotation2,A[0]=I[8],A[1]=I[9],A[2]=I[10]}else u.startRotation0=e._tempStartRotation0,C=u.startRotation0,o?C[0]=C[1]=C[2]=M.lerp(t.startRotationConstantMin,t.startRotationConstantMax,Math.random()):(l.seed=h[5],C[0]=C[1]=C[2]=M.lerp(t.startRotationConstantMin,t.startRotationConstantMax,l.getFloat()),h[5]=l.seed)}var N=NaN;switch(o?N=Math.random():(l.seed=h[6],N=l.getFloat(),h[6]=l.seed),N<t.randomizeRotationDirection&&(C[0]=-C[0],C[1]=-C[1],C[2]=-C[2]),u.startRotation1=e._tempStartRotation1,u.startRotation2=e._tempStartRotation2,t.startLifetimeType){case 0:u.startLifeTime=t.startLifetimeConstant;break;case 1:u.startLifeTime=e._getStartLifetimeFromGradient(t.startLifeTimeGradient,t.emissionTime);break;case 2:o?u.startLifeTime=M.lerp(t.startLifetimeConstantMin,t.startLifetimeConstantMax,Math.random()):(l.seed=h[7],u.startLifeTime=M.lerp(t.startLifetimeConstantMin,t.startLifetimeConstantMax,l.getFloat()),h[7]=l.seed);break;case 3:var P=t.emissionTime;o?u.startLifeTime=M.lerp(e._getStartLifetimeFromGradient(t.startLifeTimeGradientMin,P),e._getStartLifetimeFromGradient(t.startLifeTimeGradientMax,P),Math.random()):(l.seed=h[7],u.startLifeTime=M.lerp(e._getStartLifetimeFromGradient(t.startLifeTimeGradientMin,P),e._getStartLifetimeFromGradient(t.startLifeTimeGradientMax,P),l.getFloat()),h[7]=l.seed)}switch(t.startSpeedType){case 0:u.startSpeed=t.startSpeedConstant;break;case 2:o?u.startSpeed=M.lerp(t.startSpeedConstantMin,t.startSpeedConstantMax,Math.random()):(l.seed=h[8],u.startSpeed=M.lerp(t.startSpeedConstantMin,t.startSpeedConstantMax,l.getFloat()),h[8]=l.seed)}u.startUVInfo=e._tempStartUVInfo;var L,B=t.textureSheetAnimation,F=B&&B.enbale;if(F){var U=B.tiles,z=U.x,H=U.y,G=1/z,k=1/H,j=0,Y=B.randomRow;switch(B.type){case 0:z*H;break;case 1:z,Y?o?j=Math.round(Math.random()*H):(l.seed=h[13],j=Math.round(l.getFloat()*H),h[13]=l.seed):j=0}var W=0,X=B.startFrame;switch(X.type){case 0:W=X.constant;break;case 1:o?W=Math.round(M.lerp(X.constantMin,X.constantMax,Math.random())):(l.seed=h[14],W=Math.round(M.lerp(X.constantMin,X.constantMax,l.getFloat())),h[14]=l.seed)}var q=B.frame;switch(q.type){case 0:W+=q.constant;break;case 2:o?W+=Math.round(M.lerp(q.constantMin,q.constantMax,Math.random())):(l.seed=h[15],W+=Math.round(M.lerp(q.constantMin,q.constantMax,l.getFloat())),h[15]=l.seed)}Y||(j=Math.floor(W/z));var Z=W%z;L=u.startUVInfo,L[0]=G,L[1]=k,L[2]=Z*G,L[3]=j*k}else L=u.startUVInfo,L[0]=1,L[1]=1,L[2]=0,L[3]=0;u.time=a,u.simulationWorldPostion=e._tempSimulationWorldPostion;var Q=u.simulationWorldPostion;if(0===t.simulationSpace){var K=s.position.elements;Q[0]=K[0],Q[1]=K[1],Q[2]=K[2]}else Q[0]=0,Q[1]=0,Q[2]=0;return u},i(e,["_tempRotationMatrix",function(){return this._tempRotationMatrix=new Ke},"_tempStartColor",function(){return this._tempStartColor=new Float32Array(4)},"_tempStartSize",function(){return this._tempStartSize=new Float32Array(3)},"_tempStartRotation0",function(){return this._tempStartRotation0=new Float32Array(3)},"_tempStartRotation1",function(){return this._tempStartRotation1=new Float32Array(3)},"_tempStartRotation2",function(){return this._tempStartRotation2=new Float32Array(3)},"_tempStartUVInfo",function(){return this._tempStartUVInfo=new Float32Array(4)},"_tempSimulationWorldPostion",function(){return this._tempSimulationWorldPostion=new Float32Array(3)}]),e}(),re=function(){function e(){this._tempInt0=0,this._tempInt1=0,this._tempUint0=0,this._tempUint1=0,this._tempUint2=0,this._tempUint3=0,this._tempUint4=0,this._tempUint5=0,this._tempUint6=0,this._tempUint7=0,this._tempNumver0=NaN,this._tempNumver1=NaN,this._tempNumver2=NaN,this._tempNumver3=NaN,this._floatSizePerVer=7,this._defaultBufferSize=600*this._floatSizePerVer,this._vb=null,this._posInVBData=0,this._ib=null,this._posInIBData=0,this._primitiveType=NaN,this._hasBegun=!1,this._numVertsPerPrimitive=0,this._renderState=null,this._sharderNameID=0,this._shader=null,this._shaderCompile=null,this._vbData=new Float32Array(this._defaultBufferSize),this._ibData=new Uint16Array(this._defaultBufferSize),this._spriteShaderValue=new ht,this._vb=Zt.create(e._vertexDeclaration,this._defaultBufferSize/this._floatSizePerVer,35048),this._ib=qt.create("ushort",this._defaultBufferSize,35048),this._sharderNameID=kt.nameKey.getID("LINE"),this._shaderCompile=lt._preCompileShader[2e-4*this._sharderNameID]}r(e,"laya.d3.core.PhasorSpriter3D");var t=e.prototype;return t.line=function(e,t,n,i,r,a,s,o,l,h,u,c,_,d){return this._hasBegun&&1===this._primitiveType||this.drawLinesException(),(this._posInVBData+2*this._floatSizePerVer>this._vbData.length||this._posInIBData+2>this._ibData.length)&&this.flush(),this._tempUint0=this._posInVBData/this._floatSizePerVer,this.addVertex(e,t,n,i,r,a,s),this.addVertex(o,l,h,u,c,_,d),this.addIndexes(this._tempUint0,this._tempUint0+1),this},t.circle=function(e,t,n,i,r,a){for(this._hasBegun&&1===this._primitiveType||this.drawLinesException(),this._tempUint0=2*t,(this._posInVBData+this._tempUint0*this._floatSizePerVer>this._vbData.length||this._posInIBData+2*this._tempUint0>this._ibData.length)&&this.flush(),this._tempUint1=this._posInVBData/this._floatSizePerVer,this._tempNumver0=0,this._tempInt0=0;this._tempNumver0<6.2832;this._tempNumver0=this._tempNumver0+3.1416/t,this._tempInt0++)this.addVertex(Math.sin(this._tempNumver0)*e,Math.cos(this._tempNumver0)*e,0,n,i,r,a),0===this._tempInt0?this.addIndexes(this._tempUint1):this._tempInt0===this._tempUint0-1?(this._tempUint2=this._tempUint1+this._tempInt0,this.addIndexes(this._tempUint2,this._tempUint2,this._tempUint1)):(this._tempUint2=this._tempUint1+this._tempInt0,this.addIndexes(this._tempUint2,this._tempUint2));return this},t.plane=function(e,t,n,i,r,a,s,o,l){return this._hasBegun&&4===this._primitiveType||this.drawTrianglesException(),(this._posInVBData+4*this._floatSizePerVer>this._vbData.length||this._posInIBData+6>this._ibData.length)&&this.flush(),this._tempNumver0=i/2,this._tempNumver1=r/2,this._tempUint0=this._posInVBData/this._floatSizePerVer,this.addVertex(e-this._tempNumver0,t+this._tempNumver1,n,a,s,o,l),this.addVertex(e+this._tempNumver0,t+this._tempNumver1,n,a,s,o,l),this.addVertex(e-this._tempNumver0,t-this._tempNumver1,n,a,s,o,l),this.addVertex(e+this._tempNumver0,t-this._tempNumver1,n,a,s,o,l),this._tempUint1=this._tempUint0+1,this._tempUint2=this._tempUint0+2,this.addIndexes(this._tempUint0,this._tempUint1,this._tempUint2,this._tempUint2,this._tempUint1,this._tempUint0+3),this},t.box=function(e,t,n,i,r,a,s,o,l,h){return this._hasBegun&&4===this._primitiveType||this.drawTrianglesException(),(this._posInVBData+8*this._floatSizePerVer>this._vbData.length||this._posInIBData+36>this._ibData.length)&&this.flush(),this._tempNumver0=i/2,this._tempNumver1=r/2,this._tempNumver2=a/2,this._tempUint0=this._posInVBData/this._floatSizePerVer,this.addVertex(e-this._tempNumver0,t+this._tempNumver1,n+this._tempNumver2,s,o,l,h),this.addVertex(e+this._tempNumver0,t+this._tempNumver1,n+this._tempNumver2,s,o,l,h),this.addVertex(e-this._tempNumver0,t-this._tempNumver1,n+this._tempNumver2,s,o,l,h),this.addVertex(e+this._tempNumver0,t-this._tempNumver1,n+this._tempNumver2,s,o,l,h),this.addVertex(e+this._tempNumver0,t+this._tempNumver1,n-this._tempNumver2,s,o,l,h),this.addVertex(e-this._tempNumver0,t+this._tempNumver1,n-this._tempNumver2,s,o,l,h),this.addVertex(e+this._tempNumver0,t-this._tempNumver1,n-this._tempNumver2,s,o,l,h),this.addVertex(e-this._tempNumver0,t-this._tempNumver1,n-this._tempNumver2,s,o,l,h),this._tempUint1=this._tempUint0+1,this._tempUint2=this._tempUint0+2,this._tempUint3=this._tempUint0+3,this._tempUint4=this._tempUint0+4,this._tempUint5=this._tempUint0+5,this._tempUint6=this._tempUint0+6,this._tempUint7=this._tempUint0+7,this.addIndexes(this._tempUint0,this._tempUint1,this._tempUint2,this._tempUint2,this._tempUint1,this._tempUint3,this._tempUint4,this._tempUint5,this._tempUint6,this._tempUint6,this._tempUint5,this._tempUint7,this._tempUint5,this._tempUint0,this._tempUint7,this._tempUint7,this._tempUint0,this._tempUint2,this._tempUint1,this._tempUint4,this._tempUint3,this._tempUint3,this._tempUint4,this._tempUint6,this._tempUint5,this._tempUint4,this._tempUint0,this._tempUint0,this._tempUint4,this._tempUint1,this._tempUint2,this._tempUint3,this._tempUint7,this._tempUint7,this._tempUint3,this._tempUint6),this},t.cone=function(e,t,n,i,r,a,s){for(this._hasBegun&&4===this._primitiveType||this.drawTrianglesException(),(this._posInVBData+(2*n+2)*this._floatSizePerVer>this._vbData.length||this._posInIBData+6*n>this._ibData.length)&&this.flush(),this._tempUint0=this._posInVBData,this._tempUint1=this._posInVBData/this._floatSizePerVer,this._tempNumver0=2*Math.PI/n,this.addVertexIndex(0,t,0,i,r,a,s,this._tempUint0),this.addVertexIndex(0,0,0,i,r,a,s,this._tempUint0+this._floatSizePerVer),this._tempInt0=2,this._tempNumver1=0,this._tempInt1=0;this._tempInt1<n;this._tempInt1++)this._tempNumver2=Math.cos(this._tempNumver1),this._tempNumver3=Math.sin(this._tempNumver1),this.addVertexIndex(e*this._tempNumver2,0,e*this._tempNumver3,i,r,a,s,this._tempUint0+this._tempInt0*this._floatSizePerVer),this.addIndexes(this._tempUint1,this._tempUint1+this._tempInt0),this._tempInt1==n-1?this.addIndexes(this._tempUint1+2):this.addIndexes(this._tempUint1+this._tempInt0+1),this.addVertexIndex(e*this._tempNumver2,0,e*this._tempNumver3,i,r,a,s,this._tempUint0+(this._tempInt0+n)*this._floatSizePerVer),this.addIndexes(this._tempUint1+1),this._tempInt1==n-1?this.addIndexes(this._tempUint1+n+2):this.addIndexes(this._tempUint1+this._tempInt0+n+1),this.addIndexes(this._tempUint1+this._tempInt0+n),this._tempInt0++,this._tempNumver1+=this._tempNumver0;return this},t.boundingBoxLine=function(e,t,n,i,r,a,s,o,l,h){return this._hasBegun&&1===this._primitiveType||this.drawLinesException(),(this._posInVBData+8*this._floatSizePerVer>this._vbData.length||this._posInIBData+48>this._ibData.length)&&this.flush(),this._tempUint0=this._posInVBData/this._floatSizePerVer,this.addVertex(e,r,a,s,o,l,h),this.addVertex(i,r,a,s,o,l,h),this.addVertex(e,t,a,s,o,l,h),this.addVertex(i,t,a,s,o,l,h),this.addVertex(i,r,n,s,o,l,h),this.addVertex(e,r,n,s,o,l,h),this.addVertex(i,t,n,s,o,l,h),this.addVertex(e,t,n,s,o,l,h),this._tempUint1=this._tempUint0+1,this._tempUint2=this._tempUint0+2,this._tempUint3=this._tempUint0+3,this._tempUint4=this._tempUint0+4,this._tempUint5=this._tempUint0+5,this._tempUint6=this._tempUint0+6,this._tempUint7=this._tempUint0+7,this.addIndexes(this._tempUint0,this._tempUint1,this._tempUint1,this._tempUint3,this._tempUint3,this._tempUint2,this._tempUint2,this._tempUint0,this._tempUint4,this._tempUint5,this._tempUint5,this._tempUint7,this._tempUint7,this._tempUint6,this._tempUint6,this._tempUint4,this._tempUint5,this._tempUint0,this._tempUint0,this._tempUint2,this._tempUint2,this._tempUint7,this._tempUint7,this._tempUint5,this._tempUint1,this._tempUint4,this._tempUint4,this._tempUint6,this._tempUint6,this._tempUint3,this._tempUint3,this._tempUint1,this._tempUint5,this._tempUint4,this._tempUint4,this._tempUint1,this._tempUint1,this._tempUint0,this._tempUint0,this._tempUint5,this._tempUint2,this._tempUint3,this._tempUint3,this._tempUint6,this._tempUint6,this._tempUint7,this._tempUint7,this._tempUint2),this},t.addVertex=function(e,t,n,i,r,a,s){return this._hasBegun||this.addVertexIndexException(),this._vbData[this._posInVBData]=e,this._vbData[this._posInVBData+1]=t,this._vbData[this._posInVBData+2]=n,this._vbData[this._posInVBData+3]=i,this._vbData[this._posInVBData+4]=r,this._vbData[this._posInVBData+5]=a,this._vbData[this._posInVBData+6]=s,this._posInVBData+=this._floatSizePerVer,this},t.addVertexIndex=function(e,t,n,i,r,a,s,o){return this._hasBegun||this.addVertexIndexException(),this._vbData[o]=e,this._vbData[o+1]=t,this._vbData[o+2]=n,this._vbData[o+3]=i,this._vbData[o+4]=r,this._vbData[o+5]=a,this._vbData[o+6]=s,o+=this._floatSizePerVer,o>this._posInVBData&&(this._posInVBData=o),this},t.addIndexes=function(e){var t=arguments;this._hasBegun||this.addVertexIndexException();for(var n=0;n<t.length;n++)this._ibData[this._posInIBData]=t[n],this._posInIBData++;return this},t.begin=function(e,t){return this._hasBegun&&this.beginException0(),1!==e&&4!==e&&this.beginException1(),this._primitiveType=e,this._renderState=t,this._hasBegun=!0,this},t.end=function(){return this._hasBegun||this.endException(),this.flush(),this._hasBegun=!1,this},t.flush=function(){0!==this._posInVBData&&(this._ib.setData(this._ibData),this._vb.setData(this._vbData),this._vb._bind(),this._ib._bind(),this._shader=this._getShader(this._renderState),this._shader.bind(),this._shader.uploadAttributes(e._vertexDeclaration.shaderValues.data,null),this._spriteShaderValue.setValue(1,this._renderState.projectionViewMatrix.elements),this._shader.uploadSpriteUniforms(this._spriteShaderValue.data),I.drawCall++,N.mainContext.drawElements(this._primitiveType,this._posInIBData,5123,0),this._posInIBData=0,this._posInVBData=0)},t._getShader=function(e){var t=e.scene._shaderDefineValue;return this._shaderCompile.withCompile(this._sharderNameID,t,2e-4*this._sharderNameID+t)},t.addVertexIndexException=function(){throw new Error("请先调用begin()函数")},t.beginException0=function(){throw new Error("调用begin()前请确保已成功调用end()！")},t.beginException1=function(){throw new Error("只支持“LINES”和“TRIANGLES”两种基元！")},t.endException=function(){throw new Error("调用end()前请确保已成功调用begin()！")},t.drawLinesException=function(){throw new Error("您必须确保在此之前已调用begin()且使用“LINES”基元！")},t.drawTrianglesException=function(){throw new Error("您必须确保在此之前已调用begin()且使用“TRIANGLES”基元！")},i(e,["_vertexDeclaration",function(){return this._vertexDeclaration=new pe(28,[new ve(0,"vector3",0),new ve(12,"vector4",1)])}]),e}(),ae=function(){function e(){this._type=0,this._mainSortID=0,this._renderObject=null,this._sprite3D=null,this._material=null,this._renderObj=null,this._staticBatch=null,this._batchIndexStart=0,this._batchIndexEnd=0,this._canDynamicBatch=!1,this._shaderValue=null,this._conchSubmesh=null,this._canDynamicBatch=!0,this._shaderValue=new ht,D.isConchNode&&(this._conchSubmesh=new ConchSubmesh)}r(e,"laya.d3.core.render.RenderElement");var t=e.prototype;return t.getStaticBatchBakedVertexs=function(t){var n=this._renderObj._getVertexBuffer(t),i=n.getData().slice(),r=n.vertexDeclaration,a=r.getVertexElementByUsage(0).offset/4,s=r.getVertexElementByUsage(3).offset/4,o=r.getVertexElementByUsage(15).offset/4,l=this._staticBatch._rootSprite.transform.worldMatrix,h=this._sprite3D.transform.worldMatrix,u=e._tempMatrix4x40,c=e._tempMatrix4x41;l.invert(u),Ke.multiply(u,h,c);var _=e._tempQuaternion0;c.decomposeTransRotScale(e._tempVector30,_,e._tempVector31);for(var d=r.vertexStride/4,m=this._renderObject._owner,f=0,p=i.length;f<p;f+=d){var v=f+a,g=f+s,x=f+o;dt.transformVector3ArrayToVector3ArrayCoordinate(i,v,c,i,v),dt.transformVector3ArrayByQuat(i,g,_,i,g),m instanceof laya.d3.core.MeshSprite3D&&m.meshRender.lightmapScaleOffset&&dt.transformLightingMapTexcoordArray(i,x,m.meshRender.lightmapScaleOffset,i,x)}return i},t.getDynamicBatchBakedVertexs=function(e){for(var t=this._renderObj._getVertexBuffer(e),n=t.getData().slice(),i=t.vertexDeclaration,r=i.getVertexElementByUsage(0).offset/4,a=i.getVertexElementByUsage(3).offset/4,s=this._sprite3D.transform,o=s.worldMatrix,l=s.rotation,h=i.vertexStride/4,u=0,c=n.length;u<c;u+=h){var _=u+r;dt.transformVector3ArrayToVector3ArrayCoordinate(n,_,o,n,_),dt.transformVector3ArrayByQuat(n,a,l,n,a)}return n},t.getBakedIndices=function(){return this._renderObj._getIndexBuffer().getData()},a(0,t,"renderObj",function(){return this._renderObj},function(e){this._renderObj!==e&&(this._renderObj=e)}),i(e,["_tempVector30",function(){return this._tempVector30=new rt},"_tempVector31",function(){return this._tempVector31=new rt},"_tempQuaternion0",function(){return this._tempQuaternion0=new et},"_tempMatrix4x40",function(){return this._tempMatrix4x40=new Ke},"_tempMatrix4x41",function(){return this._tempMatrix4x41=new Ke}]),e}(),se=function(){function e(t){this._id=0,this._needSort=!1,this._renderElements=null,this._staticBatches=null,this._renderableRenderObjects=null,this._staticBatchCombineRenderElements=null,this._dynamicBatchCombineRenderElements=null,this._finalElements=null,this._scene=null,this._id=++e._uniqueIDCounter,this._needSort=!1,this._scene=t,this._renderElements=[],this._renderableRenderObjects=[],this._staticBatchCombineRenderElements=[],this._dynamicBatchCombineRenderElements=[],this._staticBatches=[]}r(e,"laya.d3.core.render.RenderQueue");var t=e.prototype;return t._sortOpaqueFunc=function(e,t){return e._renderObject&&t._renderObject?e._renderObject._distanceForSort-t._renderObject._distanceForSort:0},t._sortAlphaFunc=function(e,t){return e._renderObject&&t._renderObject?t._renderObject._distanceForSort-e._renderObject._distanceForSort:0},t._begainRenderElement=function(e,t,n){return!!t._beforeRender(e)},t._preRenderUpdateComponents=function(e,t){for(var n=0;n<e.componentsCount;n++){var i=e.getComponentByIndex(n);!i.started&&(i._start(t),i.started=!0),i.isActive&&i._preRenderUpdate(t)}},t._postRenderUpdateComponents=function(e,t){for(var n=0;n<e.componentsCount;n++){var i=e.getComponentByIndex(n);!i.started&&(i._start(t),i.started=!0),i.isActive&&i._postRenderUpdate(t)}},t._sortAlpha=function(t){e._cameraPosition=t,this._finalElements.sort(this._sortAlphaFunc)},t._sortOpaque=function(t){e._cameraPosition=t,this._finalElements.sort(this._sortOpaqueFunc)},t._preRender=function(e){this._staticBatchCombineRenderElements.length=0;for(var t=0,n=this._staticBatches.length;t<n;t++)this._staticBatches[t]._getRenderElement(this._staticBatchCombineRenderElements);this._finalElements=this._renderElements.concat(this._staticBatchCombineRenderElements,this._dynamicBatchCombineRenderElements)},t._render=function(e,t){for(var n,i,r,a,s,o=I.loopCount,l=this._scene,h=e.camera,u=(h.id,!1),c=0,_=this._finalElements.length;c<_;c++){var d,m,f,p=this._finalElements[c];if(0===p._type)e.owner=f=p._sprite3D,e.renderElement=p,this._preRenderUpdateComponents(f,e),d=p.renderObj,m=p._material,this._begainRenderElement(e,d,m)&&(n=d._getVertexBuffer(0),i=n.vertexDeclaration,r=m._getShader(l._shaderDefineValue,i.shaderDefineValue,f._shaderDefineValue),u=r.bind()||o!==r._uploadLoopCount,(r._uploadVertexBuffer!==n||u)&&(r.uploadAttributes(i.shaderValues.data,null),r._uploadVertexBuffer=n),(r._uploadScene!==l||u)&&(r.uploadSceneUniforms(l._shaderValues.data),r._uploadScene=l),(h!==r._uploadCamera||r._uploadSprite3D!==f||u)&&(r.uploadSpriteUniforms(f._shaderValues.data),r._uploadSprite3D=f),(h!==r._uploadCamera||u)&&(r.uploadCameraUniforms(h._shaderValues.data),r._uploadCamera=h),(r._uploadMaterial!==m||u)&&(m._setMaterialShaderParams(e),m._upload(),r._uploadMaterial=m),(r._uploadRenderElement!==p||u)&&(r.uploadRenderElementUniforms(p._shaderValue.data),r._uploadRenderElement=p),a!==m?(m._setRenderStateBlendDepth(),m._setRenderStateFrontFace(t,f.transform),a=m,s=f):s!==f&&(m._setRenderStateFrontFace(t,f.transform),s=f),d._render(e),r._uploadLoopCount=o),this._postRenderUpdateComponents(f,e);else if(1===p._type){var v=p.renderObj;e.owner=f=v._rootSprite,e.renderElement=p,e._batchIndexStart=p._batchIndexStart,e._batchIndexEnd=p._batchIndexEnd,d=p.renderObj,m=p._material,this._begainRenderElement(e,d,m)&&(n=d._getVertexBuffer(0),i=n.vertexDeclaration,r=m._getShader(l._shaderDefineValue,i.shaderDefineValue,f._shaderDefineValue),u=r.bind()||o!==r._uploadLoopCount,(r._uploadVertexBuffer!==n||u)&&(r.uploadAttributes(i.shaderValues.data,null),r._uploadVertexBuffer=n),(r._uploadScene!==l||u)&&(r.uploadSceneUniforms(l._shaderValues.data),r._uploadScene=l),(h!==r._uploadCamera||r._uploadSprite3D!==f||u)&&(r.uploadSpriteUniforms(f._shaderValues.data),r._uploadSprite3D=f),(h!==r._uploadCamera||u)&&(r.uploadCameraUniforms(h._shaderValues.data),r._uploadCamera=h),(r._uploadMaterial!==m||u)&&(m._setMaterialShaderParams(e),m._upload(),r._uploadMaterial=m),(r._uploadRenderElement!==p||u)&&(r.uploadRenderElementUniforms(p._shaderValue.data),r._uploadRenderElement=p),a!==m?(m._setRenderStateBlendDepth(),m._setRenderStateFrontFace(t,f.transform),a=m,s=f):s!==f&&(m._setRenderStateFrontFace(t,f.transform),s=f),d._render(e),r._uploadLoopCount=o)}else if(2===p._type){p.renderObj;e.owner=f=p._sprite3D,e.renderElement=p,e._batchIndexStart=p._batchIndexStart,e._batchIndexEnd=p._batchIndexEnd,d=p.renderObj,m=p._material,this._begainRenderElement(e,d,m)&&(n=d._getVertexBuffer(0),i=n.vertexDeclaration,r=m._getShader(l._shaderDefineValue,i.shaderDefineValue,f._shaderDefineValue),u=r.bind()||o!==r._uploadLoopCount,(r._uploadVertexBuffer!==n||u)&&(r.uploadAttributes(i.shaderValues.data,null),r._uploadVertexBuffer=n),(r._uploadScene!==l||u)&&(r.uploadSceneUniforms(l._shaderValues.data),r._uploadScene=l),(h!==r._uploadCamera||r._uploadSprite3D!==f||u)&&(r.uploadSpriteUniforms(f._shaderValues.data),r._uploadSprite3D=f),(h!==r._uploadCamera||u)&&(r.uploadCameraUniforms(h._shaderValues.data),r._uploadCamera=h),(r._uploadMaterial!==m||u)&&(m._setMaterialShaderParams(e),m._upload(),r._uploadMaterial=m),(r._uploadRenderElement!==p||u)&&(r.uploadRenderElementUniforms(p._shaderValue.data),r._uploadRenderElement=p),a!==m?(m._setRenderStateBlendDepth(),m._setRenderStateFrontFace(t,f.transform),a=m,s=f):s!==f&&(m._setRenderStateFrontFace(t,f.transform),s=f),d._render(e),r._uploadLoopCount=o)}}},t._clearRenderElements=function(){this._staticBatches.length=0,this._dynamicBatchCombineRenderElements.length=0,this._renderElements.length=0,this._needSort=!0},t._addRenderElement=function(e){this._renderElements.push(e),this._needSort=!0},t._addStaticBatch=function(e){this._staticBatches.push(e)},t._addDynamicBatchElement=function(e){this._dynamicBatchCombineRenderElements.push(e)},a(0,t,"id",function(){return this._id}),e._uniqueIDCounter=0,e.OPAQUE=1,e.TRANSPARENT=2,e._cameraPosition=null,e}(),oe=function(){function e(){this._staticBatch=null,this._batchIndexStart=0,this._batchIndexEnd=0,this.elapsedTime=NaN,this.loopCount=0,this.context=null,this.scene=null,this.owner=null,this.renderElement=null,this.camera=null,this.viewMatrix=null,this.projectionMatrix=null,this.projectionViewMatrix=null,this.cameraBoundingFrustum=null,this.viewport=null}return r(e,"laya.d3.core.render.RenderState"),e.clientWidth=0,e.clientHeight=0,e}(),le=function(){function e(e,t){this._exactBox=null,this._relaxBox=null,this._scene=null,this._parent=null,this._currentDepth=0,this._boundingSphere=new Xe(new rt,0),this._corners=[],this._boundingBoxCenter=new rt,this._children=s(8),this._objects=[],this._tempBoundBoxCorners=[],this._scene=e,this._currentDepth=t}r(e,"laya.d3.core.scene.OctreeNode");var t=e.prototype;return n.imps(t,{"laya.d3.core.scene.ITreeNode":!0}),t.init=function(e,t){var n=new rt,i=new rt;rt.scale(t,-.5,n),rt.scale(t,.5,i),rt.add(n,e,n),rt.add(i,e,i),this.exactBox=new Ye(n,i),this.relaxBox=new Ye(n,i)},t.addTreeNode=function(e){1===qe.boxContainsBox(this._exactBox,e._render.boundingBox)?this.addNodeDown(e,0):this.addObject(e)},t.addChild=function(t){var n=this._children[t];if(null==n){n=new e(this._scene,this._currentDepth+1),this._children[t]=n,n._parent=this,rt.subtract(this._exactBox.max,this._exactBox.min,e.tempSize),rt.multiply(e.tempSize,e._octreeSplit[t],e.tempCenter),rt.add(this._exactBox.min,e.tempCenter,e.tempCenter),rt.scale(e.tempSize,.25,e.tempSize);var i=new rt,r=new rt;rt.subtract(e.tempCenter,e.tempSize,i),rt.add(e.tempCenter,e.tempSize,r),n.exactBox=new Ye(i,r),rt.scale(e.tempSize,e.relax,e.tempSize);var a=new rt,s=new rt;rt.subtract(e.tempCenter,e.tempSize,a),rt.add(e.tempCenter,e.tempSize,s),n.relaxBox=new Ye(a,s)}return n},t.addObject=function(e){e._treeNode=this,this._objects.push(e)},t.removeObject=function(e){if(e._treeNode!=this)return console.log("OctreeNode::removeObject error"),!1;var t=this._objects.indexOf(e);return t!==-1&&(this._objects.splice(t,1),!0)},t.clearObject=function(){this._objects.length=0},t.addNodeUp=function(e,t){this._parent&&1!==qe.boxContainsBox(this._exactBox,e._render.boundingBox)?this._parent.addNodeUp(e,t-1):this.addNodeDown(e,t)},t.addNodeDown=function(e,t){if(t<this._scene.treeLevel){var n=e._render,i=this.inChildIndex(n.boundingBoxCenter),r=this.addChild(i);1===qe.boxContainsBox(r._relaxBox,n.boundingBox)?r.addNodeDown(e,++t):this.addObject(e)}else this.addObject(e)},t.inChildIndex=function(e){return 4*(e.z<this._boundingBoxCenter.z?0:1)+2*(e.y<this._boundingBoxCenter.y?0:1)+(e.x<this._boundingBoxCenter.x?0:1)},t.updateObject=function(e){1===qe.boxContainsBox(this._relaxBox,e._render.boundingBox)?(this.removeObject(e),e._treeNode=null,this.addNodeDown(e,this._currentDepth)):this._parent&&(this.removeObject(e),e._treeNode=null,this._parent.addNodeUp(e,this._currentDepth-1))},t.cullingObjects=function(e,t,n,i,r){var a=0,s=0,o=0,l=0,h=this._scene._dynamicBatchManager;for(a=0,o=this._objects.length;a<o;a++){var u=this._objects[a];if(F.isVisible(u._layerMask)&&u._ownerEnable&&u._enable){var c=u._render;if(t&&(I.treeSpriteCollision+=1,0===e.containsBoundSphere(c.boundingSphere)))continue;u._owner._prepareShaderValuetoRender(r),u._distanceForSort=rt.distance(c.boundingSphere.center,i)+c.sortingFudge;var _=u._renderElements;for(s=0,l=_.length;s<l;s++){var d=_[s],m=d._staticBatch;if(m&&m._material===d._material)m._addRenderElement(d);else{var f=d.renderObj;f.triangleCount<50&&1===f._vertexBufferCount&&f._getIndexBuffer()&&d._material.renderQueue<2&&d._canDynamicBatch&&!u._owner.isStatic?h._addPrepareRenderElement(d):this._scene.getRenderQueue(d._material.renderQueue)._addRenderElement(d)}}}}for(a=0;a<8;a++){var p=this._children[a];if(null!=p){var v=t;if(t){var g=e.containsBoundBox(p._relaxBox)
;if(I.treeNodeCollision+=1,0===g)continue;v=2===g}p.cullingObjects(e,v,n,i,r)}}},t.renderBoudingBox=function(e){this._renderBoudingBox(e);for(var t=0;t<8;++t){var n=this._children[t];n&&n.renderBoudingBox(e)}},t.buildAllChild=function(e){if(e<this._scene.treeLevel)for(var t=0;t<8;t++){var n=this.addChild(t);n.buildAllChild(e+1)}},t._renderBoudingBox=function(e){var t=this._relaxBox,n=this._tempBoundBoxCorners;t.getCorners(n),e.line(n[0].x,n[0].y,n[0].z,1,0,0,1,n[1].x,n[1].y,n[1].z,1,0,0,1),e.line(n[2].x,n[2].y,n[2].z,1,0,0,1,n[3].x,n[3].y,n[3].z,1,0,0,1),e.line(n[4].x,n[4].y,n[4].z,1,0,0,1,n[5].x,n[5].y,n[5].z,1,0,0,1),e.line(n[6].x,n[6].y,n[6].z,1,0,0,1,n[7].x,n[7].y,n[7].z,1,0,0,1),e.line(n[0].x,n[0].y,n[0].z,1,0,0,1,n[3].x,n[3].y,n[3].z,1,0,0,1),e.line(n[1].x,n[1].y,n[1].z,1,0,0,1,n[2].x,n[2].y,n[2].z,1,0,0,1),e.line(n[2].x,n[2].y,n[2].z,1,0,0,1,n[6].x,n[6].y,n[6].z,1,0,0,1),e.line(n[3].x,n[3].y,n[3].z,1,0,0,1,n[7].x,n[7].y,n[7].z,1,0,0,1),e.line(n[0].x,n[0].y,n[0].z,1,0,0,1,n[4].x,n[4].y,n[4].z,1,0,0,1),e.line(n[1].x,n[1].y,n[1].z,1,0,0,1,n[5].x,n[5].y,n[5].z,1,0,0,1),e.line(n[4].x,n[4].y,n[4].z,1,0,0,1,n[7].x,n[7].y,n[7].z,1,0,0,1),e.line(n[5].x,n[5].y,n[5].z,1,0,0,1,n[6].x,n[6].y,n[6].z,1,0,0,1)},a(0,t,"exactBox",function(){return this._exactBox},function(e){this._exactBox=e,rt.add(e.min,e.max,this._boundingBoxCenter),rt.scale(this._boundingBoxCenter,.5,this._boundingBoxCenter)}),a(0,t,"relaxBox",function(){return this._relaxBox},function(e){this._relaxBox=e,e.getCorners(this._corners),Xe.createfromPoints(this._corners,this._boundingSphere)}),e.relax=1.15,e.CHILDNUM=8,i(e,["tempVector0",function(){return this.tempVector0=new rt},"tempSize",function(){return this.tempSize=new rt},"tempCenter",function(){return this.tempCenter=new rt},"_octreeSplit",function(){return this._octreeSplit=[new rt(.25,.25,.25),new rt(.75,.25,.25),new rt(.25,.75,.25),new rt(.75,.75,.25),new rt(.25,.25,.75),new rt(.75,.25,.75),new rt(.25,.75,.75),new rt(.75,.75,.75)]}]),e}(),he=function(){function e(e,t){this._exactBox=null,this._relaxBox=null,this._exactInfiniteBox=null,this._relaxInfiniteBox=null,this._scene=null,this._parent=null,this._currentDepth=0,this._boundingSphere=new Xe(new rt,0),this._corners=[],this._boundingBoxCenter=new rt,this._children=s(4),this._objects=[],this._tempBoundBoxCorners=[],this._scene=e,this._currentDepth=t}r(e,"laya.d3.core.scene.QuadtreeNode");var t=e.prototype;return n.imps(t,{"laya.d3.core.scene.ITreeNode":!0}),t.init=function(e,t){var n=new rt,i=new rt;rt.scale(t,-.5,n),rt.scale(t,.5,i),rt.add(n,e,n),rt.add(i,e,i),this.exactBox=new Ye(n,i),this.relaxBox=new Ye(n,i),this._exactInfiniteBox=new Ye(new rt,new rt),this._relaxInfiniteBox=new Ye(new rt,new rt),this._exactInfiniteBox.min.elements[0]=this._exactBox.min.elements[0],this._exactInfiniteBox.min.elements[1]=Number.NEGATIVE_INFINITY,this._exactInfiniteBox.min.elements[2]=this._exactBox.min.elements[2],this._exactInfiniteBox.max.elements[0]=this._exactBox.max.elements[0],this._exactInfiniteBox.max.elements[1]=Number.POSITIVE_INFINITY,this._exactInfiniteBox.max.elements[2]=this._exactBox.max.elements[2],this._relaxInfiniteBox.min.elements[0]=this._relaxBox.min.elements[0],this._relaxInfiniteBox.min.elements[1]=Number.NEGATIVE_INFINITY,this._relaxInfiniteBox.min.elements[2]=this._relaxBox.min.elements[2],this._relaxInfiniteBox.max.elements[0]=this._relaxBox.max.elements[0],this._relaxInfiniteBox.max.elements[1]=Number.POSITIVE_INFINITY,this._relaxInfiniteBox.max.elements[2]=this._relaxBox.max.elements[2]},t.addTreeNode=function(e){1===qe.boxContainsBox(this._exactInfiniteBox,e._render.boundingBox)?this.addNodeDown(e,0):this.addObject(e)},t.addChild=function(t){var n=this._children[t];if(null==n){n=new e(this._scene,this._currentDepth+1),this._children[t]=n,n._parent=this,rt.subtract(this._exactBox.max,this._exactBox.min,e.tempSize),rt.multiply(e.tempSize,e._quadTreeSplit[t],e.tempCenter),rt.add(this._exactBox.min,e.tempCenter,e.tempCenter),e.tempSize.elements[0]*=.25,e.tempSize.elements[1]*=.5,e.tempSize.elements[2]*=.25;var i=new rt,r=new rt;rt.subtract(e.tempCenter,e.tempSize,i),rt.add(e.tempCenter,e.tempSize,r),n.exactBox=new Ye(i,r),rt.scale(e.tempSize,e.relax,e.tempSize);var a=new rt,s=new rt;rt.subtract(e.tempCenter,e.tempSize,a),rt.add(e.tempCenter,e.tempSize,s),n.relaxBox=new Ye(a,s),n.exactInfiniteBox=new Ye(new rt,new rt),n.relaxInfiniteBox=new Ye(new rt,new rt),n.exactInfiniteBox.min.elements[0]=this._exactBox.min.elements[0],n.exactInfiniteBox.min.elements[1]=Number.NEGATIVE_INFINITY,n.exactInfiniteBox.min.elements[2]=this._exactBox.min.elements[2],n.exactInfiniteBox.max.elements[0]=this._exactBox.max.elements[0],n.exactInfiniteBox.max.elements[1]=Number.POSITIVE_INFINITY,n.exactInfiniteBox.max.elements[2]=this._exactBox.max.elements[2],n.relaxInfiniteBox.min.elements[0]=this._relaxBox.min.elements[0],n.relaxInfiniteBox.min.elements[1]=Number.NEGATIVE_INFINITY,n.relaxInfiniteBox.min.elements[2]=this._relaxBox.min.elements[2],n.relaxInfiniteBox.max.elements[0]=this._relaxBox.max.elements[0],n.relaxInfiniteBox.max.elements[1]=Number.POSITIVE_INFINITY,n.relaxInfiniteBox.max.elements[2]=this._relaxBox.max.elements[2]}return n},t.addObject=function(e){e._treeNode=this,this._objects.push(e)},t.removeObject=function(e){if(e._treeNode!=this)return console.log("QuadtreeNode::removeObject error"),!1;var t=this._objects.indexOf(e);return t!==-1&&(this._objects.splice(t,1),!0)},t.clearObject=function(){this._objects.length=0},t.addNodeUp=function(e,t){this._parent&&1!==qe.boxContainsBox(this._exactInfiniteBox,e._render.boundingBox)?this._parent.addNodeUp(e,t-1):this.addNodeDown(e,t)},t.addNodeDown=function(e,t){if(t<this._scene.treeLevel){var n=e._render,i=this.inChildIndex(n.boundingBoxCenter),r=this.addChild(i);1===qe.boxContainsBox(r.relaxInfiniteBox,n.boundingBox)?r.addNodeDown(e,++t):this.addObject(e)}else this.addObject(e)},t.inChildIndex=function(e){return 2*(e.z<this._boundingBoxCenter.z?0:1)+(e.x<this._boundingBoxCenter.x?0:1)},t.updateObject=function(e){1===qe.boxContainsBox(this._relaxInfiniteBox,e._render.boundingBox)?(this.removeObject(e),e._treeNode=null,this.addNodeDown(e,this._currentDepth)):this._parent&&(this.removeObject(e),e._treeNode=null,this._parent.addNodeUp(e,this._currentDepth-1))},t.cullingObjects=function(e,t,n,i,r){var a=0,s=0,o=0,l=0,h=this._scene._dynamicBatchManager;for(a=0,o=this._objects.length;a<o;a++){var u=this._objects[a];if(F.isVisible(u._layerMask)&&u._ownerEnable&&u._enable){var c=u._render;if(t&&(I.treeSpriteCollision+=1,0===e.containsBoundSphere(c.boundingSphere)))continue;u._owner._prepareShaderValuetoRender(r),u._distanceForSort=rt.distance(c.boundingSphere.center,i)+c.sortingFudge;var _=u._renderElements;for(s=0,l=_.length;s<l;s++){var d=_[s],m=d._staticBatch;if(m&&m._material===d._material)m._addRenderElement(d);else{var f=d.renderObj;f.triangleCount<50&&1===f._vertexBufferCount&&f._getIndexBuffer()&&d._material.renderQueue<2&&d._canDynamicBatch&&!u._owner.isStatic?h._addPrepareRenderElement(d):this._scene.getRenderQueue(d._material.renderQueue)._addRenderElement(d)}}}}for(a=0;a<4;a++){var p=this._children[a];if(null!=p){var v=t;if(t){var g=e.containsBoundBox(p._relaxBox);if(I.treeNodeCollision+=1,0===g)continue;v=2===g}p.cullingObjects(e,v,n,i,r)}}},t.renderBoudingBox=function(e){this._renderBoudingBox(e);for(var t=0;t<4;++t){var n=this._children[t];n&&n.renderBoudingBox(e)}},t.buildAllChild=function(e){if(e<this._scene.treeLevel)for(var t=0;t<4;t++){var n=this.addChild(t);n.buildAllChild(e+1)}},t._renderBoudingBox=function(e){var t=this._relaxBox,n=this._tempBoundBoxCorners;t.getCorners(n),e.line(n[0].x,n[0].y,n[0].z,1,0,0,1,n[1].x,n[1].y,n[1].z,1,0,0,1),e.line(n[2].x,n[2].y,n[2].z,1,0,0,1,n[3].x,n[3].y,n[3].z,1,0,0,1),e.line(n[4].x,n[4].y,n[4].z,1,0,0,1,n[5].x,n[5].y,n[5].z,1,0,0,1),e.line(n[6].x,n[6].y,n[6].z,1,0,0,1,n[7].x,n[7].y,n[7].z,1,0,0,1),e.line(n[0].x,n[0].y,n[0].z,1,0,0,1,n[3].x,n[3].y,n[3].z,1,0,0,1),e.line(n[1].x,n[1].y,n[1].z,1,0,0,1,n[2].x,n[2].y,n[2].z,1,0,0,1),e.line(n[2].x,n[2].y,n[2].z,1,0,0,1,n[6].x,n[6].y,n[6].z,1,0,0,1),e.line(n[3].x,n[3].y,n[3].z,1,0,0,1,n[7].x,n[7].y,n[7].z,1,0,0,1),e.line(n[0].x,n[0].y,n[0].z,1,0,0,1,n[4].x,n[4].y,n[4].z,1,0,0,1),e.line(n[1].x,n[1].y,n[1].z,1,0,0,1,n[5].x,n[5].y,n[5].z,1,0,0,1),e.line(n[4].x,n[4].y,n[4].z,1,0,0,1,n[7].x,n[7].y,n[7].z,1,0,0,1),e.line(n[5].x,n[5].y,n[5].z,1,0,0,1,n[6].x,n[6].y,n[6].z,1,0,0,1)},a(0,t,"exactInfiniteBox",function(){return this._exactInfiniteBox},function(e){this._exactInfiniteBox=e}),a(0,t,"exactBox",function(){return this._exactBox},function(e){this._exactBox=e,rt.add(e.min,e.max,this._boundingBoxCenter),rt.scale(this._boundingBoxCenter,.5,this._boundingBoxCenter)}),a(0,t,"relaxInfiniteBox",function(){return this._relaxInfiniteBox},function(e){this._relaxInfiniteBox=e}),a(0,t,"relaxBox",function(){return this._relaxBox},function(e){this._relaxBox=e,e.getCorners(this._corners),Xe.createfromPoints(this._corners,this._boundingSphere)}),e.relax=1.15,e.CHILDNUM=4,i(e,["tempVector0",function(){return this.tempVector0=new rt},"tempSize",function(){return this.tempSize=new rt},"tempCenter",function(){return this.tempCenter=new rt},"_quadTreeSplit",function(){return this._quadTreeSplit=[new rt(.25,.5,.25),new rt(.75,.5,.25),new rt(.25,.5,.75),new rt(.75,.5,.75)]}]),e}(),ue=function(){function e(e){this._vertexDeclaration=null,this._vertexDatas=null,this._indexDatas=null,this._vertexBuffer=null,this._indexBuffer=null,this._currentCombineVertexCount=0,this._currentCombineIndexCount=0,this._combineRenderElements=null,this._materials=null,this._materialToRenderElementsOffsets=null,this._merageElements=null,this._combineRenderElementPool=null,this._combineRenderElementPoolIndex=0,this._currentCombineVertexCount=0,this._currentCombineIndexCount=0,this._combineRenderElements=[],this._materialToRenderElementsOffsets=[],this._materials=[],this._merageElements=[],this._combineRenderElementPool=[],this._combineRenderElementPoolIndex=0,this._vertexDeclaration=e}r(e,"laya.d3.graphics.DynamicBatch");var t=e.prototype;return n.imps(t,{"laya.d3.core.render.IRenderable":!0}),t._getVertexBuffer=function(e){return void 0===e&&(e=0),0===e?this._vertexBuffer:null},t._getIndexBuffer=function(){return this._indexBuffer},t._getCombineRenderElementFromPool=function(e,t,n){var i=this._combineRenderElementPool[this._combineRenderElementPoolIndex++];return i||(this._combineRenderElementPool[this._combineRenderElementPoolIndex-1]=i=new ae,i._sprite3D=new yt),i._sprite3D._prepareShaderValuetoRender(n),i},t._getRenderElement=function(t,n,i){this._vertexDatas||(this._vertexDatas=new Float32Array(this._vertexDeclaration.vertexStride/4*e.maxVertexCount),this._indexDatas=new Uint16Array(e.maxIndexCount),this._vertexBuffer=Zt.create(this._vertexDeclaration,e.maxVertexCount,35048),this._indexBuffer=qt.create("ushort",e.maxIndexCount,35048)),this._merageElements.length=0;for(var r=0,a=0,s=0,o=this._combineRenderElements.length;s<o;s++){var l=this._combineRenderElements[s],h=l.getDynamicBatchBakedVertexs(0),u=l.getBakedIndices(),c=l._sprite3D.transform._isFrontFaceInvert,_=r/(this._vertexDeclaration.vertexStride/4),d=a,m=d+u.length;l._batchIndexStart=d,l._batchIndexEnd=m,this._indexDatas.set(u,a);var f=0;if(c)for(f=d;f<m;f+=3){this._indexDatas[f]=_+this._indexDatas[f];var p=this._indexDatas[f+1],v=this._indexDatas[f+2];this._indexDatas[f+1]=_+v,this._indexDatas[f+2]=_+p}else for(f=d;f<m;f+=3)this._indexDatas[f]=_+this._indexDatas[f],this._indexDatas[f+1]=_+this._indexDatas[f+1],this._indexDatas[f+2]=_+this._indexDatas[f+2];a+=u.length,this._vertexDatas.set(h,r),r+=h.length}for(this._vertexBuffer.setData(this._vertexDatas),this._indexBuffer.setData(this._indexDatas),this._combineRenderElementPoolIndex=0,s=0,o=this._materials.length;s<o;s++){var g=this._getCombineRenderElementFromPool(t,n,i);g._type=2,g._staticBatch=null,g.renderObj=this;var x=this._combineRenderElements[this._materialToRenderElementsOffsets[s]]._batchIndexStart,E=s+1===this._materialToRenderElementsOffsets.length?a:this._combineRenderElements[this._materialToRenderElementsOffsets[s+1]]._batchIndexStart;g._batchIndexStart=x,g._batchIndexEnd=E,g._material=this._materials[s],this._merageElements.push(g)}},t._addCombineRenderObjTest=function(t){var n=t.renderObj,i=this._currentCombineIndexCount+n._getIndexBuffer().indexCount;return!(this._currentCombineVertexCount+n._getVertexBuffer().vertexCount>e.maxVertexCount||i>e.maxIndexCount)},t._addCombineRenderObj=function(e){var t=e.renderObj;this._combineRenderElements.push(e),this._currentCombineIndexCount=this._currentCombineIndexCount+t._getIndexBuffer().indexCount,this._currentCombineVertexCount=this._currentCombineVertexCount+t._getVertexBuffer().vertexCount},t._addCombineMaterial=function(e){this._materials.push(e)},t._addMaterialToRenderElementOffset=function(e){this._materialToRenderElementsOffsets.push(e)},t._clearRenderElements=function(){this._combineRenderElements.length=0,this._materials.length=0,this._materialToRenderElementsOffsets.length=0,this._currentCombineVertexCount=0,this._currentCombineIndexCount=0},t._addToRenderQueue=function(e,t,n,i){this._getRenderElement(t,n,i);for(var r=0,a=this._materials.length;r<a;r++)e.getRenderQueue(this._materials[r].renderQueue)._addDynamicBatchElement(this._merageElements[r])},t._beforeRender=function(e){return this._vertexBuffer._bind(),this._indexBuffer._bind(),!0},t._render=function(e){var t=e._batchIndexEnd-e._batchIndexStart;e.context.drawElements(4,t,5123,2*e._batchIndexStart),I.drawCall++,I.trianglesFaces+=t/3},t._renderRuntime=function(e,t,n){},a(0,t,"indexOfHost",function(){return 0}),a(0,t,"_vertexBufferCount",function(){return 1}),a(0,t,"triangleCount",function(){return this._indexBuffer.indexCount/3}),a(0,t,"combineRenderElementsCount",function(){return this._combineRenderElements.length}),e.maxVertexCount=2e4,e.maxIndexCount=4e4,e.maxCombineTriangleCount=50,e}(),ce=function(){function e(){this._dynamicBatches=null,this._prepareDynamicBatchCombineElements=null,this._dynamicBatches={},this._prepareDynamicBatchCombineElements=[]}r(e,"laya.d3.graphics.DynamicBatchManager");var t=e.prototype;return t.getDynamicBatch=function(e,t){var n,i=e.id.toString()+t;return this._dynamicBatches[i]?n=this._dynamicBatches[i]:this._dynamicBatches[i]=n=new ue(e),n},t._garbageCollection=function(){for(var e in this._dynamicBatches)0===this._dynamicBatches[e].combineRenderElementsCount&&delete this._dynamicBatches[e]},t._addPrepareRenderElement=function(e){this._prepareDynamicBatchCombineElements.push(e)},t._finishCombineDynamicBatch=function(t){this._prepareDynamicBatchCombineElements.sort(e._sortPrepareDynamicBatch);for(var n,i,r,a,s,o,l,h,u=-1,c=!0,_=0,d=-1,m=0,f=this._prepareDynamicBatchCombineElements.length;m<f;m++){s=this._prepareDynamicBatchCombineElements[m];var p=s.renderObj._getVertexBuffer(0).vertexDeclaration,v=i!==p;v&&(_=0,i=p);var g=_!==u;if(g&&(u=_),(v||g)&&(o=this.getDynamicBatch(p,_),n=null),c)if(o._addCombineRenderObjTest(s)){if(a=s._material,n!==a)l&&(t.getRenderQueue(h._material.renderQueue)._addRenderElement(h),l=null,h=null,d=-1),l=a,d=o.combineRenderElementsCount,h=s,n=a;else if(l){var x=h.renderObj,E=s.renderObj;x._getVertexBuffer().vertexCount+E._getVertexBuffer().vertexCount>ue.maxVertexCount||x._getIndexBuffer().indexCount+E._getIndexBuffer().indexCount>ue.maxIndexCount?(t.getRenderQueue(h._material.renderQueue)._addRenderElement(h),l=a,d=o.combineRenderElementsCount,h=s):(o._addCombineMaterial(l),o._addMaterialToRenderElementOffset(d),o._addCombineRenderObj(h),l=null,h=null,d=-1,o._addCombineRenderObj(s))}else o._addCombineRenderObj(s);c=!0}else l&&(t.getRenderQueue(h._material.renderQueue)._addRenderElement(h),l=null,h=null,d=-1),_++,c=!1;else r=this._prepareDynamicBatchCombineElements[m-1],o._addMaterialToRenderElementOffset(o.combineRenderElementsCount),n=r._material,o._addCombineMaterial(n),o._addCombineRenderObj(r),c=!0,a=s._material,n!==a?(l=a,d=o.combineRenderElementsCount,h=s):o._addCombineRenderObj(s),n=a}l&&(t.getRenderQueue(h._material.renderQueue)._addRenderElement(h),l=null,h=null,d=-1),this._prepareDynamicBatchCombineElements.length=0},t._clearRenderElements=function(){for(var e in this._dynamicBatches)this._dynamicBatches[e]._clearRenderElements()},t._addToRenderQueue=function(e,t,n,i){for(var r in this._dynamicBatches){var a=this._dynamicBatches[r];a.combineRenderElementsCount>0&&a._addToRenderQueue(e,t,n,i)}},t.dispose=function(){this._dynamicBatches=null},e._sortPrepareDynamicBatch=function(e,t){return e._mainSortID-t._mainSortID},e}(),_e=function(){function e(){}return r(e,"laya.d3.graphics.FrustumCulling"),e.renderObjectCulling=function(e,t,n,i,r,a){var s=0,o=0,l=0,h=0,u=t._quenes,c=t._staticBatchManager,_=t._dynamicBatchManager,d=t._frustumCullingObjects;for(s=0,o=u.length;s<o;s++){var m=u[s];m&&m._clearRenderElements()}c._clearRenderElements(),_._clearRenderElements();var f=n.transform.position;for(s=0,o=d.length;s<o;s++){var p=d[s];if(F.isVisible(p._layerMask)&&p._ownerEnable&&p._enable&&0!==e.containsBoundSphere(p._render.boundingSphere)){p._owner._prepareShaderValuetoRender(a),p._distanceForSort=rt.distance(p._render.boundingSphere.center,f)+p._render.sortingFudge;var v=p._renderElements;for(l=0,h=v.length;l<h;l++){var g=v[l],x=g._staticBatch;if(x&&x._material===g._material)x._addRenderElement(g);else{var E=g.renderObj;E.triangleCount<50&&1===E._vertexBufferCount&&E._getIndexBuffer()&&g._material.renderQueue<2&&g._canDynamicBatch&&!p._owner.isStatic?_._addPrepareRenderElement(g):t.getRenderQueue(g._material.renderQueue)._addRenderElement(g)}}}}c._addToRenderQueue(t,i,r,a),_._finishCombineDynamicBatch(t),_._addToRenderQueue(t,i,r,a)},e.renderObjectCullingOctree=function(e,t,n,i,r,a){for(var s=t._quenes,o=t._staticBatchManager,l=t._dynamicBatchManager,h=0,u=s.length;h<u;h++){var c=s[h];c&&c._clearRenderElements()}o._clearRenderElements(),l._clearRenderElements(),t._frustumCullingObjects.length=0,t.treeRoot.cullingObjects(e,!0,0,n.transform.position,a),o._addToRenderQueue(t,i,r,a),l._finishCombineDynamicBatch(t),l._addToRenderQueue(t,i,r,a)},e.renderObjectCullingNoBoundFrustum=function(e,t,n,i,r){var a=0,s=0,o=0,l=0,h=e._quenes,u=e._staticBatchManager,c=e._dynamicBatchManager,_=e._frustumCullingObjects;for(a=0,s=h.length;a<s;a++){var d=h[a];d&&d._clearRenderElements()}u._clearRenderElements(),c._clearRenderElements();var m=t.transform.position;for(a=0,s=_.length;a<s;a++){var f=_[a];if(F.isVisible(f._layerMask)&&f._ownerEnable&&f._enable){f._owner._prepareShaderValuetoRender(r),f._distanceForSort=rt.distance(f._render.boundingSphere.center,m)+f._render.sortingFudge;var p=f._renderElements;for(o=0,l=p.length;o<l;o++){var v=p[o],g=v._staticBatch;if(g&&g._material===v._material)g._addRenderElement(v);else{var x=v.renderObj;x.triangleCount<50&&1===x._vertexBufferCount&&x._getIndexBuffer()&&v._material.renderQueue<2&&v._canDynamicBatch&&!f._owner.isStatic?c._addPrepareRenderElement(v):e.getRenderQueue(v._material.renderQueue)._addRenderElement(v)}}}}u._addToRenderQueue(e,n,i,r),c._finishCombineDynamicBatch(e),c._addToRenderQueue(e,n,i,r)},e}(),de=function(){function e(e){this._owner=null,this._render=null,this._renderElements=null,this._layerMask=0,this._ownerEnable=!1,this._enable=!1,this._distanceForSort=NaN,this._treeNode=null,this._conchRenderObject=null,this._owner=e,this._renderElements=[],D.isConchNode&&(this._conchRenderObject=new ConchRenderObject)}return r(e,"laya.d3.graphics.RenderObject"),e.prototype._renderRuntime=function(e){for(var t=this._renderElements,n=0,i=t.length;n<i;n++)t[n].renderObj._renderRuntime(this._conchRenderObject,t[n],e)},e}(),me=function(){function e(e,t,n){this._vertexBuffer=null,this._indexBuffer=null,this._renderElements=null,this._combineRenderElementPool=null,this._combineRenderElementPoolIndex=0,this._combineRenderElements=null,this._currentCombineVertexCount=0,this._currentCombineIndexCount=0,this._needFinishCombine=!1,this._rootSprite=null,this._vertexDeclaration=null,this._material=null,this._shaderValues=null,this._owner=null,this._shaderValues=new ht,this._owner=e,this._currentCombineVertexCount=0,this._currentCombineIndexCount=0,this._needFinishCombine=!1,this._renderElements=[],this._combineRenderElements=[],this._combineRenderElementPool=[],this._combineRenderElementPoolIndex=0,this._rootSprite=e,this._vertexDeclaration=t,this._material=n}r(e,"laya.d3.graphics.StaticBatch");var t=e.prototype;return n.imps(t,{"laya.d3.core.render.IRenderable":!0}),t._getVertexBuffer=function(e){return void 0===e&&(e=0),0===e?this._vertexBuffer:null},t._getIndexBuffer=function(){return this._indexBuffer},t._getCombineRenderElementFromPool=function(){return this._combineRenderElementPool[this._combineRenderElementPoolIndex++]||(this._combineRenderElementPool[this._combineRenderElementPoolIndex-1]=new ae)},t._addCombineRenderObjTest=function(t){var n=t.renderObj;return!(this._currentCombineVertexCount+n._getVertexBuffer().vertexCount>e.maxVertexCount)},t._addCombineRenderObj=function(e){var t=e.renderObj;this._combineRenderElements.push(e),e._staticBatch=this,this._currentCombineIndexCount=this._currentCombineIndexCount+t._getIndexBuffer().indexCount,this._currentCombineVertexCount=this._currentCombineVertexCount+t._getVertexBuffer().vertexCount,this._needFinishCombine=!0},t._deleteCombineRenderObj=function(e){var t=e.renderObj,n=this._combineRenderElements.indexOf(e);n!==-1&&(this._combineRenderElements.splice(n,1),e._staticBatch=null,this._currentCombineIndexCount=this._currentCombineIndexCount-t._getIndexBuffer().indexCount,this._currentCombineVertexCount=this._currentCombineVertexCount-t._getVertexBuffer().vertexCount,this._needFinishCombine=!0)},t._finshCombine=function(){if(this._needFinishCombine){var e=0,t=0,n=new Float32Array(this._vertexDeclaration.vertexStride/4*this._currentCombineVertexCount),i=new Uint16Array(this._currentCombineIndexCount);this._vertexBuffer&&(this._vertexBuffer.dispose(),this._indexBuffer.dispose()),this._vertexBuffer=Zt.create(this._vertexDeclaration,this._currentCombineVertexCount,35044),this._indexBuffer=qt.create("ushort",this._currentCombineIndexCount,35044);for(var r=0,a=this._combineRenderElements.length;r<a;r++){var s=this._combineRenderElements[r],o=s.getStaticBatchBakedVertexs(0),l=s.getBakedIndices(),h=s._sprite3D.transform._isFrontFaceInvert,u=e/(this._vertexDeclaration.vertexStride/4),c=t,_=c+l.length;s._batchIndexStart=c,s._batchIndexEnd=_,i.set(l,t);var d=0;if(h)for(d=c;d<_;d+=3){i[d]=u+i[d];var m=i[d+1],f=i[d+2];i[d+1]=u+f,i[d+2]=u+m}else for(d=c;d<_;d+=3)i[d]=u+i[d],i[d+1]=u+i[d+1],i[d+2]=u+i[d+2];t+=l.length,n.set(o,e),e+=o.length}this._vertexBuffer.setData(n),this._indexBuffer.setData(i),this._needFinishCombine=!1}},t._clearRenderElements=function(){this._renderElements.length=0},t._addRenderElement=function(e){for(var t=0,n=this._renderElements.length;t<n;t++)if(this._renderElements[t]._batchIndexStart>e._batchIndexStart)return void this._renderElements.splice(t,0,e);this._renderElements.push(e)},t._getRenderElement=function(e){this._combineRenderElementPoolIndex=0;var t=this._renderElements.length,n=this._getCombineRenderElementFromPool();if(n._type=1,n._staticBatch=null,n.renderObj=this,n._batchIndexStart=this._renderElements[0]._batchIndexStart,n._batchIndexEnd=this._renderElements[0]._batchIndexEnd,n._material=this._material,n._material=this._material,e.push(n),t>1)for(var i=1;i<t;i++){var r=this._renderElements[i];this._renderElements[i-1]._batchIndexEnd!==r._batchIndexStart?(n=this._getCombineRenderElementFromPool(),n._type=1,n._staticBatch=null,n.renderObj=this,n._batchIndexStart=r._batchIndexStart,n._batchIndexEnd=r._batchIndexEnd,n._material=this._material,e.push(n)):n._batchIndexEnd=r._batchIndexEnd}},t._addToRenderQueue=function(e){this._renderElements.length>0&&e.getRenderQueue(this._material.renderQueue)._addStaticBatch(this)},t._beforeRender=function(e){return this._vertexBuffer._bind(),this._indexBuffer._bind(),!0},t._render=function(e){var t=e._batchIndexEnd-e._batchIndexStart;e.context.drawElements(4,t,5123,2*e._batchIndexStart),I.drawCall++,I.trianglesFaces+=t/3},t._renderRuntime=function(e,t,n){},a(0,t,"_vertexBufferCount",function(){return 1}),a(0,t,"indexOfHost",function(){return 0}),a(0,t,"triangleCount",function(){return this._indexBuffer.indexCount/3}),e._addToRenderQueueStaticBatch=function(t,n){var i=0,r=0;if(n instanceof laya.d3.core.MeshSprite3D&&n.isStatic){var a=n.meshRender.renderObject._renderElements;for(i=0,r=a.length;i<r;i++){var s=a[i];1===s.renderObj._vertexBufferCount&&t._staticBatchManager._addPrepareRenderElement(s)}}for(i=0,r=n.numChildren;i<r;i++)e._addToRenderQueueStaticBatch(t,n._childs[i])},e.combine=function(t){var n=t.scene;if(!n)throw new Error("BaseScene: staticBatchRoot is not a part of scene.");e._addToRenderQueueStaticBatch(n,t),n._staticBatchManager._finishCombineStaticBatch(t)},e.maxVertexCount=65535,e}(),fe=function(){function e(){this._staticBatches=null,this._prepareStaticBatchCombineElements=null,this._staticBatches={},this._prepareStaticBatchCombineElements=[]}r(e,"laya.d3.graphics.StaticBatchManager");var t=e.prototype;return t._finshCombine=function(){for(var e in this._staticBatches)this._staticBatches[e]._finshCombine()},t.getStaticBatch=function(e,t,n,i){var r,a=e.id.toString()+n.id.toString()+t.id.toString()+i;return this._staticBatches[a]?r=this._staticBatches[a]:this._staticBatches[a]=r=new me(e,t,n),r},t._garbageCollection=function(){for(var e in this._staticBatches)0===this._staticBatches[e].combineRenderElementsCount&&delete this._staticBatches[e]},t._addPrepareRenderElement=function(e){this._prepareStaticBatchCombineElements.push(e)},t._finishCombineStaticBatch=function(t){this._prepareStaticBatchCombineElements.sort(e._sortPrepareStaticBatch);for(var n,i,r,a,s,o,l,h=!1,u=0,c=0,_=this._prepareStaticBatchCombineElements.length;c<_;c++){if(a=this._prepareStaticBatchCombineElements[c],o=a.renderObj._getVertexBuffer(0),i===o.vertexDeclaration&&n===a._material)if(h)r._addCombineRenderObjTest(a)?(l=a._staticBatch,l&&l!==r&&l._deleteCombineRenderObj(a),r._addCombineRenderObj(a)):(h=!1,u++);else{s=this._prepareStaticBatchCombineElements[c-1];var d=s.renderObj,m=a.renderObj;d._getVertexBuffer().vertexCount+m._getVertexBuffer().vertexCount>me.maxVertexCount?h=!1:(r=this.getStaticBatch(t,i,n,u),l=s._staticBatch,l&&l!==r&&l._deleteCombineRenderObj(s),r._addCombineRenderObj(s),l=a._staticBatch,l&&l!==r&&l._deleteCombineRenderObj(a),r._addCombineRenderObj(a),h=!0)}else h=!1,u=0;n=a._material,i=o.vertexDeclaration}this._garbageCollection(),this._finshCombine(),this._prepareStaticBatchCombineElements.length=0},t._clearRenderElements=function(){for(var e in this._staticBatches)this._staticBatches[e]._clearRenderElements()},t._addToRenderQueue=function(e,t,n,i){for(var r in this._staticBatches){var a=this._staticBatches[r];a._owner._prepareShaderValuetoRender(i),a._addToRenderQueue(e)}},t.dispose=function(){this._staticBatches=null},e._sortPrepareStaticBatch=function(e,t){var n=e._mainSortID-t._mainSortID;return 0===n?e.renderObj.triangleCount-t.renderObj.triangleCount:n},e}(),pe=function(){function e(t,n){if(this._id=0,this._shaderValues=null,this._shaderDefineValue=0,this._vertexStride=0,this._vertexElements=null,this._vertexElementsDic=null,this._conchVertexDeclaration=null,this._id=++e._uniqueIDCounter,this._id>e.maxVertexDeclaration)throw new Error("VertexDeclaration: VertexDeclaration count should not large than ",e.maxVertexDeclaration);this._shaderValues=new ht,this._vertexElementsDic={},this._vertexStride=t,this._vertexElements=n,D.isConchNode&&(this._conchVertexDeclaration=new ConchVertexDeclare);for(var i=0;i<n.length;i++){var r=n[i],a=r.elementUsage;this._vertexElementsDic[a]=r;var s=[e._getTypeSize(r.elementFormat)/4,5126,!1,this._vertexStride,r.offset];switch(this._shaderValues.setValue(a,s),a){case 2:this._addShaderDefine(lt.SHADERDEFINE_UV);break;case 1:this._addShaderDefine(lt.SHADERDEFINE_COLOR)}}if(D.isConchNode){for(var o=[],l=0,h=n.length;l<h;l++){var u=n[l];switch(u.elementFormat){case"vector2":o.push({offset:u.offset,elementFormat:35664,elementUsage:u.elementUsage});break;case"vector3":o.push({offset:u.offset,elementFormat:35665,elementUsage:u.elementUsage});break;case"vector4":o.push({offset:u.offset,elementFormat:35666,elementUsage:u.elementUsage})}}this._conchVertexDeclaration.setDelcare(o)}}r(e,"laya.d3.graphics.VertexDeclaration");var t=e.prototype;return t._addShaderDefine=function(e){this._shaderDefineValue|=e,this._conchVertexDeclaration&&this._conchVertexDeclaration.addShaderDefine(e)},t._removeShaderDefine=function(e){this._shaderDefineValue&=~e,this._conchVertexDeclaration&&this._conchVertexDeclaration.removeShaderDefine(e)},t.getVertexElements=function(){return this._vertexElements.slice()},t.getVertexElementByUsage=function(e){return this._vertexElementsDic[e]},t.unBinding=function(){},a(0,t,"shaderDefineValue",function(){return this._shaderDefineValue}),a(0,t,"id",function(){return this._id}),a(0,t,"vertexStride",function(){return this._vertexStride}),a(0,t,"shaderValues",function(){return this._shaderValues}),e._getTypeSize=function(e){switch(e){case"single":return 4;case"vector2":return 8;case"vector3":return 12;case"vector4":return 16;case"color":return 4;case"byte4":return 4;case"short2":return 4;case"short4":return 8;case"normalizedshort2":return 4;case"normalizedshort4":return 8;case"halfvector2":return 4;case"halfvector4":return 8}return 0},e.getVertexStride=function(t){for(var n=0,i=0;i<t.Length;i++){var r=t[i],a=r.offset+e._getTypeSize(r.elementFormat);n<a&&(n=a)}return n},e._maxVertexDeclarationBit=1e3,e._uniqueIDCounter=1,i(e,["maxVertexDeclaration",function(){return this.maxVertexDeclaration=2147483647-1e3*Math.floor(2147483.647)}]),e}(),ve=function(){function e(e,t,n){this.offset=0,this.elementFormat=null,this.elementUsage=0,this.offset=e,this.elementFormat=t,this.elementUsage=n}return r(e,"laya.d3.graphics.VertexElement"),e}(),ge=(function(){function e(){}r(e,"laya.d3.graphics.VertexElementFormat"),e.Single="single",e.Vector2="vector2",e.Vector3="vector3",e.Vector4="vector4",e.Color="color",e.Byte4="byte4",e.Short2="short2",e.Short4="short4",e.NormalizedShort2="normalizedshort2",e.NormalizedShort4="normalizedshort4",e.HalfVector2="halfvector2",e.HalfVector4="halfvector4",e}(),function(){function e(){}r(e,"laya.d3.graphics.VertexElementUsage"),e.POSITION0=0,e.COLOR0=1,e.TEXTURECOORDINATE0=2,e.NORMAL0=3,e.BINORMAL0=4,e.TANGENT0=5,e.BLENDINDICES0=6,e.BLENDWEIGHT0=7,e.DEPTH0=8,e.FOG0=9,e.POINTSIZE0=10,e.SAMPLE0=11,e.TESSELLATEFACTOR0=12,e.COLOR1=13,e.NEXTTEXTURECOORDINATE0=14,e.TEXTURECOORDINATE1=15,e.NEXTTEXTURECOORDINATE1=16,e.CORNERTEXTURECOORDINATE0=17,e.VELOCITY0=18,e.STARTCOLOR0=19,e.STARTSIZE=20,e.AGEADDSCALE0=21,e.STARTROTATION0=22,e.STARTROTATION1=23,e.STARTROTATION2=24,e.ENDCOLOR0=25,e.STARTLIFETIME=26,e.TIME0=33,e.POSITIONSTARTLIFETIME=30,e.DIRECTIONTIME=32,e.SIZEROTATION0=27,e.RADIUS0=28,e.RADIAN0=29,e.STARTSPEED=31,e.RANDOM0=34,e.RANDOM1=35,e.SIMULATIONWORLDPOSTION=36,e}(),function(){function e(e,t,n){this._position=null,this._textureCoordinate0=null,this._time=NaN,this._position=e,this._textureCoordinate0=t,this._time=n}r(e,"laya.d3.graphics.VertexGlitter");var t=e.prototype;return n.imps(t,{"laya.d3.graphics.IVertex":!0}),a(0,t,"textureCoordinate",function(){return this._textureCoordinate0}),a(0,t,"position",function(){return this._position}),a(0,t,"time",function(){return this._time}),a(0,t,"vertexDeclaration",function(){return e._vertexDeclaration}),a(1,e,"vertexDeclaration",function(){return e._vertexDeclaration}),i(e,["_vertexDeclaration",function(){return this._vertexDeclaration=new pe(24,[new ve(0,"vector3",0),new ve(12,"vector2",2),new ve(20,"single",33)])}]),e}()),xe=function(){function e(e,t,n,i,r,a,s,o,l,h){this._cornerTextureCoordinate=null,this._position=null,this._velocity=null,this._startColor=null,this._endColor=null,
this._sizeRotation=null,this._radius=null,this._radian=null,this._ageAddScale=NaN,this._time=NaN,this._cornerTextureCoordinate=e,this._position=t,this._velocity=n,this._startColor=i,this._endColor=r,this._sizeRotation=a,this._radius=s,this._radian=o,this._ageAddScale=l,this._time=h}r(e,"laya.d3.graphics.VertexParticle");var t=e.prototype;return n.imps(t,{"laya.d3.graphics.IVertex":!0}),a(0,t,"endColor",function(){return this._endColor}),a(0,t,"cornerTextureCoordinate",function(){return this._cornerTextureCoordinate}),a(0,t,"sizeRotation",function(){return this._sizeRotation}),a(0,t,"velocity",function(){return this._velocity}),a(0,t,"position",function(){return this._position}),a(0,t,"startColor",function(){return this._startColor}),a(0,t,"radius",function(){return this._radius}),a(0,t,"radian",function(){return this._radian}),a(0,t,"ageAddScale",function(){return this._ageAddScale}),a(0,t,"time",function(){return this._time}),a(0,t,"vertexDeclaration",function(){return e._vertexDeclaration}),a(1,e,"vertexDeclaration",function(){return e._vertexDeclaration}),i(e,["_vertexDeclaration",function(){return this._vertexDeclaration=new pe(116,[new ve(0,"vector4",17),new ve(16,"vector3",0),new ve(28,"vector3",18),new ve(40,"vector4",19),new ve(56,"vector4",25),new ve(72,"vector3",27),new ve(84,"vector2",28),new ve(92,"vector4",29),new ve(108,"single",26),new ve(112,"single",33)])}]),e}(),Ee=function(){function e(e,t,n,i,r,a,s,o,l,h,u,c,_,d){this._cornerTextureCoordinate=null,this._position=null,this._velocity=null,this._startColor=null,this._startSize=null,this._startRotation0=null,this._startRotation1=null,this._startRotation2=null,this._startLifeTime=NaN,this._time=NaN,this._startSpeed=NaN,this._randoms0=null,this._randoms1=null,this._simulationWorldPostion=null,this._cornerTextureCoordinate=e,this._position=t,this._velocity=n,this._startColor=i,this._startSize=r,this._startRotation0=a,this._startRotation1=s,this._startRotation2=o,this._startLifeTime=l,this._time=h,this._startSpeed=u,this._randoms0=this.random0,this._randoms1=this.random1,this._simulationWorldPostion=d}r(e,"laya.d3.graphics.VertexParticleShuriken");var t=e.prototype;return n.imps(t,{"laya.d3.graphics.IVertex":!0}),a(0,t,"cornerTextureCoordinate",function(){return this._cornerTextureCoordinate}),a(0,t,"velocity",function(){return this._velocity}),a(0,t,"position",function(){return this._position}),a(0,t,"random0",function(){return this._randoms0}),a(0,t,"startSize",function(){return this._startSize}),a(0,t,"startColor",function(){return this._startColor}),a(0,t,"startRotation0",function(){return this._startRotation0}),a(0,t,"startRotation1",function(){return this._startRotation1}),a(0,t,"random1",function(){return this._randoms1}),a(0,t,"startRotation2",function(){return this._startRotation2}),a(0,t,"startLifeTime",function(){return this._startLifeTime}),a(0,t,"time",function(){return this._time}),a(0,t,"startSpeed",function(){return this._startSpeed}),a(0,t,"simulationWorldPostion",function(){return this._simulationWorldPostion}),a(0,t,"vertexDeclaration",function(){return e._vertexDeclaration}),a(1,e,"vertexDeclaration",function(){return e._vertexDeclaration}),i(e,["_vertexDeclaration",function(){return this._vertexDeclaration=new pe(160,[new ve(0,"vector4",17),new ve(16,"vector4",30),new ve(32,"vector4",32),new ve(48,"vector4",19),new ve(64,"vector3",20),new ve(76,"vector3",22),new ve(88,"vector3",23),new ve(100,"vector3",24),new ve(112,"single",31),new ve(116,"vector4",34),new ve(132,"vector4",35),new ve(148,"vector3",36)])}]),e}(),Me=function(){function e(e,t,n){this._position=null,this._normal=null,this._color=null,this._position=e,this._normal=t,this._color=n}r(e,"laya.d3.graphics.VertexPositionNormalColor");var t=e.prototype;return n.imps(t,{"laya.d3.graphics.IVertex":!0}),a(0,t,"normal",function(){return this._normal}),a(0,t,"position",function(){return this._position}),a(0,t,"color",function(){return this._color}),a(0,t,"vertexDeclaration",function(){return e._vertexDeclaration}),a(1,e,"vertexDeclaration",function(){return e._vertexDeclaration}),i(e,["_vertexDeclaration",function(){return this._vertexDeclaration=new pe(40,[new ve(0,"vector3",0),new ve(12,"vector3",3),new ve(24,"vector4",1)])}]),e}(),Te=function(){function e(e,t,n,i,r){this._position=null,this._normal=null,this._color=null,this._blendIndex=null,this._blendWeight=null,this._position=e,this._normal=t,this._color=n,this._blendIndex=i,this._blendWeight=r}r(e,"laya.d3.graphics.VertexPositionNormalColorSkin");var t=e.prototype;return n.imps(t,{"laya.d3.graphics.IVertex":!0}),a(0,t,"normal",function(){return this._normal}),a(0,t,"position",function(){return this._position}),a(0,t,"blendWeight",function(){return this._blendWeight}),a(0,t,"color",function(){return this._color}),a(0,t,"blendIndex",function(){return this._blendIndex}),a(0,t,"vertexDeclaration",function(){return e._vertexDeclaration}),a(1,e,"vertexDeclaration",function(){return e._vertexDeclaration}),i(e,["_vertexDeclaration",function(){return this._vertexDeclaration=new pe(72,[new ve(0,"vector3",0),new ve(12,"vector3",3),new ve(24,"vector4",1),new ve(40,"vector4",7),new ve(56,"vector4",6)])}]),e}(),Se=function(){function e(e,t,n,i,r,a){this._position=null,this._normal=null,this._color=null,this._blendIndex=null,this._blendWeight=null,this._tangent=null,this._position=e,this._normal=t,this._color=n,this._tangent=i,this._blendIndex=r,this._blendWeight=a}r(e,"laya.d3.graphics.VertexPositionNormalColorSkinTangent");var t=e.prototype;return n.imps(t,{"laya.d3.graphics.IVertex":!0}),a(0,t,"tangent",function(){return this._tangent}),a(0,t,"normal",function(){return this._normal}),a(0,t,"position",function(){return this._position}),a(0,t,"blendWeight",function(){return this._blendWeight}),a(0,t,"color",function(){return this._color}),a(0,t,"blendIndex",function(){return this._blendIndex}),a(0,t,"vertexDeclaration",function(){return e._vertexDeclaration}),a(1,e,"vertexDeclaration",function(){return e._vertexDeclaration}),i(e,["_vertexDeclaration",function(){return this._vertexDeclaration=new pe(84,[new ve(0,"vector3",0),new ve(12,"vector3",3),new ve(24,"vector4",1),new ve(40,"vector4",7),new ve(56,"vector4",6),new ve(72,"vector3",5)])}]),e}(),ye=function(){function e(e,t,n,i){this._position=null,this._normal=null,this._color=null,this._tangent=null,this._position=e,this._normal=t,this._color=n,this._tangent=i}r(e,"laya.d3.graphics.VertexPositionNormalColorTangent");var t=e.prototype;return n.imps(t,{"laya.d3.graphics.IVertex":!0}),a(0,t,"tangent",function(){return this._tangent}),a(0,t,"normal",function(){return this._normal}),a(0,t,"position",function(){return this._position}),a(0,t,"color",function(){return this._color}),a(0,t,"vertexDeclaration",function(){return e._vertexDeclaration}),a(1,e,"vertexDeclaration",function(){return e._vertexDeclaration}),i(e,["_vertexDeclaration",function(){return this._vertexDeclaration=new pe(52,[new ve(0,"vector3",0),new ve(12,"vector3",3),new ve(24,"vector4",1),new ve(40,"vector3",5)])}]),e}(),De=function(){function e(e,t,n,i){this._position=null,this._normal=null,this._color=null,this._textureCoordinate=null,this._position=e,this._normal=t,this._color=n,this._textureCoordinate=i}r(e,"laya.d3.graphics.VertexPositionNormalColorTexture");var t=e.prototype;return n.imps(t,{"laya.d3.graphics.IVertex":!0}),a(0,t,"textureCoordinate",function(){return this._textureCoordinate}),a(0,t,"normal",function(){return this._normal}),a(0,t,"position",function(){return this._position}),a(0,t,"color",function(){return this._color}),a(0,t,"vertexDeclaration",function(){return e._vertexDeclaration}),a(1,e,"vertexDeclaration",function(){return e._vertexDeclaration}),i(e,["_vertexDeclaration",function(){return this._vertexDeclaration=new pe(48,[new ve(0,"vector3",0),new ve(12,"vector3",3),new ve(24,"vector4",1),new ve(40,"vector2",2)])}]),e}(),Re=function(){function e(e,t,n,i,r){this._position=null,this._normal=null,this._color=null,this._textureCoordinate0=null,this._textureCoordinate1=null,this._position=e,this._normal=t,this._color=n,this._textureCoordinate0=i,this._textureCoordinate1=r}r(e,"laya.d3.graphics.VertexPositionNormalColorTexture0Texture1");var t=e.prototype;return n.imps(t,{"laya.d3.graphics.IVertex":!0}),a(0,t,"normal",function(){return this._normal}),a(0,t,"position",function(){return this._position}),a(0,t,"color",function(){return this._color}),a(0,t,"textureCoordinate0",function(){return this._textureCoordinate0}),a(0,t,"vertexDeclaration",function(){return e._vertexDeclaration}),a(0,t,"textureCoordinate1",function(){return this._textureCoordinate1}),a(1,e,"vertexDeclaration",function(){return e._vertexDeclaration}),i(e,["_vertexDeclaration",function(){return this._vertexDeclaration=new pe(56,[new ve(0,"vector3",0),new ve(12,"vector3",3),new ve(24,"vector4",1),new ve(40,"vector2",2),new ve(48,"vector2",15)])}]),e}(),Ce=function(){function e(e,t,n,i,r,a,s){this._position=null,this._normal=null,this._color=null,this._textureCoordinate0=null,this._textureCoordinate1=null,this._blendIndex=null,this._blendWeight=null,this._position=e,this._normal=t,this._color=n,this._textureCoordinate0=i,this._textureCoordinate1=r,this._blendIndex=a,this._blendWeight=s}r(e,"laya.d3.graphics.VertexPositionNormalColorTexture0Texture1Skin");var t=e.prototype;return n.imps(t,{"laya.d3.graphics.IVertex":!0}),a(0,t,"normal",function(){return this._normal}),a(0,t,"position",function(){return this._position}),a(0,t,"blendWeight",function(){return this._blendWeight}),a(0,t,"color",function(){return this._color}),a(0,t,"textureCoordinate0",function(){return this._textureCoordinate0}),a(0,t,"vertexDeclaration",function(){return e._vertexDeclaration}),a(0,t,"textureCoordinate1",function(){return this._textureCoordinate1}),a(0,t,"blendIndex",function(){return this._blendIndex}),a(1,e,"vertexDeclaration",function(){return e._vertexDeclaration}),i(e,["_vertexDeclaration",function(){return this._vertexDeclaration=new pe(88,[new ve(0,"vector3",0),new ve(12,"vector3",3),new ve(24,"vector4",1),new ve(40,"vector2",2),new ve(48,"vector2",15),new ve(56,"vector4",7),new ve(72,"vector4",6)])}]),e}(),Ve=function(){function e(){this._position=null,this._normal=null,this._color=null,this._textureCoordinate0=null,this._textureCoordinate1=null,this._blendIndex=null,this._blendWeight=null,this._tangent=null}r(e,"laya.d3.graphics.VertexPositionNormalColorTexture0Texture1SkinTangent");var t=e.prototype;return n.imps(t,{"laya.d3.graphics.IVertex":!0}),t.VertexPositionNormalColorTexture0SkinTangent=function(e,t,n,i,r,a,s,o){this._position=e,this._normal=t,this._color=n,this._textureCoordinate0=i,this._textureCoordinate1=r,this._tangent=a,this._blendIndex=s,this._blendWeight=o},a(0,t,"tangent",function(){return this._tangent}),a(0,t,"normal",function(){return this._normal}),a(0,t,"position",function(){return this._position}),a(0,t,"blendWeight",function(){return this._blendWeight}),a(0,t,"color",function(){return this._color}),a(0,t,"textureCoordinate0",function(){return this._textureCoordinate0}),a(0,t,"vertexDeclaration",function(){return e._vertexDeclaration}),a(0,t,"textureCoordinate1",function(){return this._textureCoordinate1}),a(0,t,"blendIndex",function(){return this._blendIndex}),a(1,e,"vertexDeclaration",function(){return e._vertexDeclaration}),i(e,["_vertexDeclaration",function(){return this._vertexDeclaration=new pe(100,[new ve(0,"vector3",0),new ve(12,"vector3",3),new ve(24,"vector4",1),new ve(40,"vector2",2),new ve(48,"vector2",15),new ve(56,"vector4",7),new ve(72,"vector4",6),new ve(88,"vector3",5)])}]),e}(),Ae=function(){function e(){this._position=null,this._normal=null,this._color=null,this._textureCoordinate0=null,this._textureCoordinate1=null,this._tangent=null}r(e,"laya.d3.graphics.VertexPositionNormalColorTexture0Texture1Tangent");var t=e.prototype;return n.imps(t,{"laya.d3.graphics.IVertex":!0}),t.VertexPositionNormalColorTexture0Tangent=function(e,t,n,i,r,a){this._position=e,this._normal=t,this._color=n,this._textureCoordinate0=i,this._textureCoordinate1=r,this._tangent=a},a(0,t,"tangent",function(){return this._tangent}),a(0,t,"normal",function(){return this._normal}),a(0,t,"position",function(){return this._position}),a(0,t,"color",function(){return this._color}),a(0,t,"textureCoordinate0",function(){return this._textureCoordinate0}),a(0,t,"vertexDeclaration",function(){return e._vertexDeclaration}),a(0,t,"textureCoordinate1",function(){return this._textureCoordinate1}),a(1,e,"vertexDeclaration",function(){return e._vertexDeclaration}),i(e,["_vertexDeclaration",function(){return this._vertexDeclaration=new pe(68,[new ve(0,"vector3",0),new ve(12,"vector3",3),new ve(24,"vector4",1),new ve(40,"vector2",2),new ve(48,"vector2",15),new ve(56,"vector3",5)])}]),e}(),Ie=function(){function e(e,t,n,i,r,a){this._position=null,this._normal=null,this._color=null,this._textureCoordinate=null,this._blendIndex=null,this._blendWeight=null,this._position=e,this._normal=t,this._color=n,this._textureCoordinate=i,this._blendIndex=r,this._blendWeight=a}r(e,"laya.d3.graphics.VertexPositionNormalColorTextureSkin");var t=e.prototype;return n.imps(t,{"laya.d3.graphics.IVertex":!0}),a(0,t,"textureCoordinate",function(){return this._textureCoordinate}),a(0,t,"normal",function(){return this._normal}),a(0,t,"position",function(){return this._position}),a(0,t,"blendWeight",function(){return this._blendWeight}),a(0,t,"color",function(){return this._color}),a(0,t,"blendIndex",function(){return this._blendIndex}),a(0,t,"vertexDeclaration",function(){return e._vertexDeclaration}),a(1,e,"vertexDeclaration",function(){return e._vertexDeclaration}),i(e,["_vertexDeclaration",function(){return this._vertexDeclaration=new pe(80,[new ve(0,"vector3",0),new ve(12,"vector3",3),new ve(24,"vector4",1),new ve(40,"vector2",2),new ve(48,"vector4",7),new ve(64,"vector4",6)])}]),e}(),be=function(){function e(e,t,n,i,r,a,s){this._position=null,this._normal=null,this._color=null,this._textureCoordinate=null,this._blendIndex=null,this._blendWeight=null,this._tangent=null,this._position=e,this._normal=t,this._color=n,this._textureCoordinate=i,this._tangent=r,this._blendIndex=a,this._blendWeight=s}r(e,"laya.d3.graphics.VertexPositionNormalColorTextureSkinTangent");var t=e.prototype;return n.imps(t,{"laya.d3.graphics.IVertex":!0}),a(0,t,"tangent",function(){return this._tangent}),a(0,t,"textureCoordinate",function(){return this._textureCoordinate}),a(0,t,"normal",function(){return this._normal}),a(0,t,"position",function(){return this._position}),a(0,t,"blendWeight",function(){return this._blendWeight}),a(0,t,"color",function(){return this._color}),a(0,t,"blendIndex",function(){return this._blendIndex}),a(0,t,"vertexDeclaration",function(){return e._vertexDeclaration}),a(1,e,"vertexDeclaration",function(){return e._vertexDeclaration}),i(e,["_vertexDeclaration",function(){return this._vertexDeclaration=new pe(92,[new ve(0,"vector3",0),new ve(12,"vector3",3),new ve(24,"vector4",1),new ve(40,"vector2",2),new ve(48,"vector4",7),new ve(64,"vector4",6),new ve(80,"vector3",5)])}]),e}(),we=function(){function e(e,t,n,i,r){this._position=null,this._normal=null,this._color=null,this._textureCoordinate=null,this._tangent=null,this._position=e,this._normal=t,this._color=n,this._textureCoordinate=i,this._tangent=r}r(e,"laya.d3.graphics.VertexPositionNormalColorTextureTangent");var t=e.prototype;return n.imps(t,{"laya.d3.graphics.IVertex":!0}),a(0,t,"tangent",function(){return this._tangent}),a(0,t,"textureCoordinate",function(){return this._textureCoordinate}),a(0,t,"normal",function(){return this._normal}),a(0,t,"position",function(){return this._position}),a(0,t,"color",function(){return this._color}),a(0,t,"vertexDeclaration",function(){return e._vertexDeclaration}),a(1,e,"vertexDeclaration",function(){return e._vertexDeclaration}),i(e,["_vertexDeclaration",function(){return this._vertexDeclaration=new pe(60,[new ve(0,"vector3",0),new ve(12,"vector3",3),new ve(24,"vector4",1),new ve(40,"vector2",2),new ve(48,"vector3",5)])}]),e}(),Oe=function(){function e(e,t,n){this._position=null,this._normal=null,this._textureCoordinate=null,this._position=e,this._normal=t,this._textureCoordinate=n}r(e,"laya.d3.graphics.VertexPositionNormalTexture");var t=e.prototype;return n.imps(t,{"laya.d3.graphics.IVertex":!0}),a(0,t,"textureCoordinate",function(){return this._textureCoordinate}),a(0,t,"normal",function(){return this._normal}),a(0,t,"position",function(){return this._position}),a(0,t,"vertexDeclaration",function(){return e._vertexDeclaration}),a(1,e,"vertexDeclaration",function(){return e._vertexDeclaration}),i(e,["_vertexDeclaration",function(){return this._vertexDeclaration=new pe(32,[new ve(0,"vector3",0),new ve(12,"vector3",3),new ve(24,"vector2",2)])}]),e}(),Ne=function(){function e(e,t,n,i){this._position=null,this._normal=null,this._textureCoordinate0=null,this._textureCoordinate1=null,this._position=e,this._normal=t,this._textureCoordinate0=n,this._textureCoordinate1=i}r(e,"laya.d3.graphics.VertexPositionNormalTexture0Texture1");var t=e.prototype;return n.imps(t,{"laya.d3.graphics.IVertex":!0}),a(0,t,"normal",function(){return this._normal}),a(0,t,"position",function(){return this._position}),a(0,t,"textureCoordinate0",function(){return this._textureCoordinate0}),a(0,t,"vertexDeclaration",function(){return e._vertexDeclaration}),a(0,t,"textureCoordinate1",function(){return this._textureCoordinate1}),a(1,e,"vertexDeclaration",function(){return e._vertexDeclaration}),i(e,["_vertexDeclaration",function(){return this._vertexDeclaration=new pe(40,[new ve(0,"vector3",0),new ve(12,"vector3",3),new ve(24,"vector2",2),new ve(32,"vector2",15)])}]),e}(),Pe=function(){function e(e,t,n,i,r,a){this._position=null,this._normal=null,this._textureCoordinate0=null,this._textureCoordinate1=null,this._blendIndex=null,this._blendWeight=null,this._position=e,this._normal=t,this._textureCoordinate0=n,this._textureCoordinate1=i,this._blendIndex=r,this._blendWeight=a}r(e,"laya.d3.graphics.VertexPositionNormalTexture0Texture1Skin");var t=e.prototype;return n.imps(t,{"laya.d3.graphics.IVertex":!0}),a(0,t,"normal",function(){return this._normal}),a(0,t,"position",function(){return this._position}),a(0,t,"textureCoordinate0",function(){return this._textureCoordinate0}),a(0,t,"vertexDeclaration",function(){return e._vertexDeclaration}),a(0,t,"textureCoordinate1",function(){return this._textureCoordinate1}),a(0,t,"blendIndex",function(){return this._blendIndex}),a(0,t,"blendWeight",function(){return this._blendWeight}),a(1,e,"vertexDeclaration",function(){return e._vertexDeclaration}),i(e,["_vertexDeclaration",function(){return this._vertexDeclaration=new pe(72,[new ve(0,"vector3",0),new ve(12,"vector3",3),new ve(24,"vector2",2),new ve(32,"vector2",15),new ve(40,"vector4",7),new ve(56,"vector4",6)])}]),e}(),Le=function(){function e(){this._position=null,this._normal=null,this._textureCoordinate0=null,this._textureCoordinate1=null,this._blendIndex=null,this._blendWeight=null,this._tangent=null}r(e,"laya.d3.graphics.VertexPositionNormalTexture0Texture1SkinTangent");var t=e.prototype;return n.imps(t,{"laya.d3.graphics.IVertex":!0}),t.VertexPositionNormalTexture0SkinTangent=function(e,t,n,i,r,a,s){this._position=e,this._normal=t,this._textureCoordinate0=n,this._textureCoordinate1=i,this._tangent=r,this._blendIndex=a,this._blendWeight=s},a(0,t,"tangent",function(){return this._tangent}),a(0,t,"normal",function(){return this._normal}),a(0,t,"position",function(){return this._position}),a(0,t,"textureCoordinate0",function(){return this._textureCoordinate0}),a(0,t,"vertexDeclaration",function(){return e._vertexDeclaration}),a(0,t,"textureCoordinate1",function(){return this._textureCoordinate1}),a(0,t,"blendIndex",function(){return this._blendIndex}),a(0,t,"blendWeight",function(){return this._blendWeight}),a(1,e,"vertexDeclaration",function(){return e._vertexDeclaration}),i(e,["_vertexDeclaration",function(){return this._vertexDeclaration=new pe(84,[new ve(0,"vector3",0),new ve(12,"vector3",3),new ve(24,"vector2",2),new ve(32,"vector2",15),new ve(40,"vector4",7),new ve(56,"vector4",6),new ve(72,"vector3",5)])}]),e}(),Be=function(){function e(){this._position=null,this._normal=null,this._textureCoordinate0=null,this._textureCoordinate1=null,this._tangent=null}r(e,"laya.d3.graphics.VertexPositionNormalTexture0Texture1Tangent");var t=e.prototype;return n.imps(t,{"laya.d3.graphics.IVertex":!0}),t.VertexPositionNormalTexture0Tangent=function(e,t,n,i,r){this._position=e,this._normal=t,this._textureCoordinate0=n,this._textureCoordinate1=i,this._tangent=r},a(0,t,"tangent",function(){return this._tangent}),a(0,t,"normal",function(){return this._normal}),a(0,t,"position",function(){return this._position}),a(0,t,"textureCoordinate0",function(){return this._textureCoordinate0}),a(0,t,"vertexDeclaration",function(){return e._vertexDeclaration}),a(0,t,"textureCoordinate1",function(){return this._textureCoordinate1}),a(1,e,"vertexDeclaration",function(){return e._vertexDeclaration}),i(e,["_vertexDeclaration",function(){return this._vertexDeclaration=new pe(52,[new ve(0,"vector3",0),new ve(12,"vector3",3),new ve(24,"vector2",2),new ve(32,"vector2",15),new ve(40,"vector3",5)])}]),e}(),Fe=function(){function e(e,t,n,i,r){this._position=null,this._normal=null,this._textureCoordinate=null,this._blendIndex=null,this._blendWeight=null,this._position=e,this._normal=t,this._textureCoordinate=n,this._blendIndex=i,this._blendWeight=r}r(e,"laya.d3.graphics.VertexPositionNormalTextureSkin");var t=e.prototype;return n.imps(t,{"laya.d3.graphics.IVertex":!0}),a(0,t,"textureCoordinate",function(){return this._textureCoordinate}),a(0,t,"normal",function(){return this._normal}),a(0,t,"position",function(){return this._position}),a(0,t,"blendIndex",function(){return this._blendIndex}),a(0,t,"blendWeight",function(){return this._blendWeight}),a(0,t,"vertexDeclaration",function(){return e._vertexDeclaration}),a(1,e,"vertexDeclaration",function(){return e._vertexDeclaration}),i(e,["_vertexDeclaration",function(){return this._vertexDeclaration=new pe(64,[new ve(0,"vector3",0),new ve(12,"vector3",3),new ve(24,"vector2",2),new ve(32,"vector4",7),new ve(48,"vector4",6)])}]),e}(),Ue=function(){function e(e,t,n,i,r,a){this._position=null,this._normal=null,this._textureCoordinate=null,this._blendIndex=null,this._blendWeight=null,this._tangent=null,this._position=e,this._normal=t,this._textureCoordinate=n,this._tangent=i,this._blendIndex=r,this._blendWeight=a}r(e,"laya.d3.graphics.VertexPositionNormalTextureSkinTangent");var t=e.prototype;return n.imps(t,{"laya.d3.graphics.IVertex":!0}),a(0,t,"tangent",function(){return this._tangent}),a(0,t,"textureCoordinate",function(){return this._textureCoordinate}),a(0,t,"normal",function(){return this._normal}),a(0,t,"position",function(){return this._position}),a(0,t,"blendIndex",function(){return this._blendIndex}),a(0,t,"blendWeight",function(){return this._blendWeight}),a(0,t,"vertexDeclaration",function(){return e._vertexDeclaration}),a(1,e,"vertexDeclaration",function(){return e._vertexDeclaration}),i(e,["_vertexDeclaration",function(){return this._vertexDeclaration=new pe(76,[new ve(0,"vector3",0),new ve(12,"vector3",3),new ve(24,"vector2",2),new ve(32,"vector4",7),new ve(48,"vector4",6),new ve(64,"vector3",5)])}]),e}(),ze=function(){function e(e,t,n,i){this._position=null,this._normal=null,this._textureCoordinate=null,this._tangent=null,this._position=e,this._normal=t,this._textureCoordinate=n,this._tangent=i}r(e,"laya.d3.graphics.VertexPositionNormalTextureTangent");var t=e.prototype;return n.imps(t,{"laya.d3.graphics.IVertex":!0}),a(0,t,"tangent",function(){return this._tangent}),a(0,t,"textureCoordinate",function(){return this._textureCoordinate}),a(0,t,"normal",function(){return this._normal}),a(0,t,"position",function(){return this._position}),a(0,t,"vertexDeclaration",function(){return e._vertexDeclaration}),a(1,e,"vertexDeclaration",function(){return e._vertexDeclaration}),i(e,["_vertexDeclaration",function(){return this._vertexDeclaration=new pe(44,[new ve(0,"vector3",0),new ve(12,"vector3",3),new ve(24,"vector2",2),new ve(32,"vector3",5)])}]),e}(),He=function(){function e(e,t,n){this._position=null,this._normal=null,this._textureCoordinate=null,this._position=e,this._normal=t,this._textureCoordinate=n}r(e,"laya.d3.graphics.VertexPositionNTBTexture");var t=e.prototype;return n.imps(t,{"laya.d3.graphics.IVertex":!0}),a(0,t,"textureCoordinate",function(){return this._textureCoordinate}),a(0,t,"normal",function(){return this._normal}),a(0,t,"position",function(){return this._position}),a(0,t,"vertexDeclaration",function(){return e._vertexDeclaration}),a(1,e,"vertexDeclaration",function(){return e._vertexDeclaration}),i(e,["_vertexDeclaration",function(){return this._vertexDeclaration=new pe(56,[new ve(0,"vector3",0),new ve(12,"vector3",3),new ve(24,"vector3",5),new ve(36,"vector3",4),new ve(48,"vector2",2)])}]),e}(),Ge=function(){function e(e,t,n,i,r){this._version=null,this._strings=["BLOCK","DATA","STRINGS"],this._materials=null,this._materialMap=null,this._readData=null,this._mesh=null,this._BLOCK={count:0},this._DATA={offset:0,size:0},this._STRINGS={offset:0,size:0},this._shaderAttributes=null,this._mesh=n,this._materials=i,this._materialMap=r,this._version=t,this._onLoaded(e)}r(e,"laya.d3.loaders.LoadModelV01");var t=e.prototype;return t._onLoaded=function(e){this._readData=e,this.READ_BLOCK();for(var t=0;t<this._BLOCK.count;t++){var n=this._readData.getUint16(),i=this._strings[n],r=this["READ_"+i];if(null==r)throw new Error("model file err,no this function:"+n+" "+i);if(!r.call(this))break}return this._mesh},t.onError=function(){},t._readString=function(){return this._strings[this._readData.getUint16()]},t.READ_BLOCK=function(){this._readData.getUint16();return this._BLOCK.count=this._readData.getUint16(),!0},t.READ_DATA=function(){return this._DATA.offset=this._readData.getUint32(),this._DATA.size=this._readData.getUint32(),!0},t.READ_STRINGS=function(){this._STRINGS.offset=this._readData.getUint16(),this._STRINGS.size=this._readData.getUint16();var e=this._readData.pos;this._readData.pos=this._STRINGS.offset+this._DATA.offset;for(var t=0;t<this._STRINGS.size;t++)this._strings[t]=this._readData.readUTFString();return this._readData.pos=e,!0},t.READ_MATERIAL=function(){var e=this._readData.getUint16(),t=(this._readString(),this._readString());return this._materials[e]="null"!==t?x.getRes(this._materialMap[t]):new Dt,!0},t.READ_MESH=function(){this._readString();switch(this._version){case"LAYAMODEL:01":console.log("Warning: The (.lm) file is converted by old fbxTools,please reConverted it use  lastest fbxTools version,later we will remove the  support of old version (.lm) support.");break;case"LAYASKINANI:01":var e=this._readData.__getBuffer(),t=0,n=0,i=this._readData.getUint32(),r=this._readData.getUint32(),a=new Float32Array(e.slice(i+this._DATA.offset,i+this._DATA.offset+r));for(this.mesh._bindPoses=[],t=0,n=a.length;t<n;t+=16){var s=new Ke(a[t+0],a[t+1],a[t+2],a[t+3],a[t+4],a[t+5],a[t+6],a[t+7],a[t+8],a[t+9],a[t+10],a[t+11],a[t+12],a[t+13],a[t+14],a[t+15]);this.mesh._bindPoses.push(s)}var o=this._readData.getUint32(),l=this._readData.getUint32(),h=new Float32Array(e.slice(o+this._DATA.offset,o+this._DATA.offset+l));for(this.mesh._inverseBindPoses=[],t=0,n=h.length;t<n;t+=16){var u=new Ke(h[t+0],h[t+1],h[t+2],h[t+3],h[t+4],h[t+5],h[t+6],h[t+7],h[t+8],h[t+9],h[t+10],h[t+11],h[t+12],h[t+13],h[t+14],h[t+15]);this.mesh._inverseBindPoses.push(u)}break;default:throw new Error("LoadModel:unknown version.")}return!0},t.READ_SUBMESH=function(){var t=(this._readString(),this._readData.getUint8(),this._readString());this._shaderAttributes=t.match(e._attrReg);var n=this._readData.getUint32(),i=this._readData.getUint32(),r=(this._readData.getUint32(),this._readData.getUint32(),this._readData.getUint32()),a=this._readData.getUint32(),s=this._readData.getUint32(),o=this._readData.getUint32(),l=this._readData.__getBuffer(),h=new ot(this._mesh),u=this._getVertexDeclaration(),c=Zt.create(u,a/u.vertexStride,35044,!0),_=r+this._DATA.offset,d=l.slice(_,_+a);c.setData(new Float32Array(d)),h._vertexBuffer=c;for(var m=c.vertexDeclaration.getVertexElements(),f=0;f<m.length;f++)h._bufferUsage[m[f].elementUsage]=c;var p=qt.create("ushort",i/2,35044,!0),v=n+this._DATA.offset,g=l.slice(v,v+i);p.setData(new Uint16Array(g)),h._indexBuffer=p;var x=l.slice(s+this._DATA.offset,s+this._DATA.offset+o);return h._boneIndices=new Uint8Array(x),this._mesh._add(h),!0},t.READ_DATAAREA=function(){return!1},t._getVertexDeclaration=function(){for(var e=!1,t=!1,n=!1,i=!1,r=!1,a=!1,s=!1,o=!1,l=0;l<this._shaderAttributes.length;l+=8)switch(this._shaderAttributes[l]){case"POSITION":e=!0;break;case"NORMAL":t=!0;break;case"COLOR":n=!0;break;case"UV":i=!0;break;case"UV1":r=!0;break;case"BLENDWEIGHT":s=!0;break;case"BLENDINDICES":o=!0;break;case"TANGENT":a=!0}var h;return e&&t&&n&&i&&r&&s&&o&&a?h=Ve.vertexDeclaration:e&&t&&n&&i&&r&&s&&o?h=Ce.vertexDeclaration:e&&t&&i&&r&&s&&o&&a?h=Le.vertexDeclaration:e&&t&&i&&r&&s&&o?h=Pe.vertexDeclaration:e&&t&&n&&i&&s&&o&&a?h=be.vertexDeclaration:e&&t&&n&&i&&s&&o?h=Ie.vertexDeclaration:e&&t&&i&&s&&o&&a?h=Ue.vertexDeclaration:e&&t&&i&&s&&o?h=Fe.vertexDeclaration:e&&t&&n&&s&&o&&a?h=Se.vertexDeclaration:e&&t&&n&&s&&o?h=Te.vertexDeclaration:e&&t&&n&&i&&r&&a?h=Ae.vertexDeclaration:e&&t&&n&&i&&r?h=Re.vertexDeclaration:e&&t&&i&&r&&a?h=Be.vertexDeclaration:e&&t&&i&&r?h=Ne.vertexDeclaration:e&&t&&n&&i&&a?h=we.vertexDeclaration:e&&t&&n&&i?h=De.vertexDeclaration:e&&t&&i&&a?h=ze.vertexDeclaration:e&&t&&i?h=Oe.vertexDeclaration:e&&t&&n&&a?h=ye.vertexDeclaration:e&&t&&n&&(h=Me.vertexDeclaration),h},a(0,t,"mesh",function(){return this._mesh}),e._attrReg=new RegExp("(\\w+)|([:,;])","g"),e}(),ke=function(){function e(e,t,n,i,r){this._version=null,this._mesh=null,this._decIDToVertexDeclaration=null,this._decIDToVertexbufferData=null,this._decIDToSubMesh=null,this._strings=["BLOCK","DATA","STRINGS"],this._materials=null,this._materialMap=null,this._readData=null,this._BLOCK={count:0},this._DATA={offset:0,size:0},this._STRINGS={offset:0,size:0},this._shaderAttributes=null,this._decIDToVertexDeclaration={},this._decIDToVertexbufferData={},this._decIDToSubMesh={},this._mesh=n,this._materials=i,this._materialMap=r,this._version=t,this._onLoaded(e)}r(e,"laya.d3.loaders.LoadModelV02BETA");var t=e.prototype;return t._onLoaded=function(e){this._readData=e,this.READ_BLOCK();var t=0,n=0;for(t=0,n=this._BLOCK.count;t<n;t++){var i=this._readData.getUint16(),r=this._strings[i],a=this["READ_"+r];if(null==a)throw new Error("model file err,no this function:"+i+" "+r);if(!a.call(this))break}for(var s in this._decIDToVertexbufferData){var o=this._decIDToVertexbufferData[s],l=this._decIDToVertexDeclaration[s],h=Zt.create(l,4*o.length/l.vertexStride,35044,!0);h.setData(o);var u=this._decIDToSubMesh[s];for(t=0,n=u.length;t<n;t++)u[t]._vertexBuffer=h}return this._mesh},t.onError=function(){},t._readString=function(){return this._strings[this._readData.getUint16()]},t.READ_BLOCK=function(){this._readData.getUint16();return this._BLOCK.count=this._readData.getUint16(),!0},t.READ_DATA=function(){return this._DATA.offset=this._readData.getUint32(),this._DATA.size=this._readData.getUint32(),!0},t.READ_STRINGS=function(){this._STRINGS.offset=this._readData.getUint16(),this._STRINGS.size=this._readData.getUint16();var e=this._readData.pos;this._readData.pos=this._STRINGS.offset+this._DATA.offset;for(var t=0;t<this._STRINGS.size;t++)this._strings[t]=this._readData.readUTFString();return this._readData.pos=e,!0},t.READ_MATERIAL=function(){var e=this._readData.getUint16(),t=(this._readString(),this._readString());return this._materials[e]="null"!==t?x.getRes(this._materialMap[t]):new Dt,!0},t.READ_MESH=function(){this._readString();switch(this._version){case"LAYAMODEL:01":
console.log("Warning: The (.lm) file is converted by old fbxTools,please reConverted it use  lastest fbxTools version,later we will remove the  support of old version (.lm) support.");break;case"LAYASKINANI:01":case"LAYAMODEL:02":var e=this._readData.__getBuffer(),t=0,n=0,i=this._readData.getUint32(),r=this._readData.getUint32(),a=new Float32Array(e.slice(i+this._DATA.offset,i+this._DATA.offset+r));for(this.mesh._bindPoses=[],t=0,n=a.length;t<n;t+=16){var s=new Ke(a[t+0],a[t+1],a[t+2],a[t+3],a[t+4],a[t+5],a[t+6],a[t+7],a[t+8],a[t+9],a[t+10],a[t+11],a[t+12],a[t+13],a[t+14],a[t+15]);this.mesh._bindPoses.push(s)}var o=this._readData.getUint32(),l=this._readData.getUint32(),h=new Float32Array(e.slice(o+this._DATA.offset,o+this._DATA.offset+l));for(this.mesh._inverseBindPoses=[],t=0,n=h.length;t<n;t+=16){var u=new Ke(h[t+0],h[t+1],h[t+2],h[t+3],h[t+4],h[t+5],h[t+6],h[t+7],h[t+8],h[t+9],h[t+10],h[t+11],h[t+12],h[t+13],h[t+14],h[t+15]);this.mesh._inverseBindPoses.push(u)}break;default:throw new Error("LoadModel:unknown version.")}return!0},t.READ_SUBMESH=function(){var t=(this._readString(),this._readData.getUint8(),this._readString());this._shaderAttributes=t.match(e._attrReg);var n=this._readData.getUint32(),i=this._readData.getUint32(),r=(this._readData.getUint32(),this._readData.getUint32(),this._readData.getUint32()),a=this._readData.getUint32(),s=this._readData.getUint32(),o=this._readData.getUint32(),l=this._readData.__getBuffer(),h=new ot(this._mesh),u=this._getVertexDeclaration(),c=r+this._DATA.offset,_=l.slice(c,c+a),d=0,m=0,f=0,p=u.id,v=this._decIDToVertexbufferData[p];if(v){d=v.byteLength/u.vertexStride;var g=new Float32Array(_),x=new Float32Array(v.length+g.length);for(m=0;m<v.length;m++)x[m]=v[m];for(m=0;m<g.length;m++)x[v.byteLength/4+m]=g[m];this._decIDToVertexbufferData[p]=x,this._decIDToSubMesh[p].push(h)}else d=0,this._decIDToVertexbufferData[p]=new Float32Array(_),this._decIDToVertexDeclaration[p]=u,this._decIDToSubMesh[p]=[],this._decIDToSubMesh[p].push(h);var E=(u.getVertexElements(),qt.create("ushort",i/2,35044,!0)),M=n+this._DATA.offset,T=l.slice(M,M+i),S=new Uint16Array(T);for(m=0,f=S.length;m<f;m++)S[m]=d+S[m];E.setData(S),h._indexBuffer=E;var y=l.slice(s+this._DATA.offset,s+this._DATA.offset+o);return h._boneIndices=new Uint8Array(y),this._mesh._add(h),!0},t.READ_DATAAREA=function(){return!1},t._getVertexDeclaration=function(){for(var e=!1,t=!1,n=!1,i=!1,r=!1,a=!1,s=!1,o=!1,l=!1,h=0;h<this._shaderAttributes.length;h+=8)switch(this._shaderAttributes[h]){case"POSITION":e=!0;break;case"NORMAL":t=!0;break;case"COLOR":n=!0;break;case"UV":i=!0;break;case"UV1":r=!0;break;case"BLENDWEIGHT":s=!0;break;case"BLENDINDICES":o=!0;break;case"TANGENT":a=!0;break;case"BINORMAL":l=!0}var u;return e&&t&&n&&i&&r&&s&&o&&a?u=Ve.vertexDeclaration:e&&t&&n&&i&&r&&s&&o?u=Ce.vertexDeclaration:e&&t&&i&&r&&s&&o&&a?u=Le.vertexDeclaration:e&&t&&i&&r&&s&&o?u=Pe.vertexDeclaration:e&&t&&n&&i&&s&&o&&a?u=be.vertexDeclaration:e&&t&&n&&i&&s&&o?u=Ie.vertexDeclaration:e&&t&&i&&s&&o&&a?u=Ue.vertexDeclaration:e&&t&&i&&s&&o?u=Fe.vertexDeclaration:e&&t&&n&&s&&o&&a?u=Se.vertexDeclaration:e&&t&&n&&s&&o?u=Te.vertexDeclaration:e&&t&&n&&i&&r&&a?u=Ae.vertexDeclaration:e&&t&&n&&i&&r?u=Re.vertexDeclaration:e&&t&&i&&r&&a?u=Be.vertexDeclaration:e&&t&&i&&r?u=Ne.vertexDeclaration:e&&t&&n&&i&&a?u=we.vertexDeclaration:e&&t&&i&&a&&l?u=He.vertexDeclaration:e&&t&&n&&i?u=De.vertexDeclaration:e&&t&&i&&a?u=ze.vertexDeclaration:e&&t&&i?u=Oe.vertexDeclaration:e&&t&&n&&a?u=ye.vertexDeclaration:e&&t&&n&&(u=Me.vertexDeclaration),u},a(0,t,"mesh",function(){return this._mesh}),e._attrReg=new RegExp("(\\w+)|([:,;])","g"),e}(),je=function(){function e(){}return r(e,"laya.d3.loaders.MeshReader"),e.read=function(t,n,i,r){var a=new d(t);a.pos=0;var s=a.readUTFString();switch(s){case"LAYAMODEL:01":case"LAYASKINANI:01":e._readVersion01(a,s,n,i,r);break;case"LAYAMODEL:02":e._readVersion02(a,s,n,i,r);break;default:throw new Error("MeshReader: unknown mesh version.")}},e._readVersion01=function(e,t,n,i,r){new Ge(e,t,n,i,r)},e._readVersion02=function(e,t,n,i,r){new ke(e,t,n,i,r)},e}(),Ye=function(){function e(e,t){this.min=null,this.max=null,this.min=e,this.max=t}r(e,"laya.d3.math.BoundBox");var t=e.prototype;return n.imps(t,{"laya.d3.core.IClone":!0}),t.getCorners=function(e){e.length=8;var t=this.min.elements,n=this.max.elements,i=t[0],r=t[1],a=t[2],s=n[0],o=n[1],l=n[2];e[0]=new rt(i,o,l),e[1]=new rt(s,o,l),e[2]=new rt(s,r,l),e[3]=new rt(i,r,l),e[4]=new rt(i,o,a),e[5]=new rt(s,o,a),e[6]=new rt(s,r,a),e[7]=new rt(i,r,a)},t.toDefault=function(){this.min.toDefault(),this.max.toDefault()},t.cloneTo=function(e){var t=e;this.min.cloneTo(t.min),this.max.cloneTo(t.max)},t.clone=function(){var e=new this.constructor;return this.cloneTo(e),e},e.createfromPoints=function(e,t){if(null==e)throw new Error("points");var n=t.min,i=t.max,r=n.elements;r[0]=Number.MAX_VALUE,r[1]=Number.MAX_VALUE,r[2]=Number.MAX_VALUE;var a=i.elements;a[0]=-Number.MAX_VALUE,a[1]=-Number.MAX_VALUE,a[2]=-Number.MAX_VALUE;for(var s=0,o=e.length;s<o;++s)rt.min(n,e[s],n),rt.max(i,e[s],i)},e.merge=function(e,t,n){rt.min(e.min,t.min,n.min),rt.max(e.max,t.max,n.max)},e}(),We=function(){function e(t){this._matrix=null,this._near=null,this._far=null,this._left=null,this._right=null,this._top=null,this._bottom=null,this._matrix=t,this._near=new Je(new rt),this._far=new Je(new rt),this._left=new Je(new rt),this._right=new Je(new rt),this._top=new Je(new rt),this._bottom=new Je(new rt),e._getPlanesFromMatrix(this._matrix,this._near,this._far,this._left,this._right,this._top,this._bottom)}r(e,"laya.d3.math.BoundFrustum");var t=e.prototype;return t.equalsBoundFrustum=function(e){return this._matrix.equalsOtherMatrix(e.matrix)},t.equalsObj=function(e){if(e instanceof laya.d3.math.BoundFrustum){var t=e;return this.equalsBoundFrustum(t)}return!1},t.getPlane=function(e){switch(e){case 0:return this._near;case 1:return this._far;case 2:return this._left;case 3:return this._right;case 4:return this._top;case 5:return this._bottom;default:return null}},t.getCorners=function(t){e._get3PlaneInterPoint(this._near,this._bottom,this._right).cloneTo(t[0]),e._get3PlaneInterPoint(this._near,this._top,this._right).cloneTo(t[1]),e._get3PlaneInterPoint(this._near,this._top,this._left).cloneTo(t[2]),e._get3PlaneInterPoint(this._near,this._bottom,this._left).cloneTo(t[3]),e._get3PlaneInterPoint(this._far,this._bottom,this._right).cloneTo(t[4]),e._get3PlaneInterPoint(this._far,this._top,this._right).cloneTo(t[5]),e._get3PlaneInterPoint(this._far,this._top,this._left).cloneTo(t[6]),e._get3PlaneInterPoint(this._far,this._bottom,this._left).cloneTo(t[7])},t.containsPoint=function(e){for(var t=Je.PlaneIntersectionType_Front,n=Je.PlaneIntersectionType_Front,i=0;i<6;i++){switch(i){case 0:n=qe.intersectsPlaneAndPoint(this._near,e);break;case 1:n=qe.intersectsPlaneAndPoint(this._far,e);break;case 2:n=qe.intersectsPlaneAndPoint(this._left,e);break;case 3:n=qe.intersectsPlaneAndPoint(this._right,e);break;case 4:n=qe.intersectsPlaneAndPoint(this._top,e);break;case 5:n=qe.intersectsPlaneAndPoint(this._bottom,e)}switch(n){case Je.PlaneIntersectionType_Back:return 0;case Je.PlaneIntersectionType_Intersecting:t=Je.PlaneIntersectionType_Intersecting}}switch(t){case Je.PlaneIntersectionType_Intersecting:return 2;default:return 1}},t.containsBoundBox=function(t){for(var n,i=e._tempV30,r=e._tempV31,a=1,s=0;s<6;s++){if(n=this.getPlane(s),this._getBoxToPlanePVertexNVertex(t,n.normal,i,r),qe.intersectsPlaneAndPoint(n,i)===Je.PlaneIntersectionType_Back)return 0;qe.intersectsPlaneAndPoint(n,r)===Je.PlaneIntersectionType_Back&&(a=2)}return a},t.containsBoundSphere=function(e){for(var t=Je.PlaneIntersectionType_Front,n=Je.PlaneIntersectionType_Front,i=0;i<6;i++){switch(i){case 0:n=qe.intersectsPlaneAndSphere(this._near,e);break;case 1:n=qe.intersectsPlaneAndSphere(this._far,e);break;case 2:n=qe.intersectsPlaneAndSphere(this._left,e);break;case 3:n=qe.intersectsPlaneAndSphere(this._right,e);break;case 4:n=qe.intersectsPlaneAndSphere(this._top,e);break;case 5:n=qe.intersectsPlaneAndSphere(this._bottom,e)}switch(n){case Je.PlaneIntersectionType_Back:return 0;case Je.PlaneIntersectionType_Intersecting:t=Je.PlaneIntersectionType_Intersecting}}switch(t){case Je.PlaneIntersectionType_Intersecting:return 2;default:return 1}},t._getBoxToPlanePVertexNVertex=function(e,t,n,i){var r=e.min,a=r.elements,s=e.max,o=s.elements,l=t.elements,h=l[0],u=l[1],c=l[2];r.cloneTo(n);var _=n.elements;h>=0&&(_[0]=o[0]),u>=0&&(_[1]=o[1]),c>=0&&(_[2]=o[2]),s.cloneTo(i);var d=i.elements;h>=0&&(d[0]=a[0]),u>=0&&(d[1]=a[1]),c>=0&&(d[2]=a[2])},a(0,t,"top",function(){return this._top}),a(0,t,"matrix",function(){return this._matrix},function(t){this._matrix=t,e._getPlanesFromMatrix(this._matrix,this._near,this._far,this._left,this._right,this._top,this._bottom)}),a(0,t,"near",function(){return this._near}),a(0,t,"far",function(){return this._far}),a(0,t,"left",function(){return this._left}),a(0,t,"right",function(){return this._right}),a(0,t,"bottom",function(){return this._bottom}),e._getPlanesFromMatrix=function(e,t,n,i,r,a,s){var o=e.elements,l=o[0],h=o[1],u=o[2],c=o[3],_=o[4],d=o[5],m=o[6],f=o[7],p=o[8],v=o[9],g=o[10],x=o[11],E=o[12],M=o[13],T=o[14],S=o[15],y=t.normal.elements;y[0]=u,y[1]=m,y[2]=g,t.distance=T,t.normalize();var D=n.normal.elements;D[0]=c-u,D[1]=f-m,D[2]=x-g,n.distance=S-T,n.normalize();var R=i.normal.elements;R[0]=c+l,R[1]=f+_,R[2]=x+p,i.distance=S+E,i.normalize();var C=r.normal.elements;C[0]=c-l,C[1]=f-_,C[2]=x-p,r.distance=S-E,r.normalize();var V=a.normal.elements;V[0]=c-h,V[1]=f-d,V[2]=x-v,a.distance=S-M,a.normalize();var A=s.normal.elements;A[0]=c+h,A[1]=f+d,A[2]=x+v,s.distance=S+M,s.normalize()},e._get3PlaneInterPoint=function(t,n,i){var r=t.normal,a=n.normal,s=i.normal;rt.cross(a,s,e._tempV30),rt.cross(s,r,e._tempV31),rt.cross(r,a,e._tempV32);var o=rt.dot(r,e._tempV30),l=rt.dot(a,e._tempV31),h=rt.dot(s,e._tempV32);return rt.scale(e._tempV30,-t.distance/o,e._tempV33),rt.scale(e._tempV31,-n.distance/l,e._tempV34),rt.scale(e._tempV32,-i.distance/h,e._tempV35),rt.add(e._tempV33,e._tempV34,e._tempV36),rt.add(e._tempV35,e._tempV36,e._tempV37),e._tempV37},i(e,["_tempV30",function(){return this._tempV30=new rt},"_tempV31",function(){return this._tempV31=new rt},"_tempV32",function(){return this._tempV32=new rt},"_tempV33",function(){return this._tempV33=new rt},"_tempV34",function(){return this._tempV34=new rt},"_tempV35",function(){return this._tempV35=new rt},"_tempV36",function(){return this._tempV36=new rt},"_tempV37",function(){return this._tempV37=new rt}]),e}(),Xe=function(){function e(e,t){this.center=null,this.radius=NaN,this.center=e,this.radius=t}r(e,"laya.d3.math.BoundSphere");var t=e.prototype;return n.imps(t,{"laya.d3.core.IClone":!0}),t.toDefault=function(){this.center.toDefault(),this.radius=0},t.intersectsRayDistance=function(e){return qe.intersectsRayAndSphereRD(e,this)},t.intersectsRayPoint=function(e,t){return qe.intersectsRayAndSphereRP(e,this,t)},t.cloneTo=function(e){var t=e;this.center.cloneTo(t.center),t.radius=this.radius},t.clone=function(){var e=new this.constructor;return this.cloneTo(e),e},e.createFromSubPoints=function(t,n,i,r){if(null==t)throw new Error("points");if(n<0||n>=t.length)throw new Error("start"+n+"Must be in the range [0, "+(t.length-1)+"]");if(i<0||n+i>t.length)throw new Error("count"+i+"Must be in the range <= "+t.length+"}");var a=n+i,s=e._tempVector3;s.elements[0]=0,s.elements[1]=0,s.elements[2]=0;for(var o=n;o<a;++o)rt.add(t[o],s,s);var l=r.center;rt.scale(s,1/i,l);var h=0;for(o=n;o<a;++o){var u=rt.distanceSquared(l,t[o]);u>h&&(h=u)}r.radius=Math.sqrt(h)},e.createfromPoints=function(t,n){if(null==t)throw new Error("points");e.createFromSubPoints(t,0,t.length,n)},i(e,["_tempVector3",function(){return this._tempVector3=new rt}]),e}(),qe=function(){function e(){}return r(e,"laya.d3.math.Collision"),e.distancePlaneToPoint=function(e,t){return rt.dot(e.normal,t)-e.distance},e.distanceBoxToPoint=function(e,t){var n=e.min.elements,i=n[0],r=n[1],a=n[2],s=e.max.elements,o=s[0],l=s[1],h=s[2],u=t.elements,c=u[0],_=u[1],d=u[2],m=0;return c<i&&(m+=(i-c)*(i-c)),c>o&&(m+=(o-c)*(o-c)),_<r&&(m+=(r-_)*(r-_)),_>l&&(m+=(l-_)*(l-_)),d<a&&(m+=(a-d)*(a-d)),d>h&&(m+=(h-d)*(h-d)),Math.sqrt(m)},e.distanceBoxToBox=function(e,t){var n=e.min.elements,i=n[0],r=n[1],a=n[2],s=e.max.elements,o=s[0],l=s[1],h=s[2],u=t.min.elements,c=u[0],_=u[1],d=u[2],m=t.max.elements,f=m[0],p=m[1],v=m[2],g=0,x=NaN;return i>f?(x=i-f,g+=x*x):c>o&&(x=c-o,g+=x*x),r>p?(x=r-p,g+=x*x):_>l&&(x=_-l,g+=x*x),a>v?(x=a-v,g+=x*x):d>h&&(x=d-h,g+=x*x),Math.sqrt(g)},e.distanceSphereToPoint=function(e,t){var n=Math.sqrt(rt.distanceSquared(e.center,t));return n-=e.radius,Math.max(n,0)},e.distanceSphereToSphere=function(e,t){var n=Math.sqrt(rt.distanceSquared(e.center,t.center));return n-=e.radius+t.radius,Math.max(n,0)},e.intersectsRayAndTriangleRD=function(t,n,i,r,a){var s=t.origin,o=s.elements,l=o[0],h=o[1],u=o[2],c=t.direction,_=c.elements,d=_[0],m=_[1],f=_[2],p=n.elements,v=p[0],g=p[1],x=p[2],E=i.elements,M=E[0],T=E[1],S=E[2],y=r.elements,D=y[0],R=y[1],C=y[2],V=e._tempV30.elements,A=V[0],I=V[1],b=V[2];A=M-v,I=T-g,b=S-x;var w=e._tempV31.elements,O=w[0],N=w[1],P=w[2];O=D-v,N=R-g,P=C-x;var L=e._tempV32.elements,B=L[0],F=L[1],U=L[2];B=m*P-f*N,F=f*O-d*P,U=d*N-m*O;var z=A*B+I*F+b*U;if(Ze.isZero(z))return 0,!1;var H=1/z,G=e._tempV33.elements,k=G[0],j=G[1],Y=G[2];k=l-v,j=h-g,Y=u-x;var W=k*B+j*F+Y*U;if((W*=H)<0||W>1)return 0,!1;var X=e._tempV34.elements,q=X[0],Z=X[1],Q=X[2];q=j*b-Y*I,Z=Y*A-k*b,Q=k*I-j*A;var K=d*q+m*Z+f*Q;if((K*=H)<0||W+K>1)return 0,!1;var $=O*q+N*Z+P*Q;return($*=H)<0?(0,!1):($,!0)},e.intersectsRayAndTriangleRP=function(t,n,i,r,a){var s=NaN;return e.intersectsRayAndTriangleRD(t,n,i,r,s)?(rt.scale(t.direction,s,e._tempV30),rt.add(t.origin,e._tempV30,a),!0):(a=rt.ZERO,!1)},e.intersectsRayAndPoint=function(t,n){rt.subtract(t.origin,n,e._tempV30);var i=rt.dot(e._tempV30,t.direction),r=rt.dot(e._tempV30,e._tempV30)-Ze.zeroTolerance;return!(r>0&&i>0)&&!(i*i-r<0)},e.intersectsRayAndRay=function(t,n,i){var r=t.origin,a=r.elements,s=a[0],o=a[1],l=a[2],h=t.direction,u=h.elements,c=u[0],_=u[1],d=u[2],m=n.origin,f=m.elements,p=f[0],v=f[1],g=f[2],x=n.direction,E=x.elements,M=E[0],T=E[1],S=E[2];rt.cross(h,x,e._tempV30);var y=e._tempV30.elements,D=rt.scalarLength(e._tempV30);if(Ze.isZero(D)&&Ze.nearEqual(p,s)&&Ze.nearEqual(v,o)&&Ze.nearEqual(g,l))return rt.ZERO,!0;D*=D;var R=p-s,C=v-o,V=g-l,A=M,I=T,b=S,w=y[0],O=y[1],N=y[2],P=R*I*N+C*b*w+V*A*O-R*b*O-C*A*N-V*I*w;A=c,I=_,b=d;var L=P/D;rt.scale(h,L,e._tempV30),rt.scale(x,L,e._tempV31),rt.add(r,e._tempV30,e._tempV32),rt.add(m,e._tempV31,e._tempV33);var B=e._tempV32.elements,F=e._tempV33.elements;return Ze.nearEqual(F[0],B[0])&&Ze.nearEqual(F[1],B[1])&&Ze.nearEqual(F[2],B[2])?(e._tempV32,!0):(rt.ZERO,!1)},e.intersectsPlaneAndTriangle=function(t,n,i,r){var a=e.intersectsPlaneAndPoint(t,n),s=e.intersectsPlaneAndPoint(t,i),o=e.intersectsPlaneAndPoint(t,r);return a==Je.PlaneIntersectionType_Front&&s==Je.PlaneIntersectionType_Front&&o==Je.PlaneIntersectionType_Front?Je.PlaneIntersectionType_Front:a==Je.PlaneIntersectionType_Back&&s==Je.PlaneIntersectionType_Back&&o==Je.PlaneIntersectionType_Back?Je.PlaneIntersectionType_Back:Je.PlaneIntersectionType_Intersecting},e.intersectsRayAndPlaneRD=function(e,t,n){var i=t.normal,r=rt.dot(i,e.direction);if(Ze.isZero(r))return 0,!1;var a=rt.dot(i,e.origin);return!((-t.distance-a)/r<0)||(0,!1)},e.intersectsRayAndPlaneRP=function(t,n,i){var r=NaN;return e.intersectsRayAndPlaneRD(t,n,r)?(rt.scale(t.direction,r,e._tempV30),rt.add(t.origin,e._tempV30,e._tempV31),e._tempV31,!0):(rt.ZERO,!1)},e.intersectsRayAndBoxRD=function(e,t){var n=e.origin.elements,i=n[0],r=n[1],a=n[2],s=e.direction.elements,o=s[0],l=s[1],h=s[2],u=t.min.elements,c=u[0],_=u[1],d=u[2],m=t.max.elements,f=m[0],p=m[1],v=m[2],g=0,x=Ze.MaxValue;if(Ze.isZero(o)){if(i<c||i>f)return-1}else{var E=1/o,M=(c-i)*E,T=(f-i)*E;if(M>T){var S=M;M=T,T=S}if(g=Math.max(M,g),x=Math.min(T,x),g>x)return-1}if(Ze.isZero(l)){if(r<_||r>p)return-1}else{var y=1/l,D=(_-r)*y,R=(p-r)*y;if(D>R){var C=D;D=R,R=C}if(g=Math.max(D,g),x=Math.min(R,x),g>x)return-1}if(Ze.isZero(h)){if(a<d||a>v)return-1}else{var V=1/h,A=(d-a)*V,I=(v-a)*V;if(A>I){var b=A;A=I,I=b}if(g=Math.max(A,g),x=Math.min(I,x),g>x)return-1}return g},e.intersectsRayAndBoxRP=function(t,n,i){var r=e.intersectsRayAndBoxRD(t,n);return r===-1?(rt.ZERO.cloneTo(i),r):(rt.scale(t.direction,r,e._tempV30),rt.add(t.origin,e._tempV30,e._tempV31),e._tempV31.cloneTo(i),r)},e.intersectsRayAndSphereRD=function(t,n){var i=n.radius;rt.subtract(t.origin,n.center,e._tempV30);var r=rt.dot(e._tempV30,t.direction),a=rt.dot(e._tempV30,e._tempV30)-i*i;if(a>0&&r>0)return-1;var s=r*r-a;if(s<0)return-1;var o=-r-Math.sqrt(s);return o<0&&(o=0),o},e.intersectsRayAndSphereRP=function(t,n,i){var r=e.intersectsRayAndSphereRD(t,n);return r===-1?(rt.ZERO.cloneTo(i),r):(rt.scale(t.direction,r,e._tempV30),rt.add(t.origin,e._tempV30,e._tempV31),e._tempV31.cloneTo(i),r)},e.intersectsSphereAndTriangle=function(t,n,i,r){var a=t.center,s=t.radius;return e.closestPointPointTriangle(a,n,i,r,e._tempV30),rt.subtract(e._tempV30,a,e._tempV31),rt.dot(e._tempV31,e._tempV31)<=s*s},e.intersectsPlaneAndPoint=function(e,t){var n=rt.dot(e.normal,t)+e.distance;return n>0?Je.PlaneIntersectionType_Front:n<0?Je.PlaneIntersectionType_Back:Je.PlaneIntersectionType_Intersecting},e.intersectsPlaneAndPlane=function(t,n){rt.cross(t.normal,n.normal,e._tempV30);var i=rt.dot(e._tempV30,e._tempV30);return!Ze.isZero(i)},e.intersectsPlaneAndPlaneRL=function(t,n,i){var r=t.normal,a=n.normal;rt.cross(r,a,e._tempV34);var s=rt.dot(e._tempV34,e._tempV34);return!Ze.isZero(s)&&(rt.scale(a,t.distance,e._tempV30),rt.scale(r,n.distance,e._tempV31),rt.subtract(e._tempV30,e._tempV31,e._tempV32),rt.cross(e._tempV32,e._tempV34,e._tempV33),rt.normalize(e._tempV34,e._tempV34),new nt(e._tempV33,e._tempV34),!0)},e.intersectsPlaneAndBox=function(t,n){var i=t.distance,r=t.normal,a=r.elements,s=a[0],o=a[1],l=a[2],h=n.min.elements,u=h[0],c=h[1],_=h[2],d=n.max.elements,m=d[0],f=d[1],p=d[2];e._tempV30.elements[0]=s>0?u:m,e._tempV30.elements[1]=o>0?c:f,e._tempV30.elements[2]=l>0?_:p,e._tempV31.elements[0]=s>0?m:u,e._tempV31.elements[1]=o>0?f:c,e._tempV31.elements[2]=l>0?p:_;var v=rt.dot(r,e._tempV30);return v+i>0?Je.PlaneIntersectionType_Front:(v=rt.dot(r,e._tempV31),v+i<0?Je.PlaneIntersectionType_Back:Je.PlaneIntersectionType_Intersecting)},e.intersectsPlaneAndSphere=function(e,t){var n=t.radius,i=rt.dot(e.normal,t.center)+e.distance;return i>n?Je.PlaneIntersectionType_Front:i<-n?Je.PlaneIntersectionType_Back:Je.PlaneIntersectionType_Intersecting},e.intersectsBoxAndBox=function(e,t){var n=e.min.elements,i=e.max.elements,r=t.min.elements,a=t.max.elements;return!(n[0]>a[0]||r[0]>i[0])&&(!(n[1]>a[1]||r[1]>i[1])&&!(n[2]>a[2]||r[2]>i[2]))},e.intersectsBoxAndSphere=function(t,n){var i=n.center,r=n.radius;return rt.Clamp(i,t.min,t.max,e._tempV30),rt.distanceSquared(i,e._tempV30)<=r*r},e.intersectsSphereAndSphere=function(e,t){var n=e.radius+t.radius;return rt.distanceSquared(e.center,t.center)<=n*n},e.boxContainsPoint=function(e,t){var n=e.min.elements,i=e.max.elements,r=t.elements;return n[0]<=r[0]&&i[0]>=r[0]&&n[1]<=r[1]&&i[1]>=r[1]&&n[2]<=r[2]&&i[2]>=r[2]?1:0},e.boxContainsBox=function(e,t){var n=e.min.elements,i=n[0],r=n[1],a=n[2],s=e.max.elements,o=s[0],l=s[1],h=s[2],u=t.min.elements,c=u[0],_=u[1],d=u[2],m=t.max.elements,f=m[0],p=m[1],v=m[2];return o<c||i>f?0:l<_||r>p?0:h<d||a>v?0:i<=c&&f<=f&&r<=_&&p<=l&&a<=d&&v<=h?1:2},e.boxContainsSphere=function(t,n){var i=t.min,r=i.elements,a=r[0],s=r[1],o=r[2],l=t.max,h=l.elements,u=h[0],c=h[1],_=h[2],d=n.center,m=d.elements,f=m[0],p=m[1],v=m[2],g=n.radius;return rt.Clamp(d,i,l,e._tempV30),rt.distanceSquared(d,e._tempV30)>g*g?0:a+g<=f&&f<=u-g&&u-a>g&&s+g<=p&&p<=c-g&&c-s>g&&o+g<=v&&v<=_-g&&_-o>g?1:2},e.sphereContainsPoint=function(e,t){return rt.distanceSquared(t,e.center)<=e.radius*e.radius?1:0},e.sphereContainsTriangle=function(t,n,i,r){var a=e.sphereContainsPoint(t,n),s=e.sphereContainsPoint(t,i),o=e.sphereContainsPoint(t,r);return 1==a&&1==s&&1==o?1:e.intersectsSphereAndTriangle(t,n,i,r)?2:0},e.sphereContainsBox=function(t,n){var i=t.center,r=i.elements,a=r[0],s=r[1],o=r[2],l=t.radius,h=n.min,u=h.elements,c=u[0],_=u[1],d=u[2],m=n.max,f=m.elements,p=f[0],v=f[1],g=f[2],x=e._tempV30.elements;x[0],x[1],x[2];if(!e.intersectsBoxAndSphere(n,t))return 0;var E=l*l;return a-c,s-v,o-g,rt.scalarLengthSquared(e._tempV30)>E?2:(a-p,s-v,o-g,rt.scalarLengthSquared(e._tempV30)>E?2:(a-p,s-_,o-g,rt.scalarLengthSquared(e._tempV30)>E?2:(a-c,s-_,o-g,rt.scalarLengthSquared(e._tempV30)>E?2:(a-c,s-v,o-d,rt.scalarLengthSquared(e._tempV30)>E?2:(a-p,s-v,o-d,rt.scalarLengthSquared(e._tempV30)>E?2:(a-p,s-_,o-d,rt.scalarLengthSquared(e._tempV30)>E?2:(a-c,s-_,o-d,rt.scalarLengthSquared(e._tempV30)>E?2:1)))))))},e.sphereContainsSphere=function(e,t){var n=e.radius,i=t.radius,r=rt.distance(e.center,t.center);return n+i<r?0:n-i<r?2:1},e.closestPointPointTriangle=function(t,n,i,r,a){rt.subtract(i,n,e._tempV30),rt.subtract(r,n,e._tempV31),rt.subtract(t,n,e._tempV32),rt.subtract(t,i,e._tempV33),rt.subtract(t,r,e._tempV34);var s=rt.dot(e._tempV30,e._tempV32),o=rt.dot(e._tempV31,e._tempV32),l=rt.dot(e._tempV30,e._tempV33),h=rt.dot(e._tempV31,e._tempV33),u=rt.dot(e._tempV30,e._tempV34),c=rt.dot(e._tempV31,e._tempV34);if(s<=0&&o<=0)return void n.cloneTo(a);if(l>=0&&h<=l)return void i.cloneTo(a);var _=s*h-l*o;if(_<=0&&s>=0&&l<=0){var d=s/(s-l);return rt.scale(e._tempV30,d,a),void rt.add(n,a,a)}if(c>=0&&u<=c)return void r.cloneTo(a);var m=u*o-s*c;if(m<=0&&o>=0&&c<=0){var f=o/(o-c);return rt.scale(e._tempV31,f,a),void rt.add(n,a,a)}var p=l*c-u*h;if(p<=0&&h-l>=0&&u-c>=0){var v=(h-l)/(h-l+(u-c));return rt.subtract(r,i,a),rt.scale(a,v,a),void rt.add(i,a,a)}var g=1/(p+m+_),x=m*g,E=_*g;rt.scale(e._tempV30,x,e._tempV35),rt.scale(e._tempV31,E,e._tempV36),rt.add(e._tempV35,e._tempV36,a),rt.add(n,a,a)},e.closestPointPlanePoint=function(t,n,i){var r=t.normal,a=rt.dot(r,n)-t.distance;rt.scale(r,a,e._tempV30),rt.subtract(n,e._tempV30,i)},e.closestPointBoxPoint=function(t,n,i){rt.max(n,t.min,e._tempV30),rt.min(e._tempV30,t.max,i)},e.closestPointSpherePoint=function(e,t,n){var i=e.center;rt.subtract(t,i,n),rt.normalize(n,n),rt.scale(n,e.radius,n),rt.add(n,i,n)},e.closestPointSphereSphere=function(e,t,n){var i=e.center;rt.subtract(t.center,i,n),rt.normalize(n,n),rt.scale(n,e.radius,n),rt.add(n,i,n)},i(e,["_tempV30",function(){return this._tempV30=new rt},"_tempV31",function(){return this._tempV31=new rt},"_tempV32",function(){return this._tempV32=new rt},"_tempV33",function(){return this._tempV33=new rt},"_tempV34",function(){return this._tempV34=new rt},"_tempV35",function(){return this._tempV35=new rt},"_tempV36",function(){return this._tempV36=new rt}]),e}(),Ze=(function(){function e(){}r(e,"laya.d3.math.ContainmentType"),e.Disjoint=0,e.Contains=1,e.Intersects=2,e}(),function(){function e(){}return r(e,"laya.d3.math.MathUtils3D"),e.isZero=function(t){return Math.abs(t)<e.zeroTolerance},e.nearEqual=function(t,n){return!!e.isZero(t-n)},e.fastInvSqrt=function(t){return e.isZero(t)?t:1/Math.sqrt(t)},i(e,["zeroTolerance",function(){return this.zeroTolerance=1e-6},"MaxValue",function(){return this.MaxValue=3.40282347e38},"MinValue",function(){return this.MinValue=-3.40282347e38}]),e}()),Qe=function(){function e(){var e=this.elements=new Float32Array(9);e[0]=1,e[1]=0,e[2]=0,e[3]=0,e[4]=1,e[5]=0,e[6]=0,e[7]=0,e[8]=1}r(e,"laya.d3.math.Matrix3x3");var t=e.prototype;return n.imps(t,{"laya.d3.core.IClone":!0}),t.determinant=function(){var e=this.elements,t=e[0],n=e[1],i=e[2],r=e[3],a=e[4],s=e[5],o=e[6],l=e[7],h=e[8];return t*(h*a-s*l)+n*(-h*r+s*o)+i*(l*r-a*o)},t.translate=function(e,t){var n=t.elements,i=this.elements,r=e.elements,a=i[0],s=i[1],o=i[2],l=i[3],h=i[4],u=i[5],c=i[6],_=i[7],d=i[8],m=r[0],f=r[1];n[0]=a,n[1]=s,n[2]=o,n[3]=l,n[4]=h,n[5]=u,n[6]=m*a+f*l+c,n[7]=m*s+f*h+_,n[8]=m*o+f*u+d},t.rotate=function(e,t){var n=t.elements,i=this.elements,r=i[0],a=i[1],s=i[2],o=i[3],l=i[4],h=i[5],u=i[6],c=i[7],_=i[8],d=Math.sin(e),m=Math.cos(e);n[0]=m*r+d*o,n[1]=m*a+d*l,n[2]=m*s+d*h,n[3]=m*o-d*r,n[4]=m*l-d*a,n[5]=m*h-d*s,n[6]=u,n[7]=c,n[8]=_},t.scale=function(e,t){var n=t.elements,i=this.elements,r=e.elements,a=r[0],s=r[1];n[0]=a*i[0],n[1]=a*i[1],n[2]=a*i[2],n[3]=s*i[3],n[4]=s*i[4],n[5]=s*i[5],n[6]=i[6],n[7]=i[7],n[8]=i[8]},t.invert=function(e){var t=e.elements,n=this.elements,i=n[0],r=n[1],a=n[2],s=n[3],o=n[4],l=n[5],h=n[6],u=n[7],c=n[8],_=c*o-l*u,d=-c*s+l*h,m=u*s-o*h,f=i*_+r*d+a*m;f||(e=null),f=1/f,t[0]=_*f,t[1]=(-c*r+a*u)*f,t[2]=(l*r-a*o)*f,t[3]=d*f,t[4]=(c*i-a*h)*f,t[5]=(-l*i+a*s)*f,t[6]=m*f,t[7]=(-u*i+r*h)*f,t[8]=(o*i-r*s)*f},t.transpose=function(e){var t=e.elements,n=this.elements;if(e===this){var i=n[1],r=n[2],a=n[5];t[1]=n[3],t[2]=n[6],t[3]=i,t[5]=n[7],t[6]=r,t[7]=a}else t[0]=n[0],t[1]=n[3],t[2]=n[6],t[3]=n[1],t[4]=n[4],t[5]=n[7],t[6]=n[2],t[7]=n[5],t[8]=n[8]},t.identity=function(){var e=this.elements;e[0]=1,e[1]=0,e[2]=0,e[3]=0,e[4]=1,e[5]=0,e[6]=0,e[7]=0,e[8]=1},t.cloneTo=function(e){var t,n,i;if(n=this.elements,i=e.elements,n!==i)for(t=0;t<9;++t)i[t]=n[t]},t.clone=function(){var e=new this.constructor;return this.cloneTo(e),e},e.createFromTranslation=function(e,t){var n=(t.elements,e.elements);t[0]=1,t[1]=0,t[2]=0,t[3]=0,t[4]=1,t[5]=0,t[6]=n[0],t[7]=n[1],t[8]=1},e.createFromRotation=function(e,t){var n=t.elements,i=Math.sin(e),r=Math.cos(e);n[0]=r,n[1]=i,n[2]=0,n[3]=-i,n[4]=r,n[5]=0,n[6]=0,n[7]=0,n[8]=1},e.createFromScaling=function(e,t){var n=t.elements,i=e.elements;n[0]=i[0],n[1]=0,n[2]=0,n[3]=0,n[4]=i[1],n[5]=0,n[6]=0,n[7]=0,n[8]=1},e.createFromMatrix4x4=function(e,t){t[0]=e[0],t[1]=e[1],t[2]=e[2],t[3]=e[4],t[4]=e[5],t[5]=e[6],t[6]=e[8],t[7]=e[9],t[8]=e[10]},e.multiply=function(e,t,n){var i=n.elements,r=e.elements,a=t.elements,s=r[0],o=r[1],l=r[2],h=r[3],u=r[4],c=r[5],_=r[6],d=r[7],m=r[8],f=a[0],p=a[1],v=a[2],g=a[3],x=a[4],E=a[5],M=a[6],T=a[7],S=a[8];i[0]=f*s+p*h+v*_,i[1]=f*o+p*u+v*d,i[2]=f*l+p*c+v*m,i[3]=g*s+x*h+E*_,i[4]=g*o+x*u+E*d,i[5]=g*l+x*c+E*m,i[6]=M*s+T*h+S*_,i[7]=M*o+T*u+S*d,i[8]=M*l+T*c+S*m},e.lookAt=function(t,n,i,r){rt.subtract(t,n,e._tempV30),rt.normalize(e._tempV30,e._tempV30),rt.cross(i,e._tempV30,e._tempV31),rt.normalize(e._tempV31,e._tempV31),rt.cross(e._tempV30,e._tempV31,e._tempV32);var a=e._tempV30.elements,s=e._tempV31.elements,o=e._tempV32.elements,l=r.elements;l[0]=s[0],l[1]=s[1],l[2]=s[2],l[3]=o[0],l[4]=o[1],l[5]=o[2],l[6]=a[0],l[7]=a[1],l[8]=a[2]},e.DEFAULT=new e,i(e,["_tempV30",function(){return this._tempV30=new rt},"_tempV31",function(){return this._tempV31=new rt},"_tempV32",function(){return this._tempV32=new rt}]),e}(),Ke=function(){function e(e,t,n,i,r,a,s,o,l,h,u,c,_,d,m,f){void 0===e&&(e=1),void 0===t&&(t=0),void 0===n&&(n=0),void 0===i&&(i=0),void 0===r&&(r=0),void 0===a&&(a=1),void 0===s&&(s=0),void 0===o&&(o=0),void 0===l&&(l=0),void 0===h&&(h=0),void 0===u&&(u=1),void 0===c&&(c=0),void 0===_&&(_=0),void 0===d&&(d=0),void 0===m&&(m=0),void 0===f&&(f=1);var p=this.elements=new Float32Array(16);p[0]=e,p[1]=t,p[2]=n,p[3]=i,p[4]=r,p[5]=a,p[6]=s,p[7]=o,p[8]=l,p[9]=h,p[10]=u,p[11]=c,p[12]=_,p[13]=d,p[14]=m,p[15]=f}r(e,"laya.d3.math.Matrix4x4");var t=e.prototype;return n.imps(t,{"laya.d3.core.IClone":!0}),t.getElementByRowColumn=function(e,t){if(e<0||e>3)throw new Error("row","Rows and columns for matrices run from 0 to 3, inclusive.");if(t<0||t>3)throw new Error("column","Rows and columns for matrices run from 0 to 3, inclusive.");return this.elements[4*e+t]},t.setElementByRowColumn=function(e,t,n){if(e<0||e>3)throw new Error("row","Rows and columns for matrices run from 0 to 3, inclusive.");if(t<0||t>3)throw new Error("column","Rows and columns for matrices run from 0 to 3, inclusive.");this.elements[4*e+t]=n},t.equalsOtherMatrix=function(e){var t=this.elements,n=e.elements;return Ze.nearEqual(t[0],n[0])&&Ze.nearEqual(t[1],n[1])&&Ze.nearEqual(t[2],n[2])&&Ze.nearEqual(t[3],n[3])&&Ze.nearEqual(t[4],n[4])&&Ze.nearEqual(t[5],n[5])&&Ze.nearEqual(t[6],n[6])&&Ze.nearEqual(t[7],n[7])&&Ze.nearEqual(t[8],n[8])&&Ze.nearEqual(t[9],n[9])&&Ze.nearEqual(t[10],n[10])&&Ze.nearEqual(t[11],n[11])&&Ze.nearEqual(t[12],n[12])&&Ze.nearEqual(t[13],n[13])&&Ze.nearEqual(t[14],n[14])&&Ze.nearEqual(t[15],n[15])},t.decomposeTransRotScale=function(t,n,i){var r=e._tempMatrix4x4;return this.decomposeTransRotMatScale(t,r,i)?(et.createFromMatrix4x4(r,n),!0):(n.identity(),!1)},t.decomposeTransRotMatScale=function(t,n,i){var r=this.elements,a=t.elements,s=n.elements,o=i.elements;a[0]=r[12],a[1]=r[13],a[2]=r[14];var l=r[0],h=r[1],u=r[2],c=r[4],_=r[5],d=r[6],m=r[8],f=r[9],p=r[10],v=o[0]=Math.sqrt(l*l+h*h+u*u),g=o[1]=Math.sqrt(c*c+_*_+d*d),x=o[2]=Math.sqrt(m*m+f*f+p*p);if(Ze.isZero(v)||Ze.isZero(g)||Ze.isZero(x))return s[1]=s[2]=s[3]=s[4]=s[6]=s[7]=s[8]=s[9]=s[11]=s[12]=s[13]=s[14]=0,s[0]=s[5]=s[10]=s[15]=1,!1;var E=e._tempVector0,M=E.elements;M[0]=m/x,M[1]=f/x,M[2]=p/x;var T=e._tempVector1,S=T.elements;S[0]=l/v,S[1]=h/v,S[2]=u/v;var y=e._tempVector2;rt.cross(E,T,y);var D=e._tempVector1;return rt.cross(y,E,D),s[3]=s[7]=s[11]=s[12]=s[13]=s[14]=0,s[15]=1,s[0]=D.x,s[1]=D.y,s[2]=D.z,s[4]=y.x,s[5]=y.y,s[6]=y.z,s[8]=E.x,s[9]=E.y,s[10]=E.z,s[0]*l+s[1]*h+s[2]*u<0&&(o[0]=-v),s[4]*c+s[5]*_+s[6]*d<0&&(o[1]=-g),s[8]*m+s[9]*f+s[10]*p<0&&(o[2]=-x),!0},t.normalize=function(){var e=this.elements,t=e[0],n=e[1],i=e[2],r=Math.sqrt(t*t+n*n+i*i);if(!r)return e[0]=0,e[1]=0,void(e[2]=0);1!=r&&(r=1/r,e[0]=t*r,e[1]=n*r,e[2]=i*r)},t.transpose=function(){var e,t;return e=this.elements,t=e[1],e[1]=e[4],e[4]=t,t=e[2],e[2]=e[8],e[8]=t,t=e[3],e[3]=e[12],e[12]=t,t=e[6],e[6]=e[9],e[9]=t,t=e[7],e[7]=e[13],e[13]=t,t=e[11],e[11]=e[14],e[14]=t,this},t.invert=function(e){var t=this.elements,n=e.elements,i=t[0],r=t[1],a=t[2],s=t[3],o=t[4],l=t[5],h=t[6],u=t[7],c=t[8],_=t[9],d=t[10],m=t[11],f=t[12],p=t[13],v=t[14],g=t[15],x=i*l-r*o,E=i*h-a*o,M=i*u-s*o,T=r*h-a*l,S=r*u-s*l,y=a*u-s*h,D=c*p-_*f,R=c*v-d*f,C=c*g-m*f,V=_*v-d*p,A=_*g-m*p,I=d*g-m*v,b=x*I-E*A+M*V+T*C-S*R+y*D;0!==Math.abs(b)&&(b=1/b,n[0]=(l*I-h*A+u*V)*b,n[1]=(a*A-r*I-s*V)*b,n[2]=(p*y-v*S+g*T)*b,n[3]=(d*S-_*y-m*T)*b,n[4]=(h*C-o*I-u*R)*b,n[5]=(i*I-a*C+s*R)*b,n[6]=(v*M-f*y-g*E)*b,n[7]=(c*y-d*M+m*E)*b,n[8]=(o*A-l*C+u*D)*b,n[9]=(r*C-i*A-s*D)*b,n[10]=(f*S-p*M+g*x)*b,n[11]=(_*M-c*S-m*x)*b,n[12]=(l*R-o*V-h*D)*b,n[13]=(i*V-r*R+a*D)*b,n[14]=(p*E-f*T-v*x)*b,n[15]=(c*T-_*E+d*x)*b)},t.identity=function(){var e=this.elements;e[1]=e[2]=e[3]=e[4]=e[6]=e[7]=e[8]=e[9]=e[11]=e[12]=e[13]=e[14]=0,e[0]=e[5]=e[10]=e[15]=1},t.cloneTo=function(e){var t,n,i;if(n=this.elements,i=e.elements,n!==i)for(t=0;t<16;++t)i[t]=n[t]},t.clone=function(){var e=new this.constructor;return this.cloneTo(e),e},t.getTranslationVector=function(e){var t=this.elements,n=e.elements;n[0]=t[12],n[1]=t[13],n[2]=t[14]},t.setTranslationVector=function(e){var t=this.elements,n=e.elements;t[12]=n[0],t[13]=n[1],t[14]=n[2]},e.createRotationX=function(e,t){var n=t.elements,i=Math.sin(e),r=Math.cos(e);n[1]=n[2]=n[3]=n[4]=n[7]=n[8]=n[11]=n[12]=n[13]=n[14]=0,n[0]=n[15]=1,n[5]=n[10]=r,n[6]=i,n[9]=-i},e.createRotationY=function(e,t){var n=t.elements,i=Math.sin(e),r=Math.cos(e);n[1]=n[3]=n[4]=n[6]=n[7]=n[9]=n[11]=n[12]=n[13]=n[14]=0,n[5]=n[15]=1,n[0]=n[10]=r,n[2]=-i,n[8]=i},e.createRotationZ=function(e,t){var n=t.elements,i=Math.sin(e),r=Math.cos(e);n[2]=n[3]=n[6]=n[7]=n[8]=n[9]=n[11]=n[12]=n[13]=n[14]=0,n[10]=n[15]=1,n[0]=n[5]=r,n[1]=i,n[4]=-i},e.createRotationYawPitchRoll=function(t,n,i,r){et.createFromYawPitchRoll(t,n,i,e._tempQuaternion),e.createRotationQuaternion(e._tempQuaternion,r)},e.createRotationQuaternion=function(e,t){var n=e.elements,i=t.elements,r=n[0],a=n[1],s=n[2],o=n[3],l=r*r,h=a*a,u=s*s,c=r*a,_=s*o,d=s*r,m=a*o,f=a*s,p=r*o;i[3]=i[7]=i[11]=i[12]=i[13]=i[14]=0,i[15]=1,i[0]=1-2*(h+u),i[1]=2*(c+_),i[2]=2*(d-m),i[4]=2*(c-_),i[5]=1-2*(u+l),i[6]=2*(f+p),i[8]=2*(d+m),i[9]=2*(f-p),i[10]=1-2*(h+l)},e.createTranslate=function(e,t){var n=e.elements,i=t.elements
;i[4]=i[8]=i[1]=i[9]=i[2]=i[6]=i[3]=i[7]=i[11]=0,i[0]=i[5]=i[10]=i[15]=1,i[12]=n[0],i[13]=n[1],i[14]=n[2]},e.createScaling=function(e,t){var n=e.elements,i=t.elements;i[0]=n[0],i[5]=n[1],i[10]=n[2],i[1]=i[4]=i[8]=i[12]=i[9]=i[13]=i[2]=i[6]=i[14]=i[3]=i[7]=i[11]=0,i[15]=1},e.multiply=function(e,t,n){var i,r,a,s,o,l,h,u;if(r=n.elements,a=e.elements,s=t.elements,r===s)for(s=new Float32Array(16),i=0;i<16;++i)s[i]=r[i];for(i=0;i<4;i++)o=a[i],l=a[i+4],h=a[i+8],u=a[i+12],r[i]=o*s[0]+l*s[1]+h*s[2]+u*s[3],r[i+4]=o*s[4]+l*s[5]+h*s[6]+u*s[7],r[i+8]=o*s[8]+l*s[9]+h*s[10]+u*s[11],r[i+12]=o*s[12]+l*s[13]+h*s[14]+u*s[15]},e.createFromQuaternion=function(e,t){var n=t.elements,i=e.elements,r=i[0],a=i[1],s=i[2],o=i[3],l=r+r,h=a+a,u=s+s,c=r*l,_=a*l,d=a*h,m=s*l,f=s*h,p=s*u,v=o*l,g=o*h,x=o*u;n[0]=1-d-p,n[1]=_+x,n[2]=m-g,n[3]=0,n[4]=_-x,n[5]=1-c-p,n[6]=f+v,n[7]=0,n[8]=m+g,n[9]=f-v,n[10]=1-c-d,n[11]=0,n[12]=0,n[13]=0,n[14]=0,t[15]=1},e.createAffineTransformation=function(e,t,n,i){var r=e.elements,a=t.elements,s=n.elements,o=i.elements,l=a[0],h=a[1],u=a[2],c=a[3],_=l+l,d=h+h,m=u+u,f=l*_,p=l*d,v=l*m,g=h*d,x=h*m,E=u*m,M=c*_,T=c*d,S=c*m,y=s[0],D=s[1],R=s[2];o[0]=(1-(g+E))*y,o[1]=(p+S)*y,o[2]=(v-T)*y,o[3]=0,o[4]=(p-S)*D,o[5]=(1-(f+E))*D,o[6]=(x+M)*D,o[7]=0,o[8]=(v+T)*R,o[9]=(x-M)*R,o[10]=(1-(f+g))*R,o[11]=0,o[12]=r[0],o[13]=r[1],o[14]=r[2],o[15]=1},e.createLookAt=function(e,t,n,i){var r,a,s,o,l,h,u,c,_,d,m=e.elements,f=t.elements,p=n.elements,v=i.elements,g=m[0],x=m[1],E=m[2],M=p[0],T=p[1],S=p[2],y=f[0],D=f[1],R=f[2];if(Math.abs(g-y)<Ze.zeroTolerance&&Math.abs(x-D)<Ze.zeroTolerance&&Math.abs(E-R)<Ze.zeroTolerance)return void i.identity();u=g-y,c=x-D,_=E-R,d=1/Math.sqrt(u*u+c*c+_*_),u*=d,c*=d,_*=d,r=T*_-S*c,a=S*u-M*_,s=M*c-T*u,d=Math.sqrt(r*r+a*a+s*s),d?(d=1/d,r*=d,a*=d,s*=d):r=a=s=0,o=c*s-_*a,l=_*r-u*s,h=u*a-c*r,d=Math.sqrt(o*o+l*l+h*h),d?(d=1/d,o*=d,l*=d,h*=d):o=l=h=0,v[0]=r,v[1]=o,v[2]=u,v[3]=0,v[4]=a,v[5]=l,v[6]=c,v[7]=0,v[8]=s,v[9]=h,v[10]=_,v[11]=0,v[12]=-(r*g+a*x+s*E),v[13]=-(o*g+l*x+h*E),v[14]=-(u*g+c*x+_*E),v[15]=1},e.createPerspective=function(e,t,n,i,r){var a=r.elements,s=1/Math.tan(.5*e),o=i/(n-i);a[0]=s/t,a[5]=s,a[10]=o,a[11]=-1,a[14]=o*n,a[1]=a[2]=a[3]=a[4]=a[6]=a[7]=a[8]=a[9]=a[12]=a[13]=a[15]=0},e.createOrthogonal=function(e,t,n,i,r,a,s){var o=s.elements,l=1/(e-t),h=1/(n-i),u=1/(r-a);o[1]=o[2]=o[3]=o[4]=o[6]=o[7]=o[8]=o[9]=o[11]=0,o[15]=1,o[0]=-2*l,o[5]=-2*h,o[10]=2*u,o[12]=(e+t)*l,o[13]=(i+n)*h,o[14]=(a+r)*u},e.translation=function(e,t){var n=e.elements,i=t.elements;i[0]=i[5]=i[10]=i[15]=1,i[12]=n[0],i[13]=n[1],i[14]=n[2]},i(e,["_tempMatrix4x4",function(){return this._tempMatrix4x4=new e},"_tempVector0",function(){return this._tempVector0=new rt},"_tempVector1",function(){return this._tempVector1=new rt},"_tempVector2",function(){return this._tempVector2=new rt},"_tempQuaternion",function(){return this._tempQuaternion=new et},"DEFAULT",function(){return this.DEFAULT=new e}]),e}(),$e=function(){function e(e,t){this.extents=null,this.transformation=null,this.extents=e,this.transformation=t}r(e,"laya.d3.math.OrientedBoundBox");var t=e.prototype;return t.getCorners=function(t){var n=this.extents.elements;t.length=8;var i=e._tempV30.elements,r=e._tempV31.elements,a=e._tempV32.elements;i[0]=n[0],i[1]=i[2]=0,r[1]=n[1],r[0]=r[2]=0,a[2]=n[2],a[0]=a[1]=0,rt.TransformNormal(e._tempV30,this.transformation,e._tempV30),rt.TransformNormal(e._tempV31,this.transformation,e._tempV31),rt.TransformNormal(e._tempV32,this.transformation,e._tempV32);var s=e._tempV33;this.transformation.getTranslationVector(s),rt.add(s,e._tempV30,e._tempV34),rt.add(e._tempV34,e._tempV31,e._tempV34),rt.add(e._tempV34,e._tempV32,t[0]),rt.add(s,e._tempV30,e._tempV34),rt.add(e._tempV34,e._tempV31,e._tempV34),rt.subtract(e._tempV34,e._tempV32,t[1]),rt.subtract(s,e._tempV30,e._tempV34),rt.add(e._tempV34,e._tempV31,e._tempV34),rt.subtract(e._tempV34,e._tempV32,t[2]),rt.subtract(s,e._tempV30,e._tempV34),rt.add(e._tempV34,e._tempV31,e._tempV34),rt.add(e._tempV34,e._tempV32,t[3]),rt.add(s,e._tempV30,e._tempV34),rt.subtract(e._tempV34,e._tempV31,e._tempV34),rt.add(e._tempV34,e._tempV32,t[4]),rt.add(s,e._tempV30,e._tempV34),rt.subtract(e._tempV34,e._tempV31,e._tempV34),rt.subtract(e._tempV34,e._tempV32,t[5]),rt.subtract(s,e._tempV30,e._tempV34),rt.subtract(e._tempV34,e._tempV31,e._tempV34),rt.subtract(e._tempV34,e._tempV32,t[6]),rt.subtract(s,e._tempV30,e._tempV34),rt.subtract(e._tempV34,e._tempV31,e._tempV34),rt.add(e._tempV34,e._tempV32,t[7])},t.transform=function(e){Ke.multiply(this.transformation,e,this.transformation)},t.scale=function(e){rt.multiply(this.extents,e,this.extents)},t.translate=function(t){this.transformation.getTranslationVector(e._tempV30),rt.add(e._tempV30,t,e._tempV31),this.transformation.setTranslationVector(e._tempV31)},t.Size=function(e){rt.scale(this.extents,2,e)},t.getSize=function(t){var n=this.extents.elements;e._tempV30.x=n[0],e._tempV31.y=n[1],e._tempV32.z=n[2],rt.TransformNormal(e._tempV30,this.transformation,e._tempV30),rt.TransformNormal(e._tempV31,this.transformation,e._tempV31),rt.TransformNormal(e._tempV31,this.transformation,e._tempV32);var i=t.elements;i[0]=rt.scalarLength(e._tempV30),i[1]=rt.scalarLength(e._tempV31),i[2]=rt.scalarLength(e._tempV32)},t.getSizeSquared=function(t){var n=this.extents.elements;e._tempV30.x=n[0],e._tempV31.y=n[1],e._tempV32.z=n[2],rt.TransformNormal(e._tempV30,this.transformation,e._tempV30),rt.TransformNormal(e._tempV31,this.transformation,e._tempV31),rt.TransformNormal(e._tempV31,this.transformation,e._tempV32);var i=t.elements;i[0]=rt.scalarLengthSquared(e._tempV30),i[1]=rt.scalarLengthSquared(e._tempV31),i[2]=rt.scalarLengthSquared(e._tempV32)},t.getCenter=function(e){this.transformation.getTranslationVector(e)},t.containsPoint=function(t){var n=this.extents.elements,i=n[0],r=n[1],a=n[2];this.transformation.invert(e._tempM0),rt.transformCoordinate(t,e._tempM0,e._tempV30);var s=e._tempV30.elements,o=Math.abs(s[0]),l=Math.abs(s[1]),h=Math.abs(s[2]);return Ze.nearEqual(o,i)&&Ze.nearEqual(l,r)&&Ze.nearEqual(h,a)?2:o<i&&l<r&&h<a?1:0},t.containsPoints=function(t){var n=this.extents.elements,i=n[0],r=n[1],a=n[2];this.transformation.invert(e._tempM0);for(var s=!0,o=!1,l=0;l<t.length;l++){rt.transformCoordinate(t[l],e._tempM0,e._tempV30);var h=e._tempV30.elements,u=Math.abs(h[0]),c=Math.abs(h[1]),_=Math.abs(h[2]);Ze.nearEqual(u,i)&&Ze.nearEqual(c,r)&&Ze.nearEqual(_,a)&&(o=!0),u<i&&c<r&&a<_?o=!0:s=!1}return s?1:o?2:0},t.containsSphere=function(t,n){void 0===n&&(n=!1);var i=this.extents.elements,r=i[0],a=i[1],s=i[2],o=t.radius;this.transformation.invert(e._tempM0),rt.transformCoordinate(t.center,e._tempM0,e._tempV30);var l=NaN;if(n?l=o:(rt.scale(rt.UnitX,o,e._tempV31),rt.TransformNormal(e._tempV31,e._tempM0,e._tempV31),l=rt.scalarLength(e._tempV31)),rt.scale(this.extents,-1,e._tempV32),rt.Clamp(e._tempV30,e._tempV32,this.extents,e._tempV33),rt.distanceSquared(e._tempV30,e._tempV33)>l*l)return 0;var h=e._tempV30.elements,u=h[0],c=h[1],_=h[2],d=e._tempV32.elements,m=d[0],f=d[1],p=d[2];return m+l<=u&&u<=r-l&&r-m>l&&f+l<=c&&c<=a-l&&a-f>l&&p+l<=_&&_<=s-l&&s-p>l?1:2},t.containsOrientedBoundBox=function(t){var n=0,i=0;t.getCorners(e._corners);var r=this.containsPoints(e._corners);if(0!=r)return r;var a=this.extents.elements;t.extents.cloneTo(e._tempV35);var s=e._tempV35.elements;e._getRows(this.transformation,e._rows1),e._getRows(t.transformation,e._rows2);var o=NaN,l=NaN,h=NaN;for(n=0;n<3;n++)for(i=0;i<3;i++)h=rt.dot(e._rows1[n],e._rows2[i]),e._tempM0.setElementByRowColumn(n,i,h),e._tempM1.setElementByRowColumn(n,i,Math.abs(h));t.getCenter(e._tempV34),this.getCenter(e._tempV36),rt.subtract(e._tempV34,e._tempV36,e._tempV30);var u=e._tempV31.elements;u[0]=rt.dot(e._tempV30,e._rows1[0]),u[1]=rt.dot(e._tempV30,e._rows1[1]),u[2]=rt.dot(e._tempV30,e._rows1[2]);var c=e._tempV32.elements,_=e._tempV33.elements;for(n=0;n<3;n++)if(c[0]=e._tempM1.getElementByRowColumn(n,0),c[1]=e._tempM1.getElementByRowColumn(n,1),c[2]=e._tempM1.getElementByRowColumn(n,2),o=a[n],l=rt.dot(e._tempV35,e._tempV32),Math.abs(u[n])>o+l)return 0;for(i=0;i<3;i++)if(c[0]=e._tempM1.getElementByRowColumn(0,i),c[1]=e._tempM1.getElementByRowColumn(1,i),c[2]=e._tempM1.getElementByRowColumn(2,i),_[0]=e._tempM0.getElementByRowColumn(0,i),_[1]=e._tempM0.getElementByRowColumn(1,i),_[2]=e._tempM0.getElementByRowColumn(2,i),o=rt.dot(this.extents,e._tempV32),l=s[i],Math.abs(rt.dot(e._tempV31,e._tempV33))>o+l)return 0;for(n=0;n<3;n++)for(i=0;i<3;i++){var d=(n+1)%3,m=(n+2)%3,f=(i+1)%3,p=(i+2)%3;if(o=a[d]*e._tempM1.getElementByRowColumn(m,i)+s[m]*e._tempM1.getElementByRowColumn(m,i),l=a[f]*e._tempM1.getElementByRowColumn(n,p)+s[p]*e._tempM1.getElementByRowColumn(n,f),Math.abs(u[m]*e._tempM0.getElementByRowColumn(d,i)-u[d]*e._tempM0.getElementByRowColumn(m,i))>o+l)return 0}return 2},t.containsLine=function(t,n){e._corners[0]=t,e._corners[1]=n;var i=this.containsPoints(e._corners);if(0!=i)return i;var r=this.extents.elements,a=r[0],s=r[1],o=r[2];this.transformation.invert(e._tempM0),rt.transformCoordinate(t,e._tempM0,e._tempV30),rt.transformCoordinate(n,e._tempM0,e._tempV31),rt.add(e._tempV30,e._tempV31,e._tempV32),rt.scale(e._tempV32,.5,e._tempV32),rt.subtract(e._tempV30,e._tempV32,e._tempV33);var l=e._tempV33.elements,h=l[0],u=l[1],c=l[2],_=e._tempV34.elements,d=_[0]=Math.abs(l[0]),m=_[1]=Math.abs(l[1]),f=_[2]=Math.abs(l[2]),p=e._tempV32.elements,v=p[0],g=p[1],x=p[2];return Math.abs(v)>a+d?0:Math.abs(g)>s+m?0:Math.abs(x)>o+f?0:Math.abs(g*c-x*u)>s*f+o*m?0:Math.abs(v*c-x*h)>a*f+o*d?0:Math.abs(v*u-g*h)>a*m+s*d?0:2},t.containsBoundBox=function(t){var n=0,i=0,r=t.min,a=t.max;t.getCorners(e._corners);var s=this.containsPoints(e._corners);if(0!=s)return s;rt.subtract(a,r,e._tempV30),rt.scale(e._tempV30,.5,e._tempV30),rt.add(r,e._tempV30,e._tempV30),rt.subtract(a,e._tempV30,e._tempV31);var o=this.extents.elements,l=e._tempV31.elements;e._getRows(this.transformation,e._rows1),this.transformation.invert(e._tempM0);var h=NaN,u=NaN;for(n=0;n<3;n++)for(i=0;i<3;i++)e._tempM1.setElementByRowColumn(n,i,Math.abs(e._tempM0.getElementByRowColumn(n,i)));this.getCenter(e._tempV35),rt.subtract(e._tempV30,e._tempV35,e._tempV32);var c=e._tempV31.elements;c[0]=rt.dot(e._tempV32,e._rows1[0]),c[1]=rt.dot(e._tempV32,e._rows1[1]),c[2]=rt.dot(e._tempV32,e._rows1[2]);var _=e._tempV33.elements,d=e._tempV34.elements;for(n=0;n<3;n++)if(_[0]=e._tempM1.getElementByRowColumn(n,0),_[1]=e._tempM1.getElementByRowColumn(n,1),_[2]=e._tempM1.getElementByRowColumn(n,2),h=o[n],u=rt.dot(e._tempV31,e._tempV33),Math.abs(c[n])>h+u)return 0;for(i=0;i<3;i++)if(_[0]=e._tempM1.getElementByRowColumn(0,i),_[1]=e._tempM1.getElementByRowColumn(1,i),_[2]=e._tempM1.getElementByRowColumn(2,i),d[0]=e._tempM0.getElementByRowColumn(0,i),d[1]=e._tempM0.getElementByRowColumn(1,i),d[2]=e._tempM0.getElementByRowColumn(2,i),h=rt.dot(this.extents,e._tempV33),u=l[i],Math.abs(rt.dot(e._tempV31,e._tempV34))>h+u)return 0;for(n=0;n<3;n++)for(i=0;i<3;i++){var m=(n+1)%3,f=(n+2)%3,p=(i+1)%3,v=(i+2)%3;if(h=o[m]*e._tempM1.getElementByRowColumn(f,i)+o[f]*e._tempM1.getElementByRowColumn(m,i),u=l[p]*e._tempM1.getElementByRowColumn(n,v)+l[v]*e._tempM1.getElementByRowColumn(n,p),Math.abs(c[f]*e._tempM0.getElementByRowColumn(m,i)-c[m]*e._tempM0.getElementByRowColumn(f,i))>h+u)return 0}return 2},t.intersectsRay=function(t,n){rt.scale(this.extents,-1,e._tempV30),this.transformation.invert(e._tempM0),rt.TransformNormal(t.direction,e._tempM0,e._ray.direction),rt.transformCoordinate(t.origin,e._tempM0,e._ray.origin),e._boxBound1.min=e._tempV30,e._boxBound1.max=this.extents;var i=qe.intersectsRayAndBoxRP(e._ray,e._boxBound1,n);return i!==-1&&rt.transformCoordinate(n,this.transformation,n),i},t._getLocalCorners=function(t){t.length=8;var n=this.extents.elements;e._tempV30.x=n[0],e._tempV31.y=n[1],e._tempV32.z=n[2],rt.add(e._tempV30,e._tempV31,e._tempV33),rt.add(e._tempV33,e._tempV32,t[0]),rt.add(e._tempV30,e._tempV31,e._tempV33),rt.subtract(e._tempV33,e._tempV32,t[1]),rt.subtract(e._tempV31,e._tempV30,e._tempV33),rt.subtract(e._tempV33,e._tempV30,t[2]),rt.subtract(e._tempV31,e._tempV30,e._tempV33),rt.add(e._tempV33,e._tempV32,t[3]),rt.subtract(e._tempV30,e._tempV31,e._tempV33),rt.add(e._tempV33,e._tempV32,t[4]),rt.subtract(e._tempV30,e._tempV31,e._tempV33),rt.subtract(e._tempV33,e._tempV32,t[5]),rt.scale(t[0],-1,t[6]),rt.subtract(e._tempV32,e._tempV30,e._tempV33),rt.subtract(e._tempV33,e._tempV31,t[7])},t.equals=function(e){return this.extents==e.extents&&this.transformation==e.transformation},t.cloneTo=function(e){var t=e;this.extents.cloneTo(t.extents),this.transformation.cloneTo(t.transformation)},e.createByBoundBox=function(t,n){var i=t.min,r=t.max;rt.subtract(r,i,e._tempV30),rt.scale(e._tempV30,.5,e._tempV30),rt.add(i,e._tempV30,e._tempV31),rt.subtract(r,e._tempV31,e._tempV32),Ke.translation(e._tempV31,e._tempM0);var a=e._tempV32.clone(),s=e._tempM0.clone();n.extents=a,n.transformation=s},e.createByMinAndMaxVertex=function(t,n){return rt.subtract(n,t,e._tempV30),rt.scale(e._tempV30,.5,e._tempV30),rt.add(t,e._tempV30,e._tempV31),rt.subtract(n,e._tempV31,e._tempV32),Ke.translation(e._tempV31,e._tempM0),new e(e._tempV32,e._tempM0)},e._getRows=function(e,t){t.length=3;var n=e.elements,i=t[0].elements;i[0]=n[0],i[1]=n[1],i[2]=n[2];var r=t[1].elements;r[0]=n[4],r[1]=n[5],r[2]=n[6];var a=t[2].elements;a[0]=n[8],a[1]=n[9],a[2]=n[10]},e.getObbtoObbMatrix4x4=function(t,n,i,r){var a=t.transformation,s=n.transformation;if(i){e._getRows(a,e._rows1),e._getRows(s,e._rows2);for(var o=0;o<3;o++)for(var l=0;l<3;l++)r.setElementByRowColumn(o,l,rt.dot(e._rows2[o],e._rows1[l]));n.getCenter(e._tempV30),t.getCenter(e._tempV31),rt.subtract(e._tempV30,e._tempV31,e._tempV32);var h=r.elements;h[12]=rt.dot(e._tempV32,e._rows1[0]),h[13]=rt.dot(e._tempV32,e._rows1[1]),h[14]=rt.dot(e._tempV32,e._rows1[2]),h[15]=1}else a.invert(e._tempM0),Ke.multiply(s,e._tempM0,r)},e.merge=function(t,n,i){var r=t.extents,a=t.transformation;e.getObbtoObbMatrix4x4(t,n,i,e._tempM0),n._getLocalCorners(e._corners),rt.transformCoordinate(e._corners[0],e._tempM0,e._corners[0]),rt.transformCoordinate(e._corners[1],e._tempM0,e._corners[1]),rt.transformCoordinate(e._corners[2],e._tempM0,e._corners[2]),rt.transformCoordinate(e._corners[3],e._tempM0,e._corners[3]),rt.transformCoordinate(e._corners[4],e._tempM0,e._corners[4]),rt.transformCoordinate(e._corners[5],e._tempM0,e._corners[5]),rt.transformCoordinate(e._corners[6],e._tempM0,e._corners[6]),rt.transformCoordinate(e._corners[7],e._tempM0,e._corners[7]),rt.scale(r,-1,e._boxBound1.min),r.cloneTo(e._boxBound1.max),Ye.createfromPoints(e._corners,e._boxBound2),Ye.merge(e._boxBound2,e._boxBound1,e._boxBound3);var s=e._boxBound3.min,o=e._boxBound3.max;rt.subtract(o,s,e._tempV30),rt.scale(e._tempV30,.5,e._tempV30),rt.add(s,e._tempV30,e._tempV32),rt.subtract(o,e._tempV32,r),rt.transformCoordinate(e._tempV32,a,e._tempV33)},e._corners=[],e._rows1=[],e._rows2=[],i(e,["_tempV30",function(){return this._tempV30=new rt},"_tempV31",function(){return this._tempV31=new rt},"_tempV32",function(){return this._tempV32=new rt},"_tempV33",function(){return this._tempV33=new rt},"_tempV34",function(){return this._tempV34=new rt},"_tempV35",function(){return this._tempV35=new rt},"_tempV36",function(){return this._tempV36=new rt},"_tempM0",function(){return this._tempM0=new Ke},"_tempM1",function(){return this._tempM1=new Ke},"_ray",function(){return this._ray=new nt(new rt,new rt)},"_boxBound1",function(){return this._boxBound1=new Ye(new rt,new rt)},"_boxBound2",function(){return this._boxBound2=new Ye(new rt,new rt)},"_boxBound3",function(){return this._boxBound3=new Ye(new rt,new rt)}]),e}(),Je=function(){function e(e,t){this.normal=null,this.distance=NaN,void 0===t&&(t=0),this.normal=e,this.distance=t}return r(e,"laya.d3.math.Plane"),e.prototype.normalize=function(){var e=this.normal.elements,t=e[0],n=e[1],i=e[2],r=1/Math.sqrt(t*t+n*n+i*i);e[0]=t*r,e[1]=n*r,e[2]=i*r,this.distance*=r},e.createPlaneBy3P=function(t,n,i){var r=t.elements,a=n.elements,s=i.elements,o=a[0]-r[0],l=a[1]-r[1],h=a[2]-r[2],u=s[0]-r[0],c=s[1]-r[1],_=s[2]-r[2],d=l*_-h*c,m=h*u-o*_,f=o*c-l*u,p=1/Math.sqrt(d*d+m*m+f*f),v=d*p,g=m*p,x=f*p,E=e._TEMPVec3.elements;E[0]=v,E[1]=g,E[2]=x;var M=-(v*r[0]+g*r[1]+x*r[2]);return new e(e._TEMPVec3,M)},e.PlaneIntersectionType_Back=0,e.PlaneIntersectionType_Front=1,e.PlaneIntersectionType_Intersecting=2,i(e,["_TEMPVec3",function(){return this._TEMPVec3=new rt}]),e}(),et=function(){function e(e,t,n,i){this.elements=new Float32Array(4),void 0===e&&(e=0),void 0===t&&(t=0),void 0===n&&(n=0),void 0===i&&(i=1),this.elements[0]=e,this.elements[1]=t,this.elements[2]=n,this.elements[3]=i}r(e,"laya.d3.math.Quaternion");var t=e.prototype;return n.imps(t,{"laya.d3.core.IClone":!0}),t.scaling=function(e,t){var n=t.elements,i=this.elements;n[0]=i[0]*e,n[1]=i[1]*e,n[2]=i[2]*e,n[3]=i[3]*e},t.normalize=function(e){var t=e.elements,n=this.elements,i=n[0],r=n[1],a=n[2],s=n[3],o=i*i+r*r+a*a+s*s;o>0&&(o=1/Math.sqrt(o),t[0]=i*o,t[1]=r*o,t[2]=a*o,t[3]=s*o)},t.length=function(){var e=this.elements,t=e[0],n=e[1],i=e[2],r=e[3];return Math.sqrt(t*t+n*n+i*i+r*r)},t.rotateX=function(e,t){var n=t.elements,i=this.elements;e*=.5;var r=i[0],a=i[1],s=i[2],o=i[3],l=Math.sin(e),h=Math.cos(e);n[0]=r*h+o*l,n[1]=a*h+s*l,n[2]=s*h-a*l,n[3]=o*h-r*l},t.rotateY=function(e,t){var n=t.elements,i=this.elements;e*=.5;var r=i[0],a=i[1],s=i[2],o=i[3],l=Math.sin(e),h=Math.cos(e);n[0]=r*h-s*l,n[1]=a*h+o*l,n[2]=s*h+r*l,n[3]=o*h-a*l},t.rotateZ=function(e,t){var n=t.elements,i=this.elements;e*=.5;var r=i[0],a=i[1],s=i[2],o=i[3],l=Math.sin(e),h=Math.cos(e);n[0]=r*h+a*l,n[1]=a*h-r*l,n[2]=s*h+o*l,n[3]=o*h-s*l},t.getYawPitchRoll=function(t){rt.transformQuat(rt.ForwardRH,this,e.TEMPVector31),rt.transformQuat(rt.Up,this,e.TEMPVector32);var n=e.TEMPVector32.elements;e.angleTo(rt.ZERO,e.TEMPVector31,e.TEMPVector33);var i=e.TEMPVector33.elements;i[0]==Math.PI/2?(i[1]=e.arcTanAngle(n[2],n[0]),i[2]=0):i[0]==-Math.PI/2?(i[1]=e.arcTanAngle(-n[2],-n[0]),i[2]=0):(Ke.createRotationY(-i[1],e.TEMPMatrix0),Ke.createRotationX(-i[0],e.TEMPMatrix1),rt.transformCoordinate(e.TEMPVector32,e.TEMPMatrix0,e.TEMPVector32),rt.transformCoordinate(e.TEMPVector32,e.TEMPMatrix1,e.TEMPVector32),i[2]=e.arcTanAngle(n[1],-n[0])),i[1]<=-Math.PI&&(i[1]=Math.PI),i[2]<=-Math.PI&&(i[2]=Math.PI),i[1]>=Math.PI&&i[2]>=Math.PI&&(i[1]=0,i[2]=0,i[0]=Math.PI-i[0]);var r=t.elements;r[0]=i[1],r[1]=i[0],r[2]=i[2]},t.invert=function(e){var t=e.elements,n=this.elements,i=n[0],r=n[1],a=n[2],s=n[3],o=i*i+r*r+a*a+s*s,l=o?1/o:0;t[0]=-i*l,t[1]=-r*l,t[2]=-a*l,t[3]=s*l},t.identity=function(){var e=this.elements;e[0]=0,e[1]=0,e[2]=0,e[3]=1},t.cloneTo=function(e){var t,n,i;if(n=this.elements,i=e.elements,n!==i)for(t=0;t<4;++t)i[t]=n[t]},t.clone=function(){var e=new this.constructor;return this.cloneTo(e),e},t.equals=function(e){var t=this.elements,n=e.elements;return Ze.nearEqual(t[0],n[0])&&Ze.nearEqual(t[1],n[1])&&Ze.nearEqual(t[2],n[2])&&Ze.nearEqual(t[3],n[3])},a(0,t,"x",function(){return this.elements[0]}),a(0,t,"y",function(){return this.elements[1]}),a(0,t,"z",function(){return this.elements[2]}),a(0,t,"w",function(){return this.elements[3]}),e.createFromYawPitchRoll=function(e,t,n,i){var r=.5*n,a=.5*t,s=.5*e,o=Math.sin(r),l=Math.cos(r),h=Math.sin(a),u=Math.cos(a),c=Math.sin(s),_=Math.cos(s),d=i.elements;d[0]=_*h*l+c*u*o,d[1]=c*u*l-_*h*o,d[2]=_*u*o-c*h*l,d[3]=_*u*l+c*h*o},e.multiply=function(e,t,n){var i=e.elements,r=t.elements,a=n.elements,s=i[0],o=i[1],l=i[2],h=i[3],u=r[0],c=r[1],_=r[2],d=r[3],m=o*_-l*c,f=l*u-s*_,p=s*c-o*u,v=s*u+o*c+l*_;a[0]=s*d+u*h+m,a[1]=o*d+c*h+f,a[2]=l*d+_*h+p,a[3]=h*d-v},e.arcTanAngle=function(e,t){return 0==e?1==t?Math.PI/2:-Math.PI/2:e>0?Math.atan(t/e):e<0?t>0?Math.atan(t/e)+Math.PI:Math.atan(t/e)-Math.PI:0},e.angleTo=function(t,n,i){rt.subtract(n,t,e.TEMPVector30),rt.normalize(e.TEMPVector30,e.TEMPVector30),i.elements[0]=Math.asin(e.TEMPVector30.y),i.elements[1]=e.arcTanAngle(-e.TEMPVector30.z,-e.TEMPVector30.x)},e.createFromAxisAngle=function(e,t,n){var i=n.elements,r=e.elements;t*=.5;var a=Math.sin(t);i[0]=a*r[0],i[1]=a*r[1],i[2]=a*r[2],i[3]=Math.cos(t)},e.createFromMatrix3x3=function(e,t){var n,i=t.elements,r=e.elements,a=r[0]+r[4]+r[8];if(a>0)n=Math.sqrt(a+1),i[3]=.5*n,n=.5/n,i[0]=(r[5]-r[7])*n,i[1]=(r[6]-r[2])*n,i[2]=(r[1]-r[3])*n;else{var s=0;r[4]>r[0]&&(s=1),r[8]>r[3*s+s]&&(s=2);var o=(s+1)%3,l=(s+2)%3;n=Math.sqrt(r[3*s+s]-r[3*o+o]-r[3*l+l]+1),i[s]=.5*n,n=.5/n,i[3]=(r[3*o+l]-r[3*l+o])*n,i[o]=(r[3*o+s]+r[3*s+o])*n,i[l]=(r[3*l+s]+r[3*s+l])*n}},e.createFromMatrix4x4=function(e,t){var n,i,r=e.elements,a=t.elements,s=r[0]+r[5]+r[10];s>0?(n=Math.sqrt(s+1),a[3]=.5*n,n=.5/n,a[0]=(r[6]-r[9])*n,a[1]=(r[8]-r[2])*n,a[2]=(r[1]-r[4])*n):r[0]>=r[5]&&r[0]>=r[10]?(n=Math.sqrt(1+r[0]-r[5]-r[10]),i=.5/n,a[0]=.5*n,a[1]=(r[1]+r[4])*i,a[2]=(r[2]+r[8])*i,a[3]=(r[6]-r[9])*i):r[5]>r[10]?(n=Math.sqrt(1+r[5]-r[0]-r[10]),i=.5/n,a[0]=(r[4]+r[1])*i,a[1]=.5*n,a[2]=(r[9]+r[6])*i,a[3]=(r[8]-r[2])*i):(n=Math.sqrt(1+r[10]-r[0]-r[5]),i=.5/n,a[0]=(r[8]+r[2])*i,a[1]=(r[9]+r[6])*i,a[2]=.5*n,a[3]=(r[1]-r[4])*i)},e.slerp=function(e,t,n,i){var r,a,s,o,l,h=e.elements,u=t.elements,c=i.elements,_=h[0],d=h[1],m=h[2],f=h[3],p=u[0],v=u[1],g=u[2],x=u[3];return a=_*p+d*v+m*g+f*x,a<0&&(a=-a,p=-p,v=-v,g=-g,x=-x),1-a>1e-6?(r=Math.acos(a),s=Math.sin(r),o=Math.sin((1-n)*r)/s,l=Math.sin(n*r)/s):(o=1-n,l=n),c[0]=o*_+l*p,c[1]=o*d+l*v,c[2]=o*m+l*g,c[3]=o*f+l*x,c},e.lerp=function(e,t,n,i){var r=i.elements,a=e.elements,s=t.elements,o=a[0],l=a[1],h=a[2],u=a[3];r[0]=o+n*(s[0]-o),r[1]=l+n*(s[1]-l),r[2]=h+n*(s[2]-h),r[3]=u+n*(s[3]-u)},e.add=function(e,t,n){var i=n.elements,r=e.elements,a=t.elements;i[0]=r[0]+a[0],i[1]=r[1]+a[1],i[2]=r[2]+a[2],i[3]=r[3]+a[3]},e.dot=function(e,t){var n=e.elements,i=t.elements;return n[0]*i[0]+n[1]*i[1]+n[2]*i[2]+n[3]*i[3]},e.rotationLookAt=function(t,n,i){e.lookAt(rt.ZERO,t,n,i)},e.lookAt=function(t,n,i,r){Qe.lookAt(t,n,i,e._tempMatrix3x3),e.rotationMatrix(e._tempMatrix3x3,r)},e.rotationMatrix=function(e,t){var n=e.elements,i=n[0],r=n[1],a=n[2],s=n[3],o=n[4],l=n[5],h=n[6],u=n[7],c=n[8],_=t.elements,d=NaN,m=NaN,f=i+o+c;f>0?(d=Math.sqrt(f+1),_[3]=.5*d,d=.5/d,_[0]=(l-u)*d,_[1]=(h-a)*d,_[2]=(r-s)*d):i>=o&&i>=c?(d=Math.sqrt(1+i-o-c),m=.5/d,_[0]=.5*d,_[1]=(r+s)*m,_[2]=(a+h)*m,_[3]=(l-u)*m):o>c?(d=Math.sqrt(1+o-i-c),m=.5/d,_[0]=(s+r)*m,_[1]=.5*d,_[2]=(u+l)*m,_[3]=(h-a)*m):(d=Math.sqrt(1+c-i-o),m=.5/d,_[0]=(h+a)*m,_[1]=(u+l)*m,_[2]=.5*d,_[3]=(r-s)*m)},e.DEFAULT=new e,i(e,["TEMPVector30",function(){return this.TEMPVector30=new rt},"TEMPVector31",function(){return this.TEMPVector31=new rt},"TEMPVector32",function(){return this.TEMPVector32=new rt},"TEMPVector33",function(){return this.TEMPVector33=new rt},"TEMPMatrix0",function(){return this.TEMPMatrix0=new Ke},"TEMPMatrix1",function(){return this.TEMPMatrix1=new Ke},"_tempMatrix3x3",function(){return this._tempMatrix3x3=new Qe}]),e}(),tt=function(){function e(e){this._temp=new Uint32Array(1),this.seeds=new Uint32Array(4),this.seeds[0]=e,this.seeds[1]=1812433253*this.seeds[0]+1,this.seeds[2]=1812433253*this.seeds[1]+1,this.seeds[3]=1812433253*this.seeds[2]+1}r(e,"laya.d3.math.Rand");var t=e.prototype;return t.getUint=function(){return this._temp[0]=this.seeds[0]^this.seeds[0]<<11,this.seeds[0]=this.seeds[1],this.seeds[1]=this.seeds[2],this.seeds[2]=this.seeds[3],this.seeds[3]=this.seeds[3]^this.seeds[3]>>>19^this._temp[0]^this._temp[0]>>>8,this.seeds[3]},t.getFloat=function(){return this.getUint(),(8388607&this.seeds[3])*(1/8388607)},t.getSignedFloat=function(){return 2*this.getFloat()-1},a(0,t,"seed",function(){return this.seeds[0]},function(e){this.seeds[0]=e,this.seeds[1]=1812433253*this.seeds[0]+1,this.seeds[2]=1812433253*this.seeds[1]+1,this.seeds[3]=1812433253*this.seeds[2]+1}),e.getFloatFromInt=function(e){return 1/8388607*(8388607&e)},e.getByteFromInt=function(e){return(8388607&e)>>>15},e}(),nt=(function(){function e(e){if(this._state0U=NaN,this._state0L=NaN,this._state1U=NaN,this._state1L=NaN,!(e instanceof Array)||4!==e.length)throw new Error("Rand:Seed must be an array with 4 numbers");this._state0U=0|e[0],this._state0L=0|e[1],this._state1U=0|e[2],this._state1L=0|e[3]}r(e,"laya.d3.math.RandX");var t=e.prototype;t.randomint=function(){var e=this._state0U,t=this._state0L,n=this._state1U,i=this._state1L,r=(i>>>0)+(t>>>0),a=n+e+(r/2>>>31)>>>0,s=r>>>0;this._state0U=n,this._state0L=i;var o=0,l=0,h=0,u=0;o=e<<23|(t&-512)>>>9,l=t<<23,e^=o,t^=l,o=e^n,l=t^i;h=e>>>18,u=t>>>18|(262143&e)<<14,o^=h,l^=u;return h=n>>>5,u=i>>>5|(31&n)<<27,o^=h,l^=u,this._state1U=o,this._state1L=l,[a,s]},t.random=function(){var t=this.randomint(),n=t[0],i=t[1],r=n>>>12,a=i>>>12|(4095&n)<<20,s=1023<<20|r,o=0|a;return e._CONVERTION_BUFFER.setUint32(0,s,!1),e._CONVERTION_BUFFER.setUint32(4,o,!1),tt._CONVERTION_BUFFER.getFloat64(0,!1)-1},i(e,["_CONVERTION_BUFFER",function(){return this._CONVERTION_BUFFER=new DataView(new ArrayBuffer(8))},"defaultRand",function(){return this.defaultRand=new tt([0,Date.now()/65536,0,Date.now()%65536])}]),e}(),function(){function e(e,t){this.origin=null,this.direction=null,this.origin=e,this.direction=t}return r(e,"laya.d3.math.Ray"),e}()),it=function(){function e(e,t){this.elements=new Float32Array(2),void 0===e&&(e=0),void 0===t&&(t=0);var n=this.elements;n[0]=e,n[1]=t}r(e,"laya.d3.math.Vector2");var t=e.prototype;return n.imps(t,{"laya.d3.core.IClone":!0}),t.cloneTo=function(e){var t=e,n=t.elements,i=this.elements;n[0]=i[0],n[1]=i[1]},t.clone=function(){var e=new this.constructor;return this.cloneTo(e),e},a(0,t,"x",function(){return this.elements[0]},function(e){this.elements[0]=e}),a(0,t,"y",function(){return this.elements[1]},function(e){this.elements[1]=e}),e.scale=function(e,t,n){var i=n.elements,r=e.elements;i[0]=r[0]*t,i[1]=r[1]*t},i(e,["ZERO",function(){return this.ZERO=new e(0,0)},"ONE",function(){return this.ONE=new e(1,1)}]),e}(),rt=function(){function e(e,t,n){this.elements=new Float32Array(3),void 0===e&&(e=0),void 0===t&&(t=0),void 0===n&&(n=0);var i=this.elements;i[0]=e,i[1]=t,i[2]=n}r(e,"laya.d3.math.Vector3");var t=e.prototype;return n.imps(t,{"laya.d3.core.IClone":!0}),t.cloneTo=function(e){var t=e,n=t.elements,i=this.elements;n[0]=i[0],n[1]=i[1],n[2]=i[2]},t.clone=function(){var e=new this.constructor;return this.cloneTo(e),e},t.toDefault=function(){this.elements[0]=0,this.elements[1]=0,this.elements[2]=0},a(0,t,"x",function(){return this.elements[0]},function(e){this.elements[0]=e}),a(0,t,"y",function(){return this.elements[1]},function(e){this.elements[1]=e}),a(0,t,"z",function(){return this.elements[2]},function(e){this.elements[2]=e}),e.distanceSquared=function(e,t){var n=e.elements,i=t.elements,r=n[0]-i[0],a=n[1]-i[1],s=n[2]-i[2];return r*r+a*a+s*s},e.distance=function(e,t){var n=e.elements,i=t.elements,r=n[0]-i[0],a=n[1]-i[1],s=n[2]-i[2];return Math.sqrt(r*r+a*a+s*s)},e.min=function(e,t,n){var i=n.elements,r=e.elements,a=t.elements;i[0]=Math.min(r[0],a[0]),i[1]=Math.min(r[1],a[1]),i[2]=Math.min(r[2],a[2])},e.max=function(e,t,n){var i=n.elements,r=e.elements,a=t.elements;i[0]=Math.max(r[0],a[0]),i[1]=Math.max(r[1],a[1]),i[2]=Math.max(r[2],a[2])},e.transformQuat=function(e,t,n){var i=n.elements,r=e.elements,a=t.elements,s=r[0],o=r[1],l=r[2],h=a[0],u=a[1],c=a[2],_=a[3],d=_*s+u*l-c*o,m=_*o+c*s-h*l,f=_*l+h*o-u*s,p=-h*s-u*o-c*l;i[0]=d*_+p*-h+m*-c-f*-u,i[1]=m*_+p*-u+f*-h-d*-c,i[2]=f*_+p*-c+d*-u-m*-h},e.scalarLength=function(e){var t=e.elements,n=t[0],i=t[1],r=t[2];return Math.sqrt(n*n+i*i+r*r)},e.scalarLengthSquared=function(e){var t=e.elements,n=t[0],i=t[1],r=t[2];return n*n+i*i+r*r},e.normalize=function(e,t){var n=e.elements,i=t.elements,r=n[0],a=n[1],s=n[2],o=r*r+a*a+s*s;o>0&&(o=1/Math.sqrt(o),i[0]=n[0]*o,i[1]=n[1]*o,i[2]=n[2]*o)},e.multiply=function(e,t,n){var i=n.elements,r=e.elements,a=t.elements;i[0]=r[0]*a[0],i[1]=r[1]*a[1],i[2]=r[2]*a[2]},e.scale=function(e,t,n){var i=n.elements,r=e.elements;i[0]=r[0]*t,i[1]=r[1]*t,i[2]=r[2]*t},e.lerp=function(e,t,n,i){var r=i.elements,a=e.elements,s=t.elements,o=a[0],l=a[1],h=a[2];r[0]=o+n*(s[0]-o),r[1]=l+n*(s[1]-l),r[2]=h+n*(s[2]-h)},e.transformV3ToV3=function(t,n,i){var r=new at;e.transformV3ToV4(t,n,r);var a=r.elements,s=i.elements;s[0]=a[0],s[1]=a[1],s[2]=a[2]},e.transformV3ToV4=function(e,t,n){var i=e.elements,r=i[0],a=i[1],s=i[2],o=t.elements,l=n.elements;l[0]=r*o[0]+a*o[4]+s*o[8]+o[12],l[1]=r*o[1]+a*o[5]+s*o[9]+o[13],l[2]=r*o[2]+a*o[6]+s*o[10]+o[14],l[3]=r*o[3]+a*o[7]+s*o[11]+o[15]},e.TransformNormal=function(e,t,n){var i=e.elements,r=i[0],a=i[1],s=i[2],o=t.elements,l=n.elements;l[0]=r*o[0]+a*o[4]+s*o[8],l[1]=r*o[1]+a*o[5]+s*o[9],l[2]=r*o[2]+a*o[6]+s*o[10]},e.transformCoordinate=function(t,n,i){var r=e.TEMPVec4.elements,a=t.elements,s=a[0],o=a[1],l=a[2],h=n.elements;r[0]=s*h[0]+o*h[4]+l*h[8]+h[12],r[1]=s*h[1]+o*h[5]+l*h[9]+h[13],r[2]=s*h[2]+o*h[6]+l*h[10]+h[14],r[3]=1/(s*h[3]+o*h[7]+l*h[11]+h[15]);var u=i.elements;u[0]=r[0]*r[3],u[1]=r[1]*r[3],u[2]=r[2]*r[3]},e.Clamp=function(e,t,n,i){var r=e.elements,a=r[0],s=r[1],o=r[2],l=t.elements,h=l[0],u=l[1],c=l[2],_=n.elements,d=_[0],m=_[1],f=_[2],p=i.elements;a=a>d?d:a,a=a<h?h:a,s=s>m?m:s,s=s<u?u:s,o=o>f?f:o,o=o<c?c:o,p[0]=a,p[1]=s,p[2]=o},e.add=function(e,t,n){var i=n.elements,r=e.elements,a=t.elements;i[0]=r[0]+a[0],i[1]=r[1]+a[1],i[2]=r[2]+a[2]},e.subtract=function(e,t,n){var i=n.elements,r=e.elements,a=t.elements;i[0]=r[0]-a[0],i[1]=r[1]-a[1],i[2]=r[2]-a[2]},e.cross=function(e,t,n){var i=e.elements,r=t.elements,a=n.elements,s=i[0],o=i[1],l=i[2],h=r[0],u=r[1],c=r[2];a[0]=o*c-l*u,a[1]=l*h-s*c,a[2]=s*u-o*h},e.dot=function(e,t){var n=e.elements,i=t.elements;return n[0]*i[0]+n[1]*i[1]+n[2]*i[2]},e.equals=function(e,t){var n=e.elements,i=t.elements;return Ze.nearEqual(Math.abs(n[0]),Math.abs(i[0]))&&Ze.nearEqual(Math.abs(n[1]),Math.abs(i[1]))&&Ze.nearEqual(Math.abs(n[2]),Math.abs(i[2]))},i(e,["ZERO",function(){return this.ZERO=new e(0,0,0)},"ONE",function(){return this.ONE=new e(1,1,1)},"NegativeUnitX",function(){return this.NegativeUnitX=new e(-1,0,0)},"UnitX",function(){return this.UnitX=new e(1,0,0)},"UnitY",function(){return this.UnitY=new e(0,1,0)},"UnitZ",function(){return this.UnitZ=new e(0,0,1)},"ForwardRH",function(){return this.ForwardRH=new e(0,0,-1)},"ForwardLH",function(){return this.ForwardLH=new e(0,0,1)},"Up",function(){return this.Up=new e(0,1,0)},"TEMPVec4",function(){return this.TEMPVec4=new at}]),e}(),at=function(){function e(e,t,n,i){this.elements=new Float32Array(4),void 0===e&&(e=0),void 0===t&&(t=0),void 0===n&&(n=0),void 0===i&&(i=0);var r=this.elements;r[0]=e,r[1]=t,r[2]=n,r[3]=i}r(e,"laya.d3.math.Vector4");var t=e.prototype;return n.imps(t,{"laya.d3.core.IClone":!0}),t.cloneTo=function(e){var t=e,n=t.elements,i=this.elements;n[0]=i[0],n[1]=i[1],n[2]=i[2],n[3]=i[3]},t.clone=function(){var e=new this.constructor;return this.cloneTo(e),e},t.length=function(){return Math.sqrt(this.x*this.x+this.y*this.y+this.z*this.z+this.w*this.w)},t.lengthSquared=function(){return this.x*this.x+this.y*this.y+this.z*this.z+this.w*this.w},a(0,t,"x",function(){return this.elements[0]},function(e){this.elements[0]=e}),a(0,t,"y",function(){return this.elements[1]},function(e){this.elements[1]=e}),a(0,t,"z",function(){return this.elements[2]},function(e){this.elements[2]=e}),a(0,t,"w",function(){return this.elements[3]},function(e){this.elements[3]=e}),e.lerp=function(e,t,n,i){var r=i.elements,a=e.elements,s=t.elements,o=a[0],l=a[1],h=a[2],u=a[3];r[0]=o+n*(s[0]-o),r[1]=l+n*(s[1]-l),r[2]=h+n*(s[2]-h),r[3]=u+n*(s[3]-u)},e.transformByM4x4=function(e,t,n){var i=e.elements,r=i[0],a=i[1],s=i[2],o=i[3],l=t.elements,h=n.elements;h[0]=r*l[0]+a*l[4]+s*l[8]+o*l[12],h[1]=r*l[1]+a*l[5]+s*l[9]+o*l[13],h[2]=r*l[2]+a*l[6]+s*l[10]+o*l[14],h[3]=r*l[3]+a*l[7]+s*l[11]+o*l[15]},e.equals=function(e,t){var n=e.elements,i=t.elements;return Ze.nearEqual(Math.abs(n[0]),Math.abs(i[0]))&&Ze.nearEqual(Math.abs(n[1]),Math.abs(i[1]))&&Ze.nearEqual(Math.abs(n[2]),Math.abs(i[2]))&&Ze.nearEqual(Math.abs(n[3]),Math.abs(i[3]))},e.normalize=function(e,t){var n=e.elements,i=t.elements,r=e.length();r>0&&(i[0]=n[0]*r,i[1]=n[1]*r,
i[2]=n[2]*r,i[3]=n[3]*r)},e.add=function(e,t,n){var i=n.elements,r=e.elements,a=t.elements;i[0]=r[0]+a[0],i[1]=r[1]+a[1],i[2]=r[2]+a[2],i[3]=r[3]+a[3]},e.subtract=function(e,t,n){var i=n.elements,r=e.elements,a=t.elements;i[0]=r[0]-a[0],i[1]=r[1]-a[1],i[2]=r[2]-a[2],i[3]=r[3]-a[3]},e.multiply=function(e,t,n){var i=n.elements,r=e.elements,a=t.elements;i[0]=r[0]*a[0],i[1]=r[1]*a[1],i[2]=r[2]*a[2],i[3]=r[3]*a[3]},e.scale=function(e,t,n){var i=n.elements,r=e.elements;i[0]=r[0]*t,i[1]=r[1]*t,i[2]=r[2]*t,i[3]=r[3]*t},e.Clamp=function(e,t,n,i){var r=e.elements,a=r[0],s=r[1],o=r[2],l=r[3],h=t.elements,u=h[0],c=h[1],_=h[2],d=h[3],m=n.elements,f=m[0],p=m[1],v=m[2],g=m[3],x=i.elements;a=a>f?f:a,a=a<u?u:a,s=s>p?p:s,s=s<c?c:s,o=o>v?v:o,o=o<_?_:o,l=l>g?g:l,l=l<d?d:l,x[0]=a,x[1]=s,x[2]=o,x[3]=l},e.distanceSquared=function(e,t){var n=e.elements,i=t.elements,r=n[0]-i[0],a=n[1]-i[1],s=n[2]-i[2],o=n[3]-i[3];return r*r+a*a+s*s+o*o},e.distance=function(e,t){var n=e.elements,i=t.elements,r=n[0]-i[0],a=n[1]-i[1],s=n[2]-i[2],o=n[3]-i[3];return Math.sqrt(r*r+a*a+s*s+o*o)},e.dot=function(e,t){var n=e.elements,i=t.elements;return n[0]*i[0]+n[1]*i[1]+n[2]*i[2]+n[3]*i[3]},e.min=function(e,t,n){var i=n.elements,r=e.elements,a=t.elements;i[0]=Math.min(r[0],a[0]),i[1]=Math.min(r[1],a[1]),i[2]=Math.min(r[2],a[2]),i[3]=Math.min(r[3],a[3])},e.max=function(e,t,n){var i=n.elements,r=e.elements,a=t.elements;i[0]=Math.max(r[0],a[0]),i[1]=Math.max(r[1],a[1]),i[2]=Math.max(r[2],a[2]),i[3]=Math.max(r[3],a[3])},i(e,["ZERO",function(){return this.ZERO=new e},"ONE",function(){return this.ONE=new e(1,1,1,1)},"UnitX",function(){return this.UnitX=new e(1,0,0,0)},"UnitY",function(){return this.UnitY=new e(0,1,0,0)},"UnitZ",function(){return this.UnitZ=new e(0,0,1,0)},"UnitW",function(){return this.UnitW=new e(0,0,0,1)}]),e}(),st=function(){function e(e,t,n,i){this.minDepth=0,this.maxDepth=1,this.x=e,this.y=t,this.width=n,this.height=i}r(e,"laya.d3.math.Viewport");var t=e.prototype;return t.project=function(e,t,n){rt.transformV3ToV3(e,t,n);var i=e.elements,r=t.elements,a=n.elements,s=i[0]*r[3]+i[1]*r[7]+i[2]*r[11]+r[15];1!==s&&(a[0]=a[0]/s,a[1]=a[1]/s,a[2]=a[2]/s),a[0]=.5*(a[0]+1)*this.width+this.x,a[1]=.5*(1-a[1])*this.height+this.y,a[2]=a[2]*(this.maxDepth-this.minDepth)+this.minDepth},t.unprojectFromMat=function(e,t,n){var i=e.elements,r=t.elements,a=n.elements;a[0]=(i[0]-this.x)/this.width*2-1,a[1]=-((i[1]-this.y)/this.height*2-1);var s=(this.maxDepth-this.minDepth)/2;a[2]=(i[2]-this.minDepth-s)/s;var o=a[0]*r[3]+a[1]*r[7]+a[2]*r[11]+r[15];rt.transformV3ToV3(n,t,n),1!==o&&(a[0]=a[0]/o,a[1]=a[1]/o,a[2]=a[2]/o)},t.unprojectFromWVP=function(t,n,i,r,a){Ke.multiply(n,i,e._tempMatrix4x4),r&&Ke.multiply(e._tempMatrix4x4,r,e._tempMatrix4x4),e._tempMatrix4x4.invert(e._tempMatrix4x4),this.unprojectFromMat(t,e._tempMatrix4x4,a)},i(e,["_tempMatrix4x4",function(){return this._tempMatrix4x4=new Ke}]),e}(),ot=function(){function e(e){this._mesh=null,this._vertexBuffer=null,this._indexBuffer=null,this._boneIndices=null,this._bufferUsage=null,this._indexInMesh=0,this._bufferUsage={},this._mesh=e}r(e,"laya.d3.resource.models.SubMesh");var t=e.prototype;return n.imps(t,{"laya.d3.core.render.IRenderable":!0,"laya.resource.IDispose":!0}),t._getVertexBuffer=function(e){return void 0===e&&(e=0),0===e?this._vertexBuffer:null},t._getIndexBuffer=function(){return this._indexBuffer},t._beforeRender=function(e){return this._vertexBuffer._bind(),this._indexBuffer._bind(),!0},t._renderRuntime=function(e,t,n){t._material,t._sprite3D;e.drawSubmesh(t._conchSubmesh,0,4,0,this._indexBuffer.indexCount)},t._render=function(e){var t=this._indexBuffer.indexCount;e.context.drawElements(4,t,5123,0),I.drawCall++,I.trianglesFaces+=t/3},t.dispose=function(){this._boneIndices=null,this._indexBuffer.dispose(),this._vertexBuffer.dispose()},a(0,t,"_vertexBufferCount",function(){return 1}),a(0,t,"indexOfHost",function(){return this._indexInMesh}),a(0,t,"triangleCount",function(){return this._indexBuffer.indexCount/3}),e}(),lt=function(){function e(n,i,r,a,s,o){function l(e){for(var t=e.split(" "),n=[],i=0;i<t.length;i++)t[i].length>0&&n.push(t[i]);return n}function h(n){var i=n;n=n.replace(e.DEFINEREG,"");var r,a,s=0,h=0,u=0,c=new t(0,null,null,null),_=c,d=n.split("\n");for(s=0,h=d.length;s<h;s++){var m=d[s];if(m.indexOf("#ifdef")>=0)r=l(m),_=new t(1,r[1],"",_);else if(m.indexOf("#if")>=0)r=l(m),_=new t(1,r[1],"",_);else if(m.indexOf("#else")>=0)a=_.condition,_=new t(2,null,"",_.parent),_.condition=a;else if(m.indexOf("#endif")>=0)_=_.parent;else if(m.indexOf("#include")>=0){r=l(m);var f=r[1],p=f.charAt(0);'"'!==p&&"'"!==p||(f=f.substr(1,f.length-2),(u=f.lastIndexOf(p))>0&&(f=f.substr(0,u))),u=r[0].indexOf("?");var v=u>0?r[0].substr(u+1):r[0];if(new t(1,v,o[f],_),D.isConchNode){var g=v.match(e.INCLUDE),x=g.length;if(1==x)v=v.replace(g[0],"defined("+g[0]+")");else if(x>1)for(var E={},M=0;M<x;M++){var T=g[M];E[T]||(v=v.replace(T,"defined("+T+")"),E[T]=!0)}var S="#if "+v;S+="\n"+o[f]+"\n",S+="#endif",i=i.replace(m,S)}}else _.childs.length>0&&0===_.childs[_.childs.length-1].type?_.childs[_.childs.length-1].text+="\n"+m:new t(0,null,m,_)}return D.isConchNode&&(c.sd=i),c}this._currentShaderDefinePower=9,this._int2name=[],this._name=n,this._renderElementUniformMap={},this._materialUniformMap={},this._spriteUniformMap={},this._cameraUniformMap={},this._sceneUniformMap={},this.sharders=[],this.sharders.length=32,this._VSTXT=i,this._PSTXT=r,this._int2name=this._int2name.concat(e._globalInt2name),this._VS=h(i),this._PS=h(r),this._attributeMap=a;var u;for(u in s){var c=s[u];switch(c[1]){case 0:this._renderElementUniformMap[u]=c[0];break;case 1:this._materialUniformMap[u]=c[0];break;case 2:this._spriteUniformMap[u]=c[0];break;case 3:this._cameraUniformMap[u]=c[0];break;case 4:this._sceneUniformMap[u]=c[0];break;default:throw new Error("ShaderCompile3D: period is unkonw.")}}if(D.isConchNode){this._conchShader=new ConchShader,this._conchShader.setSrc(this._VS.sd,this._PS.sd),delete this._VS.sd,delete this._PS.sd;var _=[];for(u in this._attributeMap)_.push({name:u,elementUsage:this._attributeMap[u]});this._conchShader.setAttrDeclare(_);var d=[];for(u in s){var m=s[u];d.push({name:u,elementUsage:m[0],periodType:m[1]})}this._conchShader.setUniformDeclare(d)}}var t;r(e,"laya.d3.shader.ShaderCompile3D");var n=e.prototype;return n.withCompile=function(e,t,n){var i=this.sharders[n];if(i)return i;var r=this.definesToNameDic(t,this._int2name);if(mt.shaderCompileDebug){var a="";for(var s in r)a+=s+" ";console.log("DebugMode------Shader name:"+kt.nameKey.getName(e)+" ID:"+e+",shaderDefine result Value:"+t+" define group:"+a+"------DebugMode")}return i=this.createShader(r),this.sharders[n]=i,i},n.createShader=function(e){var t={},n="";if(e)for(var i in e)n+="#define "+i+"\n",t[i]=!0;var r=this._VS.toscript(t,[]),a=this._PS.toscript(t,[]);return kt.create(n+r.join("\n"),n+a.join("\n"),this._attributeMap,this._sceneUniformMap,this._cameraUniformMap,this._spriteUniformMap,this._materialUniformMap,this._renderElementUniformMap)},n.precompileShaderWithShaderDefine=function(e){this.withCompile(this._name/2e-4,e,this._name+e)},n.registerDefine=function(e){var t=Math.pow(2,this._currentShaderDefinePower++);return this._int2name[t]=e,D.isConchNode&&conch.regShaderDefine&&conch.regShaderDefine(e,t),t},n.definesToNameDic=function(e,t){for(var n={},i=1,r=0;r<32&&!((i=1<<r)>e);r++)if(e&i){var a=t[i];a&&(n[a]="")}return n},e.__init__=function(){e._globalRegDefine("FSHIGHPRECISION",e.SHADERDEFINE_FSHIGHPRECISION),e._globalRegDefine("VR",e.SHADERDEFINE_VR),e._globalRegDefine("FOG",e.SHADERDEFINE_FOG),e._globalRegDefine("DIRECTIONLIGHT",e.SHADERDEFINE_DIRECTIONLIGHT),e._globalRegDefine("POINTLIGHT",e.SHADERDEFINE_POINTLIGHT),e._globalRegDefine("SPOTLIGHT",e.SHADERDEFINE_SPOTLIGHT),e._globalRegDefine("UV",e.SHADERDEFINE_UV),e._globalRegDefine("COLOR",e.SHADERDEFINE_COLOR),e._globalRegDefine("BONE",Kt.SHADERDEFINE_BONE)},e._globalRegDefine=function(t,n){e._globalInt2name[n]=t},e.add=function(t,n,i,r,a){var s=2e-4*t;return laya.d3.shader.ShaderCompile3D._preCompileShader[s]=new e(s,n,i,r,a,kt._includeFiles)},e.get=function(e){return laya.d3.shader.ShaderCompile3D._preCompileShader[2e-4*kt.nameKey.getID(e)]},e.SHADERDEFINE_FSHIGHPRECISION=1,e.SHADERDEFINE_VR=2,e.SHADERDEFINE_FOG=4,e.SHADERDEFINE_DIRECTIONLIGHT=8,e.SHADERDEFINE_POINTLIGHT=16,e.SHADERDEFINE_SPOTLIGHT=32,e.SHADERDEFINE_UV=64,e.SHADERDEFINE_COLOR=128,e._globalInt2name=[],e._preCompileShader={},e.IFDEF_NO=0,e.IFDEF_YES=1,e.IFDEF_ELSE=2,e.SHADERNAME2ID=2e-4,i(e,["DEFINEREG",function(){return this.DEFINEREG=new RegExp("defined(?=\\((.*?)\\))","g")},"INCLUDE",function(){return this.INCLUDE=new RegExp("\\w+","g")}]),e.__init$=function(){t=function(){function e(e,t,n,i){if(this.childs=new Array,this.type=e,this.text=n,this.parent=i,i&&i.childs.push(this),t){for(var r="",a=!1,s=!1,o=0,l=t.length;o<l;o++){var h=t.charAt(o);s="!&|() \t".indexOf(h)<0,a!=s&&(s&&(r+="this."),a=s),r+=h}this.condition=V.createShaderCondition(r)}}return r(e,""),e.prototype.toscript=function(e,t){if(0===this.type&&this.text&&t.push(this.text),this.childs.length<1&&!this.text)return t;if(0!==this.type){var n=!!this.condition.call(e);if(2===this.type&&(n=!n),!n)return t;this.text&&t.push(this.text)}return this.childs.length>0&&this.childs.forEach(function(n,i,r){n.toscript(e,t)}),t},e}()},e}(),ht=function(){function e(){this._data=null,this._data=[]}r(e,"laya.d3.shader.ValusArray");var t=e.prototype;return t.setValue=function(e,t){this._data[e]=t},a(0,t,"data",function(){return this._data}),e}(),ut=(function(){function e(){this._currentPSSM=-1,this._numberOfPSSM=3,this._maxDistance=200,this._ratioOfDistance=1/this._numberOfPSSM,this._lightDirLength=1,this._samplerEmbeddedCount=0,this._statesDirty=!0,this._shadowMapTextureSize=1024,this._sceneCamera=null,this._spiltDistance=new Array(5),this._globalParallelLightDir=new rt(0,-1,0),this._involvedShadowMapRange=new Ye(new rt,new rt),this._tempInvolvedShadowMapRange=new Ye(new rt,new rt),this._lightCulling=new We(Ke.DEFAULT),this._renderTarget=new Array(5),this._lightCamera=new sn,this._boundingSphere=new Array(5),this._boundingBox=new Array(5),this._lightViewProjectionMatrix=new Array(5),this._frustumPos=new Array(20),this._uniformDistance=new Array(5),this._logDistance=new Array(5),this._dimension=new Array(5),this._tempLookAt3=new rt,this._tempLookAt4=new at,this._tempValue=new at,this._tempPos=new rt,this._tempLightUp=new rt,this._tempMin=new at,this._tempMax=new at,this._tempMatrix44=new Ke,this._splitFrustumCulling=new We(Ke.DEFAULT),this._tempScaleMatrix44=new Ke;var e=0;for(e=0;e<this._spiltDistance.length;e++)this._spiltDistance[e]=0;for(this.setInvolvedShadowMapRange(this._maxDistance),e=0;e<this._dimension.length;e++)this._dimension[e]=new it;for(e=0;e<this._frustumPos.length;e++)this._frustumPos[e]=new rt;for(e=0;e<this._lightViewProjectionMatrix.length;e++)this._lightViewProjectionMatrix[e]=new Ke;for(e=0;e<this._boundingBox.length;e++)this._boundingBox[e]=new Ye(new rt,new rt);for(e=0;e<this._boundingSphere.length;e++)this._boundingSphere[e]=new Xe(new rt,0);var t=this._numberOfPSSM+1;for(e=0;e<t;e++)this._renderTarget[e]=new tn(this._shadowMapTextureSize,this._shadowMapTextureSize);Ke.createScaling(new rt(.5,.5,1),this._tempScaleMatrix44),this._tempScaleMatrix44.elements[12]=.5,this._tempScaleMatrix44.elements[13]=.5}r(e,"laya.d3.shadowMap.ParallelSplitShadowMap");var t=e.prototype;t.setInfo=function(e,t,n,i,r){r>4&&(this._numberOfPSSM=4),this._sceneCamera=e,this._maxDistance=t,this._numberOfPSSM=r,this._lightDirLength=rt.scalarLength(this._globalParallelLightDir),rt.normalize(n,this._globalParallelLightDir),this._ratioOfDistance=1/this._numberOfPSSM;for(var a=0;a<this._spiltDistance.length;a++)this._spiltDistance[a]=0;this._shadowMapTextureSize=i,this._statesDirty=!0},t.setFarDistance=function(e){this._maxDistance!=e&&(this._maxDistance=e,this._statesDirty=!0)},t.getFarDistance=function(){return this._maxDistance},t.setNumberOfFrumstum=function(e){this._numberOfPSSM!=e&&(this._numberOfPSSM=e,this._ratioOfDistance=1/this._numberOfPSSM,this._statesDirty=!0)},t.getNumberOfFrumstum=function(){return this._numberOfPSSM},t.setGlobalParallelLightDir=function(e){rt.equals(this._globalParallelLightDir,e)&&(this._globalParallelLightDir=e,this._lightDirLength=rt.scalarLength(this._globalParallelLightDir))},t.getGlobalParallelLightDir=function(){return this._globalParallelLightDir},t.setCurrentPSSM=function(e){this._currentPSSM!=e&&(this._currentPSSM=e)},t.getCurrentPSSM=function(){return this._currentPSSM},t.getLightCamera=function(){return this._lightCamera},t.beginSampler=function(e){if(e<0||e>this._numberOfPSSM)throw new Error("Camera: beginSample invalid index");this.setCurrentPSSM(e),this.update(),this._samplerEmbeddedCount++},t.endSampler=function(){0!=this._samplerEmbeddedCount&&(this._currentPSSM=-1,this._samplerEmbeddedCount--)},t.recalculate=function(){this.calcSplitDistance(),this.calcBoundingBox(),this.rebuildRenderTarget(),this.setInvolvedShadowMapRange(this._maxDistance),this._statesDirty=!1},t.update=function(){this._statesDirty&&this.recalculate(),this.calcSplitFrustum(),this.calcLightViewProject()},t.calcSplitDistance=function(){if(this._statesDirty){var e=this._sceneCamera.nearPlane,t=this._maxDistance,n=1/this._numberOfPSSM,i=0;for(i=0;i<=this._numberOfPSSM;i++)this._uniformDistance[i]=e+(t-e)*i*n;var r=t/e;for(i=0;i<=this._numberOfPSSM;i++){var a=Math.pow(r,i*n);this._logDistance[i]=e*a}for(i=0;i<=this._numberOfPSSM;i++)this._spiltDistance[i]=this._uniformDistance[i]*this._ratioOfDistance+this._logDistance[i]*(1-this._ratioOfDistance)}},t.calcBoundingBox=function(){if(this._statesDirty){var e=3.1416*this._sceneCamera.fieldOfView/180,t=this._sceneCamera.aspectRatio,n=Math.tan(e/2),i=NaN,r=NaN,a=NaN,s=0;for(s=0;s<=this._numberOfPSSM;s++){a=this._spiltDistance[s],i=a*n,r=i*t;var o=this._frustumPos[4*s+0].elements;o[0]=-r,o[1]=-i,o[2]=-a,o=this._frustumPos[4*s+1].elements,o[0]=r,o[1]=-i,o[2]=-a,o=this._frustumPos[4*s+2].elements,o[0]=-r,o[1]=i,o[2]=-a,o=this._frustumPos[4*s+3].elements,o[0]=r,o[1]=i,o[2]=-a,o=this._dimension[s].elements,o[0]=r,o[1]=i}var l,h,u,c;for(s=1;s<=this._numberOfPSSM;s++)l=this._dimension[s].elements,h=this._boundingBox[s].min.elements,h[0]=-l[0],h[1]=-l[1],h[2]=-this._spiltDistance[s],u=this._boundingBox[s].max.elements,u[0]=l[0],u[1]=l[1],u[2]=-this._spiltDistance[s-1],c=this._boundingSphere[s].center.elements,c[0]=.5*(h[0]+u[0]),c[1]=.5*(h[1]+u[1]),c[2]=.5*(h[2]+u[2]),this._boundingSphere[s].radius=.5*Math.sqrt(Math.pow(u[0]-h[0],2)+Math.pow(u[1]-h[1],2)+Math.pow(u[2]-h[2],2));h=this._boundingBox[0].min.elements,l=this._dimension[this._numberOfPSSM].elements,h[0]=-l[0],h[1]=-l[1],h[2]=-this._spiltDistance[this._numberOfPSSM],u=this._boundingBox[0].max.elements,u[0]=l[0],u[1]=l[1],u[2]=-this._spiltDistance[0],c=this._boundingSphere[0].center.elements,c[0]=.5*(h[0]+u[0]),c[1]=.5*(h[1]+u[1]),c[2]=.5*(h[2]+u[2]),this._boundingSphere[0].radius=.5*Math.sqrt(Math.pow(u[0]-h[0],2)+Math.pow(u[1]-h[1],2)+Math.pow(u[2]-h[2],2))}},t.calcSplitFrustum=function(){this._currentPSSM>0?Ke.createPerspective(3.1416*this._sceneCamera.fieldOfView/180,this._sceneCamera.aspectRatio,this._spiltDistance[this._currentPSSM-1],this._spiltDistance[this._currentPSSM],this._tempMatrix44):Ke.createPerspective(3.1416*this._sceneCamera.fieldOfView/180,this._sceneCamera.aspectRatio,this._spiltDistance[0],this._spiltDistance[this._numberOfPSSM],this._tempMatrix44),Ke.multiply(this._tempMatrix44,this._sceneCamera.viewMatrix,this._tempMatrix44),this._splitFrustumCulling.matrix=this._tempMatrix44},t.rebuildRenderTarget=function(){var e=0;for(e=0;e<this._numberOfPSSM+1;e++)null!=this._renderTarget[e]&&this._renderTarget[e].width==this._shadowMapTextureSize&&this._renderTarget[e].height==this._shadowMapTextureSize||(null!=this._renderTarget[e]&&this._renderTarget[e].dispose(),this._renderTarget[e]=new tn(this._shadowMapTextureSize,this._shadowMapTextureSize));for(e=this._numberOfPSSM+1;e<4;e++)null!=this._renderTarget[e]&&(this._renderTarget[e].dispose(),this._renderTarget[e]=null)},t.calcLightViewProject=function(){var e=this._boundingSphere[this._currentPSSM],t=this._sceneCamera.transform.worldMatrix;e.radius;e.center.cloneTo(this._tempLookAt3),rt.transformV3ToV4(this._tempLookAt3,t,this._tempLookAt4);var n=this._tempLookAt3.elements,i=this._tempLookAt4.elements;n[0]=i[0],n[1]=i[1],n[2]=i[2];var r=this._tempLightUp.elements,a=this._sceneCamera.forward.elements;r[0]=a[0],r[1]=1,r[2]=a[2],rt.normalize(this._tempLightUp,this._tempLightUp),rt.scale(this._globalParallelLightDir,2*e.radius,this._tempPos),rt.subtract(this._tempLookAt3,this._tempPos,this._tempPos),this._lightCamera.transform.lookAt(this._tempPos,this._tempLookAt3,this._tempLightUp,!1);var s=this._tempMax.elements,o=this._tempMin.elements;s[0]=s[1]=s[2]=-1e5,s[3]=1,o[0]=o[1]=o[2]=1e5,o[3]=1;var l=0,h=0,u=0;0==this._currentPSSM?(h=0,u=3*this._numberOfPSSM):(h=4*(this._currentPSSM-1),u=h),Ke.multiply(this._lightCamera.viewMatrix,t,this._tempMatrix44);for(var c=this._tempValue.elements,_=0;_<8;_++){l=_<4?h:u;var d=this._frustumPos[l+_].elements;c[0]=d[0],c[1]=d[1],c[2]=d[2],c[3]=1,at.transformByM4x4(this._tempValue,this._tempMatrix44,this._tempValue),o[0]=c[0]<o[0]?c[0]:o[0],o[1]=c[1]<o[1]?c[1]:o[1],o[2]=c[2]<o[2]?c[2]:o[2],s[0]=c[0]>s[0]?c[0]:s[0],s[1]=c[1]>s[1]?c[1]:s[1],s[2]=c[2]>s[2]?c[2]:s[2]}at.add(this._tempMax,this._tempMin,this._tempValue),c[0]*=.5,c[1]*=.5,c[2]*=.5,c[3]=1,at.transformByM4x4(this._tempValue,this._lightCamera.transform.worldMatrix,this._tempValue);var m=Math.abs(-this._tempMax.z),f=m>this._maxDistance?m:this._maxDistance;rt.scale(this._globalParallelLightDir,f,this._tempPos);var p=this._tempPos.elements;p[0]=c[0]-p[0],p[1]=c[1]-p[1],p[2]=c[2]-p[2],this._lightCamera.transform.lookAt(this._tempPos,this._tempLookAt3,this._tempLightUp,!1),Ke.createOrthogonal(o[0],s[0],o[1],s[1],1,(f+.5*(s[2]-o[2]))*this._lightDirLength,this._lightCamera.projectionMatrix),Ke.multiply(this._tempScaleMatrix44,this._lightCamera.projectionViewMatrix,this._lightViewProjectionMatrix[this._currentPSSM]),this._lightCulling.matrix=this._lightCamera.projectionViewMatrix},t.getLightFrustumCulling=function(){return this._lightCulling},t.getSplitFrustumCulling=function(){return this._splitFrustumCulling},t.getViewProjectMatrixOfGlobalLight=function(e){return this._lightViewProjectionMatrix[e]},t.getSplitDistance=function(e){return this._spiltDistance[e]},t.setInvolvedShadowMapRange=function(e){var t=this._involvedShadowMapRange.min.elements;t[0]=t[1]=t[2]=-e;var n=this._involvedShadowMapRange.max.elements;n[0]=n[1]=n[2]=e},t.getInvolvedShadowMapRangeWS=function(){var e=this._involvedShadowMapRange.min.elements,t=this._involvedShadowMapRange.max.elements,n=this._tempInvolvedShadowMapRange.max.elements,i=(this._tempInvolvedShadowMapRange.min.elements,this._sceneCamera.position.elements);return n[0]+=i[0]-.5*(t[0]+e[0]),n[1]+=i[1]-.5*(t[1]+e[1]),n[2]+=i[2]-.5*(t[2]+e[2]),this._tempInvolvedShadowMapRange},t.setShadowMapTextureSize=function(e){e!=this._shadowMapTextureSize&&(this._shadowMapTextureSize=e,this._statesDirty=!0)},t.getShadowMapTextureSize=function(){return this._shadowMapTextureSize},t.beginRenderTarget=function(e){null!=this._renderTarget[e]&&this._renderTarget[e].start()},t.endRenderTarget=function(e){null!=this._renderTarget[e]&&this._renderTarget[e].end()},e.MAX_PSSM_COUNT=4,e}(),function(){function e(){}r(e,"laya.d3.utils.Physics"),e.rayCast=function(t,n,i,r){void 0===i&&(i=Number.MAX_VALUE),void 0===r&&(r=0),e._outHitAllInfo.length=0;for(var a=F.getLayerByNumber(r)._colliders,s=0,o=a.length;s<o;s++)if(a[s].raycast(t,e._outHitInfo,i),e._outHitInfo.distance!==-1&&e._outHitInfo.distance<=i){var l=new ct;e._outHitInfo.cloneTo(l),e._outHitAllInfo.push(l)}if(0==e._outHitAllInfo.length)return n.sprite3D=null,void(n.distance=-1);for(var h=Number.MAX_VALUE,u=0,c=0;c<e._outHitAllInfo.length;c++)e._outHitAllInfo[c].distance<h&&(h=e._outHitAllInfo[c].distance,u=c);e._outHitAllInfo[u].cloneTo(n)},e.rayCastAll=function(t,n,i,r){void 0===i&&(i=Number.MAX_VALUE),void 0===r&&(r=0),n.length=0;for(var a=F.getLayerByNumber(r)._colliders,s=0,o=a.length;s<o;s++)if(e._outHitInfo.distance=-1,e._outHitInfo.sprite3D=null,a[s].raycast(t,e._outHitInfo,i),e._outHitInfo.distance!==-1&&e._outHitInfo.distance<=i){var l=new ct;e._outHitInfo.cloneTo(l),n.push(l)}},e._outHitAllInfo=[],i(e,["_outHitInfo",function(){return this._outHitInfo=new ct}]),e}(),function(){function e(){}return r(e,"laya.d3.utils.Picker"),e.calculateCursorRay=function(t,n,i,r,a,s){var o=t.elements[0],l=t.elements[1],h=e._tempVector30,u=h.elements;u[0]=o,u[1]=l,u[2]=n.minDepth;var c=e._tempVector31,_=c.elements;_[0]=o,_[1]=l,_[2]=n.maxDepth;var d=s.origin,m=e._tempVector32;n.unprojectFromWVP(h,i,r,a,d),n.unprojectFromWVP(c,i,r,a,m);var f=s.direction.elements;f[0]=m.x-d.x,f[1]=m.y-d.y,f[2]=m.z-d.z,rt.normalize(s.direction,s.direction)},e.rayIntersectsPositionsAndIndices=function(t,n,i,r,a){for(var s=i.vertexStride/4,o=i.getVertexElementByUsage(0).offset/4,l=Number.MAX_VALUE,h=-1,u=-1,c=-1,_=0;_<r.length;_+=3){var d=e._tempVector35,m=d.elements,f=r[_]*s,p=f+o;m[0]=n[p],m[1]=n[p+1],m[2]=n[p+2];var v=e._tempVector36,g=v.elements,x=r[_+1]*s,E=x+o;g[0]=n[E],g[1]=n[E+1],g[2]=n[E+2];var M=e._tempVector37,T=M.elements,S=r[_+2]*s,y=S+o;T[0]=n[y],T[1]=n[y+1],T[2]=n[y+2];var D=laya.d3.utils.Picker.rayIntersectsTriangle(t,d,v,M);!isNaN(D)&&D<l&&(l=D,h=f,u=x,c=S)}if(l!==Number.MAX_VALUE){a.distance=l,rt.normalize(t.direction,t.direction),rt.scale(t.direction,l,a.position),rt.add(t.origin,a.position,a.position);var R=a.trianglePositions,C=R[0],V=R[1],A=R[2],I=C.elements,b=V.elements,w=A.elements,O=h+o;I[0]=n[O],I[1]=n[O+1],I[2]=n[O+2];var N=u+o;b[0]=n[N],b[1]=n[N+1],b[2]=n[N+2];var P=c+o;w[0]=n[P],w[1]=n[P+1],w[2]=n[P+2];var L=i.getVertexElementByUsage(3);if(L){var B=L.offset/4,F=a.triangleNormals,U=F[0],z=F[1],H=F[2],G=U.elements,k=z.elements,j=H.elements,Y=h+B;G[0]=n[Y],G[1]=n[Y+1],G[2]=n[Y+2];var W=u+B;k[0]=n[W],k[1]=n[W+1],k[2]=n[W+2];var X=c+B;j[0]=n[X],j[1]=n[X+1],j[2]=n[X+2]}return!0}return a.position.toDefault(),a.distance=Number.MAX_VALUE,a.trianglePositions[0].toDefault(),a.trianglePositions[1].toDefault(),a.trianglePositions[2].toDefault(),a.triangleNormals[0].toDefault(),a.triangleNormals[1].toDefault(),a.triangleNormals[2].toDefault(),!1},e.rayIntersectsTriangle=function(t,n,i,r){var a=e._tempVector30,s=e._tempVector31;rt.subtract(i,n,a),rt.subtract(r,n,s);var o=e._tempVector32;rt.cross(t.direction,s,o);var l;if((l=rt.dot(a,o))>-Number.MIN_VALUE&&l<Number.MIN_VALUE)return Number.NaN;var h=1/l,u=e._tempVector33;rt.subtract(t.origin,n,u);var c;if(c=rt.dot(u,o),(c*=h)<0||c>1)return Number.NaN;var _=e._tempVector34;rt.cross(u,a,_);var d;if(d=rt.dot(t.direction,_),(d*=h)<0||c+d>1)return Number.NaN;var m;return m=rt.dot(s,_),(m*=h)<0?Number.NaN:m},i(e,["_tempVector30",function(){return this._tempVector30=new rt},"_tempVector31",function(){return this._tempVector31=new rt},"_tempVector32",function(){return this._tempVector32=new rt},"_tempVector33",function(){return this._tempVector33=new rt},"_tempVector34",function(){return this._tempVector34=new rt},"_tempVector35",function(){return this._tempVector35=new rt},"_tempVector36",function(){return this._tempVector36=new rt},"_tempVector37",function(){return this._tempVector37=new rt}]),e}()),ct=function(){function e(){this.distance=NaN,this.trianglePositions=null,this.triangleNormals=null,this.position=null,this.sprite3D=null,this.distance=-1,this.trianglePositions=[new rt,new rt,new rt],this.trianglePositions.length=3,this.triangleNormals=[new rt,new rt,new rt],this.triangleNormals.length=3,this.position=new rt}return r(e,"laya.d3.utils.RaycastHit"),e.prototype.cloneTo=function(e){e.distance=this.distance,this.trianglePositions[0].cloneTo(e.trianglePositions[0]),this.trianglePositions[1].cloneTo(e.trianglePositions[1]),this.trianglePositions[2].cloneTo(e.trianglePositions[2]),this.triangleNormals[0].cloneTo(e.triangleNormals[0]),this.triangleNormals[1].cloneTo(e.triangleNormals[1]),this.triangleNormals[2].cloneTo(e.triangleNormals[2]),this.position.cloneTo(e.position),e.sprite3D=this.sprite3D},e}(),_t=function(){function e(e,t){this._width=0,this._height=0,this._width=e,this._height=t}r(e,"laya.d3.utils.Size");var t=e.prototype;return a(0,t,"width",function(){return this._width===-1?oe.clientWidth:this._width}),a(0,t,"height",function(){return this._height===-1?oe.clientHeight:this._height}),a(1,e,"fullScreen",function(){return new e(-1,-1)}),e}(),dt=function(){function e(){}return r(e,"laya.d3.utils.Utils3D"),e.prototype.testTangent=function(e,t,n,i){var r=t.vertexDeclaration;if(e._material.normalTexture&&!r.getVertexElementByUsage(5)){var a=t.getData(),s=laya.d3.utils.Utils3D.generateTangent(a,r.vertexStride/4,r.getVertexElementByUsage(0).offset/4,r.getVertexElementByUsage(2).offset/4,n.getData());r=laya.d3.utils.Utils3D.getVertexTangentDeclaration(r.getVertexElements());var o=Zt.create(r,35044);return o.setData(s),t.dispose(),i[5]=o,o}return t},e._getTexturePath=function(e){var t=e.length-4;return e.indexOf(".dds")!=t&&e.indexOf(".tga")!=t&&e.indexOf(".exr")!=t&&e.indexOf(".DDS")!=t&&e.indexOf(".TGA")!=t&&e.indexOf(".EXR")!=t||(e=e.substr(0,t)+".png"),e=w.formatURL(e)},e._rotationTransformScaleSkinAnimation=function(t,n,i,r,a,s,o,l,h,u,c,_){var d=e._tempArray16_0,m=e._tempArray16_1,f=e._tempArray16_2,p=r+r,v=a+a,g=s+s,x=r*p,E=a*p,M=a*v,T=s*p,S=s*v,y=s*g,D=o*p,R=o*v,C=o*g;d[15]=1,d[0]=1-M-y,d[1]=E+C,d[2]=T-R,d[4]=E-C,d[5]=1-x-y,d[6]=S+D,d[8]=T+R,d[9]=S-D,d[10]=1-x-M,m[15]=1,m[0]=l,m[5]=h,m[10]=u;var V,A,I,b,w;for(V=0;V<4;V++)A=d[V],I=d[V+4],b=d[V+8],w=d[V+12],f[V]=A,f[V+4]=I,f[V+8]=b,f[V+12]=A*t+I*n+b*i+w;for(V=0;V<4;V++)A=f[V],I=f[V+4],b=f[V+8],w=f[V+12],c[V+_]=A*m[0]+I*m[1]+b*m[2]+w*m[3],c[V+_+4]=A*m[4]+I*m[5]+b*m[6]+w*m[7],c[V+_+8]=A*m[8]+I*m[9]+b*m[10]+w*m[11],c[V+_+12]=A*m[12]+I*m[13]+b*m[14]+w*m[15]},e._applyMeshMaterials=function(e,t){for(var n=e.meshRender,i=n.sharedMaterials,r=t.materials,a=0,s=r.length;a<s;a++)i[a]||(i[a]=r[a]);n.sharedMaterials=i},e._loadParticle=function(t,n,i){var r,a=Math.PI/180,s=0,o=0,l=t.materialPath;l?r=x.getRes(i[l]):(r=new Qt,r.diffuseTexture=i?x.getRes(i[t.texturePath]):rn.load(t.texturePath)),n.particleRender.sharedMaterial=r;var h=n.particleSystem;h.isPerformanceMode=t.isPerformanceMode,h.duration=t.duration,h.looping=t.looping,h.prewarm=t.prewarm,h.startDelayType=t.startDelayType,h.startDelay=t.startDelay,h.startDelayMin=t.startDelayMin,h.startDelayMax=t.startDelayMax,h.startLifetimeType=t.startLifetimeType,h.startLifetimeConstant=t.startLifetimeConstant,h.startLifeTimeGradient=e._initStartLife(t.startLifetimeGradient),h.startLifetimeConstantMin=t.startLifetimeConstantMin,h.startLifetimeConstantMax=t.startLifetimeConstantMax,h.startLifeTimeGradientMin=e._initStartLife(t.startLifetimeGradientMin),h.startLifeTimeGradientMax=e._initStartLife(t.startLifetimeGradientMax),h.startSpeedType=t.startSpeedType,h.startSpeedConstant=t.startSpeedConstant,h.startSpeedConstantMin=t.startSpeedConstantMin,h.startSpeedConstantMax=t.startSpeedConstantMax,h.threeDStartSize=t.threeDStartSize,h.startSizeType=t.startSizeType,h.startSizeConstant=t.startSizeConstant;var u=t.startSizeConstantSeparate,c=h.startSizeConstantSeparate.elements;c[0]=u[0],c[1]=u[1],c[2]=u[2],h.startSizeConstantMin=t.startSizeConstantMin,h.startSizeConstantMax=t.startSizeConstantMax;var _=t.startSizeConstantMinSeparate,d=h.startSizeConstantMinSeparate.elements;d[0]=_[0],d[1]=_[1],d[2]=_[2];var m=t.startSizeConstantMaxSeparate,f=h.startSizeConstantMaxSeparate.elements;f[0]=m[0],f[1]=m[1],f[2]=m[2],h.threeDStartRotation=t.threeDStartRotation,h.startRotationType=t.startRotationType,h.startRotationConstant=t.startRotationConstant*a;var p=t.startRotationConstantSeparate,v=h.startRotationConstantSeparate.elements;v[0]=p[0]*a,v[1]=p[1]*a,v[2]=p[2]*a,h.startRotationConstantMin=t.startRotationConstantMin*a,h.startRotationConstantMax=t.startRotationConstantMax*a;var g=t.startRotationConstantMinSeparate,E=h.startRotationConstantMinSeparate.elements;E[0]=g[0]*a,E[1]=g[1]*a,E[2]=g[2]*a;var M=t.startRotationConstantMaxSeparate,T=h.startRotationConstantMaxSeparate.elements;T[0]=M[0]*a,T[1]=M[1]*a,T[2]=M[2]*a,h.randomizeRotationDirection=t.randomizeRotationDirection,h.startColorType=t.startColorType;var S=t.startColorConstant,y=h.startColorConstant.elements;y[0]=S[0],y[1]=S[1],y[2]=S[2],y[3]=S[3];var D=t.startColorConstantMin,R=h.startColorConstantMin.elements;R[0]=D[0],R[1]=D[1],R[2]=D[2],R[3]=D[3];var C=t.startColorConstantMax,V=h.startColorConstantMax.elements;V[0]=C[0],V[1]=C[1],V[2]=C[2],V[3]=C[3];var A=t.gravity,I=h.gravity.elements;I[0]=A[0],I[1]=A[1],I[2]=A[2],h.gravityModifier=t.gravityModifier,h.simulationSpace=t.simulationSpace,h.scaleMode=t.scaleMode,h.playOnAwake=t.playOnAwake,h.maxParticles=t.maxParticles;var b=t.autoRandomSeed;null!=b&&(h.autoRandomSeed=b);var w=t.randomSeed;null!=w&&(h.randomSeed[0]=w);var O=t.emission,N=new H;N.emissionRate=O.emissionRate;var P=O.bursts;if(P)for(s=0,o=P.length;s<o;s++){var L=P[s];N.addBurst(new U(L.time,L.min,L.max))}N.enbale=O.enable,h.emission=N;var B,F=t.shape;switch(F.shapeType){case 0:var Y;B=Y=new St,Y.radius=F.sphereRadius,Y.emitFromShell=F.sphereEmitFromShell,Y.randomDirection=F.sphereRandomDirection;break;case 1:var W;B=W=new Tt,W.radius=F.hemiSphereRadius,W.emitFromShell=F.hemiSphereEmitFromShell,W.randomDirection=F.hemiSphereRandomDirection;break;case 2:var X;B=X=new Mt,X.angle=F.coneAngle*a,X.radius=F.coneRadius,X.length=F.coneLength,X.emitType=F.coneEmitType,X.randomDirection=F.coneRandomDirection;break;case 3:var K;B=K=new xt,K.x=F.boxX,K.y=F.boxY,K.z=F.boxZ,K.randomDirection=F.boxRandomDirection;break;case 7:var $;B=$=new Et,$.radius=F.circleRadius,$.arc=F.circleArc*a,$.emitFromEdge=F.circleEmitFromEdge,$.randomDirection=F.circleRandomDirection;break;default:var ie;B=ie=new Et,ie.radius=F.circleRadius,ie.arc=F.circleArc*a,ie.emitFromEdge=F.circleEmitFromEdge,ie.randomDirection=F.circleRandomDirection}B.enable=F.enable,h.shape=B;var re=t.velocityOverLifetime;if(re){var ae,se=re.velocity;switch(se.type){case 0:var oe=se.constant;ae=Z.createByConstant(new rt(oe[0],oe[1],oe[2]));break;case 1:ae=Z.createByGradient(e._initParticleVelocity(se.gradientX),e._initParticleVelocity(se.gradientY),e._initParticleVelocity(se.gradientZ));break;case 2:var le=se.constantMin,he=se.constantMax;ae=Z.createByRandomTwoConstant(new rt(le[0],le[1],le[2]),new rt(he[0],he[1],he[2]));break;case 3:ae=Z.createByRandomTwoGradient(e._initParticleVelocity(se.gradientXMin),e._initParticleVelocity(se.gradientXMax),e._initParticleVelocity(se.gradientYMin),e._initParticleVelocity(se.gradientYMax),e._initParticleVelocity(se.gradientZMin),e._initParticleVelocity(se.gradientZMax))}var ue=new ne(ae);ue.space=re.space,ue.enbale=re.enable,h.velocityOverLifetime=ue}var ce=t.colorOverLifetime;if(ce){var _e,de=ce.color;switch(de.type){case 0:var me=de.constant;_e=j.createByConstant(new at(me[0],me[1],me[2],me[3]));break;case 1:_e=j.createByGradient(e._initParticleColor(de.gradient));break;case 2:var fe=de.constantMin,pe=de.constantMax;_e=j.createByRandomTwoConstant(new at(fe[0],fe[1],fe[2],fe[3]),new at(pe[0],pe[1],pe[2],pe[3]));break;case 3:_e=j.createByRandomTwoGradient(e._initParticleColor(de.gradientMin),e._initParticleColor(de.gradientMax))}var ve=new z(_e);ve.enbale=ce.enable,h.colorOverLifetime=ve}var ge=t.sizeOverLifetime;if(ge){var xe,Ee=ge.size;switch(Ee.type){case 0:xe=Ee.separateAxes?q.createByGradientSeparate(e._initParticleSize(Ee.gradientX),e._initParticleSize(Ee.gradientY),e._initParticleSize(Ee.gradientZ)):q.createByGradient(e._initParticleSize(Ee.gradient));break;case 1:if(Ee.separateAxes){var Me=Ee.constantMinSeparate,Te=Ee.constantMaxSeparate;xe=q.createByRandomTwoConstantSeparate(new rt(Me[0],Me[1],Me[2]),new rt(Te[0],Te[1],Te[2]))
}else xe=q.createByRandomTwoConstant(Ee.constantMin,Ee.constantMax);break;case 2:xe=Ee.separateAxes?q.createByRandomTwoGradientSeparate(e._initParticleSize(Ee.gradientXMin),e._initParticleSize(Ee.gradientYMin),e._initParticleSize(Ee.gradientZMin),e._initParticleSize(Ee.gradientXMax),e._initParticleSize(Ee.gradientYMax),e._initParticleSize(Ee.gradientZMax)):q.createByRandomTwoGradient(e._initParticleSize(Ee.gradientMin),e._initParticleSize(Ee.gradientMax))}var Se=new J(xe);Se.enbale=ge.enable,h.sizeOverLifetime=Se}var ye=t.rotationOverLifetime;if(ye){var De,Re=ye.angularVelocity;switch(Re.type){case 0:Re.separateAxes||(De=k.createByConstant(Re.constant*a));break;case 1:Re.separateAxes||(De=k.createByGradient(e._initParticleRotation(Re.gradient)));break;case 2:Re.separateAxes||(De=k.createByRandomTwoConstant(Re.constantMin*a,Re.constantMax*a));break;case 3:Re.separateAxes||(De=k.createByRandomTwoGradient(e._initParticleRotation(Re.gradientMin),e._initParticleRotation(Re.gradientMax)))}var Ce=new Q(De);Ce.enbale=ye.enable,h.rotationOverLifetime=Ce}var Ve=t.textureSheetAnimation;if(Ve){var Ae,Ie=Ve.frame;switch(Ie.type){case 0:Ae=G.createByConstant(Ie.constant);break;case 1:Ae=G.createByOverTime(e._initParticleFrame(Ie.overTime));break;case 2:Ae=G.createByRandomTwoConstant(Ie.constantMin,Ie.constantMax);break;case 3:Ae=G.createByRandomTwoOverTime(e._initParticleFrame(Ie.overTimeMin),e._initParticleFrame(Ie.overTimeMax))}var be,we=Ve.startFrame;switch(we.type){case 0:be=ee.createByConstant(we.constant);break;case 1:be=ee.createByRandomTwoConstant(we.constantMin,we.constantMax)}var Oe=new te(Ae,be);Oe.enbale=Ve.enable;var Ne=Ve.tiles;Oe.tiles=new it(Ne[0],Ne[1]),Oe.type=Ve.type,Oe.randomRow=Ve.randomRow,Oe.cycles=Ve.cycles,h.textureSheetAnimation=Oe}var Pe=n.particleRender;Pe.renderMode=t.renderMode,Pe.stretchedBillboardCameraSpeedScale=t.stretchedBillboardCameraSpeedScale,Pe.stretchedBillboardSpeedScale=t.stretchedBillboardSpeedScale,Pe.stretchedBillboardLengthScale=t.stretchedBillboardLengthScale,Pe.sortingFudge=t.sortingFudge?t.sortingFudge:0,h.playOnAwake&&h.play()},e._parseHierarchyProp=function(t,n,i){var r=i.customProps,a=r.translate,s=n.transform.localPosition,o=s.elements;o[0]=a[0],o[1]=a[1],o[2]=a[2],n.transform.localPosition=s;var l=r.rotation,h=n.transform.localRotation,u=h.elements;u[0]=l[0],u[1]=l[1],u[2]=l[2],u[3]=l[3],n.transform.localRotation=h;var c=r.scale,_=n.transform.localScale,d=_.elements;switch(d[0]=c[0],d[1]=c[1],d[2]=c[2],n.transform.localScale=_,i.type){case"Sprite3D":break;case"MeshSprite3D":var m=n,f=m.meshRender,p=r.lightmapIndex;null!==p&&(f.lightmapIndex=p);var v=r.lightmapScaleOffset;v&&(f.lightmapScaleOffset=new at(v[0],v[1],v[2],v[3]));var g=x.getRes(t[i.instanceParams.loadPath]);m.meshFilter.sharedMesh=g,g.loaded?f.sharedMaterials=g.materials:g.once("loaded",m,m._applyMeshMaterials);break;case"ShuriKenParticle3D":var E=n;e._loadParticle(r,E,t)}},e._parseHierarchyNode=function(e){switch(e.type){case"Sprite3D":return new yt;case"MeshSprite3D":return new on;case"ShuriKenParticle3D":return new ln;default:throw new Error("Utils3D:unidentified class type in (.lh) file.")}},e._initStartLife=function(e){for(var t=new X,n=e.startLifetimes,i=0,r=n.length;i<r;i++){var a=n[i];t.add(a.key,a.value)}return t},e._initParticleVelocity=function(e){for(var t=new X,n=e.velocitys,i=0,r=n.length;i<r;i++){var a=n[i];t.add(a.key,a.value)}return t},e._initParticleColor=function(e){var t=new Y,n=e.alphas,i=0,r=0;for(i=0,r=n.length;i<r;i++){var a=n[i];t.addAlpha(a.key,a.value)}var s=e.rgbs;for(i=0,r=s.length;i<r;i++){var o=s[i],l=o.value;t.addRGB(o.key,new rt(l[0],l[1],l[2]))}return t},e._initParticleSize=function(e){for(var t=new X,n=e.sizes,i=0,r=n.length;i<r;i++){var a=n[i];t.add(a.key,a.value)}return t},e._initParticleRotation=function(e){for(var t=new X,n=e.angularVelocitys,i=0,r=n.length;i<r;i++){var a=n[i];t.add(a.key,a.value/180*Math.PI)}return t},e._initParticleFrame=function(e){for(var t=new W,n=e.frames,i=0,r=n.length;i<r;i++){var a=n[i];t.add(a.key,a.value)}return t},e._computeBoneAndAnimationDatas=function(e,t,n,i,r){var a,s,o=0,l=0,h=n.length/2,u=e.length;for(a=0;a<u;o+=e[a].keyframeWidth,l+=16,a++)laya.d3.utils.Utils3D._rotationTransformScaleSkinAnimation(t[o+7],t[o+8],t[o+9],t[o+3],t[o+4],t[o+5],t[o+6],t[o+0],t[o+1],t[o+2],i,l),0!=a&&(s=16*e[a].parentIndex,laya.d3.utils.Utils3D.mulMatrixByArray(i,s,i,l,i,l));for(a=0;a<h;a+=16)laya.d3.utils.Utils3D.mulMatrixByArrayFast(i,a,n,h+a,r,a)},e._computeAnimationDatas=function(e,t,n){for(var i=e.length/2,r=0;r<i;r+=16)laya.d3.utils.Utils3D.mulMatrixByArrayFast(t,r,e,i+r,n,r)},e._computeBoneAndAnimationDatasByBindPoseMatrxix=function(e,t,n,i,r){var a,s,o=0,l=0,h=e.length;for(a=0;a<h;o+=e[a].keyframeWidth,l+=16,a++)laya.d3.utils.Utils3D._rotationTransformScaleSkinAnimation(t[o+7],t[o+8],t[o+9],t[o+3],t[o+4],t[o+5],t[o+6],t[o+0],t[o+1],t[o+2],i,l),0!=a&&(s=16*e[a].parentIndex,laya.d3.utils.Utils3D.mulMatrixByArray(i,s,i,l,i,l));var u=n.length;for(a=0;a<u;a++){var c=16*a;laya.d3.utils.Utils3D.mulMatrixByArrayAndMatrixFast(i,c,n[a],r,c)}},e._computeAnimationDatasByArrayAndMatrixFast=function(e,t,n){for(var i=e.length,r=0;r<i;r++){var a=16*r;laya.d3.utils.Utils3D.mulMatrixByArrayAndMatrixFast(t,a,e[r],n,a)}},e._computeRootAnimationData=function(e,t,n){for(var i=0,r=0,a=0,s=e.length;i<s;r+=e[i].keyframeWidth,a+=16,i++)laya.d3.utils.Utils3D.createAffineTransformationArray(t[r+0],t[r+1],t[r+2],t[r+3],t[r+4],t[r+5],t[r+6],t[r+7],t[r+8],t[r+9],n,a)},e.generateTangent=function(t,n,i,r,a){for(var s=n+3,o=new Float32Array(s*(t.length/n)),l=0;l<a.length;l+=3){var h=a[l+0],u=a[l+1],c=a[l+2],_=n*h+i,d=e._tempVector3_0;d.x=t[_+0],d.y=t[_+1],d.z=t[_+2];var m=n*u+i,f=e._tempVector3_1;f.x=t[m+0],f.y=t[m+1],f.z=t[m+2];var p=n*c+i,v=e._tempVector3_2;v.x=t[p+0],v.y=t[p+1],v.z=t[p+2];var g=n*h+r,x=t[g+0],E=t[g+1],M=n*u+r,T=t[M+0],S=t[M+1],y=n*c+r,D=t[y+0],R=t[y+1],C=e._tempVector3_3;rt.subtract(f,d,C);var V=e._tempVector3_4;rt.subtract(v,d,V),rt.scale(C,R-E,C),rt.scale(V,S-E,V);var A=e._tempVector3_5;rt.subtract(C,V,A),rt.scale(A,1/((T-x)*(R-E)-(S-E)*(D-x)),A);var I=0;for(I=0;I<n;I++)o[s*h+I]=t[n*h+I];for(I=0;I<3;I++)o[s*h+n+I]=+A.elements[I];for(I=0;I<n;I++)o[s*u+I]=t[n*u+I];for(I=0;I<3;I++)o[s*u+n+I]=+A.elements[I];for(I=0;I<n;I++)o[s*c+I]=t[n*c+I];for(I=0;I<3;I++)o[s*c+n+I]=+A.elements[I]}for(l=0;l<o.length;l+=s){var b=s*l+n,w=e._tempVector3_6;w.x=o[b+0],w.y=o[b+1],w.z=o[b+2],rt.normalize(w,w),o[b+0]=w.x,o[b+1]=w.y,o[b+2]=w.z}return o},e.getVertexTangentDeclaration=function(e){for(var t=!1,n=!1,i=!1,r=!1,a=!1,s=!1,o=!1,l=0;l<e.length;l++)switch(e[l].elementUsage){case"POSITION":t=!0;break;case"NORMAL":n=!0;break;case"COLOR":i=!0;break;case"UV":r=!0;break;case"UV1":a=!0;break;case"BLENDWEIGHT":s=!0;break;case"BLENDINDICES":o=!0}var h;return t&&n&&i&&r&&a&&s&&o&&(h=Ve.vertexDeclaration),t&&n&&i&&r&&s&&o?h=be.vertexDeclaration:t&&n&&r&&a&&s&&o?h=Le.vertexDeclaration:t&&n&&r&&s&&o?h=Ue.vertexDeclaration:t&&n&&i&&s&&o?h=Se.vertexDeclaration:t&&n&&i&&r&&a?h=Ae.vertexDeclaration:t&&n&&i&&r?h=we.vertexDeclaration:t&&n&&r&&a?h=Be.vertexDeclaration:t&&n&&r?h=ze.vertexDeclaration:t&&n&&i&&(h=ye.vertexDeclaration),h},e.transformVector3ArrayByQuat=function(e,t,n,i,r){var a=n.elements,s=e[t],o=e[t+1],l=e[t+2],h=a[0],u=a[1],c=a[2],_=a[3],d=_*s+u*l-c*o,m=_*o+c*s-h*l,f=_*l+h*o-u*s,p=-h*s-u*o-c*l;i[r]=d*_+p*-h+m*-c-f*-u,i[r+1]=m*_+p*-u+f*-h-d*-c,i[r+2]=f*_+p*-c+d*-u-m*-h},e.mulMatrixByArray=function(t,n,i,r,a,s){var o,l,h,u,c;if(a===i){for(i=e._tempArray16_3,o=0;o<16;++o)i[o]=a[s+o];r=0}for(o=0;o<4;o++)l=t[n+o],h=t[n+o+4],u=t[n+o+8],c=t[n+o+12],a[s+o]=l*i[r+0]+h*i[r+1]+u*i[r+2]+c*i[r+3],a[s+o+4]=l*i[r+4]+h*i[r+5]+u*i[r+6]+c*i[r+7],a[s+o+8]=l*i[r+8]+h*i[r+9]+u*i[r+10]+c*i[r+11],a[s+o+12]=l*i[r+12]+h*i[r+13]+u*i[r+14]+c*i[r+15]},e.mulMatrixByArrayFast=function(e,t,n,i,r,a){var s,o,l,h,u;for(s=0;s<4;s++)o=e[t+s],l=e[t+s+4],h=e[t+s+8],u=e[t+s+12],r[a+s]=o*n[i+0]+l*n[i+1]+h*n[i+2]+u*n[i+3],r[a+s+4]=o*n[i+4]+l*n[i+5]+h*n[i+6]+u*n[i+7],r[a+s+8]=o*n[i+8]+l*n[i+9]+h*n[i+10]+u*n[i+11],r[a+s+12]=o*n[i+12]+l*n[i+13]+h*n[i+14]+u*n[i+15]},e.mulMatrixByArrayAndMatrixFast=function(e,t,n,i,r){var a,s,o,l,h,u=n.elements,c=u[0],_=u[1],d=u[2],m=u[3],f=u[4],p=u[5],v=u[6],g=u[7],x=u[8],E=u[9],M=u[10],T=u[11],S=u[12],y=u[13],D=u[14],R=u[15],C=t,V=t+4,A=t+8,I=t+12,b=r,w=r+4,O=r+8,N=r+12;for(a=0;a<4;a++)s=e[C+a],o=e[V+a],l=e[A+a],h=e[I+a],i[b+a]=s*c+o*_+l*d+h*m,i[w+a]=s*f+o*p+l*v+h*g,i[O+a]=s*x+o*E+l*M+h*T,i[N+a]=s*S+o*y+l*D+h*R},e.createAffineTransformationArray=function(e,t,n,i,r,a,s,o,l,h,u,c){var _=i+i,d=r+r,m=a+a,f=i*_,p=i*d,v=i*m,g=r*d,x=r*m,E=a*m,M=s*_,T=s*d,S=s*m;u[c+0]=(1-(g+E))*o,u[c+1]=(p+S)*o,u[c+2]=(v-T)*o,u[c+3]=0,u[c+4]=(p-S)*l,u[c+5]=(1-(f+E))*l,u[c+6]=(x+M)*l,u[c+7]=0,u[c+8]=(v+T)*h,u[c+9]=(x-M)*h,u[c+10]=(1-(f+g))*h,u[c+11]=0,u[c+12]=e,u[c+13]=t,u[c+14]=n,u[c+15]=1},e.transformVector3ArrayToVector3ArrayCoordinate=function(t,n,i,r,a){var s=e._tempArray4_0,o=t[n+0],l=t[n+1],h=t[n+2],u=i.elements;s[0]=o*u[0]+l*u[4]+h*u[8]+u[12],s[1]=o*u[1]+l*u[5]+h*u[9]+u[13],s[2]=o*u[2]+l*u[6]+h*u[10]+u[14],s[3]=1/(o*u[3]+l*u[7]+h*u[11]+u[15]),r[a+0]=s[0]*s[3],r[a+1]=s[1]*s[3],r[a+2]=s[2]*s[3]},e.transformLightingMapTexcoordArray=function(e,t,n,i,r){var a=n.elements;i[r+0]=e[t+0]*a[0]+a[2],i[r+1]=1+e[t+1]*a[1]+a[3]},e.convert3DCoordTo2DScreenCoord=function(e,t){var n=e.elements,i=t.elements;i[0]=-oe.clientWidth/2+n[0],i[1]=oe.clientHeight/2-n[1],i[2]=n[2]},e.getURLVerion=function(e){var t=e.indexOf("?");return t>=0?e.substr(t):null},e._tempVector3_0=new rt,e._tempVector3_1=new rt,e._tempVector3_2=new rt,e._tempVector3_3=new rt,e._tempVector3_4=new rt,e._tempVector3_5=new rt,e._tempVector3_6=new rt,e._tempArray4_0=new Float32Array(4),e._tempArray16_0=new Float32Array(16),e._tempArray16_1=new Float32Array(16),e._tempArray16_2=new Float32Array(16),e._tempArray16_3=new Float32Array(16),i(e,["_typeToFunO",function(){return this._typeToFunO={INT16:"writeInt16",SHORT:"writeInt16",UINT16:"writeUint16",UINT32:"writeUint32",FLOAT32:"writeFloat32",INT:"writeInt32",UINT:"writeUint32",BYTE:"writeByte",STRING:"writeUTFString"}}]),e}(),mt=function(){function e(){}return r(e,"Laya3D"),e._changeWebGLSize=function(e,t){N.onStageResize(e,t),oe.clientWidth=e,oe.clientHeight=t},e._initShader=function(){kt.addInclude("LightHelper.glsl","\nstruct DirectionLight\n{\n vec3 Direction;\n vec3 Diffuse;\n vec3 Ambient;\n vec3 Specular;\n};\n\nstruct PointLight\n{\n vec3 Diffuse;\n vec3 Ambient;\n vec3 Specular;\n vec3 Attenuation;\n vec3 Position;\n float Range;\n};\n\nstruct SpotLight\n{\n vec3 Diffuse;\n vec3 Ambient;\n vec3 Specular;\n vec3 Attenuation;\n vec3 Position;\n vec3 Direction;\n float Spot;\n float Range;\n};\n\n\nvoid  computeDirectionLight(in vec3 matDif,in vec3 matAmb,in vec4 matSpe,in DirectionLight dirLight,in vec3 normal,in vec3 toEye,out vec3 dif,out vec3 amb,out vec3 spec)\n{\n\tdif=vec3(0.0);//不初始化在IOS中闪烁，PC中不会闪烁\n\tamb=vec3(0.0);\n\tspec=vec3(0.0);\n\tvec3 lightVec=-normalize(dirLight.Direction);\n\t\n\tamb=matAmb*dirLight.Ambient;\n\t\n\tfloat  diffuseFactor=dot(lightVec, normal);\n\t\n\tif(diffuseFactor>0.0)\n\t{\n\t   vec3 v = reflect(-lightVec, normal);\n\t   float specFactor = pow(max(dot(v, toEye), 0.0), matSpe.w);\n\t   \n\t   dif = diffuseFactor * matDif * dirLight.Diffuse;\n\t   spec = specFactor * matSpe.rgb * dirLight.Specular;\n\t}\n\t\n}\n\nvoid computePointLight(in vec3 matDif,in vec3 matAmb,in vec4 matSpe,in PointLight poiLight, in vec3 pos,in vec3 normal,in vec3 toEye,out vec3 dif,out vec3 amb,out vec3 spec)\n{\n\tdif=vec3(0.0);\n\tamb=vec3(0.0);\n\tspec=vec3(0.0);\n\tvec3 lightVec = poiLight.Position - pos;\n\t\t\n\tfloat d = length(lightVec);\n\t\n\tif( d > poiLight.Range )\n\t\treturn;\n\t\t\n\tlightVec /= d; \n\t\n\tamb = matAmb * poiLight.Ambient;\t\n\n\tfloat diffuseFactor = dot(lightVec, normal);\n\n\tif( diffuseFactor > 0.0 )\n\t{\n\t\tvec3 v= reflect(-lightVec, normal);\n\t\tfloat specFactor = pow(max(dot(v, toEye), 0.0), matSpe.w);\n\t\t\t\t\t\n\t\tdif = diffuseFactor * matDif * poiLight.Diffuse;\n\t\tspec = specFactor * matSpe.rgb * poiLight.Specular;\n\t}\n\n\tfloat attenuate = 1.0 / dot(poiLight.Attenuation, vec3(1.0, d, d*d));\n\n\tdif *= attenuate;\n\tspec*= attenuate;\n}\n\nvoid ComputeSpotLight(in vec3 matDif,in vec3 matAmb,in vec4 matSpe,in SpotLight spoLight,in vec3 pos, in vec3 normal,in vec3 toEye,out vec3 dif,out vec3 amb,out vec3 spec)\n{\n\tamb = vec3(0.0);\n\tdif =vec3(0.0);\n\tspec= vec3(0.0);\n\tvec3 lightVec = spoLight.Position - pos;\n\t\t\n\tfloat d = length(lightVec);\n\t\n\tif( d > spoLight.Range)\n\t\treturn;\n\t\t\n\tlightVec /= d; \n\t\n\tamb = matAmb * spoLight.Ambient;\t\n\n\tfloat diffuseFactor = dot(lightVec, normal);\n\n\tif(diffuseFactor > 0.0)\n\t{\n\t\tvec3 v= reflect(-lightVec, normal);\n\t\tfloat specFactor = pow(max(dot(v, toEye), 0.0), matSpe.w);\n\t\t\t\t\t\n\t\tdif = diffuseFactor * matDif * spoLight.Diffuse;\n\t\tspec = specFactor * matSpe.rgb * spoLight.Specular;\n\t}\n\t\n\tfloat spot = pow(max(dot(-lightVec, normalize(spoLight.Direction)), 0.0), spoLight.Spot);\n\n\tfloat attenuate = spot/dot(spoLight.Attenuation, vec3(1.0, d, d*d));\n\n\tamb *= spot;\n\tdif *= attenuate;\n\tspec*= attenuate;\n}\n\nvec3 NormalSampleToWorldSpace(vec3 normalMapSample, vec3 unitNormal, vec3 tangent)\n{\n\tvec3 normalT = 2.0*normalMapSample - 1.0;\n\n\t// Build orthonormal basis.\n\tvec3 N = normalize(unitNormal);\n\tvec3 T = normalize(tangent- dot(tangent, N)*N);\n\tvec3 B = cross(T, N);\n\n\tmat3 TBN = mat3(T, B, N);\n\n\t// Transform from tangent space to world space.\n\tvec3 bumpedNormal = TBN*normalT;\n\n\treturn bumpedNormal;\n}\n"),kt.addInclude("VRHelper.glsl","\nvec4 DistortFishEye(vec4 p)\n{\n    vec2 v = p.xy / p.w;\n    float radius = length(v);// Convert to polar coords\n    if (radius > 0.0)\n    {\n      float theta = atan(v.y,v.x);\n      \n      radius = pow(radius, 0.93);// Distort:\n\n      v.x = radius * cos(theta);// Convert back to Cartesian\n      v.y = radius * sin(theta);\n      p.xy = v.xy * p.w;\n    }\n    return p;\n}");var e,t,n={a_Position:0,a_Color:1,a_Normal:3,a_Texcoord0:2,a_Texcoord1:15,a_TexcoordNext0:14,a_BoneWeights:7,a_BoneIndices:6,a_Tangent0:5},i={u_Bones:[0,0],u_DiffuseTexture:[0,1],u_SpecularTexture:[2,1],u_NormalTexture:[1,1],u_AmbientTexture:[4,1],u_ReflectTexture:[5,1],u_Albedo:[6,1],u_AlphaTestValue:[7,1],u_UVMatrix:[13,1],u_UVAge:[14,1],u_UVAniAge:[8,1],u_MaterialDiffuse:[10,1],u_MaterialAmbient:[9,1],u_MaterialSpecular:[11,1],u_MaterialReflect:[12,1],u_WorldMat:[0,2],u_MvpMatrix:[1,2],u_LightmapScaleOffset:[2,2],u_CameraPos:[0,3],u_FogStart:[1,4],u_FogRange:[2,4],u_FogColor:[0,4],"u_DirectionLight.Direction":[3,4],"u_DirectionLight.Diffuse":[4,4],"u_DirectionLight.Ambient":[5,4],"u_DirectionLight.Specular":[6,4],"u_PointLight.Position":[7,4],"u_PointLight.Range":[8,4],"u_PointLight.Attenuation":[9,4],"u_PointLight.Diffuse":[10,4],"u_PointLight.Ambient":[11,4],"u_PointLight.Specular":[12,4],"u_SpotLight.Position":[13,4],"u_SpotLight.Direction":[14,4],"u_SpotLight.Range":[16,4],"u_SpotLight.Spot":[15,4],"u_SpotLight.Attenuation":[17,4],"u_SpotLight.Diffuse":[18,4],"u_SpotLight.Ambient":[19,4],"u_SpotLight.Specular":[20,4]},r=kt.nameKey.add("SIMPLE");e='#include?VR "VRHelper.glsl";\nattribute vec4 a_Position;\nuniform mat4 u_MvpMatrix;\n\n\n\n#if defined(DIFFUSEMAP)||((defined(DIRECTIONLIGHT)||defined(POINTLIGHT)||defined(SPOTLIGHT))&&(defined(COLOR)&&defined(SPECULARMAP)||defined(NORMALMAP)))\nattribute vec2 a_Texcoord0;\nvarying vec2 v_Texcoord0;\n  #ifdef MIXUV\n  attribute vec2 a_TexcoordNext0;\n  uniform float  u_UVAge;\n  #endif\n  #ifdef UVTRANSFORM \n  uniform mat4 u_UVMatrix;\n  #endif\n#endif\n\n#ifdef AMBIENTMAP\nattribute vec2 a_Texcoord1;\nuniform vec4 u_LightmapScaleOffset;\nvarying vec2 v_Texcoord1;\n#endif\n\n#ifdef COLOR\nattribute vec4 a_Color;\nvarying vec4 v_Color;\n#endif\n\n#ifdef BONE\nattribute vec4 a_BoneIndices;\nattribute vec4 a_BoneWeights;\nconst int c_MaxBoneCount = 24;\nuniform mat4 u_Bones[c_MaxBoneCount];\n#endif\n\n#if defined(DIRECTIONLIGHT)||defined(POINTLIGHT)||defined(SPOTLIGHT)||defined(REFLECTMAP)\nattribute vec3 a_Normal;\nvarying vec3 v_Normal;\n#endif\n\n#if (defined(DIRECTIONLIGHT)||defined(POINTLIGHT)||defined(SPOTLIGHT)||defined(REFLECTMAP))&&defined(NORMALMAP)\nattribute vec3 a_Tangent0;\nvarying vec3 v_Tangent0;\n#endif\n\n#if defined(DIRECTIONLIGHT)||defined(POINTLIGHT)||defined(SPOTLIGHT)||defined(FOG)||defined(REFLECTMAP)\nuniform mat4 u_WorldMat;\nvarying vec3 v_PositionWorld;\n#endif\n\n\nvoid main()\n{\n #ifdef BONE\n mat4 skinTransform=mat4(0.0);\n skinTransform += u_Bones[int(a_BoneIndices.x)] * a_BoneWeights.x;\n skinTransform += u_Bones[int(a_BoneIndices.y)] * a_BoneWeights.y;\n skinTransform += u_Bones[int(a_BoneIndices.z)] * a_BoneWeights.z;\n skinTransform += u_Bones[int(a_BoneIndices.w)] * a_BoneWeights.w;\n vec4 position=skinTransform*a_Position;\n   #ifdef VR\n   gl_Position = DistortFishEye(u_MvpMatrix * position);\n   #else\n   gl_Position = u_MvpMatrix * position;\n   #endif\n #else\n   #ifdef VR\n   gl_Position = DistortFishEye(u_MvpMatrix * a_Position);\n   #else\n   gl_Position = u_MvpMatrix * a_Position;\n   #endif\n #endif\n \n\n #if defined(DIRECTIONLIGHT)||defined(POINTLIGHT)||defined(SPOTLIGHT)||defined(REFLECTMAP)\n mat3 worldMat;\n   #ifdef BONE\n   worldMat=mat3(u_WorldMat*skinTransform);\n   #else\n   worldMat=mat3(u_WorldMat);\n   #endif  \n v_Normal=worldMat*a_Normal;\n   #if (defined(DIRECTIONLIGHT)||defined(POINTLIGHT)||defined(SPOTLIGHT))&&defined(NORMALMAP)\n   v_Tangent0=worldMat*a_Tangent0;\n   #endif\n #endif\n \n #if defined(DIRECTIONLIGHT)||defined(POINTLIGHT)||defined(SPOTLIGHT)||defined(FOG)\n   #ifdef BONE\n   v_PositionWorld=(u_WorldMat*position).xyz;\n   #else\n   v_PositionWorld=(u_WorldMat*a_Position).xyz;\n   #endif\n #endif\n \n#if defined(DIFFUSEMAP)||((defined(DIRECTIONLIGHT)||defined(POINTLIGHT)||defined(SPOTLIGHT))&&(defined(COLOR)&&defined(SPECULARMAP)||defined(NORMALMAP)))\n  #ifdef MIXUV\n  v_Texcoord0=mix(a_Texcoord0,a_TexcoordNext0,u_UVAge);\n  #else\n  v_Texcoord0=a_Texcoord0;\n  #endif\n  #ifdef UVTRANSFORM\n  v_Texcoord0=(u_UVMatrix*vec4(v_Texcoord0,0.0,1.0)).xy;\n  #endif\n#endif\n\n#ifdef AMBIENTMAP\n  #ifdef SCALEOFFSETLIGHTINGMAPUV\n  v_Texcoord1=vec2(a_Texcoord1.x*u_LightmapScaleOffset.x+u_LightmapScaleOffset.z,1.0+a_Texcoord1.y*u_LightmapScaleOffset.y+u_LightmapScaleOffset.w);\n  #else\n  v_Texcoord1=a_Texcoord1;\n  #endif \n#endif\n\n  \n#ifdef COLOR\nv_Color=a_Color;\n#endif\n}',t='#ifdef FSHIGHPRECISION\nprecision highp float;\n#else\nprecision mediump float;\n#endif\n\n#include?DIRECTIONLIGHT||POINTLIGHT||SPOTLIGHT "LightHelper.glsl";\n\nuniform vec4 u_Albedo;\n\n#ifdef ALPHATEST\nuniform float u_AlphaTestValue;\n#endif\n\n#ifdef DIFFUSEMAP\nuniform sampler2D u_DiffuseTexture;\n#endif\n\n#ifdef REFLECTMAP\nuniform samplerCube u_ReflectTexture;\nuniform vec3 u_MaterialReflect;\n#endif\n\n#if   defined(DIFFUSEMAP)||((defined(DIRECTIONLIGHT)||defined(POINTLIGHT)||defined(SPOTLIGHT))&&(defined(COLOR)&&defined(SPECULARMAP)||defined(NORMALMAP)))\nvarying vec2 v_Texcoord0;\n#endif\n\n#ifdef AMBIENTMAP\nvarying vec2 v_Texcoord1;\nuniform sampler2D u_AmbientTexture;\n#endif\n\n#ifdef COLOR\nvarying vec4 v_Color;\n#endif\n\n#if defined(DIRECTIONLIGHT)||defined(POINTLIGHT)||defined(SPOTLIGHT)\nuniform vec3 u_MaterialDiffuse;\nuniform vec4 u_MaterialSpecular;\n  #if (defined(DIFFUSEMAP)||defined(COLOR))&&defined(SPECULARMAP) \n  uniform sampler2D u_SpecularTexture;\n  #endif\n#endif\n\n#if defined(DIRECTIONLIGHT)||defined(POINTLIGHT)||defined(SPOTLIGHT)||defined(AMBIENTMAP)\nuniform vec3 u_MaterialAmbient;\n#endif\n\n#ifdef FOG\nuniform float u_FogStart;\nuniform float u_FogRange;\nuniform vec3 u_FogColor;\n#endif\n\n#ifdef MIXUV\nuniform float  u_UVAniAge;\n#endif\n\n\n#if defined(DIRECTIONLIGHT)||defined(POINTLIGHT)||defined(SPOTLIGHT)||defined(REFLECTMAP)\nvarying vec3 v_Normal;\n#endif\n\n#if (defined(DIRECTIONLIGHT)||defined(POINTLIGHT)||defined(SPOTLIGHT))&&defined(NORMALMAP)\nuniform sampler2D u_NormalTexture;\nvarying vec3 v_Tangent0;\n#endif\n\n#ifdef DIRECTIONLIGHT\nuniform DirectionLight u_DirectionLight;\n#endif\n\n#ifdef POINTLIGHT\nuniform PointLight u_PointLight;\n#endif\n\n#ifdef SPOTLIGHT\nuniform SpotLight u_SpotLight;\n#endif\n\n\n#if defined(DIRECTIONLIGHT)||defined(POINTLIGHT)||defined(SPOTLIGHT)||defined(FOG)||defined(REFLECTMAP)\nuniform vec3 u_CameraPos;\nvarying vec3 v_PositionWorld;\n#endif\n\n\nvoid main()\n{\n  #if defined(DIFFUSEMAP)&&!defined(COLOR)\n  gl_FragColor=texture2D(u_DiffuseTexture, v_Texcoord0);\n  #endif \n  \n  #if defined(COLOR)&&!defined(DIFFUSEMAP)\n  gl_FragColor=v_Color;\n  #endif \n  \n  #if defined(DIFFUSEMAP)&&defined(COLOR)\n  vec4 texColor=texture2D(u_DiffuseTexture, v_Texcoord0);\n  gl_FragColor=texColor*v_Color;\n  #endif\n  \n  #if !defined(DIFFUSEMAP)&&!defined(COLOR)\n  gl_FragColor=vec4(1.0,1.0,1.0,1.0);\n  #endif \n  \n  #ifdef AMBIENTMAP\n  gl_FragColor.rgb=gl_FragColor.rgb*(u_MaterialAmbient+texture2D(u_AmbientTexture, v_Texcoord1).rgb); \n  #endif \n  \n  gl_FragColor=gl_FragColor*u_Albedo;\n  \n  #ifdef ALPHATEST\n  if(gl_FragColor.a-u_AlphaTestValue<0.0)\n    discard;\n  #endif\n  \n  \n  #if defined(DIRECTIONLIGHT)||defined(POINTLIGHT)||defined(SPOTLIGHT)||defined(REFLECTMAP)\n  vec3 normal;\n    #if (defined(DIRECTIONLIGHT)||defined(POINTLIGHT)||defined(SPOTLIGHT))&&defined(NORMALMAP)\n    vec3 normalMapSample = texture2D(u_NormalTexture, v_Texcoord0).rgb;\n\tnormal = normalize(NormalSampleToWorldSpace(normalMapSample, v_Normal, v_Tangent0));\n\t#else\n\tnormal = normalize(v_Normal);\n    #endif\n  #endif\n\t\n  #if defined(DIRECTIONLIGHT)||defined(POINTLIGHT)||defined(SPOTLIGHT)\n  vec3 diffuse = vec3(0.0);\n  vec3 ambient = vec3(0.0);\n  vec3 specular= vec3(0.0);\n  vec3 dif, amb, spe;\n  #endif\n  \n  #if defined(DIRECTIONLIGHT)||defined(POINTLIGHT)||defined(SPOTLIGHT)||defined(FOG)||defined(REFLECTMAP)\n  vec3 toEye;\n    #ifdef FOG\n\ttoEye=u_CameraPos-v_PositionWorld;\n    float toEyeLength=length(toEye);\n    toEye/=toEyeLength;\n    #else\n\ttoEye=normalize(u_CameraPos-v_PositionWorld);\n    #endif\n  #endif\n\t\n  #ifdef DIRECTIONLIGHT\n  computeDirectionLight(u_MaterialDiffuse,u_MaterialAmbient,u_MaterialSpecular,u_DirectionLight,normal,toEye, dif, amb, spe);\n  diffuse+=dif;\n  ambient+=amb;\n  specular+=spe;\n  #endif\n \n  #ifdef POINTLIGHT\n  computePointLight(u_MaterialDiffuse,u_MaterialAmbient,u_MaterialSpecular,u_PointLight,v_PositionWorld,normal,toEye, dif, amb, spe);\n  diffuse+=dif;\n  ambient+=amb;\n  specular+=spe;\n  #endif\n\n  #ifdef SPOTLIGHT\n  ComputeSpotLight(u_MaterialDiffuse,u_MaterialAmbient,u_MaterialSpecular,u_SpotLight,v_PositionWorld,normal,toEye, dif, amb, spe);\n  diffuse+=dif;\n  ambient+=amb;\n  specular+=spe;\n  #endif\n\n  \n  #if defined(DIRECTIONLIGHT)||defined(POINTLIGHT)||defined(SPOTLIGHT)\n    #if (defined(DIFFUSEMAP)||defined(COLOR))&&defined(SPECULARMAP)\n    specular =specular*texture2D(u_SpecularTexture, v_Texcoord0).rgb;\n    #endif\n  gl_FragColor =vec4( gl_FragColor.rgb*(ambient + diffuse) + specular,gl_FragColor.a);\n  #endif\n  \n  #ifdef REFLECTMAP\n  vec3 incident = -toEye;\n  vec3 reflectionVector = reflect(incident,normal);\n  vec3 reflectionColor  = textureCube(u_ReflectTexture,reflectionVector).rgb;\n  gl_FragColor.rgb += u_MaterialReflect*reflectionColor;\n  #endif\n  \n  #ifdef FOG\n  float lerpFact=clamp((toEyeLength-u_FogStart)/u_FogRange,0.0,1.0);\n  gl_FragColor.rgb=mix(gl_FragColor.rgb,u_FogColor,lerpFact);\n  #endif\n}\n\n';var a=lt.add(r,e,t,n,i);Xt.SHADERDEFINE_DIFFUSEMAP=a.registerDefine("DIFFUSEMAP"),Xt.SHADERDEFINE_NORMALMAP=a.registerDefine("NORMALMAP"),Xt.SHADERDEFINE_SPECULARMAP=a.registerDefine("SPECULARMAP"),Xt.SHADERDEFINE_EMISSIVEMAP=a.registerDefine("EMISSIVEMAP"),Xt.SHADERDEFINE_AMBIENTMAP=a.registerDefine("AMBIENTMAP"),Xt.SHADERDEFINE_REFLECTMAP=a.registerDefine("REFLECTMAP"),Xt.SHADERDEFINE_SCALEOFFSETLIGHTINGMAPUV=a.registerDefine("SCALEOFFSETLIGHTINGMAPUV"),Xt.SHADERDEFINE_ALPHATEST=a.registerDefine("ALPHATEST"),Xt.SHADERDEFINE_UVTRANSFORM=a.registerDefine("UVTRANSFORM");var s=kt.nameKey.add("SIMPLEVEXTEX");e='#include?DIRECTIONLIGHT||POINTLIGHT||SPOTLIGHT "LightHelper.glsl";\n\nattribute vec4 a_Position;\nuniform mat4 u_MvpMatrix;\n\n#include?VR "VRHelper.glsl";\n\n\n\n#if defined(DIFFUSEMAP)||((defined(DIRECTIONLIGHT)||defined(POINTLIGHT)||defined(SPOTLIGHT))&&defined(COLOR)&&defined(SPECULARMAP))\nattribute vec2 a_Texcoord0;\nvarying vec2 v_Texcoord0;\n  #ifdef MIXUV\n  attribute vec2 a_TexcoordNext0;\n  uniform float  u_UVAge;\n  #endif\n  #ifdef UVTRANSFORM\n  uniform mat4 u_UVMatrix;\n  #endif\n#endif\n\n#ifdef AMBIENTMAP\nattribute vec2 a_Texcoord1;\nuniform vec4 u_LightmapScaleOffset;\nvarying vec2 v_Texcoord1;\n#endif\n\n\n#ifdef COLOR\nattribute vec4 a_Color;\nvarying vec4 v_Color;\n#endif\n\n#ifdef BONE\nattribute vec4 a_BoneIndices;\nattribute vec4 a_BoneWeights;\nconst int c_MaxBoneCount = 24;\nuniform mat4 u_Bones[c_MaxBoneCount];\n#endif\n\n#if defined(DIRECTIONLIGHT)||defined(POINTLIGHT)||defined(SPOTLIGHT)||defined(REFLECTMAP)\nattribute vec3 a_Normal;\n#endif\n\n#if defined(DIRECTIONLIGHT)||defined(POINTLIGHT)||defined(SPOTLIGHT)||defined(FOG)||defined(REFLECTMAP)\nuniform mat4 u_WorldMat;\nuniform vec3 u_CameraPos;\n#endif\n\n#ifdef DIRECTIONLIGHT\nuniform DirectionLight u_DirectionLight;\n#endif\n\n#ifdef POINTLIGHT\nuniform PointLight u_PointLight;\n#endif\n\n#ifdef SPOTLIGHT\nuniform SpotLight u_SpotLight;\n#endif\n\n#if defined(DIRECTIONLIGHT)||defined(POINTLIGHT)||defined(SPOTLIGHT)\nuniform vec3 u_MaterialDiffuse;\nuniform vec4 u_MaterialSpecular;\n\nvarying vec3 v_Diffuse;\nvarying vec3 v_Ambient;\nvarying vec3 v_Specular;\n#endif\n\n#if defined(DIRECTIONLIGHT)||defined(POINTLIGHT)||defined(SPOTLIGHT)||defined(AMBIENTMAP)\nuniform vec3 u_MaterialAmbient;\n#endif\n\n#ifdef FOG\nvarying float v_ToEyeLength;\n#endif\n\n#ifdef REFLECTMAP\nvarying vec3 v_ToEye;\nvarying vec3 v_Normal;\n#endif\n\n\nvoid main()\n{\n #ifdef BONE\n mat4 skinTransform=mat4(0.0);\n skinTransform += u_Bones[int(a_BoneIndices.x)] * a_BoneWeights.x;\n skinTransform += u_Bones[int(a_BoneIndices.y)] * a_BoneWeights.y;\n skinTransform += u_Bones[int(a_BoneIndices.z)] * a_BoneWeights.z;\n skinTransform += u_Bones[int(a_BoneIndices.w)] * a_BoneWeights.w;\n vec4 position=skinTransform*a_Position;\n   #ifdef VR\n   gl_Position = DistortFishEye(u_MvpMatrix * position);\n   #else\n   gl_Position = u_MvpMatrix * position;\n   #endif\n #else\n   #ifdef VR\n   gl_Position = DistortFishEye(u_MvpMatrix * a_Position);\n   #else\n   gl_Position = u_MvpMatrix * a_Position;\n   #endif\n #endif\n \n \n#if defined(DIRECTIONLIGHT)||defined(POINTLIGHT)||defined(SPOTLIGHT)||defined(REFLECTMAP)\n  #ifdef BONE\n  vec3 normal=normalize( mat3(u_WorldMat*skinTransform)*a_Normal);\n  #else\n  vec3 normal=normalize( mat3(u_WorldMat)*a_Normal);\n  #endif\n \n  #ifdef REFLECTMAP\n  v_Normal=normal;\n  #endif\n#endif\n \n\n#if defined(DIRECTIONLIGHT)||defined(POINTLIGHT)||defined(SPOTLIGHT)\n  v_Diffuse=vec3(0.0);\n  v_Ambient=vec3(0.0);\n  v_Specular=vec3(0.0);\n  vec3 dif, amb, spe;\n#endif\n\n\n#if defined(DIRECTIONLIGHT)||defined(POINTLIGHT)||defined(SPOTLIGHT)||defined(FOG)||defined(REFLECTMAP)\n  #ifdef BONE\n  vec3 positionWorld=(u_WorldMat*position).xyz;\n  #else\n  vec3 positionWorld=(u_WorldMat*a_Position).xyz;\n  #endif\n#endif\n\n#if defined(DIRECTIONLIGHT)||defined(POINTLIGHT)||defined(SPOTLIGHT)||defined(FOG)||defined(REFLECTMAP)\nvec3 toEye;\n  #ifdef FOG\n  toEye=u_CameraPos-positionWorld;\n  v_ToEyeLength=length(toEye);\n  toEye/=v_ToEyeLength;\n  #else\n  toEye=normalize(u_CameraPos-positionWorld);\n  #endif\n \n  #ifdef REFLECTMAP\n  v_ToEye=toEye;\n  #endif\n#endif\n \n#ifdef DIRECTIONLIGHT\ncomputeDirectionLight(u_MaterialDiffuse,u_MaterialAmbient,u_MaterialSpecular,u_DirectionLight,normal,toEye, dif, amb, spe);\nv_Diffuse+=dif;\nv_Ambient+=amb;\nv_Specular+=spe;\n#endif\n \n#ifdef POINTLIGHT\ncomputePointLight(u_MaterialDiffuse,u_MaterialAmbient,u_MaterialSpecular,u_PointLight,positionWorld,normal,toEye, dif, amb, spe);\nv_Diffuse+=dif;\nv_Ambient+=amb;\nv_Specular+=spe;\n#endif\n\n#ifdef SPOTLIGHT\nComputeSpotLight(u_MaterialDiffuse,u_MaterialAmbient,u_MaterialSpecular,u_SpotLight,positionWorld,normal,toEye, dif, amb, spe);\nv_Diffuse+=dif;\nv_Ambient+=amb;\nv_Specular+=spe;\n#endif\n  \n#if defined(DIFFUSEMAP)||((defined(DIRECTIONLIGHT)||defined(POINTLIGHT)||defined(SPOTLIGHT))&&defined(COLOR)&&defined(SPECULARMAP))\n  #ifdef MIXUV\n  v_Texcoord0=mix(a_Texcoord0,a_TexcoordNext0,u_UVAge);\n  #else\n  v_Texcoord0=a_Texcoord0;\n  #endif\n  #ifdef UVTRANSFORM\n  v_Texcoord0=(u_UVMatrix*vec4(v_Texcoord0,0.0,1.0)).xy;\n  #endif\n#endif\n\n#ifdef AMBIENTMAP\n  #ifdef SCALEOFFSETLIGHTINGMAPUV\n  v_Texcoord1=vec2(a_Texcoord1.x*u_LightmapScaleOffset.x+u_LightmapScaleOffset.z,1.0+a_Texcoord1.y*u_LightmapScaleOffset.y+u_LightmapScaleOffset.w);\n  #else\n  v_Texcoord1=a_Texcoord1;\n  #endif \n#endif\n  \n#ifdef COLOR\nv_Color=a_Color;\n#endif\n}',
t="#ifdef FSHIGHPRECISION\nprecision highp float;\n#else\nprecision mediump float;\n#endif\n\nuniform vec4 u_Albedo;\n\n#ifdef ALPHATEST\nuniform float u_AlphaTestValue;\n#endif\n\n#ifdef DIFFUSEMAP\nuniform sampler2D u_DiffuseTexture;\n#endif\n\n#ifdef REFLECTMAP\nuniform samplerCube u_ReflectTexture;\nuniform vec3 u_MaterialReflect;\n#endif\n\n\n#if defined(DIFFUSEMAP)||((defined(DIRECTIONLIGHT)||defined(POINTLIGHT)||defined(SPOTLIGHT))&&defined(COLOR)&&defined(SPECULARMAP))\nvarying vec2 v_Texcoord0;\n#endif\n\n#ifdef AMBIENTMAP\nvarying vec2 v_Texcoord1;\nuniform sampler2D u_AmbientTexture;\n#endif\n\n#if defined(DIRECTIONLIGHT)||defined(POINTLIGHT)||defined(SPOTLIGHT)||defined(AMBIENTMAP)\nuniform vec3 u_MaterialAmbient;\n#endif\n\n#ifdef COLOR\nvarying vec4 v_Color;\n#endif\n\n#if defined(DIRECTIONLIGHT)||defined(POINTLIGHT)||defined(SPOTLIGHT)\nvarying vec3 v_Diffuse;\nvarying vec3 v_Ambient;\nvarying vec3 v_Specular;\n  #if (defined(DIFFUSEMAP)||defined(COLOR))&&defined(SPECULARMAP)\n  uniform sampler2D u_SpecularTexture;\n  #endif\n#endif\n\n#ifdef FOG\nuniform float u_FogStart;\nuniform float u_FogRange;\nuniform vec3 u_FogColor;\nvarying float v_ToEyeLength;\n#endif\n\n#ifdef MIXUV\nuniform float  u_UVAniAge;\n#endif\n\n#ifdef REFLECTMAP\nvarying vec3 v_Normal;\nvarying vec3 v_ToEye;\n#endif\n\n\nvoid main()\n{\n #if defined(DIFFUSEMAP)&&!defined(COLOR)\n gl_FragColor=texture2D(u_DiffuseTexture, v_Texcoord0);\n #endif \n \n #if defined(COLOR)&&!defined(DIFFUSEMAP)\n gl_FragColor=v_Color;\n #endif \n \n #if defined(DIFFUSEMAP)&&defined(COLOR)\n vec4 texColor=texture2D(u_DiffuseTexture, v_Texcoord0);\n gl_FragColor=texColor*v_Color;\n #endif\n \n #if !defined(DIFFUSEMAP)&&!defined(COLOR)\n gl_FragColor=vec4(1.0,1.0,1.0,1.0);\n #endif \n \n #ifdef AMBIENTMAP\n gl_FragColor.rgb=gl_FragColor.rgb*(u_MaterialAmbient+texture2D(u_AmbientTexture, v_Texcoord1).rgb);\n #endif \n \n gl_FragColor=gl_FragColor*u_Albedo;\n  \n #ifdef ALPHATEST\n   if(gl_FragColor.a-u_AlphaTestValue<0.0)\n    discard;\n #endif\n \n \n #ifdef REFLECTMAP\n vec3 normal=normalize(v_Normal);\n #endif \t\n\n  \n #if defined(DIRECTIONLIGHT)||defined(POINTLIGHT)||defined(SPOTLIGHT)\n   #if (defined(DIFFUSEMAP)||defined(COLOR))&&defined(SPECULARMAP)\n   vec3 specular =v_Specular*texture2D(u_SpecularTexture,v_Texcoord0).rgb;\n   gl_FragColor =vec4( gl_FragColor.rgb*(v_Ambient + v_Diffuse)+specular,gl_FragColor.a);\n   #else\n   gl_FragColor =vec4( gl_FragColor.rgb*(v_Ambient + v_Diffuse)+v_Specular,gl_FragColor.a);\n   #endif\n #endif\n \n #ifdef REFLECTMAP\n vec3 incident = -v_ToEye;\n vec3 reflectionVector = reflect(incident,v_Normal);\n vec3 reflectionColor  = textureCube(u_ReflectTexture,reflectionVector).rgb;\n gl_FragColor.rgb += u_MaterialReflect*reflectionColor;\n #endif\n \n #ifdef FOG\n float lerpFact=clamp((v_ToEyeLength-u_FogStart)/u_FogRange,0.0,1.0);\n gl_FragColor.rgb=mix(gl_FragColor.rgb,u_FogColor,lerpFact);\n #endif\n}\n\n",a=lt.add(s,e,t,n,i),Xt.SHADERDEFINE_DIFFUSEMAP=a.registerDefine("DIFFUSEMAP"),Xt.SHADERDEFINE_NORMALMAP=a.registerDefine("NORMALMAP"),Xt.SHADERDEFINE_SPECULARMAP=a.registerDefine("SPECULARMAP"),Xt.SHADERDEFINE_EMISSIVEMAP=a.registerDefine("EMISSIVEMAP"),Xt.SHADERDEFINE_AMBIENTMAP=a.registerDefine("AMBIENTMAP"),Xt.SHADERDEFINE_REFLECTMAP=a.registerDefine("REFLECTMAP"),Xt.SHADERDEFINE_SCALEOFFSETLIGHTINGMAPUV=a.registerDefine("SCALEOFFSETLIGHTINGMAPUV"),Xt.SHADERDEFINE_ALPHATEST=a.registerDefine("ALPHATEST"),Xt.SHADERDEFINE_UVTRANSFORM=a.registerDefine("UVTRANSFORM"),n={a_Position:0,a_Color:1},i={u_MvpMatrix:[1,2]};var o=kt.nameKey.add("LINE");e='#include?VR "VRHelper.glsl";\nattribute vec4 a_Position;\nuniform mat4 u_MvpMatrix;\nattribute vec4 a_Color;\nvarying vec4 v_Color;\n\n\nvoid main()\n{\n  gl_Position = u_MvpMatrix * a_Position;\n  v_Color=a_Color;\n}',t="#ifdef FSHIGHPRECISION\nprecision highp float;\n#else\nprecision mediump float;\n#endif\n\nvarying vec4 v_Color;\n\nvoid main()\n{\n  gl_FragColor=v_Color; \n}\n\n",lt.add(o,e,t,n,i),n={position:0,normal:3,tangent:5,binormal:4,uv:2,a_BoneWeights:7,a_BoneIndices:6,a_Tangent0:5},i={u_Bones:[0,0],u_lodRect:[9,3],texBaseColor:[0,1],texNormal:[1,1],texORM:[2,1],texPrefilterdEnv:[8,3],texPrefilterDiff:[7,3],texBRDFLUT:[3,1],u_AlphaTestValue:[4,1],u_UVAniAge:[5,1],u_MaterialRoughness:[6,1],u_UVMatrix:[7,1],u_UVAge:[8,1],modelMatrix:[0,2],mvp:[1,2],cameraPosition:[0,3],u_View:[1,3],u_Project:[2,3],u_FogStart:[1,4],u_FogRange:[2,4],u_FogColor:[0,4],"u_DirectionLight.Direction":[3,4],"u_DirectionLight.Diffuse":[4,4],"u_DirectionLight.Ambient":[5,4],"u_DirectionLight.Specular":[6,4],"u_PointLight.Position":[7,4],"u_PointLight.Range":[8,4],"u_PointLight.Attenuation":[9,4],"u_PointLight.Diffuse":[10,4],"u_PointLight.Ambient":[11,4],"u_PointLight.Specular":[12,4],"u_SpotLight.Position":[13,4],"u_SpotLight.Direction":[14,4],"u_SpotLight.Range":[16,4],"u_SpotLight.Spot":[15,4],"u_SpotLight.Attenuation":[17,4],"u_SpotLight.Diffuse":[18,4],"u_SpotLight.Ambient":[19,4],"u_SpotLight.Specular":[20,4]};var l=kt.nameKey.add("PBR");e="\nuniform mat4 modelMatrix;\n//uniform mat4 modelViewMatrix;\n//uniform mat4 projectionMatrix;\nuniform mat4 mvp;\n//uniform mat4 viewMatrix;\nuniform vec3 cameraPosition;\n\nattribute vec3 position;\nattribute vec3 normal;\nattribute vec3 tangent;\nattribute vec3 binormal;\nattribute vec2 uv;\n\nvarying vec2 vUv;\nvarying vec3 vWorldNorm;\nvarying vec4 vViewPos;\nvarying vec4 vWorldPos;\nvarying vec3 vLightDir;\nvarying vec3 vViewDir;\nvarying vec3 vWorldTangent;\nvarying vec3 vWorldBinormal;\n\nvoid main() {\n    vUv = uv;\n    vWorldPos = modelMatrix*vec4(position, 1.0);\n    vWorldNorm =  (modelMatrix*vec4(normal,0.0)).xyz;\n\tvWorldTangent = (modelMatrix*vec4(tangent,0.0)).xyz;\n\tvWorldBinormal = (modelMatrix*vec4(binormal,0.0)).xyz;\n    vViewDir = normalize(vWorldPos.xyz-cameraPosition);\n    gl_Position = mvp*vec4(position, 1.0);\n}\n",t="//#version 300 es\n\nprecision highp float;\nprecision lowp int;\n\nconst float PI = 3.14159265358979323846264;\nconst float _2PI = 6.2831853071796;\nvarying vec2 vUv;\nvarying vec3 vWorldNorm;\nvarying vec3 vWorldTangent;\nvarying vec3 vWorldBinormal;\nvarying vec3 vViewDir;\nvarying vec4 vViewPos;\nvarying vec4 vWorldPos;\n//\nuniform sampler2D texBaseColor;\nuniform sampler2D texNormal;\n//uniform sampler2D texORM;   //Ao, Roughness, Metallic\n//预计算的贴图\nuniform sampler2D texPrefilterdEnv;\nuniform sampler2D texBRDFLUT;\nuniform sampler2D texPrefilterDiff;\n\nuniform vec3 u_fresnel0;\nuniform float u_roughness;\nconst float maxlv = 9.;\t//现在只支持512分辨率的环境贴图\nconst int nmaxlv = 9;//\n//atlas\n//uniform vec4 u_lodRect[10];//现在只支持512分辨率的环境贴图，所以只有10个，[0]是原始， [9]是1x1.\n\t\t\t\t\t\t\t//[u,v,w,h]。w,h都是0到1\n\nvec3 u_lightColor = vec3(1.,1.,1.);\nvec3 u_diffuseColor = vec3(0.1,0.1,0.1);\nvec3 speccontrib = vec3(0.);\n\nconst float _maxu8 = 255.0;\nconst float _maxu16 = 65535.0;\nconst float _shift8 = 256.0;    //平移的话是*256而不是255\nvec2 _RGBAToU16(const in vec4 rgba){\n    return vec2((rgba.r*_maxu8+rgba.g*_maxu8*_shift8)/_maxu16, (rgba.b*_maxu8+rgba.a*_maxu8*_shift8)/_maxu16);\n}\nvec3 _RGBEToRGB( const in vec4 rgba ){\n    float f = pow(2.0, rgba.w * 255.0 - (128.0 + 8.0));\n    return rgba.rgb * (255.0 * f);\n}\nfloat saturate(float v){\n    return min(max(v,0.),1.);\n}\n\n/* 合并的方式\nvec4 texPanoramaLod(sampler2D tex, const in vec3 dir, float lod){\n\tfloat fl0 = floor(lod);\n    int l0 = int(fl0); \t\t\t//这里就不检查与maxlv的关系了\n    int l1 = l0+1;\n\tif(l1>nmaxlv)l1=nmaxlv;\n    float k = lod-fl0;\t\t\t\t//TODO fract\n\t\n\t//ps不支持索引数组\n\tvec4 rect1;// = u_lodRect[l0];\n\tvec4 rect2;// = u_lodRect[l1];\n\tfor( int i=0; i<10; i++){\n\t\tif(i==l0) {\n\t\t\trect1 = u_lodRect[i];\n\t\t}\n\t\tif(i==l1){\n\t\t\trect2 = u_lodRect[i];\n\t\t}\n\t}\n\t\n    float u = atan(dir.z,dir.x)/_2PI+0.5;  \n    float v = acos(dir.y)/PI;\n\n    vec4 v0 = texture2D(tex, vec2(u*rect1.z+rect1.x,v*rect1.w+rect1.y));\n    vec4 v1 = texture2D(tex, vec2(u*rect2.z+rect2.x,v*rect2.w+rect2.y));\n    return mix(v0,v1,k);\n}\n*/\n\nvec4 tex2dLod(sampler2D tex, float u, float v, float lod){\n\tvec2 uv = vec2(u,v);\n\tuv+=mod(gl_FragCoord.xy-vec2(0.5),2.0)*vec2(128.,0.);\n\treturn texture2D(tex,uv,lod-16.);//16=log(512)+log(128)\n}\n\n/*\n* 对一个全景图进行采样。假设x轴指向中心。\n*/\nvec4 texPanorama(sampler2D tex, const in vec3 dir){\n\tfloat envu = atan(dir.z,dir.x)/_2PI+0.5; \t\n\tfloat envv = acos(dir.y)/PI;//(1.0-R.y)/2.0;\n\treturn texture2D(tex,vec2(envu,envv));\n}\n\nvec4 texPanoramaLod(sampler2D tex, const in vec3 dir, float lod){\n\tfloat envu = atan(dir.z,dir.x)/_2PI+0.5; \t\n\tfloat envv = acos(dir.y)/PI;//(1.0-R.y)/2.0;\n\treturn tex2dLod(tex,envu,envv,lod);\n}\n\nvec3 ApproximateSpecularIBL( vec3 SpecularColor , float Roughness , float NoV, vec3 R){\n    vec4 PrefilteredColor = texPanoramaLod(texPrefilterdEnv, R, Roughness*maxlv);\n    PrefilteredColor.rgb = _RGBEToRGB(PrefilteredColor);\n    vec4 EnvBRDF = texture2D(texBRDFLUT,vec2(Roughness , NoV));//TODO lod\n    vec2 rg = _RGBAToU16(EnvBRDF);    \n    //原来的括号不对\n    speccontrib = (SpecularColor* rg.x + saturate( 50.0 * PrefilteredColor.g ) * rg.y);\n    return PrefilteredColor.rgb * speccontrib;\n}\n\nvec3 testDiff(vec3 dir){\n\treturn texPanorama(texPrefilterDiff, dir).rgb;\n}\n/*\n    计算sh光照。\n    使用level=2，所以需要9个系数。\n    https://cseweb.ucsd.edu/~ravir/papers/envmap/envmap.pdf\n*/\nuniform mat4 rshcoeffs;\nvec3 diff_sh9(vec3 dir){\n    return vec3(0.0,0.,0.);\n}\n\nvec3 applyNormalTex( vec3 norm, vec3 surf_norm ) {\n    vec3 mapN = norm * 2.0 - 1.0;\n    //mapN.xy = normalScale * mapN.xy;\n    mat3 tsn = mat3( vWorldTangent, vWorldBinormal, surf_norm );  //注意调整T,B的顺序\n    return normalize( tsn * mapN );\n}\n\nvec3 pbrlight(vec3 normal, float rough, float NoV, vec3 R){\n    vec4 basecolor = texture2D(texBaseColor,vUv);\n\tfloat metaless = 1.0;\n\tconst float ismetalinfov = (128./255.);\n\tif(basecolor.a>=ismetalinfov){//这时候表示金属度\n\t\tmetaless = (basecolor.a-ismetalinfov)*2.;\n\t\tbasecolor.a = 1.0;\n\t}else{\n\t\tmetaless = 0.;\n\t\tbasecolor.a = basecolor.a*2.0;\n\t}\n    //vec4 pbrinfo = texture2D(texORM,vUv);\n    const vec3 nonmetalF0 =vec3(0.2);\n    vec3 F0 =  mix(nonmetalF0, basecolor.rgb, metaless);\n    vec3 color_spec = ApproximateSpecularIBL(F0,rough, NoV, R);\n    vec3 color_diff=testDiff(normal);\n    return color_diff*mix(basecolor.rgb,vec3(0,0,0),metaless)+color_spec;\n}\n\nvec3 oldlight(vec4 normal, float NoV, vec3 R){\n    vec4 basecolor = texture2D(texBaseColor,vUv);\n    //vec4 pbrinfo = texture2D(texORM,vUv);\n\tconst vec3 lightdir=normalize(vec3(1.,1.,0.));\n\tconst vec3 spcecol = vec3(1.,0.8,0.8);\n\tconst vec3 amb = vec3(0.5);\n\tvec3 diffv =  (vec3(saturate(dot(lightdir,normal.xyz)))+amb);\n\t//vec3 spec = spcecol* pow(saturate(dot(R,lightdir)),(1.-pbrinfo.g)*5.);\n\treturn diffv*basecolor.rgb;//+spec;\n}\n\nvoid main() {\n    vec3 normal =  normalize(vWorldNorm);\n\tvec3 smoothnorm = normal;\n\tvec4 normtex = texture2D( texNormal, vUv );\n\tnormal = applyNormalTex(normtex.xyz, normal);\n    vec3 view   = -normalize(vViewDir);\n    float NoV = saturate(dot( view, normal ));\n    vec3 R = 2. * NoV * normal - view;\n    gl_FragColor.rgb = pbrlight(normal,normtex.a,NoV,R);\n\t//gl_FragColor.rgb = oldlight(normtex,NoV,R);\n    gl_FragColor.a = 1.0;\n}\n",a=lt.add(l,e,t,n,i),n={a_Position:0,a_Texcoord:2},i={u_BlendTexture:[0,1],u_LayerTexture0:[1,1],u_LayerTexture1:[2,1],u_LayerTexture2:[3,1],u_LayerTexture3:[4,1],u_Albedo:[6,1],u_Ambient:[9,1],u_UVMatrix:[13,1],u_WorldMat:[0,2],u_MvpMatrix:[1,2],u_CameraPos:[0,3],u_FogStart:[1,4],u_FogRange:[2,4],u_FogColor:[0,4]};var h=kt.nameKey.add("TERRAIN");e='#include?VR "VRHelper.glsl";\nattribute vec4 a_Position;\nuniform mat4 u_MvpMatrix;\nuniform mat4 u_UVMatrix;\n\n#if defined(DIFFUSEMAP)&&defined(NORMALMAP)&&defined(SPECULARMAP)&&defined(EMISSIVEMAP)&&defined(AMBIENTMAP)\nattribute vec2 a_Texcoord;\nvarying vec2 v_Texcoord;\nvarying vec2 v_TiledTexcoord;\n#endif\n\n#ifdef FOG\nuniform mat4 u_WorldMat;\nvarying vec3 v_PositionWorld;\n#endif\n\n\nvoid main()\n{\n #ifdef VR\n gl_Position = DistortFishEye(u_MvpMatrix * a_Position);\n #else\n gl_Position = u_MvpMatrix * a_Position;\n #endif\n \n #ifdef FOG\n v_PositionWorld=(u_WorldMat*a_Position).xyz;\n #endif\n \n #if defined(DIFFUSEMAP)&&defined(NORMALMAP)&&defined(SPECULARMAP)&&defined(EMISSIVEMAP)&&defined(AMBIENTMAP)\n v_Texcoord=a_Texcoord;\n v_TiledTexcoord=(u_UVMatrix*vec4(a_Texcoord,0.0,1.0)).xy;\n #endif\n}',t="#ifdef FSHIGHPRECISION\nprecision highp float;\n#else\nprecision mediump float;\n#endif\n\nuniform vec4 u_Albedo;\nuniform vec3 u_Ambient;\n\n#ifdef FOG\nuniform vec3 u_CameraPos;\nvarying vec3 v_PositionWorld;\n\nuniform float u_FogStart;\nuniform float u_FogRange;\nuniform vec3 u_FogColor;\n#endif\n\n#if defined(DIFFUSEMAP)&&defined(NORMALMAP)&&defined(SPECULARMAP)&&defined(EMISSIVEMAP)&&defined(AMBIENTMAP)\n  varying vec2 v_Texcoord;\n  varying vec2 v_TiledTexcoord;\n  uniform sampler2D u_BlendTexture;\n  uniform sampler2D u_LayerTexture0;\n  uniform sampler2D u_LayerTexture1;\n  uniform sampler2D u_LayerTexture2;\n  uniform sampler2D u_LayerTexture3;\n#endif\n\nvoid main()\n{\t\n  #if defined(DIFFUSEMAP)&&defined(NORMALMAP)&&defined(SPECULARMAP)&&defined(EMISSIVEMAP)&&defined(AMBIENTMAP)\n  vec4 blend=texture2D(u_BlendTexture, v_Texcoord);\n  vec4 c0=texture2D(u_LayerTexture0, v_TiledTexcoord);\n  vec4 c1=texture2D(u_LayerTexture1, v_TiledTexcoord);\n  vec4 c2=texture2D(u_LayerTexture2, v_TiledTexcoord);\n  vec4 c3=texture2D(u_LayerTexture3, v_TiledTexcoord);\n  vec4 texColor = c0;\n  texColor = mix(texColor, c1, blend.r);\n  texColor = mix(texColor, c2, blend.g);\n  texColor = mix(texColor, c3, blend.b);\n  gl_FragColor=vec4(texColor.rgb*u_Ambient.rgb*blend.a,1.0);\n  gl_FragColor=gl_FragColor*u_Albedo;\n  #endif \n  \n  #ifdef FOG\n  vec3 toEye=u_CameraPos-v_PositionWorld;\n  float toEyeLength=length(toEye);\n  \n  float lerpFact=clamp((toEyeLength-u_FogStart)/u_FogRange,0.0,1.0);\n  gl_FragColor.rgb=mix(gl_FragColor.rgb,u_FogColor,lerpFact);\n  #endif\n}\n\n",a=lt.add(h,e,t,n,i),Xt.SHADERDEFINE_DIFFUSEMAP=a.registerDefine("DIFFUSEMAP"),Xt.SHADERDEFINE_NORMALMAP=a.registerDefine("NORMALMAP"),Xt.SHADERDEFINE_SPECULARMAP=a.registerDefine("SPECULARMAP"),Xt.SHADERDEFINE_EMISSIVEMAP=a.registerDefine("EMISSIVEMAP"),Xt.SHADERDEFINE_AMBIENTMAP=a.registerDefine("AMBIENTMAP"),Xt.SHADERDEFINE_REFLECTMAP=a.registerDefine("REFLECTMAP"),Xt.SHADERDEFINE_SCALEOFFSETLIGHTINGMAPUV=a.registerDefine("SCALEOFFSETLIGHTINGMAPUV"),Xt.SHADERDEFINE_ALPHATEST=a.registerDefine("ALPHATEST"),Xt.SHADERDEFINE_UVTRANSFORM=a.registerDefine("UVTRANSFORM"),n={a_CornerTextureCoordinate:17,a_Position:0,a_Velocity:18,a_StartColor:19,a_EndColor:25,a_SizeRotation:27,a_Radius:28,a_Radian:29,a_AgeAddScale:26,a_Time:33},i={u_CurrentTime:[1,1],u_Duration:[2,1],u_Gravity:[3,1],u_EndVelocity:[4,1],u_texture:[5,1],u_WorldMat:[0,2],u_View:[1,3],u_Projection:[2,3],u_ViewportScale:[0,1]};var u=kt.nameKey.add("PARTICLE");a=lt.add(u,S.vs,S.ps,n,i),Yt.SHADERDEFINE_PARTICLE3D=a.registerDefine("PARTICLE3D"),n={a_CornerTextureCoordinate:17,a_PositionStartLifeTime:30,a_DirectionTime:32,a_StartColor:19,a_EndColor:25,a_StartSize:20,a_StartRotation0:22,a_StartRotation1:23,a_StartRotation2:24,a_StartSpeed:31,a_Random0:34,a_Random1:35,a_SimulationWorldPostion:36},i={u_SimulationSpace:[7,1],u_Tintcolor:[8,1],u_ThreeDStartRotation:[0,1],u_ScalingMode:[1,1],u_CurrentTime:[2,1],u_Gravity:[3,1],u_texture:[4,1],u_StretchedBillboardLengthScale:[5,1],u_StretchedBillboardSpeedScale:[6,1],u_WorldPosition:[0,2],u_WorldRotationMat:[1,2],u_PositionScale:[4,2],u_SizeScale:[5,2],u_ColorOverLifeGradientAlphas:[15,2],u_ColorOverLifeGradientColors:[16,2],u_MaxColorOverLifeGradientAlphas:[17,2],u_MaxColorOverLifeGradientColors:[18,2],u_VOLVelocityConst:[6,2],u_VOLVelocityGradientX:[7,2],u_VOLVelocityGradientY:[8,2],u_VOLVelocityGradientZ:[9,2],u_VOLVelocityConstMax:[10,2],u_VOLVelocityGradientMaxX:[11,2],u_VOLVelocityGradientMaxY:[12,2],u_VOLVelocityGradientMaxZ:[13,2],u_VOLSpaceType:[14,2],u_SOLSizeGradient:[19,2],u_SOLSizeGradientX:[20,2],u_SOLSizeGradientY:[21,2],u_SOLSizeGradientZ:[22,2],u_SOLSizeGradientMax:[23,2],u_SOLSizeGradientMaxX:[24,2],u_SOLSizeGradientMaxY:[25,2],u_SOLSizeGradientMaxZ:[26,2],u_ROLAngularVelocityConst:[27,2],u_ROLAngularVelocityConstSeprarate:[28,2],u_ROLAngularVelocityGradient:[29,2],u_ROLAngularVelocityGradientX:[30,2],u_ROLAngularVelocityGradientY:[31,2],u_ROLAngularVelocityGradientZ:[32,2],u_ROLAngularVelocityConstMax:[33,2],u_ROLAngularVelocityConstMaxSeprarate:[34,2],u_ROLAngularVelocityGradientMax:[35,2],u_ROLAngularVelocityGradientMaxX:[36,2],u_ROLAngularVelocityGradientMaxY:[37,2],u_ROLAngularVelocityGradientMaxZ:[38,2],u_TSACycles:[39,2],u_TSASubUVLength:[40,2],u_TSAGradientUVs:[41,2],u_TSAMaxGradientUVs:[42,2],u_CameraDirection:[5,3],u_CameraUp:[6,3],u_View:[1,3],u_Projection:[2,3]};var c=kt.nameKey.add("PARTICLESHURIKEN")
;e="attribute vec4 a_CornerTextureCoordinate;\nattribute vec4 a_PositionStartLifeTime;\nattribute vec4 a_DirectionTime;\nattribute vec4 a_StartColor;\nattribute vec3 a_StartSize;\nattribute vec3 a_StartRotation0;\nattribute vec3 a_StartRotation1;\nattribute vec3 a_StartRotation2;\nattribute float a_StartSpeed;\n#ifdef defined(COLOROVERLIFETIME)||defined(RANDOMCOLOROVERLIFETIME)||defined(SIZEOVERLIFETIMERANDOMCURVES)||definedSIZEOVERLIFETIMERANDOMCURVESSEPERATE||defined(ROTATIONOVERLIFETIMERANDOMCONSTANTS)||defined(ROTATIONOVERLIFETIMERANDOMCURVES)\n  attribute vec4 a_Random0;\n#endif\n#ifdef TEXTURESHEETANIMATIONRANDOMCURVE||defined(VELOCITYOVERLIFETIMERANDOMCONSTANT)||defined(VELOCITYOVERLIFETIMERANDOMCURVE)\n  attribute vec4 a_Random1;\n#endif\nattribute vec3 a_SimulationWorldPostion;\n\nvarying float v_Discard;\nvarying vec4 v_Color;\nvarying vec2 v_TextureCoordinate;\n\nuniform float u_CurrentTime;\nuniform vec3 u_Gravity;\n\nuniform vec3 u_WorldPosition;\nuniform mat4 u_WorldRotationMat;\nuniform bool u_ThreeDStartRotation;\nuniform int u_ScalingMode;\nuniform vec3 u_PositionScale;\nuniform vec3 u_SizeScale;\nuniform mat4 u_View;\nuniform mat4 u_Projection;\n\nuniform vec3 u_CameraDirection;//TODO:只有几种广告牌模式需要用\nuniform vec3 u_CameraUp;\n\nuniform  float u_StretchedBillboardLengthScale;\nuniform  float u_StretchedBillboardSpeedScale;\nuniform int u_SimulationSpace;\n\n#ifdef defined(VELOCITYOVERLIFETIMECONSTANT)||defined(VELOCITYOVERLIFETIMECURVE)||defined(VELOCITYOVERLIFETIMERANDOMCONSTANT)||defined(VELOCITYOVERLIFETIMERANDOMCURVE)\n  uniform  int  u_VOLSpaceType;\n#endif\n#ifdef defined(VELOCITYOVERLIFETIMECONSTANT)||defined(VELOCITYOVERLIFETIMERANDOMCONSTANT)\n  uniform  vec3 u_VOLVelocityConst;\n#endif\n#ifdef defined(VELOCITYOVERLIFETIMECURVE)||defined(VELOCITYOVERLIFETIMERANDOMCURVE)\n  uniform  vec2 u_VOLVelocityGradientX[4];//x为key,y为速度\n  uniform  vec2 u_VOLVelocityGradientY[4];//x为key,y为速度\n  uniform  vec2 u_VOLVelocityGradientZ[4];//x为key,y为速度\n#endif\n#ifdef VELOCITYOVERLIFETIMERANDOMCONSTANT\n  uniform  vec3 u_VOLVelocityConstMax;\n#endif\n#ifdef VELOCITYOVERLIFETIMERANDOMCURVE\n  uniform  vec2 u_VOLVelocityGradientMaxX[4];//x为key,y为速度\n  uniform  vec2 u_VOLVelocityGradientMaxY[4];//x为key,y为速度\n  uniform  vec2 u_VOLVelocityGradientMaxZ[4];//x为key,y为速度\n#endif\n\n#ifdef COLOROVERLIFETIME\n  uniform  vec4 u_ColorOverLifeGradientColors[4];//x为key,yzw为Color\n  uniform  vec2 u_ColorOverLifeGradientAlphas[4];//x为key,y为Alpha\n#endif\n#ifdef RANDOMCOLOROVERLIFETIME\n  uniform  vec4 u_ColorOverLifeGradientColors[4];//x为key,yzw为Color\n  uniform  vec2 u_ColorOverLifeGradientAlphas[4];//x为key,y为Alpha\n  uniform  vec4 u_MaxColorOverLifeGradientColors[4];//x为key,yzw为Color\n  uniform  vec2 u_MaxColorOverLifeGradientAlphas[4];//x为key,y为Alpha\n#endif\n\n\n#ifdef defined(SIZEOVERLIFETIMECURVE)||defined(SIZEOVERLIFETIMERANDOMCURVES)\n  uniform  vec2 u_SOLSizeGradient[4];//x为key,y为尺寸\n#endif\n#ifdef SIZEOVERLIFETIMERANDOMCURVES\n  uniform  vec2 u_SOLSizeGradientMax[4];//x为key,y为尺寸\n#endif\n#ifdef defined(SIZEOVERLIFETIMECURVESEPERATE)||defined(SIZEOVERLIFETIMERANDOMCURVESSEPERATE)\n  uniform  vec2 u_SOLSizeGradientX[4];//x为key,y为尺寸\n  uniform  vec2 u_SOLSizeGradientY[4];//x为key,y为尺寸\n  uniform  vec2 u_SOLSizeGradientZ[4];//x为key,y为尺寸\n#endif\n#ifdef SIZEOVERLIFETIMERANDOMCURVESSEPERATE\n  uniform  vec2 u_SOLSizeGradientMaxX[4];//x为key,y为尺寸\n  uniform  vec2 u_SOLSizeGradientMaxY[4];//x为key,y为尺寸\n  uniform  vec2 u_SOLSizeGradientMaxZ[4];//x为key,y为尺寸\n#endif\n\n\n#ifdef ROTATIONOVERLIFETIME\n  #ifdef defined(ROTATIONOVERLIFETIMECONSTANT)||defined(ROTATIONOVERLIFETIMERANDOMCONSTANTS)\n    uniform  float u_ROLAngularVelocityConst;\n  #endif\n  #ifdef ROTATIONOVERLIFETIMERANDOMCONSTANTS\n    uniform  float u_ROLAngularVelocityConstMax;\n  #endif\n  #ifdef defined(ROTATIONOVERLIFETIMECURVE)||defined(ROTATIONOVERLIFETIMERANDOMCURVES)\n    uniform  vec2 u_ROLAngularVelocityGradient[4];//x为key,y为旋转\n  #endif\n  #ifdef ROTATIONOVERLIFETIMERANDOMCURVES\n    uniform  vec2 u_ROLAngularVelocityGradientMax[4];//x为key,y为旋转\n  #endif\n#endif\n#ifdef ROTATIONOVERLIFETIMESEPERATE\n  #ifdef defined(ROTATIONOVERLIFETIMECONSTANT)||defined(ROTATIONOVERLIFETIMERANDOMCONSTANTS)\n    uniform  vec3 u_ROLAngularVelocityConstSeprarate;\n  #endif\n  #ifdef ROTATIONOVERLIFETIMERANDOMCONSTANTS\n    uniform  vec3 u_ROLAngularVelocityConstMaxSeprarate;\n  #endif\n  #ifdef defined(ROTATIONOVERLIFETIMECURVE)||defined(ROTATIONOVERLIFETIMERANDOMCURVES)\n    uniform  vec2 u_ROLAngularVelocityGradientX[4];//x为key,y为旋转\n    uniform  vec2 u_ROLAngularVelocityGradientY[4];//x为key,y为旋转\n    uniform  vec2 u_ROLAngularVelocityGradientZ[4];//x为key,y为旋转\n  #endif\n  #ifdef ROTATIONOVERLIFETIMERANDOMCURVES\n    uniform  vec2 u_ROLAngularVelocityGradientMaxX[4];//x为key,y为旋转\n    uniform  vec2 u_ROLAngularVelocityGradientMaxY[4];//x为key,y为旋转\n    uniform  vec2 u_ROLAngularVelocityGradientMaxZ[4];//x为key,y为旋转\n  #endif\n#endif\n\n#ifdef defined(TEXTURESHEETANIMATIONCURVE)||defined(TEXTURESHEETANIMATIONRANDOMCURVE)\n  uniform  float u_TSACycles;\n  uniform  vec2 u_TSASubUVLength;\n  uniform  vec2 u_TSAGradientUVs[4];//x为key,y为frame\n#endif\n#ifdef TEXTURESHEETANIMATIONRANDOMCURVE\n  uniform  vec2 u_TSAMaxGradientUVs[4];//x为key,y为frame\n#endif\n\n \n#ifdef defined(VELOCITYOVERLIFETIMECURVE)||defined(VELOCITYOVERLIFETIMERANDOMCURVE)||defined(SIZEOVERLIFETIMECURVE)||defined(SIZEOVERLIFETIMECURVESEPERATE)||defined(SIZEOVERLIFETIMERANDOMCURVES)||defined(SIZEOVERLIFETIMERANDOMCURVESSEPERATE)\nfloat getCurValueFromGradientFloat(in vec2 gradientNumbers[4],in float normalizedAge)\n{\n\tfloat curValue;\n\tfor(int i=1;i<4;i++)\n\t{\n\t\tvec2 gradientNumber=gradientNumbers[i];\n\t\tfloat key=gradientNumber.x;\n\t\tif(key>=normalizedAge)\n\t\t{\n\t\t\tvec2 lastGradientNumber=gradientNumbers[i-1];\n\t\t\tfloat lastKey=lastGradientNumber.x;\n\t\t\tfloat age=(normalizedAge-lastKey)/(key-lastKey);\n\t\t\tcurValue=mix(lastGradientNumber.y,gradientNumber.y,age);\n\t\t\tbreak;\n\t\t}\n\t}\n\treturn curValue;\n}\n#endif\n\n#ifdef VELOCITYOVERLIFETIME\n//float getTotalPositionFromGradientFloat(in vec2 gradientNumbers[4],in float normalizedAge)\n//{\n//\tfloat totalPosition=0.0;\n//\tfor(int i=1;i<4;i++)\n//\t{\n//\t\tvec2 gradientNumber=gradientNumbers[i];\n//\t\tfloat key=gradientNumber.x;\n//\t\tvec2 lastGradientNumber=gradientNumbers[i-1];\n//\t\tfloat lastValue=lastGradientNumber.y;\n//\t\t\n//\t\tif(key>=normalizedAge){\n//\t\t\tfloat lastKey=lastGradientNumber.x;\n//\t\t\tfloat age=(normalizedAge-lastKey)/(key-lastKey);\n//\t\t\t\n//\t\t\tfloat velocity=(lastValue+mix(lastValue,gradientNumber.y,age))/2.0;\n//\t\t\ttotalPosition+=velocity*a_PositionStartLifeTime.w*(normalizedAge-lastKey);//TODO:计算POSITION时可用优化，用已计算好速度\n//\t\t\tbreak;\n//\t\t}\n//\t\telse{\n//\t\t\tfloat velocity=(lastValue+gradientNumber.y)/2.0;\n//\t\t\ttotalPosition+=velocity*a_PositionStartLifeTime.w*(key-lastGradientNumber.x);\n//\t\t}\n//\t}\n//\treturn totalPosition;\n//}\n#endif\n\n#ifdef defined(VELOCITYOVERLIFETIMECURVE)||defined(VELOCITYOVERLIFETIMERANDOMCURVE)||defined(ROTATIONOVERLIFETIMECURVE)||defined(ROTATIONOVERLIFETIMERANDOMCURVES)\nfloat getTotalValueFromGradientFloat(in vec2 gradientNumbers[4],in float normalizedAge)\n{\n\tfloat totalValue=0.0;\n\tfor(int i=1;i<4;i++)\n\t{\n\t\tvec2 gradientNumber=gradientNumbers[i];\n\t\tfloat key=gradientNumber.x;\n\t\tvec2 lastGradientNumber=gradientNumbers[i-1];\n\t\tfloat lastValue=lastGradientNumber.y;\n\t\t\n\t\tif(key>=normalizedAge){\n\t\t\tfloat lastKey=lastGradientNumber.x;\n\t\t\tfloat age=(normalizedAge-lastKey)/(key-lastKey);\n\t\t\ttotalValue+=(lastValue+mix(lastValue,gradientNumber.y,age))/2.0*a_PositionStartLifeTime.w*(normalizedAge-lastKey);\n\t\t\tbreak;\n\t\t}\n\t\telse{\n\t\t\ttotalValue+=(lastValue+gradientNumber.y)/2.0*a_PositionStartLifeTime.w*(key-lastGradientNumber.x);\n\t\t}\n\t}\n\treturn totalValue;\n}\n#endif\n\n#ifdef defined(COLOROVERLIFETIME)||defined(RANDOMCOLOROVERLIFETIME)\nvec4 getColorFromGradient(in vec2 gradientAlphas[4],in vec4 gradientColors[4],in float normalizedAge)\n{\n\tvec4 overTimeColor;\n\tfor(int i=1;i<4;i++)\n\t{\n\t\tvec2 gradientAlpha=gradientAlphas[i];\n\t\tfloat alphaKey=gradientAlpha.x;\n\t\tif(alphaKey>=normalizedAge)\n\t\t{\n\t\t\tvec2 lastGradientAlpha=gradientAlphas[i-1];\n\t\t\tfloat lastAlphaKey=lastGradientAlpha.x;\n\t\t\tfloat age=(normalizedAge-lastAlphaKey)/(alphaKey-lastAlphaKey);\n\t\t\toverTimeColor.a=mix(lastGradientAlpha.y,gradientAlpha.y,age);\n\t\t\tbreak;\n\t\t}\n\t}\n\t\n\tfor(int i=1;i<4;i++)\n\t{\n\t\tvec4 gradientColor=gradientColors[i];\n\t\tfloat colorKey=gradientColor.x;\n\t\tif(colorKey>=normalizedAge)\n\t\t{\n\t\t\tvec4 lastGradientColor=gradientColors[i-1];\n\t\t\tfloat lastColorKey=lastGradientColor.x;\n\t\t\tfloat age=(normalizedAge-lastColorKey)/(colorKey-lastColorKey);\n\t\t\toverTimeColor.rgb=mix(gradientColors[i-1].yzw,gradientColor.yzw,age);\n\t\t\tbreak;\n\t\t}\n\t}\n\treturn overTimeColor;\n}\n#endif\n\n\n#ifdef defined(TEXTURESHEETANIMATIONCURVE)||defined(TEXTURESHEETANIMATIONRANDOMCURVE)\nfloat getFrameFromGradient(in vec2 gradientFrames[4],in float normalizedAge)\n{\n\tfloat overTimeFrame;\n\tfor(int i=1;i<4;i++)\n\t{\n\t\tvec2 gradientFrame=gradientFrames[i];\n\t\tfloat key=gradientFrame.x;\n\t\tif(key>=normalizedAge)\n\t\t{\n\t\t\tvec2 lastGradientFrame=gradientFrames[i-1];\n\t\t\tfloat lastKey=lastGradientFrame.x;\n\t\t\tfloat age=(normalizedAge-lastKey)/(key-lastKey);\n\t\t\toverTimeFrame=mix(lastGradientFrame.y,gradientFrame.y,age);\n\t\t\tbreak;\n\t\t}\n\t}\n\treturn floor(overTimeFrame);\n}\n#endif\n\n#ifdef defined(VELOCITYOVERLIFETIMECONSTANT)||defined(VELOCITYOVERLIFETIMECURVE)||defined(VELOCITYOVERLIFETIMERANDOMCONSTANT)||defined(VELOCITYOVERLIFETIMERANDOMCURVE)\nvec3 computeParticleLifeVelocity(in float normalizedAge)\n{\n  vec3 outLifeVelocity;\n  #ifdef VELOCITYOVERLIFETIMECONSTANT\n\t outLifeVelocity=u_VOLVelocityConst; \n  #endif\n  #ifdef VELOCITYOVERLIFETIMECURVE\n     outLifeVelocity= vec3(getCurValueFromGradientFloat(u_VOLVelocityGradientX,normalizedAge),getCurValueFromGradientFloat(u_VOLVelocityGradientY,normalizedAge),getCurValueFromGradientFloat(u_VOLVelocityGradientZ,normalizedAge));\n  #endif\n  #ifdef VELOCITYOVERLIFETIMERANDOMCONSTANT\n\t outLifeVelocity=mix(u_VOLVelocityConst,u_VOLVelocityConstMax,vec3(a_Random1.y,a_Random1.z,a_Random1.w)); \n  #endif\n  #ifdef VELOCITYOVERLIFETIMERANDOMCURVE\n     outLifeVelocity=vec3(mix(getCurValueFromGradientFloat(u_VOLVelocityGradientX,normalizedAge),getCurValueFromGradientFloat(u_VOLVelocityGradientMaxX,normalizedAge),a_Random1.y),\n\t                 mix(getCurValueFromGradientFloat(u_VOLVelocityGradientY,normalizedAge),getCurValueFromGradientFloat(u_VOLVelocityGradientMaxY,normalizedAge),a_Random1.z),\n\t\t\t\t\t mix(getCurValueFromGradientFloat(u_VOLVelocityGradientZ,normalizedAge),getCurValueFromGradientFloat(u_VOLVelocityGradientMaxZ,normalizedAge),a_Random1.w));\n  #endif\n\t\t\t\t\t\n  return outLifeVelocity;\n} \n#endif\n\nvec3 computeParticlePosition(in vec3 startVelocity, in vec3 lifeVelocity,in float age,in float normalizedAge)\n{\n   vec3 startPosition;\n   vec3 lifePosition;\n   #ifdef defined(VELOCITYOVERLIFETIMECONSTANT)||defined(VELOCITYOVERLIFETIMECURVE)||defined(VELOCITYOVERLIFETIMERANDOMCONSTANT)||defined(VELOCITYOVERLIFETIMERANDOMCURVE)\n\t#ifdef VELOCITYOVERLIFETIMECONSTANT\n\t\t  startPosition=startVelocity*age;\n\t\t  lifePosition=lifeVelocity*age;\n\t#endif\n\t#ifdef VELOCITYOVERLIFETIMECURVE\n\t\t  startPosition=startVelocity*age;\n\t\t  lifePosition=vec3(getTotalValueFromGradientFloat(u_VOLVelocityGradientX,normalizedAge),getTotalValueFromGradientFloat(u_VOLVelocityGradientY,normalizedAge),getTotalValueFromGradientFloat(u_VOLVelocityGradientZ,normalizedAge));\n\t#endif\n\t#ifdef VELOCITYOVERLIFETIMERANDOMCONSTANT\n\t\t  startPosition=startVelocity*age;\n\t\t  lifePosition=lifeVelocity*age;\n\t#endif\n\t#ifdef VELOCITYOVERLIFETIMERANDOMCURVE\n\t\t  startPosition=startVelocity*age;\n\t\t  lifePosition=vec3(mix(getTotalValueFromGradientFloat(u_VOLVelocityGradientX,normalizedAge),getTotalValueFromGradientFloat(u_VOLVelocityGradientMaxX,normalizedAge),a_Random1.y)\n\t      ,mix(getTotalValueFromGradientFloat(u_VOLVelocityGradientY,normalizedAge),getTotalValueFromGradientFloat(u_VOLVelocityGradientMaxY,normalizedAge),a_Random1.z)\n\t      ,mix(getTotalValueFromGradientFloat(u_VOLVelocityGradientZ,normalizedAge),getTotalValueFromGradientFloat(u_VOLVelocityGradientMaxZ,normalizedAge),a_Random1.w));\n\t#endif\n\t\n\tvec3 finalPosition;\n\tif(u_VOLSpaceType==0){\n\t  if(u_ScalingMode!=2)\n\t   finalPosition =mat3(u_WorldRotationMat)*(u_PositionScale*(a_PositionStartLifeTime.xyz+startPosition+lifePosition));\n\t  else\n\t   finalPosition =mat3(u_WorldRotationMat)*(u_PositionScale*a_PositionStartLifeTime.xyz+startPosition+lifePosition);\n\t}\n\telse{\n\t  if(u_ScalingMode!=2)\n\t    finalPosition = mat3(u_WorldRotationMat)*(u_PositionScale*(a_PositionStartLifeTime.xyz+startPosition))+lifePosition;\n\t  else\n\t    finalPosition = mat3(u_WorldRotationMat)*(u_PositionScale*a_PositionStartLifeTime.xyz+startPosition)+lifePosition;\n\t}\n  #else\n\t startPosition=startVelocity*age;\n\t vec3 finalPosition;\n\t if(u_ScalingMode!=2)\n\t   finalPosition = mat3(u_WorldRotationMat)*(u_PositionScale*(a_PositionStartLifeTime.xyz+startPosition));\n\t else\n\t   finalPosition = mat3(u_WorldRotationMat)*(u_PositionScale*a_PositionStartLifeTime.xyz+startPosition);\n  #endif\n  \n  if(u_SimulationSpace==0)\n    finalPosition=finalPosition+a_SimulationWorldPostion;\n  else if(u_SimulationSpace==1) \n    finalPosition=finalPosition+u_WorldPosition;\n  \n  finalPosition+=u_Gravity*age*normalizedAge;//计算受重力影响的位置//TODO:移除\n \n  return  finalPosition;\n}\n\n\nvec4 computeParticleColor(in vec4 color,in float normalizedAge)\n{\n\t#ifdef COLOROVERLIFETIME\n\t  color*=getColorFromGradient(u_ColorOverLifeGradientAlphas,u_ColorOverLifeGradientColors,normalizedAge);\n\t#endif\n\t\n\t#ifdef RANDOMCOLOROVERLIFETIME\n\t  color*=mix(getColorFromGradient(u_ColorOverLifeGradientAlphas,u_ColorOverLifeGradientColors,normalizedAge),getColorFromGradient(u_MaxColorOverLifeGradientAlphas,u_MaxColorOverLifeGradientColors,normalizedAge),a_Random0.y);\n\t#endif\n\n    return color;\n}\n\nvec2 computeParticleSize(in vec2 size,in float normalizedAge)\n{\n\t#ifdef SIZEOVERLIFETIMECURVE\n\t\tsize*=getCurValueFromGradientFloat(u_SOLSizeGradient,normalizedAge);\n\t#endif\n\t#ifdef SIZEOVERLIFETIMERANDOMCURVES\n\t    size*=mix(getCurValueFromGradientFloat(u_SOLSizeGradient,normalizedAge),getCurValueFromGradientFloat(u_SOLSizeGradientMax,normalizedAge),a_Random0.z); \n\t#endif\n\t#ifdef SIZEOVERLIFETIMECURVESEPERATE\n\t\tsize*=vec2(getCurValueFromGradientFloat(u_SOLSizeGradientX,normalizedAge),getCurValueFromGradientFloat(u_SOLSizeGradientY,normalizedAge));\n\t#endif\n\t#ifdef SIZEOVERLIFETIMERANDOMCURVESSEPERATE\n\t    size*=vec2(mix(getCurValueFromGradientFloat(u_SOLSizeGradientX,normalizedAge),getCurValueFromGradientFloat(u_SOLSizeGradientMaxX,normalizedAge),a_Random0.z)\n\t    ,mix(getCurValueFromGradientFloat(u_SOLSizeGradientY,normalizedAge),getCurValueFromGradientFloat(u_SOLSizeGradientMaxY,normalizedAge),a_Random0.z));\n\t#endif\n\treturn size;\n}\n\nvec3 computeParticleRotation(in vec3 rotation,in float age,in float normalizedAge)//TODO:不分轴是否无需计算XY，Billboard模式下好像是,待确认。\n{ \n\t#ifdef ROTATIONOVERLIFETIME\n\t#ifdef ROTATIONOVERLIFETIMECONSTANT\n\t\t\tfloat ageRot=u_ROLAngularVelocityConst*age;\n\t        rotation+=ageRot;\n\t\t#endif\n\t\t#ifdef ROTATIONOVERLIFETIMECURVE\n\t\t\trotation+=getTotalValueFromGradientFloat(u_ROLAngularVelocityGradient,normalizedAge);\n\t\t#endif\n\t\t#ifdef ROTATIONOVERLIFETIMERANDOMCONSTANTS\n\t\t\tfloat ageRot=mix(u_ROLAngularVelocityConst,u_ROLAngularVelocityConstMax,a_Random0.w)*age;\n\t        rotation+=ageRot;\n\t    #endif\n\t\t#ifdef ROTATIONOVERLIFETIMERANDOMCURVES\n\t\t\trotation+=mix(getTotalValueFromGradientFloat(u_ROLAngularVelocityGradient,normalizedAge),getTotalValueFromGradientFloat(u_ROLAngularVelocityGradientMax,normalizedAge),a_Random0.w);\n\t\t#endif\n\t#endif\n\t#ifdef ROTATIONOVERLIFETIMESEPERATE\n\t#ifdef ROTATIONOVERLIFETIMECONSTANT\n\t\t\tvec3 ageRot=u_ROLAngularVelocityConstSeprarate*age;\n\t        rotation+=ageRot;\n\t\t#endif\n\t\t#ifdef ROTATIONOVERLIFETIMECURVE\n\t\t\trotation+=vec3(getTotalValueFromGradientFloat(u_ROLAngularVelocityGradientX,normalizedAge),getTotalValueFromGradientFloat(u_ROLAngularVelocityGradientY,normalizedAge),getTotalValueFromGradientFloat(u_ROLAngularVelocityGradientZ,normalizedAge));\n\t\t#endif\n\t\t#ifdef ROTATIONOVERLIFETIMERANDOMCONSTANTS\n\t\t\tvec3 ageRot=mix(u_ROLAngularVelocityConstSeprarate,u_ROLAngularVelocityConstMaxSeprarate,a_Random0.w)*age;\n\t        rotation+=ageRot;\n\t    #endif\n\t\t#ifdef ROTATIONOVERLIFETIMERANDOMCURVES\n\t\t\trotation+=vec3(mix(getTotalValueFromGradientFloat(u_ROLAngularVelocityGradientX,normalizedAge),getTotalValueFromGradientFloat(u_ROLAngularVelocityGradientMaxX,normalizedAge),a_Random0.w)\n\t        ,mix(getTotalValueFromGradientFloat(u_ROLAngularVelocityGradientY,normalizedAge),getTotalValueFromGradientFloat(u_ROLAngularVelocityGradientMaxY,normalizedAge),a_Random0.w)\n\t        ,mix(getTotalValueFromGradientFloat(u_ROLAngularVelocityGradientZ,normalizedAge),getTotalValueFromGradientFloat(u_ROLAngularVelocityGradientMaxZ,normalizedAge),a_Random0.w));\n\t\t#endif\n\t#endif\n\treturn rotation;\n}\n\nvec2 computeParticleUV(in vec2 uv,in float normalizedAge)\n{ \n\t#ifdef TEXTURESHEETANIMATIONCURVE\n\t\tfloat cycleNormalizedAge=normalizedAge*u_TSACycles;\n\t\tfloat frame=getFrameFromGradient(u_TSAGradientUVs,cycleNormalizedAge-floor(cycleNormalizedAge));\n\t\tfloat totalULength=frame*u_TSASubUVLength.x;\n\t\tfloat floorTotalULength=floor(totalULength);\n\t    uv.x=uv.x+totalULength-floorTotalULength;\n\t\tuv.y=uv.y+floorTotalULength*u_TSASubUVLength.y;\n    #endif\n\t#ifdef TEXTURESHEETANIMATIONRANDOMCURVE\n\t\tfloat cycleNormalizedAge=normalizedAge*u_TSACycles;\n\t\tfloat uvNormalizedAge=cycleNormalizedAge-floor(cycleNormalizedAge);\n\t    float frame=floor(mix(getFrameFromGradient(u_TSAGradientUVs,uvNormalizedAge),getFrameFromGradient(u_TSAMaxGradientUVs,uvNormalizedAge),a_Random1.x));\n\t\tfloat totalULength=frame*u_TSASubUVLength.x;\n\t\tfloat floorTotalULength=floor(totalULength);\n\t    uv.x=uv.x+totalULength-floorTotalULength;\n\t\tuv.y=uv.y+floorTotalULength*u_TSASubUVLength.y;\n    #endif\n\treturn uv;\n}\n\nvoid main()\n{\n   float age = u_CurrentTime - a_DirectionTime.w;\n   float normalizedAge = age/a_PositionStartLifeTime.w;\n   vec3 lifeVelocity;\n   if(normalizedAge<1.0){ \n\t  vec3 startVelocity=a_DirectionTime.xyz*a_StartSpeed;\n   #ifdef defined(VELOCITYOVERLIFETIMECONSTANT)||defined(VELOCITYOVERLIFETIMECURVE)||defined(VELOCITYOVERLIFETIMERANDOMCONSTANT)||defined(VELOCITYOVERLIFETIMERANDOMCURVE)\n\t  lifeVelocity= computeParticleLifeVelocity(normalizedAge);//计算粒子生命周期速度\n   #endif \n\t  \n   vec3 center=computeParticlePosition(startVelocity, lifeVelocity, age, normalizedAge);//计算粒子位置\n   vec2 corner=a_CornerTextureCoordinate.xy;//Billboard模式z轴无效\n   \n   #ifdef SPHERHBILLBOARD\n        vec3 cameraUpVector =normalize(u_CameraUp);//TODO:是否外面归一化\n        vec3 sideVector = normalize(cross(u_CameraDirection,cameraUpVector));\n        vec3 upVector = normalize(cross(sideVector,u_CameraDirection));\n\t    corner*=computeParticleSize(a_StartSize.xy,normalizedAge);\n\t\tif(u_ThreeDStartRotation){\n\t\t  center += u_SizeScale.xzy*(mat3(a_StartRotation0,a_StartRotation1,a_StartRotation2)*(corner.x*sideVector+corner.y*upVector));\n\t\t}\n\t\telse{\n\t\t  vec3 rotationAng = computeParticleRotation(a_StartRotation0, age,normalizedAge);\n\t\t  float rot=rotationAng.z;\n          float c = cos(rot);\n          float s = sin(rot);\n          mat2 rotation= mat2(c, -s, s, c);\n\t\t  corner=rotation*corner;\n\t\t  center += u_SizeScale.xzy*(corner.x*sideVector+corner.y*upVector);\n\t\t}\n       \n   #endif\n   \n   #ifdef STRETCHEDBILLBOARD\n\tvec3 velocity;\n\t#ifdef defined(VELOCITYOVERLIFETIMECONSTANT)||defined(VELOCITYOVERLIFETIMECURVE)||defined(VELOCITYOVERLIFETIMERANDOMCONSTANT)||defined(VELOCITYOVERLIFETIMERANDOMCURVE)\n\t    if(u_VOLSpaceType==0)\n\t\t  velocity=mat3(u_WorldRotationMat)*(u_SizeScale*(startVelocity+lifeVelocity));\n\t    else\n\t\t  velocity=mat3(u_WorldRotationMat)*(u_SizeScale*startVelocity)+lifeVelocity;\n    #else\n\t    velocity= mat3(u_WorldRotationMat)*(u_SizeScale*startVelocity);\n    #endif   \n        vec3 cameraUpVector =normalize(velocity);\n        vec3 sideVector = normalize(cross(u_CameraDirection,cameraUpVector));\n\t    vec2 size=computeParticleSize(a_StartSize.xy,normalizedAge);\n\t    const mat2 rotaionZHalfPI=mat2(0.0, -1.0, 1.0, 0.0);\n\t    corner=rotaionZHalfPI*corner;\n\t    corner.y=corner.y-abs(corner.y);\n\t    float speed=length(velocity);//TODO:\n\t    center +=u_SizeScale.xzy*size.x*corner.x*sideVector+((cameraUpVector*speed)*u_StretchedBillboardSpeedScale+cameraUpVector*size.y*u_StretchedBillboardLengthScale)*corner.y;\n   #endif\n   \n   #ifdef HORIZONTALBILLBOARD\n        const vec3 cameraUpVector =vec3(0.0,0.0,-1.0);\n\t    const vec3 sideVector = vec3(1.0,0.0,0.0);\n\t\tcorner*=computeParticleSize(a_StartSize.xy,normalizedAge);\n\t\tvec3 rotationAng = computeParticleRotation(a_StartRotation0, age,normalizedAge);\n\t    float rot=rotationAng.z;\n        float c = cos(rot);\n        float s = sin(rot);\n        mat2 rotation= mat2(c, -s, s, c);\n\t    corner=rotation*corner*cos(0.78539816339744830961566084581988);//TODO:临时缩小cos45,不确定U3D原因\n        center +=u_SizeScale.xzy*(corner.x*sideVector+ corner.y*cameraUpVector);\n   #endif\n   \n   #ifdef VERTICALBILLBOARD\n        const vec3 cameraUpVector =vec3(0.0,1.0,0.0);\n        vec3 sideVector = normalize(cross(u_CameraDirection,cameraUpVector));\n\t\tcorner*=computeParticleSize(a_StartSize.xy,normalizedAge);\n\t\tvec3 rotationAng = computeParticleRotation(a_StartRotation0, age,normalizedAge);\n\t\tfloat rot=rotationAng.z;\n        float c = cos(rot);\n        float s = sin(rot);\n        mat2 rotation= mat2(c, -s, s, c);\n\t    corner=rotation*corner*cos(0.78539816339744830961566084581988);//TODO:临时缩小cos45,不确定U3D原因\n        center +=u_SizeScale.xzy*(corner.x*sideVector+ corner.y*cameraUpVector);\n   #endif\n   \n      gl_Position=u_Projection*u_View*vec4(center,1.0);\n      v_Color = computeParticleColor(a_StartColor, normalizedAge);\n      v_TextureCoordinate =computeParticleUV(a_CornerTextureCoordinate.zw, normalizedAge);\n      v_Discard=0.0;\n   }\n   else\n   {\n      v_Discard=1.0;\n   }\n}\n\n",t="#ifdef FSHIGHPRECISION\n  precision highp float;\n#else\n  precision mediump float;\n#endif\n\nvarying float v_Discard;\nvarying vec4 v_Color;\nvarying vec2 v_TextureCoordinate;\nuniform sampler2D u_texture;\nuniform vec4 u_Tintcolor;\n\n\nvoid main()\n{\t\n\t#ifdef DIFFUSEMAP\n\t  if(v_Discard!=0.0)\n         discard;\n\t  gl_FragColor=texture2D(u_texture,v_TextureCoordinate)*u_Tintcolor*2.0*v_Color;\n\t#else\n\t  gl_FragColor=vec4(0.0);\n\t#endif\n}",a=lt.add(c,e,t,n,i),Qt.SHADERDEFINE_DIFFUSEMAP=a.registerDefine("DIFFUSEMAP"),Qt.SHADERDEFINE_SPHERHBILLBOARD=a.registerDefine("SPHERHBILLBOARD"),Qt.SHADERDEFINE_STRETCHEDBILLBOARD=a.registerDefine("STRETCHEDBILLBOARD"),Qt.SHADERDEFINE_HORIZONTALBILLBOARD=a.registerDefine("HORIZONTALBILLBOARD"),Qt.SHADERDEFINE_VERTICALBILLBOARD=a.registerDefine("VERTICALBILLBOARD"),Qt.SHADERDEFINE_COLOROVERLIFETIME=a.registerDefine("COLOROVERLIFETIME"),Qt.SHADERDEFINE_RANDOMCOLOROVERLIFETIME=a.registerDefine("RANDOMCOLOROVERLIFETIME"),Qt.SHADERDEFINE_VELOCITYOVERLIFETIMECONSTANT=a.registerDefine("VELOCITYOVERLIFETIMECONSTANT"),Qt.SHADERDEFINE_VELOCITYOVERLIFETIMECURVE=a.registerDefine("VELOCITYOVERLIFETIMECURVE"),Qt.SHADERDEFINE_VELOCITYOVERLIFETIMERANDOMCONSTANT=a.registerDefine("VELOCITYOVERLIFETIMERANDOMCONSTANT"),Qt.SHADERDEFINE_VELOCITYOVERLIFETIMERANDOMCURVE=a.registerDefine("VELOCITYOVERLIFETIMERANDOMCURVE"),Qt.SHADERDEFINE_TEXTURESHEETANIMATIONCURVE=a.registerDefine("TEXTURESHEETANIMATIONCURVE"),Qt.SHADERDEFINE_TEXTURESHEETANIMATIONRANDOMCURVE=a.registerDefine("TEXTURESHEETANIMATIONRANDOMCURVE"),Qt.SHADERDEFINE_ROTATIONOVERLIFETIME=a.registerDefine("ROTATIONOVERLIFETIME"),Qt.SHADERDEFINE_ROTATIONOVERLIFETIMESEPERATE=a.registerDefine("ROTATIONOVERLIFETIMESEPERATE"),Qt.SHADERDEFINE_ROTATIONOVERLIFETIMECONSTANT=a.registerDefine("ROTATIONOVERLIFETIMECONSTANT"),Qt.SHADERDEFINE_ROTATIONOVERLIFETIMECURVE=a.registerDefine("ROTATIONOVERLIFETIMECURVE"),Qt.SHADERDEFINE_ROTATIONOVERLIFETIMERANDOMCONSTANTS=a.registerDefine("ROTATIONOVERLIFETIMERANDOMCONSTANTS"),Qt.SHADERDEFINE_ROTATIONOVERLIFETIMERANDOMCURVES=a.registerDefine("ROTATIONOVERLIFETIMERANDOMCURVES"),Qt.SHADERDEFINE_SIZEOVERLIFETIMECURVE=a.registerDefine("SIZEOVERLIFETIMECURVE"),Qt.SHADERDEFINE_SIZEOVERLIFETIMECURVESEPERATE=a.registerDefine("SIZEOVERLIFETIMECURVESEPERATE"),Qt.SHADERDEFINE_SIZEOVERLIFETIMERANDOMCURVES=a.registerDefine("SIZEOVERLIFETIMERANDOMCURVES"),Qt.SHADERDEFINE_SIZEOVERLIFETIMERANDOMCURVESSEPERATE=a.registerDefine("SIZEOVERLIFETIMERANDOMCURVESSEPERATE"),n={a_Position:0,a_Texcoord0:2,a_Time:33},i={u_Texture:[0,1],u_Albedo:[1,1],u_CurrentTime:[2,1],u_Color:[3,1],u_Duration:[4,1],u_MvpMatrix:[1,2]};var _=kt.nameKey.add("GLITTER");e="attribute vec4 a_Position;\nattribute vec2 a_Texcoord0;\nattribute float a_Time;\n\nuniform mat4 u_MvpMatrix;\nuniform  float u_CurrentTime;\nuniform  vec4 u_Color;\nuniform float u_Duration;\n\nvarying vec2 v_Texcoord;\nvarying vec4 v_Color;\n\n\nvoid main()\n{\n  gl_Position = u_MvpMatrix * a_Position;\n  \n  float age = u_CurrentTime-a_Time;\n  float normalizedAge = clamp(age / u_Duration,0.0,1.0);\n   \n  v_Texcoord=a_Texcoord0;\n  \n  v_Color=u_Color;\n  v_Color.a*=1.0-normalizedAge;\n}\n",t="#ifdef FSHIGHPRECISION\nprecision highp float;\n#else\nprecision mediump float;\n#endif\n\nuniform vec4 u_Albedo;\nuniform sampler2D u_Texture;\n\nvarying vec2 v_Texcoord;\nvarying vec4 v_Color;\n\n\nvoid main()\n{\t\n  gl_FragColor=texture2D(u_Texture, v_Texcoord)*v_Color;\n  gl_FragColor=gl_FragColor*u_Albedo;\n}\n\n",a=lt.add(_,e,t,n,i),n={a_Position:0},i={u_Intensity:[1,1],u_AlphaBlending:[2,1],u_CubeTexture:[3,1],u_MvpMatrix:[4,3]};var d=kt.nameKey.add("SkyBox");e="attribute vec4 a_Position;\nuniform mat4 u_MvpMatrix;\nvarying vec3 v_Texcoord;\n\n\nvoid main()\n{\n  gl_Position = (u_MvpMatrix*a_Position).xyww;\n  v_Texcoord=a_Position.xyz;\n}\n",t="#ifdef FSHIGHPRECISION\nprecision highp float;\n#else\nprecision mediump float;\n#endif\n\nuniform float u_Intensity;\nuniform float u_AlphaBlending;\nuniform samplerCube u_CubeTexture;\n\nvarying vec3 v_Texcoord;\n\n\nvoid main()\n{\t\n  gl_FragColor=vec4(textureCube(u_CubeTexture, v_Texcoord).rgb*u_Intensity,u_AlphaBlending);\n}\n\n",lt.add(d,e,t,n,i),n={a_Position:0,a_Texcoord0:2},i={u_Intensity:[1,1],u_AlphaBlending:[2,1],u_texture:[3,1],u_MvpMatrix:[4,3]};var m=kt.nameKey.add("SkyDome");e="attribute vec4 a_Position;\nattribute vec2 a_Texcoord0;\nuniform mat4 u_MvpMatrix;\nvarying vec2 v_Texcoord;\n\n\nvoid main()\n{\n  gl_Position = (u_MvpMatrix*a_Position).xyww;\n  v_Texcoord = a_Texcoord0;\n}\n",t="#ifdef FSHIGHPRECISION\nprecision highp float;\n#else\nprecision mediump float;\n#endif\n\nuniform float u_Intensity;\nuniform float u_AlphaBlending;\nuniform sampler2D u_texture;\n\nvarying vec2 v_Texcoord;\n\n\nvoid main()\n{\t\n  gl_FragColor=vec4(texture2D(u_texture, v_Texcoord).rgb*u_Intensity,u_AlphaBlending);\n}\n\n",lt.add(m,e,t,n,i)},e._initResourceLoad=function(){var t=E.createMap;t.lh=[yt,"SPRITE3DHIERARCHY"],t.lm=[en,"MESH"],t.lmat=[Xt,"MATERIAL"],t.lpbr=[Wt,"MATERIAL"],t.ltc=[an,"TEXTURECUBE"],t.jpg=[rn,"nativeimage"],t.jpeg=[rn,"nativeimage"],t.png=[rn,"nativeimage"],t.lsani=[l,"arraybuffer"],t.lrani=[l,"arraybuffer"],t.raw=[$t,"arraybuffer"],t.mipmaps=[$t,"arraybuffer"],t.ani=[l,"arraybuffer"],t.lani=[l,"arraybuffer"],x.parserMap.SPRITE3DHIERARCHY=e._loadSprite3DHierarchy,x.parserMap.MESH=e._loadMesh,x.parserMap.MATERIAL=e._loadMaterial,x.parserMap.TEXTURECUBE=e._loadTextureCube},e.READ_BLOCK=function(){return e._readData.pos+=4,!0},e.READ_DATA=function(){return e._DATA.offset=e._readData.getUint32(),e._DATA.size=e._readData.getUint32(),!0},e.READ_STRINGS=function(){var t=[],n={offset:0,size:0};n.offset=e._readData.getUint16(),n.size=e._readData.getUint16();e._readData.pos;e._readData.pos=n.offset+e._DATA.offset;for(var i=0;i<n.size;i++){var r=e._readData.readUTFString();r.lastIndexOf(".lmat")===-1&&r.lastIndexOf(".lpbr")===-1||t.push(r)}return t},e._getSprite3DHierarchyInnerUrls=function(t,n,i,r,a){var s,o;switch(t.type){case"MeshSprite3D":s=t.instanceParams.loadPath,o=en;break;case"ShuriKenParticle3D":var l=t.customProps.materialPath;l?(s=l,o=Qt):(s=t.customProps.texturePath,o=rn)}if(s){var h=w.formatURL(s,a);r&&(h+=r),n.push({url:h,clas:o}),i[s]=h}for(var u=t.child,c=0,_=u.length;c<_;c++)e._getSprite3DHierarchyInnerUrls(u[c],n,i,r,a)},e._loadSprite3DHierarchy=function(t){var n=new x;n.on("complete",null,e._onSprite3DHierarchylhLoaded,[t]),n.load(t.url,"text",!1,null,!0)},e._onSprite3DHierarchylhLoaded=function(t,n){var i=t.url,r=dt.getURLVerion(i),a=w.getPath(w.formatURL(i)),s=[],o={},l=JSON.parse(n);e._getSprite3DHierarchyInnerUrls(l,s,o,r,a);var h=s.length,u=h+1,c=1/u;if(e._onProcessChange(t,0,c,1),h>0){var _=g.create(null,e._onProcessChange,[t,c,h/u],!1);e._innerSprite3DHierarchyLoaderManager.create(s,g.create(null,e._onSprite3DMeshsLoaded,[t,_,n,o]),_)}else e._onSprite3DMeshsLoaded(t,null,n,null)},e._onSprite3DMeshsLoaded=function(e,t,n,i){e.endLoad([n,i]),t&&t.recover()},e._loadMesh=function(t){var n=new x;n.on("complete",null,e._onMeshLmLoaded,[t]),n.load(t.url,"arraybuffer",!1,null,!0)},e._onMeshLmLoaded=function(t,n){var i,r,a=t.url,s=dt.getURLVerion(a),o=w.getPath(w.formatURL(a)),l={};e._readData=new d(n),e._readData.pos=0,e._readData.readUTFString(),e.READ_BLOCK();var h=0,u=0;for(h=0;h<2;h++){var c=e._readData.getUint16(),_=e._strings[c],m=e["READ_"+_];if(null==m)throw new Error("model file err,no this function:"+c+" "+_);1===h?i=m.call():m.call()}for(h=0,u=i.length;h<u;h++){var f=i[h];r=w.formatURL(f,o),s&&(r+=s),i[h]=r,l[f]=r}e._onProcessChange(t,0,.5,1);var p=g.create(null,e._onProcessChange,[t,.5,.5],!1);e._innerMeshLoaderManager.create(i,g.create(null,e._onMeshMateialLoaded,[t,p,n,l]),p)},e._onMeshMateialLoaded=function(e,t,n,i){e.endLoad([n,i]),t.recover()},e._getMaterialTexturePath=function(e,t,n){var i=e.length-4;return e.indexOf(".dds")!=i&&e.indexOf(".tga")!=i&&e.indexOf(".exr")!=i&&e.indexOf(".DDS")!=i&&e.indexOf(".TGA")!=i&&e.indexOf(".EXR")!=i||(e=e.substr(0,i)+".png"),e=w.formatURL(e,n),t&&(e+=t),e},e._loadMaterial=function(t){var n=new x;n.on("complete",null,e._onMaterilLmatLoaded,[t]),n.load(t.url,"json",!1,null,!0)},e._onMaterilLmatLoaded=function(t,n){var i,r=t.url,a=dt.getURLVerion(r),s=w.getPath(w.formatURL(r)),o=[],l={},h=n.customProps,u=n.version;if(u)switch(u){case"LAYAMATERIAL:01":for(var c=n.props.textures,_=0,d=c.length;_<d;_++){var m=c[_].path;m&&(i=e._getMaterialTexturePath(m,a,s),o.push(i),l[m]=i)}break;default:throw new Error("Laya3D:unkonwn version.")}else{var f=h.diffuseTexture.texture2D;if(f&&(i=e._getMaterialTexturePath(f,a,s),o.push(i),l[f]=i),h.normalTexture){var p=h.normalTexture.texture2D;p&&(i=e._getMaterialTexturePath(p,a,s),o.push(i),l[p]=i)}if(h.specularTexture){var v=h.specularTexture.texture2D;v&&(i=e._getMaterialTexturePath(v,a,s),o.push(i),l[v]=i)}if(h.emissiveTexture){var x=h.emissiveTexture.texture2D;x&&(i=e._getMaterialTexturePath(x,a,s),o.push(i),l[x]=i)}if(h.ambientTexture){var E=h.ambientTexture.texture2D;E&&(i=e._getMaterialTexturePath(E,a,s),o.push(i),l[E]=i)}if(h.reflectTexture){var M=h.reflectTexture.texture2D;M&&(i=e._getMaterialTexturePath(M,a,s),o.push(i),l[M]=i)}}var T=o.length,S=T+1,y=1/S
;if(e._onProcessChange(t,0,y,1),T>0){var D=g.create(null,e._onProcessChange,[t,y,T/S],!1);e._innerMaterialLoaderManager.create(o,g.create(null,e._onMateialTexturesLoaded,[t,D,n,l]),D,rn)}else e._onMateialTexturesLoaded(t,null,n,null)},e._onMateialTexturesLoaded=function(e,t,n,i){e.endLoad([n,i]),t&&t.recover()},e._loadTextureCube=function(t){var n=new x;n.on("complete",null,e._onTextureCubeLtcLoaded,[t]),n.load(t.url,"json",!1,null,!0)},e._onTextureCubeLtcLoaded=function(t,n){var i=w.getPath(w.formatURL(t.url)),r=[w.formatURL(n.px,i),w.formatURL(n.nx,i),w.formatURL(n.py,i),w.formatURL(n.ny,i),w.formatURL(n.pz,i),w.formatURL(n.nz,i)];e._onProcessChange(t,0,1/7,1);var a=g.create(null,e._onProcessChange,[t,1/7,6/7],!1);e._innerTextureCubeLoaderManager.load(r,g.create(null,e._onTextureCubeImagesLoaded,[t,r,a]),a,"nativeimage")},e._onTextureCubeImagesLoaded=function(e,t,n){var i=[];i.length=6;for(var r=0;r<6;r++){var a=t[r];i[r]=x.getRes(a),x.clearRes(a)}e.endLoad(i),n.recover()},e._onProcessChange=function(e,t,n,i){(i=t+i*n)<1&&e.event("progress",i)},e.init=function(t,i,r,a,s,o){if(void 0===r&&(r=!1),void 0===a&&(a=!1),void 0===s&&(s=!1),void 0===o&&(o=!0),f.isAntialias=r,f.isAlpha=a,f.premultipliedAlpha=s,f.isStencil=o,!D.isConchNode&&!N.enable())return void alert("Laya3D init err,must support webGL!");V.changeWebGLSize=e._changeWebGLSize,D.is3DMode=!0,e._innerTextureCubeLoaderManager.maxLoader=1,e._innerMaterialLoaderManager.maxLoader=1,e._innerMeshLoaderManager.maxLoader=1,e._innerSprite3DHierarchyLoaderManager.maxLoader=1,n.init(t,i),F.__init__(),lt.__init__(),e._initShader(),e._initResourceLoad(),e.treeDebug&&(e.debugPhasorSprite=new re)},e._readData=null,e.SPRITE3DHIERARCHY="SPRITE3DHIERARCHY",e.MESH="MESH",e.MATERIAL="MATERIAL",e.PBRMATERIAL="PBRMTL",e.TEXTURECUBE="TEXTURECUBE",e.shaderCompileDebug=!1,e.treeDebug=!1,e.debugPhasorSprite=null,i(e,["_DATA",function(){return this._DATA={offset:0,size:0}},"_strings",function(){return this._strings=["BLOCK","DATA","STRINGS"]},"_innerTextureCubeLoaderManager",function(){return this._innerTextureCubeLoaderManager=new E},"_innerMaterialLoaderManager",function(){return this._innerMaterialLoaderManager=new E},"_innerMeshLoaderManager",function(){return this._innerMeshLoaderManager=new E},"_innerSprite3DHierarchyLoaderManager",function(){return this._innerSprite3DHierarchyLoaderManager=new E}]),e}(),ft=function(e){function t(){this._destroyed=!1,this._id=0,this._cachedOwnerLayerMask=0,this._cachedOwnerEnable=!1,this._enable=!1,this._owner=null,this.started=!1,t.__super.call(this),this._destroyed=!1,this._id=t._uniqueIDCounter,t._uniqueIDCounter++}r(t,"laya.d3.component.Component3D",e);var i=t.prototype;return n.imps(i,{"laya.d3.core.render.IUpdate":!0,"laya.resource.IDestroy":!0}),i._onLayerChanged=function(e){this._cachedOwnerLayerMask=e.mask},i._onEnableChanged=function(e){this._cachedOwnerEnable=e},i._initialize=function(e){this._owner=e,this.enable=!0,this.started=!1,this._cachedOwnerLayerMask=e.layer.mask,this._owner.on("layerchanged",this,this._onLayerChanged),this._cachedOwnerEnable=e.enable,this._owner.on("enabledchanged",this,this._onEnableChanged),this._load(e)},i._destroy=function(){this._unload(this.owner),this._owner=null,this._destroyed=!0},i._load=function(e){},i._start=function(e){},i._update=function(e){},i._lateUpdate=function(e){},i._preRenderUpdate=function(e){},i._postRenderUpdate=function(e){},i._unload=function(e){this.offAll()},a(0,i,"id",function(){return this._id}),a(0,i,"destroyed",function(){return this._destroyed}),a(0,i,"owner",function(){return this._owner}),a(0,i,"enable",function(){return this._enable},function(e){this._enable!==e&&(this._enable=e,this.event("enabledchanged",this._enable))}),a(0,i,"isActive",function(){return F.isActive(this._cachedOwnerLayerMask)&&this._cachedOwnerEnable&&this._enable}),a(0,i,"isVisible",function(){return F.isVisible(this._cachedOwnerLayerMask)&&this._cachedOwnerEnable&&this._enable}),a(0,i,"isSingleton",function(){return t._isSingleton}),t._isSingleton=!0,t._uniqueIDCounter=1,t}(v),pt=function(e){function t(){this._destroyed=!1,t.__super.call(this),this._destroyed=!1}r(t,"laya.d3.core.GeometryFilter",e);var i=t.prototype;return n.imps(i,{"laya.resource.IDestroy":!0}),i._destroy=function(){this.offAll(),this._destroyed=!0},a(0,i,"_isAsyncLoaded",function(){return!0}),a(0,i,"_originalBoundingSphere",function(){throw new Error("BaseRender: must override it.")}),a(0,i,"_originalBoundingBox",function(){throw new Error("BaseRender: must override it.")}),a(0,i,"destroyed",function(){return this._destroyed}),t}(v),vt=function(e){function t(e){this._destroyed=!1,this._enable=!1,this._renderObject=null,this._materials=null,this._boundingSphere=null,this._boundingBox=null,this._boundingBoxCenter=null,this._boundingSphereNeedChange=!1,this._boundingBoxNeedChange=!1,this._boundingBoxCenterNeedChange=!1,this._octreeNodeNeedChange=!1,this._owner=null,this.sortingFudge=NaN,t.__super.call(this),this._destroyed=!1,this._owner=e,this._enable=!0,this._boundingBox=new Ye(new rt,new rt),this._boundingBoxCenter=new rt,this._boundingSphere=new Xe(new rt,0),this._boundingSphereNeedChange=!0,this._boundingBoxNeedChange=!0,this._boundingBoxCenterNeedChange=!0,this._octreeNodeNeedChange=!0,this._renderObject=new de(e),this._renderObject._render=this,this._renderObject._layerMask=this._owner.layer.mask,this._renderObject._ownerEnable=this._owner.enable,this._renderObject._enable=this._enable,this._materials=[],this.sortingFudge=0,this._owner.transform.on("worldmatrixneedchanged",this,this._onWorldMatNeedChange),this._owner.on("layerchanged",this,this._onOwnerLayerChanged),this._owner.on("enabledchanged",this,this._onOwnerEnableChanged),this.on("enabledchanged",this,this._onEnableChanged)}r(t,"laya.d3.core.render.BaseRender",e);var i=t.prototype;return n.imps(i,{"laya.resource.IDestroy":!0}),i._onWorldMatNeedChange=function(){this._boundingSphereNeedChange=!0,this._boundingBoxNeedChange=!0,this._boundingBoxCenterNeedChange=!0,this._octreeNodeNeedChange=!0},i._onOwnerLayerChanged=function(e){this._renderObject._layerMask=e.mask},i._onOwnerEnableChanged=function(e){this._renderObject._ownerEnable=e},i._onEnableChanged=function(e,t){this._renderObject._enable=t},i._calculateBoundingSphere=function(){throw"BaseRender: must override it."},i._calculateBoundingBox=function(){throw"BaseRender: must override it."},i._updateOctreeNode=function(){var e=this._renderObject._treeNode;e&&this._octreeNodeNeedChange&&(e.updateObject(this._renderObject),this._octreeNodeNeedChange=!1)},i._destroy=function(){this.offAll(),this._owner=null,this._renderObject=null,this._materials=null,this._boundingBox=null,this._boundingBoxCenter=null,this._boundingSphere=null,this._destroyed=!0},a(0,i,"enable",function(){return this._enable},function(e){this._enable=e,this.event("enabledchanged",[this,e])}),a(0,i,"boundingBox",function(){return this._boundingBoxNeedChange&&(this._calculateBoundingBox(),this._boundingBoxNeedChange=!1),this._boundingBox}),a(0,i,"sharedMaterials",function(){return this._materials.slice()},function(e){if(!e)throw new Error("MeshRender: shadredMaterials value can't be null.");this._materials=e;for(var t=0,n=e.length;t<n;t++)this.event("materialchanged",[this,t,e[t]])}),a(0,i,"renderObject",function(){return this._renderObject}),a(0,i,"boundingSphere",function(){return this._boundingSphereNeedChange&&(this._calculateBoundingSphere(),this._boundingSphereNeedChange=!1),this._boundingSphere}),a(0,i,"material",function(){var e=this._materials[0];if(e&&!e._isInstance){var t=new e.constructor;e.cloneTo(t),t.name=t.name+"(Instance)",t._isInstance=!0,this._materials[0]=t,this.event("materialchanged",[this,0,t])}return this._materials[0]},function(e){this._materials[0]=e,this.event("materialchanged",[this,0,e])}),a(0,i,"materials",function(){for(var e=0,t=this._materials.length;e<t;e++){var n=this._materials[e];if(!n._isInstance){var i=new n.constructor;n.cloneTo(i),i.name=i.name+"(Instance)",i._isInstance=!0,this._materials[e]=i,this.event("materialchanged",[this,e,i])}}return this._materials.slice()},function(e){if(!e)throw new Error("MeshRender: materials value can't be null.");this._materials=e;for(var t=0,n=e.length;t<n;t++)this.event("materialchanged",[this,t,e[t]])}),a(0,i,"sharedMaterial",function(){return this._materials[0]},function(e){this._materials[0]=e,this.event("materialchanged",[this,0,e])}),a(0,i,"boundingBoxCenter",function(){if(this._boundingBoxCenterNeedChange){var e=this.boundingBox;rt.add(e.min,e.max,this._boundingBoxCenter),rt.scale(this._boundingBoxCenter,.5,this._boundingBoxCenter),this._boundingBoxCenterNeedChange=!1}return this._boundingBoxCenter}),a(0,i,"destroyed",function(){return this._destroyed}),t}(v),gt=function(e){function t(e){this._owner=null,this._preWorldTransformModifyID=-1,this._localUpdate=!1,this._worldUpdate=!0,this._positionUpdate=!0,this._rotationUpdate=!0,this._scaleUpdate=!0,this._parent=null,this.pivot=null,t.__super.call(this),this._localPosition=new rt,this._localRotation=new et(0,0,0,1),this._localScale=new rt(1,1,1),this._localMatrix=new Ke,this._position=new rt,this._rotation=new et(0,0,0,1),this._scale=new rt(1,1,1),this._worldMatrix=new Ke,this._forward=new rt,this._up=new rt,this._right=new rt,this._owner=e}r(t,"laya.d3.core.Transform3D",e);var n=t.prototype;return n._updateLocalMatrix=function(){if(!this.pivot||0===this.pivot.x&&0===this.pivot.y&&0===this.pivot.z)Ke.createAffineTransformation(this._localPosition,this._localRotation,this._localScale,this._localMatrix);else{var e=t._tempVector30;rt.multiply(this.pivot,this._localScale,e);var n=t._tempVector31;rt.subtract(e,this.pivot,n);var i=t._tempVector32;rt.transformQuat(e,this._localRotation,i),rt.subtract(i,e,i);var r=t._tempVector33;rt.subtract(this._localPosition,n,r),rt.subtract(r,i,r),Ke.createAffineTransformation(r,this._localRotation,this._localScale,this._localMatrix)}},n._onLocalTransform=function(){this._localUpdate=!0},n._onWorldTransform=function(){if(!this._worldUpdate){this._worldUpdate=!0,this._positionUpdate=!0,this._rotationUpdate=!0,this._scaleUpdate=!0,this.event("worldmatrixneedchanged");for(var e=0,t=this._owner._childs.length;e<t;e++)this._owner._childs[e].transform._onWorldTransform()}},n.translate=function(e,n){void 0===n&&(n=!0),n?(Ke.createFromQuaternion(this.localRotation,t._tempMatrix0),rt.transformCoordinate(e,t._tempMatrix0,t._tempVector30),rt.add(this.localPosition,t._tempVector30,this._localPosition),this.localPosition=this._localPosition):(rt.add(this.position,e,this._position),this.position=this._position)},n.rotate=function(e,n,i){void 0===n&&(n=!0),void 0===i&&(i=!0);var r;i?r=e:(rt.scale(e,Math.PI/180,t._tempVector30),r=t._tempVector30),et.createFromYawPitchRoll(r.y,r.x,r.z,t._tempQuaternion0),n?(et.multiply(this._localRotation,t._tempQuaternion0,this._localRotation),this.localRotation=this._localRotation):(et.multiply(t._tempQuaternion0,this.rotation,this._rotation),this.rotation=this._rotation)},n.lookAt=function(e,t,n,i){void 0===i&&(i=!0),i?(Ke.createLookAt(e,t,n,this._localMatrix),this._localMatrix.invert(this._localMatrix),this.localMatrix=this._localMatrix):(Ke.createLookAt(e,t,n,this._worldMatrix),this._worldMatrix.invert(this._worldMatrix),this.worldMatrix=this._worldMatrix)},a(0,n,"_isFrontFaceInvert",function(){var e=this.scale,t=e.x<0;return e.y<0&&(t=!t),e.z<0&&(t=!t),t}),a(0,n,"localRotation",function(){return this._localRotation},function(e){this._localRotation=e,this._localRotation.normalize(this._localRotation),this._onLocalTransform(),this._onWorldTransform()}),a(0,n,"worldMatrix",function(){return this._worldUpdate?(null!=this._parent?Ke.multiply(this._parent.worldMatrix,this.localMatrix,this._worldMatrix):this.localMatrix.cloneTo(this._worldMatrix),this._worldUpdate=!1,this._worldMatrix):this._worldMatrix},function(e){null===this._parent?this.localMatrix=e:(this._parent.worldMatrix.invert(this._localMatrix),Ke.multiply(this._localMatrix,e,this._localMatrix),this.localMatrix=this._localMatrix)}),a(0,n,"worldNeedUpdate",function(){return this._worldUpdate}),a(0,n,"localMatrix",function(){return this._localUpdate&&(this._updateLocalMatrix(),this._localUpdate=!1),this._localMatrix},function(e){this._localMatrix=e,this._localMatrix.decomposeTransRotScale(this._localPosition,this._localRotation,this._localScale),this._onWorldTransform()}),a(0,n,"localPosition",function(){return this._localPosition},function(e){this._localPosition=e,this._onLocalTransform(),this._onWorldTransform()}),a(0,n,"localScale",function(){return this._localScale},function(e){this._localScale=e,this._onLocalTransform(),this._onWorldTransform()}),a(0,n,"position",function(){if(!this._positionUpdate)return this._position;if(null!==this._parent){var e=this.worldMatrix.elements;this._position.elements[0]=e[12],this._position.elements[1]=e[13],this._position.elements[2]=e[14]}else this._localPosition.cloneTo(this._position);return this._positionUpdate=!1,this._position},function(e){null!==this._parent?(this._parent.worldMatrix.invert(t._tempMatrix0),rt.transformCoordinate(e,t._tempMatrix0,this._localPosition),this.localPosition=this._localPosition):(e.cloneTo(this._localPosition),this.localPosition=this._localPosition)}),a(0,n,"localRotationEuler",null,function(e){et.createFromYawPitchRoll(e.y,e.x,e.z,this._localRotation),this._onLocalTransform(),this._onWorldTransform()}),a(0,n,"rotation",function(){return this._rotationUpdate?(null!==this._parent?this.worldMatrix.decomposeTransRotScale(this._position,this._rotation,this._scale):this._localRotation.cloneTo(this._rotation),this._rotationUpdate=!1,this._rotation):this._rotation},function(e){null!==this._parent?(this._parent.rotation.invert(t._tempQuaternion0),et.multiply(e,t._tempQuaternion0,this._localRotation),this.localRotation=this._localRotation):(e.cloneTo(this._localRotation),this.localRotation=this._localRotation)}),a(0,n,"scale",function(){return this._scaleUpdate?(null!==this._parent?rt.multiply(this._parent.scale,this._localScale,this._scale):this._localScale.cloneTo(this._scale),this._scaleUpdate=!1,this._scale):this._scale}),a(0,n,"rotationEuler",null,function(e){et.createFromYawPitchRoll(e.y,e.x,e.z,this._rotation),this.rotation=this._rotation}),a(0,n,"forward",function(){var e=this.worldMatrix.elements;return this._forward.elements[0]=-e[8],this._forward.elements[1]=-e[9],this._forward.elements[2]=-e[10],this._forward}),a(0,n,"up",function(){var e=this.worldMatrix.elements;return this._up.elements[0]=e[4],this._up.elements[1]=e[5],this._up.elements[2]=e[6],this._up}),a(0,n,"right",function(){var e=this.worldMatrix.elements;return this._right.elements[0]=e[0],this._right.elements[1]=e[1],this._right.elements[2]=e[2],this._right}),a(0,n,"parent",null,function(e){this._parent=e,this._onWorldTransform()}),i(t,["_tempVector30",function(){return this._tempVector30=new rt},"_tempVector31",function(){return this._tempVector31=new rt},"_tempVector32",function(){return this._tempVector32=new rt},"_tempVector33",function(){return this._tempVector33=new rt},"_tempQuaternion0",function(){return this._tempQuaternion0=new et},"_tempMatrix0",function(){return this._tempMatrix0=new Ke}]),t}(v),xt=(function(e){function t(){this._rotation=0,this._tiling=null,this._matNeedUpdte=!1,t.__super.call(this),this._tempRotationMatrix=new Ke,this._tempTitlingMatrix=new Ke,this._matrix=new Ke,this._offset=new it,this._tiling=new it(1,1)}r(t,"laya.d3.core.TransformUV",e);var n=t.prototype;n._updateMatrix=function(){t._tempOffsetV3.elements[0]=this._offset.x,t._tempOffsetV3.elements[1]=this._offset.y,et.createFromYawPitchRoll(0,0,this._rotation,t._tempRotationQua),t._tempTitlingV3.elements[0]=this._tiling.x,t._tempTitlingV3.elements[1]=this._tiling.y,Ke.createAffineTransformation(t._tempOffsetV3,t._tempRotationQua,t._tempTitlingV3,this._matrix)},a(0,n,"matrix",function(){return this._matNeedUpdte&&(this._updateMatrix(),this._matNeedUpdte=!1),this._matrix}),a(0,n,"tiling",function(){return this._tiling},function(e){this._tiling=e,this._matNeedUpdte=!0}),a(0,n,"offset",function(){return this._offset},function(e){this._offset=e,this._matNeedUpdte=!0}),a(0,n,"rotation",function(){return this._rotation},function(e){this._rotation=e,this._matNeedUpdte=!0}),i(t,["_tempOffsetV3",function(){return this._tempOffsetV3=new rt(0,0,0)},"_tempRotationQua",function(){return this._tempRotationQua=new et},"_tempTitlingV3",function(){return this._tempTitlingV3=new rt(1,1,1)}]),t}(v),function(e){function t(e){this._settings=null,this._particle3D=null,t.__super.call(this),this._resultPosition=new rt,this._resultVelocity=new rt,this.centerPosition=new rt,this.size=new rt,this.velocity=new rt,this.velocityAddVariance=new rt,this._particle3D=e;for(var n=e.templet.settings,i=0;i<3;i++)this.centerPosition.elements[i]=n.boxEmitterCenterPosition[i],this.size.elements[i]=n.boxEmitterSize[i],this.velocity.elements[i]=n.boxEmitterVelocity[i],this.velocityAddVariance.elements[i]=n.boxEmitterVelocityAddVariance[i];this.emissionRate=n.emissionRate}r(t,"laya.d3.core.particle.EmitterBox",e);var n=t.prototype;n._randomPositionOnBox=function(){var e=this._resultPosition.elements,t=this.centerPosition.elements,n=this.size.elements;return e[0]=t[0]+n[0]*(Math.random()-.5),e[1]=t[1]+n[1]*(Math.random()-.5),e[2]=t[2]+n[2]*(Math.random()-.5),this._resultPosition},n._randomVelocityOnBox=function(){var e=this._resultVelocity.elements,t=this.velocity.elements,n=this.velocityAddVariance.elements;return e[0]=t[0]+n[0]*Math.random(),e[1]=t[1]+n[1]*Math.random(),e[2]=t[2]+n[2]*Math.random(),this._resultVelocity},n.emit=function(){e.prototype.emit.call(this),this._particle3D.templet.addParticle(this._randomPositionOnBox(),this._randomVelocityOnBox())},n.update=function(e){this.advanceTime(e.elapsedTime/1e3)},t}(p),function(e){function t(e){this._settings=null,this._particle3D=null,t.__super.call(this),this._resultPosition=new rt,this._resultVelocity=new rt,this.position=new rt,this.positionVariance=new rt,this.velocity=new rt,this.velocityAddVariance=new rt,this._particle3D=e;for(var n=e.templet.settings,i=0;i<3;i++)this.position.elements[i]=n.pointEmitterPosition[i],this.positionVariance.elements[i]=n.pointEmitterPositionVariance[i],this.velocity.elements[i]=n.pointEmitterVelocity[i],this.velocityAddVariance.elements[i]=n.pointEmitterVelocityAddVariance[i];this.emissionRate=n.emissionRate}r(t,"laya.d3.core.particle.EmitterPoint",e);var n=t.prototype;n._randomPositionOnPoint=function(){var e=this._resultPosition.elements,t=this.position.elements,n=this.positionVariance.elements;return e[0]=t[0]+n[0]*(Math.random()-.5)*2,e[1]=t[1]+n[1]*(Math.random()-.5)*2,e[2]=t[2]+n[2]*(Math.random()-.5)*2,this._resultPosition},n._randomVelocityOnPoint=function(){var e=this._resultVelocity.elements,t=this.velocity.elements,n=this.velocityAddVariance.elements;return e[0]=t[0]+n[0]*Math.random(),e[1]=t[1]+n[1]*Math.random(),e[2]=t[2]+n[2]*Math.random(),this._resultVelocity},n.emit=function(){e.prototype.emit.call(this),this._particle3D.templet.addParticle(this._randomPositionOnPoint(),this._randomVelocityOnPoint())},n.update=function(e){this.advanceTime(e.elapsedTime/1e3)},t}(p),function(e){function t(e){this._settings=null,this._particle3D=null,this.radius=30,this.velocity=0,this.velocityAddVariance=0,this.up=2,t.__super.call(this),this._resultPosition=new rt,this._resultVelocity=new rt,this._direction=new rt,this.centerPosition=new rt,this._particle3D=e;for(var n=e.templet.settings,i=0;i<3;i++)this.centerPosition.elements[i]=n.ringEmitterCenterPosition[i];this.radius=n.ringEmitterRadius,this.velocity=n.ringEmitterVelocity,this.velocityAddVariance=n.ringEmitterVelocityAddVariance,this.emissionRate=n.emissionRate}r(t,"laya.d3.core.particle.EmitterRing",e);var n=t.prototype;n._randomPointOnRing=function(){var e=Math.random()*Math.PI*2,t=Math.cos(e),n=Math.sin(e),i=this._resultPosition.elements,r=this.centerPosition.elements;switch(this.up){case 0:i[0]=r[0]+0,i[1]=r[1]+t*this.radius,i[2]=r[2]+n*this.radius;break;case 1:i[0]=r[0]+t*this.radius,i[1]=r[1]+0,i[2]=r[2]+n*this.radius;break;case 2:i[0]=r[0]+t*this.radius,i[1]=r[1]+n*this.radius,i[2]=r[2]+0}return this._resultPosition},n._randomVelocityOnRing=function(){var e=this._resultVelocity.elements;this._resultPosition.cloneTo(this._direction),rt.normalize(this._direction,this._direction);var t=this._direction.elements;return e[0]=t[0]*(this.velocity+this.velocityAddVariance*Math.random()),e[1]=t[1]*(this.velocity+this.velocityAddVariance*Math.random()),e[2]=t[2]*(this.velocity+this.velocityAddVariance*Math.random()),this._resultVelocity},n.emit=function(){e.prototype.emit.call(this),this._particle3D.templet.addParticle(this._randomPointOnRing(),this._randomVelocityOnRing())},n.update=function(e){this.advanceTime(e/1e3)},t}(p),function(e){function t(e){this._settings=null,this._particle3D=null,this.radius=1,this.velocity=0,this.velocityAddVariance=0,t.__super.call(this),this._reultPosition=new rt,this._resultVelocity=new rt,this._direction=new rt,this.centerPosition=new rt,this._particle3D=e;for(var n=e.templet.settings,i=0;i<3;i++)this.centerPosition.elements[i]=n.sphereEmitterCenterPosition[i];this.radius=n.sphereEmitterRadius,this.velocity=n.sphereEmitterVelocity,this.velocityAddVariance=n.sphereEmitterVelocityAddVariance,this.emissionRate=n.emissionRate}r(t,"laya.d3.core.particle.EmitterSphere",e);var n=t.prototype;n._randomPositionOnSphere=function(){var e=Math.random()*Math.PI*2,t=Math.random()*Math.PI*2,n=Math.cos(e)*this.radius,i=Math.sin(e)*this.radius,r=Math.cos(t)*n,a=Math.sin(t)*n,s=this._reultPosition.elements,o=this.centerPosition.elements;return s[0]=o[0]+r,s[1]=o[1]+i,s[2]=o[2]+a,this._reultPosition},n._randomVelocityOnSphere=function(){var e=this._resultVelocity.elements;this._reultPosition.cloneTo(this._direction),rt.normalize(this._direction,this._direction);var t=this._direction.elements;return e[0]=t[0]*(this.velocity+this.velocityAddVariance*Math.random()),e[1]=t[1]*(this.velocity+this.velocityAddVariance*Math.random()),e[2]=t[2]*(this.velocity+this.velocityAddVariance*Math.random()),this._resultVelocity},n.emit=function(){e.prototype.emit.call(this),this._particle3D.templet.addParticle(this._randomPositionOnSphere(),this._randomVelocityOnSphere())},n.update=function(e){this.advanceTime(e.elapsedTime/1e3)},t}(p),function(e){function t(){t.__super.call(this)}r(t,"laya.d3.core.glitter.SplineCurvePosition",e);var n=t.prototype;n._CalcVelocity=function(e,t,n){rt.subtract(e,t,n),rt.scale(n,.5,n)},n.Init=function(t,n,i,r){this._CalcVelocity(n,t,this._tempVector30),this._CalcVelocity(r,i,this._tempVector31),e.prototype.Init.call(this,n,this._tempVector30,r,this._tempVector31)},t}(L),function(e){function t(){this.x=NaN,this.y=NaN,this.z=NaN,this.randomDirection=!1,t.__super.call(this),this.x=1,this.y=1,this.z=1,this.randomDirection=!1}r(t,"laya.d3.core.particleShuriKen.module.shape.BoxShape",e);var n=t.prototype;return n.generatePositionAndDirection=function(e,t,n,i){var r=e.elements,a=t.elements;n?(n.seed=i[16],$._randomPointInsideHalfUnitBox(e,n),i[16]=n.seed):$._randomPointInsideHalfUnitBox(e),r[0]=this.x*r[0],r[1]=this.y*r[1],r[2]=this.z*r[2],this.randomDirection?n?(n.seed=i[17],$._randomPointUnitSphere(t,n),i[17]=n.seed):$._randomPointUnitSphere(t):(a[0]=0,a[1]=0,a[2]=1)},n.cloneTo=function(t){e.prototype.cloneTo.call(this,t);var n=t;n.x=this.x,n.y=this.y,n.z=this.z,n.randomDirection=this.randomDirection},t}(K)),Et=function(e){function t(){this.radius=NaN,this.arc=NaN,this.emitFromEdge=!1,this.randomDirection=!1,t.__super.call(this),this.radius=1,this.arc=2*Math.PI,this.emitFromEdge=!1,this.randomDirection=!1}r(t,"laya.d3.core.particleShuriKen.module.shape.CircleShape",e);var n=t.prototype;return n.generatePositionAndDirection=function(e,n,i,r){var a=e.elements,s=t._tempPositionPoint.elements;i?(i.seed=r[16],this.emitFromEdge?$._randomPointUnitArcCircle(this.arc,t._tempPositionPoint,i):$._randomPointInsideUnitArcCircle(this.arc,t._tempPositionPoint,i),r[16]=i.seed):this.emitFromEdge?$._randomPointUnitArcCircle(this.arc,t._tempPositionPoint):$._randomPointInsideUnitArcCircle(this.arc,t._tempPositionPoint),a[0]=s[0],a[1]=s[1],a[2]=0,rt.scale(e,this.radius,e),this.randomDirection?i?(i.seed=r[17],$._randomPointUnitSphere(n,i),r[17]=i.seed):$._randomPointUnitSphere(n):e.cloneTo(n)},n.cloneTo=function(t){e.prototype.cloneTo.call(this,t);var n=t;n.radius=this.radius,n.arc=this.arc,n.emitFromEdge=this.emitFromEdge,n.randomDirection=this.randomDirection},i(t,["_tempPositionPoint",function(){return this._tempPositionPoint=new it}]),t}(K),Mt=function(e){function t(){this.angle=NaN,this.radius=NaN,this.length=NaN,this.emitType=0,this.randomDirection=!1,t.__super.call(this),this.angle=25/180*Math.PI,this.radius=1,this.length=5,this.emitType=0,this.randomDirection=!1}r(t,"laya.d3.core.particleShuriKen.module.shape.ConeShape",e);var n=t.prototype;return n.generatePositionAndDirection=function(e,n,i,r){var a,s=e.elements,o=n.elements,l=t._tempPositionPoint.elements,h=NaN,u=NaN,c=Math.cos(this.angle),_=Math.sin(this.angle);switch(this.emitType){case 0:i?(i.seed=r[16],$._randomPointInsideUnitCircle(t._tempPositionPoint,i),r[16]=i.seed):$._randomPointInsideUnitCircle(t._tempPositionPoint),h=l[0],u=l[1],s[0]=h*this.radius,s[1]=u*this.radius,s[2]=0,this.randomDirection?(i?(i.seed=r[17],$._randomPointInsideUnitCircle(t._tempDirectionPoint,i),r[17]=i.seed):$._randomPointInsideUnitCircle(t._tempDirectionPoint),a=t._tempDirectionPoint.elements,o[0]=a[0]*_,o[1]=a[1]*_):(o[0]=h*_,o[1]=u*_),o[2]=c;break;case 1:i?(i.seed=r[16],$._randomPointUnitCircle(t._tempPositionPoint,i),r[16]=i.seed):$._randomPointUnitCircle(t._tempPositionPoint),h=l[0],u=l[1],s[0]=h*this.radius,s[1]=u*this.radius,s[2]=0,this.randomDirection?(i?(i.seed=r[17],$._randomPointInsideUnitCircle(t._tempDirectionPoint,i),r[17]=i.seed):$._randomPointInsideUnitCircle(t._tempDirectionPoint),a=t._tempDirectionPoint.elements,o[0]=a[0]*_,o[1]=a[1]*_):(o[0]=h*_,o[1]=u*_),o[2]=c;break;case 2:i?(i.seed=r[16],$._randomPointInsideUnitCircle(t._tempPositionPoint,i)):$._randomPointInsideUnitCircle(t._tempPositionPoint),h=l[0],u=l[1],s[0]=h*this.radius,s[1]=u*this.radius,s[2]=0,o[0]=h*_,o[1]=u*_,o[2]=c,rt.normalize(n,n),i?(rt.scale(n,this.length*i.getFloat(),n),r[16]=i.seed):rt.scale(n,this.length*Math.random(),n),rt.add(e,n,e),this.randomDirection&&(i?(i.seed=r[17],$._randomPointUnitSphere(n,i),r[17]=i.seed):$._randomPointUnitSphere(n));break;case 3:i?(i.seed=r[16],$._randomPointUnitCircle(t._tempPositionPoint,i)):$._randomPointUnitCircle(t._tempPositionPoint),h=l[0],u=l[1],s[0]=h*this.radius,s[1]=u*this.radius,s[2]=0,o[0]=h*_,o[1]=u*_,o[2]=c,rt.normalize(n,n),i?(rt.scale(n,this.length*i.getFloat(),n),r[16]=i.seed):rt.scale(n,this.length*Math.random(),n),rt.add(e,n,e),this.randomDirection&&(i?(i.seed=r[17],$._randomPointUnitSphere(n,i),r[17]=i.seed):$._randomPointUnitSphere(n));break;default:throw new Error("ConeShape:emitType is invalid.")}},n.cloneTo=function(t){e.prototype.cloneTo.call(this,t);var n=t;n.angle=this.angle,n.radius=this.radius,n.length=this.length,n.emitType=this.emitType,n.randomDirection=this.randomDirection},i(t,["_tempPositionPoint",function(){return this._tempPositionPoint=new it},"_tempDirectionPoint",function(){return this._tempDirectionPoint=new it}]),t}(K),Tt=function(e){function t(){this.radius=NaN,this.emitFromShell=!1,this.randomDirection=!1,t.__super.call(this),this.radius=1,this.emitFromShell=!1,this.randomDirection=!1}r(t,"laya.d3.core.particleShuriKen.module.shape.HemisphereShape",e);var n=t.prototype;return n.generatePositionAndDirection=function(e,t,n,i){var r=e.elements;n?(n.seed=i[16],this.emitFromShell?$._randomPointUnitSphere(e,n):$._randomPointInsideUnitSphere(e,n),i[16]=n.seed):this.emitFromShell?$._randomPointUnitSphere(e):$._randomPointInsideUnitSphere(e),rt.scale(e,this.radius,e);var a=r[2];a>0&&(r[2]=a*-1),this.randomDirection?n?(n.seed=i[17],$._randomPointUnitSphere(t,n),i[17]=n.seed):$._randomPointUnitSphere(t):e.cloneTo(t)},n.cloneTo=function(t){e.prototype.cloneTo.call(this,t);var n=t;n.radius=this.radius,n.emitFromShell=this.emitFromShell,n.randomDirection=this.randomDirection},t}(K),St=function(e){function t(){this.radius=NaN,this.emitFromShell=!1,this.randomDirection=!1,t.__super.call(this),this.radius=1,this.emitFromShell=!1,this.randomDirection=!1}r(t,"laya.d3.core.particleShuriKen.module.shape.SphereShape",e);var n=t.prototype;return n.generatePositionAndDirection=function(e,t,n,i){n?(n.seed=i[16],this.emitFromShell?$._randomPointUnitSphere(e,n):$._randomPointInsideUnitSphere(e,n),i[16]=n.seed):this.emitFromShell?$._randomPointUnitSphere(e):$._randomPointInsideUnitSphere(e),rt.scale(e,this.radius,e),this.randomDirection?n?(n.seed=i[17],$._randomPointUnitSphere(t,n),i[17]=n.seed):$._randomPointUnitSphere(t):e.cloneTo(t)},n.cloneTo=function(t){e.prototype.cloneTo.call(this,t);var n=t;n.radius=this.radius,n.emitFromShell=this.emitFromShell,n.randomDirection=this.randomDirection},t}(K),yt=function(e){function t(e){this._projectionViewWorldMatrix=null,this._id=0,this._componentsMap=null,this._typeComponentsIndices=null,this._components=null,this._url=null,this._enable=!1,this._layerMask=0,this._shaderDefineValue=0,this._shaderValues=null,this._colliders=null,this.transform=null,this.isStatic=!1,t.__super.call(this),this._projectionViewWorldMatrix=new Ke,this._shaderValues=new ht,this._colliders=[],this._componentsMap=[],this._typeComponentsIndices=[],this._components=[],this.name=e?e:"Sprite3D-"+t._nameNumberCounter++,this._enable=!0,this._id=++t._uniqueIDCounter,this._layerMask=-1,this.layer=F.currentCreationLayer,this.transform=new gt(this),this.on("display",this,this._onDisplay),this.on("undisplay",this,this._onUnDisplay)}r(t,"laya.d3.core.Sprite3D",e);var i=t.prototype;return n.imps(i,{"laya.d3.core.render.IUpdate":!0,"laya.resource.ICreateResource":!0,"laya.d3.core.IClone":!0}),i._removeComponent=function(e,t){var n=this._typeComponentsIndices[e],i=n[t],r=this._components[i];if(r instanceof laya.d3.component.physics.Collider){var a=r,s=F.getLayerByMask(this._layerMask)._colliders;s.splice(s.indexOf(a),1),this._colliders.splice(this._colliders.indexOf(a),1)}this._components.splice(i,1),n.splice(t,1),0===n.length&&(this._typeComponentsIndices.splice(e,1),this._componentsMap.splice(e,1));for(var o=0,l=this._componentsMap.length;o<l;o++){n=this._typeComponentsIndices[o];for(var h=n.length-1;h>=0;h--){var u=n[h];if(!(u>i))break;n[h]=--u}}r._destroy(),this.event("componentremoved",r)},i.createConchModel=function(){return null},i._addShaderDefine=function(e){this._shaderDefineValue|=e},i._removeShaderDefine=function(e){this._shaderDefineValue&=~e},i._onDisplay=function(){this.transform.parent=this._parent.transform,this._addSelfRenderObjects()},i._onUnDisplay=function(){this.transform.parent=null,this._clearSelfRenderObjects()},i._clearSelfRenderObjects=function(){},i._addSelfRenderObjects=function(){},i._updateComponents=function(e){for(var t=0,n=this._components.length;t<n;t++){var i=this._components[t];!i.started&&(i._start(e),i.started=!0),i.isActive&&i._update(e)}},i._lateUpdateComponents=function(e){for(var t=0;t<this._components.length;t++){var n=this._components[t];!n.started&&(n._start(e),n.started=!0),n.isActive&&n._lateUpdate(e)}},i._updateChilds=function(e){var t=this._childs.length;if(0!==t)for(var n=0;n<t;++n)this._childs[n]._update(e)},i._updateChildsConch=function(e){var t=this._childs.length;if(0!==t)for(var n=0;n<t;++n)this._childs[n]._update(e)},i._getSortID=function(e,t){return e._getVertexBuffer().vertexDeclaration.id+1e3*t.id},i._prepareShaderValuetoRender=function(e){this._setShaderValueMatrix4x4(0,this.transform.worldMatrix);var t=this.getProjectionViewWorldMatrix(e);this._setShaderValueMatrix4x4(1,t)},i._update=function(e){e.owner=this,this._enable&&(this._updateComponents(e),this._lateUpdateComponents(e)),I.spriteCount++,
this._childs.length&&this._updateChilds(e)},i._updateConch=function(e){e.owner=this,this._enable&&(this._updateComponents(e),this._lateUpdateComponents(e)),I.spriteCount++,this._childs.length&&this._updateChilds(e)},i._setShaderValueMatrix4x4=function(e,t){this._shaderValues.setValue(e,t?t.elements:null)},i._setShaderValueColor=function(e,t){this._shaderValues.setValue(e,t?t.elements:null)},i._setShaderValueBuffer=function(e,t){this._shaderValues.setValue(e,t)},i._setShaderValueInt=function(e,t){this._shaderValues.setValue(e,t)},i._setShaderValueBool=function(e,t){this._shaderValues.setValue(e,t)},i._setShaderValueNumber=function(e,t){this._shaderValues.setValue(e,t)},i._setShaderValueVector2=function(e,t){this._shaderValues.setValue(e,t?t.elements:null)},i.getProjectionViewWorldMatrix=function(e){I.loopCount;return Ke.multiply(e,this.transform.worldMatrix,this._projectionViewWorldMatrix),this._projectionViewWorldMatrix},i.loadHierarchy=function(e){this.addChild(laya.d3.core.Sprite3D.load(e))},i.addChildAt=function(t,n){if(!(t instanceof laya.d3.core.Sprite3D))throw new Error("Sprite3D:Node type must Sprite3D.");return e.prototype.addChildAt.call(this,t,n)},i.addChild=function(t){if(!(t instanceof laya.d3.core.Sprite3D))throw new Error("Sprite3D:Node type must Sprite3D.");return e.prototype.addChild.call(this,t)},i.addComponent=function(e){var t,n=this._componentsMap.indexOf(e);if(n===-1)t=[],this._componentsMap.push(e),this._typeComponentsIndices.push(t);else if(t=this._typeComponentsIndices[n],this._components[t[0]].isSingleton)throw new Error("无法单实例创建"+e+"组件，"+e+"组件已存在！");var i=m.getInstance(e);return t.push(this._components.length),this._components.push(i),i instanceof laya.d3.component.physics.Collider&&(F.getLayerByMask(this._layerMask)._colliders.push(i),this._colliders.push(i)),i._initialize(this),this.event("componentadded",i),i},i.getComponentByType=function(e,t){void 0===t&&(t=0);var n=this._componentsMap.indexOf(e);return n===-1?null:this._components[this._typeComponentsIndices[n][t]]},i.getComponentsByType=function(e,t){var n=this._componentsMap.indexOf(e);n===-1&&(t.length=0);var i=this._typeComponentsIndices[n],r=i.length;t.length=r;for(var a=0;a<r;a++)t[a]=this._components[i[a]]},i.getComponentByIndex=function(e){return this._components[e]},i.removeComponentByType=function(e,t){void 0===t&&(t=0);var n=this._componentsMap.indexOf(e);n!==-1&&this._removeComponent(n,t)},i.removeComponentsByType=function(e){var t=this._componentsMap.indexOf(e);if(t!==-1)for(var n=this._typeComponentsIndices[t],i=0,r=n.length;i<r;n.length<r?r--:i++)this._removeComponent(t,i)},i.removeAllComponent=function(){for(var e=0,t=this._componentsMap.length;e<t;this._componentsMap.length<t?t--:e++)this.removeComponentsByType(this._componentsMap[e])},i.onAsynLoaded=function(e,t,n){if(!this.destroyed){var i=t[0],r=t[1];m.createByJson(i,this,this,g.create(null,dt._parseHierarchyProp,[r],!1),g.create(null,dt._parseHierarchyNode,null,!1)),this.event("hierarchyloaded",[this])}},i.cloneTo=function(e){var t=e;t.name=this.name,t.destroyed=this.destroyed,t.timer=this.timer,t._$P=this._$P,t.enable=this.enable;var n=t.transform.localPosition;this.transform.localPosition.cloneTo(n),t.transform.localPosition=n;var i=t.transform.localRotation;this.transform.localRotation.cloneTo(i),t.transform.localRotation=i;var r=t.transform.localScale;this.transform.localScale.cloneTo(r),t.transform.localScale=r,t.isStatic=this.isStatic;var a=0,s=0;for(a=0,s=this._componentsMap.length;a<s;a++)t.addComponent(this._componentsMap[a]);for(a=0,s=this._childs.length;a<s;a++)t.addChild(this._childs[a].clone())},i.clone=function(){var e=new this.constructor;return this.cloneTo(e),e},i.destroy=function(t){void 0===t&&(t=!0),e.prototype.destroy.call(this,t);var n=0,i=0;for(n=0,i=this._components.length;n<i;n++)this._components[n]._destroy();this._components=null,this._componentsMap=null,this._typeComponentsIndices=null,this.transform=null;var r=F.getLayerByMask(this._layerMask)._colliders;for(n=0,i=this._colliders.length;n<i;n++)r.splice(r.indexOf(this._colliders[n]),1);this._colliders=null,x.clearRes(this.url)},a(0,i,"componentsCount",function(){return this._typeComponentsIndices.length}),a(0,i,"id",function(){return this._id}),a(0,i,"url",function(){return this._url},function(e){this._url=e}),a(0,i,"layer",function(){return F.getLayerByMask(this._layerMask)},function(e){if(!e)throw new Error("Layer value can be null.");var t=0,n=this._colliders.length;if(this._layerMask!==-1){var i=F.getLayerByMask(this._layerMask)._colliders;for(t=0;t<n;t++)i.splice(i.indexOf(this._colliders[t]),1)}var r=e._colliders;for(t=0;t<n;t++)r.push(this._colliders[t]);this._layerMask=e.mask,this.event("layerchanged",e)}),a(0,i,"enable",function(){return this._enable},function(e){this._enable!==e&&(this._enable=e,this.event("enabledchanged",this._enable))}),a(0,i,"active",function(){return F.isActive(this._layerMask)&&this._enable}),a(0,i,"visible",function(){return F.isVisible(this._layerMask)&&this._enable}),a(0,i,"scene",function(){return this.parent?this.parent.scene:null}),t.instantiate=function(e,t,n,i,r){void 0===r&&(r=!0);var a,s=e.clone();if(t||n)i&&i.addChild(s),a=s.transform,t&&(a.position=t),n&&(a.rotation=n);else if(r){if(a=s.transform,i){var o=a.position,l=a.rotation;i.addChild(s),a.position=o,a.rotation=l}}else i&&i.addChild(s);return s},t.load=function(e){return n.loader.create(e,null,null,t,null,1,!1)},t.WORLDMATRIX=0,t.MVPMATRIX=1,t._uniqueIDCounter=0,t._nameNumberCounter=0,t}(T),Dt=function(e){function t(){this._sharderNameID=0,this._shaderDefineValue=0,this._disableShaderDefineValue=0,this._shaderValues=null,this._values=null,this._textureSharderIndices=null,this._shader=null,this._renderQueue=0,this._shaderCompile=null,this._isInstance=!1,this.cull=0,this.blend=0,this.srcBlend=0,this.dstBlend=0,this.srcBlendRGB=0,this.dstBlendRGB=0,this.srcBlendAlpha=0,this.dstBlendAlpha=0,this.blendConstColor=null,this.blendEquation=0,this.blendEquationRGB=0,this.blendEquationAlpha=0,this.depthTest=!1,this.depthFunc=0,this.depthWrite=!1,this._conchMaterial=null,t.__super.call(this),this._loaded=!0,this._isInstance=!1,this._shaderDefineValue=0,this._disableShaderDefineValue=0,this._shaderValues=new ht,this._values=[],this._textureSharderIndices=[],this.cull=2,this.blend=0,this.srcBlend=1,this.dstBlend=0,this.srcBlendRGB=1,this.dstBlendRGB=0,this.srcBlendAlpha=1,this.dstBlendAlpha=0,this.blendConstColor=new at(1,1,1,1),this.blendEquation=0,this.blendEquationRGB=0,this.blendEquationAlpha=0,this.depthTest=!0,this.depthFunc=1,this.depthWrite=!0,D.isConchNode&&(this._conchMaterial=new ConchMaterial)}r(t,"laya.d3.core.material.BaseMaterial",e);var i=t.prototype;return n.imps(i,{"laya.d3.core.IClone":!0}),i._uploadTextures=function(){for(var e=0,t=this._textureSharderIndices.length;e<t;e++){var n=this._textureSharderIndices[e],i=this._values[n];if(i){var r=i.source;r?this._uploadTexture(n,r):this._uploadTexture(n,nn.grayTexture.source)}}},i._getShader=function(e,t,n){var i=(e|t|this._shaderDefineValue|n)&~this._disableShaderDefineValue;return this._shader=this._shaderCompile.withCompile(this._sharderNameID,i,2e-4*this._sharderNameID+i),this._shader},i._uploadTexture=function(e,t){this._shaderValues.data[e]=t},i._addShaderDefine=function(e){this._shaderDefineValue|=e,this._conchMaterial&&this._conchMaterial.addShaderDefine(e)},i._removeShaderDefine=function(e){this._shaderDefineValue&=~e,this._conchMaterial&&this._conchMaterial.removeShaderDefine(e)},i._addDisableShaderDefine=function(e){this._disableShaderDefineValue|=e},i._removeDisableShaderDefine=function(e){this._disableShaderDefineValue&=~e},i._setBuffer=function(e,t){this._shaderValues.setValue(e,t),this._values[e]=t,this._conchMaterial&&this._conchMaterial.setShaderValue(e,t,0)},i._getBuffer=function(e){return this._values[e]},i._setMatrix4x4=function(e,t){this._shaderValues.setValue(e,t?t.elements:null),this._values[e]=t,this._conchMaterial&&this._conchMaterial.setShaderValue(e,t.elements,0)},i._getMatrix4x4=function(e){return this._values[e]},i._setInt=function(e,t){this._shaderValues.setValue(e,t),this._values[e]=t,this._conchMaterial&&this._conchMaterial.setShaderValue(e,t,1)},i._getInt=function(e){return this._values[e]},i._setNumber=function(e,t){this._shaderValues.setValue(e,t),this._values[e]=t,this._conchMaterial&&this._conchMaterial.setShaderValue(e,t,2)},i._getNumber=function(e){return this._values[e]},i._setBool=function(e,t){this._shaderValues.setValue(e,t),this._values[e]=t,this._conchMaterial&&this._conchMaterial.setShaderValue(e,t,1)},i._getBool=function(e){return this._values[e]},i._setVector2=function(e,t){this._shaderValues.setValue(e,t?t.elements:null),this._values[e]=t,this._conchMaterial&&this._conchMaterial.setShaderValue(e,t.elements,0)},i._getVector2=function(e){return this._values[e]},i._setColor=function(e,t){this._shaderValues.setValue(e,t?t.elements:null),this._values[e]=t,this._conchMaterial&&t&&this._conchMaterial.setShaderValue(e,t.elements,0)},i._getColor=function(e){return this._values[e]},i._setTexture=function(e,t){var n=(this._shaderValues,this._values[e]);!n&&t?this._textureSharderIndices.push(e):n&&!t&&this._textureSharderIndices.splice(this._textureSharderIndices.indexOf(e),1),this._values[e]=t,this._conchMaterial&&this._conchMaterial.setTexture(t._conchTexture,this._textureSharderIndices.indexOf(e),e)},i._getTexture=function(e){return this._values[e]},i._upload=function(){this._uploadTextures(),this._shader.uploadMaterialUniforms(this._shaderValues.data)},i._setMaterialShaderParams=function(e){},i._setRenderStateBlendDepth=function(){var e=N.mainContext;switch(P.setDepthTest(e,this.depthTest),P.setDepthMask(e,this.depthWrite),this.blend){case 0:P.setBlend(e,!1);break;case 1:P.setBlend(e,!0),P.setBlendFunc(e,this.srcBlend,this.dstBlend);break;case 2:P.setBlend(e,!0)}},i._setRenderStateFrontFace=function(e,t){var n=N.mainContext,i=0;switch(this.cull){case 0:P.setCullFace(n,!1);break;case 1:P.setCullFace(n,!0),i=e?t._isFrontFaceInvert?2305:2304:t._isFrontFaceInvert?2304:2305,P.setFrontFace(n,i);break;case 2:P.setCullFace(n,!0),i=e?t._isFrontFaceInvert?2304:2305:t._isFrontFaceInvert?2305:2304,P.setFrontFace(n,i)}},i.setShaderName=function(e){this._sharderNameID=kt.nameKey.getID(e),this._shaderCompile=lt._preCompileShader[2e-4*this._sharderNameID],this._conchMaterial&&this._conchMaterial.setShader(this._shaderCompile._conchShader)},i.onAsynLoaded=function(e,t,n){var i=t[0],r=t[1];switch(i.version){case"LAYAMATERIAL:01":var a=i.props,s=0,o=0;for(var l in a)switch(l){case"colors":var h=a[l];for(s=0,o=h.length;s<o;s++){var u=h[s],c=u.value;switch(c.length){case 2:this[u.name]=new it(c[0],c[1]);break;case 3:this[u.name]=new rt(c[0],c[1],c[2]);break;case 4:this[u.name]=new at(c[0],c[1],c[2],c[3]);break;default:throw new Error("BaseMaterial:unkonwn color length.")}}break;case"textures":var _=a[l];for(s=0,o=_.length;s<o;s++){var d=_[s],m=d.path;m&&(this[d.name]=x.getRes(r[m]))}break;default:this[l]=a[l]}break;default:throw new Error("BaseMaterial:unkonwn version.")}this.event("loaded",this)},i.cloneTo=function(e){var t=e;t.name=this.name,t.cull=this.cull,t.blend=this.blend,t.srcBlend=this.srcBlend,t.dstBlend=this.dstBlend,t.srcBlendRGB=this.srcBlendRGB,t.dstBlendRGB=this.dstBlendRGB,t.srcBlendAlpha=this.srcBlendAlpha,t.dstBlendAlpha=this.dstBlendAlpha,this.blendConstColor.cloneTo(t.blendConstColor),t.blendEquation=this.blendEquation,t.blendEquationRGB=this.blendEquationRGB,t.blendEquationAlpha=this.blendEquationAlpha,t.depthTest=this.depthTest,t.depthFunc=this.depthFunc,t.depthWrite=this.depthWrite,t._loaded=this._loaded,t._renderQueue=this._renderQueue,t._shader=this._shader,t._sharderNameID=this._sharderNameID,t._disableShaderDefineValue=this._disableShaderDefineValue,t._shaderDefineValue=this._shaderDefineValue;var n=0,i=0,r=t._shaderValues;t._shaderValues.data.length=this._shaderValues.data.length;var a=this._values.length,s=t._values;for(s.length=a,n=0,i=a;n<i;n++){var o=this._values[n];if(o)if("number"==typeof o)s[n]=o,r.data[n]=o;else if("number"==typeof o&&Math.floor(o)==o)s[n]=o,r.data[n]=o;else if("boolean"==typeof o)s[n]=o,r.data[n]=o;else if(o instanceof laya.d3.math.Vector2){var l=s[n]||(s[n]=new it);o.cloneTo(l),r.data[n]=l.elements}else if(o instanceof laya.d3.math.Vector3){var h=s[n]||(s[n]=new rt);o.cloneTo(h),r.data[n]=h.elements}else if(o instanceof laya.d3.math.Vector4){var u=s[n]||(s[n]=new at);o.cloneTo(u),r.data[n]=u.elements}else if(o instanceof laya.d3.math.Matrix4x4){var c=s[n]||(s[n]=new Ke);o.cloneTo(c),r.data[n]=c.elements}else o instanceof laya.d3.resource.BaseTexture&&(s[n]=o)}t._textureSharderIndices=this._textureSharderIndices.slice()},i.clone=function(){var e=new this.constructor;return this.cloneTo(e),e},i.dispose=function(){this.resourceManager.removeResource(this),e.prototype.dispose.call(this)},a(0,i,"renderQueue",function(){return this._renderQueue}),t.CULL_NONE=0,t.CULL_FRONT=1,t.CULL_BACK=2,t.BLEND_DISABLE=0,t.BLEND_ENABLE_ALL=1,t.BLEND_ENABLE_SEPERATE=2,t.BLENDPARAM_ZERO=0,t.BLENDPARAM_ONE=1,t.BLENDPARAM_SRC_COLOR=768,t.BLENDPARAM_ONE_MINUS_SRC_COLOR=769,t.BLENDPARAM_DST_COLOR=774,t.BLENDPARAM_ONE_MINUS_DST_COLOR=775,t.BLENDPARAM_SRC_ALPHA=770,t.BLENDPARAM_ONE_MINUS_SRC_ALPHA=771,t.BLENDPARAM_DST_ALPHA=772,t.BLENDPARAM_ONE_MINUS_DST_ALPHA=773,t.BLENDPARAM_CONSTANT_COLOR=32769,t.BLENDPARAM_ONE_MINUS_CONSTANT_COLOR=32770,t.BLENDPARAM_CONSTANT_ALPHA=32771,t.BLENDPARAM_ONE_MINUS_CONSTANT_ALPHA=32772,t.BLENDPARAM_SRC_ALPHA_SATURATE=776,t.BLENDEQUATION_ADD=0,t.BLENDEQUATION_SUBTRACT=1,t.BLENDEQUATION_REVERSE_SUBTRACT=2,t.DEPTHFUNC_NEVER=0,t.DEPTHFUNC_LESS=1,t.DEPTHFUNC_EQUAL=2,t.DEPTHFUNC_LEQUAL=3,t.DEPTHFUNC_GREATER=4,t.DEPTHFUNC_NOTEQUAL=5,t.DEPTHFUNC_GEQUAL=6,t.DEPTHFUNC_ALWAYS=7,t}(C),Rt=function(e){function t(){this._width=0,this._height=0,this._size=null,this._repeat=!1,this._mipmap=!1,this._minFifter=0,this._magFifter=0,this._source=null,t.__super.call(this),this._conchTexture,D.isConchNode&&(this._conchTexture=new ConchTexture),this._repeat=!0,this.mipmap=!0,this.minFifter=-1,this.magFifter=-1}r(t,"laya.d3.resource.BaseTexture",e);var n=t.prototype;return n.dispose=function(){this.resourceManager.removeResource(this),e.prototype.dispose.call(this)},a(0,n,"width",function(){return this._width}),a(0,n,"repeat",function(){return this._repeat}),a(0,n,"height",function(){return this._height}),a(0,n,"magFifter",function(){return this._magFifter},function(e){this._magFifter=e,e!=this._magFifter&&this._conchTexture&&this._conchTexture.setMaxFifter(e)}),a(0,n,"size",function(){return this._size}),a(0,n,"mipmap",function(){return this._mipmap},function(e){this._mipmap=e,this._mipmap!=e&&this._conchTexture&&this._conchTexture.setMipMap(e)}),a(0,n,"minFifter",function(){return this._minFifter},function(e){this._minFifter=e,this._minFifter!=e&&this._conchTexture&&this._conchTexture.setMinFifter(e)}),a(0,n,"source",function(){return this.activeResource(),this._source}),t}(C),Ct=function(e){function t(){this._subMeshCount=0,this._boundingBox=null,this._boundingSphere=null,this._boundingBoxCorners=null,t.__super.call(this),this._loaded=!1,this._boundingBoxCorners=s(8,null)}r(t,"laya.d3.resource.models.BaseMesh",e);var n=t.prototype;return n._generateBoundingObject=function(){var e=this.positions;this._boundingSphere=new Xe(new rt,0),Xe.createfromPoints(e,this._boundingSphere),this._boundingBox=new Ye(new rt,new rt),Ye.createfromPoints(e,this._boundingBox),this._boundingBox.getCorners(this._boundingBoxCorners)},n.getRenderElementsCount=function(){throw new Error("未Override,请重载该属性！")},n.getRenderElement=function(e){throw new Error("未Override,请重载该属性！")},a(0,n,"positions",function(){throw new Error("未Override,请重载该属性！")}),a(0,n,"subMeshCount",function(){return this._subMeshCount}),a(0,n,"boundingBox",function(){return this._boundingBox}),a(0,n,"boundingBoxCorners",function(){return this._boundingBoxCorners}),a(0,n,"boundingSphere",function(){return this._boundingSphere}),t}(C),Vt=function(e){function t(){this.__ownerCamera=null,this._alphaBlending=1,this._colorIntensity=1,this._vertexBuffer=null,this._indexBuffer=null,this._sharderNameID=0,this._shader=null,this._shaderValue=null,this._shaderCompile=null,this._environmentDiffuse=null,this._environmentSpecular=null,this._conchSky=null,t.__super.call(this),this._shaderValue=new ht,D.isConchNode&&(this._conchSky=new ConchSkyMesh)}r(t,"laya.d3.resource.models.Sky",e);var n=t.prototype;return n._setEnvironmentDiffuse=function(){this._environmentDiffuse.loaded?this.__ownerCamera._shaderValues.setValue(7,this._environmentDiffuse.source):this._environmentDiffuse.on("loaded",this,this._environmentDiffuseLoaded)},n._setEnvironmentSpecular=function(){if(this._environmentSpecular.loaded){var e=this._environmentSpecular.simLodInfo;e&&e instanceof Float32Array&&this.__ownerCamera._shaderValues.setValue(9,e),this.__ownerCamera._shaderValues.setValue(8,this._environmentSpecular.source)}else this._environmentSpecular.on("loaded",this,this._environmentSpecularLoaded)},n._environmentDiffuseLoaded=function(){this.__ownerCamera._shaderValues.setValue(7,this._environmentDiffuse.source)},n._environmentSpecularLoaded=function(){var e=this._environmentSpecular.simLodInfo;e&&e instanceof Float32Array&&this.__ownerCamera._shaderValues.setValue(9,e),this.__ownerCamera._shaderValues.setValue(8,this._environmentSpecular.source)},n._render=function(e){},a(0,n,"_ownerCamera",null,function(e){this.__ownerCamera=e,this._environmentDiffuse&&this._setEnvironmentDiffuse(),this._environmentSpecular&&this._setEnvironmentSpecular()}),a(0,n,"alphaBlending",function(){return this._alphaBlending},function(e){this._alphaBlending=e,this._alphaBlending<0&&(this._alphaBlending=0),this._alphaBlending>1&&(this._alphaBlending=1),this._conchSky&&this._conchSky.setShaderValue(2,this._alphaBlending,2)}),a(0,n,"colorIntensity",function(){return this._colorIntensity},function(e){this._colorIntensity=e,this._colorIntensity<0&&(this._colorIntensity=0),this._conchSky&&this._conchSky.setShaderValue(1,this._colorIntensity,2)}),a(0,n,"environmentDiffuse",function(){return this._environmentDiffuse},function(e){e.minFifter=9728,this._environmentDiffuse=e,this.__ownerCamera&&this._setEnvironmentDiffuse()}),a(0,n,"environmentSpecular",function(){return this._environmentSpecular},function(e){this._environmentSpecular=e,this.__ownerCamera&&this._setEnvironmentSpecular()}),t.MVPMATRIX=0,t.INTENSITY=1,t.ALPHABLENDING=2,t.DIFFUSETEXTURE=3,t}(C),At=function(e){function t(){this._player=null,this._templet=null,t.__super.call(this),this._player=new o}r(t,"laya.d3.component.animation.KeyframeAnimations",e);var i=t.prototype;return i._updateAnimtionPlayer=function(){this._player.update(n.timer.delta)},i._addUpdatePlayerToTimer=function(){n.timer.frameLoop(1,this,this._updateAnimtionPlayer)},i._removeUpdatePlayerToTimer=function(){n.timer.clear(this,this._updateAnimtionPlayer)},i._onOwnerEnableChanged=function(e){this._owner.displayedInStage&&(e?this._addUpdatePlayerToTimer():this._removeUpdatePlayerToTimer())},i._onDisplayInStage=function(){this._owner.enable&&this._addUpdatePlayerToTimer()},i._onUnDisplayInStage=function(){this._owner.enable&&this._removeUpdatePlayerToTimer()},i._load=function(e){this._owner.displayedInStage&&this._owner.enable&&this._addUpdatePlayerToTimer(),this._owner.on("enabledchanged",this,this._onOwnerEnableChanged),this._owner.on("display",this,this._onDisplayInStage),this._owner.on("undisplay",this,this._onUnDisplayInStage)},i._unload=function(t){e.prototype._unload.call(this,t),this._owner.displayedInStage&&this._owner.enable&&this._removeUpdatePlayerToTimer(),this._owner.off("enabledchanged",this,this._onOwnerEnableChanged),this._owner.off("display",this,this._onDisplayInStage),this._owner.off("undisplay",this,this._onUnDisplayInStage),this._player._destroy(),this._player=null,this._templet=null},a(0,i,"url",null,function(e){console.log("Warning: discard property,please use templet property instead.");var t=n.loader.create(e,null,null,l);this._templet!==t&&(0!==this._player.state&&this._player.stop(!0),this._templet=t,this._player.templet=t,this.event("animationchanged",this))}),a(0,i,"player",function(){return this._player}),a(0,i,"templet",function(){return this._templet},function(e){this._templet!==e&&(0!==this._player.state&&this._player.stop(!0),this._templet=e,this._player.templet=e,this.event("animationchanged",this))}),a(0,i,"currentFrameIndex",function(){return this._player.currentKeyframeIndex}),a(0,i,"currentAnimationClipIndex",function(){return this._player.currentAnimationClipIndex}),a(0,i,"nodeCount",function(){return this._templet.getNodeCount(this._player.currentAnimationClipIndex)}),t}(ft),It=(function(e){function t(){this._attachSkeleton=null,this._extenData=null,this.attachBones=null,this.matrixs=null,t.__super.call(this),this.attachBones=[],this.matrixs=[]}r(t,"laya.d3.component.AttachPoint",e);var n=t.prototype;n._load=function(t){e.prototype._load.call(this,t),this._attachSkeleton=t.getComponentByType(Kt)},n._update=function(e){if(this._attachSkeleton&&!this._attachSkeleton.destroyed&&2===this._attachSkeleton.player.state&&this._attachSkeleton.curBonesDatas){var t=this._attachSkeleton.player,n=this._attachSkeleton.templet;this.matrixs.length=this.attachBones.length;for(var i=this._attachSkeleton.curBonesDatas,r=this.owner.transform.worldMatrix,a=0,s=this.attachBones.length;a<s;a++){var o=16*n.getNodeIndexWithName(t.currentAnimationClipIndex,this.attachBones[a]),l=this.matrixs[a];l||(l=this.matrixs[a]=new Ke);for(var h=l.elements,u=0;u<16;u++)h[u]=i[o+u];Ke.multiply(r,l,l)}this.event("complete")}},t}(ft),function(e){function t(){this._needUpdate=!1,t.__super.call(this)}r(t,"laya.d3.component.physics.Collider",e);var n=t.prototype;return n.raycast=function(e,t,n){throw void 0===n&&(n=Number.MAX_VALUE),new Error("Must override it.")},a(0,n,"isSingleton",function(){return t._isSingleton}),t._isSingleton=!1,t}(ft)),bt=(function(e){function t(){t.__super.call(this)}r(t,"laya.d3.component.Script",e),a(0,t.prototype,"isSingleton",function(){return t._isSingleton}),t._isSingleton=!1,t}(ft),function(e){function t(e){t.__super.call(this,e)}r(t,"laya.d3.core.GlitterRender",e);var n=t.prototype;return n._calculateBoundingBox=function(){var e=this._boundingBox.min.elements;e[0]=-Number.MAX_VALUE,e[1]=-Number.MAX_VALUE,e[2]=-Number.MAX_VALUE;var t=this._boundingBox.min.elements;t[0]=Number.MAX_VALUE,t[1]=Number.MAX_VALUE,t[2]=Number.MAX_VALUE},n._calculateBoundingSphere=function(){var e=this._boundingSphere.center.elements;e[0]=0,e[1]=0,e[2]=0,this._boundingSphere.radius=Number.MAX_VALUE},t}(vt)),wt=function(e){function t(e){this._owner=null,this._sharedMesh=null,t.__super.call(this),this._owner=e}r(t,"laya.d3.core.MeshFilter",e);var n=t.prototype;return n._sharedMeshLoaded=function(){this.event("loaded")},n._destroy=function(){e.prototype._destroy.call(this),this._owner=null,this._sharedMesh=null},a(0,n,"sharedMesh",function(){return this._sharedMesh},function(e){var t=this._sharedMesh;this._sharedMesh=e,this.event("meshchanged",[this,t,e]),e.loaded||this._sharedMesh.once("loaded",this,this._sharedMeshLoaded)}),a(0,n,"_isAsyncLoaded",function(){return this._sharedMesh.loaded}),a(0,n,"_originalBoundingSphere",function(){return this._sharedMesh.boundingSphere}),a(0,n,"_originalBoundingBox",function(){return this._sharedMesh.boundingBox}),t}(pt),Ot=function(e){function t(e){this._meshSprite3DOwner=null,this._lightmapScaleOffset=null,this.castShadow=!1,this.receiveShadow=!1,this.lightmapIndex=0,t.__super.call(this,e),this._meshSprite3DOwner=e,this.lightmapIndex=-1,this.castShadow=!0,this.receiveShadow=!0,this._meshSprite3DOwner.meshFilter.on("meshchanged",this,this._onMeshChanged)}r(t,"laya.d3.core.MeshRender",e);var n=t.prototype;return n._onMeshChanged=function(e,t,n){n.loaded?this._boundingSphereNeedChange=this._boundingBoxNeedChange=this._boundingBoxCenterNeedChange=this._octreeNodeNeedChange=!0:n.once("loaded",this,this._onMeshLoaed)},n._onMeshLoaed=function(e,t){this._boundingSphereNeedChange=this._boundingBoxNeedChange=this._boundingBoxCenterNeedChange=this._octreeNodeNeedChange=!0},n._calculateBoundingSphere=function(){var e=this._meshSprite3DOwner.meshFilter.sharedMesh;if(null==e||null==e.boundingSphere)this._boundingSphere.toDefault();else{var t=e.boundingSphere,n=NaN,i=this._meshSprite3DOwner.transform,r=i.scale;n=r.x>=r.y&&r.x>=r.z?r.x:r.y>=r.z?r.y:r.z,rt.transformCoordinate(t.center,i.worldMatrix,this._boundingSphere.center),this._boundingSphere.radius=t.radius*n}},n._calculateBoundingBox=function(){var e=this._meshSprite3DOwner.meshFilter.sharedMesh;if(null==e||null==e.boundingBox)this._boundingBox.toDefault();else{for(var n=this._meshSprite3DOwner.transform.worldMatrix,i=e.boundingBoxCorners,r=0;r<8;r++)rt.transformCoordinate(i[r],n,t._tempBoudingBoxCorners[r]);Ye.createfromPoints(t._tempBoudingBoxCorners,this._boundingBox)}},n._destroy=function(){e.prototype._destroy.call(this),this._lightmapScaleOffset=null,this._meshSprite3DOwner=null},a(0,n,"lightmapScaleOffset",function(){return this._lightmapScaleOffset},function(e){this._lightmapScaleOffset=e,this._owner._setShaderValueColor(2,e),this._owner._addShaderDefine(Xt.SHADERDEFINE_SCALEOFFSETLIGHTINGMAPUV)}),i(t,["_tempBoudingBoxCorners",function(){return this._tempBoudingBoxCorners=[new rt,new rt,new rt,new rt,new rt,new rt,new rt,new rt]}]),t}(vt),Nt=function(e){function t(e){t.__super.call(this,e)}r(t,"laya.d3.core.ParticleRender",e);var n=t.prototype;return n._calculateBoundingBox=function(){var e=this._boundingBox.min.elements;e[0]=-Number.MAX_VALUE,e[1]=-Number.MAX_VALUE,e[2]=-Number.MAX_VALUE;var t=this._boundingBox.min.elements;t[0]=Number.MAX_VALUE,t[1]=Number.MAX_VALUE,t[2]=Number.MAX_VALUE},n._calculateBoundingSphere=function(){var e=this._boundingSphere.center.elements;e[0]=0,e[1]=0,e[2]=0,this._boundingSphere.radius=Number.MAX_VALUE},t}(vt),Pt=function(e){function t(e){this._owner=null,this._vertices=null,this._floatCountPerVertex=0,this._firstActiveElement=0,this._firstNewElement=0,this._firstFreeElement=0,this._firstRetiredElement=0,this._drawCounter=0,this._currentTime=NaN,this._vertexBuffer=null,this._indexBuffer=null,this._bufferMaxParticles=0,this._emission=null,this._shape=null,this._isPlaying=!1,this._isPaused=!1,this._playStartDelay=NaN,this._frameTime=NaN,this._emissionTime=NaN,this._playbackTime=NaN,this._burstsIndex=0,this._velocityOverLifetime=null,this._colorOverLifetime=null,this._sizeOverLifetime=null,this._rotationOverLifetime=null,this._textureSheetAnimation=null,this._startUpdateLoopCount=0,this._rand=null,this._randomSeeds=null,this.duration=NaN,this.looping=!1,this.prewarm=!1,this.startDelayType=0,this.startDelay=NaN,this.startDelayMin=NaN,this.startDelayMax=NaN,this.startLifetimeType=0,this.startLifetimeConstant=NaN,this.startLifeTimeGradient=null,this.startLifetimeConstantMin=NaN,this.startLifetimeConstantMax=NaN,this.startLifeTimeGradientMin=null,this.startLifeTimeGradientMax=null,this.startSpeedType=0,this.startSpeedConstant=NaN,this.startSpeedConstantMin=NaN,this.startSpeedConstantMax=NaN,this.threeDStartSize=!1,this.startSizeType=0,this.startSizeConstant=NaN,this.startSizeConstantSeparate=null,this.startSizeConstantMin=NaN,this.startSizeConstantMax=NaN,this.startSizeConstantMinSeparate=null,this.startSizeConstantMaxSeparate=null,this.threeDStartRotation=!1,this.startRotationType=0,this.startRotationConstant=NaN,this.startRotationConstantSeparate=null,this.startRotationConstantMin=NaN,this.startRotationConstantMax=NaN,this.startRotationConstantMinSeparate=null,this.startRotationConstantMaxSeparate=null,this.randomizeRotationDirection=NaN,this.startColorType=0,this.startColorConstant=null,this.startColorConstantMin=null,this.startColorConstantMax=null,this.gravity=null,this.gravityModifier=NaN,this.simulationSpace=0,this.scaleMode=0,this.playOnAwake=!1,this.randomSeed=null,this.autoRandomSeed=!1,this.isPerformanceMode=!1,t.__super.call(this),this._boundingSphere=new Xe(new rt,0),this._boundingBox=new Ye(new rt,new rt),this._uvLength=new it,this._owner=e,this._currentTime=0,this._floatCountPerVertex=40,this._isPlaying=!1,this._isPaused=!1,this._burstsIndex=0,this._frameTime=0,this._emissionTime=0,this._playbackTime=0,this._bufferMaxParticles=1e3,this.duration=5,this.looping=!0,this.prewarm=!1,this.startDelayType=0,this.startDelay=0,this.startDelayMin=0,this.startDelayMax=0,this.startLifetimeType=0,this.startLifetimeConstant=5,this.startLifeTimeGradient=new X,this.startLifetimeConstantMin=0,this.startLifetimeConstantMax=5,this.startLifeTimeGradientMin=new X,this.startLifeTimeGradientMax=new X,this.startSpeedType=0,this.startSpeedConstant=5,this.startSpeedConstantMin=0,this.startSpeedConstantMax=5,this.threeDStartSize=!1,this.startSizeType=0,this.startSizeConstant=1,this.startSizeConstantSeparate=new rt(1,1,1),this.startSizeConstantMin=0,this.startSizeConstantMax=1,this.startSizeConstantMinSeparate=new rt(0,0,0),this.startSizeConstantMaxSeparate=new rt(1,1,1),this.threeDStartRotation=!1,this.startRotationType=0,this.startRotationConstant=0,this.startRotationConstantSeparate=new rt(0,0,0),this.startRotationConstantMin=0,this.startRotationConstantMax=0,this.startRotationConstantMinSeparate=new rt(0,0,0),this.startRotationConstantMaxSeparate=new rt(0,0,0),this.randomizeRotationDirection=0,this.startColorType=0,this.startColorConstant=new at(1,1,1,1),this.startColorConstantMin=new at(1,1,1,1),this.startColorConstantMax=new at(1,1,1,1),this.gravity=new rt(0,-9.81,0),this.gravityModifier=0,this.simulationSpace=1,this.scaleMode=0,this.playOnAwake=!0,this._rand=new tt(0),this.autoRandomSeed=!0,this.randomSeed=new Uint32Array(1),this._randomSeeds=new Uint32Array(t._RANDOMOFFSET.length),this.isPerformanceMode=!0,this._owner.on("enabledchanged",this,this._onOwnerEnableChanged),this._owner.on("display",this,this._onDisplayInStage),this._owner.on("undisplay",this,this._onUnDisplayInStage)}r(t,"laya.d3.core.particleShuriKen.ShurikenParticleSystem",e);var s=t.prototype;return n.imps(s,{"laya.d3.core.render.IRenderable":!0,"laya.d3.core.IClone":!0}),s._getVertexBuffer=function(e){return void 0===e&&(e=0),0===e?this._vertexBuffer:null},s._getIndexBuffer=function(){return this._indexBuffer},s._updateEmission=function(){if(n.stage.isVisibility){var e=0;this._startUpdateLoopCount!==I.loopCount&&(e=n.timer.delta/1e3,this._currentTime+=e),this._retireActiveParticles(),this._freeRetiredParticles(),this._emission.enbale&&this._advanceTime(e),this._firstActiveElement===this._firstFreeElement&&(this._currentTime=0),this._firstRetiredElement===this._firstActiveElement&&(this._drawCounter=0)}},s._addUpdateEmissionToTimer=function(){n.timer.frameLoop(1,this,this._updateEmission)},s._removeUpdateEmissionToTimer=function(){n.timer.clear(this,this._updateEmission)},s._onOwnerEnableChanged=function(e){this._owner.displayedInStage&&(e?this._addUpdateEmissionToTimer():this._removeUpdateEmissionToTimer())},s._onDisplayInStage=function(){this._owner.enable&&this._addUpdateEmissionToTimer()},s._onUnDisplayInStage=function(){this._owner.enable&&this._removeUpdateEmissionToTimer()},s._retireActiveParticles=function(){for(;this._firstActiveElement!=this._firstNewElement;){var e=this._firstActiveElement*this._floatCountPerVertex*4,t=e+11;if(this._currentTime-this._vertices[t]+1e-4<this._vertices[e+7])break;this._vertices[t]=this._drawCounter,this._firstActiveElement++,this._firstActiveElement>=this._bufferMaxParticles&&(this._firstActiveElement=0)}},s._freeRetiredParticles=function(){for(;this._firstRetiredElement!=this._firstActiveElement;){var e=this._drawCounter-this._vertices[this._firstRetiredElement*this._floatCountPerVertex*4+11];if(this.isPerformanceMode&&e<3)break;this._firstRetiredElement++,this._firstRetiredElement>=this._bufferMaxParticles&&(this._firstRetiredElement=0)}},s._setPartVertexDatas=function(){for(var e=0;e<this._bufferMaxParticles;e++){
var t=e*this._floatCountPerVertex*4;this._vertices[t+0*this._floatCountPerVertex+0]=-.5,this._vertices[t+0*this._floatCountPerVertex+1]=-.5,this._vertices[t+1*this._floatCountPerVertex+0]=.5,this._vertices[t+1*this._floatCountPerVertex+1]=-.5,this._vertices[t+2*this._floatCountPerVertex+0]=.5,this._vertices[t+2*this._floatCountPerVertex+1]=.5,this._vertices[t+3*this._floatCountPerVertex+0]=-.5,this._vertices[t+3*this._floatCountPerVertex+1]=.5}},s._initPartVertexDatas=function(){this._vertexBuffer=Zt.create(Ee.vertexDeclaration,4*this._bufferMaxParticles,35048),this._vertices=new Float32Array(this._bufferMaxParticles*this._floatCountPerVertex*4),this._setPartVertexDatas()},s._initIndexDatas=function(){this._indexBuffer=qt.create("ushort",6*this._bufferMaxParticles,35044);for(var e=new Uint16Array(6*this._bufferMaxParticles),t=0;t<this._bufferMaxParticles;t++){var n=6*t,i=4*t;e[n+0]=i+0,e[n+1]=i+2,e[n+2]=i+1,e[n+3]=i+0,e[n+4]=i+3,e[n+5]=i+2}this._indexBuffer.setData(e)},s._burst=function(e,t){for(var n=0,i=this._emission._bursts,r=i.length;this._burstsIndex<r;this._burstsIndex++){var a=i[this._burstsIndex],s=a.time;if(!(s>=e&&s<=t))break;var o=0;this.autoRandomSeed?o=M.lerp(a.minCount,a.maxCount,Math.random()):(this._rand.seed=this._randomSeeds[0],o=M.lerp(a.minCount,a.maxCount,this._rand.getFloat()),this._randomSeeds[0]=this._rand.seed),n+=o}return n},s._advanceTime=function(e){if(this._isPlaying&&!this._isPaused&&(this._playbackTime+=e,!(this._playbackTime<this._playStartDelay))){var t=0,n=this._emissionTime;this._emissionTime+=e;var i=0;if(this._emissionTime>this.duration){if(i+=this._burst(n,this.duration),!this.looping){for(this._isPlaying=!1,i=Math.min(this.maxParticles-this.aliveParticleCount,i),t=0;t<i;t++)this.emit();return void this.event("stopped")}this._emissionTime-=this.duration,this.event("complete"),this._burstsIndex=0,i+=this._burst(0,this._emissionTime)}else i+=this._burst(n,this._emissionTime);for(i=Math.min(this.maxParticles-this.aliveParticleCount,i),t=0;t<i;t++)this.emit();this._frameTime+=e;var r=this.emission._minEmissionTime;if(!(this._frameTime<r))for(;this._frameTime>r&&this.emit();)this._frameTime-=r}},s._destroy=function(){e.prototype._destroy.call(this),this._owner.displayedInStage&&this._owner.enable&&this._removeUpdateEmissionToTimer(),this._vertexBuffer.dispose(),this._indexBuffer.dispose(),this._emission._destroy(),this._owner=null,this._vertices=null,this._vertexBuffer=null,this._indexBuffer=null,this._emission=null,this._shape=null,this.startLifeTimeGradient=null,this.startLifeTimeGradientMin=null,this.startLifeTimeGradientMax=null,this.startSizeConstantSeparate=null,this.startSizeConstantMinSeparate=null,this.startSizeConstantMaxSeparate=null,this.startRotationConstantSeparate=null,this.startRotationConstantMinSeparate=null,this.startRotationConstantMaxSeparate=null,this.startColorConstant=null,this.startColorConstantMin=null,this.startColorConstantMax=null,this.gravity=null,this._velocityOverLifetime=null,this._colorOverLifetime=null,this._sizeOverLifetime=null,this._rotationOverLifetime=null,this._textureSheetAnimation=null},s.emit=function(){var e=t._tempPosition,n=t._tempDirection;if(this._shape.enable)this.autoRandomSeed?this._shape.generatePositionAndDirection(e,n):this._shape.generatePositionAndDirection(e,n,this._rand,this._randomSeeds);else{var i=e.elements,r=n.elements;i[0]=i[1]=i[2]=0,r[0]=r[1]=0,r[2]=1}return this.addParticle(e,n)},s.addParticle=function(e,t){rt.normalize(t,t);var n=e.elements,i=t.elements,r=this._firstFreeElement+1;if(r>=this._bufferMaxParticles&&(r=0),r===this._firstRetiredElement)return!1;var a=ie.create(this,this._owner.particleRender,n,i,this._currentTime,this._owner.transform),s=this._firstFreeElement*this._floatCountPerVertex*4,o=a.startUVInfo[0],l=a.startUVInfo[1],h=a.startUVInfo[2],u=a.startUVInfo[3];this._vertices[s+2]=h,this._vertices[s+3]=u+l,this._vertices[s+this._floatCountPerVertex+2]=h+o,this._vertices[s+this._floatCountPerVertex+3]=u+l,this._vertices[s+2*this._floatCountPerVertex+2]=h+o,this._vertices[s+2*this._floatCountPerVertex+3]=u,this._vertices[s+3*this._floatCountPerVertex+2]=h,this._vertices[s+3*this._floatCountPerVertex+3]=u;var c=NaN,_=NaN,d=NaN,m=NaN,f=NaN,p=NaN,v=NaN,g=this._velocityOverLifetime&&this._velocityOverLifetime.enbale;if(g){var x=this._velocityOverLifetime.velocity.type;2===x||3===x?this.autoRandomSeed?(c=Math.random(),_=Math.random(),d=Math.random()):(this._rand.seed=this._randomSeeds[9],c=this._rand.getFloat(),_=this._rand.getFloat(),d=this._rand.getFloat(),this._randomSeeds[9]=this._rand.seed):g=!1}else g=!1;var E=this._colorOverLifetime&&this._colorOverLifetime.enbale;if(E){3===this._colorOverLifetime.color.type?this.autoRandomSeed?m=Math.random():(this._rand.seed=this._randomSeeds[10],m=this._rand.getFloat(),this._randomSeeds[10]=this._rand.seed):E=!1}else E=!1;var M=this._sizeOverLifetime&&this._sizeOverLifetime.enbale;if(M){3===this._sizeOverLifetime.size.type?this.autoRandomSeed?f=Math.random():(this._rand.seed=this._randomSeeds[11],f=this._rand.getFloat(),this._randomSeeds[11]=this._rand.seed):M=!1}else M=!1;var T=this._rotationOverLifetime&&this._rotationOverLifetime.enbale;if(T){var S=this._rotationOverLifetime.angularVelocity.type;2===S||3===S?this.autoRandomSeed?p=Math.random():(this._rand.seed=this._randomSeeds[12],p=this._rand.getFloat(),this._randomSeeds[12]=this._rand.seed):T=!1}else T=!1;var y=this._textureSheetAnimation&&this._textureSheetAnimation.enbale;if(y){3===this._textureSheetAnimation.frame.type?this.autoRandomSeed?v=Math.random():(this._rand.seed=this._randomSeeds[15],v=this._rand.getFloat(),this._randomSeeds[15]=this._rand.seed):y=!1}else y=!1;for(var D=0;D<4;D++){var R=s+D*this._floatCountPerVertex,C=0,V=0;for(C=0,V=4;C<3;C++)this._vertices[R+V+C]=a.position[C];for(this._vertices[R+7]=a.startLifeTime,C=0,V=8;C<3;C++)this._vertices[R+V+C]=a.direction[C];for(this._vertices[R+11]=a.time,C=0,V=12;C<4;C++)this._vertices[R+V+C]=a.startColor[C];for(C=0,V=16;C<3;C++)this._vertices[R+V+C]=a.startSize[C];for(C=0,V=19;C<3;C++)this._vertices[R+V+C]=a.startRotation0[C];for(C=0,V=22;C<3;C++)this._vertices[R+V+C]=a.startRotation1[C];for(C=0,V=25;C<3;C++)this._vertices[R+V+C]=a.startRotation2[C];for(this._vertices[R+28]=a.startSpeed,E&&(this._vertices[R+30]=m),M&&(this._vertices[R+31]=f),T&&(this._vertices[R+32]=p),y&&(this._vertices[R+33]=v),g&&(this._vertices[R+34]=c,this._vertices[R+35]=_,this._vertices[R+36]=d),C=0,V=37;C<3;C++)this._vertices[R+V+C]=a.simulationWorldPostion[C]}return this._firstFreeElement=r,!0},s.addNewParticlesToVertexBuffer=function(){var e=0;this._firstNewElement<this._firstFreeElement?(e=4*this._firstNewElement*this._floatCountPerVertex,this._vertexBuffer.setData(this._vertices,e,e,4*(this._firstFreeElement-this._firstNewElement)*this._floatCountPerVertex)):(e=4*this._firstNewElement*this._floatCountPerVertex,this._vertexBuffer.setData(this._vertices,e,e,4*(this._bufferMaxParticles-this._firstNewElement)*this._floatCountPerVertex),this._firstFreeElement>0&&this._vertexBuffer.setData(this._vertices,0,0,4*this._firstFreeElement*this._floatCountPerVertex)),this._firstNewElement=this._firstFreeElement},s._beforeRender=function(e){return this._firstNewElement!=this._firstFreeElement&&this.addNewParticlesToVertexBuffer(),this._drawCounter++,this._firstActiveElement!=this._firstFreeElement&&(this._vertexBuffer._bind(),this._indexBuffer._bind(),!0)},s._render=function(e){var t=0,n=N.mainContext;this._firstActiveElement<this._firstFreeElement?(t=6*(this._firstFreeElement-this._firstActiveElement),n.drawElements(4,t,5123,6*this._firstActiveElement*2),I.trianglesFaces+=t/3,I.drawCall++):(t=6*(this._bufferMaxParticles-this._firstActiveElement),n.drawElements(4,t,5123,6*this._firstActiveElement*2),I.trianglesFaces+=t/3,I.drawCall++,this._firstFreeElement>0&&(t=6*this._firstFreeElement,n.drawElements(4,t,5123,0),I.trianglesFaces+=t/3,I.drawCall++))},s.play=function(){if(this._burstsIndex=0,this._isPlaying=!0,this._isPaused=!1,this._frameTime=0,this._emissionTime=0,this._playbackTime=0,!this.autoRandomSeed)for(var e=0,n=this._randomSeeds.length;e<n;e++)this._randomSeeds[e]=this.randomSeed[0]+t._RANDOMOFFSET[e];switch(this.startDelayType){case 0:this._playStartDelay=this.startDelay;break;case 1:this.autoRandomSeed?this._playStartDelay=M.lerp(this.startDelayMin,this.startDelayMax,Math.random()):(this._rand.seed=this._randomSeeds[2],this._playStartDelay=M.lerp(this.startDelayMin,this.startDelayMax,this._rand.getFloat()),this._randomSeeds[2]=this._rand.seed);break;default:throw new Error("Utils3D: startDelayType is invalid.")}this._startUpdateLoopCount=I.loopCount,this.event("played")},s.pause=function(){this._isPaused=!0,this.event("paused")},s.stop=function(){this._burstsIndex=0,this._frameTime=0,this._isPlaying=!1,this._isPaused=!1,this._emissionTime=0,this._playbackTime=0,this.event("stopped")},s.cloneTo=function(e){var t=e;t.duration=this.duration,t.looping=this.looping,t.prewarm=this.prewarm,t.startDelayType=this.startDelayType,t.startDelay=this.startDelay,t.startDelayMin=this.startDelayMin,t.startDelayMax=this.startDelayMax,t.startLifetimeType=this.startLifetimeType,t.startLifetimeConstant=this.startLifetimeConstant,this.startLifeTimeGradient.cloneTo(t.startLifeTimeGradient),t.startLifetimeConstantMin=this.startLifetimeConstantMin,t.startLifetimeConstantMax=this.startLifetimeConstantMax,this.startLifeTimeGradientMin.cloneTo(t.startLifeTimeGradientMin),this.startLifeTimeGradientMax.cloneTo(t.startLifeTimeGradientMax),t.startSpeedType=this.startSpeedType,t.startSpeedConstant=this.startSpeedConstant,t.startSpeedConstantMin=this.startSpeedConstantMin,t.startSpeedConstantMax=this.startSpeedConstantMax,t.threeDStartSize=this.threeDStartSize,t.startSizeType=this.startSizeType,t.startSizeConstant=this.startSizeConstant,this.startSizeConstantSeparate.cloneTo(t.startSizeConstantSeparate),t.startSizeConstantMin=this.startSizeConstantMin,t.startSizeConstantMax=this.startSizeConstantMax,this.startSizeConstantMinSeparate.cloneTo(t.startSizeConstantMinSeparate),this.startSizeConstantMaxSeparate.cloneTo(t.startSizeConstantMaxSeparate),t.threeDStartRotation=this.threeDStartRotation,t.startRotationType=this.startRotationType,t.startRotationConstant=this.startRotationConstant,this.startRotationConstantSeparate.cloneTo(t.startRotationConstantSeparate),t.startRotationConstantMin=this.startRotationConstantMin,t.startRotationConstantMax=this.startRotationConstantMax,this.startRotationConstantMinSeparate.cloneTo(t.startRotationConstantMinSeparate),this.startRotationConstantMaxSeparate.cloneTo(t.startRotationConstantMaxSeparate),t.randomizeRotationDirection=this.randomizeRotationDirection,t.startColorType=this.startColorType,this.startColorConstant.cloneTo(t.startColorConstant),this.startColorConstantMin.cloneTo(t.startColorConstantMin),this.startColorConstantMax.cloneTo(t.startColorConstantMax),this.gravity.cloneTo(t.gravity),t.gravityModifier=this.gravityModifier,t.simulationSpace=this.simulationSpace,t.scaleMode=this.scaleMode,t.playOnAwake=this.playOnAwake,t.maxParticles=this.maxParticles,this.emission&&(t.emission=this.emission.clone()),this.shape&&(t.shape=this.shape.clone()),this.velocityOverLifetime&&(t.velocityOverLifetime=this.velocityOverLifetime.clone()),this.colorOverLifetime&&(t.colorOverLifetime=this.colorOverLifetime.clone()),this.sizeOverLifetime&&(t.sizeOverLifetime=this.sizeOverLifetime.clone()),this.rotationOverLifetime&&(t.rotationOverLifetime=this.rotationOverLifetime.clone()),this.textureSheetAnimation&&(t.textureSheetAnimation=this.textureSheetAnimation.clone()),t.isPerformanceMode=this.isPerformanceMode,t._isPlaying=this._isPlaying,t._isPaused=this._isPaused,t._playStartDelay=this._playStartDelay,t._frameTime=this._frameTime,t._emissionTime=this._emissionTime,t._playbackTime=this._playbackTime,t._burstsIndex=this._burstsIndex},s.clone=function(){var e=new this.constructor;return this.cloneTo(e),e},s._renderRuntime=function(e,t,n){},a(0,s,"isPaused",function(){return this._isPaused}),a(0,s,"currentTime",function(){return this._currentTime}),a(0,s,"maxParticles",function(){return this._bufferMaxParticles-1},function(e){var t=e+1;t!==this._bufferMaxParticles&&(this._bufferMaxParticles=t,this._vertexBuffer&&(this._vertexBuffer.dispose(),this._indexBuffer.dispose()),this._initPartVertexDatas(),this._initIndexDatas())}),a(0,s,"isAlive",function(){return!!(this._isPlaying||this.aliveParticleCount>0)}),a(0,s,"shape",function(){return this._shape},function(e){this._shape=e,this._emission._shape=e}),a(0,s,"rotationOverLifetime",function(){return this._rotationOverLifetime},function(e){if(e){var t=e.angularVelocity,n=t.separateAxes,i=t.type;if(e.enbale)switch(n?this._owner._addShaderDefine(Qt.SHADERDEFINE_ROTATIONOVERLIFETIMESEPERATE):this._owner._addShaderDefine(Qt.SHADERDEFINE_ROTATIONOVERLIFETIME),i){case 0:this._owner._addShaderDefine(Qt.SHADERDEFINE_ROTATIONOVERLIFETIMECONSTANT);break;case 1:this._owner._addShaderDefine(Qt.SHADERDEFINE_ROTATIONOVERLIFETIMECURVE);break;case 2:this._owner._addShaderDefine(Qt.SHADERDEFINE_ROTATIONOVERLIFETIMERANDOMCONSTANTS);break;case 3:this._owner._addShaderDefine(Qt.SHADERDEFINE_ROTATIONOVERLIFETIMERANDOMCURVES)}else this._owner._removeShaderDefine(Qt.SHADERDEFINE_ROTATIONOVERLIFETIME),this._owner._removeShaderDefine(Qt.SHADERDEFINE_ROTATIONOVERLIFETIMESEPERATE),this._owner._removeShaderDefine(Qt.SHADERDEFINE_ROTATIONOVERLIFETIMECONSTANT),this._owner._removeShaderDefine(Qt.SHADERDEFINE_ROTATIONOVERLIFETIMECURVE),this._owner._removeShaderDefine(Qt.SHADERDEFINE_ROTATIONOVERLIFETIMERANDOMCONSTANTS),this._owner._removeShaderDefine(Qt.SHADERDEFINE_ROTATIONOVERLIFETIMERANDOMCURVES);switch(i){case 0:n?this._owner._setShaderValueColor(28,t.constantSeparate):this._owner._setShaderValueNumber(27,t.constant);break;case 1:n?(this._owner._setShaderValueBuffer(30,t.gradientX._elements),this._owner._setShaderValueBuffer(31,t.gradientY._elements),this._owner._setShaderValueBuffer(32,t.gradientZ._elements)):this._owner._setShaderValueBuffer(29,t.gradient._elements);break;case 2:n?(this._owner._setShaderValueColor(28,t.constantMinSeparate),this._owner._setShaderValueColor(34,t.constantMaxSeparate)):(this._owner._setShaderValueNumber(27,t.constantMin),this._owner._setShaderValueNumber(33,t.constantMax));break;case 3:n?(this._owner._setShaderValueBuffer(30,t.gradientXMin._elements),this._owner._setShaderValueBuffer(36,t.gradientXMax._elements),this._owner._setShaderValueBuffer(31,t.gradientYMin._elements),this._owner._setShaderValueBuffer(37,t.gradientYMax._elements),this._owner._setShaderValueBuffer(32,t.gradientZMin._elements),this._owner._setShaderValueBuffer(38,t.gradientZMax._elements)):(this._owner._setShaderValueBuffer(29,t.gradientMin._elements),this._owner._setShaderValueBuffer(35,t.gradientMax._elements))}}else this._owner._removeShaderDefine(Qt.SHADERDEFINE_ROTATIONOVERLIFETIME),this._owner._removeShaderDefine(Qt.SHADERDEFINE_ROTATIONOVERLIFETIMESEPERATE),this._owner._removeShaderDefine(Qt.SHADERDEFINE_ROTATIONOVERLIFETIMECONSTANT),this._owner._removeShaderDefine(Qt.SHADERDEFINE_ROTATIONOVERLIFETIMECURVE),this._owner._removeShaderDefine(Qt.SHADERDEFINE_ROTATIONOVERLIFETIMERANDOMCONSTANTS),this._owner._removeShaderDefine(Qt.SHADERDEFINE_ROTATIONOVERLIFETIMERANDOMCURVES),this._owner._setShaderValueColor(28,null),this._owner._setShaderValueColor(34,null),this._owner._setShaderValueNumber(27,void 0),this._owner._setShaderValueNumber(33,void 0),this._owner._setShaderValueBuffer(30,null),this._owner._setShaderValueBuffer(36,null),this._owner._setShaderValueBuffer(31,null),this._owner._setShaderValueBuffer(37,null),this._owner._setShaderValueBuffer(32,null),this._owner._setShaderValueBuffer(38,null),this._owner._setShaderValueBuffer(29,null),this._owner._setShaderValueBuffer(35,null);this._rotationOverLifetime=e}),a(0,s,"emission",function(){return this._emission},function(e){this._emission=e,e._particleSystem=this,e._shape=this._shape}),a(0,s,"emissionTime",function(){return this._emissionTime>this.duration?this.duration:this._emissionTime}),a(0,s,"aliveParticleCount",function(){return this._firstNewElement>=this._firstRetiredElement?this._firstNewElement-this._firstRetiredElement:this._bufferMaxParticles-this._firstRetiredElement+this._firstNewElement}),a(0,s,"isPlaying",function(){return this._isPlaying}),a(0,s,"playbackTime",function(){return this._playbackTime}),a(0,s,"velocityOverLifetime",function(){return this._velocityOverLifetime},function(e){if(e){var t=e.velocity,n=t.type;if(e.enbale)switch(n){case 0:this._owner._addShaderDefine(Qt.SHADERDEFINE_VELOCITYOVERLIFETIMECONSTANT);break;case 1:this._owner._addShaderDefine(Qt.SHADERDEFINE_VELOCITYOVERLIFETIMECURVE);break;case 2:this._owner._addShaderDefine(Qt.SHADERDEFINE_VELOCITYOVERLIFETIMERANDOMCONSTANT);break;case 3:this._owner._addShaderDefine(Qt.SHADERDEFINE_VELOCITYOVERLIFETIMERANDOMCURVE)}else this._owner._removeShaderDefine(Qt.SHADERDEFINE_VELOCITYOVERLIFETIMECONSTANT),this._owner._removeShaderDefine(Qt.SHADERDEFINE_VELOCITYOVERLIFETIMECURVE),this._owner._removeShaderDefine(Qt.SHADERDEFINE_VELOCITYOVERLIFETIMERANDOMCONSTANT),this._owner._removeShaderDefine(Qt.SHADERDEFINE_VELOCITYOVERLIFETIMERANDOMCURVE);switch(n){case 0:this._owner._setShaderValueColor(6,t.constant);break;case 1:this._owner._setShaderValueBuffer(7,t.gradientX._elements),this._owner._setShaderValueBuffer(8,t.gradientY._elements),this._owner._setShaderValueBuffer(9,t.gradientZ._elements);break;case 2:this._owner._setShaderValueColor(6,t.constantMin),this._owner._setShaderValueColor(10,t.constantMax);break;case 3:this._owner._setShaderValueBuffer(7,t.gradientXMin._elements),this._owner._setShaderValueBuffer(11,t.gradientXMax._elements),this._owner._setShaderValueBuffer(8,t.gradientYMin._elements),this._owner._setShaderValueBuffer(12,t.gradientYMax._elements),this._owner._setShaderValueBuffer(9,t.gradientZMin._elements),this._owner._setShaderValueBuffer(13,t.gradientZMax._elements)}this._owner._setShaderValueInt(14,e.space)}else this._owner._removeShaderDefine(Qt.SHADERDEFINE_VELOCITYOVERLIFETIMECONSTANT),this._owner._removeShaderDefine(Qt.SHADERDEFINE_VELOCITYOVERLIFETIMECURVE),this._owner._removeShaderDefine(Qt.SHADERDEFINE_VELOCITYOVERLIFETIMERANDOMCONSTANT),this._owner._removeShaderDefine(Qt.SHADERDEFINE_VELOCITYOVERLIFETIMERANDOMCURVE),this._owner._setShaderValueColor(6,null),this._owner._setShaderValueBuffer(7,null),this._owner._setShaderValueBuffer(8,null),this._owner._setShaderValueBuffer(9,null),this._owner._setShaderValueColor(6,null),this._owner._setShaderValueColor(10,null),this._owner._setShaderValueBuffer(7,null),this._owner._setShaderValueBuffer(11,null),this._owner._setShaderValueBuffer(8,null),this._owner._setShaderValueBuffer(12,null),this._owner._setShaderValueBuffer(9,null),this._owner._setShaderValueBuffer(13,null),this._owner._setShaderValueInt(14,void 0);this._velocityOverLifetime=e}),a(0,s,"colorOverLifetime",function(){return this._colorOverLifetime},function(e){if(e){var t=e.color;if(e.enbale)switch(t.type){case 1:this._owner._addShaderDefine(Qt.SHADERDEFINE_COLOROVERLIFETIME);break;case 3:this._owner._addShaderDefine(Qt.SHADERDEFINE_RANDOMCOLOROVERLIFETIME)}else this._owner._removeShaderDefine(Qt.SHADERDEFINE_COLOROVERLIFETIME),this._owner._removeShaderDefine(Qt.SHADERDEFINE_RANDOMCOLOROVERLIFETIME);switch(t.type){case 1:var n=t.gradient;this._owner._setShaderValueBuffer(15,n._alphaElements),this._owner._setShaderValueBuffer(16,n._rgbElements);break;case 3:var i=t.gradientMin,r=t.gradientMax;this._owner._setShaderValueBuffer(15,i._alphaElements),this._owner._setShaderValueBuffer(16,i._rgbElements),this._owner._setShaderValueBuffer(17,r._alphaElements),this._owner._setShaderValueBuffer(18,r._rgbElements)}}else this._owner._removeShaderDefine(Qt.SHADERDEFINE_COLOROVERLIFETIME),this._owner._removeShaderDefine(Qt.SHADERDEFINE_RANDOMCOLOROVERLIFETIME),this._owner._setShaderValueBuffer(15,n._alphaElements),this._owner._setShaderValueBuffer(16,n._rgbElements),this._owner._setShaderValueBuffer(15,i._alphaElements),this._owner._setShaderValueBuffer(16,i._rgbElements),this._owner._setShaderValueBuffer(17,r._alphaElements),this._owner._setShaderValueBuffer(18,r._rgbElements);this._colorOverLifetime=e}),a(0,s,"sizeOverLifetime",function(){return this._sizeOverLifetime},function(e){if(e){var t=e.size,n=t.separateAxes,i=t.type;if(e.enbale)switch(i){case 0:n?this._owner._addShaderDefine(Qt.SHADERDEFINE_SIZEOVERLIFETIMECURVESEPERATE):this._owner._addShaderDefine(Qt.SHADERDEFINE_SIZEOVERLIFETIMECURVE);break;case 2:n?this._owner._addShaderDefine(Qt.SHADERDEFINE_SIZEOVERLIFETIMERANDOMCURVESSEPERATE):this._owner._addShaderDefine(Qt.SHADERDEFINE_SIZEOVERLIFETIMERANDOMCURVES)}else this._owner._removeShaderDefine(Qt.SHADERDEFINE_SIZEOVERLIFETIMECURVE),this._owner._removeShaderDefine(Qt.SHADERDEFINE_SIZEOVERLIFETIMECURVESEPERATE),this._owner._removeShaderDefine(Qt.SHADERDEFINE_SIZEOVERLIFETIMERANDOMCURVES),this._owner._removeShaderDefine(Qt.SHADERDEFINE_SIZEOVERLIFETIMERANDOMCURVESSEPERATE);switch(i){case 0:n?(this._owner._setShaderValueBuffer(20,t.gradientX._elements),this._owner._setShaderValueBuffer(21,t.gradientY._elements),this._owner._setShaderValueBuffer(22,t.gradientZ._elements)):this._owner._setShaderValueBuffer(19,t.gradient._elements);break;case 2:n?(this._owner._setShaderValueBuffer(20,t.gradientXMin._elements),this._owner._setShaderValueBuffer(24,t.gradientXMax._elements),this._owner._setShaderValueBuffer(21,t.gradientYMin._elements),this._owner._setShaderValueBuffer(25,t.gradientYMax._elements),this._owner._setShaderValueBuffer(22,t.gradientZMin._elements),this._owner._setShaderValueBuffer(26,t.gradientZMax._elements)):(this._owner._setShaderValueBuffer(19,t.gradientMin._elements),this._owner._setShaderValueBuffer(23,t.gradientMax._elements))}}else this._owner._removeShaderDefine(Qt.SHADERDEFINE_SIZEOVERLIFETIMECURVE),this._owner._removeShaderDefine(Qt.SHADERDEFINE_SIZEOVERLIFETIMECURVESEPERATE),this._owner._removeShaderDefine(Qt.SHADERDEFINE_SIZEOVERLIFETIMERANDOMCURVES),this._owner._removeShaderDefine(Qt.SHADERDEFINE_SIZEOVERLIFETIMERANDOMCURVESSEPERATE),this._owner._setShaderValueBuffer(20,null),this._owner._setShaderValueBuffer(24,null),this._owner._setShaderValueBuffer(21,null),this._owner._setShaderValueBuffer(25,null),this._owner._setShaderValueBuffer(22,null),this._owner._setShaderValueBuffer(26,null),this._owner._setShaderValueBuffer(19,null),this._owner._setShaderValueBuffer(23,null);this._sizeOverLifetime=e}),a(0,s,"textureSheetAnimation",function(){return this._textureSheetAnimation},function(e){if(e){var t=e.frame,n=t.type;if(e.enbale)switch(n){case 1:this._owner._addShaderDefine(Qt.SHADERDEFINE_TEXTURESHEETANIMATIONCURVE);break;case 3:}else this._owner._removeShaderDefine(Qt.SHADERDEFINE_TEXTURESHEETANIMATIONCURVE),this._owner._removeShaderDefine(Qt.SHADERDEFINE_TEXTURESHEETANIMATIONRANDOMCURVE);if(1===n||3===n){this._owner._setShaderValueInt(39,e.cycles);var i=e.tiles,r=this._uvLength.elements;r[0]=1/i.x,r[1]=1/i.y,this._owner._setShaderValueVector2(40,this._uvLength)}switch(n){case 1:this._owner._setShaderValueBuffer(41,t.frameOverTimeData._elements);break;case 3:this._owner._setShaderValueBuffer(41,t.frameOverTimeDataMin._elements),this._owner._setShaderValueBuffer(42,t.frameOverTimeDataMax._elements)}}else this._owner._removeShaderDefine(Qt.SHADERDEFINE_TEXTURESHEETANIMATIONCURVE),this._owner._removeShaderDefine(Qt.SHADERDEFINE_TEXTURESHEETANIMATIONRANDOMCURVE),this._owner._setShaderValueInt(39,void 0),this._owner._setShaderValueVector2(40,null),this._owner._setShaderValueBuffer(41,null),this._owner._setShaderValueBuffer(42,null);this._textureSheetAnimation=e}),a(0,s,"indexOfHost",function(){return 0}),a(0,s,"_vertexBufferCount",function(){return 1}),a(0,s,"triangleCount",function(){return this._indexBuffer.indexCount/3}),a(0,s,"_originalBoundingSphere",function(){var e=this._boundingSphere.center.elements;return e[0]=0,e[1]=0,e[2]=0,this._boundingSphere.radius=Number.MAX_VALUE,this._boundingSphere}),a(0,s,"_originalBoundingBox",function(){var e=this._boundingBox.min.elements;e[0]=-Number.MAX_VALUE,e[1]=-Number.MAX_VALUE,e[2]=-Number.MAX_VALUE;var t=this._boundingBox.min.elements;return t[0]=Number.MAX_VALUE,t[1]=Number.MAX_VALUE,t[2]=Number.MAX_VALUE,this._boundingBox}),i(t,["_RANDOMOFFSET",function(){return this._RANDOMOFFSET=new Uint32Array([592910910,3276756734,322376503,306581307,1793934638,3737431713,2527743459,2368504881,4085612399,3774601268,326370691,1494990940,1089181156,3159510623,2941263940,2786374529,271901988,4233252447])},"_tempPosition",function(){return this._tempPosition=new rt},"_tempDirection",function(){return this._tempDirection=new rt}]),t}(pt),Lt=function(e){function t(e){this._renderMode=0,this.stretchedBillboardCameraSpeedScale=NaN,this.stretchedBillboardSpeedScale=NaN,this.stretchedBillboardLengthScale=NaN,t.__super.call(this,e),this._renderMode=0,e._addShaderDefine(Qt.SHADERDEFINE_SPHERHBILLBOARD),this.stretchedBillboardCameraSpeedScale=0,this.stretchedBillboardSpeedScale=0,this.stretchedBillboardLengthScale=1}r(t,"laya.d3.core.particleShuriKen.ShurikenParticleRender",e);var n=t.prototype;return n._calculateBoundingBox=function(){var e=this._boundingBox.min.elements;e[0]=-Number.MAX_VALUE,e[1]=-Number.MAX_VALUE,e[2]=-Number.MAX_VALUE;var t=this._boundingBox.min.elements;t[0]=Number.MAX_VALUE,t[1]=Number.MAX_VALUE,t[2]=Number.MAX_VALUE},n._calculateBoundingSphere=function(){var e=this._boundingSphere.center.elements;e[0]=0,e[1]=0,e[2]=0,this._boundingSphere.radius=Number.MAX_VALUE},a(0,n,"renderMode",function(){return this._renderMode},function(e){if(this._renderMode!==e){switch(this._renderMode){case 0:this._owner._removeShaderDefine(Qt.SHADERDEFINE_SPHERHBILLBOARD);break;case 1:this._owner._removeShaderDefine(Qt.SHADERDEFINE_STRETCHEDBILLBOARD);break;case 2:this._owner._removeShaderDefine(Qt.SHADERDEFINE_HORIZONTALBILLBOARD);break;case 3:this._owner._removeShaderDefine(Qt.SHADERDEFINE_VERTICALBILLBOARD)}switch(this._renderMode=e,e){case 0:this._owner._addShaderDefine(Qt.SHADERDEFINE_SPHERHBILLBOARD);break;case 1:this._owner._addShaderDefine(Qt.SHADERDEFINE_STRETCHEDBILLBOARD);break;case 2:this._owner._addShaderDefine(Qt.SHADERDEFINE_HORIZONTALBILLBOARD);break;case 3:this._owner._addShaderDefine(Qt.SHADERDEFINE_VERTICALBILLBOARD);break;default:throw new Error("ShurikenParticleRender: unknown renderMode Value.")}}}),t}(vt),Bt=function(e){function t(e,n){this._owner=null,this._vertexBuffer3D=null,this._indexBuffer3D=null,t.__super.call(this,n),this._owner=e,this.initialize(),this._vertexBuffer=this._vertexBuffer3D=Zt.create(xe.vertexDeclaration,4*n.maxPartices,35048),this._indexBuffer=this._indexBuffer3D=qt.create("ushort",6*n.maxPartices,35044,!0),this.loadContent()}r(t,"laya.d3.resource.tempelet.ParticleTemplet3D",e);var i=t.prototype;return n.imps(i,{"laya.d3.core.render.IRenderable":!0}),i._getVertexBuffer=function(e){return void 0===e&&(e=0),0===e?this._vertexBuffer3D:null},i._getIndexBuffer=function(){return this._indexBuffer3D},i.addParticle=function(e,t){this.addParticleArray(e.elements,t.elements)},i.loadContent=function(){for(var e=new Uint16Array(6*this.settings.maxPartices),t=0;t<this.settings.maxPartices;t++)e[6*t+0]=4*t+0,e[6*t+1]=4*t+1,e[6*t+2]=4*t+2,e[6*t+3]=4*t+0,e[6*t+4]=4*t+2,e[6*t+5]=4*t+3;this._indexBuffer3D.setData(e)},i.addNewParticlesToVertexBuffer=function(){var e=0;this._firstNewElement<this._firstFreeElement?(e=4*this._firstNewElement*this._floatCountPerVertex,this._vertexBuffer3D.setData(this._vertices,e,e,4*(this._firstFreeElement-this._firstNewElement)*this._floatCountPerVertex)):(e=4*this._firstNewElement*this._floatCountPerVertex,this._vertexBuffer3D.setData(this._vertices,e,e,4*(this.settings.maxPartices-this._firstNewElement)*this._floatCountPerVertex),this._firstFreeElement>0&&this._vertexBuffer3D.setData(this._vertices,0,0,4*this._firstFreeElement*this._floatCountPerVertex)),this._firstNewElement=this._firstFreeElement},i._beforeRender=function(e){return this._firstNewElement!=this._firstFreeElement&&this.addNewParticlesToVertexBuffer(),this._drawCounter++,this._firstActiveElement!=this._firstFreeElement&&(this._vertexBuffer3D._bind(),this._indexBuffer._bind(),!0)},i._render=function(e){var t=0,n=N.mainContext;this._firstActiveElement<this._firstFreeElement?(t=6*(this._firstFreeElement-this._firstActiveElement),n.drawElements(4,t,5123,6*this._firstActiveElement*2),I.trianglesFaces+=t/3,I.drawCall++):(t=6*(this.settings.maxPartices-this._firstActiveElement),n.drawElements(4,t,5123,6*this._firstActiveElement*2),I.trianglesFaces+=t/3,I.drawCall++,this._firstFreeElement>0&&(t=6*this._firstFreeElement,n.drawElements(4,t,5123,0),I.trianglesFaces+=t/3,I.drawCall++))},i._renderRuntime=function(e,t,n){},a(0,i,"indexOfHost",function(){return 0}),a(0,i,"_vertexBufferCount",function(){return 1}),a(0,i,"triangleCount",function(){return this._indexBuffer3D.indexCount/3}),t}(y),Ft=function(e){function t(e){this._floatCountPerVertex=6,this._owner=null,this._vertices=null,this._vertexBuffer=null,this._firstActiveElement=0,this._firstNewElement=0,this._firstFreeElement=0,this._firstRetiredElement=0,this._currentTime=NaN,this._drawCounter=0,this.scLeft=null,this.scRight=null,this._numPositionMode=0,this._numPositionVelocityMode=0,this._lastTime=NaN,this._needPatch=!1,this._lastPatchAddPos0=null,this._lastPatchAddPos1=null,this._lastPatchAddTime=NaN,this.lifeTime=NaN,this.minSegmentDistance=NaN,this.minInterpDistance=NaN,this.maxSlerpCount=0,this.color=null,this._maxSegments=0,t.__super.call(this),this._tempVector0=new rt,this._tempVector1=new rt,this._tempVector2=new rt,this._tempVector3=new rt,this._albedo=new at(1,1,1,1),this._posModeLastPosition0=new rt,this._posModeLastPosition1=new rt,this._posModePosition0=new rt,this._posModePosition1=new rt,this._posVelModePosition0=new rt,this._posVelModeVelocity0=new rt,this._posVelModePosition1=new rt,this._posVelModeVelocity1=new rt,this._owner=e,this._lastTime=0,this._firstActiveElement=0,this._firstNewElement=0,this._firstFreeElement=0,this._firstRetiredElement=0,this._currentTime=0,this._drawCounter=0,this._needPatch=!1,this._lastPatchAddPos0=new rt,this._lastPatchAddPos1=new rt,this.scLeft=new L,this.scRight=new L,this.lifeTime=.5,this.minSegmentDistance=.1,this.minInterpDistance=.6,this.maxSlerpCount=128,this.color=new at(1,1,1,1),this._maxSegments=200,this._owner.on("enabledchanged",this,this._onEnableChanged)}r(t,"laya.d3.resource.tempelet.GlitterTemplet",e);var i=t.prototype;return n.imps(i,{"laya.d3.core.render.IRenderable":!0}),i._getVertexBuffer=function(e){return void 0===e&&(e=0),0===e?this._vertexBuffer:null},i._getIndexBuffer=function(){return null},i._initialize=function(){this._vertexBuffer=Zt.create(ge.vertexDeclaration,2*this.maxSegments,35048),this._vertices=new Float32Array(this.maxSegments*this._floatCountPerVertex*2)},i._onEnableChanged=function(e){e||(this._numPositionMode=0,this._numPositionVelocityMode=0,this._firstActiveElement=0,this._firstNewElement=0,this._firstFreeElement=0,this._firstRetiredElement=0,this._currentTime=0,this._drawCounter=0)},i._updateTextureCoordinates=function(){this._firstActiveElement<this._firstFreeElement?this._updateSubTextureCoordinates(this._firstActiveElement,2*(this._firstFreeElement-this._firstActiveElement)):(this._updateSubTextureCoordinates(this._firstActiveElement,2*(this.maxSegments-this._firstActiveElement)),this._firstFreeElement>0&&this._updateSubTextureCoordinates(0,2*this._firstFreeElement))},i._updateSubTextureCoordinates=function(e,t){for(var n=2*e,i=0;i<t;i+=2){var r=n+i,a=r*this._floatCountPerVertex,s=(r+1)*this._floatCountPerVertex;this._vertices[a+3]=this._vertices[s+3]=(this._vertices[a+5]-this._currentTime)/this.lifeTime}},i._retireActiveGlitter=function(){for(var e=this.lifeTime,t=2*this._floatCountPerVertex;this._firstActiveElement!=this._firstNewElement;){var n=this._firstActiveElement*t+5
;if(this._currentTime-this._vertices[n]<e)break;this._vertices[n]=this._drawCounter,this._firstActiveElement++,this._firstActiveElement>=this.maxSegments&&(this._firstActiveElement=0)}},i._freeRetiredGlitter=function(){for(var e=2*this._floatCountPerVertex;this._firstRetiredElement!=this._firstActiveElement;){if(this._drawCounter-this._vertices[this._firstRetiredElement*e+5]<3)break;this._firstRetiredElement++,this._firstRetiredElement>=this.maxSegments&&(this._firstRetiredElement=0)}},i._calcVelocity=function(e,t,n){rt.subtract(e,t,n),rt.scale(n,.5,n)},i._addNewGlitterSegementToVertexBuffer=function(){var e=0;this._firstActiveElement<this._firstFreeElement?(e=2*this._firstActiveElement*this._floatCountPerVertex,this._vertexBuffer.setData(this._vertices,e,e,2*(this._firstFreeElement-this._firstActiveElement)*this._floatCountPerVertex)):(e=2*this._firstActiveElement*this._floatCountPerVertex,this._vertexBuffer.setData(this._vertices,e,e,2*(this.maxSegments-this._firstActiveElement)*this._floatCountPerVertex),this._firstFreeElement>0&&this._vertexBuffer.setData(this._vertices,0,0,2*this._firstFreeElement*this._floatCountPerVertex)),this._firstNewElement=this._firstFreeElement},i._addGlitter=function(e,t,n){this._needPatch&&(this._needPatch=!1,this._addGlitter(this._lastPatchAddPos0,this._lastPatchAddPos1,this._lastPatchAddTime));var i=this._firstFreeElement+1;if(i>=this.maxSegments&&(i=0,e.cloneTo(this._lastPatchAddPos0),t.cloneTo(this._lastPatchAddPos1),this._lastPatchAddTime=n,this._needPatch=!0),i===this._firstRetiredElement)throw new Error("GlitterTemplet:current segement count have large than maxSegments,please adjust the  value of maxSegments or add Glitter Vertex Frequency.");var r=e.elements,a=t.elements,s=0,o=this._firstFreeElement*this._floatCountPerVertex*2;for(s=0;s<3;s++)this._vertices[o+s]=r[s];this._vertices[o+3]=0,this._vertices[o+4]=0,this._vertices[o+5]=n;var l=o+this._floatCountPerVertex;for(s=0;s<3;s++)this._vertices[l+s]=a[s];this._vertices[l+3]=0,this._vertices[l+4]=1,this._vertices[l+5]=n,this._firstFreeElement=i},i._update=function(e){this._currentTime+=e/1e3,this._retireActiveGlitter(),this._freeRetiredGlitter(),this._firstActiveElement==this._firstFreeElement&&(this._currentTime=0),this._firstRetiredElement==this._firstActiveElement&&(this._drawCounter=0),this._updateTextureCoordinates()},i._beforeRender=function(e){return this._firstNewElement!=this._firstFreeElement&&this._addNewGlitterSegementToVertexBuffer(),this._drawCounter++,this._firstActiveElement!=this._firstFreeElement&&(this._vertexBuffer.bindWithIndexBuffer(null),!0)},i._render=function(e){var t=0,n=N.mainContext;this._firstActiveElement<this._firstFreeElement?(t=2*(this._firstFreeElement-this._firstActiveElement),n.drawArrays(5,2*this._firstActiveElement,t),I.trianglesFaces+=t-2,I.drawCall++):(t=2*(this.maxSegments-this._firstActiveElement),n.drawArrays(5,2*this._firstActiveElement,t),I.trianglesFaces+=t-2,I.drawCall++,this._firstFreeElement>0&&(t=2*this._firstFreeElement,n.drawArrays(5,0,t),I.trianglesFaces+=t-2,I.drawCall++))},i.addVertexPosition=function(e,t){if(this._owner.enable)if(this._numPositionMode<2)0===this._numPositionMode?(e.cloneTo(this._posModeLastPosition0),t.cloneTo(this._posModeLastPosition1)):(e.cloneTo(this._posModePosition0),t.cloneTo(this._posModePosition1)),this._numPositionMode++;else{var n=this._tempVector2;this._calcVelocity(e,this._posModeLastPosition0,n);var i=this._tempVector3;this._calcVelocity(t,this._posModeLastPosition1,i),this.addVertexPositionVelocity(this._posModePosition0,n,this._posModePosition1,i),this._posModePosition0.cloneTo(this._posModeLastPosition0),this._posModePosition1.cloneTo(this._posModeLastPosition1),e.cloneTo(this._posModePosition0),t.cloneTo(this._posModePosition1)}},i.addVertexPositionVelocity=function(e,t,n,i){if(this._owner.enable){if(0===this._numPositionVelocityMode)this._numPositionVelocityMode++;else{var r=this._tempVector0;rt.subtract(e,this._posVelModePosition0,r);var a=rt.scalarLength(r);rt.subtract(n,this._posVelModePosition1,r);var s=rt.scalarLength(r),o=0,l=l;if(a<l&&s<l)return;if(1===(o=1+Math.floor(Math.max(a,s)/this.minInterpDistance)))this._addGlitter(e,n,this._currentTime);else{o=Math.min(o,this.maxSlerpCount),this.scLeft.Init(this._posVelModePosition0,this._posVelModeVelocity0,e,t),this.scRight.Init(this._posVelModePosition1,this._posVelModeVelocity1,n,i);for(var h=1/o,u=h,c=this._currentTime-this._lastTime,_=1;_<=o;_++){var d=this._tempVector0;this.scLeft.Slerp(u,d);var m=this._tempVector1;this.scRight.Slerp(u,m);var f=this._lastTime+c*_/o;this._addGlitter(d,m,f),u+=h}}}this._lastTime=this._currentTime,e.cloneTo(this._posVelModePosition0),t.cloneTo(this._posVelModeVelocity0),n.cloneTo(this._posVelModePosition1),i.cloneTo(this._posVelModeVelocity1)}},i._destroy=function(){e.prototype._destroy.call(this),this._tempVector0=null,this._tempVector1=null,this._tempVector2=null,this._tempVector3=null,this._owner=null,this._albedo=null,this._vertices=null,this._vertexBuffer.dispose(),this._vertexBuffer=null,this.scLeft=null,this.scRight=null,this._posModeLastPosition0=null,this._posModeLastPosition1=null,this._posModePosition0=null,this._posModePosition1=null,this._posVelModePosition0=null,this._posVelModeVelocity0=null,this._posVelModePosition1=null,this._posVelModeVelocity1=null,this._lastPatchAddPos0=null,this._lastPatchAddPos1=null,this.color=null},i._renderRuntime=function(e,t,n){},a(0,i,"maxSegments",function(){return this._maxSegments-1},function(e){var t=e+1;t!==this._maxSegments&&(this._maxSegments=t,this._vertexBuffer&&this._vertexBuffer.dispose(),this._initialize())}),a(0,i,"_originalBoundingSphere",function(){return e.prototype._$get__originalBoundingSphere.call(this)}),a(0,i,"indexOfHost",function(){return 0}),a(0,i,"_vertexBufferCount",function(){return 1}),a(0,i,"triangleCount",function(){var e=0;return this._firstActiveElement<this._firstFreeElement?e=2*(this._firstFreeElement-this._firstActiveElement)-2:(e=2*(this.maxSegments-this._firstActiveElement)-2,e+=2*this._firstFreeElement-2),e}),a(0,i,"_originalBoundingBox",function(){return e.prototype._$get__originalBoundingBox.call(this)}),t}(pt),Ut=function(e){function t(){this._invertYProjectionMatrix=null,this._invertYProjectionViewMatrix=null,this._invertYScaleMatrix=null,this._boundFrustum=null,this._enableLightCount=3,this._renderTargetTexture=null,this._customRenderQueneIndex=11,this._lastCurrentTime=NaN,this._shaderValues=null,this._shaderDefineValue=0,this._staticBatchManager=null,this._dynamicBatchManager=null,this.enableFog=!1,this.fogStart=NaN,this.fogRange=NaN,this.fogColor=null,this.enableLight=!0,this.treeRoot=null,this.treeSize=null,this.treeLevel=0,t.__super.call(this),this._renderState=new oe,this._lights=new Array,this._frustumCullingObjects=[],this._quenes=[],this._cameraPool=[],this._shaderValues=new ht,this._invertYProjectionMatrix=new Ke,this._invertYProjectionViewMatrix=new Ke,this._invertYScaleMatrix=new Ke,Ke.createScaling(new rt(1,-1,1),this._invertYScaleMatrix),this._staticBatchManager=new fe,this._dynamicBatchManager=new ce,this._boundFrustum=new We(Ke.DEFAULT),this.enableFog=!1,this.fogStart=300,this.fogRange=1e3,this.fogColor=new rt(.7,.7,.7),this.on("display",this,this._$3__onDisplay),this.on("undisplay",this,this._onUnDisplay)}r(t,"laya.d3.core.scene.BaseScene",e);var i=t.prototype;return n.imps(i,{"laya.webgl.submit.ISubmit":!0}),i.initOctree=function(e,t,n,i,r){void 0===r&&(r=6),this.treeSize=new rt(e,t,n),this.treeLevel=r,this.treeRoot=new le(this,0),this.treeRoot.init(i,this.treeSize)},i.initQuadtree=function(e,t,n,i,r){void 0===r&&(r=6),this.treeSize=new rt(e,t,n),this.treeLevel=r,this.treeRoot=new he(this,0),this.treeRoot.init(i,this.treeSize)},i.addTreeNode=function(e){this.treeRoot.addTreeNode(e)},i.removeTreeNode=function(e){this.treeSize&&e._treeNode&&e._treeNode.removeObject(e)},i.createConchModel=function(){var e=new ConchScene;return e.init(512,512,512,4),e},i._$3__onDisplay=function(){n.stage._scenes.push(this),n.stage._scenes.sort(t._sortScenes)},i._onUnDisplay=function(){var e=n.stage._scenes;e.splice(e.indexOf(this),1)},i._prepareUpdateToRenderState=function(e,t){t.context=N.mainContext,t.elapsedTime=this._lastCurrentTime?this.timer.currTimer-this._lastCurrentTime:0,this._lastCurrentTime=this.timer.currTimer,t.loopCount=I.loopCount,t.scene=this},i._prepareSceneToRender=function(e){if(N.frameShaderHighPrecision&&this.addShaderDefine(lt.SHADERDEFINE_FSHIGHPRECISION),this._lights.length>0)for(var t=0,n=0;n<this._lights.length;n++){var i=this._lights[n];if(i.active){if(++t>this._enableLightCount)break;i.updateToWorldState(e)}}if(this.enableFog){var r=this._shaderValues;this.addShaderDefine(lt.SHADERDEFINE_FOG),r.setValue(1,this.fogStart),r.setValue(2,this.fogRange),r.setValue(0,this.fogColor.elements)}},i._endRenderToRenderState=function(e){this._shaderValues.data.length=0},i._updateScene=function(){var e=this._renderState;this._prepareUpdateToRenderState(N.mainContext,e),this.beforeUpdate(e),this._updateChilds(e),this.lateUpdate(e)},i._updateSceneConch=function(){var e=this._renderState;this._prepareUpdateToRenderState(N.mainContext,e),this.beforeUpdate(e),this._updateChildsConch(e),this.lateUpdate(e),this._prepareSceneToRender(e);for(var t=0,n=this._cameraPool.length;t<n;t++){var i=this._cameraPool[t];e.camera=i,i._prepareCameraToRender()}},i._updateChilds=function(e){for(var t=0,n=this._childs.length;t<n;++t)this._childs[t]._update(e)},i._updateChildsConch=function(e){for(var t=0,n=this._childs.length;t<n;++t)this._childs[t]._updateConch(e)},i._preRenderScene=function(e,t){var n=t.viewMatrix,i=t.projectionMatrix,r=t.projectionViewMatrix,a=0,s=0,o=t.camera;for(o.useOcclusionCulling?(this._boundFrustum.matrix=t.projectionViewMatrix,this.treeRoot?_e.renderObjectCullingOctree(this._boundFrustum,this,o,n,i,r):_e.renderObjectCulling(this._boundFrustum,this,o,n,i,r)):_e.renderObjectCullingNoBoundFrustum(this,o,n,i,r),a=0,s=this._quenes.length;a<s;a++)this._quenes[a]&&this._quenes[a]._preRender(t)},i._clear=function(e,t){var n=t.viewport,i=t.camera,r=n.x,a=i.renderTargetSize.height-n.y-n.height,s=n.width,o=n.height;e.viewport(r,a,s,o);var l=0,h=i.renderTarget;switch(i.clearFlag){case 0:var u=i.clearColor;if(u){e.enable(3089),e.scissor(r,a,s,o);var c=u.elements;e.clearColor(c[0],c[1],c[2],c[3]),l=16384}if(h)switch(u||(l=16384),h.depthStencilFormat){case 33189:l|=256;break;case 36168:l|=1024;break;case 34041:l|=256,l|=1024}l&&e.clear(l),u&&e.disable(3089);break;case 1:case 2:if(h)switch(l=16384,h.depthStencilFormat){case 33189:l|=256;break;case 36168:l|=1024;break;case 34041:l|=256,l|=1024}l&&e.clear(l);break;case 3:break;default:throw new Error("BaseScene:camera clearFlag invalid.")}},i._renderScene=function(e,t){var n,i=t.camera,r=0,a=0;for(r=0;r<2;r++)(n=this._quenes[r])&&(i.renderTarget?n._render(t,!0):n._render(t,!1));if(1===i.clearFlag){var s=i.sky;s&&(P.setCullFace(e,!1),P.setDepthFunc(e,515),P.setDepthMask(e,!1),s._render(t),P.setDepthFunc(e,513),P.setDepthMask(e,!0))}for(r=2,a=this._quenes.length;r<a;r++)(n=this._quenes[r])&&(n._sortAlpha(t.camera.transform.position),i.renderTarget?n._render(t,!0):n._render(t,!1))},i._set3DRenderConfig=function(e){e.disable(3042),P._blend=!1,e.blendFunc(770,771),P._sFactor=770,P._dFactor=771,e.disable(2929),P._depthTest=!1,e.enable(2884),P._cullFace=!0,e.depthMask(1),P._depthMask=!0,e.frontFace(2304),P._frontFace=2304},i._set2DRenderConfig=function(e){P.setBlend(e,!0),P.setBlendFunc(e,770,771),P.setDepthTest(e,!1),P.setCullFace(e,!1),P.setDepthMask(e,!0),P.setFrontFace(e,2305),e.viewport(0,0,R.width,R.height)},i._addLight=function(e){this._lights.indexOf(e)<0&&this._lights.push(e)},i._removeLight=function(e){var t=this._lights.indexOf(e);t>=0&&this._lights.splice(t,1)},i.addChildAt=function(e,t){if(!(e instanceof laya.d3.core.Sprite3D))throw new Error("Sprite3D:Node type must Sprite3D.");return laya.display.Node.prototype.addChildAt.call(this,e,t)},i.addChild=function(e){if(!(e instanceof laya.d3.core.Sprite3D))throw new Error("Sprite3D:Node type must Sprite3D.");return laya.display.Node.prototype.addChild.call(this,e)},i.addFrustumCullingObject=function(e){this.treeRoot?this.addTreeNode(e):this._frustumCullingObjects.push(e)},i.removeFrustumCullingObject=function(e){if(this.treeRoot)this.removeTreeNode(e);else{var t=this._frustumCullingObjects.indexOf(e);t!==-1&&this._frustumCullingObjects.splice(t,1)}},i.getRenderQueue=function(e){return this._quenes[e]||(this._quenes[e]=new se(this))},i.addRenderQuene=function(){this._quenes[this._customRenderQueneIndex++]=new se(this)},i.beforeUpdate=function(e){},i.lateUpdate=function(e){},i.beforeRender=function(e){},i.lateRender=function(e){},i.addShaderDefine=function(e){this._shaderDefineValue|=e},i.render=function(t,n,i){D._context.ctx._shader2D.glTexture=null,this._childs.length>0&&t.addRenderObject(this),this._renderType&=-2049,e.prototype.render.call(this,t,n,i)},i._renderCamera=function(e,t,n){},i.renderSubmit=function(){var e=N.mainContext;this._set3DRenderConfig(e),this._prepareSceneToRender(this._renderState);for(var t=0,n=this._cameraPool.length;t<n;t++){var i=this._cameraPool[t];i.enable&&this._renderCamera(e,this._renderState,i)}return this._endRenderToRenderState(this._renderState),this._set2DRenderConfig(e),1},i.getRenderType=function(){return 0},i.releaseRender=function(){},a(0,i,"scene",function(){return this}),t._sortScenes=function(e,i){if(e.parent===n.stage&&i.parent===n.stage){var r=n.stage._childs;return r.indexOf(e)-r.indexOf(i)}return e.parent!==n.stage&&i.parent!==n.stage?t._sortScenes(e.parent,i.parent):e.parent===n.stage?-1:1},t.FOGCOLOR=0,t.FOGSTART=1,t.FOGRANGE=2,t.LIGHTDIRECTION=3,t.LIGHTDIRDIFFUSE=4,t.LIGHTDIRAMBIENT=5,t.LIGHTDIRSPECULAR=6,t.POINTLIGHTPOS=7,t.POINTLIGHTRANGE=8,t.POINTLIGHTATTENUATION=9,t.POINTLIGHTDIFFUSE=10,t.POINTLIGHTAMBIENT=11,t.POINTLIGHTSPECULAR=12,t.SPOTLIGHTPOS=13,t.SPOTLIGHTDIRECTION=14,t.SPOTLIGHTSPOT=15,t.SPOTLIGHTRANGE=16,t.SPOTLIGHTATTENUATION=17,t.SPOTLIGHTDIFFUSE=18,t.SPOTLIGHTAMBIENT=19,t.SPOTLIGHTSPECULAR=20,t}(A),zt=function(e){function t(e,i){this._projectionMatrixModifyID=0,t.__super.call(this),void 0===e&&(e=.3),void 0===i&&(i=1e3),this._tempVector3=new rt,this._position=new rt,this._up=new rt,this._forward=new rt,this._right=new rt,this._fieldOfView=60,this._useUserProjectionMatrix=!1,this._orthographic=!1,this._viewportExpressedInClipSpace=!0,this._renderTargetSize=_t.fullScreen,this._orthographicVerticalSize=10,this.renderingOrder=0,this._nearPlane=e,this._farPlane=i,this.cullingMask=2147483647,this.clearFlag=0,this.useOcclusionCulling=!0,this._calculateProjectionMatrix(),n.stage.on("resize",this,this._onScreenSizeChanged)}r(t,"laya.d3.core.BaseCamera",e);var i=t.prototype;return i.lookAt=function(e){var t=new et;et.lookAt(this.position,e,this.up,t),this.transform.rotation=t},i.createConchModel=function(){return new ConchCamera},i._sortCamerasByRenderingOrder=function(){if(this._displayedInStage)for(var e=this.scene._cameraPool,t=e.length-1,n=0;n<t;n++)if(e[n].renderingOrder>e[t].renderingOrder){var i=e[n];e[n]=e[t],e[t]=i}},i._calculateProjectionMatrix=function(){},i._onScreenSizeChanged=function(){this._calculateProjectionMatrix()},i._prepareCameraToRender=function(){F._currentCameraCullingMask=this.cullingMask;var e=this._shaderValues;e.setValue(0,this.transform.position.elements),e.setValue(5,this.forward.elements),e.setValue(6,this.up.elements)},i.addLayer=function(e){29!==e.number&&30!=e.number&&(this.cullingMask=this.cullingMask|e.mask)},i.removeLayer=function(e){29!==e.number&&30!=e.number&&(this.cullingMask=this.cullingMask&~e.mask)},i.addAllLayers=function(){this.cullingMask=2147483647},i.removeAllLayers=function(){this.cullingMask=0|F.getLayerByNumber(29).mask|F.getLayerByNumber(30).mask},i.ResetProjectionMatrix=function(){this._useUserProjectionMatrix=!1,this._calculateProjectionMatrix()},i.destroy=function(t){void 0===t&&(t=!0),this.sky=null,this.renderTarget=null,n.stage.off("resize",this,this._onScreenSizeChanged),e.prototype.destroy.call(this,t)},i.moveForward=function(e){this._tempVector3.elements[0]=this._tempVector3.elements[1]=0,this._tempVector3.elements[2]=e,this.transform.translate(this._tempVector3)},i.moveRight=function(e){this._tempVector3.elements[1]=this._tempVector3.elements[2]=0,this._tempVector3.elements[0]=e,this.transform.translate(this._tempVector3)},i.moveVertical=function(e){this._tempVector3.elements[0]=this._tempVector3.elements[2]=0,this._tempVector3.elements[1]=e,this.transform.translate(this._tempVector3,!1)},i._addSelfRenderObjects=function(){var e=this.scene._cameraPool,t=e.length;if(t>0){for(var n=t-1;n>=0;n--)if(this.renderingOrder<=e[n].renderingOrder){e.splice(n+1,0,this);break}}else e.push(this),this.scene.conchModel&&this.scene.conchModel.setCurrentCamera(this.conchModel)},i._clearSelfRenderObjects=function(){var e=this.scene._cameraPool;e.splice(e.indexOf(this),1)},a(0,i,"sky",function(){return this._sky},function(e){this._sky=e,e._ownerCamera=this,this.conchModel&&this.conchModel.setSkyMesh(this._sky._conchSky)}),a(0,i,"forward",function(){var e=this.transform.worldMatrix.elements,t=this._forward.elements;return t[0]=-e[8],t[1]=-e[9],t[2]=-e[10],this._forward}),a(0,i,"position",function(){var e=this.transform.worldMatrix.elements,t=this._position.elements;return t[0]=e[12],t[1]=e[13],t[2]=e[14],this._position}),a(0,i,"renderTarget",function(){return this._renderTarget},function(e){this._renderTarget=e,null!=e&&(this._renderTargetSize=e.size)}),a(0,i,"up",function(){var e=this.transform.worldMatrix.elements,t=this._up.elements;return t[0]=e[4],t[1]=e[5],t[2]=e[6],this._up}),a(0,i,"right",function(){var e=this.transform.worldMatrix.elements,t=this._right.elements;return t[0]=e[0],t[1]=e[1],t[2]=e[2],this._right}),a(0,i,"renderTargetSize",function(){return this._renderTargetSize},function(e){null!=this.renderTarget&&this._renderTargetSize,this._renderTargetSize=e,this._calculateProjectionMatrix()}),a(0,i,"fieldOfView",function(){return this._fieldOfView},function(e){this._fieldOfView=e,this._calculateProjectionMatrix()}),a(0,i,"nearPlane",function(){return this._nearPlane},function(e){this._nearPlane=e,this._calculateProjectionMatrix()}),a(0,i,"farPlane",function(){return this._farPlane},function(e){this._farPlane=e,this._calculateProjectionMatrix()}),a(0,i,"orthographicProjection",function(){return this._orthographic},function(e){this._orthographic=e,this._calculateProjectionMatrix()}),a(0,i,"orthographicVerticalSize",function(){return this._orthographicVerticalSize},function(e){this._orthographicVerticalSize=e,this._calculateProjectionMatrix()}),a(0,i,"renderingOrder",function(){return this._renderingOrder},function(e){this._renderingOrder=e,this._sortCamerasByRenderingOrder()}),t.CAMERAPOS=0,t.VIEWMATRIX=1,t.PROJECTMATRIX=2,t.VPMATRIX=3,t.VPMATRIX_NO_TRANSLATE=4,t.CAMERADIRECTION=5,t.CAMERAUP=6,t.ENVIRONMENTDIFFUSE=7,t.ENVIRONMENTSPECULAR=8,t.SIMLODINFO=9,t.RENDERINGTYPE_DEFERREDLIGHTING="DEFERREDLIGHTING",t.RENDERINGTYPE_FORWARDRENDERING="FORWARDRENDERING",t.CLEARFLAG_SOLIDCOLOR=0,t.CLEARFLAG_SKY=1,t.CLEARFLAG_DEPTHONLY=2,t.CLEARFLAG_NONE=3,t}(yt),Ht=function(e){function t(e){this._render=null,this._geometryFilter=null,t.__super.call(this,e)}r(t,"laya.d3.core.RenderableSprite3D",e);var n=t.prototype;return n._update=function(e){e.owner=this,this._enable&&(this._updateComponents(e),this._render._updateOctreeNode(),this._lateUpdateComponents(e)),I.spriteCount++,this._childs.length&&this._updateChilds(e)},n._updateConch=function(e){e.owner=this,this._enable&&(this._updateComponents(e),this._render._updateOctreeNode(),this.transform.worldNeedUpdate&&this._render.renderObject._conchRenderObject.matrix(this.transform.worldMatrix.elements),this._render.renderObject._renderRuntime(e),this._lateUpdateComponents(e)),I.spriteCount++,this._childs.length&&this._updateChildsConch(e)},n.destroy=function(t){void 0===t&&(t=!0),e.prototype.destroy.call(this,t),this._render._destroy(),this._render=null},t}(yt),Gt=function(e){function t(){this._diffuseColor=null,this._ambientColor=null,this._specularColor=null,this._reflectColor=null,t.__super.call(this),this.on("added",this,this._onAdded),this.on("removed",this,this._onRemoved),this._diffuseColor=new rt(.8,.8,.8),this._ambientColor=new rt(.6,.6,.6),this._specularColor=new rt(1,1,1),this._reflectColor=new rt(1,1,1)}r(t,"laya.d3.core.light.LightSprite",e);var n=t.prototype;return n._onRemoved=function(){this.scene._removeLight(this)},n._onAdded=function(){this.scene._addLight(this)},n.updateToWorldState=function(e){},a(0,n,"diffuseColor",function(){return this._diffuseColor},function(e){this._diffuseColor=e}),a(0,n,"ambientColor",function(){return this._ambientColor},function(e){this._ambientColor=e}),a(0,n,"lightType",function(){return-1}),a(0,n,"specularColor",function(){return this._specularColor},function(e){this._specularColor=e}),a(0,n,"reflectColor",function(){return this._reflectColor},function(e){this._reflectColor=e}),t.TYPE_DIRECTIONLIGHT=1,t.TYPE_POINTLIGHT=2,t.TYPE_SPOTLIGHT=3,t}(yt),kt=function(e){function t(e,n,i,r,a,s,o,l){if(this.customCompile=!1,this._curActTexIndex=0,this._program=null,this._attributeParams=null,this._uniformParams=null,this._attributeParamsMap=[],this._sceneUniformParamsMap=[],this._cameraUniformParamsMap=[],this._spriteUniformParamsMap=[],this._materialUniformParamsMap=[],this._renderElementUniformParamsMap=[],t.__super.call(this),!e||!n)throw"Shader Error";(D.isConchApp||D.isFlash)&&(this.customCompile=!0),this._id=++t._count,this._vs=e,this._ps=n,this._attributeMap=i,this._sceneUniformMap=r,this._cameraUniformMap=a,this._spriteUniformMap=s,this._materialUniformMap=o,this._renderElementUniformMap=l,this.recreateResource()}r(t,"laya.d3.shader.Shader3D",e);var n=t.prototype;return n.recreateResource=function(){this.startCreate(),this._compile(),this.completeCreate(),this.memorySize=0},n.detoryResource=function(){N.mainContext.deleteShader(this._vshader),N.mainContext.deleteShader(this._pshader),N.mainContext.deleteProgram(this._program),this._vshader=this._pshader=this._program=null,this._attributeParams=null,this._uniformParams=null,this.memorySize=0,this._curActTexIndex=0},n._compile=function(){if(this._vs&&this._ps&&!this._attributeParams&&!this._uniformParams){this._reCompile=!0,this._attributeParams=[],this._uniformParams=[];var e,n=[this._vs,this._ps];this.customCompile&&(e=this._preGetParams(this._vs,this._ps));var i=N.mainContext;if(this._program=i.createProgram(),this._vshader=t._createShader(i,n[0],35633),this._pshader=t._createShader(i,n[1],35632),i.attachShader(this._program,this._vshader),i.attachShader(this._program,this._pshader),i.linkProgram(this._program),!this.customCompile&&!i.getProgramParameter(this._program,35714))throw i.getProgramInfoLog(this._program);var r,a,s=0,o=0,l=this.customCompile?e.attributes.length:i.getProgramParameter(this._program,35721);for(s=0;s<l;s++){var h=this.customCompile?e.attributes[s]:i.getActiveAttrib(this._program,s);a=i.getAttribLocation(this._program,h.name),r={vartype:"attribute",ivartype:0,attrib:h,location:a,name:h.name,type:h.type,isArray:!1,isSame:!1,preValue:null,indexOfParams:0},this._attributeParams.push(r)}var u=this.customCompile?e.uniforms.length:i.getProgramParameter(this._program,35718);for(s=0;s<u;s++){var c=this.customCompile?e.uniforms[s]:i.getActiveUniform(this._program,s);a=i.getUniformLocation(this._program,c.name),r={vartype:"uniform",ivartype:1,attrib:h,location:a,name:c.name,type:c.type,isArray:!1,isSame:!1,preValue:null,indexOfParams:0},r.name.indexOf("[0]")>0&&(r.name=r.name.substr(0,r.name.length-3),r.isArray=!0,r.location=i.getUniformLocation(this._program,r.name)),this._uniformParams.push(r)}for(s=0,o=this._attributeParams.length;s<o;s++)r=this._attributeParams[s],r.indexOfParams=s,r.index=1,r.value=[r.location,null],r.codename=r.name,r.name=null!=this._attributeMap[r.codename]?this._attributeMap[r.codename]:r.codename,this._attributeParamsMap.push(r.name),this._attributeParamsMap.push(r),r._this=this,r.uploadedValue=[],r.fun=this._attribute;for(s=0,o=this._uniformParams.length;s<o;s++)switch(r=this._uniformParams[s],r.indexOfParams=s,r.index=1,r.value=[r.location,null],r.codename=r.name,null!=this._sceneUniformMap[r.codename]?(r.name=this._sceneUniformMap[r.codename],this._sceneUniformParamsMap.push(r.name),this._sceneUniformParamsMap.push(r)):null!=this._cameraUniformMap[r.codename]?(r.name=this._cameraUniformMap[r.codename],this._cameraUniformParamsMap.push(r.name),this._cameraUniformParamsMap.push(r)):null!=this._spriteUniformMap[r.codename]?(r.name=this._spriteUniformMap[r.codename],this._spriteUniformParamsMap.push(r.name),this._spriteUniformParamsMap.push(r)):null!=this._materialUniformMap[r.codename]?(r.name=this._materialUniformMap[r.codename],this._materialUniformParamsMap.push(r.name),this._materialUniformParamsMap.push(r)):null!=this._renderElementUniformMap[r.codename]?(r.name=this._renderElementUniformMap[r.codename],this._renderElementUniformParamsMap.push(r.name),this._renderElementUniformParamsMap.push(r)):console.log("Shader:can't find uinform name:"+r.codename+"in shader file."),r._this=this,r.uploadedValue=[],r.type){case 5124:r.fun=r.isArray?this._uniform1iv:this._uniform1i;break;case 5126:r.fun=r.isArray?this._uniform1fv:this._uniform1f;break;case 35664:r.fun=r.isArray?this._uniform_vec2v:this._uniform_vec2;break;case 35665:r.fun=r.isArray?this._uniform_vec3v:this._uniform_vec3;break;case 35666:r.fun=r.isArray?this._uniform_vec4v:this._uniform_vec4;break;case 35678:r.fun=this._uniform_sampler2D;break;case 35680:r.fun=this._uniform_samplerCube;break;case 35676:r.fun=this._uniformMatrix4fv;break;case 35670:r.fun=this._uniform1i;break;case 35674:case 35675:throw new Error("compile shader err!");default:throw new Error("compile shader err!")}}},n._attribute=function(e,t){var n=N.mainContext;return n.enableVertexAttribArray(e.location),n.vertexAttribPointer(e.location,t[0],t[1],t[2],t[3],t[4]),2},n._uniform1f=function(e,t){var n=e.uploadedValue;return n[0]!==t?(N.mainContext.uniform1f(e.location,n[0]=t),1):0},n._uniform1fv=function(e,t){if(t.length<4){var n=e.uploadedValue;return n[0]!==t[0]||n[1]!==t[1]||n[2]!==t[2]||n[3]!==t[3]?(N.mainContext.uniform1fv(e.location,t),n[0]=t[0],n[1]=t[1],n[2]=t[2],n[3]=t[3],1):0}return N.mainContext.uniform1fv(e.location,t),1},n._uniform_vec2=function(e,t){var n=e.uploadedValue;return n[0]!==t[0]||n[1]!==t[1]?(N.mainContext.uniform2f(e.location,n[0]=t[0],n[1]=t[1]),1):0},n._uniform_vec2v=function(e,t){if(t.length<2){var n=e.uploadedValue;return n[0]!==t[0]||n[1]!==t[1]||n[2]!==t[2]||n[3]!==t[3]?(N.mainContext.uniform2fv(e.location,t),n[0]=t[0],n[1]=t[1],n[2]=t[2],n[3]=t[3],1):0}return N.mainContext.uniform2fv(e.location,t),1},n._uniform_vec3=function(e,t){var n=e.uploadedValue;return n[0]!==t[0]||n[1]!==t[1]||n[2]!==t[2]?(N.mainContext.uniform3f(e.location,n[0]=t[0],n[1]=t[1],n[2]=t[2]),1):0},n._uniform_vec3v=function(e,t){return N.mainContext.uniform3fv(e.location,t),1},n._uniform_vec4=function(e,t){var n=e.uploadedValue;return n[0]!==t[0]||n[1]!==t[1]||n[2]!==t[2]||n[3]!==t[3]?(N.mainContext.uniform4f(e.location,n[0]=t[0],n[1]=t[1],n[2]=t[2],n[3]=t[3]),1):0},n._uniform_vec4v=function(e,t){return N.mainContext.uniform4fv(e.location,t),1},n._uniformMatrix2fv=function(e,t){return N.mainContext.uniformMatrix2fv(e.location,!1,t),1},n._uniformMatrix3fv=function(e,t){return N.mainContext.uniformMatrix3fv(e.location,!1,t),1},n._uniformMatrix4fv=function(e,t){return N.mainContext.uniformMatrix4fv(e.location,!1,t),1},n._uniform1i=function(e,t){var n=e.uploadedValue;return n[0]!==t?(N.mainContext.uniform1i(e.location,n[0]=t),1):0},n._uniform1iv=function(e,t){return N.mainContext.uniform1iv(e.location,t),1},n._uniform_ivec2=function(e,t){var n=e.uploadedValue;return n[0]!==t[0]||n[1]!==t[1]?(N.mainContext.uniform2i(e.location,n[0]=t[0],n[1]=t[1]),1):0},n._uniform_ivec2v=function(e,t){return N.mainContext.uniform2iv(e.location,t),1},n._uniform_vec3i=function(e,t){var n=e.uploadedValue;return n[0]!==t[0]||n[1]!==t[1]||n[2]!==t[2]?(N.mainContext.uniform3i(e.location,n[0]=t[0],n[1]=t[1],n[2]=t[2]),1):0},n._uniform_vec3vi=function(e,t){return N.mainContext.uniform3iv(e.location,t),1},n._uniform_vec4i=function(e,t){var n=e.uploadedValue;return n[0]!==t[0]||n[1]!==t[1]||n[2]!==t[2]||n[3]!==t[3]?(N.mainContext.uniform4i(e.location,n[0]=t[0],n[1]=t[1],n[2]=t[2],n[3]=t[3]),1):0},n._uniform_vec4vi=function(e,t){return N.mainContext.uniform4iv(e.location,t),1},n._uniform_sampler2D=function(e,n){var i=N.mainContext,r=e.uploadedValue;return null==r[0]?(r[0]=this._curActTexIndex,i.uniform1i(e.location,this._curActTexIndex),i.activeTexture(t._TEXTURES[this._curActTexIndex]),P.bindTexture(i,3553,n),this._curActTexIndex++,1):(i.activeTexture(t._TEXTURES[r[0]]),P.bindTexture(i,3553,n),0)},n._uniform_samplerCube=function(e,n){var i=N.mainContext,r=e.uploadedValue;return null==r[0]?(r[0]=this._curActTexIndex,i.uniform1i(e.location,this._curActTexIndex),i.activeTexture(t._TEXTURES[this._curActTexIndex]),P.bindTexture(i,34067,n),this._curActTexIndex++,1):(i.activeTexture(t._TEXTURES[r[0]]),P.bindTexture(i,34067,n),0)},n._noSetValue=function(e){console.log("no....:"+e.name)},n.uploadTexture2D=function(e){I.shaderCall++;var t=N.mainContext;t.activeTexture(33984),P.bindTexture(t,3553,e)},n.bind=function(){return u.activeShader=this,u.bindShader=this,this.activeResource(),P.UseProgram(this._program)},n.uploadAttributes=function(e,t){for(var n,i,r=0,a=0,s=this._attributeParamsMap.length;a<s;a+=2)i=this._attributeParamsMap[a+1],null!=(n=e[this._attributeParamsMap[a]])&&(t&&t[i.name]&&t[i.name].bind(),r+=i.fun.call(this,i,n));I.shaderCall+=r},n.uploadSceneUniforms=function(e){for(var t,n,i=0,r=0,a=this._sceneUniformParamsMap.length;r<a;r+=2)n=this._sceneUniformParamsMap[r+1],null!=(t=e[this._sceneUniformParamsMap[r]])&&(i+=n.fun.call(this,n,t));I.shaderCall+=i},n.uploadCameraUniforms=function(e){for(var t,n,i=0,r=0,a=this._cameraUniformParamsMap.length;r<a;r+=2)n=this._cameraUniformParamsMap[r+1],null!=(t=e[this._cameraUniformParamsMap[r]])&&(i+=n.fun.call(this,n,t));I.shaderCall+=i},n.uploadSpriteUniforms=function(e){for(var t,n,i=0,r=0,a=this._spriteUniformParamsMap.length;r<a;r+=2)n=this._spriteUniformParamsMap[r+1],null!=(t=e[this._spriteUniformParamsMap[r]])&&(i+=n.fun.call(this,n,t));I.shaderCall+=i},n.uploadMaterialUniforms=function(e){for(var t,n,i=0,r=0,a=this._materialUniformParamsMap.length;r<a;r+=2)n=this._materialUniformParamsMap[r+1],null!=(t=e[this._materialUniformParamsMap[r]])&&(i+=n.fun.call(this,n,t));I.shaderCall+=i},n.uploadRenderElementUniforms=function(e){for(var t,n,i=0,r=0,a=this._renderElementUniformParamsMap.length;r<a;r+=2)n=this._renderElementUniformParamsMap[r+1],null!=(t=e[this._renderElementUniformParamsMap[r]])&&(i+=n.fun.call(this,n,t));I.shaderCall+=i},n._preGetParams=function(e,t){var n=[e,t],i={},r=[],a=[],s={},o=[];i.attributes=r,i.uniforms=a,i.defines=s;for(var l=new RegExp("(/\\*([^*]|[\\r\\\n]|(\\*+([^*/]|[\\r\\n])))*\\*+/)|(//.*)","g"),h=new RegExp("(\".*\")|('.*')|([#\\w\\*-\\.+/()=<>{}\\\\]+)|([,;:\\\\])","g"),u=0,c=0,_=0;_<2;_++){n[_]=n[_].replace(l,"");var d,m=n[_].match(h);for(u=0,c=m.length;u<c;u++){var f=m[u];if("attribute"==f||"uniform"==f)u=this.parseOne(r,a,m,u,f,!0);else{if("#define"==f){f=m[++u],o[f]=1;continue}if("#ifdef"==f){d=m[++u];s[d]=s[d]||[];for(u++;u<c;u++)if("attribute"==(f=m[u])||"uniform"==f)u=this.parseOne(r,a,m,u,f,o[d]);else if("#else"==f)for(u++;u<c;u++)if("attribute"==(f=m[u])||"uniform"==f)u=this.parseOne(r,a,m,u,f,!o[d]);else if("#endif"==f)break}}}}return i},n.parseOne=function(e,n,i,r,a,s){var o={type:t.shaderParamsMap[i[r+1]],name:i[r+2],size:isNaN(parseInt(i[r+3]))?1:parseInt(i[r+3])};return s&&("attribute"==a?e.push(o):n.push(o)),":"==i[r+3]&&(o.type=i[r+4],r+=2),r+=2},n.dispose=function(){this.resourceManager.removeResource(this),laya.resource.Resource.prototype.dispose.call(this)},
t.create=function(e,n,i,r,a,s,o,l){return new t(e,n,i,r,a,s,o,l)},t.addInclude=function(e,n){if(!n||0===n.length)throw new Error("add shader include file err:"+e);if(t._includeFiles[e])throw new Error("add shader include file err, has add:"+e);t._includeFiles[e]=n},t._createShader=function(e,t,n){var i=e.createShader(n);if(e.shaderSource(i,t),e.compileShader(i),!e.getShaderParameter(i,35713))throw e.getShaderInfoLog(i);return i},t.PERIOD_RENDERELEMENT=0,t.PERIOD_MATERIAL=1,t.PERIOD_SPRITE=2,t.PERIOD_CAMERA=3,t.PERIOD_SCENE=4,t._TEXTURES=[33984,33985,33986,33987,33988,33989,33990,,33991,33992],t._includeFiles={},t._count=0,i(t,["shaderParamsMap",function(){return this.shaderParamsMap={float:5126,int:5124,bool:35670,vec2:35664,vec3:35665,vec4:35666,ivec2:35667,ivec3:35668,ivec4:35669,bvec2:35671,bvec3:35672,bvec4:35673,mat2:35674,mat3:35675,mat4:35676,sampler2D:35678,samplerCube:35680}},"nameKey",function(){return this.nameKey=new b}]),t}(u),jt=function(e){function t(){this._renderMode=0,t.__super.call(this),this.setShaderName("GLITTER"),this.renderMode=1}r(t,"laya.d3.core.material.GlitterMaterial",e);var s=t.prototype;return s.setShaderName=function(t){e.prototype.setShaderName.call(this,t)},s._setMaterialShaderParams=function(e){var t=e.owner,n=t.templet;this._setColor(3,n.color),this._setNumber(4,n.lifeTime),this._setColor(1,n._albedo),this._setNumber(2,n._currentTime)},s.cloneTo=function(t){e.prototype.cloneTo.call(this,t),t._renderMode=this._renderMode},a(0,s,"renderMode",function(){return this._renderMode},function(e){switch(this._renderMode=e,e){case 1:this._renderQueue=1,this.depthWrite=!0,this.cull=2,this.blend=0,this.event("renderqueuechanged",this);break;case 2:this._renderQueue=1,this.depthWrite=!0,this.cull=0,this.blend=0,this.event("renderqueuechanged",this);break;case 13:this._renderQueue=2,this.depthWrite=!0,this.cull=2,this.blend=1,this.srcBlend=770,this.dstBlend=771,this.event("renderqueuechanged",this);break;case 14:this._renderQueue=2,this.depthWrite=!0,this.cull=0,this.blend=1,this.srcBlend=770,this.dstBlend=771,this.event("renderqueuechanged",this);break;case 15:this._renderQueue=2,this.depthWrite=!0,this.cull=2,this.blend=1,this.srcBlend=770,this.dstBlend=1,this.event("renderqueuechanged",this);break;case 16:this._renderQueue=2,this.depthWrite=!0,this.cull=0,this.blend=1,this.srcBlend=770,this.dstBlend=1,this.event("renderqueuechanged",this);break;case 5:this._renderQueue=2,this.depthWrite=!1,this.cull=2,this.blend=1,this.srcBlend=770,this.dstBlend=771,this.event("renderqueuechanged",this);break;case 6:this._renderQueue=2,this.depthWrite=!1,this.cull=0,this.blend=1,this.srcBlend=770,this.dstBlend=771,this.event("renderqueuechanged",this);break;case 7:this._renderQueue=2,this.depthWrite=!1,this.cull=2,this.blend=1,this.srcBlend=770,this.dstBlend=1,this.event("renderqueuechanged",this);break;case 8:this._renderQueue=2,this.depthWrite=!1,this.cull=0,this.blend=1,this.srcBlend=770,this.dstBlend=1,this.event("renderqueuechanged",this);break;case 9:this._renderQueue=2,this.depthTest=!1,this.cull=2,this.blend=1,this.srcBlend=770,this.dstBlend=771,this.event("renderqueuechanged",this);break;case 10:this._renderQueue=2,this.depthTest=!1,this.cull=0,this.blend=1,this.srcBlend=770,this.dstBlend=771,this.event("renderqueuechanged",this);break;case 11:this._renderQueue=2,this.depthTest=!1,this.cull=2,this.blend=1,this.srcBlend=770,this.dstBlend=1,this.event("renderqueuechanged",this);break;case 12:this._renderQueue=2,this.depthTest=!1,this.cull=0,this.blend=1,this.srcBlend=770,this.dstBlend=1,this.event("renderqueuechanged",this);break;default:throw new Error("Material:renderMode value error.")}this._conchMaterial&&this._conchMaterial.setRenderMode(e)}),a(0,s,"diffuseTexture",function(){return this._getTexture(0)},function(e){this._setTexture(0,e)}),t.load=function(e){return n.loader.create(e,null,null,t)},t.RENDERMODE_OPAQUE=1,t.RENDERMODE_OPAQUEDOUBLEFACE=2,t.RENDERMODE_TRANSPARENT=13,t.RENDERMODE_TRANSPARENTDOUBLEFACE=14,t.RENDERMODE_ADDTIVE=15,t.RENDERMODE_ADDTIVEDOUBLEFACE=16,t.RENDERMODE_DEPTHREAD_TRANSPARENT=5,t.RENDERMODE_DEPTHREAD_TRANSPARENTDOUBLEFACE=6,t.RENDERMODE_DEPTHREAD_ADDTIVE=7,t.RENDERMODE_DEPTHREAD_ADDTIVEDOUBLEFACE=8,t.RENDERMODE_NONDEPTH_TRANSPARENT=9,t.RENDERMODE_NONDEPTH_TRANSPARENTDOUBLEFACE=10,t.RENDERMODE_NONDEPTH_ADDTIVE=11,t.RENDERMODE_NONDEPTH_ADDTIVEDOUBLEFACE=12,t.DIFFUSETEXTURE=0,t.ALBEDO=1,t.CURRENTTIME=2,t.UNICOLOR=3,t.DURATION=4,i(t,["defaultMaterial",function(){return this.defaultMaterial=new t}]),t}(Dt),Yt=function(e){function t(){this._renderMode=0,t.__super.call(this),this._addShaderDefine(laya.d3.core.material.ParticleMaterial.SHADERDEFINE_PARTICLE3D),this.setShaderName("PARTICLE"),this.renderMode=1}r(t,"laya.d3.core.material.ParticleMaterial",e);var s=t.prototype;return s._setMaterialShaderParams=function(e){var t=e.owner,n=t.templet,i=n.settings;this._setNumber(2,i.duration),this._setBuffer(3,i.gravity),this._setNumber(4,i.endVelocity);var r=e.viewport.width/e.viewport.height,a=new it(.5/r,-.5);this._setVector2(0,a),this._setNumber(1,n._currentTime)},s.cloneTo=function(t){e.prototype.cloneTo.call(this,t),t._renderMode=this._renderMode},a(0,s,"renderMode",function(){return this._renderMode},function(e){switch(this._renderMode=e,e){case 1:this._renderQueue=1,this.depthWrite=!0,this.cull=2,this.blend=0,this.event("renderqueuechanged",this);break;case 2:this._renderQueue=1,this.depthWrite=!0,this.cull=0,this.blend=0,this.event("renderqueuechanged",this);break;case 13:this._renderQueue=2,this.depthWrite=!0,this.cull=2,this.blend=1,this.srcBlend=770,this.dstBlend=771,this.event("renderqueuechanged",this);break;case 14:this._renderQueue=2,this.depthWrite=!0,this.cull=0,this.blend=1,this.srcBlend=770,this.dstBlend=771,this.event("renderqueuechanged",this);break;case 15:this._renderQueue=2,this.depthWrite=!0,this.cull=2,this.blend=1,this.srcBlend=770,this.dstBlend=1,this.event("renderqueuechanged",this);break;case 16:this._renderQueue=2,this.depthWrite=!0,this.cull=0,this.blend=1,this.srcBlend=770,this.dstBlend=1,this.event("renderqueuechanged",this);break;case 5:this._renderQueue=2,this.depthWrite=!1,this.cull=2,this.blend=1,this.srcBlend=770,this.dstBlend=771,this.event("renderqueuechanged",this);break;case 6:this._renderQueue=2,this.depthWrite=!1,this.cull=0,this.blend=1,this.srcBlend=770,this.dstBlend=771,this.event("renderqueuechanged",this);break;case 7:this._renderQueue=2,this.depthWrite=!1,this.cull=2,this.blend=1,this.srcBlend=770,this.dstBlend=1,this.event("renderqueuechanged",this);break;case 8:this._renderQueue=2,this.depthWrite=!1,this.cull=0,this.blend=1,this.srcBlend=770,this.dstBlend=1,this.event("renderqueuechanged",this);break;case 9:this._renderQueue=2,this.depthTest=!1,this.cull=2,this.blend=1,this.srcBlend=770,this.dstBlend=771,this.event("renderqueuechanged",this);break;case 10:this._renderQueue=2,this.depthTest=!1,this.cull=0,this.blend=1,this.srcBlend=770,this.dstBlend=771,this.event("renderqueuechanged",this);break;case 11:this._renderQueue=2,this.depthTest=!1,this.cull=2,this.blend=1,this.srcBlend=770,this.dstBlend=1,this.event("renderqueuechanged",this);break;case 12:this._renderQueue=2,this.depthTest=!1,this.cull=0,this.blend=1,this.srcBlend=770,this.dstBlend=1,this.event("renderqueuechanged",this);break;default:throw new Error("Material:renderMode value error.")}this._conchMaterial&&this._conchMaterial.setRenderMode(e)}),a(0,s,"diffuseTexture",function(){return this._getTexture(5)},function(e){this._setTexture(5,e)}),t.load=function(e){return n.loader.create(e,null,null,t)},t.RENDERMODE_OPAQUE=1,t.RENDERMODE_OPAQUEDOUBLEFACE=2,t.RENDERMODE_TRANSPARENT=13,t.RENDERMODE_TRANSPARENTDOUBLEFACE=14,t.RENDERMODE_ADDTIVE=15,t.RENDERMODE_ADDTIVEDOUBLEFACE=16,t.RENDERMODE_DEPTHREAD_TRANSPARENT=5,t.RENDERMODE_DEPTHREAD_TRANSPARENTDOUBLEFACE=6,t.RENDERMODE_DEPTHREAD_ADDTIVE=7,t.RENDERMODE_DEPTHREAD_ADDTIVEDOUBLEFACE=8,t.RENDERMODE_NONDEPTH_TRANSPARENT=9,t.RENDERMODE_NONDEPTH_TRANSPARENTDOUBLEFACE=10,t.RENDERMODE_NONDEPTH_ADDTIVE=11,t.RENDERMODE_NONDEPTH_ADDTIVEDOUBLEFACE=12,t.SHADERDEFINE_PARTICLE3D=0,t.VIEWPORTSCALE=0,t.CURRENTTIME=1,t.DURATION=2,t.GRAVITY=3,t.ENDVELOCITY=4,t.DIFFUSETEXTURE=5,i(t,["defaultMaterial",function(){return this.defaultMaterial=new t}]),t}(Dt),Wt=function(e){function t(){if(this._transformUV=null,t.__super.call(this),!laya.d3.core.material.PBRMaterial.pbrlutTex){var e=c.window.__pbrlutdata;if(!e)throw alert("no pbr lutdata, need pbrlut.js"),"no pbr lutdata, need pbrlut.js";var n=$t.create(new Uint32Array(e).buffer,256,256,9728,9728,!1);laya.d3.core.material.PBRMaterial.pbrlutTex=n}this._setTexture(3,laya.d3.core.material.PBRMaterial.pbrlutTex),this.setShaderName("PBR"),this._setNumber(4,.5)}r(t,"laya.d3.core.material.PBRMaterial",e);var s=t.prototype;return s.disableLight=function(){this._addDisableShaderDefine(lt.SHADERDEFINE_POINTLIGHT|lt.SHADERDEFINE_SPOTLIGHT|lt.SHADERDEFINE_DIRECTIONLIGHT)},s.disableFog=function(){this._addDisableShaderDefine(lt.SHADERDEFINE_FOG)},s._setMaterialShaderParams=function(e){this._transformUV&&this._transformUV.matrix},s.onAsynLoaded=function(t,n,i){e.prototype.onAsynLoaded.call(this,t,n,i)},a(0,s,"transformUV",function(){return this._transformUV},function(e){this._transformUV=e,this._setMatrix4x4(7,e.matrix),this._conchMaterial&&this._conchMaterial.setShaderValue(7,e.matrix.elements,0)}),a(0,s,"diffuseTexture",function(){return this._getTexture(0)},function(e){this._setTexture(0,e)}),a(0,s,"alphaTestValue",function(){return this._getNumber(4)},function(e){this._setNumber(4,e)}),a(0,s,"normalTexture",function(){return this._getTexture(1)},function(e){this._setTexture(1,e)}),a(0,s,"roughness",function(){return this._getNumber(6)},function(e){this._setNumber(6,e)}),a(0,s,"pbrlutTexture",function(){return this._getTexture(3)},function(e){this._setTexture(3,e)}),a(0,s,"pbrInfoTexture",function(){return this._getTexture(2)},function(e){this._setTexture(2,e)}),t.load=function(e){return n.loader.create(e,null,null,t)},t.DIFFUSETEXTURE=0,t.NORMALTEXTURE=1,t.PBRINFOTEXTURE=2,t.PBRLUTTEXTURE=3,t.ALPHATESTVALUE=4,t.UVANIAGE=5,t.MATERIALROUGHNESS=6,t.UVMATRIX=7,t.UVAGE=8,t.pbrlutTex=null,i(t,["defaultMaterial",function(){return this.defaultMaterial=new t}]),t}(Dt),Xt=function(e){function t(){this._renderMode=0,this._transformUV=null,t.__super.call(this),this.setShaderName("SIMPLE"),this._setColor(9,new rt(.6,.6,.6)),this._setColor(10,new rt(1,1,1)),this._setColor(11,new at(1,1,1,8)),this._setColor(12,new rt(1,1,1)),this._setColor(6,new at(1,1,1,1)),this._setNumber(7,.5),this.renderMode=1}r(t,"laya.d3.core.material.StandardMaterial",e);var s=t.prototype;return s.disableLight=function(){this._addDisableShaderDefine(lt.SHADERDEFINE_POINTLIGHT|lt.SHADERDEFINE_SPOTLIGHT|lt.SHADERDEFINE_DIRECTIONLIGHT)},s.disableFog=function(){this._addDisableShaderDefine(lt.SHADERDEFINE_FOG)},s.onAsynLoaded=function(n,i,r){var a=i[0];if(a.version)e.prototype.onAsynLoaded.call(this,n,i,r);else{var s=i[1],o=a.props;for(var l in o)this[l]=o[l];t._parseStandardMaterial(s,this,a),this.event("loaded",this)}},s._setMaterialShaderParams=function(e){this._transformUV&&this._transformUV.matrix},s.cloneTo=function(t){e.prototype.cloneTo.call(this,t),t._renderMode=this._renderMode},a(0,s,"ambientColor",function(){return this._getColor(9)},function(e){this._setColor(9,e)}),a(0,s,"ambientTexture",function(){return this._getTexture(4)},function(e){e?this._addShaderDefine(laya.d3.core.material.StandardMaterial.SHADERDEFINE_AMBIENTMAP):this._removeShaderDefine(laya.d3.core.material.StandardMaterial.SHADERDEFINE_AMBIENTMAP),this._setTexture(4,e)}),a(0,s,"renderMode",function(){return this._renderMode},function(e){switch(this._renderMode=e,e){case 1:this._renderQueue=1,this.depthWrite=!0,this.cull=2,this.blend=0,this._removeShaderDefine(laya.d3.core.material.StandardMaterial.SHADERDEFINE_ALPHATEST),this.event("renderqueuechanged",this);break;case 2:this._renderQueue=1,this.depthWrite=!0,this.cull=0,this.blend=0,this._removeShaderDefine(laya.d3.core.material.StandardMaterial.SHADERDEFINE_ALPHATEST),this.event("renderqueuechanged",this);break;case 3:this.depthWrite=!0,this.cull=2,this.blend=0,this._renderQueue=1,this._addShaderDefine(laya.d3.core.material.StandardMaterial.SHADERDEFINE_ALPHATEST),this.event("renderqueuechanged",this);break;case 4:this._renderQueue=1,this.depthWrite=!0,this.cull=0,this.blend=0,this._addShaderDefine(laya.d3.core.material.StandardMaterial.SHADERDEFINE_ALPHATEST),this.event("renderqueuechanged",this);break;case 13:this._renderQueue=2,this.depthWrite=!0,this.cull=2,this.blend=1,this.srcBlend=770,this.dstBlend=771,this._removeShaderDefine(laya.d3.core.material.StandardMaterial.SHADERDEFINE_ALPHATEST),this.event("renderqueuechanged",this);break;case 14:this._renderQueue=2,this.depthWrite=!0,this.cull=0,this.blend=1,this.srcBlend=770,this.dstBlend=771,this._removeShaderDefine(laya.d3.core.material.StandardMaterial.SHADERDEFINE_ALPHATEST),this.event("renderqueuechanged",this);break;case 15:this._renderQueue=2,this.depthWrite=!0,this.cull=2,this.blend=1,this.srcBlend=770,this.dstBlend=1,this._removeShaderDefine(laya.d3.core.material.StandardMaterial.SHADERDEFINE_ALPHATEST),this.event("renderqueuechanged",this);break;case 16:this._renderQueue=2,this.depthWrite=!0,this.cull=0,this.blend=1,this.srcBlend=770,this.dstBlend=1,this._removeShaderDefine(laya.d3.core.material.StandardMaterial.SHADERDEFINE_ALPHATEST),this.event("renderqueuechanged",this);break;case 5:this._renderQueue=2,this.depthWrite=!1,this.cull=2,this.blend=1,this.srcBlend=770,this.dstBlend=771,this._removeShaderDefine(laya.d3.core.material.StandardMaterial.SHADERDEFINE_ALPHATEST),this.event("renderqueuechanged",this);break;case 6:this._renderQueue=2,this.depthWrite=!1,this.cull=0,this.blend=1,this.srcBlend=770,this.dstBlend=771,this._removeShaderDefine(laya.d3.core.material.StandardMaterial.SHADERDEFINE_ALPHATEST),this.event("renderqueuechanged",this);break;case 7:this._renderQueue=2,this.depthWrite=!1,this.cull=2,this.blend=1,this.srcBlend=770,this.dstBlend=1,this._removeShaderDefine(laya.d3.core.material.StandardMaterial.SHADERDEFINE_ALPHATEST),this.event("renderqueuechanged",this);break;case 8:this._renderQueue=2,this.depthWrite=!1,this.cull=0,this.blend=1,this.srcBlend=770,this.dstBlend=1,this._removeShaderDefine(laya.d3.core.material.StandardMaterial.SHADERDEFINE_ALPHATEST),this.event("renderqueuechanged",this);break;case 9:this._renderQueue=2,this.depthTest=!1,this.cull=2,this.blend=1,this.srcBlend=770,this.dstBlend=771,this._removeShaderDefine(laya.d3.core.material.StandardMaterial.SHADERDEFINE_ALPHATEST),this.event("renderqueuechanged",this);break;case 10:this._renderQueue=2,this.depthTest=!1,this.cull=0,this.blend=1,this.srcBlend=770,this.dstBlend=771,this._removeShaderDefine(laya.d3.core.material.StandardMaterial.SHADERDEFINE_ALPHATEST),this.event("renderqueuechanged",this);break;case 11:this._renderQueue=2,this.depthTest=!1,this.cull=2,this.blend=1,this.srcBlend=770,this.dstBlend=1,this._removeShaderDefine(laya.d3.core.material.StandardMaterial.SHADERDEFINE_ALPHATEST),this.event("renderqueuechanged",this);break;case 12:this._renderQueue=2,this.depthTest=!1,this.cull=0,this.blend=1,this.srcBlend=770,this.dstBlend=1,this._removeShaderDefine(laya.d3.core.material.StandardMaterial.SHADERDEFINE_ALPHATEST),this.event("renderqueuechanged",this);break;default:throw new Error("Material:renderMode value error.")}this._conchMaterial&&this._conchMaterial.setRenderMode(e)}),a(0,s,"albedo",function(){return this._getColor(6)},function(e){this._setColor(6,e)}),a(0,s,"diffuseColor",function(){return this._getColor(10)},function(e){this._setColor(10,e)}),a(0,s,"specularColor",function(){return this._getColor(11)},function(e){this._setColor(11,e)}),a(0,s,"normalTexture",function(){return this._getTexture(1)},function(e){e?this._addShaderDefine(laya.d3.core.material.StandardMaterial.SHADERDEFINE_NORMALMAP):this._removeShaderDefine(laya.d3.core.material.StandardMaterial.SHADERDEFINE_NORMALMAP),this._setTexture(1,e)}),a(0,s,"reflectColor",function(){return this._getColor(12)},function(e){this._setColor(12,e)}),a(0,s,"diffuseTexture",function(){return this._getTexture(0)},function(e){e?this._addShaderDefine(laya.d3.core.material.StandardMaterial.SHADERDEFINE_DIFFUSEMAP):this._removeShaderDefine(laya.d3.core.material.StandardMaterial.SHADERDEFINE_DIFFUSEMAP),this._setTexture(0,e)}),a(0,s,"alphaTestValue",function(){return this._getNumber(7)},function(e){this._setNumber(7,e)}),a(0,s,"specularTexture",function(){return this._getTexture(2)},function(e){e?this._addShaderDefine(laya.d3.core.material.StandardMaterial.SHADERDEFINE_SPECULARMAP):this._removeShaderDefine(laya.d3.core.material.StandardMaterial.SHADERDEFINE_SPECULARMAP),this._setTexture(2,e)}),a(0,s,"emissiveTexture",function(){return this._getTexture(3)},function(e){e?this._addShaderDefine(laya.d3.core.material.StandardMaterial.SHADERDEFINE_EMISSIVEMAP):this._removeShaderDefine(laya.d3.core.material.StandardMaterial.SHADERDEFINE_EMISSIVEMAP),this._setTexture(3,e)}),a(0,s,"reflectTexture",function(){return this._getTexture(5)},function(e){e?this._addShaderDefine(laya.d3.core.material.StandardMaterial.SHADERDEFINE_REFLECTMAP):this._removeShaderDefine(laya.d3.core.material.StandardMaterial.SHADERDEFINE_REFLECTMAP),this._setTexture(5,e)}),a(0,s,"transformUV",function(){return this._transformUV},function(e){this._transformUV=e,this._setMatrix4x4(13,e.matrix),e?this._addShaderDefine(laya.d3.core.material.StandardMaterial.SHADERDEFINE_UVTRANSFORM):this._removeShaderDefine(laya.d3.core.material.StandardMaterial.SHADERDEFINE_UVTRANSFORM),this._conchMaterial&&this._conchMaterial.setShaderValue(13,e.matrix.elements,0)}),t.load=function(e){return n.loader.create(e,null,null,t)},t._parseStandardMaterial=function(e,t,n){var i=n.customProps,r=i.ambientColor;t.ambientColor=new rt(r[0],r[1],r[2]);var a=i.diffuseColor;t.diffuseColor=new rt(a[0],a[1],a[2]);var s=i.specularColor;t.specularColor=new at(s[0],s[1],s[2],s[3]);var o=i.reflectColor;t.reflectColor=new rt(o[0],o[1],o[2]);var l=i.diffuseTexture.texture2D;l&&(t.diffuseTexture=x.getRes(e[l]));var h=i.normalTexture.texture2D;h&&(t.normalTexture=x.getRes(e[h]));var u=i.specularTexture.texture2D;u&&(t.specularTexture=x.getRes(e[u]));var c=i.emissiveTexture.texture2D;c&&(t.emissiveTexture=x.getRes(e[c]));var _=i.ambientTexture.texture2D;_&&(t.ambientTexture=x.getRes(e[_]));var d=i.reflectTexture.texture2D;d&&(t.reflectTexture=x.getRes(e[d]))},t.RENDERMODE_OPAQUE=1,t.RENDERMODE_OPAQUEDOUBLEFACE=2,t.RENDERMODE_CUTOUT=3,t.RENDERMODE_CUTOUTDOUBLEFACE=4,t.RENDERMODE_TRANSPARENT=13,t.RENDERMODE_TRANSPARENTDOUBLEFACE=14,t.RENDERMODE_ADDTIVE=15,t.RENDERMODE_ADDTIVEDOUBLEFACE=16,t.RENDERMODE_DEPTHREAD_TRANSPARENT=5,t.RENDERMODE_DEPTHREAD_TRANSPARENTDOUBLEFACE=6,t.RENDERMODE_DEPTHREAD_ADDTIVE=7,t.RENDERMODE_DEPTHREAD_ADDTIVEDOUBLEFACE=8,t.RENDERMODE_NONDEPTH_TRANSPARENT=9,t.RENDERMODE_NONDEPTH_TRANSPARENTDOUBLEFACE=10,t.RENDERMODE_NONDEPTH_ADDTIVE=11,t.RENDERMODE_NONDEPTH_ADDTIVEDOUBLEFACE=12,t.SHADERDEFINE_DIFFUSEMAP=0,t.SHADERDEFINE_NORMALMAP=0,t.SHADERDEFINE_SPECULARMAP=0,t.SHADERDEFINE_EMISSIVEMAP=0,t.SHADERDEFINE_AMBIENTMAP=0,t.SHADERDEFINE_REFLECTMAP=0,t.SHADERDEFINE_UVTRANSFORM=0,t.SHADERDEFINE_ALPHATEST=0,t.SHADERDEFINE_SCALEOFFSETLIGHTINGMAPUV=0,t.DIFFUSETEXTURE=0,t.NORMALTEXTURE=1,t.SPECULARTEXTURE=2,t.EMISSIVETEXTURE=3,t.AMBIENTTEXTURE=4,t.REFLECTTEXTURE=5,t.ALBEDO=6,t.ALPHATESTVALUE=7,t.UVANIAGE=8,t.MATERIALAMBIENT=9,t.MATERIALDIFFUSE=10,t.MATERIALSPECULAR=11,t.MATERIALREFLECT=12,t.UVMATRIX=13,t.UVAGE=14,i(t,["defaultMaterial",function(){return this.defaultMaterial=new t}]),t}(Dt),qt=function(e){function t(e,n,i,r){this._indexType=null,this._indexTypeByteCount=0,this._indexCount=0,this._canRead=!1,void 0===i&&(i=35044),void 0===r&&(r=!1),t.__super.call(this),this._indexType=e,this._indexCount=n,this._bufferUsage=i,this._bufferType=34963,this._canRead=r;var a=0;if("ushort"==e)this._indexTypeByteCount=2;else{if("ubyte"!=e)throw new Error("unidentification index type.");this._indexTypeByteCount=1}a=this._indexTypeByteCount*n,this._byteLength=a,D.isConchNode||(this._bind(),_._gl.bufferData(this._bufferType,a,this._bufferUsage)),r?("ushort"==e?this._buffer=new Uint16Array(n):"ubyte"==e&&(this._buffer=new Uint8Array(n)),this.memorySize=2*a):this.memorySize=a}r(t,"laya.d3.graphics.IndexBuffer3D",e);var n=t.prototype;return n.setData=function(e,t,n,i){void 0===t&&(t=0),void 0===n&&(n=0),void 0===i&&(i=4294967295);var r=0;if("ushort"==this._indexType?(r=2,0===n&&4294967295===i||(e=new Uint16Array(e.buffer,n*r,i))):"ubyte"==this._indexType&&(r=1,0===n&&4294967295===i||(e=new Uint8Array(e.buffer,n*r,i))),D.isConchNode||(this._bind(),_._gl.bufferSubData(this._bufferType,t*r,e)),this._canRead)if(0!==t||0!==n||4294967295!==i){var a=this._buffer.length-t;i>a&&(i=a);for(var s=0;s<i;s++)this._buffer[t+s]=e[s]}else this._buffer=e},n.getData=function(){if(this._canRead)return this._buffer;throw new Error("Can't read data from VertexBuffer with only write flag!")},n.dispose=function(){this._buffer=null,e.prototype.dispose.call(this),this.memorySize=0},a(0,n,"indexType",function(){return this._indexType}),a(0,n,"indexTypeByteCount",function(){return this._indexTypeByteCount}),a(0,n,"indexCount",function(){return this._indexCount}),a(0,n,"canRead",function(){return this._canRead}),t.INDEXTYPE_UBYTE="ubyte",t.INDEXTYPE_USHORT="ushort",t.create=function(e,n,i,r){return void 0===i&&(i=35044),void 0===r&&(r=!1),new t(e,n,i,r)},t}(_),Zt=function(e){function t(e,n,i,r){this._vertexDeclaration=null,this._vertexCount=0,this._canRead=!1,void 0===r&&(r=!1),t.__super.call(this),this._vertexDeclaration=e,this._vertexCount=n,this._bufferUsage=i,this._bufferType=34962,this._canRead=r;var a=this._vertexDeclaration.vertexStride*n;this.memorySize=a,this._byteLength=a,D.isConchNode||(this._bind(),_._gl.bufferData(this._bufferType,a,this._bufferUsage)),r&&(this._buffer=new Float32Array(a/4))}r(t,"laya.d3.graphics.VertexBuffer3D",e);var n=t.prototype;return n.bindWithIndexBuffer=function(e){e&&e._bind(),this._bind()},n.setData=function(e,t,n,i){if(void 0===t&&(t=0),void 0===n&&(n=0),void 0===i&&(i=4294967295),0===n&&4294967295===i||(e=new Float32Array(e.buffer,4*n,i)),D.isConchNode||(this._bind(),_._gl.bufferSubData(this._bufferType,4*t,e)),this._canRead)if(0!==t||0!==n||4294967295!==i){var r=this._buffer.length-t;i>r&&(i=r);for(var a=0;a<i;a++)this._buffer[t+a]=e[a]}else this._buffer=e},n.getData=function(){if(this._canRead)return this._buffer;throw new Error("Can't read data from VertexBuffer with only write flag!")},n.detoryResource=function(){for(var t=this._vertexDeclaration.getVertexElements(),n=0;n<t.length;n++)N.mainContext.disableVertexAttribArray(n);e.prototype.detoryResource.call(this)},n.dispose=function(){e.prototype.dispose.call(this),this._buffer=null,this._vertexDeclaration=null,this.memorySize=0},a(0,n,"vertexDeclaration",function(){return this._vertexDeclaration}),a(0,n,"vertexCount",function(){return this._vertexCount}),a(0,n,"canRead",function(){return this._canRead}),t.create=function(e,n,i,r){return void 0===i&&(i=35044),void 0===r&&(r=!1),new t(e,n,i,r)},t}(_),Qt=function(e){function t(){this._renderMode=0,t.__super.call(this),this.setShaderName("PARTICLESHURIKEN"),this._setColor(8,new at(.5,.5,.5,.5)),this.renderMode=8}r(t,"laya.d3.core.particleShuriKen.ShurikenParticleMaterial",e);var s=t.prototype;return s._setMaterialShaderParams=function(e){var n=e.owner,i=n.particleSystem,r=n.particleRender,a=(n.transform,t._tempGravity.elements),s=i.gravity.elements,o=i.gravityModifier;a[0]=s[0]*o,a[1]=s[1]*o,a[2]=s[2]*o,this._setBuffer(3,a),this._setInt(7,i.simulationSpace),this._setBool(0,i.threeDStartRotation),this._setInt(1,i.scaleMode),this._setInt(5,r.stretchedBillboardLengthScale),this._setInt(6,r.stretchedBillboardSpeedScale),this._setNumber(2,i.currentTime)},s.onAsynLoaded=function(n,i,r){var a=i[0];if(a.version)e.prototype.onAsynLoaded.call(this,n,i,r);else{var s=i[1],o=a.props;for(var l in o)this[l]=o[l];t._parseShurikenParticleMaterial(s,this,a),this.event("loaded",this)}},s.cloneTo=function(t){e.prototype.cloneTo.call(this,t),t._renderMode=this._renderMode},a(0,s,"renderMode",function(){return this._renderMode},function(e){switch(this._renderMode=e,e){case 1:this._renderQueue=1,this.depthWrite=!0,this.cull=2,this.blend=0,this.event("renderqueuechanged",this);break;case 2:this._renderQueue=1,this.depthWrite=!0,this.cull=0,this.blend=0,this.event("renderqueuechanged",this);break;case 13:this._renderQueue=2,this.depthWrite=!0,this.cull=2,this.blend=1,this.srcBlend=770,this.dstBlend=771,this.event("renderqueuechanged",this);break;case 14:this._renderQueue=2,this.depthWrite=!0,this.cull=0,this.blend=1,this.srcBlend=770,this.dstBlend=771,this.event("renderqueuechanged",this);break;case 15:this._renderQueue=2,this.depthWrite=!0,this.cull=2,this.blend=1,this.srcBlend=770,this.dstBlend=1,this.event("renderqueuechanged",this);break;case 16:this._renderQueue=2,this.depthWrite=!0,this.cull=0,this.blend=1,this.srcBlend=770,this.dstBlend=1,this.event("renderqueuechanged",this);break;case 5:this._renderQueue=2,this.depthWrite=!1,this.cull=2,this.blend=1,this.srcBlend=770,this.dstBlend=771,this.event("renderqueuechanged",this);break;case 6:this._renderQueue=2,this.depthWrite=!1,this.cull=0,this.blend=1,this.srcBlend=770,this.dstBlend=771,this.event("renderqueuechanged",this);break;case 7:this._renderQueue=2,this.depthWrite=!1,this.cull=2,this.blend=1,this.srcBlend=770,this.dstBlend=1,this.event("renderqueuechanged",this);break;case 8:this._renderQueue=2,this.depthWrite=!1,this.cull=0,this.blend=1,this.srcBlend=770,this.dstBlend=1,this.event("renderqueuechanged",this);break;case 9:this._renderQueue=2,this.depthTest=!1,this.cull=2,this.blend=1,this.srcBlend=770,this.dstBlend=771,this.event("renderqueuechanged",this);break;case 10:this._renderQueue=2,this.depthTest=!1,this.cull=0,this.blend=1,this.srcBlend=770,this.dstBlend=771,this.event("renderqueuechanged",this);break;case 11:this._renderQueue=2,this.depthTest=!1,this.cull=2,this.blend=1,this.srcBlend=770,this.dstBlend=1,this.event("renderqueuechanged",this);break;case 12:this._renderQueue=2,this.depthTest=!1,this.cull=0,this.blend=1,this.srcBlend=770,this.dstBlend=1,this.event("renderqueuechanged",this);break;default:throw new Error("Material:renderMode value error.")}this._conchMaterial&&this._conchMaterial.setRenderMode(e)}),a(0,s,"tintColor",function(){return this._getColor(8)},function(e){this._setColor(8,e)}),a(0,s,"diffuseTexture",function(){return this._getTexture(0)},function(e){e?this._addShaderDefine(laya.d3.core.particleShuriKen.ShurikenParticleMaterial.SHADERDEFINE_DIFFUSEMAP):this._removeShaderDefine(laya.d3.core.particleShuriKen.ShurikenParticleMaterial.SHADERDEFINE_DIFFUSEMAP),this._setTexture(4,e)}),t.load=function(e){return n.loader.create(e,null,null,t)},t._parseShurikenParticleMaterial=function(e,t,n){var i=n.customProps,r=i.diffuseTexture.texture2D;r&&(t.diffuseTexture=x.getRes(e[r]));var a=i.tintColor;a&&(t.tintColor=new at(a[0],a[1],a[2],a[3]))},t.RENDERMODE_OPAQUE=1,t.RENDERMODE_OPAQUEDOUBLEFACE=2,t.RENDERMODE_TRANSPARENT=13,t.RENDERMODE_TRANSPARENTDOUBLEFACE=14,t.RENDERMODE_ADDTIVE=15,t.RENDERMODE_ADDTIVEDOUBLEFACE=16,t.RENDERMODE_DEPTHREAD_TRANSPARENT=5,t.RENDERMODE_DEPTHREAD_TRANSPARENTDOUBLEFACE=6,t.RENDERMODE_DEPTHREAD_ADDTIVE=7,t.RENDERMODE_DEPTHREAD_ADDTIVEDOUBLEFACE=8,t.RENDERMODE_NONDEPTH_TRANSPARENT=9,t.RENDERMODE_NONDEPTH_TRANSPARENTDOUBLEFACE=10,t.RENDERMODE_NONDEPTH_ADDTIVE=11,t.RENDERMODE_NONDEPTH_ADDTIVEDOUBLEFACE=12,t.SHADERDEFINE_DIFFUSEMAP=0,t.SHADERDEFINE_SPHERHBILLBOARD=0,t.SHADERDEFINE_STRETCHEDBILLBOARD=0,t.SHADERDEFINE_HORIZONTALBILLBOARD=0,t.SHADERDEFINE_VERTICALBILLBOARD=0,t.SHADERDEFINE_RANDOMCOLOROVERLIFETIME=0,t.SHADERDEFINE_COLOROVERLIFETIME=0,t.SHADERDEFINE_VELOCITYOVERLIFETIMECONSTANT=0,t.SHADERDEFINE_VELOCITYOVERLIFETIMECURVE=0,t.SHADERDEFINE_VELOCITYOVERLIFETIMERANDOMCONSTANT=0,t.SHADERDEFINE_VELOCITYOVERLIFETIMERANDOMCURVE=0,t.SHADERDEFINE_TEXTURESHEETANIMATIONCURVE=0,t.SHADERDEFINE_TEXTURESHEETANIMATIONRANDOMCURVE=0,t.SHADERDEFINE_ROTATIONOVERLIFETIME=0,t.SHADERDEFINE_ROTATIONOVERLIFETIMESEPERATE=0,t.SHADERDEFINE_ROTATIONOVERLIFETIMECONSTANT=0,t.SHADERDEFINE_ROTATIONOVERLIFETIMECURVE=0,t.SHADERDEFINE_ROTATIONOVERLIFETIMERANDOMCONSTANTS=0,t.SHADERDEFINE_ROTATIONOVERLIFETIMERANDOMCURVES=0,t.SHADERDEFINE_SIZEOVERLIFETIMECURVE=0,t.SHADERDEFINE_SIZEOVERLIFETIMECURVESEPERATE=0,t.SHADERDEFINE_SIZEOVERLIFETIMERANDOMCURVES=0,t.SHADERDEFINE_SIZEOVERLIFETIMERANDOMCURVESSEPERATE=0,t.THREEDSTARTROTATION=0,t.SCALINGMODE=1,t.CURRENTTIME=2,t.GRAVITY=3,t.DIFFUSETEXTURE=4,t.STRETCHEDBILLBOARDLENGTHSCALE=5,t.STRETCHEDBILLBOARDSPEEDSCALE=6,t.SIMULATIONSPACE=7,t.TINTCOLOR=8,t._diffuseTextureIndex=0,i(t,["_tempGravity",function(){return this._tempGravity=new rt},"defaultMaterial",function(){return this.defaultMaterial=new t}]),t}(Dt),Kt=(function(e){function t(){this._tempCurAnimationData=null,this._lastFrameIndex=-1,this._currentTransform=null,this._originalAnimationTransform=null,this._originalFov=0,this._camera=null,this._cacheAnimationDatas=[],this._currentAnimationData=null,this.localMode=!0,this.addMode=!0,this._tempVector30=new rt,this._tempVector31=new rt,this._tempVector32=new rt,t.__super.call(this)}r(t,"laya.d3.component.animation.CameraAnimations",e);var i=t.prototype;i._effect=function(){var e=0;for(e=0;e<3;e++)this._tempVector30.elements[e]=this._currentAnimationData[e],this._tempVector31.elements[e]=this._currentAnimationData[e+3],this._tempVector32.elements[e]=this._currentAnimationData[e+6];this._currentTransform||(this._currentTransform=new Ke),Ke.createLookAt(this._tempVector30,this._tempVector31,this._tempVector32,this._currentTransform),this._currentTransform.invert(this._currentTransform),this.addMode&&Ke.multiply(this._originalAnimationTransform,this._currentTransform,this._currentTransform),this.localMode?this.owner.transform.localMatrix=this._currentTransform:this.owner.transform.worldMatrix=this._currentTransform,this._camera.fieldOfView=this._currentAnimationData[9]},i._load=function(e){var t=this;if(!(e instanceof laya.d3.core.Camera))throw new Error("该Sprite3D并非Camera");this._camera=e,this._player.on("stopped",this,function(){t._player.returnToZeroStopped&&(t.localMode?t._originalAnimationTransform&&(e.transform.localMatrix=t._originalAnimationTransform):t._originalAnimationTransform&&(e.transform.worldMatrix=t._originalAnimationTransform),t._camera.fieldOfView=t._originalFov)})},i._update=function(e){if(this._templet&&this._templet.loaded&&2===this._player.state){var t=this._player.playbackRate*n.timer.scale,i=this._player.isCache&&t>=1?this.currentFrameIndex:-1,r=this.currentAnimationClipIndex;if(i!==-1&&this._lastFrameIndex===i)return void laya.d3.component.Component3D.prototype._update.call(this,e);if(this._player.isCache&&t>=1){var a=this._templet.getAnimationDataWithCache(this._player.cacheFrameRate,this._cacheAnimationDatas,r,i);if(a)return this._currentAnimationData=a,this._lastFrameIndex=i,laya.d3.component.Component3D.prototype._update.call(this,e),void this._effect()}var s=this._templet.getNodes(r),o=s.length;this._player.isCache&&t>=1?this._currentAnimationData=new Float32Array(10*o):(this._tempCurAnimationData||(this._tempCurAnimationData=new Float32Array(10*o)),this._currentAnimationData=this._tempCurAnimationData),this._player.isCache&&t>=1?this._templet.getOriginalData(r,this._currentAnimationData,this._player._fullFrames[r],i,this._player.currentPlayTime):this._templet.getOriginalDataUnfixedRate(r,this._currentAnimationData,this._player.currentPlayTime),this._player.isCache&&t>=1&&this._templet.setAnimationDataWithCache(this._player.cacheFrameRate,this._cacheAnimationDatas,r,i,this._currentAnimationData),this._lastFrameIndex=i,laya.d3.component.Component3D.prototype._update.call(this,e),this._effect()}},t}(At),function(e){function t(){
this._animationSprites=null,this._animationSpritesInitLocalMatrix=null,this._tempCurAnimationData=null,this._curOriginalData=null,this._lastFrameIndex=-1,this._curAnimationDatas=null,t.__super.call(this),this._animationSprites=[],this._animationSpritesInitLocalMatrix=[]}r(t,"laya.d3.component.animation.RigidAnimations",e);var i=t.prototype;i._init=function(){for(var e=this._templet.getNodes(this.currentAnimationClipIndex),t=this._owner,n=e.length,i=0,r=new Uint16Array(this._templet.getPublicExtData()),a=0;a<n;a++){var s=r.slice(i+1,i+1+r[i]);i+=r[i]+1;for(var o=1;o<s.length;o++){s[o];t=t._childs[s[o]]}var l=t.getChildByName(e[a].name);if(!l)break;this._animationSprites[a]=l;var h=this._animationSpritesInitLocalMatrix[a];h||(h=this._animationSpritesInitLocalMatrix[a]=new Ke),l.transform.localMatrix.cloneTo(h),t=this._owner}},i._animtionPlay=function(){this._templet.loaded?this._init():this._templet.once("loaded",this,this._init)},i._animtionStop=function(){if(this._lastFrameIndex=-1,this._player.returnToZeroStopped){this._curAnimationDatas=null;for(var e=0;e<this._animationSprites.length;e++)this._animationSprites[e].transform.localMatrix=this._animationSpritesInitLocalMatrix[e]}},i._effectAnimation=function(e){for(var t=0,n=this._animationSprites.length;t<n;t++){for(var i=this._animationSprites[t],r=i.transform.localMatrix,a=r.elements,s=0;s<16;s++)a[s]=this._curAnimationDatas[16*t+s];i.transform.localMatrix=r}},i._load=function(t){e.prototype._load.call(this,t),this._player.on("stopped",this,this._animtionStop),this._player.on("played",this,this._animtionPlay)},i._update=function(e){if(2===this._player.state&&this._templet&&this._templet.loaded){var t=this._player.playbackRate*n.timer.scale,i=this._player.cachePlayRate,r=this._player.isCache&&t>=i,a=r?this.currentFrameIndex:-1;if(a===-1||this._lastFrameIndex!==a){var s=this.currentAnimationClipIndex,o=this._templet.getNodes(s),l=this._templet._animationDatasCache;if(r){var h=this._templet.getAnimationDataWithCache(i,l,s,a);if(h)return this._curAnimationDatas=h,this._lastFrameIndex=a,void this._effectAnimation(o)}var u=16*o.length;r?this._curAnimationDatas=new Float32Array(u):(this._tempCurAnimationData||(this._tempCurAnimationData=new Float32Array(u)),this._curAnimationDatas=this._tempCurAnimationData),this._curOriginalData||(this._curOriginalData=new Float32Array(this._templet.getTotalkeyframesLength(s))),r?this._templet.getOriginalData(s,this._curOriginalData,this._player._fullFrames[s],a,this._player.currentFrameTime):this._templet.getOriginalDataUnfixedRate(s,this._curOriginalData,this._player.currentPlayTime),dt._computeRootAnimationData(o,this._curOriginalData,this._curAnimationDatas),r&&this._templet.setAnimationDataWithCache(i,l,s,a,this._curAnimationDatas),this._lastFrameIndex=a,this._effectAnimation(o)}}},i._unload=function(t){e.prototype._unload.call(this,t),this._animationSprites=null,this._animationSpritesInitLocalMatrix=null,this._tempCurAnimationData=null,this._curOriginalData=null,this._curAnimationDatas=null},a(0,i,"url",null,function(e){console.log("Warning: discard property,please use templet property instead.");var t=n.loader.create(e,null,null,l);this._templet!==t&&(0!==this._player.state&&this._player.stop(!0),this._templet=t,this._player.templet=t,this._curOriginalData=null,this._curAnimationDatas=null,this._tempCurAnimationData=null,this._templet._animationDatasCache||(this._templet._animationDatasCache=[]),this.event("animationchanged",this))}),a(0,i,"templet",e.prototype._$get_templet,function(e){this._templet!==e&&(0!==this._player.state&&this._player.stop(!0),this._templet=e,this._player.templet=e,this._curOriginalData=null,this._curAnimationDatas=null,this._tempCurAnimationData=null,this._templet._animationDatasCache||(this._templet._animationDatasCache=[]),this.event("animationchanged",this))}),t}(At),function(e){function t(){this._tempCurAnimationData=null,this._tempCurBonesData=null,this._curOriginalData=null,this._extenData=null,this._lastFrameIndex=-1,this._curMeshAnimationData=null,this._curBonesDatas=null,this._curAnimationDatas=null,this._ownerMesh=null,t.__super.call(this)}r(t,"laya.d3.component.animation.SkinAnimations",e);var i=t.prototype;return i._getAnimationDatasWithCache=function(e,t,n,i,r){var a=n[i];if(a){var s=a[e];if(s){var o=s[t.id];return o?o[r]:null}return null}return null},i._setAnimationDatasWithCache=function(e,t,n,i,r,a){var s=n[i]||(n[i]={}),o=s[e]||(s[e]={});(o[t.id]||(o[t.id]=[]))[r]=a},i._onMeshLoaded=function(){this.destroyed||this._onAnimationPlayMeshLoaded},i._onAnimationPlayMeshLoaded=function(){for(var e=this._ownerMesh.meshRender.renderObject._renderElements,t=0,n=e.length;t<n;t++)e[t]._canDynamicBatch=!1},i._onAnimationPlay=function(){var e=this._ownerMesh.meshFilter.sharedMesh;e.loaded?this._onAnimationPlayMeshLoaded():e.on("loaded",this,this._onMeshLoaded)},i._onAnimationStop=function(){this._lastFrameIndex=-1,this._player.returnToZeroStopped&&(this._curBonesDatas=null,this._curAnimationDatas=null);for(var e=this._ownerMesh.meshRender.renderObject._renderElements,t=0,n=e.length;t<n;t++)e[t]._canDynamicBatch=!0},i._load=function(t){e.prototype._load.call(this,t),this._ownerMesh=t,this._player.on("played",this,this._onAnimationPlay),this._player.on("stopped",this,this._onAnimationStop),this._ownerMesh._addShaderDefine(laya.d3.component.animation.SkinAnimations.SHADERDEFINE_BONE)},i.preComputeKeyFrames=function(e){if(!this._templet.loaded||!this._ownerMesh.meshFilter.sharedMesh.loaded)throw new Error("SkinAnimations: must to be sure animation templet and mesh templet has loaded.");for(var n=this._player.cachePlayRate,i=this._player.cacheFrameRateInterval*n,r=Math.floor(this._templet.getAniDuration(e)/i),a=0;a<=r;a++){var s=this._templet._animationDatasCache[0],o=this._templet._animationDatasCache[1],l=this._ownerMesh.meshFilter.sharedMesh;if(!this._getAnimationDatasWithCache(n,l,o,e,a)){var h=this._templet.getNodes(e),u=16*h.length;this._curMeshAnimationData||(this._curMeshAnimationData=new Float32Array(u));var c=0,_=0;for(this._curAnimationDatas=[],c=0,_=l.getSubMeshCount();c<_;c++)this._curAnimationDatas[c]=new Float32Array(16*l.getSubMesh(c)._boneIndices.length);this._curBonesDatas=new Float32Array(u),this._curOriginalData||(this._curOriginalData=new Float32Array(this._templet.getTotalkeyframesLength(e))),this._templet.getOriginalData(e,this._curOriginalData,this._player._fullFrames[e],a,i*a);var d=l.InverseAbsoluteBindPoses;for(d?dt._computeBoneAndAnimationDatasByBindPoseMatrxix(h,this._curOriginalData,d,this._curBonesDatas,this._curMeshAnimationData):(this._extenData||(this._extenData=new Float32Array(this._templet.getPublicExtData())),dt._computeBoneAndAnimationDatas(h,this._curOriginalData,this._extenData,this._curBonesDatas,this._curMeshAnimationData)),c=0,_=l.getSubMeshCount();c<_;c++){var m=l.getSubMesh(c);t._computeSubMeshAniDatas(c,m._boneIndices,this._curMeshAnimationData,this._curAnimationDatas)}this._setAnimationDatasWithCache(n,l,o,e,a,this._curAnimationDatas),this._templet.setAnimationDataWithCache(n,s,e,a,this._curBonesDatas)}}},i._update=function(e){var i=this._ownerMesh.meshFilter.sharedMesh;if(2===this._player.state&&this._templet&&this._templet.loaded&&i.loaded){var r=this._player.playbackRate*n.timer.scale,a=this._player.cachePlayRate,s=this._player.isCache&&r>=a,o=s?this.currentFrameIndex:-1;if(o===-1||this._lastFrameIndex!==o){var l=this.currentAnimationClipIndex,h=this._templet._animationDatasCache[0],u=this._templet._animationDatasCache[1];if(s){var c=this._getAnimationDatasWithCache(a,i,u,l,o);if(c)return this._curAnimationDatas=c,this._curBonesDatas=this._templet.getAnimationDataWithCache(a,h,l,o),void(this._lastFrameIndex=o)}var _=!1;s&&(this._curBonesDatas=this._templet.getAnimationDataWithCache(a,h,l,o),_=!!this._curBonesDatas);var d=this._templet.getNodes(l),m=16*d.length;this._curMeshAnimationData||(this._curMeshAnimationData=new Float32Array(m));var f=0,p=0;if(s){for(this._curAnimationDatas=[],f=0,p=i.getSubMeshCount();f<p;f++)this._curAnimationDatas[f]=new Float32Array(16*i.getSubMesh(f)._boneIndices.length);_||(this._curBonesDatas=new Float32Array(m))}else{if(!this._tempCurAnimationData)for(this._tempCurAnimationData=[],f=0,p=i.getSubMeshCount();f<p;f++)this._tempCurAnimationData[f]=new Float32Array(16*i.getSubMesh(f)._boneIndices.length);this._tempCurBonesData||(this._tempCurBonesData=new Float32Array(m)),this._curAnimationDatas=this._tempCurAnimationData,this._curBonesDatas=this._tempCurBonesData}this._curOriginalData||(this._curOriginalData=new Float32Array(this._templet.getTotalkeyframesLength(l))),s?this._templet.getOriginalData(l,this._curOriginalData,this._player._fullFrames[l],o,this._player.currentFrameTime):this._templet.getOriginalDataUnfixedRate(l,this._curOriginalData,this._player.currentPlayTime);var v=i.InverseAbsoluteBindPoses;for(v?s&&_?dt._computeAnimationDatasByArrayAndMatrixFast(v,this._curBonesDatas,this._curMeshAnimationData):dt._computeBoneAndAnimationDatasByBindPoseMatrxix(d,this._curOriginalData,v,this._curBonesDatas,this._curMeshAnimationData):(this._extenData||(this._extenData=new Float32Array(this._templet.getPublicExtData())),s&&_?dt._computeAnimationDatas(this._extenData,this._curBonesDatas,this._curMeshAnimationData):dt._computeBoneAndAnimationDatas(d,this._curOriginalData,this._extenData,this._curBonesDatas,this._curMeshAnimationData)),f=0,p=i.getSubMeshCount();f<p;f++){var g=i.getSubMesh(f);t._computeSubMeshAniDatas(f,g._boneIndices,this._curMeshAnimationData,this._curAnimationDatas)}if(s&&(this._setAnimationDatasWithCache(a,i,u,l,o,this._curAnimationDatas),_||this._templet.setAnimationDataWithCache(a,h,l,o,this._curBonesDatas)),this._lastFrameIndex=o,D.isConchNode)for(f=0,p=i.getSubMeshCount();f<p;f++)this._ownerMesh.meshRender.sharedMaterials[f]._addShaderDefine(laya.d3.component.animation.SkinAnimations.SHADERDEFINE_BONE),this._ownerMesh.meshRender.renderObject._renderElements[f]._conchSubmesh.setShaderValue(0,this._curAnimationDatas[f],0)}}},i._preRenderUpdate=function(e){if(this._curAnimationDatas){var t=e.renderElement,n=t.renderObj.indexOfHost;t._shaderValue.setValue(0,this._curAnimationDatas[n])}},i._unload=function(t){e.prototype._unload.call(this,t),this._tempCurAnimationData=null,this._tempCurBonesData=null,this._curOriginalData=null,this._extenData=null,this._curMeshAnimationData=null,this._curBonesDatas=null,this._curAnimationDatas=null,this._ownerMesh=null,this._owner._removeShaderDefine(laya.d3.component.animation.SkinAnimations.SHADERDEFINE_BONE)},a(0,i,"curBonesDatas",function(){return this._curBonesDatas}),a(0,i,"curAnimationDatas",function(){return this._curAnimationDatas}),a(0,i,"url",null,function(e){console.log("Warning: discard property,please use templet property instead.");var t=n.loader.create(e,null,null,l);this._templet!==t&&(0!==this._player.state&&this._player.stop(!0),this._templet=t,this._player.templet=t,this._curOriginalData=this._extenData=null,this._curMeshAnimationData=null,this._tempCurBonesData=null,this._tempCurAnimationData=null,this._templet._animationDatasCache||(this._templet._animationDatasCache=[[],[]]),this.event("animationchanged",this))}),a(0,i,"templet",e.prototype._$get_templet,function(e){this._templet!==e&&(0!==this._player.state&&this._player.stop(!0),this._templet=e,this._player.templet=e,this._curOriginalData=this._extenData=null,this._curMeshAnimationData=null,this._tempCurBonesData=null,this._tempCurAnimationData=null,this._templet._animationDatasCache||(this._templet._animationDatasCache=[[],[]]),this.event("animationchanged",this))}),t._computeSubMeshAniDatas=function(e,t,n,i){for(var r=i[e],a=0,s=t.length,o=0;a<s;a++)for(var l=0;l<16;l++,o++)r[o]=n[(t[a]<<4)+l]},t._copyBone=function(e,t,n){for(var i=0,r=e.length,a=0;i<r;i++)for(var s=0;s<16;s++,a++)n[a]=t[(e[i]<<4)+s]},t.BONES=0,t.SHADERDEFINE_BONE=256,t}(At)),$t=(function(e){function t(){this._nodes=null,this._lasstInitIndex=-1,this._materials=null,this._mesh=null,this._meshDataInited=!1,this._uvDatasCount=0,this._subMeshIndexToNodeIndex=[],this._keyframeAges=[],this._ages=[],this._bufferUsages=[],this._originalShaderAttributes=[],this._uvShaderValues=[],this._uvNextShaderValues=[],this._uvAnimationBuffers=[],t.__super.call(this),this._meshDataInited=!1}r(t,"laya.d3.component.animation.UVAnimations",e);var n=t.prototype;n._initMeshData=function(){this._materials=this._mesh.meshRender.sharedMaterials,this._meshDataInited=!0},n._initAnimationData=function(e){},n._load=function(e){if(!(e instanceof laya.d3.core.MeshSprite3D))throw new Error("该Sprite3D并非Mesh");this._mesh=e,e.on("loaded",this,function(e){}),this.on("loaded",this,function(){}),this.player.on("played",this,function(){}),this.player.on("stopped",this,function(){})},n._update=function(e){if(this.player.update(e.elapsedTime),this._templet&&this._templet.loaded&&2===this.player.state){for(var t=this.currentAnimationClipIndex,n=this._templet.getNodesCurrentFrameIndex(t,this.player.currentPlayTime),i=0;i<this._nodes.length;i++){var r=n[i];this._keyframeAges[i]=(this.player.currentPlayTime-this._nodes[i].keyFrame[r].startTime)/this._nodes[i].keyFrame[r].duration,this._ages[i]=this.player.currentPlayTime/this._nodes[i].playTime;var a=this._nodes[i].keyframeWidth/this._uvDatasCount;this._uvShaderValues[i]||(this._uvShaderValues[i]=[]),this._uvNextShaderValues[i]||(this._uvNextShaderValues[i]=[]);for(var s=0;s<this._uvDatasCount;s++){var o=[2,5126,!1,0,r*a*4],l=[2,5126,!1,0,(r+1)*a*4];this._uvShaderValues[i][s]=o,this._uvNextShaderValues[i][s]=l}}laya.d3.component.Component3D.prototype._update.call(this,e)}},n._preRenderUpdate=function(e){},t}(At),function(e){function t(){this._size=null,this._transformOrientedBoundBox=null,this.center=null,t.__super.call(this),this._needUpdate=!1}r(t,"laya.d3.component.physics.BoxCollider",e);var n=t.prototype;n._updateCollider=function(){if(this._needUpdate){var e=this._owner.transform;e.worldMatrix.cloneTo(this._transformOrientedBoundBox.transformation),rt.multiply(e.scale,this.center,t._deviationV3),rt.transformQuat(t._deviationV3,e.rotation,t._deviationV3),this._transformOrientedBoundBox.getCenter(t._obbCenterV3),rt.add(t._obbCenterV3,t._deviationV3,t._deviationV3),this._transformOrientedBoundBox.transformation.setTranslationVector(t._deviationV3),this._needUpdate=!1}},n._onGeometryFilterLoaded=function(){this.destroyed||this._initBoundBox()},n._onWorldMatrixChanged=function(){this._needUpdate=!0},n._initBoundBox=function(){var e=this.owner._geometryFilter._originalBoundingBox;$e.createByBoundBox(e,this._transformOrientedBoundBox);var t=this._transformOrientedBoundBox.extents;this._size=new rt(2*t.x,2*t.y,2*t.z),this.center=new rt,rt.add(e.min,e.max,this.center),rt.scale(this.center,.5,this.center),this.owner.transform.on("worldmatrixneedchanged",this,this._onWorldMatrixChanged),this._needUpdate=!0},n._initialize=function(e){if(laya.d3.component.Component3D.prototype._initialize.call(this,e),this._owner instanceof laya.d3.core.RenderableSprite3D){var t=e;this._transformOrientedBoundBox=new $e(new rt,new Ke),t._geometryFilter._isAsyncLoaded?this._initBoundBox():t._geometryFilter.once("loaded",this,this._onGeometryFilterLoaded)}else this._transformOrientedBoundBox=new $e(new rt,new Ke),this._size=new rt,this.center=new rt,e.transform.on("worldmatrixneedchanged",this,this._onWorldMatrixChanged),this._needUpdate=!0},n.raycast=function(e,t,n){void 0===n&&(n=Number.MAX_VALUE),this._updateCollider();var i=this._transformOrientedBoundBox.intersectsRay(e,t.position);return i!==-1&&i<=n?(t.distance=i,t.sprite3D=this._owner,!0):(t.distance=-1,t.sprite3D=null,!1)},a(0,n,"boundBox",function(){return this._updateCollider(),this._transformOrientedBoundBox}),a(0,n,"size",function(){return this._size},function(e){this._size=e,rt.scale(e,.5,this._transformOrientedBoundBox.extents)}),i(t,["_deviationV3",function(){return this._deviationV3=new rt},"_obbCenterV3",function(){return this._obbCenterV3=new rt}]),t}(It),function(e){function t(){this._transformBoundSphere=null,this._mesh=null,t.__super.call(this),this._transformBoundSphere=new Xe(new rt(0,0,0),0)}r(t,"laya.d3.component.physics.MeshCollider",e);var n=t.prototype;n._raycastMesh=function(e,n,i,r){void 0===r&&(r=Number.MAX_VALUE);var a=n.transform.worldMatrix,s=t._tempMatrix4x40;a.invert(s);var o=e.origin,l=e.direction,h=t._tempRay0;rt.transformCoordinate(o,s,h.origin),rt.TransformNormal(l,s,h.direction);for(var u=Number.MAX_VALUE,c=0,_=this._mesh.getRenderElementsCount();c<_;c++){var d=this._mesh.getRenderElement(c),m=d._getVertexBuffer(0),f=m.getData(),p=d._getIndexBuffer().getData(),v=t._tempRaycastHit;if(ut.rayIntersectsPositionsAndIndices(h,f,m.vertexDeclaration,p,v)){rt.transformCoordinate(v.position,a,v.position);var g=t._tempVector30;rt.subtract(o,v.position,g);var x=rt.scalarLength(g);if(x<r&&x<u){v.distance=x,v.sprite3D=n;var E=v.trianglePositions;rt.transformCoordinate(E[0],a,E[0]),rt.transformCoordinate(E[1],a,E[1]),rt.transformCoordinate(E[2],a,E[2]);var M=v.triangleNormals;return rt.transformCoordinate(M[0],a,M[0]),rt.transformCoordinate(M[1],a,M[1]),rt.transformCoordinate(M[2],a,M[2]),u=x,v.cloneTo(i),!0}return!1}}return!1},n._initialize=function(e){if(laya.d3.component.Component3D.prototype._initialize.call(this,e),this._owner instanceof laya.d3.core.MeshSprite3D){var t=e;this._mesh=t.meshFilter.sharedMesh}},n.raycast=function(e,t,n){if(void 0===n&&(n=Number.MAX_VALUE),null==this._mesh||!this._mesh.loaded)return!1;var i=NaN,r=this._owner.transform,a=r.scale;i=a.x>=a.y&&a.x>=a.z?a.x:a.y>=a.z?a.y:a.z;var s=this._mesh.boundingSphere;rt.transformCoordinate(s.center,r.worldMatrix,this._transformBoundSphere.center),this._transformBoundSphere.radius=s.radius*i;var o=this._transformBoundSphere.intersectsRayPoint(e,t.position);return!!(o!==-1&&o<=n&&this._raycastMesh(e,this._owner,t,n))||(t.distance=-1,t.sprite3D=null,!1)},a(0,n,"mesh",function(){return this._mesh},function(e){this._mesh=e}),i(t,["_tempRay0",function(){return this._tempRay0=new nt(new rt,new rt)},"_tempVector30",function(){return this._tempVector30=new rt},"_tempMatrix4x40",function(){return this._tempMatrix4x40=new Ke},"_tempRaycastHit",function(){return this._tempRaycastHit=new ct}]),t}(It),function(e){function t(){this._originalBoundSphere=null,this._transformBoundSphere=null,t.__super.call(this),this._needUpdate=!1}r(t,"laya.d3.component.physics.SphereCollider",e);var n=t.prototype;n._updateCollider=function(){if(this._needUpdate){var e=NaN,t=this._owner.transform,n=t.scale;e=n.x>=n.y&&n.x>=n.z?n.x:n.y>=n.z?n.y:n.z,rt.transformCoordinate(this._originalBoundSphere.center,t.worldMatrix,this._transformBoundSphere.center),this._transformBoundSphere.radius=this._originalBoundSphere.radius*e,this._needUpdate=!1}},n._onGeometryFilterLoaded=function(){this.destroyed||this._initBoundSphere()},n._onWorldMatrixChanged=function(){this._needUpdate=!0},n._initBoundSphere=function(){this.owner._geometryFilter._originalBoundingSphere.cloneTo(this._originalBoundSphere),this.owner.transform.on("worldmatrixneedchanged",this,this._onWorldMatrixChanged),this._needUpdate=!0},n._initialize=function(e){if(laya.d3.component.Component3D.prototype._initialize.call(this,e),e instanceof laya.d3.core.RenderableSprite3D){var t=e;this._originalBoundSphere=new Xe(new rt(0,0,0),0),this._transformBoundSphere=new Xe(new rt(0,0,0),0),t._geometryFilter._isAsyncLoaded?this._initBoundSphere():t._geometryFilter.once("loaded",this,this._onGeometryFilterLoaded)}else this._originalBoundSphere=new Xe(new rt(0,0,0),.5),this._transformBoundSphere=new Xe(new rt(0,0,0),.5),e.transform.on("worldmatrixneedchanged",this,this._onWorldMatrixChanged),this._needUpdate=!0},n.raycast=function(e,t,n){void 0===n&&(n=Number.MAX_VALUE),this._updateCollider();var i=this._transformBoundSphere.intersectsRayPoint(e,t.position);return i!==-1&&i<=n?(t.distance=i,t.sprite3D=this._owner,!0):(t.distance=-1,t.sprite3D=null,!1)},a(0,n,"center",function(){return this._originalBoundSphere.center},function(e){this._originalBoundSphere.center=e}),a(0,n,"radius",function(){return this._originalBoundSphere.radius},function(e){this._originalBoundSphere.radius=e}),a(0,n,"boundSphere",function(){return this._updateCollider(),this._transformBoundSphere}),t}(It),function(e){function t(){this.simLodInfo=null,this._src=null,this._buffer=null,this._mipmaps=null,this._recreateLock=!1,this._needReleaseAgain=!1,t.__super.call(this)}r(t,"laya.d3.resource.DataTexture2D",e);var s=t.prototype;return s.genDebugMipmaps=function(){var e=[];return e.push(new Uint8Array(new Uint32Array(131072).fill(4278190335).buffer)),e.push(new Uint8Array(new Uint32Array(32768).fill(4278223103).buffer)),e.push(new Uint8Array(new Uint32Array(8192).fill(4278255615).buffer)),e.push(new Uint8Array(new Uint32Array(2048).fill(4278255360).buffer)),e.push(new Uint8Array(new Uint32Array(512).fill(4286595072).buffer)),e.push(new Uint8Array(new Uint32Array(128).fill(4294901760).buffer)),e.push(new Uint8Array(new Uint32Array(32).fill(4294901888).buffer)),e.push(new Uint8Array(new Uint32Array(8).fill(0).buffer)),e.push(new Uint8Array(new Uint32Array(2).fill(4286611584).buffer)),e.push(new Uint8Array(new Uint32Array(1).fill(4294967295).buffer)),e},s._onTextureLoaded=function(e){},s._createWebGlTexture=function(){if(!this._buffer&&!this._mipmaps)throw"create GLTextur err:no data";var e=N.mainContext;e.getExtension("EXT_shader_texture_lod");var n=this._source=e.createTexture(),i=this._width,r=this._height,a=P.curBindTexTarget,s=P.curBindTexValue;if(P.bindTexture(e,3553,n),this._mipmaps){if(laya.d3.resource.DataTexture2D.lodasatlas){var o=0;e.texImage2D(3553,0,6408,this._width,this._height,0,6408,5121,null);for(var l=0;l<this._mipmaps.length;l++){if(this._mipmaps[l].byteLength!=u*c*4)throw"mipmap size error  level:"+l;e.texSubImage2D(3553,0,t.simLodRect[o++],t.simLodRect[o++],t.simLodRect[o++],t.simLodRect[o++],6408,5121,new Uint8Array(this._mipmaps[l]))}this.minFifter=9729,this.magFifter=9729}else{var u=this._width,c=this._height;for(o=0,e.texImage2D(3553,0,6408,this._width,this._height,0,6408,5121,null),l=0;l<this._mipmaps.length;l++){if(this._mipmaps[l].byteLength!=u*c*4)throw"mipmap size error  level:"+l;e.texImage2D(3553,l,6408,u,c,0,6408,5121,new Uint8Array(this._mipmaps[l])),u/=2,c/=2,u<1&&(u=1),c<1&&(c=1),this.minFifter=9987,this.magFifter=9987}}this.mipmap=!1}else e.texImage2D(3553,0,6408,i,r,0,6408,5121,new Uint8Array(this._buffer));var _=this._minFifter,d=this._magFifter,m=this._repeat?10497:33071,f=h.isPOT(i,r);if(!f)throw"data texture must be POT";this._mipmap||this._mipmaps?_!==-1||(_=9987):_!==-1||(_=9729),d!==-1||(d=9729),e.texParameteri(3553,10241,_),e.texParameteri(3553,10240,d),e.texParameteri(3553,10242,m),this._mipmaps?e.texParameteri(3553,10243,33071):e.texParameteri(3553,10243,m),this._mipmap&&e.generateMipmap(3553),a&&s&&P.bindTexture(e,a,s),this.src&&this.src.length>0&&(this._buffer=null),this.memorySize=f?i*r*4*(1+1/3):i*r*4,this._recreateLock=!1},s.recreateResource=function(){if(this._buffer||null!=this._src&&""!==this._src)if(this._needReleaseAgain=!1,this._buffer||this._mipmaps){if(this._recreateLock)return;this.startCreate(),this._createWebGlTexture(),this.completeCreate()}else{this._recreateLock=!0,this.startCreate()}},s.onAsynLoaded=function(e,t,n){var i;n&&(i=n[0].call(this,t)),i&&(this._width=i.width,this._height=i.height,this._buffer=i.data),this._src=e,this._size=new _t(this._width,this._height),this._conchTexture?alert("怎么给runtime传递datatexture数据"):this.activeResource(),this._loaded=!0,this.event("loaded",this)},s.getPixels=function(){return new Uint8Array(this._buffer)},s.detoryResource=function(){this._recreateLock&&(this._needReleaseAgain=!0),this._source&&(N.mainContext.deleteTexture(this._source),this._source=null,this._buffer=null,this.memorySize=0)},a(0,s,"src",function(){return this._src}),t.create=function(e,n,i,r,a,s){if(void 0===r&&(r=9729),void 0===a&&(a=9729),void 0===s&&(s=!0),!e||e.byteLength<n*i*4)throw"DataTexture2D create error";var o=new t;return o._buffer=e,o._width=n,o._height=i,o._mipmap=s,o._magFifter=r,o._minFifter=a,o._size=new _t(o._width,o._height),o._conchTexture?alert("怎么给runtime传递datatexture数据"):o.activeResource(),o._loaded=!0,o},t.load=function(e,i,r,a,s){if(void 0===i&&(i=0),void 0===r&&(r=0),void 0===a&&(a=9729),void 0===s&&(s=9729),"mipmaps"===O.getFileExtension(e)){var o=n.loader.create(e,null,null,t,[function(e){this._mipmaps=[];var t=new Uint32Array(e);this._width=t[0];var n=512;if(laya.d3.resource.DataTexture2D.lodasatlas&&(this._width*=2,n=1024),this._width!=n)throw console.error("现在只支持512x256的环境贴图。当前的是"+t[0]),"现在只支持512x256的环境贴图。当前的是"+t[0];this._height=t[1];for(var i=laya.d3.resource.DataTexture2D.lodasatlas?this._width/2:this._width,r=this._height,a=8;;){var s=i*r*4;if(a+s>e.byteLength)throw"load mipmaps data size error ";var o=new Uint8Array(e,a,s);if(this._mipmaps.push(o),a+=s,1==i&&1==r)break;i/=2,r/=2,i<1&&(i=1),r<1&&(r=1)}return null}]);if(laya.d3.resource.DataTexture2D.lodasatlas){o.simLodInfo=new Float32Array(40);for(var l=0;l<o.simLodInfo.length;)o.simLodInfo[l]=(t.simLodRect[l]+.5)/1024,l++,o.simLodInfo[l]=(t.simLodRect[l]+.5)/256,l++,o.simLodInfo[l]=Math.max(t.simLodRect[l]-1,.1)/1024,l++,o.simLodInfo[l]=Math.max(t.simLodRect[l]-1.5,.1)/256,l++}return o}if("number"==typeof i)return n.loader.create(e,null,null,t,[function(e){return this._width=i,this._height=r,this._buffer=e,null}]);if("function"==typeof i)return n.loader.create(e,null,null,t,[i]);throw new Error("unknown params.")},t.lodasatlas=!1,i(t,["simLodRect",function(){return this.simLodRect=new Uint32Array([0,0,512,256,512,0,256,128,768,0,128,64,896,0,64,32,960,0,32,16,992,0,16,8,1008,0,8,4,1016,0,4,2,1020,0,2,1,1022,0,1,1])}]),t}(Rt)),Jt=function(e){function t(){this._numberVertices=0,this._numberIndices=0,this._vertexBuffer=null,this._indexBuffer=null,this._indexOfHost=0,t.__super.call(this),this._indexOfHost=0}r(t,"laya.d3.resource.models.PrimitiveMesh",e);var i=t.prototype;return n.imps(i,{"laya.d3.core.render.IRenderable":!0}),i._getVertexBuffer=function(e){return void 0===e&&(e=0),0===e?this._vertexBuffer:null},i._getIndexBuffer=function(){return this._indexBuffer},i.getRenderElement=function(e){return this},i.getRenderElementsCount=function(){return 1},i.detoryResource=function(){this._vertexBuffer&&(this._vertexBuffer.dispose(),this._vertexBuffer=null),this._indexBuffer&&(this._indexBuffer.dispose(),this._indexBuffer=null),this.memorySize=0},i._beforeRender=function(e){return this._vertexBuffer._bind(),this._indexBuffer._bind(),!0},i._render=function(e){e.context.drawElements(4,this._numberIndices,5123,0),I.drawCall++,I.trianglesFaces+=this._numberIndices/3},i._renderRuntime=function(e,t,n){e.drawSubmesh(t._conchSubmesh,0,4,0,this._numberIndices)},a(0,i,"indexOfHost",function(){return this._indexOfHost}),a(0,i,"_vertexBufferCount",function(){return 1}),a(0,i,"triangleCount",function(){return this._indexBuffer.indexCount/3}),a(0,i,"positions",function(){var e,t=[],n=this._vertexBuffer.vertexDeclaration.getVertexElements(),i=0;for(i=0;i<n.length;i++){var r=n[i];if("vector3"===r.elementFormat&&0===r.elementUsage){e=r;break}}var a=this._vertexBuffer.getData();for(i=0;i<a.length;i+=this._vertexBuffer.vertexDeclaration.vertexStride/4){var s=i+e.offset/4,o=new rt(a[s+0],a[s+1],a[s+2]);t.push(o)}return t}),t}(Ct),en=function(e){function t(){this._materials=null,this._subMeshes=null,this._bindPoses=null,this._inverseBindPoses=null,t.__super.call(this),this._subMeshes=[],this._materials=[],this._loaded?this._generateBoundingObject():this.once("loaded",this,this._generateBoundingObject)}r(t,"laya.d3.resource.models.Mesh",e);var i=t.prototype;return i._add=function(e){e._indexInMesh=this._subMeshes.length,this._subMeshes.push(e),this._subMeshCount++},i._remove=function(e){var t=this._subMeshes.indexOf(e);return!(t<0)&&(this._subMeshes.splice(t,1),this._subMeshCount--,!0)},i.onAsynLoaded=function(e,t,n){var i=t[0],r=t[1];je.read(i,this,this._materials,r),this._loaded=!0,this.event("loaded",this)},i.getSubMesh=function(e){return this._subMeshes[e]},i.getSubMeshCount=function(){return this._subMeshes.length},i.getRenderElementsCount=function(){return this._subMeshes.length},i.getRenderElement=function(e){return this._subMeshes[e]},i.dispose=function(){this._resourceManager.removeResource(this),laya.resource.Resource.prototype.dispose.call(this);for(var e=0;e<this._subMeshes.length;e++)this._subMeshes[e].dispose();this._subMeshes=null,this._subMeshCount=0},a(0,i,"positions",function(){for(var e=[],t=this._subMeshes.length,n=0;n<t;n++){var i,r=this._subMeshes[n],a=r._getVertexBuffer(),s=a.vertexDeclaration.getVertexElements(),o=0;for(o=0;o<s.length;o++){var l=s[o];if("vector3"===l.elementFormat&&0===l.elementUsage){i=l;break}}var h=a.getData();for(o=0;o<h.length;o+=a.vertexDeclaration.vertexStride/4){var u=o+i.offset/4,c=new rt(h[u+0],h[u+1],h[u+2]);e.push(c)}}return e}),a(0,i,"materials",function(){return this._materials.slice()}),a(0,i,"bindPoses",function(){return this._bindPoses}),a(0,i,"InverseAbsoluteBindPoses",function(){return this._inverseBindPoses}),t.load=function(e){return n.loader.create(e,null,null,t)},t}(Ct),tn=function(e){function t(e,n,i,r,a,s,o,l,h){this._alreadyResolved=!1,this._surfaceFormat=0,this._surfaceType=0,this._depthStencilFormat=0,this._frameBuffer=null,this._depthStencilBuffer=null,void 0===i&&(i=6408),void 0===r&&(r=5121),void 0===a&&(a=33189),void 0===s&&(s=!1),void 0===o&&(o=!1),void 0===l&&(l=-1),void 0===h&&(h=-1),t.__super.call(this),this._width=e,this._height=n,this._size=new _t(e,n),this._surfaceFormat=i,this._surfaceType=r,this._depthStencilFormat=a,this._mipmap=s,this._repeat=o,this._minFifter=l,this._magFifter=h,this.activeResource(),this._loaded=!0,this._alreadyResolved=!0}r(t,"laya.d3.resource.RenderTexture",e);var n=t.prototype;return n.recreateResource=function(){this.startCreate();var e=N.mainContext;this._frameBuffer=e.createFramebuffer(),this._source=e.createTexture();var t=P.curBindTexTarget,n=P.curBindTexValue;P.bindTexture(e,3553,this._source),e.texImage2D(3553,0,6408,this._width,this._height,0,this._surfaceFormat,this._surfaceType,null);var i=this._minFifter,r=this._magFifter,a=this._repeat?10497:33071;if(h.isPOT(this._width,this._height)?(this._mipmap?i!==-1||(i=9987):i!==-1||(i=9729),r!==-1||(r=9729),e.texParameteri(3553,10241,i),e.texParameteri(3553,10240,r),e.texParameteri(3553,10242,a),e.texParameteri(3553,10243,a),this._mipmap&&e.generateMipmap(3553)):(i!==-1||(i=9729),r!==-1||(r=9729),e.texParameteri(3553,10241,i),e.texParameteri(3553,10240,r),e.texParameteri(3553,10242,33071),e.texParameteri(3553,10243,33071)),e.bindFramebuffer(36160,this._frameBuffer),e.framebufferTexture2D(36160,36064,3553,this._source,0),this._depthStencilFormat)switch(this._depthStencilBuffer=e.createRenderbuffer(),e.bindRenderbuffer(36161,this._depthStencilBuffer),e.renderbufferStorage(36161,this._depthStencilFormat,this._width,this._height),this._depthStencilFormat){case 33189:e.framebufferRenderbuffer(36160,36096,36161,this._depthStencilBuffer);break;case 36168:e.framebufferRenderbuffer(36160,36128,36161,this._depthStencilBuffer);break;case 34041:e.framebufferRenderbuffer(36160,33306,36161,this._depthStencilBuffer)}e.bindFramebuffer(36160,null),t&&n&&P.bindTexture(e,t,n),e.bindRenderbuffer(36161,null),this.memorySize=this._width*this._height*4,this.completeCreate()},n.start=function(){N.mainContext.bindFramebuffer(36160,this.frameBuffer),t._currentRenderTarget=this,this._alreadyResolved=!1},n.end=function(){N.mainContext.bindFramebuffer(36160,null),t._currentRenderTarget=null,this._alreadyResolved=!0},n.getData=function(e,t,n,i){var r=N.mainContext;if(r.bindFramebuffer(36160,this._frameBuffer),!(36053===r.checkFramebufferStatus(36160)))return r.bindFramebuffer(36160,null),null;var a=new Uint8Array(this._width*this._height*4);return r.readPixels(e,t,n,i,this._surfaceFormat,this._surfaceType,a),r.bindFramebuffer(36160,null),a},
n.detoryResource=function(){if(this._frameBuffer){var e=N.mainContext;e.deleteTexture(this._source),e.deleteFramebuffer(this._frameBuffer),e.deleteRenderbuffer(this._depthStencilBuffer),this._source=null,this._frameBuffer=null,this._depthStencilBuffer=null,this.memorySize=0}},a(0,n,"surfaceFormat",function(){return this._surfaceFormat}),a(0,n,"surfaceType",function(){return this._surfaceType}),a(0,n,"depthStencilFormat",function(){return this._depthStencilFormat}),a(0,n,"source",function(){return this._alreadyResolved?e.prototype._$get_source.call(this):null}),a(0,n,"depthStencilBuffer",function(){return this._depthStencilBuffer}),a(0,n,"frameBuffer",function(){return this._frameBuffer}),t._currentRenderTarget=null,t}(Rt),nn=function(e){function t(e){this._color=null,this._pixels=null,t.__super.call(this),this._width=1,this._height=1,this._size=new _t(this.width,this.height),this._color=e,this._pixels=new Uint8Array([255*e.x,255*e.y,255*e.z,255*e.w])}r(t,"laya.d3.resource.SolidColorTexture2D",e);var n=t.prototype;return n._createWebGlTexture=function(){var e=N.mainContext,t=this._source=e.createTexture(),n=this._width,i=this._height,r=P.curBindTexTarget,a=P.curBindTexValue;P.bindTexture(e,3553,t),e.texImage2D(3553,0,6408,n,i,0,6408,5121,this._pixels);var s=this._minFifter,o=this._magFifter,l=this._repeat?10497:33071,u=h.isPOT(n,i);u?(this._mipmap?s!==-1||(s=9987):s!==-1||(s=9729),o!==-1||(o=9729),e.texParameteri(3553,10241,s),e.texParameteri(3553,10240,o),e.texParameteri(3553,10242,l),e.texParameteri(3553,10243,l),this._mipmap&&e.generateMipmap(3553)):(s!==-1||(s=9729),o!==-1||(o=9729),e.texParameteri(3553,10241,s),e.texParameteri(3553,10240,o),e.texParameteri(3553,10242,33071),e.texParameteri(3553,10243,33071)),r&&a&&P.bindTexture(e,r,a),this.memorySize=u?n*i*4*(1+1/3):n*i*4},n.recreateResource=function(){this.startCreate(),this._createWebGlTexture(),this.completeCreate()},n.detoryResource=function(){this._source&&(N.mainContext.deleteTexture(this._source),this._source=null,this.memorySize=0)},a(0,n,"source",function(){return e.prototype._$get_source.call(this)}),i(t,["magentaTexture",function(){return this.magentaTexture=new t(new at(1,0,1,1))},"grayTexture",function(){return this.grayTexture=new t(new at(.5,.5,.5,1))}]),t}(Rt),rn=(function(e){function t(){this._numberVertices=0,this._numberIndices=0,this._textureCube=null,t.__super.call(this),this.name="Skybox-"+t._nameNumber,t._nameNumber++,this.loadShaderParams(),this.recreateResource(),this.alphaBlending=1,this.colorIntensity=1}r(t,"laya.d3.resource.models.SkyBox",e);var n=t.prototype;n._getShader=function(e){var t=e.scene._shaderDefineValue;return this._shader=this._shaderCompile.withCompile(this._sharderNameID,t,t+2e-4*this._sharderNameID),this._shader},n.recreateResource=function(){this.startCreate(),this._numberVertices=36,this._numberIndices=36;var e=new Uint16Array(this._numberIndices),n=t._vertexDeclaration.vertexStride/4,i=new Float32Array(this._numberVertices*n),r=new rt(-.5,.5,.5),a=new rt(-.5,-.5,.5),s=new rt(.5,.5,.5),o=new rt(.5,-.5,.5),l=new rt(-.5,.5,-.5),h=new rt(.5,.5,-.5),u=new rt(-.5,-.5,-.5),c=new rt(.5,-.5,-.5),_=0;_=this._addVertex(i,_,r),_=this._addVertex(i,_,a),_=this._addVertex(i,_,s),_=this._addVertex(i,_,a),_=this._addVertex(i,_,o),_=this._addVertex(i,_,s),_=this._addVertex(i,_,l),_=this._addVertex(i,_,h),_=this._addVertex(i,_,u),_=this._addVertex(i,_,u),_=this._addVertex(i,_,h),_=this._addVertex(i,_,c),_=this._addVertex(i,_,r),_=this._addVertex(i,_,h),_=this._addVertex(i,_,l),_=this._addVertex(i,_,r),_=this._addVertex(i,_,s),_=this._addVertex(i,_,h),_=this._addVertex(i,_,a),_=this._addVertex(i,_,u),_=this._addVertex(i,_,c),_=this._addVertex(i,_,a),_=this._addVertex(i,_,c),_=this._addVertex(i,_,o),_=this._addVertex(i,_,r),_=this._addVertex(i,_,u),_=this._addVertex(i,_,a),_=this._addVertex(i,_,l),_=this._addVertex(i,_,u),_=this._addVertex(i,_,r),_=this._addVertex(i,_,s),_=this._addVertex(i,_,o),_=this._addVertex(i,_,c),_=this._addVertex(i,_,h),_=this._addVertex(i,_,s),_=this._addVertex(i,_,c);for(var d=0;d<36;d++)e[d]=d;if(this._vertexBuffer=new Zt(t._vertexDeclaration,this._numberVertices,35044,!0),this._indexBuffer=new qt("ushort",this._numberIndices,35044,!0),this._vertexBuffer.setData(i),this._indexBuffer.setData(e),this.memorySize=2*(this._vertexBuffer.byteLength+this._indexBuffer.byteLength),this.completeCreate(),this._conchSky){this._conchSky.setVBIB(t._vertexDeclaration._conchVertexDeclaration,i,e),this._sharderNameID=kt.nameKey.getID("SkyBox");var m=lt._preCompileShader[2e-4*this._sharderNameID];this._conchSky.setShader(m._conchShader)}},n._addVertex=function(e,t,n){var i=n.elements;return e[t+0]=i[0],e[t+1]=i[1],e[t+2]=i[2],t+3},n.loadShaderParams=function(){this._sharderNameID=kt.nameKey.getID("SkyBox"),this._shaderCompile=lt._preCompileShader[2e-4*this._sharderNameID]},n._render=function(e){this._textureCube&&this._textureCube.loaded&&(this._vertexBuffer._bind(),this._indexBuffer._bind(),this._shader=this._getShader(e),this._shader.bind(),e.camera.transform.worldMatrix.cloneTo(t._tempMatrix4x40),t._tempMatrix4x40.transpose(),Ke.multiply(e.projectionMatrix,t._tempMatrix4x40,t._tempMatrix4x41),e.camera._shaderValues.setValue(4,t._tempMatrix4x41.elements),this._shader.uploadCameraUniforms(e.camera._shaderValues.data),this._shaderValue.setValue(1,this._colorIntensity),this._shaderValue.setValue(2,this._alphaBlending),this._shaderValue.setValue(3,this.textureCube.source),this._shader.uploadAttributes(t._vertexDeclaration.shaderValues.data,null),this._shader.uploadMaterialUniforms(this._shaderValue.data),N.mainContext.drawElements(4,36,5123,0),I.trianglesFaces+=12,I.drawCall++)},a(0,n,"textureCube",function(){return this._textureCube},function(e){this._textureCube=e,this._conchSky&&this._conchSky.setTextureCube(this._textureCube._conchTexture,0,3)}),t._nameNumber=1,i(t,["_tempMatrix4x40",function(){return this._tempMatrix4x40=new Ke},"_tempMatrix4x41",function(){return this._tempMatrix4x41=new Ke},"_vertexDeclaration",function(){return this._vertexDeclaration=new pe(12,[new ve(0,"vector3",0)])}]),t}(Vt),function(e){function t(e){this._canRead=!1,this._src=null,this._image=null,this._recreateLock=!1,this._needReleaseAgain=!1,this._pixels=null,void 0===e&&(e=!1),t.__super.call(this),this._canRead=e}r(t,"laya.d3.resource.Texture2D",e);var i=t.prototype;return i._onTextureLoaded=function(e){this._image=e;var t=e.width,n=e.height;this._width=t,this._height=n,this._size=new _t(t,n),this._canRead&&(c.canvas.size(t,n),c.canvas.clear(),c.context.drawImage(e,0,0,t,n),this._pixels=new Uint8Array(c.context.getImageData(0,0,t,n).data.buffer))},i._createWebGlTexture=function(){if(!this._image)throw"create GLTextur err:no data:"+this._image;var e=N.mainContext,t=this._source=e.createTexture(),n=this._width,i=this._height,r=P.curBindTexTarget,a=P.curBindTexValue;P.bindTexture(e,3553,t),this._canRead?e.texImage2D(3553,0,6408,n,i,0,6408,5121,this._pixels):e.texImage2D(3553,0,6408,6408,5121,this._image);var s=this._minFifter,o=this._magFifter,l=this._repeat?10497:33071,u=h.isPOT(n,i);u?(this._mipmap?s!==-1||(s=9987):s!==-1||(s=9729),o!==-1||(o=9729),e.texParameteri(3553,10241,s),e.texParameteri(3553,10240,o),e.texParameteri(3553,10242,l),e.texParameteri(3553,10243,l),this._mipmap&&e.generateMipmap(3553)):(s!==-1||(s=9729),o!==-1||(o=9729),e.texParameteri(3553,10241,s),e.texParameteri(3553,10240,o),e.texParameteri(3553,10242,33071),e.texParameteri(3553,10243,33071)),r&&a&&P.bindTexture(e,r,a),this._image.onload=null,this._image=null,this.memorySize=u?n*i*4*(1+1/3):n*i*4,this._recreateLock=!1},i.recreateResource=function(){if(null!=this._src&&""!==this._src)if(this._needReleaseAgain=!1,this._image){if(this._recreateLock)return;this.startCreate(),this._createWebGlTexture(),this.completeCreate()}else{this._recreateLock=!0,this.startCreate();var e=this;this._image=new c.window.Image,this._image.crossOrigin="",this._image.onload=function(){if(e._needReleaseAgain)return e._needReleaseAgain=!1,e._image.onload=null,void(e._image=null);e._createWebGlTexture(),e.completeCreate()},this._image.src=this._src}},i.onAsynLoaded=function(e,t,n){n&&(this._canRead=n[0]),this._src=e,this._onTextureLoaded(t),this._conchTexture?this._conchTexture.setTexture2DImage(this._image):this.activeResource(),this._loaded=!0,this.event("loaded",this)},i.getPixels=function(){if(this._canRead)return this._pixels;throw new Error("Texture2D: must set texture canRead is true.")},i.detoryResource=function(){this._recreateLock&&(this._needReleaseAgain=!0),this._source&&(N.mainContext.deleteTexture(this._source),this._source=null,this._image=null,this.memorySize=0)},a(0,i,"src",function(){return this._src}),t.load=function(e){return n.loader.create(e,null,null,t)},t}(Rt)),an=(function(e){function t(){this._numberVertices=0,this._numberIndices=0,this._texture=null,this._stacks=16,this._slices=16,this._radius=1,t.__super.call(this),this.name="SkyDome-"+t._nameNumber,t._nameNumber++,this.loadShaderParams(),this.recreateResource(),this.alphaBlending=1,this.colorIntensity=1}r(t,"laya.d3.resource.models.SkyDome",e);var n=t.prototype;n._getShader=function(e){var t=e.scene._shaderDefineValue;return this._shader=this._shaderCompile.withCompile(this._sharderNameID,t,t+2e-4*this._sharderNameID),this._shader},n.recreateResource=function(){this.startCreate(),this._numberVertices=(this._stacks+1)*(this._slices+1),this._numberIndices=3*this._stacks*(this._slices+1)*2;for(var e=new Uint16Array(this._numberIndices),n=t._vertexDeclaration.vertexStride/4,i=new Float32Array(this._numberVertices*n),r=Math.PI/this._stacks,a=2*Math.PI/this._slices,s=0,o=0,l=0,h=0;h<this._stacks+1;h++)for(var u=Math.sin(h*r),c=Math.cos(h*r),_=0;_<this._slices+1;_++){var d=u*Math.sin(_*a),m=u*Math.cos(_*a);i[o+0]=d*this._radius,i[o+1]=c*this._radius,i[o+2]=m*this._radius,i[o+3]=.75-_/this._slices,i[o+4]=h/this._stacks,o+=n,h!=this._stacks-1&&(e[l++]=s+1,e[l++]=s,e[l++]=s+(this._slices+1),e[l++]=s+(this._slices+1),e[l++]=s,e[l++]=s+this._slices,s++)}if(this._vertexBuffer=new Zt(t._vertexDeclaration,this._numberVertices,35044),this._indexBuffer=new qt("ushort",this._numberIndices,35044),this._vertexBuffer.setData(i),this._indexBuffer.setData(e),this.memorySize=2*(this._vertexBuffer.byteLength+this._indexBuffer.byteLength),this.completeCreate(),this._conchSky){this._conchSky.setVBIB(t._vertexDeclaration._conchVertexDeclaration,i,e),this._sharderNameID=kt.nameKey.getID("SkyDome");var f=lt._preCompileShader[2e-4*this._sharderNameID];this._conchSky.setShader(f._conchShader)}},n.loadShaderParams=function(){this._sharderNameID=kt.nameKey.getID("SkyDome"),this._shaderCompile=lt._preCompileShader[2e-4*this._sharderNameID]},n._render=function(e){this._texture&&this._texture.loaded&&(this._vertexBuffer._bind(),this._indexBuffer._bind(),this._shader=this._getShader(e),this._shader.bind(),e.camera.transform.worldMatrix.cloneTo(t._tempMatrix4x40),t._tempMatrix4x40.transpose(),Ke.multiply(e.projectionMatrix,t._tempMatrix4x40,t._tempMatrix4x41),e.camera._shaderValues.setValue(4,t._tempMatrix4x41.elements),this._shader.uploadCameraUniforms(e.camera._shaderValues.data),this._shaderValue.setValue(1,this._colorIntensity),this._shaderValue.setValue(2,this._alphaBlending),this._shaderValue.setValue(3,this.texture.source),this._shader.uploadAttributes(t._vertexDeclaration.shaderValues.data,null),this._shader.uploadMaterialUniforms(this._shaderValue.data),N.mainContext.drawElements(4,this._indexBuffer.indexCount,5123,0),I.trianglesFaces+=this._numberIndices/3,I.drawCall++)},a(0,n,"texture",function(){return this._texture},function(e){this._texture=e,this._conchSky&&this._conchSky.setTexture(this._texture._conchTexture,0,3)}),t._nameNumber=1,i(t,["_tempMatrix4x40",function(){return this._tempMatrix4x40=new Ke},"_tempMatrix4x41",function(){return this._tempMatrix4x41=new Ke},"_vertexDeclaration",function(){return this._vertexDeclaration=new pe(20,[new ve(0,"vector3",0),new ve(12,"vector2",2)])}]),t}(Vt),function(e){function t(){this._texCount=6,this._recreateLock=!1,this._needReleaseAgain=!1,t.__super.call(this)}r(t,"laya.d3.resource.TextureCube",e);var i=t.prototype;return i._onTextureLoaded=function(e){this._images=e;for(var t=2147483647,n=2147483647,i=0;i<6;i++){var r=e[i];t=Math.min(t,r.width),n=Math.min(n,r.height)}this._width=t,this._height=n,this._size=new _t(t,n)},i._createWebGlTexture=function(){var e=0;for(e=0;e<this._texCount;e++)if(!this._images[e])throw"create GLTextur err:no data:"+this._images[e];var t=N.mainContext,n=this._source=t.createTexture(),i=this._width,r=this._height,a=P.curBindTexTarget,s=P.curBindTexValue;P.bindTexture(t,34067,n),t.texImage2D(34069,0,6408,6408,5121,this._images[0]),t.texImage2D(34070,0,6408,6408,5121,this._images[1]),t.texImage2D(34071,0,6408,6408,5121,this._images[2]),t.texImage2D(34072,0,6408,6408,5121,this._images[3]),t.texImage2D(34073,0,6408,6408,5121,this._images[4]),t.texImage2D(34074,0,6408,6408,5121,this._images[5]);var o=this.minFifter,l=this.magFifter,u=this.repeat?10497:33071,c=h.isPOT(i,r);for(c?(this.mipmap?o!==-1||(o=9987):o!==-1||(o=9729),l!==-1||(l=9729),t.texParameteri(34067,10241,o),t.texParameteri(34067,10240,l),t.texParameteri(34067,10242,u),t.texParameteri(34067,10243,u),this.mipmap&&t.generateMipmap(34067)):(o!==-1||(o=9729),l!==-1||(l=9729),t.texParameteri(34067,10241,o),t.texParameteri(34067,10240,l),t.texParameteri(34067,10242,33071),t.texParameteri(34067,10243,33071)),a&&s&&P.bindTexture(t,a,s),e=0;e<6;e++)this._images[e].onload=null,this._images[e]=null;this.memorySize=c?i*r*4*(1+1/3)*this._texCount:i*r*4*this._texCount,this._recreateLock=!1},i.recreateResource=function(){var e=this;if(null!=this._srcs)if(this._needReleaseAgain=!1,this._images[0]){if(this._recreateLock)return;this.startCreate(),this._createWebGlTexture(),this.completeCreate()}else{this._recreateLock=!0,this.startCreate();for(var t=this,n=0;n<this._texCount;n++){this._images[n]=new c.window.Image,this._images[n].crossOrigin="";var i=n;this._images[i].onload=function(){var n=0;if(t._needReleaseAgain){for(n=0;n<e._texCount;n++)if(!t._images[n].complete)return;for(t._needReleaseAgain=!1,n=0;n<e._texCount;n++)t._images[n].onload=null,t._images[n]=null}else{for(n=0;n<e._texCount;n++)if(!t._images[n].complete)return;t._createWebGlTexture(),t.completeCreate()}},this._images[n].src=this._srcs[n]}}},i.onAsynLoaded=function(e,t,n){this._srcs=e,this._onTextureLoaded(t),this._conchTexture?this._conchTexture.setTextureCubeImages(this._images):this.activeResource(),this._loaded=!0,this.event("loaded",this)},i.detoryResource=function(){this._recreateLock&&(this._needReleaseAgain=!0),this._source&&(N.mainContext.deleteTexture(this._source),this._source=null,this.memorySize=0)},a(0,i,"srcs",function(){return this._srcs}),t.load=function(e){return n.loader.create(e,null,null,t)},t}(Rt)),sn=(function(e){function t(){this._tempBoundBoxCorners=[],t.__super.call(this)}r(t,"laya.d3.core.scene.Scene",e);var n=t.prototype;n._renderRenderableBoundBox=function(e,t){if(t instanceof laya.d3.core.RenderableSprite3D){var n=t,i=n._render.boundingBox,r=this._tempBoundBoxCorners;i.getCorners(r),e.line(r[0].x,r[0].y,r[0].z,0,1,0,1,r[1].x,r[1].y,r[1].z,0,1,0,1),e.line(r[2].x,r[2].y,r[2].z,0,1,0,1,r[3].x,r[3].y,r[3].z,0,1,0,1),e.line(r[4].x,r[4].y,r[4].z,0,1,0,1,r[5].x,r[5].y,r[5].z,0,1,0,1),e.line(r[6].x,r[6].y,r[6].z,0,1,0,1,r[7].x,r[7].y,r[7].z,0,1,0,1),e.line(r[0].x,r[0].y,r[0].z,0,1,0,1,r[3].x,r[3].y,r[3].z,0,1,0,1),e.line(r[1].x,r[1].y,r[1].z,0,1,0,1,r[2].x,r[2].y,r[2].z,0,1,0,1),e.line(r[2].x,r[2].y,r[2].z,0,1,0,1,r[6].x,r[6].y,r[6].z,0,1,0,1),e.line(r[3].x,r[3].y,r[3].z,0,1,0,1,r[7].x,r[7].y,r[7].z,0,1,0,1),e.line(r[0].x,r[0].y,r[0].z,0,1,0,1,r[4].x,r[4].y,r[4].z,0,1,0,1),e.line(r[1].x,r[1].y,r[1].z,0,1,0,1,r[5].x,r[5].y,r[5].z,0,1,0,1),e.line(r[4].x,r[4].y,r[4].z,0,1,0,1,r[7].x,r[7].y,r[7].z,0,1,0,1),e.line(r[5].x,r[5].y,r[5].z,0,1,0,1,r[6].x,r[6].y,r[6].z,0,1,0,1)}for(var a=0,s=t._childs.length;a<s;a++)this._renderRenderableBoundBox(e,t._childs[a])},n._renderCamera=function(e,t,n){var i=n;t.camera=i,i._prepareCameraToRender(),this.beforeRender(t);var r=i.renderTarget;if(r?(r.start(),Ke.multiply(this._invertYScaleMatrix,i.projectionMatrix,this._invertYProjectionMatrix),Ke.multiply(this._invertYScaleMatrix,i.projectionViewMatrix,this._invertYProjectionViewMatrix),t.projectionMatrix=this._invertYProjectionMatrix,i._setShaderValueMatrix4x4(2,this._invertYProjectionMatrix),t.projectionViewMatrix=this._invertYProjectionViewMatrix):(t.projectionMatrix=i.projectionMatrix,i._setShaderValueMatrix4x4(2,i.projectionMatrix),t.projectionViewMatrix=i.projectionViewMatrix),i._setShaderValueMatrix4x4(1,i.viewMatrix),t.viewMatrix=i.viewMatrix,t.viewport=i.viewport,this._preRenderScene(e,t),this._clear(e,t),this._renderScene(e,t),this.lateRender(t),mt.treeDebug&&this.treeRoot){var a=mt.debugPhasorSprite;a.begin(1,t),this._renderRenderableBoundBox(a,this),this.treeRoot.renderBoudingBox(a),a.end()}r&&r.end()},t}(Ut),function(e){function t(){t.__super.call(this)}r(t,"laya.d3.core.scene.VRScene",e),t.prototype._renderCamera=function(e,t,n){var i=n;t.camera=i,i._prepareCameraToRender(),t.scene.addShaderDefine(lt.SHADERDEFINE_VR),this.beforeRender(t);var r=i.renderTarget;r?(r.start(),Ke.multiply(this._invertYScaleMatrix,i.leftProjectionMatrix,this._invertYProjectionMatrix),Ke.multiply(this._invertYScaleMatrix,i.leftProjectionViewMatrix,this._invertYProjectionViewMatrix),t.projectionMatrix=this._invertYProjectionMatrix,i._setShaderValueMatrix4x4(2,this._invertYProjectionMatrix),t.projectionViewMatrix=this._invertYProjectionViewMatrix):(t.projectionMatrix=i.leftProjectionMatrix,i._setShaderValueMatrix4x4(2,i.leftProjectionMatrix),t.projectionViewMatrix=i.leftProjectionViewMatrix),i._setShaderValueMatrix4x4(1,i.leftViewMatrix),t.viewMatrix=i.leftViewMatrix,t.viewport=i.leftViewport,this._preRenderScene(e,t),this._clear(e,t),this._renderScene(e,t),r?(r.start(),Ke.multiply(this._invertYScaleMatrix,i.rightProjectionMatrix,this._invertYProjectionMatrix),Ke.multiply(this._invertYScaleMatrix,i.rightProjectionViewMatrix,this._invertYProjectionViewMatrix),t.projectionMatrix=this._invertYProjectionMatrix,i._setShaderValueMatrix4x4(2,this._invertYProjectionMatrix),t.projectionViewMatrix=this._invertYProjectionViewMatrix):(t.projectionMatrix=i.rightProjectionMatrix,i._setShaderValueMatrix4x4(2,i.rightProjectionMatrix),t.projectionViewMatrix=i.rightProjectionViewMatrix),i._setShaderValueMatrix4x4(1,i.rightViewMatrix),t.viewMatrix=i.rightViewMatrix,t.viewport=i.rightViewport,this._preRenderScene(e,t),this._clear(e,t),this._renderScene(e,t),this.lateRender(t),r&&r.end()},t}(Ut),function(e){function t(e,n,i){void 0===e&&(e=0),void 0===n&&(n=.1),void 0===i&&(i=1e3),this._viewMatrix=new Ke,this._projectionMatrix=new Ke,this._projectionViewMatrix=new Ke,this._viewport=new st(0,0,0,0),this._normalizedViewport=new st(0,0,1,1),this._aspectRatio=e,t.__super.call(this,n,i)}r(t,"laya.d3.core.Camera",e);var n=t.prototype;return n._calculateProjectionMatrix=function(){if(!this._useUserProjectionMatrix)if(this.orthographicProjection){var e=this.orthographicVerticalSize*this.aspectRatio*.5,t=.5*this.orthographicVerticalSize;Ke.createOrthogonal(-e,e,-t,t,this.nearPlane,this.farPlane,this._projectionMatrix)}else Ke.createPerspective(3.1416*this.fieldOfView/180,this.aspectRatio,this.nearPlane,this.farPlane,this._projectionMatrix);this._projectionMatrixModifyID+=.01/this.id},n.viewportPointToRay=function(e,t){ut.calculateCursorRay(e,this.viewport,this._projectionMatrix,this.viewMatrix,null,t)},n.normalizedViewportPointToRay=function(e,n){var i=t._tempVector2,r=this.viewport,a=e.elements,s=i.elements;s[0]=a[0]*r.width,s[1]=a[1]*r.height,ut.calculateCursorRay(i,this.viewport,this._projectionMatrix,this.viewMatrix,null,n)},n.worldToViewportPoint=function(e,t){if(Ke.multiply(this._projectionMatrix,this._viewMatrix,this._projectionViewMatrix),this.viewport.project(e,this._projectionViewMatrix,t),t.z<0||t.z>1){var n=t.elements;n[0]=n[1]=n[2]=NaN}},n.worldToNormalizedViewportPoint=function(e,t){if(Ke.multiply(this._projectionMatrix,this._viewMatrix,this._projectionViewMatrix),this.normalizedViewport.project(e,this._projectionViewMatrix,t),t.z<0||t.z>1){var n=t.elements;n[0]=n[1]=n[2]=NaN}},n._update=function(e){this.conchModel&&(this.conchModel.setViewMatrix(this.viewMatrix.elements),this.conchModel.setProjectMatrix(this.projectionMatrix.elements)),laya.d3.core.Sprite3D.prototype._update.call(this,e)},a(0,n,"projectionViewMatrix",function(){return Ke.multiply(this.projectionMatrix,this.viewMatrix,this._projectionViewMatrix),this._projectionViewMatrix}),a(0,n,"aspectRatio",function(){if(0===this._aspectRatio){var e=this.viewport;return e.width/e.height}return this._aspectRatio},function(e){if(e<0)throw new Error("Camera: the aspect ratio has to be a positive real number.");this._aspectRatio=e,this._calculateProjectionMatrix()}),a(0,n,"needViewport",function(){var e=this.normalizedViewport;return 0===e.x&&0===e.y&&1===e.width&&1===e.height}),a(0,n,"viewport",function(){if(this._viewportExpressedInClipSpace){var e=this._normalizedViewport,t=this.renderTargetSize,n=t.width,i=t.height;this._viewport.x=e.x*n,this._viewport.y=e.y*i,this._viewport.width=e.width*n,this._viewport.height=e.height*i}return this._viewport},function(e){if(null!=this.renderTarget&&(e.x<0||e.y<0||0==e.width||0==e.height))throw new Error("Camera: viewport size invalid.","value");this._viewportExpressedInClipSpace=!1,this._viewport=e,this._calculateProjectionMatrix()}),a(0,n,"normalizedViewport",function(){if(!this._viewportExpressedInClipSpace){var e=this._viewport,t=this.renderTargetSize,n=t.width,i=t.height;this._normalizedViewport.x=e.x/n,this._normalizedViewport.y=e.y/i,this._normalizedViewport.width=e.width/n,this._normalizedViewport.height=e.height/i}return this._normalizedViewport},function(e){if(e.x<0||e.y<0||e.x+e.width>1||e.x+e.height>1)throw new Error("Camera: viewport size invalid.","value");this._viewportExpressedInClipSpace=!0,this._normalizedViewport=e,this._calculateProjectionMatrix()}),a(0,n,"projectionMatrix",function(){return this._projectionMatrix},function(e){this._projectionMatrix=e,this._useUserProjectionMatrix=!0}),a(0,n,"viewMatrix",function(){return this.transform.worldMatrix.invert(this._viewMatrix),this._viewMatrix}),i(t,["_tempVector2",function(){return this._tempVector2=new it}]),t}(zt)),on=(function(e){function t(){t.__super.call(this),this._render=new bt(this),this._render.on("materialchanged",this,this._onMaterialChanged);var e=new jt;this._render.sharedMaterial=e,this._geometryFilter=new Ft(this),e.renderMode=8,this._changeRenderObject(0)}r(t,"laya.d3.core.glitter.Glitter",e);var n=t.prototype;n._changeRenderObject=function(e){var t=this._render.renderObject._renderElements,n=t[e];n||(n=t[e]=new ae),n._renderObject=this._render.renderObject;var i=this._render.sharedMaterials[e];i||(i=jt.defaultMaterial);var r=this._geometryFilter;return n._mainSortID=0,n._sprite3D=this,n.renderObj=r,n._material=i,n},n._onMaterialChanged=function(e,t,n){t<e.renderObject._renderElements.length&&this._changeRenderObject(t)},n._clearSelfRenderObjects=function(){this.scene.removeFrustumCullingObject(this._render.renderObject)},n._addSelfRenderObjects=function(){this.scene.addFrustumCullingObject(this._render.renderObject)},n._update=function(t){this._geometryFilter._update(t.elapsedTime),e.prototype._update.call(this,t)},n._prepareShaderValuetoRender=function(e){this._setShaderValueMatrix4x4(0,this.transform.worldMatrix);var t=this.getProjectionViewWorldMatrix(e);this._setShaderValueMatrix4x4(1,t)},n.addGlitterByPositions=function(e,t){this._geometryFilter.addVertexPosition(e,t)},n.addGlitterByPositionsVelocitys=function(e,t,n,i){this._geometryFilter.addVertexPositionVelocity(e,t,n,i)},n.cloneTo=function(e){laya.d3.core.Sprite3D.prototype.cloneTo.call(this,e);var t=e,n=t.templet,i=this._geometryFilter;n.lifeTime=i.lifeTime,n.minSegmentDistance=i.minSegmentDistance,n.minInterpDistance=i.minInterpDistance,n.maxSlerpCount=i.maxSlerpCount,i.color.cloneTo(n.color),n._maxSegments=i._maxSegments;var r=t._render,a=this._render;r.sharedMaterials=a.sharedMaterials,r.enable=a.enable},n.destroy=function(t){void 0===t&&(t=!0),e.prototype.destroy.call(this,t),this._geometryFilter._destroy(),this._geometryFilter=null},a(0,n,"templet",function(){return this._geometryFilter}),a(0,n,"glitterRender",function(){return this._render}),t}(Ht),function(e){function t(){this._direction=null,t.__super.call(this),this._diffuseColor=new rt(1,1,1),this._ambientColor=new rt(.6,.6,.6),this._specularColor=new rt(1,1,1),this._reflectColor=new rt(1,1,1),this._direction=new rt(0,-.5,-1)}r(t,"laya.d3.core.light.DirectionLight",e);var n=t.prototype;n.updateToWorldState=function(e){var t=e.scene;if(t.enableLight){var n=t._shaderValues;t.addShaderDefine(lt.SHADERDEFINE_DIRECTIONLIGHT),n.setValue(4,this.diffuseColor.elements),n.setValue(5,this.ambientColor.elements),n.setValue(6,this.specularColor.elements),n.setValue(3,this.direction.elements)}},a(0,n,"direction",function(){return this._direction},function(e){this._direction=e}),a(0,n,"lightType",function(){return 1}),t}(Gt),function(e){function t(e,n){t.__super.call(this,n),this._geometryFilter=new wt(this),this._render=new Ot(this),this._geometryFilter.on("meshchanged",this,this._onMeshChanged),this._render.on("materialchanged",this,this._onMaterialChanged),e&&(this._geometryFilter.sharedMesh=e,e instanceof laya.d3.resource.models.Mesh&&(e.loaded?this._render.sharedMaterials=e.materials:e.once("loaded",this,this._applyMeshMaterials)))}r(t,"laya.d3.core.MeshSprite3D",e);var i=t.prototype;return i.createConchModel=function(){return null},i._changeRenderObjectByMesh=function(e){var t=this._render.renderObject._renderElements,n=t[e];n||(n=t[e]=new ae),n._renderObject=this._render.renderObject;var i=this._render.sharedMaterials[e];i||(i=Xt.defaultMaterial);var r=this._geometryFilter.sharedMesh.getRenderElement(e);if(n._mainSortID=this._getSortID(r,i),n._sprite3D=this,n.renderObj=r,n._material=i,D.isConchNode){var a=r._getVertexBuffer();n._conchSubmesh.setVBIB(a.vertexDeclaration._conchVertexDeclaration,a.getData(),r._getIndexBuffer().getData())}return n},i._changeRenderObjectByMaterial=function(e,t){var n=this._render.renderObject._renderElements[e],i=this._geometryFilter.sharedMesh.getRenderElement(e);return n._mainSortID=this._getSortID(i,t),n._sprite3D=this,n.renderObj=i,n._material=t,D.isConchNode&&n._conchSubmesh.setMaterial(t._conchMaterial),n},i._changeRenderObjectsByMesh=function(){if(D.isConchNode){var e=this._geometryFilter.sharedMesh.boundingBox;this._render.renderObject._conchRenderObject.boundingBox(e.min.elements,e.max.elements)}var t=this._geometryFilter.sharedMesh.getRenderElementsCount();this._render.renderObject._renderElements.length=t;for(var n=0;n<t;n++)this._changeRenderObjectByMesh(n)},i._onMeshChanged=function(e){var t=e.sharedMesh;t.loaded?this._changeRenderObjectsByMesh():t.once("loaded",this,this._onMeshLoaded)},i._onMeshLoaded=function(e){e===this.meshFilter.sharedMesh&&this._changeRenderObjectsByMesh()},i._onMaterialChanged=function(e,t,n){t<this._render.renderObject._renderElements.length&&this._changeRenderObjectByMaterial(t,n)},i._clearSelfRenderObjects=function(){this.scene.removeFrustumCullingObject(this._render.renderObject),this.scene.conchModel&&this.scene.conchModel.removeChild(this._render.renderObject._conchRenderObject)},i._addSelfRenderObjects=function(){this.scene.addFrustumCullingObject(this._render.renderObject),this.scene.conchModel&&this.scene.conchModel.addChildAt(this._render.renderObject._conchRenderObject)},i._applyMeshMaterials=function(e){for(var t=this._render.sharedMaterials,n=e.materials,i=0,r=n.length;i<r;i++)t[i]||(t[i]=n[i]);this._render.sharedMaterials=t},i._prepareShaderValuetoRender=function(e){laya.d3.core.Sprite3D.prototype._prepareShaderValuetoRender.call(this,e)},i.cloneTo=function(e){laya.d3.core.Sprite3D.prototype.cloneTo.call(this,e);var t=e;t._geometryFilter.sharedMesh=this._geometryFilter.sharedMesh;var n=this._render,i=t._render;i.enable=n.enable,i.sharedMaterials=n.sharedMaterials,i.castShadow=n.castShadow;var r=n.lightmapScaleOffset;r&&(i.lightmapScaleOffset=r.clone()),i.receiveShadow=n.receiveShadow},i.destroy=function(t){void 0===t&&(t=!0),e.prototype.destroy.call(this,t),this._geometryFilter._destroy()},a(0,i,"meshFilter",function(){return this._geometryFilter}),a(0,i,"meshRender",function(){return this._render}),t.load=function(e){return n.loader.create(e,null,null,t,null,1,!1)},t.LIGHTMAPSCALEOFFSET=2,t}(Ht)),ln=(function(e){function t(){this._attenuation=null,this._range=NaN,t.__super.call(this),this._diffuseColor=new rt(1,1,1),this._ambientColor=new rt(.2,.2,.2),this._specularColor=new rt(1,0,0),this._reflectColor=new rt(1,1,1),this.transform.position=new rt(0,0,0),this._range=6,this._attenuation=new rt(.6,.6,.6)}r(t,"laya.d3.core.light.PointLight",e);var n=t.prototype;n.updateToWorldState=function(e){var t=e.scene;if(t.enableLight){var n=t._shaderValues;t.addShaderDefine(lt.SHADERDEFINE_POINTLIGHT),n.setValue(10,this.diffuseColor.elements),n.setValue(11,this.ambientColor.elements),n.setValue(12,this.specularColor.elements),n.setValue(7,this.transform.position.elements),n.setValue(8,this.range),n.setValue(9,this.attenuation.elements)}},a(0,n,"range",function(){return this._range},function(e){this._range=e}),a(0,n,"lightType",function(){return 2}),a(0,n,"attenuation",function(){return this._attenuation},function(e){this._attenuation=e}),t}(Gt),function(e){function t(){this._direction=null,this._attenuation=null,this._spot=NaN,this._range=NaN,t.__super.call(this),this._diffuseColor=new rt(1,1,1),this._ambientColor=new rt(.2,.2,.2),this._specularColor=new rt(1,1,1),this._reflectColor=new rt(1,1,1),this.transform.position=new rt(0,1,1),this._direction=new rt(0,-1,-1),this._attenuation=new rt(.6,.6,.6),this._spot=96,this._range=6}r(t,"laya.d3.core.light.SpotLight",e);var n=t.prototype;n.updateToWorldState=function(e){var t=e.scene;if(t.enableLight){var n=t._shaderValues;t.addShaderDefine(lt.SHADERDEFINE_SPOTLIGHT),n.setValue(18,this.diffuseColor.elements),n.setValue(19,this.ambientColor.elements),n.setValue(20,this.specularColor.elements),n.setValue(13,this.transform.position.elements),n.setValue(14,this.direction.elements),n.setValue(16,this.range),n.setValue(15,this.spot),n.setValue(17,this.attenuation.elements)}},a(0,n,"range",function(){return this._range},function(e){this._range=e}),a(0,n,"direction",function(){return this._direction},function(e){this._direction=e}),a(0,n,"lightType",function(){return 3}),a(0,n,"attenuation",function(){return this._attenuation},function(e){this._attenuation=e}),a(0,n,"spot",function(){return this._spot},function(e){this._spot=e}),t}(Gt),function(e){function t(e){this._setting=null,this._templet=null,t.__super.call(this),this._setting=e,this._render=new Nt(this),this._render.on("materialchanged",this,this._onMaterialChanged);var n=new Yt;e.textureName&&(n.diffuseTexture=rn.load(e.textureName)),this._render.sharedMaterial=n,this._templet=new Bt(this,e),0===e.blendState?n.renderMode=5:1===e.blendState&&(n.renderMode=7),this._changeRenderObject(0)}r(t,"laya.d3.core.particle.Particle3D",e);var n=t.prototype;n._changeRenderObject=function(e){var t=this._render.renderObject._renderElements,n=t[e];n||(n=t[e]=new ae),n._renderObject=this._render.renderObject;var i=this._render.sharedMaterials[e];i||(i=Yt.defaultMaterial);var r=this._templet;return n._mainSortID=0,n._sprite3D=this,n.renderObj=r,n._material=i,n},n._onMaterialChanged=function(e,t,n){t<e.renderObject._renderElements.length&&this._changeRenderObject(t)},n._clearSelfRenderObjects=function(){this.scene.removeFrustumCullingObject(this._render.renderObject)},n._addSelfRenderObjects=function(){this.scene.addFrustumCullingObject(this._render.renderObject)},n._prepareShaderValuetoRender=function(e){
this._setShaderValueMatrix4x4(0,this.transform.worldMatrix);var t=this.getProjectionViewWorldMatrix(e);this._setShaderValueMatrix4x4(1,t)},n._update=function(t){this._templet.update(t.elapsedTime),e.prototype._update.call(this,t)},n.addParticle=function(e,t){rt.add(this.transform.localPosition,e,e),this._templet.addParticle(e,t)},n.cloneTo=function(e){laya.d3.core.Sprite3D.prototype.cloneTo.call(this,e);var t=e;t._templet=this._templet;var n=t._render,i=this._render;n.sharedMaterials=i.sharedMaterials,n.enable=i.enable},n.destroy=function(t){void 0===t&&(t=!0),e.prototype.destroy.call(this,t),this._templet=null},a(0,n,"templet",function(){return this._templet}),a(0,n,"particleRender",function(){return this._render}),t}(Ht),function(e){function t(e){t.__super.call(this),this._tempRotationMatrix=new Ke,this._render=new Lt(this),this._render.on("materialchanged",this,this._onMaterialChanged),this._geometryFilter=new Pt(this),this._changeRenderObject(0),e&&(this._render.sharedMaterial=e)}r(t,"laya.d3.core.particleShuriKen.ShuriKenParticle3D",e);var n=t.prototype;return n._changeRenderObject=function(e){var t=this._render.renderObject._renderElements,n=t[e];n||(n=t[e]=new ae),n._renderObject=this._render.renderObject;var i=this._render.sharedMaterials[e];i||(i=Qt.defaultMaterial);var r=this._geometryFilter;return n._mainSortID=0,n._sprite3D=this,n.renderObj=r,n._material=i,n},n._onMaterialChanged=function(e,t,n){t<e.renderObject._renderElements.length&&this._changeRenderObject(t)},n._clearSelfRenderObjects=function(){this.scene.removeFrustumCullingObject(this._render.renderObject)},n._addSelfRenderObjects=function(){this.scene.addFrustumCullingObject(this._render.renderObject)},n._prepareShaderValuetoRender=function(e){switch(this.particleSystem.simulationSpace){case 0:this._setShaderValueColor(0,rt.ZERO);break;case 1:this._setShaderValueColor(0,this.transform.position);break;default:throw new Error("ShurikenParticleMaterial: SimulationSpace value is invalid.")}switch(Ke.createFromQuaternion(this.transform.rotation,this._tempRotationMatrix),this._setShaderValueMatrix4x4(1,this._tempRotationMatrix),this.particleSystem.scaleMode){case 0:this._setShaderValueColor(4,this.transform.scale),this._setShaderValueColor(5,this.transform.scale);break;case 1:this._setShaderValueColor(4,this.transform.localScale),this._setShaderValueColor(5,this.transform.localScale);break;case 2:this._setShaderValueColor(4,this.transform.scale),this._setShaderValueColor(5,rt.ONE)}},n.cloneTo=function(e){laya.d3.core.Sprite3D.prototype.cloneTo.call(this,e);var t=e,n=t._geometryFilter;this._geometryFilter.cloneTo(n);var i=t._render,r=this._render;i.sharedMaterials=r.sharedMaterials,i.enable=r.enable,i.renderMode=r.renderMode,i.stretchedBillboardCameraSpeedScale=r.stretchedBillboardCameraSpeedScale,i.stretchedBillboardSpeedScale=r.stretchedBillboardSpeedScale,i.stretchedBillboardLengthScale=r.stretchedBillboardLengthScale},n.destroy=function(t){void 0===t&&(t=!0),e.prototype.destroy.call(this,t),this._geometryFilter._destroy(),this._geometryFilter=null},a(0,n,"particleSystem",function(){return this._geometryFilter}),a(0,n,"particleRender",function(){return this._render}),t.WORLDPOSITION=0,t.WORLDROTATIONMATRIX=1,t.POSITIONSCALE=4,t.SIZESCALE=5,t.VOLVELOCITYCONST=6,t.VOLVELOCITYGRADIENTX=7,t.VOLVELOCITYGRADIENTY=8,t.VOLVELOCITYGRADIENTZ=9,t.VOLVELOCITYCONSTMAX=10,t.VOLVELOCITYGRADIENTXMAX=11,t.VOLVELOCITYGRADIENTYMAX=12,t.VOLVELOCITYGRADIENTZMAX=13,t.VOLSPACETYPE=14,t.COLOROVERLIFEGRADIENTALPHAS=15,t.COLOROVERLIFEGRADIENTCOLORS=16,t.MAXCOLOROVERLIFEGRADIENTALPHAS=17,t.MAXCOLOROVERLIFEGRADIENTCOLORS=18,t.SOLSIZEGRADIENT=19,t.SOLSIZEGRADIENTX=20,t.SOLSIZEGRADIENTY=21,t.SOLSizeGradientZ=22,t.SOLSizeGradientMax=23,t.SOLSIZEGRADIENTXMAX=24,t.SOLSIZEGRADIENTYMAX=25,t.SOLSizeGradientZMAX=26,t.ROLANGULARVELOCITYCONST=27,t.ROLANGULARVELOCITYCONSTSEPRARATE=28,t.ROLANGULARVELOCITYGRADIENT=29,t.ROLANGULARVELOCITYGRADIENTX=30,t.ROLANGULARVELOCITYGRADIENTY=31,t.ROLANGULARVELOCITYGRADIENTZ=32,t.ROLANGULARVELOCITYCONSTMAX=33,t.ROLANGULARVELOCITYCONSTMAXSEPRARATE=34,t.ROLANGULARVELOCITYGRADIENTMAX=35,t.ROLANGULARVELOCITYGRADIENTXMAX=36,t.ROLANGULARVELOCITYGRADIENTYMAX=37,t.ROLANGULARVELOCITYGRADIENTZMAX=38,t.TEXTURESHEETANIMATIONCYCLES=39,t.TEXTURESHEETANIMATIONSUBUVLENGTH=40,t.TEXTURESHEETANIMATIONGRADIENTUVS=41,t.TEXTURESHEETANIMATIONGRADIENTMAXUVS=42,t}(Ht));(function(e){function t(e,n,i,r,a){void 0===e&&(e=.1),void 0===n&&(n=0),void 0===i&&(i=0),void 0===r&&(r=.1),void 0===a&&(a=1e3),this._tempMatrix=new Ke,this._leftViewMatrix=new Ke,this._leftProjectionMatrix=new Ke,this._leftProjectionViewMatrix=new Ke,this._leftViewport=new st(0,0,0,0),this._leftNormalizedViewport=new st(0,0,.5,1),this._leftAspectRatio=n,this._rightViewMatrix=new Ke,this._rightProjectionMatrix=new Ke,this._rightProjectionViewMatrix=new Ke,this._rightViewport=new st(0,0,0,0),this._rightNormalizedViewport=new st(.5,0,.5,1),this._rightAspectRatio=i,this._pupilDistande=e,t.__super.call(this,r,a)}r(t,"laya.d3.core.VRCamera",e);var n=t.prototype;n._calculatePupilOffset=function(){var e=this._tempVector3;return rt.scale(this.right,this._pupilDistande/2,e),e.elements},n._calculateLeftProjectionMatrix=function(){if(!this._useUserProjectionMatrix)if(this.orthographicProjection){var e=this.orthographicVerticalSize*this.leftAspectRatio*.5,t=.5*this.orthographicVerticalSize;Ke.createOrthogonal(-e,e,-t,t,this.nearPlane,this.farPlane,this._leftProjectionMatrix)}else Ke.createPerspective(3.1416*this.fieldOfView/180,this.leftAspectRatio,this.nearPlane,this.farPlane,this._rightProjectionMatrix);this._projectionMatrixModifyID+=.01/this.id},n._calculateRightProjectionMatrix=function(){if(!this._useUserProjectionMatrix)if(this.orthographicProjection){var e=this.orthographicVerticalSize*this.rightAspectRatio*.5,t=.5*this.orthographicVerticalSize;Ke.createOrthogonal(-e,e,t,t,this.nearPlane,this.farPlane,this._rightProjectionMatrix)}else Ke.createPerspective(3.1416*this.fieldOfView/180,this.rightAspectRatio,this.nearPlane,this.farPlane,this._rightProjectionMatrix);this._projectionMatrixModifyID+=.01/this.id},n._calculateProjectionMatrix=function(){if(!this._useUserProjectionMatrix)if(this.orthographicProjection){var e=this.orthographicVerticalSize*this.leftAspectRatio*.5,t=.5*this.orthographicVerticalSize,n=this.orthographicVerticalSize*this.rightAspectRatio*.5,i=.5*this.orthographicVerticalSize;Ke.createOrthogonal(-e,e,-t,t,this.nearPlane,this.farPlane,this._leftProjectionMatrix),Ke.createOrthogonal(-n,n,i,i,this.nearPlane,this.farPlane,this._rightProjectionMatrix)}else Ke.createPerspective(3.1416*this.fieldOfView/180,this.leftAspectRatio,this.nearPlane,this.farPlane,this._leftProjectionMatrix),Ke.createPerspective(3.1416*this.fieldOfView/180,this.rightAspectRatio,this.nearPlane,this.farPlane,this._rightProjectionMatrix);this._projectionMatrixModifyID+=.01/this.id},a(0,n,"leftNormalizedViewport",function(){if(!this._viewportExpressedInClipSpace){var e=this._leftViewport,t=this.renderTargetSize,n=t.width,i=t.height;this._leftNormalizedViewport.x=e.x/n,this._leftNormalizedViewport.y=e.y/i,this._leftNormalizedViewport.width=e.width/n,this._leftNormalizedViewport.height=e.height/i}return this._leftNormalizedViewport}),a(0,n,"rightViewport",function(){if(this._viewportExpressedInClipSpace){var e=this._rightNormalizedViewport,t=this.renderTargetSize,n=t.width,i=t.height;this._rightViewport.x=e.x*n,this._rightViewport.y=e.y*i,this._rightViewport.width=e.width*n,this._rightViewport.height=e.height*i}return this._rightViewport}),a(0,n,"viewport",null,function(e){if(null!=this.renderTarget&&(e.x<0||e.y<0||0==e.width||0==e.height))throw new Error("VRCamera: viewport size invalid.","value");this._viewportExpressedInClipSpace=!1,this._leftViewport=new st(0,0,e.width/2,e.height),this._rightViewport=new st(e.width/2,0,e.width/2,e.height),this._calculateProjectionMatrix()}),a(0,n,"leftAspectRatio",function(){if(0===this._leftAspectRatio){var e=this.leftViewport;return e.width/e.height}return this._leftAspectRatio}),a(0,n,"rightAspectRatio",function(){if(0===this._rightAspectRatio){var e=this.rightViewport;return e.width/e.height}return this._rightAspectRatio}),a(0,n,"aspectRatio",null,function(e){if(e<0)throw new Error("VRCamera: the aspect ratio has to be a positive real number.");this._leftAspectRatio=e,this._rightAspectRatio=e,this._calculateRightProjectionMatrix()}),a(0,n,"rightNormalizedViewport",function(){if(!this._viewportExpressedInClipSpace){var e=this._rightViewport,t=this.renderTargetSize,n=t.width,i=t.height;this._rightNormalizedViewport.x=e.x/n,this._rightNormalizedViewport.y=e.y/i,this._rightNormalizedViewport.width=e.width/n,this._rightNormalizedViewport.height=e.height/i}return this._rightNormalizedViewport}),a(0,n,"normalizedViewport",null,function(e){if(e.x<0||e.y<0||e.x+e.width>1||e.x+e.height>1)throw new Error("VRCamera: viewport size invalid.","value");this._viewportExpressedInClipSpace=!0,this._leftNormalizedViewport=new st(0,0,e.width/2,e.height),this._rightNormalizedViewport=new st(e.width/2,0,e.width/2,e.height),this._calculateProjectionMatrix()}),a(0,n,"leftViewport",function(){if(this._viewportExpressedInClipSpace){var e=this._leftNormalizedViewport,t=this.renderTargetSize,n=t.width,i=t.height;this._leftViewport.x=e.x*n,this._leftViewport.y=e.y*i,this._leftViewport.width=e.width*n,this._leftViewport.height=e.height*i}return this._leftViewport}),a(0,n,"needLeftViewport",function(){var e=this.leftNormalizedViewport;return 0===e.x&&0===e.y&&1===e.width&&1===e.height}),a(0,n,"needRightViewport",function(){var e=this.rightNormalizedViewport;return 0===e.x&&0===e.y&&1===e.width&&1===e.height}),a(0,n,"leftViewMatrix",function(){var e=this._calculatePupilOffset(),t=this._tempMatrix;this.transform.worldMatrix.cloneTo(t);var n=t.elements;return n[12]-=e[0],n[13]-=e[1],n[14]-=e[2],t.invert(this._leftViewMatrix),this._leftViewMatrix}),a(0,n,"rightViewMatrix",function(){var e=this._calculatePupilOffset(),t=this._tempMatrix;this.transform.worldMatrix.cloneTo(t);var n=t.elements;return n[12]+=e[0],n[13]+=e[1],n[14]+=e[2],t.invert(this._rightViewMatrix),this._rightViewMatrix}),a(0,n,"leftProjectionMatrix",function(){return this._leftProjectionMatrix}),a(0,n,"leftProjectionViewMatrix",function(){return Ke.multiply(this.leftProjectionMatrix,this.leftViewMatrix,this._leftProjectionViewMatrix),this._leftProjectionViewMatrix}),a(0,n,"rightProjectionMatrix",function(){return this._rightProjectionMatrix}),a(0,n,"rightProjectionViewMatrix",function(){return Ke.multiply(this.rightProjectionMatrix,this.rightViewMatrix,this._rightProjectionViewMatrix),this._rightProjectionViewMatrix}),t})(zt),function(e){function t(e,n,i){this._long=NaN,this._width=NaN,this._height=NaN,void 0===e&&(e=1),void 0===n&&(n=1),void 0===i&&(i=1),t.__super.call(this),this._long=e,this._width=n,this._height=i,this.activeResource(),this._loaded=!0,this._generateBoundingObject()}r(t,"laya.d3.resource.models.BoxMesh",e);var n=t.prototype;n.recreateResource=function(){this.startCreate(),this._numberVertices=24,this._numberIndices=36;var e=new Uint16Array(this._numberIndices),t=Oe.vertexDeclaration,n=t.vertexStride/4,i=new Float32Array(this._numberVertices*n),r=this._long/2,a=this._width/2,s=0;i[s+0]=-r,i[s+1]=this._height,i[s+2]=-a,i[s+3]=0,i[s+4]=1,i[s+5]=0,i[s+6]=0,i[s+7]=0,s+=8,i[s+0]=r,i[s+1]=this._height,i[s+2]=-a,i[s+3]=0,i[s+4]=1,i[s+5]=0,i[s+6]=1,i[s+7]=0,s+=8,i[s+0]=r,i[s+1]=this._height,i[s+2]=a,i[s+3]=0,i[s+4]=1,i[s+5]=0,i[s+6]=1,i[s+7]=1,s+=8,i[s+0]=-r,i[s+1]=this._height,i[s+2]=a,i[s+3]=0,i[s+4]=1,i[s+5]=0,i[s+6]=0,i[s+7]=1,s+=8,i[s+0]=-r,i[s+1]=0,i[s+2]=-a,i[s+3]=0,i[s+4]=-1,i[s+5]=0,i[s+6]=1,i[s+7]=0,s+=8,i[s+0]=r,i[s+1]=0,i[s+2]=-a,i[s+3]=0,i[s+4]=-1,i[s+5]=0,i[s+6]=0,i[s+7]=0,s+=8,i[s+0]=r,i[s+1]=0,i[s+2]=a,i[s+3]=0,i[s+4]=-1,i[s+5]=0,i[s+6]=0,i[s+7]=1,s+=8,i[s+0]=-r,i[s+1]=0,i[s+2]=a,i[s+3]=0,i[s+4]=-1,i[s+5]=0,i[s+6]=1,i[s+7]=1,s+=8,i[s+0]=-r,i[s+1]=this._height,i[s+2]=-a,i[s+3]=-1,i[s+4]=0,i[s+5]=0,i[s+6]=0,i[s+7]=0,s+=8,i[s+0]=-r,i[s+1]=this._height,i[s+2]=a,i[s+3]=-1,i[s+4]=0,i[s+5]=0,i[s+6]=1,i[s+7]=0,s+=8,i[s+0]=-r,i[s+1]=0,i[s+2]=a,i[s+3]=-1,i[s+4]=0,i[s+5]=0,i[s+6]=1,i[s+7]=1,s+=8,i[s+0]=-r,i[s+1]=0,i[s+2]=-a,i[s+3]=-1,i[s+4]=0,i[s+5]=0,i[s+6]=0,i[s+7]=1,s+=8,i[s+0]=r,i[s+1]=this._height,i[s+2]=-a,i[s+3]=1,i[s+4]=0,i[s+5]=0,i[s+6]=1,i[s+7]=0,s+=8,i[s+0]=r,i[s+1]=this._height,i[s+2]=a,i[s+3]=1,i[s+4]=0,i[s+5]=0,i[s+6]=0,i[s+7]=0,s+=8,i[s+0]=r,i[s+1]=0,i[s+2]=a,i[s+3]=1,i[s+4]=0,i[s+5]=0,i[s+6]=0,i[s+7]=1,s+=8,i[s+0]=r,i[s+1]=0,i[s+2]=-a,i[s+3]=1,i[s+4]=0,i[s+5]=0,i[s+6]=1,i[s+7]=1,s+=8,i[s+0]=-r,i[s+1]=this._height,i[s+2]=a,i[s+3]=0,i[s+4]=0,i[s+5]=1,i[s+6]=0,i[s+7]=0,s+=8,i[s+0]=r,i[s+1]=this._height,i[s+2]=a,i[s+3]=0,i[s+4]=0,i[s+5]=1,i[s+6]=1,i[s+7]=0,s+=8,i[s+0]=r,i[s+1]=0,i[s+2]=a,i[s+3]=0,i[s+4]=0,i[s+5]=1,i[s+6]=1,i[s+7]=1,s+=8,i[s+0]=-r,i[s+1]=0,i[s+2]=a,i[s+3]=0,i[s+4]=0,i[s+5]=1,i[s+6]=0,i[s+7]=1,s+=8,i[s+0]=-r,i[s+1]=this._height,i[s+2]=-a,i[s+3]=0,i[s+4]=0,i[s+5]=-1,i[s+6]=1,i[s+7]=0,s+=8,i[s+0]=r,i[s+1]=this._height,i[s+2]=-a,i[s+3]=0,i[s+4]=0,i[s+5]=-1,i[s+6]=0,i[s+7]=0,s+=8,i[s+0]=r,i[s+1]=0;i[s+2]=-a,i[s+3]=0,i[s+4]=0,i[s+5]=-1,i[s+6]=0,i[s+7]=1,s+=8,i[s+0]=-r,i[s+1]=0,i[s+2]=-a,i[s+3]=0,i[s+4]=0,i[s+5]=-1,i[s+6]=1,i[s+7]=1;var o=0;e[o+0]=0,e[o+1]=1,e[o+2]=2,o+=3,e[o+0]=2,e[o+1]=3,e[o+2]=0,o+=3,e[o+0]=4,e[o+1]=7,e[o+2]=6,o+=3,e[o+0]=6,e[o+1]=5,e[o+2]=4,o+=3,e[o+0]=8,e[o+1]=9,e[o+2]=10,o+=3,e[o+0]=10,e[o+1]=11,e[o+2]=8,o+=3,e[o+0]=12,e[o+1]=15,e[o+2]=14,o+=3,e[o+0]=14,e[o+1]=13,e[o+2]=12,o+=3,e[o+0]=16,e[o+1]=17,e[o+2]=18,o+=3,e[o+0]=18,e[o+1]=19,e[o+2]=16,o+=3,e[o+0]=20,e[o+1]=23,e[o+2]=22,o+=3,e[o+0]=22,e[o+1]=21,e[o+2]=20,this._vertexBuffer=new Zt(t,this._numberVertices,35044,!0),this._indexBuffer=new qt("ushort",this._numberIndices,35044,!0),this._vertexBuffer.setData(i),this._indexBuffer.setData(e),this.memorySize=2*(this._vertexBuffer.byteLength+this._indexBuffer.byteLength),this.completeCreate()},a(0,n,"long",function(){return this._long},function(e){this._long!==e&&(this._long=e,this.releaseResource(),this.activeResource())}),a(0,n,"width",function(){return this._width},function(e){this._width!==e&&(this._width=e,this.releaseResource(),this.activeResource())}),a(0,n,"height",function(){return this._height},function(e){this._height!==e&&(this._height=e,this.releaseResource(),this.activeResource())}),t}(Jt),function(e){function t(e,n,i){this._radius=NaN,this._height=NaN,this._slices=0,void 0===e&&(e=.5),void 0===n&&(n=1),void 0===i&&(i=32),t.__super.call(this),this._radius=e,this._height=n,this._slices=i,this.recreateResource(),this._loaded=!0,this._generateBoundingObject()}r(t,"laya.d3.resource.models.CylinderMesh",e);var n=t.prototype;n.recreateResource=function(){this.startCreate(),this._numberVertices=this._slices+1+1+2*(this._slices+1)+(this._slices+1+1),this._numberIndices=3*this._slices+6*this._slices+3*this._slices;for(var e=Oe.vertexDeclaration,t=e.vertexStride/4,n=new Float32Array(this._numberVertices*t),i=new Uint16Array(this._numberIndices),r=2*Math.PI/this._slices,a=this._height/2,s=0,o=0,l=0,h=0,u=0,c=0,_=0,d=0;d<=this._slices;d++)0===d&&(n[c++]=0,n[c++]=a,n[c++]=0,n[c++]=0,n[c++]=1,n[c++]=0,n[c++]=.5,n[c++]=.5),s=d*r,l=Math.cos(s)*this._radius,h=a,u=Math.sin(s)*this._radius,n[c++]=l,n[c++]=h,n[c++]=u,n[c++]=0,n[c++]=1,n[c++]=0,n[c++]=.5+.5*Math.cos(s),n[c++]=.5+.5*Math.sin(s);for(var m=0;m<this._slices;m++)i[_++]=0,i[_++]=m+1,i[_++]=m+2;o+=this._slices+1+1;for(var f=0;f<=this._slices;f++)s=f*r,l=Math.cos(s)*this._radius,h=a,u=Math.sin(s)*this._radius,n[c++]=l,n[c+8*(this._slices+1)-1]=l,n[c++]=h,n[c+8*(this._slices+1)-1]=-h,n[c++]=u,n[c+8*(this._slices+1)-1]=u,n[c++]=l,n[c+8*(this._slices+1)-1]=l,n[c++]=0,n[c+8*(this._slices+1)-1]=0,n[c++]=u,n[c+8*(this._slices+1)-1]=u,n[c++]=1-1*f/this._slices,n[c+8*(this._slices+1)-1]=1-1*f/this._slices,n[c++]=0,n[c+8*(this._slices+1)-1]=1;c+=8*(this._slices+1);for(var p=0;p<this._slices;p++)i[_++]=p+o+(this._slices+1),i[_++]=p+o+1,i[_++]=p+o,i[_++]=p+o+(this._slices+1),i[_++]=p+o+(this._slices+1)+1,i[_++]=p+o+1;o+=2*(this._slices+1);for(var v=0;v<=this._slices;v++)0===v&&(n[c++]=0,n[c++]=-a,n[c++]=0,n[c++]=0,n[c++]=-1,n[c++]=0,n[c++]=.5,n[c++]=.5),s=v*r,l=Math.cos(s)*this._radius,h=-a,u=Math.sin(s)*this._radius,n[c++]=l,n[c++]=h,n[c++]=u,n[c++]=0,n[c++]=-1,n[c++]=0,n[c++]=.5+.5*Math.cos(s),n[c++]=.5+.5*Math.sin(s);for(var g=0;g<this._slices;g++)i[_++]=0+o,i[_++]=g+2+o,i[_++]=g+1+o;o+=this._slices+1+1,this._vertexBuffer=new Zt(e,this._numberVertices,35044,!0),this._indexBuffer=new qt("ushort",this._numberIndices,35044,!0),this._vertexBuffer.setData(n),this._indexBuffer.setData(i),this.memorySize=2*(this._vertexBuffer.byteLength+this._indexBuffer.byteLength),this.completeCreate()},a(0,n,"radius",function(){return this._radius},function(e){this._radius!==e&&(this._radius=e,this.releaseResource(),this.activeResource())}),a(0,n,"height",function(){return this._height},function(e){this._height!==e&&(this._height=e,this.releaseResource(),this.activeResource())}),a(0,n,"slices",function(){return this._slices},function(e){this._slices!==e&&(this._slices=e,this.releaseResource(),this.activeResource())}),t}(Jt),function(e){function t(e,n){this._long=NaN,this._width=NaN,void 0===e&&(e=1),void 0===n&&(n=1),t.__super.call(this),this._long=e,this._width=n,this.activeResource(),this._loaded=!0,this._generateBoundingObject()}r(t,"laya.d3.resource.models.QuadMesh",e);var n=t.prototype;n.recreateResource=function(){this.startCreate(),this._numberVertices=4,this._numberIndices=6;var e=new Uint16Array(this._numberIndices),t=Oe.vertexDeclaration,n=t.vertexStride/4,i=new Float32Array(this._numberVertices*n),r=this._long/2,a=this._width/2,s=0;i[0+8*s]=-r,i[1+8*s]=0,i[2+8*s]=-a,i[3+8*s]=0,i[4+8*s]=1,i[5+8*s]=0,i[6+8*s]=0,i[7+8*s]=0,s++,i[0+8*s]=r,i[1+8*s]=0,i[2+8*s]=-a,i[3+8*s]=0,i[4+8*s]=1,i[5+8*s]=0,i[6+8*s]=1,i[7+8*s]=0,s++,i[0+8*s]=r,i[1+8*s]=0,i[2+8*s]=a,i[3+8*s]=0,i[4+8*s]=1,i[5+8*s]=0,i[6+8*s]=1,i[7+8*s]=1,s++,i[0+8*s]=-r,i[1+8*s]=0,i[2+8*s]=a,i[3+8*s]=0,i[4+8*s]=1,i[5+8*s]=0,i[6+8*s]=0,i[7+8*s]=1;var o=0;e[0+3*o]=0,e[1+3*o]=1,e[2+3*o]=3,o++,e[0+3*o]=1,e[1+3*o]=2,e[2+3*o]=3,this._vertexBuffer=new Zt(t,this._numberVertices,35044,!0),this._indexBuffer=new qt("ushort",this._numberIndices,35044,!0),this._vertexBuffer.setData(i),this._indexBuffer.setData(e),this.memorySize=2*(this._vertexBuffer.byteLength+this._indexBuffer.byteLength),this.completeCreate()},a(0,n,"long",function(){return this._long},function(e){this._long!==e&&(this._long=e,this.releaseResource(),this.activeResource())}),a(0,n,"width",function(){return this._width},function(e){this._width!==e&&(this._width=e,this.releaseResource(),this.activeResource())}),t}(Jt),function(e){function t(e,n,i){this._radius=NaN,this._slices=0,this._stacks=0,void 0===e&&(e=.5),void 0===n&&(n=32),void 0===i&&(i=32),t.__super.call(this),this._radius=e,this._stacks=n,this._slices=i,this.activeResource(),this._loaded=!0,this._generateBoundingObject()}r(t,"laya.d3.resource.models.SphereMesh",e);var n=t.prototype;n.recreateResource=function(){this.startCreate(),this._numberVertices=(this._stacks+1)*(this._slices+1),this._numberIndices=3*this._stacks*(this._slices+1)*2;for(var e=new Uint16Array(this._numberIndices),t=Oe.vertexDeclaration,n=t.vertexStride/4,i=new Float32Array(this._numberVertices*n),r=Math.PI/this._stacks,a=2*Math.PI/this._slices,s=0,o=0,l=0,h=0;h<this._stacks+1;h++)for(var u=Math.sin(h*r),c=Math.cos(h*r),_=0;_<this._slices+1;_++){var d=u*Math.sin(_*a),m=u*Math.cos(_*a);i[o+0]=d*this._radius,i[o+1]=c*this._radius,i[o+2]=m*this._radius,i[o+3]=d,i[o+4]=c,i[o+5]=m,i[o+6]=_/this._slices,i[o+7]=h/this._stacks,o+=n,h!=this._stacks-1&&(e[l++]=s+(this._slices+1),e[l++]=s,e[l++]=s+1,e[l++]=s+this._slices,e[l++]=s,e[l++]=s+(this._slices+1),s++)}this._vertexBuffer=new Zt(t,this._numberVertices,35044,!0),this._indexBuffer=new qt("ushort",this._numberIndices,35044,!0),this._vertexBuffer.setData(i),this._indexBuffer.setData(e),this.memorySize=2*(this._vertexBuffer.byteLength+this._indexBuffer.byteLength),this.completeCreate()},a(0,n,"radius",function(){return this._radius},function(e){this._radius!==e&&(this._radius=e,this.releaseResource(),this.activeResource())}),a(0,n,"slices",function(){return this._slices},function(e){this._slices!==e&&(this._slices=e,this.releaseResource(),this.activeResource())}),a(0,n,"stacks",function(){return this._stacks},function(e){this._stacks!==e&&(this._stacks=e,this.releaseResource(),this.activeResource())}),t}(Jt),function(e){function t(e,n,i){this._minX=NaN,this._minZ=NaN,this._cellSize=null,this._heightMap=null,t.__super.call(this,e,i),this._heightMap=n,this._cellSize=new it}r(t,"laya.d3.core.MeshTerrainSprite3D",e);var n=t.prototype;n._disableRotation=function(){var e=this.transform.rotation;e.elements[0]=0,e.elements[1]=0,e.elements[2]=0,e.elements[3]=1,this.transform.rotation=e},n._getScaleX=function(){var e=this.transform.worldMatrix,t=e.elements,n=t[0],i=t[1],r=t[2];return Math.sqrt(n*n+i*i+r*r)},n._getScaleZ=function(){var e=this.transform.worldMatrix,t=e.elements,n=t[8],i=t[9],r=t[10];return Math.sqrt(n*n+i*i+r*r)},n._initCreateFromMesh=function(e,t){this._heightMap=B.creatFromMesh(this.meshFilter.sharedMesh,e,t,this._cellSize);var n=this.meshFilter.sharedMesh.boundingBox,i=n.min;n.max;this._minX=i.x,this._minZ=i.z},n._initCreateFromMeshHeightMap=function(e,t,n){var i=this,r=this.meshFilter.sharedMesh.boundingBox;e.loaded?(this._heightMap=B.createFromImage(e,t,n),this._computeCellSize(r)):e.once("loaded",null,function(){i._heightMap=B.createFromImage(e,t,n),i._computeCellSize(r)});var a=r.min;r.max;this._minX=a.x,this._minZ=a.z},n._computeCellSize=function(e){var t=e.min,n=e.max,i=t.x,r=t.z,a=n.x,s=n.z,o=a-i,l=s-r;this._cellSize.elements[0]=o/(this._heightMap.width-1),this._cellSize.elements[1]=l/(this._heightMap.height-1)},n._update=function(e){this._disableRotation(),laya.d3.core.RenderableSprite3D.prototype._update.call(this,e)},n.getHeight=function(e,n){t._tempVector3.elements[0]=e,t._tempVector3.elements[1]=0,t._tempVector3.elements[2]=n,this._disableRotation();var i=this.transform.worldMatrix;i.invert(t._tempMatrix4x4),rt.transformCoordinate(t._tempVector3,t._tempMatrix4x4,t._tempVector3),e=t._tempVector3.elements[0],n=t._tempVector3.elements[2];var r=(e-this._minX)/this._cellSize.x,a=(n-this._minZ)/this._cellSize.y,s=Math.floor(a),o=Math.floor(r),l=r-o,h=a-s,u=NaN,c=NaN,_=i.elements,d=_[4],m=_[5],f=_[6],p=Math.sqrt(d*d+m*m+f*f),v=_[13],g=this._heightMap.getHeight(s,o+1),x=this._heightMap.getHeight(s+1,o);if(isNaN(g)||isNaN(x))return NaN;if(l+h<=1){var E=this._heightMap.getHeight(s,o);return isNaN(E)?NaN:(u=g-E,c=x-E,(E+l*u+h*c)*p+v)}var M=this._heightMap.getHeight(s+1,o+1);return isNaN(M)?NaN:(u=x-M,c=g-M,(M+(1-l)*u+(1-h)*c)*p+v)},a(0,n,"minX",function(){var e=this.transform.worldMatrix,t=e.elements;return this._minX*this._getScaleX()+t[12]}),a(0,n,"width",function(){return(this._heightMap.width-1)*this._cellSize.x*this._getScaleX()}),a(0,n,"minZ",function(){var e=this.transform.worldMatrix,t=e.elements;return this._minZ*this._getScaleZ()+t[14]}),a(0,n,"depth",function(){return(this._heightMap.height-1)*this._cellSize.y*this._getScaleZ()}),t.createFromMesh=function(e,n,i,r){var a=new t(e,null,r);return e.loaded?a._initCreateFromMesh(n,i):e.once("loaded",a,a._initCreateFromMesh,[n,i]),a},t.createFromMeshAndHeightMap=function(e,n,i,r,a){var s=new t(e,null,a);return e.loaded?s._initCreateFromMeshHeightMap(n,i,r):e.once("loaded",s,s._initCreateFromMeshHeightMap,[n,i,r]),s},i(t,["_tempVector3",function(){return this._tempVector3=new rt},"_tempMatrix4x4",function(){return this._tempMatrix4x4=new Ke}]),t}(on);n.__init([lt])}(window,document,Laya);